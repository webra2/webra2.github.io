var __classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(e,t,i,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,i):s?s.value=i:t.set(e,i),i},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(e,t,i,r){if("a"===i&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?r:"a"===i?r.call(e):r?r.value:t.get(e)};System.register("data/IniSection",[],function(e,t){"use strict";var r;t&&t.id;return{setters:[],execute:function(){e("IniSection",r=class r{constructor(e){this.entries=new Map,this.name=e}clone(){let i=new r(this.name);return this.entries.forEach((e,t)=>{i.set(t,e)}),i}set(e,t){this.entries.set(e,t)}get(e){return this.entries.get(e)}has(e){return this.entries.has(e)}getString(e,t=""){var i=this.get(e);return i||t}getNumber(e,t=0){var i=this.get(e);if(!i)return t;var r=this.parseNumber(i);return void 0===r?(console.warn(`Invalid value for key ${e}. "${i}" is not a valid number or percentage string.`),t):r}parseNumber(e){let t;if(t=e.match(/%$/)?Number(e.replace("%",""))/100:Number(e),!isNaN(t))return t}getFixed(e,t=0){return this.toFixedPointPrecision(this.getNumber(e,t))}toFixedPointPrecision(e){return(65536*e|0)/65536}getBool(e,t=!1){let i=this.getString(e).trim();return i=i&&i.toLowerCase(),!(!i||-1===["yes","1","true","on"].indexOf(i))||(!i||-1===["no","0","false","off"].indexOf(i))&&t}getArray(e,t=/\,\s*/,i=[]){let r=this.getString(e).trim();return r=r.replace(/\,$/,"").replace(/\,+/g,","),r?r.split(t):i}getNumberArray(e,t=/\,\s*/,i=[]){let r=this.getString(e).trim();if(!r)return i;let s=[];for(var a of r.split(t)){if(!a)return i;var n=this.parseNumber(a);if(void 0===n)return console.warn(`Invalid value for key ${e}. "${a}" is not a valid number or percentage string.`),i;s.push(n)}return s}getFixedArray(e,t=/\,\s*/,i=[]){return this.getNumberArray(e,t,i).map(e=>this.toFixedPointPrecision(e))}getEnum(e,t,i,r=!1){let s=this.getString(e).trim();if(!s)return i;let a;if(r){let e=Object.getOwnPropertyNames(t);var n=e.find(e=>e.toLowerCase()===s.toLowerCase());n&&(a=t[n])}else t.hasOwnProperty(s)&&(a=t[s]);return void 0===a?(console.warn(`Invalid value for key "${e}". "${s}" is not an accepted enum value.`),i):a}getEnumNumeric(e,t,i){var r=this.getString(e).trim();if(!r)return i;let s;return Number.isInteger(parseInt(r,10))&&t.hasOwnProperty(r)&&(s=parseInt(r,10)),void 0===s?(console.warn(`Invalid value for key "${e}". "${r}" is not an accepted enum value.`),i):s}getEnumArray(e,i,t=/\,\s*/,r=[],s=!1){let a=this.getString(e).trim();if(!a)return r;let n=[];for(let l of a.split(t)){if(!l)return r;let t=!1;if(s){let e=Object.getOwnPropertyNames(i);var o=e.find(e=>e.toLowerCase()===l.toLowerCase());o&&(n.push(i[o]),t=!0)}else i.hasOwnProperty(l)&&(n.push(i[l]),t=!0);if(!t)return console.warn(`Invalid value "${l}" for key "${e}".`),r}return n}getHighestNumericIndex(){let i=0,r;return this.entries.forEach((e,t)=>{r=parseInt(t,10),r>i&&(i=r)}),i}getConcatenatedValues(){let e="";for(var t of this.entries.values())e+=t;return e}toString(){let e=[];e.push(`[${this.name}]`);for(var[t,i]of this.entries)e.push(t+"="+i);return e.push(""),e.join("\r\n")}})}}}),System.register("data/IniParser",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("IniParser",i=class{parse(e){let o={},s=o,a,n=/^\[([^\]]*)\]\s*$|^([^=]+)(=(.*))?$/i,t=e.split(/[\r\n]+/g);return t.forEach((e,t,i)=>{if(e&&!e.match(/^\s*[;#]/)){var r=(e=e.replace(/]\s*(\/\/|;|#).*$/,"]")).match(n);if(r){if(void 0!==r[1])return a=this.unsafe(r[1]),void(s=o[a]=o[a]||{});let e=this.unsafe(r[2]);r=r[3]?this.unsafe(r[4]||""):"";2<e.length&&"[]"===e.slice(-2)&&(e=e.substring(0,e.length-2),s[e]?Array.isArray(s[e])||(s[e]=[s[e]]):s[e]=[]),Array.isArray(s[e])?s[e].push(r):s[e]=r}}}),Object.keys(o).filter((e,t,i)=>{if(!o[e]||"object"!=typeof o[e]||Array.isArray(o[e]))return!1;let r=this.dotSplit(e),s=o,a=r.pop();var n=a.replace(/\\\./g,".");return r.forEach(function(e,t,i){s[e]&&"object"==typeof s[e]||(s[e]={}),s=s[e]}),(s!==o||n!==a)&&(s[n]=o[e],!0)}).forEach(function(e,t,i){delete o[e]}),o}dotSplit(e){return e.replace(/\1/g,"LITERAL\\1LITERAL").replace(/\\\./g,"").split(/\./).map(e=>e.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,""))}isQuoted(e){return'"'===e.charAt(0)&&'"'===e.slice(-1)||"'"===e.charAt(0)&&"'"===e.slice(-1)}unsafe(s){if(s=(s||"").trim(),this.isQuoted(s))return s=s.substr(1,s.length-2);{let e=!1,t="";for(let i=0,r=s.length;i<r;i++){var a=s.charAt(i);if(e)-1!=="\\;#".indexOf(a)?t+=a:t+="\\"+a,e=!1;else{if(-1!==";#".indexOf(a))break;"\\"===a?e=!0:t+=a}}return e&&(t+="\\"),t=t.trim(),t}}})}}}),System.register("data/DataStream",[],function(e,t){"use strict";var n;t&&t.id;return{setters:[],execute:function(){e("DataStream",n=class n{constructor(e,t,i=n.LITTLE_ENDIAN){this.endianness=i,this.position=0,this._dynamicSize=!0,this._byteLength=0,this._byteOffset=t||0,e instanceof ArrayBuffer?this.buffer=e:"object"==typeof e?(this.dataView=e,t&&(this._byteOffset+=t)):this.buffer=new ArrayBuffer(e||0)}get dynamicSize(){return this._dynamicSize}set dynamicSize(e){e||this._trimAlloc(),this._dynamicSize=e}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(e){this._buffer=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(e){this._byteOffset=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(e){this._byteOffset=e.byteOffset,this._buffer=e.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+e.byteLength}bigEndian(){return this.endianness=n.BIG_ENDIAN,this}_realloc(t){if(this._dynamicSize){var i=this._byteOffset+this.position+t;let e=this._buffer.byteLength;if(i<=e)i>this._byteLength&&(this._byteLength=i);else{for(e<1&&(e=1);i>e;)e*=2;var r=new ArrayBuffer(e),s=new Uint8Array(this._buffer);const a=new Uint8Array(r,0,s.length);a.set(s),this.buffer=r,this._byteLength=i}}}_trimAlloc(){if(this._byteLength!==this._buffer.byteLength){var e=new ArrayBuffer(this._byteLength);const i=new Uint8Array(e);var t=new Uint8Array(this._buffer,0,i.length);i.set(t),this.buffer=e}}seek(e){var t=Math.max(0,Math.min(this.byteLength,e));this.position=isNaN(t)||!isFinite(t)?0:t}isEof(){return this.position>=this.byteLength}mapInt32Array(e,t){this._realloc(4*e);var i=new Int32Array(this._buffer,this.byteOffset+this.position,e);return n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=4*e,i}mapInt16Array(e,t){this._realloc(2*e);var i=new Int16Array(this._buffer,this.byteOffset+this.position,e);return n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=2*e,i}mapInt8Array(e){this._realloc(e);var t=new Int8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=e,t}mapUint32Array(e,t){this._realloc(4*e);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,e);return n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=4*e,i}mapUint16Array(e,t){this._realloc(2*e);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,e);return n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=2*e,i}mapUint8Array(e){this._realloc(e);var t=new Uint8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=e,t}mapFloat64Array(e,t){this._realloc(8*e);var i=new Float64Array(this._buffer,this.byteOffset+this.position,e);return n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=8*e,i}mapFloat32Array(e,t){this._realloc(4*e);var i=new Float32Array(this._buffer,this.byteOffset+this.position,e);return n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=4*e,i}readInt32Array(e,t){e=void 0===e?this.byteLength-this.position/4:e;var i=new Int32Array(e);return n.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=i.byteLength,i}readInt16Array(e,t){e=void 0===e?this.byteLength-this.position/2:e;var i=new Int16Array(e);return n.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=i.byteLength,i}readInt8Array(e){e=void 0===e?this.byteLength-this.position:e;var t=new Int8Array(e);return n.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t}readUint32Array(e,t){e=void 0===e?this.byteLength-this.position/4:e;var i=new Uint32Array(e);return n.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=i.byteLength,i}readUint16Array(e,t){e=void 0===e?this.byteLength-this.position/2:e;var i=new Uint16Array(e);return n.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=i.byteLength,i}readUint8Array(e){e=void 0===e?this.byteLength-this.position:e;var t=new Uint8Array(e);return n.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t}readFloat64Array(e,t){e=void 0===e?this.byteLength-this.position/8:e;var i=new Float64Array(e);return n.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=i.byteLength,i}readFloat32Array(e,t){e=void 0===e?this.byteLength-this.position/4:e;var i=new Float32Array(e);return n.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),n.arrayToNative(i,void 0===t?this.endianness:t),this.position+=i.byteLength,i}writeInt32Array(t,i){if(this._realloc(4*t.length),t instanceof Int32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt32Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeInt32(t[e],i);return this}writeInt16Array(t,i){if(this._realloc(2*t.length),t instanceof Int16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt16Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeInt16(t[e],i);return this}writeInt8Array(t){if(this._realloc(t.length),t instanceof Int8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt8Array(t.length);else for(let e=0;e<t.length;e++)this.writeInt8(t[e]);return this}writeUint32Array(t,i){if(this._realloc(4*t.length),t instanceof Uint32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint32Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeUint32(t[e],i);return this}writeUint16Array(t,i){if(this._realloc(2*t.length),t instanceof Uint16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint16Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeUint16(t[e],i);return this}writeUint8Array(t){if(this._realloc(t.length),t instanceof Uint8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint8Array(t.length);else for(let e=0;e<t.length;e++)this.writeUint8(t[e]);return this}writeFloat64Array(t,i){if(this._realloc(8*t.length),t instanceof Float64Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat64Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeFloat64(t[e],i);return this}writeFloat32Array(t,i){if(this._realloc(4*t.length),t instanceof Float32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat32Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeFloat32(t[e],i);return this}readInt32(e){var t=this._dataView.getInt32(this.position,void 0===e?this.endianness:e);return this.position+=4,t}readInt16(e){var t=this._dataView.getInt16(this.position,void 0===e?this.endianness:e);return this.position+=2,t}readInt8(){var e=this._dataView.getInt8(this.position);return this.position+=1,e}readUint32(e){var t=this._dataView.getUint32(this.position,void 0===e?this.endianness:e);return this.position+=4,t}readUint16(e){var t=this._dataView.getUint16(this.position,void 0===e?this.endianness:e);return this.position+=2,t}readUint8(){var e=this._dataView.getUint8(this.position);return this.position+=1,e}readFloat32(e){var t=this._dataView.getFloat32(this.position,void 0===e?this.endianness:e);return this.position+=4,t}readFloat64(e){var t=this._dataView.getFloat64(this.position,void 0===e?this.endianness:e);return this.position+=8,t}writeInt32(e,t){return this._realloc(4),this._dataView.setInt32(this.position,e,void 0===t?this.endianness:t),this.position+=4,this}writeInt16(e,t){return this._realloc(2),this._dataView.setInt16(this.position,e,void 0===t?this.endianness:t),this.position+=2,this}writeInt8(e){return this._realloc(1),this._dataView.setInt8(this.position,e),this.position+=1,this}writeUint32(e,t){return this._realloc(4),this._dataView.setUint32(this.position,e,void 0===t?this.endianness:t),this.position+=4,this}writeUint16(e,t){return this._realloc(2),this._dataView.setUint16(this.position,e,void 0===t?this.endianness:t),this.position+=2,this}writeUint8(e){return this._realloc(1),this._dataView.setUint8(this.position,e),this.position+=1,this}writeFloat32(e,t){return this._realloc(4),this._dataView.setFloat32(this.position,e,void 0===t?this.endianness:t),this.position+=4,this}writeFloat64(e,t){return this._realloc(8),this._dataView.setFloat64(this.position,e,void 0===t?this.endianness:t),this.position+=8,this}static memcpy(e,t,i,r,s){const a=new Uint8Array(e,t,s);var n=new Uint8Array(i,r,s);a.set(n)}static arrayToNative(e,t){return t===this.endianness?e:this.flipArrayEndianness(e)}static nativeToEndian(e,t){return this.endianness===t?e:this.flipArrayEndianness(e)}static flipArrayEndianness(i){const r=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);for(let a=0;a<i.byteLength;a+=i.BYTES_PER_ELEMENT)for(let e=a+i.BYTES_PER_ELEMENT-1,t=a;e>t;e--,t++){var s=r[t];r[t]=r[e],r[e]=s}return i}static createStringFromArray(e){const t=[];for(let i=0;i<e.length;i+=32768)t.push(String.fromCharCode.apply(void 0,e.subarray(i,i+32768)));return t.join("")}readUCS2String(e,t){return n.createStringFromArray(this.readUint16Array(e,t))}writeUCS2String(e,t,i){void 0===i&&(i=e.length);let r=0;for(;r<e.length&&r<i;r++)this.writeUint16(e.charCodeAt(r),t);for(;r<i;r++)this.writeUint16(0);return this}readString(e,t){return void 0===t||"ASCII"===t?n.createStringFromArray(this.mapUint8Array(void 0===e?this.byteLength-this.position:e)):new TextDecoder(t).decode(this.mapUint8Array(e))}writeString(t,e,i){if(void 0===e||"ASCII"===e)if(void 0!==i){let e;var r=Math.min(t.length,i);for(e=0;e<r;e++)this.writeUint8(t.charCodeAt(e));for(;e<i;e++)this.writeUint8(0)}else for(let e=0;e<t.length;e++)this.writeUint8(t.charCodeAt(e));else this.writeUint8Array((new TextEncoder).encode(t.substring(0,i)));return this}writeUtf8WithLen(e){var t=(new TextEncoder).encode(e);return this.writeUint16(t.length).writeUint8Array(t)}readUtf8WithLen(){var e=this.readUint16();return(new TextDecoder).decode(this.mapUint8Array(e))}readCString(e){var t=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position);let r=t;void 0!==e&&(r=Math.min(e,t));let s=0;for(;s<r&&0!==i[s];s++);var a=n.createStringFromArray(this.mapUint8Array(s));return void 0!==e?this.position+=r-s:s!==t&&(this.position+=1),a}writeCString(t,i){if(void 0!==i){let e;var r=Math.min(t.length,i);for(e=0;e<r;e++)this.writeUint8(t.charCodeAt(e));for(;e<i;e++)this.writeUint8(0)}else{for(let e=0;e<t.length;e++)this.writeUint8(t.charCodeAt(e));this.writeUint8(0)}return this}toUint8Array(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}}),n.BIG_ENDIAN=!1,n.LITTLE_ENDIAN=!0,n.endianness=0<new Int8Array(new Int16Array([1]).buffer)[0]}}}),System.register("data/vfs/IOError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{constructor(){super(...arguments),this.name="IOError"}},e("IOError",i)}}}),System.register("data/vfs/VirtualFile",["data/DataStream","data/vfs/IOError"],function(e,t){"use strict";var n,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){i=e}],execute:function(){e("VirtualFile",r=class{constructor(e,t){this.stream=e,this.filename=t}static async fromRealFile(t){try{const e=new n.DataStream(await t.arrayBuffer());return e._trimAlloc=()=>{},new this(e,t.name)}catch(e){if(e instanceof DOMException)throw new i.IOError(`File "${t.name}" could not be read (${e.name})`,{cause:e});throw e}}static fromBytes(e,t){let i=new n.DataStream(e);return i._trimAlloc=()=>{},new this(i,t)}static factory(e,t,i=0,r=e.byteLength){var s=new DataView(e.buffer,e.byteOffset+i,r);const a=new n.DataStream(s);return a._trimAlloc=()=>{},new this(a,t)}readAsString(e){return this.stream.seek(0),this.stream.readString(this.stream.byteLength,e)}getBytes(){return new Uint8Array(this.stream.buffer,this.stream.byteOffset,this.stream.byteLength)}getSize(){return this.stream.byteLength}asFile(e){return new File([this.getBytes()],this.filename,{type:e})}})}}}),System.register("data/IniFile",["data/IniSection","data/IniParser","data/vfs/VirtualFile"],function(e,t){"use strict";var n,i,r,s;t&&t.id;return{setters:[function(e){n=e},function(e){i=e},function(e){r=e}],execute:function(){e("IniFile",s=class s{constructor(e){this.sections=new Map,e instanceof r.VirtualFile?this.fromVirtualFile(e):"object"==typeof e?this.fromJson(e):"string"==typeof e&&this.fromString(e)}fromVirtualFile(e){return this.fromString(e.readAsString())}fromString(e){return this.fromJson((new i.IniParser).parse(e)),this}fromJson(e){let t,i,r,s;var a;for(t in e)if(e.hasOwnProperty(t)){for(s in i=e[t],r=new n.IniSection(t),i)i.hasOwnProperty(s)&&(a=i[s],r.set(s,a));this.sections.set(t,r)}}toString(){let e=[];for(var t of this.sections.values())e.push(t.toString());return e.join("\r\n")}clone(){let i=new s;return this.sections.forEach((e,t)=>{i.sections.set(t,e.clone())}),i}getOrCreateSection(e){let t=this.sections.get(e);return t||(t=new n.IniSection(e),this.sections.set(e,t)),t}getSection(e){return this.sections.get(e)}getOrderedSections(){return[...this.sections.values()]}isValueArray(e){return-1!==["BuildingTypes","AircraftTypes","InfantryTypes","OverlayTypes","TerrainTypes","SmudgeTypes","VehicleTypes","Animations","VoxelAnims","SuperWeaponTypes","Countries","Warheads","Tiberiums"].indexOf(e)}mergeWith(e){return e.sections.forEach((e,t)=>{let r=this.getOrCreateSection(t);if(this.isValueArray(t)){let i=r.getHighestNumericIndex()+1;e.entries.forEach((e,t)=>{r.set((i++).toString(),e)})}else e.entries.forEach((e,t)=>{r.set(t,e)})}),this}})}}}),System.register("data/encoding/Format3",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Format3",i=class{static decode(r,s,e){let a=new Uint8Array(s*e),n=0,o=0;for(let t=0;t<e;t++){let t=(r[n+1]<<8|r[n])-2;n+=2;let i=0;for(;0<t--;){let e=r[n++];if(0!==e)i++,a[o++]=e;else for(t--,e=r[n++],i+e>s&&(e=s-i&255),i+=e;0!=e--;)a[o++]=0}}return a}})}}}),System.register("data/ShpImage",[],function(e,t){"use strict";var n;t&&t.id;return{setters:[],execute:function(){e("ShpImage",n=class n{constructor(e){this.height=1,this.width=1,this.x=0,this.y=0,this.imageData=e??new Uint8Array(0)}clip(t,i){let e=new n;e.width=Math.min(this.width,t),e.height=Math.min(this.height,i);let r=new Uint8Array(t*i),s=0;for(let a=0;a<this.height&&!(a>=i);a++)for(let e=0;e<this.width;e++)e>=t||(r[s++]=this.imageData[a*this.width+e]);return e.imageData=r,e.x=this.x,e.y=this.y,e}})}}}),System.register("data/ShpFile",["data/encoding/Format3","data/ShpImage","data/vfs/VirtualFile"],function(e,t){"use strict";var l,d,i,r;t&&t.id;return{setters:[function(e){l=e},function(e){d=e},function(e){i=e}],execute:function(){e("ShpFile",r=class r{constructor(e){this.height=0,this.width=0,this.numImages=0,this.images=[],e instanceof i.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){this.filename=e.filename;let s=e.stream;if(0===s.readInt16()){this.width=s.readInt16(),this.height=s.readInt16(),this.numImages=s.readInt16();let i=[];for(let e=0;e<this.numImages;++e)i.push(this.readFrameHeader(s));this.images=[];for(let r=0;r<this.numImages;++r){var{compressionType:a,imageDataStartOffset:n,x:o,y:l,width:c,height:h}=i[r];let e=r<this.numImages-1?i[r+1].imageDataStartOffset:s.byteLength;e<n&&(e=s.byteLength);var u=e-n;s.seek(n);u=this.readImageData(s,c,h,a,u);let t=new d.ShpImage(u);t.x=o,t.y=l,t.width=c,t.height=h,this.images.push(t)}}}readFrameHeader(e){var t=e.readInt16(),i=e.readInt16(),r=e.readInt16(),s=e.readInt16(),a=e.readUint8();return e.readUint8(),e.readUint8(),e.readUint8(),e.readInt32(),e.readInt32(),{x:t,y:i,width:r,height:s,compressionType:a,imageDataStartOffset:e.readInt32()}}readImageData(r,e,s,t,i){var a=e*s;if(t<=1){var n=new Uint8Array(r.buffer,r.byteOffset+r.position,a);return r.position+=a,n}if(2===t){let e=0,t=new Uint8Array(a);for(let i=0;i<s;++i){var o=r.readUint16()-2;t.set(new Uint8Array(r.buffer,r.byteOffset+r.position,o),e),r.position+=o,e+=o}return t}if(3!==t)return new Uint8Array;a=new Uint8Array(r.buffer,r.byteOffset+r.position,i);return r.position+=i,l.Format3.decode(a,e,s)}getImage(e){if(e<0||this.images.length<=e)throw new RangeError(`Image index out of bounds (file=${this.filename}, index=${e}, length=${this.images.length})`);return this.images[e]}addImage(e){this.images.push(e),this.numImages++}clip(e,t){let i=new r;return i.filename=this.filename,i.width=Math.min(this.width,e),i.height=Math.min(this.height,t),i.images=this.images.map(e=>e.clip(i.width,i.height)),i.numImages=this.numImages,i}})}}}),System.register("data/vxl/SpanOffsets",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/vxl/Voxel",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/vxl/Span",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/vxl/normals",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=THREE.Vector3,e("normals1",[new i(.54946297,-183e-6,-.835518),new i(.00014400001,.54940403,-.83555698),new i(-.54940403,-68000001e-12,-.83555698),new i(106e-6,-.54946297,-.835518),new i(.94900799,.00031599999,-.31525001),new i(-186e-6,.94899702,-.31528401),new i(-.94899702,.00031800001,-.31528401),new i(-447e-6,-.94900799,-.31525001),new i(.95084399,-279e-6,.30967101),new i(202e-6,.95084798,.30965701),new i(-.95084798,-70000002e-12,.30965701),new i(147e-6,-.95084399,.30967101),new i(.55237001,-11e-6,.83359897),new i(19999999e-12,.55238003,.833592),new i(-.55238003,57000001e-12,.83359301),new i(-66000001e-12,-.55237001,.83359897)]),e("normals2",[new i(.67121398,.19849201,-.714194),new i(.26964301,.58439398,-.76536),new i(-.040546,.096988,-.99445897),new i(-.57242799,-.091913998,-.81478697),new i(-.17140099,-.57270998,-.80163902),new i(.36255699,-.30299899,-.88133103),new i(.81034702,-.34897199,-.470698),new i(.103962,.93867201,-.328767),new i(-.324047,.58766901,-.74137598),new i(-.80086499,.34046099,-.49264699),new i(-.66549802,-.59014702,-.45698899),new i(.314767,-.803002,-.506073),new i(.97262901,.151076,-.17655),new i(.680291,.68423599,-.26272699),new i(-.52007902,.82777703,-.210483),new i(-.96164399,-.179001,-.207847),new i(-.262714,-.937451,-.22840101),new i(.219707,-.97130102,.091124997),new i(.92380798,-.229975,.30608699),new i(-.082488999,.97065997,.225866),new i(-.59179801,.69678998,.40528899),new i(-.92529601,.36660099,.097111002),new i(-.705051,-.68777502,.172828),new i(.7324,-.68036699,-.026304999),new i(.85516202,.37458199,.358311),new i(.47300601,.83648002,.276705),new i(-.097617,.65411198,.750072),new i(-.90412402,-.153725,.39865801),new i(-.211916,-.85808998,.46773201),new i(.50022697,-.67440802,.543091),new i(.584539,-.110249,.80384099),new i(.43737301,.45464399,.77588898),new i(-.042440999,.083318003,.995619),new i(-.59625101,.22013199,.77202803),new i(-.506455,-.39697701,.76544899),new i(.070569001,-.47847399,.87526202)]),e("normals3",[new i(.45651099,-.073968001,-.88663799),new i(.50769401,.38511699,-.77067),new i(.095431998,.22666401,-.96928602),new i(-.35876599,.54318798,-.75910097),new i(-.361276,.13299499,-.92292601),new i(-.48311701,-.32406601,-.813375),new i(-.018073,-.197559,-.980124),new i(.3211,-.501477,-.80337799),new i(.79949099,.069615997,-.59662998),new i(.390971,.77130598,-.50222403),new i(.080782004,.61448997,-.784778),new i(-.73275,.41143101,-.54203498),new i(-.73525399,.0091019999,-.67773098),new i(-.80249399,-.39490801,-.44727099),new i(-.13413,-.58915502,-.79680902),new i(.71955299,-.37622699,-.58369303),new i(.96687502,.173593,-.187132),new i(.760831,.51910597,-.38944301),new i(-.114642,.87551898,-.46938601),new i(-.53236699,.76885903,-.354177),new i(-.96226698,.024977,-.27095801),new i(-.46738699,-.721986,-.51018202),new i(.058449998,-.85235399,-.51968902),new i(.49823299,-.74374002,-.44566301),new i(.93915099,-.27024499,-.212044),new i(.58393198,.80944198,-.061857),new i(.183797,.97322798,-.138007),new i(-.88435501,.45221901,-.115822),new i(-.943178,-.33206701,.012138),new i(-.69844002,-.70656699,-.113772),new i(-.228411,-.95470601,-.190694),new i(.73156399,-.675861,-.089588001),new i(.96925098,.046804,.24158201),new i(.85564703,.50347698,.119916),new i(-.25115299,.96794701,-80999998e-12),new i(-.64779502,.75674897,.087711997),new i(-.96916401,.14519399,.1991),new i(-.41479301,-.88896698,.194126),new i(.25077501,-.961178,-.115109),new i(.47862899,-.84259301,.246883),new i(.89004397,-.39614201,.225595),new i(.52405101,.76235998,.37970701),new i(.11962,.94548202,.30291),new i(-.76085001,.49007499,.42536199),new i(-.86978501,-.20215,.450122),new i(-.70946699,-.60242403,.36570701),new i(.019308999,-.95887101,.28318599),new i(.626113,-.564677,.53770101),new i(.769943,-.126663,.62541503),new i(.76419097,.35070199,.54131401),new i(-.001878,.74136698,.67109799),new i(-.37088001,.81836802,.43900099),new i(-.71390897,.12865201,.68831801),new i(-.295165,-.73866397,.60601401),new i(.186195,-.73836899,.648184),new i(.387523,-.35878301,.84917599),new i(.481022,.124846,.86777401),new i(.391808,.54505599,.741216),new i(-.0035359999,.36559799,.93076599),new i(-.42049801,.484961,.76680797),new i(-.35490301,.019470001,.93470001),new i(-.54783702,-.35920799,.75554299),new i(-.106662,-.445115,.88909799),new i(.086796001,-.059307002,.99445897)]),e("normals4",[new i(.52657801,-.35962099,-.77031702),new i(.150482,.43598399,.88728398),new i(.414195,.73825502,-.53237402),new i(.075152002,.91624898,-.393498),new i(-.316149,.93073601,-.18379299),new i(-.77381903,.62333399,-.11251),new i(-.90084201,.42853701,-.069568001),new i(-.99894202,-.010971,.044665001),new i(-.979761,-.15767001,-.123324),new i(-.91127402,-.362371,-.19562),new i(-.62406898,-.72094101,-.301301),new i(-.310173,-.80934501,-.498752),new i(.146613,-.81581903,-.55941403),new i(-.71651602,-.69435602,-.066887997),new i(.50397199,-.114202,-.85613698),new i(.45549101,.87262702,-.176211),new i(-.00501,-.114373,-.99342501),new i(-.104675,-.327701,-.93896502),new i(.56041199,.75258899,-.34575599),new i(-.060575999,.82162797,-.566796),new i(-.30234101,.79700702,-.522847),new i(-.671543,.67074001,-.314863),new i(-.77840102,-.12835699,.61450499),new i(-.92404997,.278382,-.261985),new i(-.69977301,-.55049098,-.45527801),new i(-.56824797,-.51718903,-.64000797),new i(.054097999,-.93286401,-.356143),new i(.75838202,.57289302,-.31088799),new i(.0036200001,.30502599,-.95233703),new i(-.060849998,-.98688602,-.14951099),new i(.63523,.045478001,-.77098298),new i(.52170497,.241309,-.81828701),new i(.26940399,.63542497,-.72364098),new i(.045676,.67275399,-.738455),new i(-.180511,.67465699,-.71571898),new i(-.397131,.63664001,-.66104198),new i(-.55200398,.47251499,-.687038),new i(-.77217001,.08309,-.62996),new i(-.669819,-.119533,-.73284),new i(-.54045498,-.31844401,-.77878201),new i(-.38613501,-.522789,-.75999397),new i(-.261466,-.68856698,-.676395),new i(-.019412,-.69610298,-.71767998),new i(.30356899,-.48184401,-.82199299),new i(.68193901,-.19512901,-.70490003),new i(-.24488901,-.116562,-.96251899),new i(.80075902,-.022979001,-.59854603),new i(-.37027499,.095583998,-.92399102),new i(-.33067101,-.32657799,-.88543999),new i(-.16322,-.52757901,-.83367902),new i(.12639,-.313146,-.941257),new i(.34954801,-.27222601,-.89649802),new i(.23991799,-.085825004,-.96699202),new i(.390845,.081537001,-.91683799),new i(.25526699,.26869699,-.92878503),new i(.146245,.48043799,-.86474901),new i(-.32601601,.47845599,-.81534898),new i(-.46968201,-.112519,-.87563598),new i(.81844002,-.25852001,-.51315099),new i(-.474318,.292238,-.83043301),new i(.778943,.39584199,-.48637101),new i(.62409401,.39377299,-.67487001),new i(.74088597,.203834,-.63995302),new i(.48021701,.565768,-.67029703),new i(.38093001,.42453501,-.82137799),new i(-.093422003,.50112402,-.86031801),new i(-.236485,.29619801,-.92538702),new i(-.131531,.093959004,-.98684901),new i(-.82356203,.29577699,-.48400599),new i(.61106598,-.624304,-.486664),new i(.069495998,-.52033001,-.85113299),new i(.226522,-.66487902,-.711775),new i(.47130799,-.56890398,-.67395699),new i(.38842499,-.74262398,-.54556),new i(.78367501,-.48072901,-.39338499),new i(.962394,.135676,-.235349),new i(.876607,.172034,-.449406),new i(.63340503,.58979303,-.50094098),new i(.182276,.80065799,-.57072097),new i(.177003,.76413399,.62029701),new i(-.544016,.675515,-.49772099),new i(-.67929697,.28646699,-.67564201),new i(-.59039098,.091369003,-.801929),new i(-.82436001,-.13312399,-.55018902),new i(-.71579403,-.33454201,-.61296099),new i(.17428599,-.89248401,.416049),new i(-.082528003,-.83712298,-.54075301),new i(.28333101,-.88087398,-.37918901),new i(.675134,-.42662701,-.60181701),new i(.84372002,-.512335,-.160156),new i(.97730398,-.098555997,-.18752),new i(.846295,.522672,-.102947),new i(.67714101,.72132498,-.145501),new i(.32096499,.87089199,-.37219399),new i(-.178978,.911533,-.37023601),new i(-.44716901,.82670099,-.341474),new i(-.70320302,.496328,-.50908101),new i(-.97718102,.063562997,-.202674),new i(-.87817001,-.412938,.241455),new i(-.83583099,-.35855001,-.415728),new i(-.499174,-.69343299,-.51959199),new i(-.188789,-.92375302,-.33322501),new i(.19225401,-.96936101,-.152896),new i(.51594001,-.783907,-.34539199),new i(.90592498,-.30095199,-.29787099),new i(.99111199,-.127746,.037106998),new i(.99513501,.098424003,-.0043830001),new i(.76012301,.64627701,.067367002),new i(.205221,.95958,-.192591),new i(-.042750001,.97951299,-.19679099),new i(-.43801701,.89892697,.0084920004),new i(-.82199401,.48078501,-.30523899),new i(-.89991701,.081710003,-.42833701),new i(-.92661202,-.144618,-.347096),new i(-.79365999,-.55779201,-.24283899),new i(-.43134999,-.84777898,-.30855799),new i(-.0054919999,-.96499997,.26219299),new i(.58790499,-.80402601,-.088940002),new i(.69949299,-.66768599,-.254765),new i(.88930303,.359795,-.282291),new i(.780972,.197037,.59267199),new i(.52012098,.50669599,.68755698),new i(.40389499,.69396102,.59605998),new i(-.154983,.89923602,.40909001),new i(-.65733802,.53716803,.528543),new i(-.74619502,.33409101,.575827),new i(-.62495202,-.049144,.77911502),new i(.31814101,-.254715,.913185),new i(-.555897,.405294,.725752),new i(-.79443401,.099405997,.59916002),new i(-.64036101,-.68946302,.33849499),new i(-.12671299,-.73409498,.66711998),new i(.105457,-.78081697,.61579502),new i(.40799299,-.48091599,.77605498),new i(.69513601,-.54512,.468647),new i(.97319102,-.0064889998,.229908),new i(.94689399,.317509,-.050799001),new i(.56358302,.82561201,.027183),new i(.325773,.94542301,.0069490001),new i(-.171821,.98509699,-.0078149997),new i(-.67044097,.73993897,.054768998),new i(-.822981,.55496198,.121322),new i(-.96619302,.117857,.229307),new i(-.95376903,-.29470399,.058945),new i(-.86438698,-.50272799,-.010015),new i(-.53060901,-.84200603,-.097365998),new i(-.162618,-.98407501,.071772002),new i(.081446998,-.99601102,.036439002),new i(.74598402,-.66596299,.00076199998),new i(.94205701,-.32926899,-.064106002),new i(.93970197,-.28108999,.194803),new i(.77121401,.55067003,.319363),new i(.641348,.73069,.23402099),new i(.080682002,.99669099,.0098789996),new i(-.046725001,.97664303,.20972501),new i(-.53107601,.82100099,.209562),new i(-.69581503,.65599,.29243499),new i(-.97612202,.216709,-.014913),new i(-.96166098,-.14412899,.23331399),new i(-.772084,-.61364698,.165299),new i(-.44960001,-.83605999,.314426),new i(-.39269999,-.91461599,.096247002),new i(.390589,-.91947001,.044890001),new i(.58252901,-.79919797,.148127),new i(.866431,-.48981199,.096864),new i(.90458697,.111498,.41145),new i(.95353699,.23232999,.191806),new i(.497311,.77080297,.398177),new i(.194066,.95631999,.218611),new i(.422876,.882276,.206797),new i(-.373797,.84956598,.37217399),new i(-.53449702,.71402299,.4522),new i(-.881827,.23716,.40759799),new i(-.904948,-.014069,.42528901),new i(-.751827,-.51281703,.41445801),new i(-.50101501,-.69791698,.51175803),new i(-.23519,-.92592299,.295555),new i(.228983,-.95393997,.193819),new i(.734025,-.63489801,.241062),new i(.91375297,-.063253,-.40131599),new i(.90573502,-.161487,.391875),new i(.85892999,.342446,.38074899),new i(.62448603,.60758102,.49077699),new i(.28926399,.85747898,.42550799),new i(.069968,.90216899,.42567101),new i(-.28617999,.94069999,.182165),new i(-.57401299,.80511898,-.14930899),new i(.111258,.099717997,-.98877603),new i(-.30539301,-.94422799,-.12316),new i(-.60116601,-.78957599,.123163),new i(-.290645,-.81213999,.50591898),new i(-.064920001,-.87716299,.47578499),new i(.408301,-.862216,.29978901),new i(.56609702,-.72556603,.39126399),new i(.83936399,-.427387,.33586901),new i(.81889999,-.041305002,.57244802),new i(.71978402,.41499701,.55649698),new i(.88174403,.45027,.140659),new i(.40182301,-.89822,-.17815199),new i(-.054019999,.79134399,.60898),new i(-.29377401,.76399398,.57446498),new i(-.450798,.61034697,.65135098),new i(-.63822103,.186694,.74687302),new i(-.87287003,-.25712699,.41470799),new i(-.58725703,-.52170998,.618828),new i(-.35365799,-.64197397,.680291),new i(.041648999,-.61127299,.79032302),new i(.348342,-.77918297,.52108699),new i(.499167,-.62244099,.602826),new i(.79001898,-.30383101,.53250003),new i(.66011798,.060733002,.74870199),new i(.60492098,.29416099,.73996001),new i(.38569701,.37934601,.84103203),new i(.239693,.207876,.94833201),new i(.012623,.25853199,.96591997),new i(-.100557,.457147,.88368797),new i(.046967,.62858802,.77631903),new i(-.43039101,-.44540501,.785097),new i(-.43429101,-.196228,.87913901),new i(-.25663701,-.336867,.90590203),new i(-.131372,-.15891001,.97851402),new i(.102379,-.208767,.972592),new i(.195687,-.450129,.87125802),new i(.62731898,-.42314801,.65377098),new i(.68743902,-.171583,.70568198),new i(.27592,-.021255,.96094602),new i(.45936701,.15746599,.87417799),new i(.285395,.583184,.76055598),new i(-.81217402,.46030301,.35846099),new i(-.189068,.64122301,.743698),new i(-.338875,.47648001,.811252),new i(-.92099398,.347186,.176727),new i(.040638998,.024465,.99887401),new i(-.73913199,-.35374701,.57318997),new i(-.60351199,-.28661501,.74405998),new i(-.188676,-.547059,.81555402),new i(-.026045,-.39782,.91709399),new i(.26789701,-.649041,.71202302),new i(.518246,-.28489101,.80638599),new i(.493451,-.066532999,.86722499),new i(-.328188,.140251,.93414301),new i(.328188,.140251,.93414301),new i(-.328188,.140251,.93414301),new i(-.328188,.140251,.93414301),new i(-.328188,.140251,.93414301)])}}}),System.register("data/vxl/VoxelField",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("VoxelField",i=class{constructor(e,t,i){this.sizeX=e,this.sizeY=t,this.sizeZ=i,this.arr=new Array(e*t*i)}add(e){this.arr[e.x+e.y*this.sizeX+e.z*this.sizeX*this.sizeY]=e}get(e,t,i){if(!(e>=this.sizeX||t>=this.sizeY||i>=this.sizeZ))return this.arr[e+t*this.sizeX+i*this.sizeX*this.sizeY]}})}}}),System.register("data/vxl/Section",["data/vxl/normals","data/vxl/VoxelField"],function(e,t){"use strict";var i,o,r;t&&t.id;return{setters:[function(e){i=e},function(e){o=e}],execute:function(){e("Section",r=class{get spanX(){return this.maxBounds.x-this.minBounds.x}get spanY(){return this.maxBounds.y-this.minBounds.y}get spanZ(){return this.maxBounds.z-this.minBounds.z}get scaleX(){return this.spanX/this.sizeX}get scaleY(){return this.spanY/this.sizeY}get scaleZ(){return this.spanZ/this.sizeZ}get scale(){return new THREE.Vector3(this.scaleX,this.scaleY,this.scaleZ)}getAllVoxels(){let i=[],r=new o.VoxelField(this.sizeX+1,this.sizeY+1,this.sizeZ+1);for(let n=0,e=this.spans.length;n<e;n++){var s=this.spans[n].voxels;for(let e=0,t=s.length;e<t;e++){var a=s[e];i.push(a),r.add(a)}}return{voxels:i,voxelField:r}}getNormals(){switch(this.normalsMode){case 1:return i.normals1;case 2:return i.normals2;case 3:return i.normals3;case 4:return i.normals4;default:throw new Error("Invalid normalsmode "+this.normalsMode)}}scaleHvaMatrix(e){return(e=e.clone()).elements[12]*=this.hvaMultiplier,e.elements[13]*=this.hvaMultiplier,e.elements[14]*=this.hvaMultiplier,e}toPlain(){return{name:this.name,normalsMode:this.normalsMode,minBounds:this.minBounds.toArray(),maxBounds:this.maxBounds.toArray(),sizeX:this.sizeX,sizeY:this.sizeY,sizeZ:this.sizeZ,hvaMultiplier:this.hvaMultiplier,transfMatrix:this.transfMatrix.toArray(),spans:this.spans}}fromPlain(e){return this.name=e.name,this.normalsMode=e.normalsMode,this.minBounds=(new THREE.Vector3).fromArray(e.minBounds),this.maxBounds=(new THREE.Vector3).fromArray(e.maxBounds),this.sizeX=e.sizeX,this.sizeY=e.sizeY,this.sizeZ=e.sizeZ,this.hvaMultiplier=e.hvaMultiplier,this.transfMatrix=(new THREE.Matrix4).fromArray(e.transfMatrix),this.spans=e.spans,this}})}}}),System.register("data/vxl/VxlHeader",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("VxlHeader",i=class{read(e){this.fileName=e.readCString(16),this.paletteCount=e.readUint32(),this.headerCount=e.readUint32(),this.tailerCount=e.readUint32(),this.bodySize=e.readUint32(),this.paletteRemapStart=e.readUint8(),this.paletteRemapEnd=e.readUint8(),e.seek(e.position+768)}}),i.size=32}}}),System.register("data/VxlFile",["data/vfs/VirtualFile","data/vxl/Section","data/vxl/VxlHeader"],function(e,t){"use strict";var i,c,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){c=e},function(e){r=e}],execute:function(){e("VxlFile",s=class{constructor(e){this.voxelCount=0,e instanceof i.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){this.filename=e.filename;let n=e.stream;if(this.sections=[],!(n.byteLength<r.VxlHeader.size)){let a=new r.VxlHeader;if(a.read(n),a.headerCount&&a.tailerCount&&a.tailerCount===a.headerCount){for(let i=0;i<a.headerCount;++i){const l=new c.Section;this.readSectionHeader(l,n),this.sections.find(e=>e.name===l.name)&&console.warn(`Duplicate section name "${l.name}" found in VXL "${this.filename}".`),this.sections.push(l)}var o=n.position;n.seek(n.position+a.bodySize);let e=[];for(let r=0;r<a.tailerCount;++r)e[r]=this.readSectionTailer(this.sections[r],n);let t=0;for(let s=0;s<a.headerCount;++s)n.seek(o),t+=this.readSectionBodySpans(this.sections[s],e[s],n);this.voxelCount=t}}}readSectionHeader(e,t){e.name=t.readCString(16),t.readUint32(),t.readUint32(),t.readUint32()}readSectionTailer(e,t){var i=t.readUint32(),r=t.readUint32(),s=t.readUint32();return e.hvaMultiplier=t.readFloat32(),e.transfMatrix=this.readTransfMatrix(t),e.minBounds=new THREE.Vector3(t.readFloat32(),t.readFloat32(),t.readFloat32()),e.maxBounds=new THREE.Vector3(t.readFloat32(),t.readFloat32(),t.readFloat32()),e.sizeX=t.readUint8(),e.sizeY=t.readUint8(),e.sizeZ=t.readUint8(),e.normalsMode=t.readUint8(),{startingSpanOffset:i,endingSpanOffset:r,dataSpanOffset:s}}readTransfMatrix(e){let t=[];for(let i=0;i<3;++i)t.push(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());return t.push(0,0,0,1),(new THREE.Matrix4).fromArray(t).transpose()}readSectionBodySpans(e,t,i){i.seek(i.position+t.startingSpanOffset);var{sizeX:r,sizeY:s,sizeZ:a}=e;let n=new Array(s);for(let u=0;u<s;++u){n[u]=new Array(r);for(let e=0;e<r;++e)n[u][e]=i.readInt32()}let o=new Array(s);for(let d=0;d<s;++d){o[d]=new Array(r);for(let e=0;e<r;++e)o[d][e]=i.readInt32()}let l=e.spans=[],c=0;for(let g=0;g<s;++g)for(let e=0;e<r;++e){var h={x:e,y:g,voxels:this.readSpanVoxels(n[g][e],o[g][e],e,g,a,i)};l.push(h),c+=h.voxels.length}return c}readSpanVoxels(e,t,i,r,s,a){if(-1===e||-1===t)return[];let n=[];for(let c=0;c<s;){c+=a.readUint8();var o=a.readUint8();for(let e=0;e<o;++e){var l={x:i,y:r,z:c++,colorIndex:a.readUint8(),normalIndex:a.readUint8()};n.push(l)}a.readUint8()}return n}fromPlain(e){return this.sections=e.sections.map(e=>(new c.Section).fromPlain(e)),this.voxelCount=e.voxelCount,this}toPlain(){return{sections:this.sections.map(e=>e.toPlain()),voxelCount:this.voxelCount}}getSection(e){return this.sections[e]}})}}}),System.register("data/TmpImage",[],function(t,e){"use strict";var a,r,i;e&&e.id;return{setters:[],execute:function(){var e;(e=a=a||{})[e.ExtraData=1]="ExtraData",e[e.ZData=2]="ZData",e[e.DamagedData=4]="DamagedData",r=e=>e<0?e+256:e,t("TmpImage",i=class{constructor(e,t,i){this.fromStream(e,t,i)}fromStream(e,t,i){this.x=e.readInt32(),this.y=e.readInt32(),e.readInt32(),e.readInt32();var r=e.readInt32();this.extraX=e.readInt32(),this.extraY=e.readInt32(),this.extraWidth=e.readInt32(),this.extraHeight=e.readInt32();var s=e.readUint32();this.height=e.readUint8(),this.terrainType=e.readUint8(),this.rampType=e.readUint8(),this.radarLeft=this.readRadarRgb(e.readInt8(),e.readInt8(),e.readInt8()),this.radarRight=this.readRadarRgb(e.readInt8(),e.readInt8(),e.readInt8()),e.seek(e.position+3),this.tileData=new Uint8Array(e.buffer,e.byteOffset+e.position,t*i/2),e.position+=t*i/2,this.hasZData=(s&a.ZData)===a.ZData,this.hasZData&&(e.position+=t*i/2),this.hasExtraData=(s&a.ExtraData)===a.ExtraData,this.hasExtraData&&(s=Math.abs(this.extraWidth*this.extraHeight),this.extraData=new Uint8Array(e.buffer,e.byteOffset+e.position,s),e.position+=s),this.hasZData&&this.hasExtraData&&0<r&&r<e.byteLength&&(e.position+=Math.abs(this.extraWidth*this.extraHeight))}readRadarRgb(e,t,i){return new THREE.Color(r(e)/255,r(t)/255,r(i)/255)}})}}}),System.register("data/TmpFile",["data/TmpImage","data/vfs/VirtualFile"],function(e,t){"use strict";var n,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){i=e}],execute:function(){e("TmpFile",r=class{constructor(e){this.images=[],e instanceof i.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){let t=e.stream;this.width=t.readInt32(),this.height=t.readInt32(),this.blockWidth=t.readInt32(),this.blockHeight=t.readInt32();var i=this.width*this.height,r=new Uint8Array(t.buffer,t.byteOffset+t.position,4*i);this.images=[];for(let a=0;a<i;a++){var s=r[4*a+3]<<24|r[4*a+2]<<16|r[4*a+1]<<8|r[4*a];t.seek(s);s=new n.TmpImage(t,this.blockWidth,this.blockHeight);this.images.push(s)}}})}}}),System.register("util/Base64",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Base64",i=class{static encode(e){return void 0!==globalThis.btoa?globalThis.btoa(e):Buffer.from(e,"binary").toString("base64")}static decode(e){return void 0!==globalThis.atob?globalThis.atob(e):Buffer.from(e,"base64").toString("binary")}static isBase64(e){return!!e.match(/^([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$/)}})}}}),System.register("util/string",["util/Base64"],function(e,t){"use strict";var i;t&&t.id;function r(e){var t=e.length;let i=new Uint8Array(t);for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i}function s(e){return e.reduce((e,t)=>e+String.fromCharCode(t),"")}return e("pad",function(e,t="0000"){var i=""+e;return t.substring(0,t.length-i.length)+i}),e("equalsIgnoreCase",function(e,t){return e.toLowerCase()===t.toLowerCase()}),e("binaryStringToUint8Array",r),e("base64StringToUint8Array",function(e){return r(i.Base64.decode(e))}),e("uint8ArrayToBase64String",function(e){return i.Base64.encode(s(e))}),e("uint8ArrayToBinaryString",s),e("utf16ToBinaryString",function(e){var t=e.length;let i="";for(let s=0;s<t;s++){var r=e.charCodeAt(s);i+=String.fromCharCode(r>>8),i+=String.fromCharCode(255&r)}return i}),e("binaryStringToUtf16",function(e){var t=e.length;let i="";for(let s=0;s<t;s+=2){var r=(e.charCodeAt(s)<<8)+e.charCodeAt(s+1);i+=String.fromCharCode(r)}return i}),e("bufferToHexString",function(e){const t=[],i=new DataView(e);for(let s=0;s<i.byteLength;s+=4){const a=i.getUint32(s);var r="00000000",r=(r+a.toString(16)).slice(-r.length);t.push(r)}return t.join("")}),{setters:[function(e){i=e}],execute:function(){}}}),System.register("util/Color",["util/string"],function(e,t){"use strict";var i,u;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Color",u=class u{constructor(e,t,i){this.r=e,this.g=t,this.b=i}static fromRgb(e,t,i){return new u(e,t,i)}static fromHsv(e,t,i){let r=0,s=0,a=0;if(e=e/255*360%360,i/=255,0===(t/=255))r=i,s=i,a=i;else{var n=e/60,o=Math.floor(n),n=n-o,l=i*(1-t),c=i*(1-t*n),h=i*(1-t*(1-n));switch(o){case 0:r=i,s=h,a=l;break;case 1:r=c,s=i,a=l;break;case 2:r=l,s=i,a=h;break;case 3:r=l,s=c,a=i;break;case 4:r=h,s=l,a=i;break;case 5:r=i,s=l,a=c}}return u.fromRgb(Math.floor(255*r),Math.floor(255*s),Math.floor(255*a))}asHex(){return(this.r<<16)+(this.g<<8)+this.b}asHexString(){return"#"+i.pad(this.asHex().toString(16),"000000")}clone(){return new u(this.r,this.g,this.b)}})}}}),System.register("util/math",[],function(e,t){"use strict";t&&t.id;return e("getRandomInt",function(e,t){return Math.round(Math.random()*(t-e))+e}),e("clamp",function(e,t,i){return Math.min(i,Math.max(e,t))}),e("isBetween",function(e,t,i){return t<=e&&e<=i}),e("lerp",function(e,t,i){return(1-i)*e+i*t}),e("truncToDecimals",function(e,t){if(!e)return e;var i=10**t;return 0<=e?Math.floor(e*i)/i:Math.ceil(e*i)/i}),e("roundToDecimals",function(e,t){if(!e)return e;var i=10**t;return Math.round(e*i)/i}),e("floorTo",function(e,t){return Math.floor(e/t)*t}),e("fnv32a",function(e){let t=2166136261;for(let i=0,r=e.length;i<r;++i)t^=e[i],t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0}),{setters:[],execute:function(){}}}),System.register("data/Palette",["util/Color","util/math","data/vfs/VirtualFile"],function(e,t){"use strict";var i,s,r,a;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e}],execute:function(){e("Palette",a=class a{constructor(e){e instanceof r.VirtualFile?this.fromVirtualFile(e):"object"==typeof e&&this.fromJson(e)}fromVirtualFile(e){var t=e.stream.readUint8Array(768);this.fromJson(t)}fromJson(e){this.colors=[];for(let t=0;t<e.length/3;++t)this.colors.push(i.Color.fromRgb(4*e[3*t],4*e[3*t+1],4*e[3*t+2]));this._hash=this.computeHash(this.colors)}getColor(e){return this.colors[e]}getColorAsHex(e){return this.getColor(e).asHex()}setColors(e){this.colors=e,this._hash=this.computeHash(this.colors)}get size(){return this.colors.length}get hash(){return this._hash}computeHash(e){let t=new Uint8Array(3*this.size),i=0;for(var r of e)t[i]=r.r,t[i+1]=r.g,t[i+2]=r.b,i+=3;return s.fnv32a(t)}clone(){let e=new a;return e.colors=this.colors.map(e=>e.clone()),e._hash=this._hash,e}remap(e){var t=[63,59,55,52,48,44,41,37,33,30,26,22,19,15,11,8];for(let i=a.REMAP_START_IDX;i<a.REMAP_START_IDX+t.length;i++)this.colors[i].r=Math.floor(e.r/255*t[i-a.REMAP_START_IDX]*4),this.colors[i].g=Math.floor(e.g/255*t[i-a.REMAP_START_IDX]*4),this.colors[i].b=Math.floor(e.b/255*t[i-a.REMAP_START_IDX]*4);return this._hash=this.computeHash(this.colors),this}}),a.REMAP_START_IDX=16}}}),System.register("game/theater/TileSet",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("TileSet",i=class{constructor(e,t,i){this.fileName=e,this.setName=t,this.tilesInSet=i,this.entries=[]}})}}}),System.register("game/theater/TileSetAnim",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("TileSetAnim",i=class{constructor(e,t,i,r){this.name=e,this.subTile=t,this.offsetX=i,this.offsetY=r}})}}}),System.register("game/theater/TileSetEntry",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("TileSetEntry",i=class{constructor(e,t){this.owner=e,this.index=t,this.files=[]}addFile(e){this.files.push(e)}setAnimation(e){this.animation=e}getAnimation(){return this.animation}getTmpFile(e,t,i=!1){if(this.files.length){var r=this.files[t(0,this.files.length-1)];return r.images[Math.min(e,r.images.length-1)].hasDamagedData?this.files[Math.min(i?1:0,this.files.length-1)]:r}}})}}}),System.register("engine/ResourceCollection",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/theater/TileSets",["util/string","game/theater/TileSetEntry","game/theater/TileSet","game/theater/TileSetAnim"],function(t,e){"use strict";var c,h,u,o,i,s,r;e&&e.id;return{setters:[function(e){c=e},function(e){h=e},function(e){u=e},function(e){o=e}],execute:function(){var e;(e=i=i||{})[e.TopLeft=0]="TopLeft",e[e.BottomRight=1]="BottomRight",e[e.TopRight=2]="TopRight",e[e.BottomLeft=3]="BottomLeft",e[e.MiddleTlBr=4]="MiddleTlBr",e[e.MiddleTrBl=5]="MiddleTrBl",t("HighBridgeHeadType",i),s=new Map([[i.TopLeft,["BridgeTopLeft1","BridgeTopLeft2"]],[i.BottomRight,["BridgeBottomRight1","BridgeBottomRight2"]],[i.TopRight,["BridgeTopRight1","BridgeTopRight2"]],[i.BottomLeft,["BridgeBottomLeft1","BridgeBottomLeft2"]],[i.MiddleTlBr,["BridgeMiddle1"]],[i.MiddleTrBl,["BridgeMiddle2"]]]),t("TileSets",r=class{constructor(e){this.theaterIni=e,this.tileSets=[],this.orderedEntries=[],this.highBridgeSetNums=[this.getGeneralValue("BridgeSet"),this.getGeneralValue("WoodBridgeSet")],this.cliffSetNums=[this.getGeneralValue("CliffSet"),this.getGeneralValue("WaterCliffs"),this.getGeneralValue("DestroyableCliffs")]}getTile(e){return this.orderedEntries[e]}getTileImage(e,t,i){let r=this.getTile(e);if(!r)throw new Error(`TileNum ${e} not found`);var s=r.getTmpFile(t,i);if(!s||t>=s.images.length)throw new Error(`SubTile ${t} not found`);return s.images[t]}getSetNum(e){var t=this.orderedEntries[e];if(!t)throw new Error("Invalid tileNum "+e);return this.tileSets.indexOf(t.owner)}getTileNumFromSet(i,r=0){let s=0;return this.tileSets.some((e,t)=>t===i?(s+=r,!0):(s+=e.entries.length,!1)),s}getGeneralValue(e){let t=this.theaterIni.getSection("General");if(!t)throw new Error("Missing [General] section in theather ini");return t.getNumber(e)}loadTileData(e,t){this.tileSets.length=0,this.orderedEntries.length=0,this.initTileSets(e,t),this.initAnimations()}readMaxTileNum(){let t=0,i=0;for(;;){var r="TileSet"+c.pad(t,"0000");let e=this.theaterIni.getSection(r);if(!e)break;t++,i+=e.getNumber("TilesInSet")}return i}initTileSets(a,n){let e=0,t;for(var i;;){if(i="TileSet"+c.pad(e,"0000"),t=this.theaterIni.getSection(i),!t)break;e++;let r=new u.TileSet(t.getString("FileName"),t.getString("SetName"),t.getNumber("TilesInSet"));this.tileSets.push(r);for(let s=1;s<=r.tilesInSet;s++){let t=new h.TileSetEntry(r,s-1);var o="a".charCodeAt(0);for(let i=o-1;i<="z".charCodeAt(0);i++)if(!(i>=o&&"Bridges"===r.setName)){let e=r.fileName+c.pad(s,"00");i>=o&&(e+=String.fromCharCode(i)),e+=n;var l=a.get(e);if(!l)break;t.addFile(l)}r.entries.push(t),this.orderedEntries.push(t)}}}initAnimations(){var e=this.theaterIni.getOrderedSections();for(let n=this.tileSets.length;n<e.length;++n){let t=e[n],i=this.tileSets.find(e=>e.setName===t.name);if(i)for(let e=1;e<=i.tilesInSet;++e){var r="Tile"+c.pad(e,"00"),s=r+"Anim",a=t.getString(s);a?(r=new o.TileSetAnim(a,t.getNumber(r+"AttachesTo"),t.getNumber(r+"XOffset"),t.getNumber(r+"YOffset")),i.entries[e-1].setAnimation(r)):console.warn(`Missing anim "${s}" for tileset `+i.setName)}}}isLAT(e){return e===this.getGeneralValue("RoughTile")||e===this.getGeneralValue("SandTile")||e===this.getGeneralValue("GreenTile")||e===this.getGeneralValue("PaveTile")}isCLAT(e){return e===this.getGeneralValue("ClearToRoughLat")||e===this.getGeneralValue("ClearToSandLat")||e===this.getGeneralValue("ClearToGreenLat")||e===this.getGeneralValue("ClearToPaveLat")}getLAT(e){return e===this.getGeneralValue("ClearToRoughLat")?this.getGeneralValue("RoughTile"):e===this.getGeneralValue("ClearToSandLat")?this.getGeneralValue("SandTile"):e===this.getGeneralValue("ClearToGreenLat")?this.getGeneralValue("GreenTile"):e===this.getGeneralValue("ClearToPaveLat")?this.getGeneralValue("PaveTile"):-1}getCLATSet(e){return e===this.getGeneralValue("RoughTile")?this.getGeneralValue("ClearToRoughLat"):e===this.getGeneralValue("SandTile")?this.getGeneralValue("ClearToSandLat"):e===this.getGeneralValue("GreenTile")?this.getGeneralValue("ClearToGreenLat"):e===this.getGeneralValue("PaveTile")?this.getGeneralValue("ClearToPaveLat"):-1}canConnectTiles(e,t){if(e===t)return!1;var i=this.getGeneralValue("GreenTile"),r=this.getGeneralValue("PaveTile"),s=this.getGeneralValue("MiscPaveTile"),a=this.getGeneralValue("ShorePieces"),n=this.getGeneralValue("WaterBridge"),o=this.getGeneralValue("PavedRoads"),l=this.getGeneralValue("Medians");return!(e===i&&t===a||t===i&&e===a)&&(!(e===i&&t===n||t===i&&e===n)&&(!(e===r&&t===o||t===r&&e===o)&&(!(e===r&&t===s||t===r&&e===s)&&!(e===r&&t===l||t===r&&e===l))))}getHighBridgeHeadType(e){for(var[t,i]of s)for(var r of i)if(this.getGeneralValue(r)===e+1)return t}getOppositeHighBridgeHeadType(e){switch(e){case i.TopLeft:return i.BottomRight;case i.TopRight:return i.BottomLeft;case i.BottomLeft:return i.TopRight;case i.BottomRight:return i.TopLeft;case i.MiddleTlBr:case i.MiddleTrBl:throw new Error("Middle bridge heads can't have opposites");default:throw new Error("Unhandled headType "+e)}}isCliffTile(e){return this.cliffSetNums.includes(this.getSetNum(e))}isHighBridgeBoundaryTile(e){if(this.highBridgeSetNums.includes(this.getSetNum(e))){var t=this.getTile(e),t=this.getHighBridgeHeadType(t.index);return void 0!==t&&![i.MiddleTlBr,i.MiddleTrBl].includes(t)}return!1}isHighBridgeMiddleTile(e){if(this.highBridgeSetNums.includes(this.getSetNum(e))){var t=this.getTile(e),t=this.getHighBridgeHeadType(t.index);return void 0!==t&&[i.MiddleTlBr,i.MiddleTrBl].includes(t)}return!1}})}}}),System.register("engine/type/PaletteType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Iso=1]="Iso",e[e.Unit=2]="Unit",e[e.Overlay=3]="Overlay",e[e.Anim=4]="Anim",e[e.Custom=5]="Custom",e[e.Default=6]="Default",t("PaletteType",i)}}}),System.register("engine/TheaterType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Temperate=1]="Temperate",e[e.Urban=2]="Urban",e[e.Snow=4]="Snow",e[e.Lunar=8]="Lunar",e[e.Desert=16]="Desert",e[e.NewUrban=32]="NewUrban",e[e.All=63]="All",t("TheaterType",i)}}}),System.register("engine/Theater",["game/theater/TileSets","engine/type/PaletteType"],function(e,t){"use strict";var u,r,i;t&&t.id;return{setters:[function(e){u=e},function(e){r=e}],execute:function(){e("Theater",i=class{constructor(e,t,i,r,s,a,n,o,l){this.type=e,this.settings=t,this.palettes=i,this.isoPalette=r,this.ovlPalette=s,this.unitPalette=a,this.animPalette=n,this.libPalette=o,this.tileSets=l}static factory(e,t,i,r,s){var a=s.get(i.IsoPaletteName);if(!a)throw new Error(`Missing palette "${i.IsoPaletteName}"`);var n=s.get(i.OverlayPaletteName);if(!n)throw new Error(`Missing palette "${i.OverlayPaletteName}"`);var o=s.get(i.UnitPaletteName);if(!o)throw new Error(`Missing palette "${i.UnitPaletteName}"`);var l=s.get("anim.pal");if(!l)throw new Error("Missing anim palette");var c=s.get(i.LibPaletteName);if(!c)throw new Error("Missing lib palette "+i.LibPaletteName);let h=new u.TileSets(t);return h.loadTileData(r,i.Extension),new this(e,i,s,a,n,o,l,c,h)}getPalette(e,t){switch(e){case r.PaletteType.Anim:return this.animPalette;case r.PaletteType.Overlay:return this.ovlPalette;case r.PaletteType.Unit:return this.unitPalette;case r.PaletteType.Custom:if("lib"===t)return this.libPalette;var i=this.palettes.get(t+".pal");if(!i)throw new Error(`Custom palette "${t}" not found`);return i;default:r.PaletteType.Iso;return this.isoPalette}}})}}}),System.register("version",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("version","0.57.3")}}}),System.register("data/IdxEntry",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("IdxEntry",i=class{})}}}),System.register("data/IdxFile",["data/IdxEntry"],function(e,t){"use strict";var n,i;t&&t.id;return{setters:[function(e){n=e}],execute:function(){e("IdxFile",i=class{constructor(e){this.entries=new Map,this.parse(e)}parse(t){var e=t.readCString(4);if("GABA"!==e)throw new Error(`Unable to load Idx file, did not find magic id, found ${e} instead`);e=t.readInt32();if(2!==e)throw new Error(`Unable to load Idx file, did not find magic number 2, found ${e} instead`);var i=t.readInt32();for(let s=0;s<i;s++){const a=new n.IdxEntry;let e=t.readString(16);var r=e.indexOf("\0");0!==r&&(e=e.substr(0,r)),a.filename=e+".wav",a.offset=t.readUint32(),a.length=t.readUint32(),a.sampleRate=t.readUint32(),a.flags=t.readUint32(),a.chunkSize=t.readUint32(),this.entries.set(a.filename,a)}}})}}}),System.register("data/vfs/Archive",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/AudioBagFile",["data/DataStream","data/vfs/VirtualFile"],function(e,t){"use strict";var h,i,r;t&&t.id;return{setters:[function(e){h=e},function(e){i=e}],execute:function(){e("AudioBagFile",r=class{constructor(){this.fileData=new Map}fromVirtualFile(e,t){var i,r;for([i,r]of t.entries){var s=this.buildWavData(e.stream,r);this.fileData.set(i,s)}return this}getFileList(){return[...this.fileData.keys()]}containsFile(e){return this.fileData.has(e)}openFile(e){if(!this.containsFile(e))throw new Error(`File "${e}" not found`);return new i.VirtualFile(this.fileData.get(e),e)}buildWavData(e,t){let i=new h.DataStream;var r,s,a,n,o=0<(1&t.flags)?2:1;let l=0;0<(2&t.flags)?(i.writeString("RIFF"),i.writeUint32(t.length+36),i.writeString("WAVE"),i.writeString("fmt "),i.writeInt32(16),i.writeInt16(1),i.writeInt16(o),i.writeUint32(t.sampleRate),i.writeUint32(2*o*t.sampleRate),i.writeInt16(2*o),i.writeInt16(16),i.writeString("data"),i.writeUint32(t.length)):0<(8&t.flags)&&(r=11100*o*(t.sampleRate/22050|0),s=t.chunkSize,a=1017*(n=Math.max(2,Math.ceil(t.length/s))),n=n*s,l=n-t.length,i.writeString("RIFF"),i.writeUint32(52+n),i.writeString("WAVE"),i.writeString("fmt "),i.writeUint32(20),i.writeInt16(17),i.writeInt16(o),i.writeUint32(t.sampleRate),i.writeInt32(r),i.writeInt16(s),i.writeInt16(4),i.writeInt16(2),i.writeInt16(1017),i.writeString("fact"),i.writeUint32(4),i.writeInt32(a),i.writeString("data"),i.writeUint32(n)),e.seek(t.offset),i.writeUint8Array(e.readUint8Array(t.length));for(let c=0;c<l;c++)i.writeUint8(0);return i.seek(0),i._trimAlloc=()=>{},i}})}}}),System.register("data/encoding/Blowfish",[],function(e,t){"use strict";var i;t&&t.id;function o(e){return e=((e=(e<<16>>>0|e>>>16)>>>0)<<8>>>0&4278255360|e>>>8&16711935)>>>0}return{setters:[],execute:function(){e("Blowfish",i=class{constructor(e){this.m_p=new Uint32Array([608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731]),this.m_s=[new Uint32Array([3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946]),new Uint32Array([1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055]),new Uint32Array([3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504]),new Uint32Array([976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462])];for(let o=0,l=0;o<18;++o){var t=e[l++%e.length],i=e[l++%e.length],r=e[l++%e.length],s=e[l++%e.length];this.m_p[o]^=t<<24|i<<16|r<<8|s}let a=0,n=0;for(let c=0;c<18;)[a,n]=this._encrypt(a,n),this.m_p[c++]=a,this.m_p[c++]=n;for(let h=0;h<4;++h)for(let e=0;e<256;)[a,n]=this._encrypt(a,n),this.m_s[h][e++]=a,this.m_s[h][e++]=n}encrypt(e){return this.runCipher(e,this._encrypt.bind(this))}decrypt(e){return this.runCipher(e,this._decrypt.bind(this))}runCipher(e,t){let i=new Uint32Array(e.length),r=e.length/2|0,s=0;for(;0<r--;){var a=o(e[s]),n=o(e[s+1]);[a,n]=t(a,n),i[s++]=o(a),i[s++]=o(n)}return i}_encrypt(e,t){let i=e,r=t;i^=this.m_p[0];let s=!1;for(let a=1;a<=16;a++,s=!s)s?i=this.round(i,r,a):r=this.round(r,i,a);return r^=this.m_p[17],[r,i]}_decrypt(e,t){let i=e,r=t;i^=this.m_p[17];let s=!1;for(let a=16;1<=a;a--,s=!s)s?i=this.round(i,r,a):r=this.round(r,i,a);return r^=this.m_p[0],[r,i]}s(e,t){return this.m_s[t][e>>(3-t<<3)&255]}bf_f(e){return(this.s(e,0)+this.s(e,1)>>>0^this.s(e,2))+this.s(e,3)>>>0}round(e,t,i){return e^(this.bf_f(t)^this.m_p[i])}})}}}),System.register("data/encoding/BlowfishKey",[],function(e,t){"use strict";var s,a,i,r;t&&t.id;return{setters:[],execute:function(){s="AihRvNoIbTn85FZRYNZRcT+i6KpU+maCsEqr3Q5q+LDB5tH7Tz2qQ38V",a=new Int8Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i=class{constructor(){this.key1=new Uint32Array(64),this.key2=new Uint32Array(64)}},e("BlowfishKey",r=class{constructor(){this.pubkey=new i,this.glob1=new Uint32Array(64),this.glob2=new Uint32Array(130),this.glob1_hi=new Uint32Array(4),this.glob1_hi_inv=new Uint32Array(4)}init_bignum(e,t,i){for(let r=0;r<i;r++)e[r]=0;e[0]=t}move_key_to_big(e,t,i,r){let s;s=0!=(128&t[0])?255:0;const a=new Uint8Array(e.buffer,e.byteOffset);let n=4*r;for(;n>i;n--)a[n-1]=s;for(;0<n;n--)a[n-1]=t[i-n]}key_to_bignum(e,t,i){let r,s,a=0;if(2===t[a]){if(a++,0!=(128&t[a])){for(r=0,s=0;s<(127&t[a]);s++)r=(r<<8>>>0|t[a+s+1])>>>0;a+=1+(127&t[a])}else r=t[a],a++;r<=4*i&&this.move_key_to_big(e,t.subarray(a),r,i)}}len_bignum(e,t){let i=t-1;for(;0<=i&&0===e[i];)i--;return i+1}bitlen_bignum(e,t){var i;let r,s;if(0===(i=this.len_bignum(e,t)))return 0;for(r=32*i,s=2147483648;0==(s&e[i-1]);)s>>>=1,r--;return r}init_pubkey(){let e=0,t;var i;const r=new Uint8Array(256);for(this.init_bignum(this.pubkey.key2,65537,64),t=0;e<s.length;)i=(((a[s.charCodeAt(e++)]>>>0<<6>>>0|255&a[s.charCodeAt(e++)])>>>0<<6>>>0|255&a[s.charCodeAt(e++)])>>>0<<6>>>0|255&a[s.charCodeAt(e++)])>>>0,r[t++]=i>>16&255,r[t++]=i>>8&255,r[t++]=255&i;this.key_to_bignum(this.pubkey.key1,r,64),this.pubkey.len=this.bitlen_bignum(this.pubkey.key1,64)-1}len_predata(){var e=(this.pubkey.len-1)/8|0;return(1+(55/e|0))*(1+e)>>>0}cmp_bignum(e,t,i){for(;0<i;){if(e[--i]<t[i])return-1;if(e[i]>t[i])return 1}return 0}mov_bignum(e,t,i){for(let r=0;r<i;r++)e[r]=t[r]}shr_bignum(e,t,i){let r;var s=t/32|0;if(0<s){for(r=0;r<i-s;r++)e[r]=e[r+s];for(;r<i;r++)e[r]=0;t%=32}if(0!==t){for(r=0;r<i-1;r++)e[r]=(e[r]>>>t|e[r+1]<<32-t>>>0)>>>0;e[r]=e[r]>>>t}}shl_bignum(e,t,i){let r;var s=t/32|0;if(0<s){for(r=i-1;r>s;r--)e[r]=e[r-s];for(;0<r;r--)e[r]=0;t%=32}if(0!==t){for(r=i-1;0<r;r--)e[r]=(e[r]<<t>>>0|e[r-1]>>>32-t)>>>0;e[0]=e[0]<<t>>>0}}sub_bignum(e,t,i,r,s){var a,n;s+=s;var o=new Uint16Array(t.buffer,t.byteOffset),l=new Uint16Array(i.buffer,i.byteOffset);const c=new Uint16Array(e.buffer,e.byteOffset);let h=0;for(;-1!=--s;)a=o[h],n=l[h],c[h]=a-n-r&65535,r=0!=(a-n-r&65536)?1:0,h++;return r}sub_bignum_word(e,t,i,r,s){var a,n;let o=0;for(;-1!=--s;)a=t[o],n=i[o],e[o]=a-n-r&65535,r=0!=(a-n-r&65536)?1:0,o++;return r}inv_bignum(e,t,i){const r=new Uint32Array(64);var s;let a,n,o=0;for(this.init_bignum(r,0,i),this.init_bignum(e,0,i),n=this.bitlen_bignum(t,i),a=1<<n%32>>>0,o=((n+32)/32|0)-1,s=4*((n-1)/32|0)>>>0,r[s/4|0]=r[s/4|0]|1<<(n-1&31)>>>0;0<n;)n--,this.shl_bignum(r,1,i),-1!==this.cmp_bignum(r,t,i)&&(this.sub_bignum(r,r,t,0,i),e[o]=e[o]|a>>>0),a>>>=1,0===a&&(o--,a=2147483648);this.init_bignum(r,0,i)}inc_bignum(e,t){let i=0;for(;0==++e[i]&&0<--t;)i++}init_two_dw(e,t){this.mov_bignum(this.glob1,e,t),this.glob1_bitlen=this.bitlen_bignum(this.glob1,t),this.glob1_len_x2=(this.glob1_bitlen+15)/16|0,this.mov_bignum(this.glob1_hi,this.glob1.subarray(this.len_bignum(this.glob1,t)-2),2),this.glob1_hi_bitlen=this.bitlen_bignum(this.glob1_hi,2)-32>>>0,this.shr_bignum(this.glob1_hi,this.glob1_hi_bitlen,2),this.inv_bignum(this.glob1_hi_inv,this.glob1_hi,2),this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen=(this.glob1_hi_bitlen+15)%16+1>>>0,this.inc_bignum(this.glob1_hi_inv,2),32<this.bitlen_bignum(this.glob1_hi_inv,2)&&(this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen--),this.glob1_hi_inv_lo=65535&this.glob1_hi_inv[0],this.glob1_hi_inv_hi=this.glob1_hi_inv[0]>>>16&65535}mul_bignum_word(e,t,i,r){let s,a;var n=new Uint16Array(t.buffer,t.byteOffset);let o=a=0;for(s=0;s<r;s++)a=i*n[o]+e[o]+a,e[o]=65535&a,o++,a>>>=16;e[o]+=65535&a}mul_bignum(e,t,i,r){let s;var a=new Uint16Array(i.buffer,i.byteOffset);let n=new Uint16Array(e.buffer,e.byteOffset);this.init_bignum(e,0,2*r);let o=0;for(s=0;s<2*r;s++)this.mul_bignum_word(n.subarray(o),t,a[o],2*r),o++}not_bignum(e,t){let i;for(i=0;i<t;i++)e[i]=~e[i]>>>0}neg_bignum(e,t){this.not_bignum(e,t),this.inc_bignum(e,t)}get_mulword(e,t){let i=((((65535&(65535^e[t-1]))*this.glob1_hi_inv_lo+65536>>>1)+((65535^e[t-2])*this.glob1_hi_inv_hi+this.glob1_hi_inv_hi>>>1)+1>>>16)+((65535&(65535^e[t-1]))*this.glob1_hi_inv_hi>>>1)+((65535^e[t])*this.glob1_hi_inv_lo>>>1)+1>>>14)+this.glob1_hi_inv_hi*(65535^e[t])*2>>>this.glob1_hi_bitlen>>>0;return 65535<i&&(i=65535),65535&i}dec_bignum(e,t){let i=0;for(;--e[i]>>>0==4294967295&&0<--t;)i++}calc_a_bignum(e,t,i,r){var s;let a;var n=this.glob1,o=this.glob2;if(this.mul_bignum(this.glob2,t,i,r),this.glob2[2*r]=0,(s=2*this.len_bignum(this.glob2,2*r+1))>=this.glob1_len_x2){this.inc_bignum(this.glob2,2*r+1),this.neg_bignum(this.glob2,2*r+1),a=1+s-this.glob1_len_x2;let e=new Uint16Array(o.buffer),t=a,i=1+s;for(;0!==a;a--){i--;var l=this.get_mulword(e,i);t--;var c=e.subarray(t);0<l&&(this.mul_bignum_word(c,this.glob1,l,2*r),0==(32768&e[i])&&0!==this.sub_bignum_word(c,c,new Uint16Array(n.buffer),0,2*r)&&e[i]--)}this.neg_bignum(this.glob2,r),this.dec_bignum(this.glob2,r)}this.mov_bignum(e,this.glob2,r)}clear_tmp_vars(e){this.init_bignum(this.glob1,0,e),this.init_bignum(this.glob2,0,e),this.init_bignum(this.glob1_hi_inv,0,4),this.init_bignum(this.glob1_hi,0,4),this.glob1_bitlen=0,this.glob1_hi_bitlen=0,this.glob1_len_x2=0,this.glob1_hi_inv_lo=0,this.glob1_hi_inv_hi=0}calc_a_key(e,t,i,r,s){var a,n,o=new Uint32Array(64);let l,c,h=0;for(this.init_bignum(e,1,s),n=this.len_bignum(r,s),this.init_two_dw(r,n),l=this.bitlen_bignum(i,n)<<24>>24,a=((l+31)/32|0)>>>0,c=1<<(l-1)%32>>>1,h+=a-1,l--,this.mov_bignum(e,t,n);-1!=--l;)0===c&&(c=2147483648,h--),this.calc_a_bignum(o,e,e,n),0!=(i[h]&c)?this.calc_a_bignum(e,o,t,n):this.mov_bignum(e,o,n),c>>>=1;this.init_bignum(o,0,n),this.clear_tmp_vars(s)}memcpy(e,t,i){let r=0;for(;0!=i--;)e[r]=t[r],r++}process_predata(e,t,i){var r=new Uint32Array(64),s=new Uint32Array(64);let a=0,n=0;for(var o=(this.pubkey.len-1)/8|0;1+o<=t;)this.init_bignum(r,0,64),this.memcpy(new Uint8Array(r.buffer),e.subarray(a),1+o),this.calc_a_key(s,r,this.pubkey.key2,this.pubkey.key1,64),this.memcpy(i.subarray(n),new Uint8Array(s.buffer),o),t-=1+o,a+=1+o,n+=o}decryptKey(e){this.init_pubkey();let t=new Uint8Array(256);return this.process_predata(e,this.len_predata(),t),t.subarray(0,56)}})}}}),System.register("data/Crc32",[],function(e,t){"use strict";var r;t&&t.id;return{setters:[],execute:function(){e("Crc32",r=class r{constructor(e=4294967295){this.polynomal=e,this.crc=e}static calculateCrc(e,t=4294967295){let i=t;for(let r=0,s=e.length;r<s;r++)i=(i>>>8^this.lookUp[255&i^e[r]])>>>0;return i=(i^t)>>>0,i}append(e){for(let t=0,i=e.length;t<i;t++)this.crc=(this.crc>>>8^r.lookUp[255&this.crc^e[t]])>>>0}get(){return(this.crc^this.polynomal)>>>0}}),r.lookUp=new Uint32Array([0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117])}}}),System.register("data/MixEntry",["util/string","data/Crc32"],function(e,t){"use strict";var s,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e}],execute:function(){e("MixEntry",i=class{constructor(e,t,i){this.hash=e,this.offset=t,this.length=i}static hashFilename(t){var i=(t=t.toUpperCase()).length,r=i>>2;if(0!=(3&i)){t+=String.fromCharCode(i-(r<<2));let e=3-(3&i);for(;0!=e--;)t+=t[r<<2]}return a.Crc32.calculateCrc(s.binaryStringToUint8Array(t))}}),i.size=12}}}),System.register("data/MixFile",["data/DataStream","data/encoding/Blowfish","data/encoding/BlowfishKey","data/MixEntry","data/vfs/VirtualFile"],function(t,e){"use strict";var n,o,l,c,i,r,s;e&&e.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.Checksum=65536]="Checksum",e[e.Encrypted=131072]="Encrypted",t("MixFile",s=class{constructor(e){this.stream=e,this.headerStart=84,this.index=new Map,this.parseHeader()}parseHeader(){var e=this.stream.readUint32(),t=0==(e&~(r.Checksum|r.Encrypted));if(t){if(0!=(e&r.Encrypted))return void(this.dataStart=this.parseRaHeader())}else this.stream.seek(0);this.dataStart=this.parseTdHeader(this.stream)}parseRaHeader(){const e=this.stream;var t=e.readUint8Array(80),i=(new l.BlowfishKey).decryptKey(t),r=e.readUint32Array(2);const s=new o.Blowfish(i);let a=new n.DataStream(s.decrypt(r));t=a.readUint16();a.readUint32(),e.position=this.headerStart;i=6+t*c.MixEntry.size,t=(3+i)/4|0,r=e.readUint32Array(t+t%2);a=new n.DataStream(s.decrypt(r));i=this.headerStart+i+(1+(~i>>>0)&7);return this.parseTdHeader(a),i}parseTdHeader(e){var t=e.readUint16();e.readUint32();for(let r=0;r<t;r++){var i=new c.MixEntry(e.readUint32(),e.readUint32(),e.readUint32());this.index.set(i.hash,i)}return e.position}containsFile(e){return this.index.has(c.MixEntry.hashFilename(e))}openFile(e){var t=this.index.get(c.MixEntry.hashFilename(e));if(!t)throw new Error(`File "${e}" not found`);return i.VirtualFile.factory(this.stream,e,this.dataStart+t.offset,t.length)}})}}}),System.register("util/Logger",["js-logger"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("AppLogger",i)}}}),System.register("data/vfs/FileNotFoundError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{constructor(){super(...arguments),this.name="FileNotFoundError"}},e("FileNotFoundError",i)}}}),System.register("data/vfs/MemArchive",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MemArchive",i=class{constructor(){this.entries=new Map}addFile(e){this.entries.set(e.filename,e)}containsFile(e){return this.entries.has(e)}openFile(e){if(!this.containsFile(e))throw new Error(`File "${e}" not found`);return this.entries.get(e)}})}}}),System.register("data/vfs/StorageQuotaError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{constructor(e){super("Storage quota exceeded",e),this.name="StorageQuotaError"}},e("StorageQuotaError",i)}}}),System.register("data/vfs/NameNotAllowedError",["data/vfs/IOError"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.IOError{constructor(){super(...arguments),this.name="NameNotAllowedError"}},e("NameNotAllowedError",r)}}}),System.register("data/vfs/RealFileSystemDir",["data/vfs/StorageQuotaError","util/string","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/NameNotAllowedError","data/vfs/VirtualFile"],function(e,t){"use strict";var a,i,n,o,l,r,s;t&&t.id;return{setters:[function(e){a=e},function(e){i=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){r=e}],execute:function(){e("RealFileSystemDir",s=class s{constructor(e,t=!1){this.handle=e,this.caseSensitive=t}get name(){return this.handle.name}async*getEntries(){try{for await(var e of this.handle.keys())yield e}catch(e){if("NotFoundError"===e.name)throw new n.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`Directory "${this.handle.name}" could not be read (${e.name})`,{cause:e});throw e}}async listEntries(){let e=[];for await(var t of this.getEntries())e.push(t);return e}async*getFileHandles(){try{for await(const e of this.handle.values())"file"===e.kind&&(yield e)}catch(e){if("NotFoundError"===e.name)throw new n.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`Directory "${this.handle.name}" could not be read (${e.name})`,{cause:e});throw e}}async*getRawFiles(){for await(const e of this.getFileHandles())yield await e.getFile()}async containsEntry(e){return void 0!==await this.resolveEntryName(e)}async resolveEntryName(e){if(this.caseSensitive)return(await this.handle.getFileHandle(e).catch(()=>this.handle.getDirectoryHandle(e)).catch(()=>{}))?.name;for await(const t of this.getEntries())if(i.equalsIgnoreCase(t,e))return t}async fixEntryCase(e){if(!this.caseSensitive)for await(var t of this.getEntries())if(i.equalsIgnoreCase(t,e)){e=t;break}return e}async getRawFile(t,e=!1,i){let r;try{var s=e?t:await this.fixEntryCase(t);r=await this.handle.getFileHandle(s)}catch(e){if("NotFoundError"===e.name)throw new n.FileNotFoundError(`File "${t}" not found in directory "${this.handle.name}"`,{cause:e});if(e instanceof TypeError&&e.message.includes("not allowed"))throw new l.NameNotAllowedError(`File name "${t}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`File "${t}" could not be read (${e.name})`,{cause:e});throw e}s=await r.getFile();return i?new File([s],s.name,{type:i}):s}async openFile(e,t=!1){var i=await this.getRawFile(e,t);return r.VirtualFile.fromRealFile(i)}async writeFile(i,e){var r=e??(i instanceof File?i.name:i.filename);try{var s=await this.fixEntryCase(r);await this.deleteFile(s,!0);let e=await this.handle.getFileHandle(s,{create:!0}),t=await e.createWritable();try{await t.write(i instanceof File?i:new Uint8Array(i.stream.buffer,i.stream.byteOffset,i.stream.byteLength)),await t.close()}catch(e){throw await t.abort(),e}}catch(e){if("QuotaExceededError"===e.name)throw new a.StorageQuotaError({cause:e});if("NotFoundError"===e.name)throw new n.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:e});if(e instanceof TypeError&&e.message.includes("not allowed"))throw new l.NameNotAllowedError(`File name "${r}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`File "${r}" could not be written (${e.name})`,{cause:e});throw e}}async deleteFile(e,t=!1){var i=t?e:await this.resolveEntryName(e);if(i)try{await this.handle.removeEntry(i)}catch(e){if(t&&"NotFoundError"===e.name)return;if("QuotaExceededError"===e.name)throw new a.StorageQuotaError({cause:e});if(e instanceof TypeError&&e.message.includes("not allowed"))throw new l.NameNotAllowedError(`File name "${i}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`File "${i}" could not be deleted (${e.name})`,{cause:e});throw e}}async getDirectory(t,e=this.caseSensitive){var i=e?t:await this.fixEntryCase(t);let r;try{r=await this.handle.getDirectoryHandle(i)}catch(e){if("NotFoundError"===e.name)throw new n.FileNotFoundError(`Directory "${t}" not found or parent directory "${this.handle.name}" is gone`,{cause:e});if(e instanceof TypeError&&e.message.includes("not allowed"))throw new l.NameNotAllowedError(`Directory name "${t}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`Directory "${t}" could not be read (${e.name})`,{cause:e});throw e}return new s(r,e)}async getOrCreateDirectory(t,e=this.caseSensitive){var i=e?t:await this.fixEntryCase(t);try{return new s(await this.handle.getDirectoryHandle(i,{create:!0}),e)}catch(e){if("QuotaExceededError"===e.name)throw new a.StorageQuotaError({cause:e});if("NotFoundError"===e.name)throw new n.FileNotFoundError(`Directory "${this.handle.name}" not found"`,{cause:e});if(e instanceof TypeError&&e.message.includes("not allowed"))throw new l.NameNotAllowedError(`Directory name "${t}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`Directory "${t}" could not be created (${e.name})`,{cause:e});throw e}}async deleteDirectory(e,t=!1){var i=await this.resolveEntryName(e);if(i)try{await this.handle.removeEntry(i,{recursive:t})}catch(e){if("QuotaExceededError"===e.name)throw new a.StorageQuotaError({cause:e});if("InvalidModificationError"===e.name)throw new o.IOError("Can't delete non-empty directory when recursive = false");if(e instanceof TypeError&&e.message.includes("not allowed"))throw new l.NameNotAllowedError(`Directory name "${i}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new o.IOError(`Directory "${i}" could not be deleted (${e.name})`,{cause:e});throw e}}})}}}),System.register("data/vfs/RealFileSystem",["data/vfs/FileNotFoundError","data/vfs/RealFileSystemDir"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){e("RealFileSystem",s=class{constructor(){this.directories=[]}addRootDirectoryHandle(e){this.rootDirectory=this.addDirectoryHandle(e),this.rootDirectoryHandle=e}getRootDirectoryHandle(){return this.rootDirectoryHandle}addDirectoryHandle(e){var t=new i.RealFileSystemDir(e);return this.directories.push(t),t}addDirectory(e){this.directories.push(e)}async getDirectory(e){var t=await this.findDirectory(e);if(!t)throw new Error(`Directory "${e}" not found in real file system`);return t}async findDirectory(e){for(const t of this.directories)if(await t.containsEntry(e))return await t.getDirectory(e)}getRootDirectory(){return this.rootDirectory}async containsEntry(e){for(const t of this.directories)if(await t.containsEntry(e))return!0;return!1}async openFile(e,t=!1){for(const i of this.directories)try{return await i.openFile(e,t)}catch(e){if(!(e instanceof r.FileNotFoundError))throw e}throw new r.FileNotFoundError(`File "${e}" not found in real file system`)}async getRawFile(e){for(const t of this.directories)if(await t.containsEntry(e))return await t.getRawFile(e);throw new Error(`File "${e}" not found in real file system`)}async*getEntries(){for(var e of this.directories)for await(var t of e.getEntries())yield t}})}}}),System.register("data/vfs/VirtualFileSystem",["data/AudioBagFile","data/IdxFile","data/MixFile","engine/Engine","util/string","data/vfs/FileNotFoundError","data/vfs/MemArchive"],function(e,t){"use strict";var r,s,l,c,h,i,n,a;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){i=e},function(e){n=e}],execute:function(){e("VirtualFileSystem",a=class{constructor(e,t){this.rfs=e,this.logger=t,this.allArchives=new Map,this.archivesByPriority=[]}fileExists(e){for(const t of this.archivesByPriority)if(t.containsFile(e))return!0;return!1}openFile(e){for(const t of this.archivesByPriority)if(t.containsFile(e))return t.openFile(e);throw new i.FileNotFoundError(`File "${e}" not found in VFS`)}addArchive(e,t){this.allArchives.has(t)||(this.allArchives.set(t,e),this.archivesByPriority.push(e)),this.logger.info(`Added archive "${t}" to VFS`)}hasArchive(e){return this.allArchives.has(e)}removeArchive(e){var t=this.allArchives.get(e);t&&(this.allArchives.delete(e),this.archivesByPriority.splice(this.archivesByPriority.indexOf(t),1),this.logger.info(`Removed archive "${e}" from VFS`))}listArchives(){return[...this.allArchives.keys()]}async addMixFile(e){await this.addArchiveByFilename(e,e=>new l.MixFile(e.stream))}async addBagFile(e){const i=await this.openFileWithRfs(e.replace(".bag",".idx"));await this.addArchiveByFilename(e,e=>{var t=new s.IdxFile(i.stream);return(new r.AudioBagFile).fromVirtualFile(e,t)})}async addArchiveByFilename(e,t){var i;this.allArchives.has(e)||(i=await this.openFileWithRfs(e))&&this.addArchive(t(i),e)}async openFileWithRfs(e){let t;try{t=await this.rfs.openFile(e)}catch(e){if(!(e instanceof i.FileNotFoundError))throw e}if(!t){if(!this.fileExists(e))throw new i.FileNotFoundError(`File "${e}" not found`);t=this.openFile(e)}return t}async loadImplicitMixFiles(e){this.logger.info("Initializing implicit mix files..."),e===c.EngineType.YurisRevenge&&await this.addMixFile("langmd.mix"),await this.addMixFile("language.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("ra2md.mix"),await this.addMixFile("ra2.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("cachemd.mix"),await this.addMixFile("cache.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("loadmd.mix"),await this.addMixFile("load.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("localmd.mix"),await this.addMixFile("local.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("ntrlmd.mix"),await this.addMixFile("neutral.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("audiomd.mix"),await this.addMixFile("audio.mix"),await this.addBagFile("audio.bag"),await this.addMixFile("conquer.mix"),e===c.EngineType.YurisRevenge&&(await this.addMixFile("conqmd.mix"),await this.addMixFile("genermd.mix")),await this.addMixFile("generic.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("isogenmd.mix"),await this.addMixFile("isogen.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("cameomd.mix"),await this.addMixFile("cameo.mix"),e===c.EngineType.YurisRevenge&&await this.addMixFile("multimd.mix"),await this.addMixFile("multi.mix")}async loadExtraMixFiles(i){let r=new Set;for await(var e of this.rfs.getEntries())r.add(e.toLowerCase());for(var s of["ecache","expand","elocal"])for(let t=99;0<=t;t--){let e=[""+s+h.pad(t,"00")+".mix"];i===c.EngineType.YurisRevenge&&e.push(`${s}md${h.pad(t,"00")}.mix`);for(var a of e)r.has(a)&&await this.addMixFile(a)}let t=[".mmx"];i===c.EngineType.YurisRevenge&&t.push(".yro");for(const n of t)for(const o of r)o.endsWith(n)&&this.addArchive(new l.MixFile((await this.rfs.openFile(o)).stream),o)}async loadStandaloneFiles(e){let i=["ini","csf"],r=new Set(e?.exclude),s=[];for await(var a of this.rfs.getEntries()){let t=a.toLowerCase();i.some(e=>t.endsWith("."+e))&&!r.has(t)&&s.push(await this.rfs.openFile(a,!0))}if(s.length){let e=new n.MemArchive;for(var t of s)e.addFile(t);this.addArchive(e,"mem.archive")}}})}}}),System.register("engine/LazyResourceCollection",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("LazyResourceCollection",i=class{constructor(e){this.resourceFactory=e,this.resources=new Map}setVfs(e){this.vfs=e}set(e,t){this.resources.set(e,t)}has(e){return!!this.resources.has(e)||(this.vfs?.fileExists(e)??!1)}get(e){let t;return t=this.resources.get(e),!t&&this.vfs?.fileExists(e)&&(t=this.resourceFactory(this.vfs.openFile(e)),this.resources.set(e,t)),t}clear(e){e?this.resources.delete(e):this.resources.clear()}})}}}),System.register("data/WavFile",["wavefile","data/vfs/VirtualFile"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("WavFile",s=class{constructor(e){e instanceof Uint8Array?this.fromRawData(e):e instanceof r.VirtualFile&&this.fromVirtualFile(e)}fromRawData(e){return this.rawData=e,this}fromVirtualFile(e){var t=e.stream;return this.rawData=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),this}getRawData(){return this.rawData}getData(){if(!this.decodedData){if(!this.rawData)throw new Error("No data loaded");this.decodedData=this.decodeData(this.rawData),this.rawData=void 0}return this.decodedData}setData(e){this.rawData=void 0,this.decodedData=e}decodeData(e){let t=new i.WaveFile(e);return"4"===t.bitDepth&&t.fromIMAADPCM(),t.toBuffer()}isRawImaAdpcm(){return this.rawData&&"4"===new i.WaveFile(this.rawData).bitDepth}})}}}),System.register("engine/AsyncResourceCollection",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/LazyAsyncResourceCollection",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("LazyAsyncResourceCollection",i=class{constructor(e,t=!0){this.resourceFactory=e,this.cache=t,this.resources=new Map}setDir(e){this.rfsDir=e}set(e,t){this.resources.set(e,t)}async has(e){return!!this.resources.has(e)||(await this.rfsDir?.containsEntry(e)??!1)}async get(e){let t;return t=this.resources.get(e),!t&&await this.rfsDir?.containsEntry(e)&&(t=await this.resourceFactory(await this.rfsDir.getRawFile(e)),this.cache&&this.resources.set(e,t)),t}clear(){this.resources.clear()}})}}}),System.register("data/Mp3File",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Mp3File",i=class{constructor(e){this.file=e}asFile(){return new File([this.file],this.file.name,{type:"audio/mp3"})}})}}}),System.register("engine/mixDatabase",[],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[],execute:function(){e("mixDatabase",i=(new Map).set("cameo.mix",["adogicon.shp","adoguico.shp","aengicon.shp","aenguico.shp","agapgen.shp","agisicon.shp","ahrvicon.shp","ahrvuico.shp","aparicon.shp","apchicon.shp","apcicon.shp","artyicon.shp","asaticon.shp","ayaricon.shp","batricon.shp","beagicon.shp","bggyicon.shp","bolticon.shp","brrkicon.shp","carricon.shp","ccomicon.shp","ccomuico.shp","chemicon.shp","chroicon.shp","clckicon.shp","clegicon.shp","cleguico.shp","clonicon.shp","cnsticon.shp","crryicon.shp","csphicon.shp","darken.shp","desoicon.shp","desouico.shp","desticon.shp","detnicon.shp","dlphicon.shp","dlphuico.shp","dogicon.shp","doguico.shp","dredicon.shp","dronicon.shp","e1icon.shp","e1uico.shp","e2icon.shp","e2uico.shp","e4icon.shp","empicon.shp","engnicon.shp","facticon.shp","falcicon.shp","fixicon.shp","flakicon.shp","flkticon.shp","flktuico.shp","forticon.shp","fsdicon.shp","fspicon.shp","fstdicon.shp","fvicon.shp","fvuico.shp","gapicon.shp","gat2icon.shp","gateicon.shp","gbayicon.shp","gcanicon.shp","giicon.shp","giuico.shp","gorep.shp","gtnkicon.shp","gtnkuico.shp","gwepicon.shp","handicon.shp","harvicon.shp","harvuico.shp","heliicon.shp","hindicon.shp","hmecicon.shp","hovricon.shp","htkicon.shp","htkuico.shp","htnkicon.shp","htnkuico.shp","ioncicon.shp","ircricon.shp","ironicon.shp","ivanicon.shp","ivanuico.shp","ivncicon.shp","ivncuico.shp","jjeticon.shp","jjetuico.shp","landicon.shp","lasricon.shp","liteicon.shp","lpsticon.shp","mcvicon.shp","mcvuico.shp","metricon.shp","mltiicon.shp","mmchicon.shp","msslicon.shp","mtnkicon.shp","mtnkuico.shp","mutcicon.shp","nga2icon.shp","ngaticon.shp","nhpdicon.shp","npsiicon.shp","npwricon.shp","nradicon.shp","nrcticon.shp","nreficon.shp","ntchicon.shp","nukeicon.shp","nwalicon.shp","nwepicon.shp","obliicon.shp","obmbicon.shp","orcaicon.shp","otrnicon.shp","paraicon.shp","pillicon.shp","plticon.shp","plugicon.shp","podsicon.shp","powricon.shp","prisicon.shp","proicon.shp","psicicon.shp","psicuico.shp","psisicon.shp","psiticon.shp","psituico.shp","rad1icon.shp","rad2icon.shp","rad3icon.shp","radricon.shp","rboticon.shp","reficon.shp","rfixicon.shp","rtnkicon.shp","rtnkuico.shp","samicon.shp","sapcicon.shp","sapicon.shp","sbagicon.shp","sealicon.shp","sealuico.shp","seekicon.shp","shadicon.shp","shaduico.shp","shkicon.shp","shkuico.shp","smchicon.shp","smcvicon.shp","smcvuico.shp","snipicon.shp","snipuico.shp","soniicon.shp","spoticon.shp","spyicon.shp","spyuico.shp","sqdicon.shp","sreficon.shp","srefuico.shp","stnkicon.shp","subicon.shp","subticon.shp","tanyicon.shp","tanyuico.shp","techicon.shp","tempicon.shp","teslaicon.shp","tickicon.shp","tnkdicon.shp","tnkduico.shp","towricon.shp","trkaicon.shp","trsticon.shp","trstuico.shp","tslaicon.shp","ttnkicon.shp","ttnkuico.shp","turbicon.shp","twr1icon.shp","twr2icon.shp","twr3icon.shp","v3icon.shp","v3uico.shp","wallicon.shp","weapicon.shp","weaticon.shp","weedicon.shp","wethicon.shp","xxicon.shp","yardicon.shp","yuriicon.shp","yuriuico.shp","yurpicon.shp","yurpuico.shp","zepicon.shp","zepuico.shp"]).set("theme.mix",["200meter.wav","blowitup.wav","burn.wav","destroy.wav","eaglehun.wav","fortific.wav","grinder.wav","hm2.wav","indeep.wav","industro.wav","jank.wav","motorize.wav","power.wav","ra2-opt.wav","ra2-sco.wav","tension.wav"])),r=["addon.shp","bkgdlg.shp","bkgdmd.shp","bkgdsm.shp","bttnbkgd.shp","button00.shp","button01.shp","button02.shp","button03.shp","button04.shp","button05.shp","button06.shp","button07.shp","button08.shp","button09.shp","button10.shp","button11.shp","credits.shp","diplobtn.shp","gclock2.shp","key.ini","lendcap.shp","lspacer.shp","optbtn.shp","pbeacon.shp","power.shp","powerp.shp","pwrlvl.shp","radar.shp","radar01.shp","radar02.shp","r-dn.shp","rdrbeacn.shp","rendcap.shp","repair.shp","r-up.shp","sell.shp","side1.shp","side2.shp","side2b.shp","side3.shp","sidebar.pal","sidebttn.shp","tab00.shp","tab01.shp","tab02.shp","tab03.shp","tabs.shp","top.shp","uibkgd.pal","wayp.shp"],i.set("sidec01.mix",r).set("sidec02.mix",r),r=["reportbug.shp"],i.set("sidec01cd.mix",r).set("sidec02cd.mix",r)}}}),System.register("engine/gameRes/GameResSource",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Archive=0]="Archive",e[e.Cdn=1]="Cdn",e[e.Local=2]="Local",t("GameResSource",i)}}}),System.register("game/rules/MpDialogSettings",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MpDialogSettings",i=class{readIni(e){return this.minMoney=e.getNumber("MinMoney"),this.money=e.getNumber("Money"),this.maxMoney=e.getNumber("MaxMoney"),this.moneyIncrement=e.getNumber("MoneyIncrement"),this.minUnitCount=e.getNumber("MinUnitCount"),this.unitCount=e.getNumber("UnitCount"),this.maxUnitCount=e.getNumber("MaxUnitCount"),this.crates=e.getBool("Crates"),this.gameSpeed=e.getNumber("GameSpeed"),this.mcvRedeploys=e.getBool("MCVRedeploys"),this.shortGame=e.getBool("ShortGame"),this.superWeapons=e.getBool("SuperWeapons"),this.techLevel=e.getNumber("TechLevel"),this.alliesAllowed=e.getBool("AlliesAllowed",!0),this.allyChangeAllowed=e.getBool("AllyChangeAllowed",!0),this.mustAlly=e.getBool("MustAlly"),this}})}}}),System.register("game/ini/GameModeType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Battle=0]="Battle",e[e.ManBattle=1]="ManBattle",e[e.FreeForAll=2]="FreeForAll",e[e.Unholy=3]="Unholy",e[e.Cooperative=4]="Cooperative",t("GameModeType",i)}}}),System.register("game/ini/GameModes",["game/rules/MpDialogSettings","game/ini/GameModeType"],function(e,t){"use strict";var n,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){i=e}],execute:function(){e("GameModes",r=class{constructor(e,t){this.modeIniLoader=t,this.entries=new Map,this.loadIni(e)}loadIni(e){e.getOrderedSections().forEach(s=>{let a=i.GameModeType[s.name]??i.GameModeType.Battle;[...s.entries.keys()].forEach(e=>{let t=s.getArray(e);if(t.length<5)throw new Error(`Invalid format for mp mode entry "${e}".`);var i=Number(e),r=t[2].toLowerCase(),r={id:i,type:a,label:t[0],description:t[1],rulesOverride:r,mapFilter:t[3],randomMapsAllowed:t[4],aiAllowed:i<3,mpDialogSettings:(new n.MpDialogSettings).readIni(this.modeIniLoader(r).getOrCreateSection("MultiplayerDialogSettings"))};this.entries.set(i,r)})})}getById(e){if(!this.entries.has(e))throw new Error("No game mode found with id "+e);return this.entries.get(e)}hasId(e){return this.entries.has(e)}getAll(){return[...this.entries.values()]}})}}}),System.register("data/CsfFile",[],function(t,e){"use strict";var o,l,c,i,r,s;e&&e.id;return{setters:[],execute:function(){var e;o=new Uint32Array(new Uint8Array(Array.prototype.map.call("STRW",e=>e.charCodeAt(0)).reverse()).buffer)[0],l=e=>e.map(e=>~e>>>0),c=e=>{let t="";for(let i=0;i<e.length;i+=2)t+=String.fromCharCode(e[i+1]<<8|e[i]);return t},(e=i=i||{})[e.EnglishUS=0]="EnglishUS",e[e.EnglishUK=1]="EnglishUK",e[e.German=2]="German",e[e.French=3]="French",e[e.Spanish=4]="Spanish",e[e.Italian=5]="Italian",e[e.Japanese=6]="Japanese",e[e.Jabberwockie=7]="Jabberwockie",e[e.Korean=8]="Korean",e[e.Chinese=9]="Chinese",e[e.Unknown=9]="Unknown",t("CsfLanguage",i),t("csfLanguageCodeMap",r=(new Map).set(i.EnglishUS,"en-US").set(i.EnglishUK,"en-GB").set(i.German,"de-DE").set(i.French,"fr-FR").set(i.Spanish,"es-ES").set(i.Italian,"it-IT").set(i.Japanese,"ja-JP").set(i.Korean,"ko-KR").set(i.Chinese,"zh-CN")),t("CsfFile",s=class{constructor(e){this.language=i.Unknown,this.data={},e&&this.fromVirtualFile(e)}fromVirtualFile(e){let t=e.stream;t.readInt32(),t.readInt32();var i=t.readInt32();t.readInt32(),t.readInt32(),this.language=t.readInt32();for(let n=0;n<i;n++){t.readInt32();var r,s=t.readInt32(),a=t.readString(t.readInt32());0!=(1&s)?(r=t.readInt32()===o,s=l(t.readUint8Array(2*t.readInt32())),s=c(s),r&&t.readString(t.readInt32()),this.data[a]=s):this.data[a]=""}}getIsoLangCode(){return r.get(this.language)}})}}}),System.register("data/Strings",["sprintf-js","data/CsfFile"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){e("Strings",s=class{constructor(e){this.data={},e instanceof i.CsfFile?this.fromCsf(e):"object"==typeof e&&this.fromJson(e)}fromCsf(e){this.fromJson(e.data)}fromJson(e){for(var t of Object.keys(e))this.setValue(t,this.sanitizeValue(e[t]))}sanitizeValue(e){return e.replace(/%hs/g,"%s")}setValue(e,t){this.data[e.toLowerCase()]=t}has(e){return!!this.data[e.toLowerCase()]}get(e,...t){let i=this.data[e.toLowerCase()];return i?"string"!=typeof i?(console.warn(`Invalid string value for name "${e}"`),e):(t.length&&(i=r.sprintf(i,...t)),i):e.match(/^NOSTR:/i)?e.replace(/^NOSTR:/i,""):(console.warn(`String with name "${e}" not found"`),e)}})}}}),System.register("engine/MapManifest",["data/IniFile"],function(e,t){"use strict";var l,i;t&&t.id;return{setters:[function(e){l=e}],execute:function(){e("MapManifest",i=class{fromIni(t,e){return this.fileName=t.getString("File")||t.name.toLowerCase()+".map",this.uiName=t.getString("Description"),this.maxSlots=t.getNumber("MaxPlayers"),this.official=!0,this.gameModes=e.filter(e=>t.getArray("GameMode").includes(e.mapFilter)),this}getFullMapTitle(e){return this.addTitleSlotsSuffix(e.get(this.uiName),this.maxSlots)}addTitleSlotsSuffix(e,t){return e.match(/(\(|)\s*\d(-\d)?\s*(\)|)\s*$/)||(e+=` (2${2<t?"-"+t:""})`),e}fromMapFile(e,t){var i=e.readAsString();let r=e.filename;const s=new l.IniFile(this.extractIniSection("Basic",i)).getSection("Basic");if(!s)throw new Error(`Map "${r}" is missing the [Basic] section`);this.fileName=r,this.uiName="NOSTR:"+(s.getString("Name")||r.replace(/\.[^.]+$/,""));let a=s.getNumber("MaxPlayer");if(!a){i=this.extractIniSection("Header",i);const o=i?new l.IniFile(i).getSection("Header"):void 0;a=o?.getNumber("NumberStartingPoints")||2}this.maxSlots=a,this.official=s.getBool("Official");let n=s.getArray("GameMode",void 0,["standard"]);return this.gameModes=t.filter(e=>n.includes(e.mapFilter)),this}extractIniSection(e,t){var i=t.indexOf(`[${e}]`);if(-1!==i){let e=i+1;for(;e<t.length&&("["!==t[e]||"\n"!==t[e-1]);e++);return t.slice(i,e)}}})}}}),System.register("engine/MapList",["engine/MapManifest"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("MapList",i=class i{constructor(e){this.gameModes=e,this.manifests=[]}addFromIni(i){let e=i.getSection("MultiMaps");if(!e)throw new Error("Invalid map list. Missing [MultiMaps] section.");return this.manifests=this.manifests.concat([...e.entries.values()].map(e=>{var t=i.getSection(e);if(!t)throw new Error(`Invalid map list. Missing [${e}] section.`);return(new r.MapManifest).fromIni(t,this.gameModes.getAll())})),this.dedupeEntries(),this}add(e){this.manifests.push(e)}addFromMapFile(e){this.add((new r.MapManifest).fromMapFile(e,this.gameModes.getAll()))}getAll(){return this.manifests}getByName(t){return this.manifests.find(e=>e.fileName.toLowerCase()===t.toLowerCase())}sortByName(){this.manifests.sort((e,t)=>e.fileName.localeCompare(t.fileName))}clone(){let e=new i(this.gameModes);return e.manifests=[...this.manifests],e}mergeWith(e){return this.manifests.push(...e.manifests),this.dedupeEntries(),this}dedupeEntries(){this.manifests=[...new Map(this.manifests.map(e=>[e.fileName.toLowerCase(),e])).values()]}})}}}),System.register("data/hva/Section",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Section",i=class{getMatrix(e){return this.matrices[e]}})}}}),System.register("data/HvaFile",["data/hva/Section","data/vfs/VirtualFile"],function(e,t){"use strict";var n,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){i=e}],execute:function(){e("HvaFile",r=class{constructor(e){e instanceof i.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){this.filename=e.filename;let t=e.stream;this.sections=[],t.readCString(16);var i=t.readInt32(),r=t.readInt32();for(let s=0;s<r;++s){let e=new n.Section;e.name=t.readCString(16),e.matrices=new Array(i),this.sections.push(e)}for(let a=0;a<i;++a)for(let e=0;e<r;++e)this.sections[e].matrices[a]=this.readMatrix(t)}readMatrix(e){let t=[];for(let i=0;i<3;++i)t.push(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());return t.push(0,0,0,1),(new THREE.Matrix4).fromArray(t).transpose()}})}}}),System.register("engine/Engine",["data/IniFile","data/ShpFile","data/VxlFile","data/TmpFile","data/Palette","engine/Theater","engine/TheaterType","version","data/vfs/VirtualFileSystem","data/vfs/RealFileSystem","engine/LazyResourceCollection","data/WavFile","engine/LazyAsyncResourceCollection","data/Mp3File","engine/mixDatabase","engine/gameRes/GameResSource","data/Crc32","game/ini/GameModes","util/string","engine/MapList","data/HvaFile"],function(t,e){"use strict";var l,i,r,s,a,n,o,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;e&&e.id;return{setters:[function(e){l=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){var e;(e=C=C||{})[e.AutoDetect=0]="AutoDetect",e[e.TiberianSun=1]="TiberianSun",e[e.Firestorm=2]="Firestorm",e[e.RedAlert2=3]="RedAlert2",e[e.YurisRevenge=4]="YurisRevenge",t("EngineType",C),t("Engine",E=class E{static getVersion(){return c.version.split(".").slice(0,2).join(".")}static getModHash(){if(!this.modHash)throw new Error("Rules must be loaded first");return this.modHash}static getActiveMod(){return this.activeMod}static setActiveMod(e){this.activeMod=e}static initGameResSource(e){this.gameResSource=e}static async initRfs(e){let t=this.rfs=new u.RealFileSystem;return t.addRootDirectoryHandle(e),t}static async initVfs(e,t){return this.vfs=new h.VirtualFileSystem(e,t),E.iniFiles.setVfs(this.vfs),E.palettes.setVfs(this.vfs),E.images.setVfs(this.vfs),E.voxels.setVfs(this.vfs),E.voxelAnims.setVfs(this.vfs),E.tileData.setVfs(this.vfs),E.sounds.setVfs(this.vfs),E.themes.setDir(await this.rfs?.findDirectory(E.rfsSettings.musicDir)),E.taunts.setDir(await this.rfs?.findDirectory(E.rfsSettings.tauntsDir)),this.vfs}static supportsTheater(t){var e=this.getActiveEngine();return this.theaterSettings.get(e)?.some(e=>e.Type===t)||!1}static getTheaterSettings(e,t){if(!this.theaterSettings.has(e))throw new Error('Unknown engineType "'+e);var i=this.theaterSettings.get(e).find(e=>e.Type===t);if(!i)throw new Error(`Unsupported theater "${o.TheaterType[t]}"`);return i}static async loadTheater(e){if(!E.rules||!E.art)throw new Error("Rules and art should be loaded first");if(void 0===E.gameResSource)throw new Error("No gameResSource is set");var t=E.getActiveEngine();let i;var r,s=E.getTheaterSettings(t,e);if(E.gameResSource!==y.GameResSource.Cdn)for(var a of s.Mixes)await E.vfs.addMixFile(a);return E.theaters.has(e)?i=E.theaters.get(e):(r=E.getTheaterIni(t,e),t=E.getTileData(),i=n.Theater.factory(e,r,s,t,E.palettes),E.theaters.set(e,i)),E.activeTheater=i,i}static unloadTheater(e){if(E.vfs){var t,i=E.getActiveEngine();for(t of E.getTheaterSettings(i,e).Mixes)E.vfs.removeArchive(t)}}static unloadSideMixData(){for(var e of["sidec01.mix","sidec01cd.mix"]){var t,i=f.mixDatabase.get(e);if(!i)return void console.warn(`Mix "${e}" not found in mix database`);for(t of i)("pal"===t.split(".").pop()?E.palettes:E.images).clear(t)}}static getTheaterIni(e,t){var i=E.getTheaterSettings(e,t).TheaterIni;return E.getIni(i)}static loadRules(){var e=this.getFileNameVariant("rules.ini"),t=this.getFileNameVariant("art.ini"),i=this.getFileNameVariant("ai.ini");let r=this.iniFiles.get(e),s=this.iniFiles.get(t);var a=this.iniFiles.get(i);if(!r)throw new Error(`Rules "${e}" not found`);if(!s)throw new Error(`Art "${t}" not found`);if(!a)throw new Error(`AI "${i}" not found`);t=this.iniFiles.get(E.customRulesFileName),i=this.iniFiles.get(E.customArtFileName);if(!t)throw new Error(`Rules "${E.customRulesFileName}" not found`);if(!i)throw new Error(`Art "${E.customArtFileName}" not found`);E.art=s.clone().mergeWith(i),E.rules=r.clone().mergeWith(t),E.ai=a,E.modHash=E.computeModHash()}static computeModHash(){if(!this.vfs)throw new Error("VFS not initialized");let e=[this.customRulesFileName,this.customArtFileName,this.customMpModesFileName,this.getFileNameVariant("rules.ini"),this.getFileNameVariant("art.ini"),this.getFileNameVariant("ai.ini")];var t,i,r,s=this.theaterSettings.get(this.getActiveEngine());if(!s)throw new Error('Unsupported engineType "'+this.getActiveEngine());for(t of s)e.push(this.getFileNameVariant(t.TheaterIni));let a=this.getMpModes();for(i of a.getAll())e.push(i.rulesOverride);let n=new T.Crc32;for(r of e){if(!this.vfs.fileExists(r))throw new Error(`File ${r} not found`);var o=this.vfs.openFile(r).stream;n.append(new Uint8Array(o.buffer,o.byteOffset,o.byteLength))}return n.append(b.binaryStringToUint8Array(this.getVersion())),n.get()}static getRules(){if(!E.rules)throw new Error("Rules must be loaded first");return E.rules}static getArt(){if(!E.art)throw new Error("Art must be loaded first");return E.art}static getAi(){if(!E.ai)throw new Error("AI must be loaded first");return E.ai}static getFileNameVariant(e){var t=this.getActiveEngine();let i;if(t===C.YurisRevenge)i="md";else{if(t!==C.RedAlert2)throw new Error("Unsupported engine type "+C[t]);i=""}return i?e.replace(/\.([^.]+)$/,i+".$1"):e}static getMpModes(){return new v.GameModes(this.getIni(this.customMpModesFileName),e=>this.getIni(e))}static getUiIni(){var e=this.getFileNameVariant("ui.ini");return this.getIni(e)}static getIni(e){if(!this.iniFiles.has(e))throw new Error(`INI file ${e} not found.`);return this.iniFiles.get(e)}static async loadMapList(){if(!this.vfs)throw new Error("File system not initialized");var e,i,r,t=this.getMpModes();let s=new S.MapList(t);s.addFromIni(this.getIni(this.getFileNameVariant("missions.pkt")));for(e of this.vfs.listArchives()){var a=e.toLowerCase().replace(/\.[^.]+$/,"")+".pkt";this.vfs.fileExists(a)&&s.addFromIni(new l.IniFile(this.vfs.openFile(a)))}let n=new S.MapList(t);if(this.rfs)for await(var o of this.rfs.getEntries()){let t=o.toLowerCase();try{t.endsWith(".pkt")?(i=new l.IniFile(await this.rfs.openFile(o,!0)),s.addFromIni(i)):this.supportedMapTypes.some(e=>t.endsWith("."+e))&&(r=await this.rfs.openFile(o,!0),n.addFromMapFile(r))}catch(e){console.warn(`Couldn't read file "${o}"`,e)}}return n.sortByName(),s.mergeWith(n),this.mapList=s,s}static getTileData(){return E.tileData}static getImages(){return E.images}static getVoxels(){return E.voxels}static getVoxelAnims(){return E.voxelAnims}static getPalettes(){return E.palettes}static getSounds(){return E.sounds}static getThemes(){return E.themes}static getTaunts(){return E.taunts}static getActiveEngine(){return C.RedAlert2}static getLastTheaterType(){return E.activeTheater?.type}static getCacheDir(){try{return this.getOrCreateDir(this.rfsSettings.cacheDir,!0)}catch(e){return void console.error("Couldn't get cache directory",[e])}}static async getReplayDir(){var i=this.getActiveMod();if(i){let e=await this.getModDir(),t=await e?.getDirectory(i);return t?.getOrCreateDirectory(E.rfsSettings.replayDir)}return this.getOrCreateDir(this.rfsSettings.replayDir)}static getModDir(){return this.getOrCreateDir(E.rfsSettings.modDir)}static getMapDir(){return this.getOrCreateDir(E.rfsSettings.mapDir)}static async getOrCreateDir(e,t=!1){let i=this.rfs?.getRootDirectory();if(i)return await i.getOrCreateDirectory(e,t)}static getMapList(){return this.mapList}static destroy(){this.activeTheater=void 0,this.activeMod=void 0,this.modHash=void 0,this.mapList=void 0,this.rfs=void 0,this.vfs=void 0,this.art=void 0,this.iniFiles.clear(),this.images.clear(),this.palettes.clear(),this.rules=void 0,this.ai=void 0,this.theaters.clear(),this.tileData.clear(),this.voxels.clear(),this.voxelAnims.clear()}}),E.UI_ANIM_SPEED=2,E.rfsSettings={menuVideoFileName:"ra2ts_l.webm",splashImgFileName:"glsl.png",mapDir:"maps",modDir:"mods",musicDir:"music",tauntsDir:"Taunts",cacheDir:"cache",replayDir:"replays"},E.supportedMapTypes=["mpr","map"],E.images=new d.LazyResourceCollection(e=>new i.ShpFile(e)),E.voxels=new d.LazyResourceCollection(e=>new r.VxlFile(e)),E.voxelAnims=new d.LazyResourceCollection(e=>new w.HvaFile(e)),E.sounds=new d.LazyResourceCollection(e=>new g.WavFile(e)),E.themes=new p.LazyAsyncResourceCollection(e=>new m.Mp3File(e),!1),E.taunts=new p.LazyAsyncResourceCollection(async e=>new g.WavFile(new Uint8Array(await e.arrayBuffer()))),E.iniFiles=new d.LazyResourceCollection(e=>new l.IniFile(e)),E.tileData=new d.LazyResourceCollection(e=>new s.TmpFile(e)),E.palettes=new d.LazyResourceCollection(e=>new a.Palette(e)),E.theaters=new Map,E.theaterSettings=(new Map).set(C.RedAlert2,[{Type:o.TheaterType.Temperate,TheaterIni:"temperat.ini",Mixes:["isotemp.mix","temperat.mix","tem.mix"],Extension:".tem",NewTheaterChar:"T",IsoPaletteName:"isotem.pal",UnitPaletteName:"unittem.pal",OverlayPaletteName:"temperat.pal",LibPaletteName:"libtem.pal"},{Type:o.TheaterType.Snow,TheaterIni:"snow.ini",Mixes:["isosnow.mix","snow.mix","sno.mix"],Extension:".sno",NewTheaterChar:"A",IsoPaletteName:"isosno.pal",UnitPaletteName:"unitsno.pal",OverlayPaletteName:"snow.pal",LibPaletteName:"libsno.pal"},{Type:o.TheaterType.Urban,TheaterIni:"urban.ini",Mixes:["isourb.mix","urb.mix","urban.mix"],Extension:".urb",NewTheaterChar:"U",IsoPaletteName:"isourb.pal",UnitPaletteName:"uniturb.pal",OverlayPaletteName:"urban.pal",LibPaletteName:"liburb.pal"}]).set(C.YurisRevenge,[{Type:o.TheaterType.Temperate,TheaterIni:"temperatmd.ini",Mixes:["isotemp.mix","isotemmd.mix","temperat.mix","tem.mix"],Extension:".tem",NewTheaterChar:"T",IsoPaletteName:"isotem.pal",UnitPaletteName:"unittem.pal",OverlayPaletteName:"temperat.pal",LibPaletteName:"libtem.pal"},{Type:o.TheaterType.Snow,TheaterIni:"snowmd.ini",Mixes:["isosnomd.mix","snowmd.mix","isosnow.mix","snow.mix","sno.mix"],Extension:".sno",NewTheaterChar:"A",IsoPaletteName:"isosno.pal",UnitPaletteName:"unitsno.pal",OverlayPaletteName:"snow.pal",LibPaletteName:"libsno.pal"},{Type:o.TheaterType.Urban,TheaterIni:"urbanmd.ini",Mixes:["isourbmd.mix","isourb.mix","urb.mix","urban.mix"],Extension:".urb",NewTheaterChar:"U",IsoPaletteName:"isourb.pal",UnitPaletteName:"uniturb.pal",OverlayPaletteName:"urban.pal",LibPaletteName:"liburb.pal"},{Type:o.TheaterType.NewUrban,TheaterIni:"urbannmd.ini",Mixes:["isoubnmd.mix","isoubn.mix","ubn.mix","urbann.mix"],Extension:".ubn",NewTheaterChar:"N",IsoPaletteName:"isoubn.pal",UnitPaletteName:"unitubn.pal",OverlayPaletteName:"urbann.pal",LibPaletteName:"libubn.pal"},{Type:o.TheaterType.Desert,TheaterIni:"desertmd.ini",Mixes:["isodesmd.mix","desert.mix","des.mix","isodes.mix"],Extension:".des",NewTheaterChar:"D",IsoPaletteName:"isodes.pal",UnitPaletteName:"unitdes.pal",OverlayPaletteName:"desert.pal",LibPaletteName:"libdes.pal"},{Type:o.TheaterType.Lunar,TheaterIni:"lunarmd.ini",Mixes:["isolunmd.mix","isolun.mix","lun.mix","lunar.mix"],Extension:".lun",NewTheaterChar:"L",IsoPaletteName:"isolun.pal",UnitPaletteName:"unitlun.pal",OverlayPaletteName:"lunar.pal",LibPaletteName:"liblun.pal"}]),E.customRulesFileName="rulescd.ini",E.customArtFileName="artcd.ini",E.customMpModesFileName="mpmodescd.ini"}}}),System.register("util/geometry",["util/math"],function(e,t){"use strict";var s;t&&t.id;return e("pointEquals",function(e,t){return e&&t&&e.x===t.x&&e.y===t.y||!e&&!t}),e("rectIntersect",function(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height}),e("rectEquals",function(e,t){return e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}),e("circleIntersect",function(e,t){var i=e.center,r=t.center;return s.isBetween((i.x-r.x)*(i.x-r.x)+(i.y-r.y)*(i.y-r.y),(e.radius-t.radius)*(e.radius-t.radius),(e.radius+t.radius)*(e.radius+t.radius))}),e("circleContainsPoint",function(e,t){var i=e.center;return(i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y)<=e.radius*e.radius}),e("rectContainsPoint",function(e,t){let i=new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width,e.y+e.height));return i.containsPoint(new THREE.Vector2(t.x,t.y))}),e("rectContainsRect",function(e,t){let i=new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width,e.y+e.height));var r=new THREE.Box2(new THREE.Vector2(t.x,t.y),new THREE.Vector2(t.x+t.width,t.y+t.height));return i.containsBox(r)}),e("rectClampPoint",function(e,t){let i=new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width,e.y+e.height));return i.clampPoint(new THREE.Vector2(t.x,t.y),new THREE.Vector2)}),e("octileDistance",function(e,t){var i=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return i+r+(Math.SQRT2-2)*Math.min(i,r)}),{setters:[function(e){s=e}],execute:function(){}}}),System.register("gui/component/SplashScreen",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SplashScreen",i=class{constructor(e,t){this.width=e,this.height=t,this.rendered=!1}render(r){if(!this.rendered){let e=this.el=document.createElement("div");e.style.backgroundColor="black",e.style.color="white",e.style.padding="10px",e.style.boxSizing="border-box",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="50% 50%",e.style.textShadow="1px 1px black",this.updateSize();var s=this.loadingEl=document.createElement("div");e.appendChild(s);let t=this.copyrightEl=document.createElement("div");t.style.position="absolute",t.style.bottom="10px",t.style.right="10px",t.style.textAlign="right",e.appendChild(t);let i=this.disclaimerEl=document.createElement("div");i.style.position="absolute",i.style.bottom="10px",i.style.left="10px",e.appendChild(i),r.appendChild(e),this.rendered=!0}}setBackgroundImage(e){this.el.style.backgroundImage=`url(${e})`}setLoadingText(e){this.loadingEl.innerHTML=e}setCopyrightText(e){this.copyrightEl.innerHTML=e.replace(/\n/g,"<br />")}setDisclaimerText(e){this.disclaimerEl.innerHTML=e.replace(/\n/g,"<br />")}setSize(e,t){this.width=e,this.height=t,this.updateSize()}updateSize(){this.el&&(this.el.style.width=this.width+"px",this.el.style.height=this.height+"px")}destroy(){this.rendered&&(this.el.remove(),this.rendered=!1)}})}}}),System.register("util/event",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("EventDispatcher",i=class{constructor(){this.listeners=new Set}subscribe(e){this.listeners.add(e)}subscribeOnce(i){let r=(e,t)=>{i(e,t),this.unsubscribe(r),r=void 0};this.subscribe(r)}unsubscribe(e){this.listeners.delete(e)}dispatch(t,i){this.listeners.forEach(e=>e(i,t))}asEvent(){return this}})}}}),System.register("util/time",[],function(e,t){"use strict";t&&t.id;return e("sleep",async function(t){return new Promise(e=>{setTimeout(()=>e(),t)})}),{setters:[],execute:function(){}}}),System.register("network/IrcConnection",["util/event","util/string","util/time"],function(e,t){"use strict";var i,o,d,g;t&&t.id;return{setters:[function(e){i=e},function(e){o=e},function(e){d=e}],execute:function(){e("IrcConnection",g=class g{constructor(e,t){this.options=e,this.logger=t,this.timeout=5,this._onMessage=new i.EventDispatcher,this._onError=new i.EventDispatcher,this._onClose=new i.EventDispatcher,this.messageBuffer=""}get onMessage(){return this._onMessage.asEvent()}get onError(){return this._onError.asEvent()}get onClose(){return this._onClose.asEvent()}async connect(r){return new Promise((e,t)=>{this.socket=new WebSocket(r),"binary"===this.options.mode&&(this.socket.binaryType="blob");let i=e=>{this.socket.removeEventListener("error",i),t(new g.ConnectError(`Connection to "${r}" failed`))};this.socket.addEventListener("open",()=>{this.socket.removeEventListener("error",i),this.handleOpen(),e()}),this.socket.addEventListener("error",i),this.socket.addEventListener("error",e=>this.handleError(e)),this.socket.addEventListener("close",e=>this.handleClose(e)),this.socket.addEventListener("message",e=>{globalThis.Blob&&e.data instanceof Blob?this.parseData(e.data).then(e=>{this.handleMessage(e)}).catch(e=>{console.error("Failed to decode socket message.",e)}):this.handleMessage(e.data)})})}handleOpen(){this.logger.info("Connection open to "+this.socket.url)}handleError(e){this.logger.error("Connection error",e),this._onError.dispatch(this,e)}handleClose(e){this.logger.info(`Connection closed (${this.socket.url})`,e),this._onClose.dispatch(this,e)}handleMessage(e){if("string"!=typeof e){if(e[0]===this.options.binaryRplPrefix)return void this._onMessage.dispatch(this,e.slice(1));e=o.uint8ArrayToBinaryString(e)}this.logger.debug("Got message:",e),e=this.messageBuffer+e,this.messageBuffer="";let t=e.split(/\r?\n/);var i=t.pop();i.length&&(this.messageBuffer=i),t.filter(e=>!!e).forEach(e=>this._onMessage.dispatch(this,e))}parseData(r){return new Promise((e,t)=>{let i=new FileReader;i.onload=()=>e(new Uint8Array(i.result)),i.onerror=()=>t(),i.readAsArrayBuffer(r)})}async sendCommand(e,a){if(a.replyStartCode&&!a.replyEndCode)throw new Error("Invalid argument. Expected a reply end code, but got only a start code.");let n=[];return await this.sendRawCommand(e,(e,r,s)=>{if("string"!=typeof e){if(e[0]===this.options.binaryRplPrefix)return!1;e=o.uint8ArrayToBinaryString(e)}return a.replyRawText?(s(e.split(/\r?\n/).map(e=>({raw:e,time:r}))),!0):e.split(/\r?\n/).filter(e=>!!e).some(e=>(e=>{if(a.replyMatch)return!!a.replyMatch.exec(e)&&(s([{raw:e,time:r}]),!0);if(!a.replyEndCode&&!a.replyCodes)return s([{raw:e,time:r}]),!0;var[,t,...i]=e.split(" "),t=parseInt(t,10),i={raw:e,code:t,params:i,time:r};if(a.replyEndCode)return a.replyCodes&&-1!==a.replyCodes.indexOf(t)?(s([i]),!0):((t===a.replyStartCode||a.replyBodyCodes&&-1!==a.replyBodyCodes.indexOf(t)||t===a.replyEndCode)&&n.push(i),t===a.replyEndCode&&(s(n),!0));if(void 0===a.replyCodes)throw new Error("List of replyCodes must be specified when not using start/end codes");return-1!==a.replyCodes.indexOf(t)&&(s([i]),!0)})(e))},a.timeout)}async sendBinCommand(e,s){const a=this.options.binaryRplPrefix;if(!a)throw new Error("Must configure binary message reply prefix to send binary commands");const t=this.options.binaryReqPrefix;if(!t)throw new Error("Must configure binary message request prefix to send binary commands");if(e[0]!==t)throw new Error("Binary command must start with the magic prefix 0x"+t.toString(16));return await this.sendRawCommand(e,(e,t,i)=>{if("string"==typeof e||e[0]!==a)return!1;var r=e[1];return-1!==s.replyCodes.indexOf(r)&&(i({code:r,data:e.slice(2),time:t}),!0)},s.timeout)}sendRawCommand(h,u,e){return new Promise((t,i)=>{let r=!1,s,a=e=>{clearTimeout(s),t(e)},n=e=>{this.socket.removeEventListener("message",c),this.socket.removeEventListener("close",o),clearTimeout(s),s=void 0,i(e)};let o=async()=>{for(;r;)await d.sleep(10);l||n(new g.SocketError("Connection was closed prematurely"))},l=!1,c=e=>{if(!l){let t=Date.now();globalThis.Blob&&e.data instanceof Blob?(r=!0,this.parseData(e.data).then(e=>{r=!1,l||u(e,t,a)&&(l=!0,this.socket.removeEventListener("message",c),this.socket.removeEventListener("close",o))}).catch(e=>{r=!1,console.error("Failed to decode socket message.",e)})):u(e.data,t,a)&&(l=!0,this.socket.removeEventListener("message",c),this.socket.removeEventListener("close",o))}};if(this.socket&&this.socket.readyState===WebSocket.OPEN){s=setTimeout(()=>{var e="string"==typeof h?h:"0x"+h[1].toString(16);n(new g.NoReplyError("Timeout reached for command "+e))},1e3*(e??this.timeout)),this.socket.addEventListener("message",c),this.socket.addEventListener("close",o);try{this.sendMessage(h)}catch(e){n(e)}}else n(new g.SocketError("Send command failed. Socket is not open."+(this.socket?` (readyState = ${this.socket.readyState})`:"")))})}sendMessage(e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)throw new g.SocketError("Socket is not open"+(this.socket?` (readyState = ${this.socket.readyState})`:""));this.logger.debug("Sent message:",e),"string"==typeof e&&(e+="\r\n");let t;t="binary"===this.options.mode&&"string"==typeof e?o.binaryStringToUint8Array(e):e,this.socket.send(t)}async ping(e){var t=Date.now();return(await this.sendCommand("ping :"+t,{replyMatch:new RegExp("^:[^ ]+ PONG [^ :]+ :"+t,"i"),timeout:e}))[0].time-t}close(){this.socket&&this.socket.close()}isOpen(){return this.socket&&this.socket.readyState===WebSocket.OPEN}}),g.MAX_CHANNELNAME_LEN=30,function(e){class t extends Error{constructor(e){super(e)}}e.NoReplyError=t;class i extends Error{constructor(e){super(e)}}e.SocketError=i;class r extends Error{constructor(e){super(e)}}e.ConnectError=r}(g=g||{}),e("IrcConnection",g)}}}),System.register("network/Apgar",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Apgar",i=class{static encode(e){let t="";for(let s=0;s<8;s++){var i=e.charCodeAt(s),r=0<s?e.charCodeAt(e.length-s):0;t+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789./"[63&(0<(1&i)?i<<1&r:i^r)]}return t}})}}}),System.register("network/WolError",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;i=class extends Error{constructor(e,t){super(e),this.code=t}},t("WolError",i),(e=(e=i=i||{}).Code||(e.Code={}))[e.OutdatedClient=0]="OutdatedClient",e[e.BadLogin=1]="BadLogin",e[e.BadGamePass=2]="BadGamePass",e[e.GameHasClosed=3]="GameHasClosed",e[e.ChannelFull=4]="ChannelFull",e[e.BannedFromChannel=5]="BannedFromChannel",t("WolError",i)}}}),System.register("util/typeGuard",[],function(e,t){"use strict";t&&t.id;return e("isNotNullOrUndefined",function(e){return null!=e}),{setters:[],execute:function(){}}}),System.register("network/gameopt/FileNameEncoder",["util/Base64","util/string"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("FileNameEncoder",s=class{encode(e){return e.match(/^[a-z0-9-_]+\.[a-z]{3}$/i)?e:i.Base64.encode(r.utf16ToBinaryString(e))}decode(e){return e.match(/\.[a-z]{3}$/i)?e:r.binaryStringToUtf16(i.Base64.decode(e))}})}}}),System.register("network/chat/ChatMessage",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Channel=0]="Channel",e[e.Page=1]="Page",e[e.Whisper=2]="Whisper",t("ChatRecipientType",i)}}}),System.register("network/WolConnection",["util/event","network/IrcConnection","network/Apgar","network/WolError","util/string","util/Base64","util/typeGuard","network/gameopt/FileNameEncoder","network/chat/ChatMessage"],function(t,e){"use strict";var i,o,s,a,T,v,r,b,l,c,h,u,n,d,g,p,m,f,y,S,w,C,E,x;e&&e.id;return{setters:[function(e){i=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){T=e},function(e){v=e},function(e){r=e},function(e){b=e},function(e){l=e}],execute:function(){var e;c=332,h=353,u=366,n=321,d=322,g=326,p=323,m=401,f=403,y=475,S=478,w=471,C=474,(e=E=E||{})[e.NoMap=0]="NoMap",e[e.HasMap=1]="HasMap",e[e.MapTransfer=2]="MapTransfer",t("WolHasMapStatus",E),t("WolConnection",x=class x{constructor(e,t){this.con=e,this.logger=t,this.wolv2Compat=!1,this.wolv2Ascii=!1,this.currentChannels=new Set,this._onChatMessage=new i.EventDispatcher,this._onJoinChannel=new i.EventDispatcher,this._onLeaveChannel=new i.EventDispatcher,this._onGameStart=new i.EventDispatcher,this._onGameOpt=new i.EventDispatcher,this._onGameMode=new i.EventDispatcher,this.handleMessage=t=>{if("string"==typeof t){let e=t.split(" ");"ping"===e[0].toLowerCase()?this.con.sendMessage("PONG"+(e[1]?" "+e[1]:"")):"privmsg"===e[1].toLowerCase()?this.handlePrivMsg(t):"page"===e[1].toLowerCase()||"notice"===e[1].toLowerCase()?this.handlePageOrNotice(t):"join"===e[1].toLowerCase()?this.handleJoin(t):"joingame"===e[1].toLowerCase()?this.handleJoingame(t):"part"===e[1].toLowerCase()?this.handlePart(t):"kick"===e[1].toLowerCase()?this.handleKick(t):"gameopt"===e[1].toLowerCase()?this.handleGameOpt(t):"mode"===e[1].toLowerCase()?this.handleMode(t):"startg"===e[1].toLowerCase()?this.handleStartGame(t):Number.isNaN(Number(e[1]))||this.handlePrivMsgError(t)}},this.handleClose=()=>{this.currentUser=void 0,this.currentGameChannel=void 0,this.currentChannels.clear()}}get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onChatMessage(){return this._onChatMessage}get onJoinChannel(){return this._onJoinChannel}get onLeaveChannel(){return this._onLeaveChannel}get onGameStart(){return this._onGameStart}get onGameOpt(){return this._onGameOpt}get onGameMode(){return this._onGameMode}static factory(e){return new this(new o.IrcConnection({mode:"binary"},e),e)}static escapeChannelName(e){return e.split("").map(e=>{switch(e){case" ":return"_";case"%":return"%%";case"$":return"$$";case"_":return"$_";case"\b":return"$b";case"\n":return"$n";case"\r":return"$r";case":":return"$=";case",":return"$-";default:return e}}).join("")}static unescapeChannelName(e){var t=e.split("");let i="",r=0;for(;r<t.length;){var s,a=t[r++];let e;e="%"===a||"$"===a?"b"===(s=t[r++])?"\b":"n"===s?"\n":"r"===s?"\r":"="===s?":":"-"===s?",":s:"_"===a?" ":a,i+=e}return i}getCurrentUser(){return this.currentUser}getCurrentChannels(){return[...this.currentChannels]}isInChannel(e){return this.currentChannels.has(e)}getServerName(){return this.serverName}getWolV2Ascii(){return this.wolv2Ascii}setWolV2Ascii(e){this.wolv2Ascii=e}async connect(e,t,i){return this.wolv2Compat=t,this.wolv2Ascii=i,this.con.onMessage.subscribe(this.handleMessage),this.con.onClose.subscribeOnce(this.handleClose),await this.con.connect(e)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close()}isOpen(){return this.con.isOpen()}ping(e){return this.con.ping(e)}cvers(e){return this.con.sendMessage("cvers 0 "+e)}async login(e,t){let i=await this.con.sendCommand(["pass supersecret","nick "+e,"apgar "+s.Apgar.encode(t),"user UserName HostName irc.westwood.com :RealName"].join("\r\n"),{replyCodes:[378],replyStartCode:375,replyBodyCodes:[372],replyEndCode:376});if(1!==i.length||378!==i[0].code)return this.currentUser=e,this.serverName=i[0].raw.match(/^:([^\s]+)/)?.[1]||"",i.slice(0,-1).map(e=>e.raw.replace(/^.*:- /,""));var r=i[0].params?i[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new a.WolError("Login error: "+r,a.WolError.Code.BadLogin)}async joinChannel(e,t){var i="join "+x.escapeChannelName(e)+(void 0!==t?" "+t:"");let r=await this.con.sendCommand(i,{replyStartCode:c,replyBodyCodes:[h],replyEndCode:u});return this.currentChannels.add(e),this.currentGameChannel=void 0,this.lastChannelOpts={name:e,pass:t},this.logger.info(`Joined channel "${e}"`),this.parseNames(r.slice(1,-1)).sort((e,t)=>Number(t.operator)-Number(e.operator))}async listUsers(e){let t=await this.con.sendCommand("NAMES "+x.escapeChannelName(e),{replyBodyCodes:[h],replyEndCode:u});return this.parseNames(t.slice(0,-1)).sort((e,t)=>Number(t.operator)-Number(e.operator))}async rejoinLastChannel(){this.lastChannelOpts&&await this.joinChannel(this.lastChannelOpts.name,this.lastChannelOpts.pass)}sendChatMessage(e,t){if(!this.currentUser)throw new Error("Must login before sending messages");t.type!==l.ChatRecipientType.Channel&&t.type!==l.ChatRecipientType.Whisper||this.privmsg([t.name],e)}privmsg(e,t){if(!this.currentUser)throw new Error("Must login before sending messages");var i,r,s=e.map(e=>e.startsWith("#")?x.escapeChannelName(e):e).join(",");let a=t;this.wolv2Ascii||(t.startsWith("/")?(i=t.match(/^\/(msg|m|whisper|w) ([^ ]+) (.+)/i))?a=`/w ${i[2]} `+v.Base64.encode(T.utf16ToBinaryString(i[3])):(i=t.match(/^\/r(?:eply)? (.+)/i))&&(a="/reply "+v.Base64.encode(T.utf16ToBinaryString(i[1]))):a=v.Base64.encode(T.utf16ToBinaryString(t))),this.con.sendMessage(`privmsg ${s} :`+a);for(r of e){var n=r.startsWith("#");this._onChatMessage.dispatch(this,{from:this.currentUser,to:{type:n?l.ChatRecipientType.Channel:l.ChatRecipientType.Whisper,name:r},text:t})}}kick(e,t,i){this.con.sendMessage(`kick ${x.escapeChannelName(t)} ${e.join(",")} :`+i)}async listGames(e,y){if(!this.currentUser)throw new Error("Must login before sending messages");let t=await this.con.sendCommand(`list ${e} `+e,{replyStartCode:n,replyBodyCodes:[d,g],replyEndCode:p});return t.slice(1,-1).map(e=>{if(!e.params||e.params.length<9)throw new Error(`Unexpected reply for list command "${e.raw}". Insufficient params.`);let t=x.unescapeChannelName(e.params[1]);var i=e.params[2],r=Number(e.params[4]),s=e.params[5],a=e.params[6],n=e.params[7];let[o,l]=e.params[8]?.split("::")??[];var c=e.params[9],h=l?.split(",")??[];if(!(r!==y||h.length<=1)){var u=h[0],d=Number(h[1]),g=u[2],p=h[2],m=h[3],f=h[4],r=(new b.FileNameEncoder).decode(h[5]),u=h[6]?T.binaryStringToUtf16(v.Base64.decode(h[6])):"",h=h[7]?T.binaryStringToUtf16(v.Base64.decode(h[7])):void 0;return{hostName:t.match(/^#?([^']+)'s game$/)?.[1],hostPing:this.wolv2Compat?void 0:Number(n),hostMuted:this.wolv2Compat?void 0:Boolean(Number(c)),name:t,description:u,modHash:d,modName:h,tournament:Boolean(Number(s)),humanPlayers:Number(i),aiPlayers:Number(p),maxPlayers:Number(g),observers:Number(m),observable:Boolean(Number(f)),mapName:r,passLocked:384===Number(o),resLocked:Boolean(Number(a))}}}).filter(r.isNotNullOrUndefined)}leaveChannel(e){this.currentChannels.has(e)&&this.con.sendMessage("PART "+x.escapeChannelName(e))}leaveAllChannels(){for(var e of this.getCurrentChannels())this.leaveChannel(e)}async createGame(e,t,i,r,s){var a="#"+(this.getCurrentUser()+"'s game"),n=x.escapeChannelName(a).slice(0,o.IrcConnection.MAX_CHANNELNAME_LEN-1),a=x.unescapeChannelName(n);return await this.con.sendCommand(`joingame ${n} ${e} ${t} ${i} 0 0 ${r?1:0} 0`+(s?" "+s:""),{replyStartCode:c,replyBodyCodes:[h],replyEndCode:u}),this.currentChannels.add(a),this.currentGameChannel=a,this.lastChannelOpts={name:a,pass:s},this.logger.info(`Joined channel "${a}"`),a}async joinGame(t,i){var r=x.escapeChannelName(t);let s=await this.con.sendCommand(`joingame ${r} 1 `+(i||""),{replyCodes:[y,S,w,C],replyStartCode:c,replyBodyCodes:[h],replyEndCode:u});if(1<s.length){this.currentChannels.add(t),this.currentGameChannel=t,this.lastChannelOpts={name:t,pass:i},this.logger.info(`Joined channel "${t}"`);let e=this.parseNames(s.slice(1,-1));r=e.find(e=>e.operator)?.name;if(void 0===r)throw new Error("Unexpected reply for joingame command. Can't find host player name");return r}switch(s[0].code){case y:throw new a.WolError("Wrong password",a.WolError.Code.BadGamePass);case S:throw new a.WolError("Game has closed",a.WolError.Code.GameHasClosed);case w:throw new a.WolError("Channel is full",a.WolError.Code.ChannelFull);case C:throw new a.WolError("Banned from channel",a.WolError.Code.BannedFromChannel);default:throw new Error("Unknown error")}}startGame(e){if(!this.currentGameChannel)throw new Error("No game channel active");var t=e.join(",");this.con.sendMessage(`startg ${x.escapeChannelName(this.currentGameChannel)} `+t)}parseNames(e){let i=[];return e.forEach(e=>{var t=e.raw.replace(new RegExp("^.*(=|\\*) [^ ]+ :"),"").split(" ").map(e=>e.split(",")).map(([e,,t])=>{var i=e.startsWith(x.CHAN_OP_PREFIX),r=this.wolv2Compat?void 0:Number(t);return{name:i?e.slice(x.CHAN_OP_PREFIX.length):e,operator:i,ping:r}});i=i.concat(t)}),i}sendPlayerReady(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"A"+(e?1:0))}sendPlayerHasMap(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"K"+e)}sendGameStartRequest(){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"G")}sendGameSlotsInfo(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"L"+e)}sendPingData(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"P"+e)}sendObserverSlot(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"O"+e)}sendGameOpts(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,e)}sendPlayerOpts(e,t,i,r,s){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(e,`R${t},${i},${r},${s},0,0,0`)}sendModeChannelMax(e,t){this.con.sendMessage(`MODE ${x.escapeChannelName(e)} +l `+t)}sendGameTopic(e,t,i,r,s,a,n,o,l){if(!this.currentGameChannel)throw new Error("No game channel active");var c=(new b.FileNameEncoder).encode(a),h=v.Base64.encode(T.utf16ToBinaryString(o.slice(0,x.MAX_ROOM_DESC_LEN-1))),u=void 0!==l?v.Base64.encode(T.utf16ToBinaryString(l.slice(0,x.MAX_ROOM_DESC_LEN-1))):"";this.con.sendMessage(`topic ${x.escapeChannelName(this.currentGameChannel)} :g${e}${t}N39,`+n+`,${i},${r},${s?1:0},`+c+`,${h},`+u)}gameOpt(e,t){if(!this.currentUser)throw new Error("Must login first");if(!this.currentGameChannel)throw new Error("No game channel active");var i=e.startsWith("#")?x.escapeChannelName(e):e;this.con.sendMessage(`gameopt ${i} :`+t),this._onGameOpt.dispatch(this,{user:this.currentUser,opt:t})}handleJoin(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOIN :([^ ]+) ([^ ]+)/i);if(!t)throw new Error(`Unexpected JOIN message format "${e}"`);let[,i,r,s]=t;t=r.trim().split(",");this._onJoinChannel.dispatch(this,{type:"join",user:{name:i,ping:this.wolv2Compat?void 0:Number(t[1]),operator:this.wolv2Compat?void 0:Boolean(Number(t[2]))},channel:x.unescapeChannelName(s)})}handleJoingame(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOINGAME ([^:]+):([^ ]+)/i);if(!t)throw new Error(`Unexpected JOINGAME message format "${e}"`);let[,i,r,s]=t;t=r.trim().split(" ");s=x.unescapeChannelName(s),this._onJoinChannel.dispatch(this,{type:"join",user:{name:i,operator:!1,ping:this.wolv2Compat?void 0:Number(t[5])},channel:s})}handleStartGame(e){var t=e.match(/^:[A-Za-z0-9-_]+![^ ]+ STARTG [^:]+:[^:]+:(\d+) (\d+)/i);if(!t)throw new Error(`Unexpected STARTG message format "${e}"`);var[,i,t]=t;this._onGameStart.dispatch(this,{gameId:Number(i),timestamp:Number(t)})}handlePrivMsg(e){var t=e.match(/^:([A-Za-z0-9-_]+)\![^ ]+ PRIVMSG ([^ ]+) :(.*)/i);if(!t)throw new Error(`Unexpected PRIVMSG message format "${e}"`);let[,i,r,s]=t;!this.wolv2Ascii&&i!==this.getServerName()&&v.Base64.isBase64(s)&&(s=T.binaryStringToUtf16(v.Base64.decode(s)));let a;r.startsWith("#")?a={from:i,to:{type:l.ChatRecipientType.Channel,name:x.unescapeChannelName(r)},text:s}:r===this.currentUser&&(a={from:i,to:{type:l.ChatRecipientType.Whisper,name:r},text:s}),a&&this._onChatMessage.dispatch(this,a)}handlePrivMsgError(e){var t=e.match(/^:([A-Za-z0-9-_]+) (\d+) ([^ ]+) (?:([^ ]*) )?:(.*)/i);if(t){var[,i,r,s,,t]=t;if([m,f].includes(Number(r))){let e;s===this.currentUser&&(e={from:i,to:{type:l.ChatRecipientType.Page,name:s},text:t}),e&&this._onChatMessage.dispatch(this,e)}}}handlePageOrNotice(e){var t=e.match(/^:([A-Za-z0-9-_]+)(?:![^ ]+)? (?:PAGE|NOTICE) ([^ ]+) :(.*)/i);if(!t)throw new Error(`Unexpected PAGE message format "${e}"`);let[,i,r,s]=t;!this.wolv2Ascii&&i!==this.getServerName()&&v.Base64.isBase64(s)&&(s=T.binaryStringToUtf16(v.Base64.decode(s)));t={text:s,from:i,to:{type:l.ChatRecipientType.Page,name:r}};this._onChatMessage.dispatch(this,t)}handlePart(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ PART ([^ ]+)/i);if(!t)throw new Error(`Unexpected PART message format "${e}"`);var[,i,t]=t,t=x.unescapeChannelName(t);i===this.currentUser&&(t===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(t),this.logger.info(`Left channel "${t}"`)),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:i},channel:t})}handleKick(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ KICK ([^ ]+) ([A-Za-z0-9-_]+)/i);if(!t)throw new Error(`Unexpected KICK message format "${e}"`);var[,,i,t]=t,i=x.unescapeChannelName(i);t===this.currentUser&&(i===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(i),this.logger.info(`Left channel "${i}"`)),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:t},channel:i})}handleGameOpt(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ GAMEOPT ([^ ]+) :(.*)/i);if(!t)throw new Error(`Unexpected GAMEOPT message format"${e}"`);var[,i,,t]=t;this._onGameOpt.dispatch(this,{user:i,opt:t})}handleMode(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ MODE ([^ ]+) \+l (\d+)/i);t?([,,,t]=t,this._onGameMode.dispatch(this,Number(t))):this.logger.warn("Got unknown MODE line: "+e)}}),x.MAX_ROOM_DESC_LEN=64,x.CHAN_OP_PREFIX="@"}}}),System.register("network/gamestate/PlayerActionPayload",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gameopt/MapNameLegacyEncoder",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MapNameLegacyEncoder",i=class{encode(e){let a=[],n=0;return e.split("").forEach((e,t)=>{var i=e.charCodeAt(0)<<2*t-7*n,r=127&i,s=i>>7&127,i=i>>14&127;i&&n++,a.push(r,s),i&&a.push(i)}),a.push(0,0),2<=e.length&&a.push(0),a=a.map(e=>128^e),a.map(e=>String.fromCharCode(e)).join("")}decode(e){let i=e.split("").map(e=>e.charCodeAt(0));for(i=i.map(e=>128^e);0===i[i.length-1];)i.pop();let r=[],s=0,a=0;for(;i.length;){var n=r.length,o=i.shift(),l=i.shift();let e=0,t=!1;(-1!==[1,2,3].indexOf(i[0])||n>s+3)&&(e=i.shift(),s=n,t=!0);n=(e<<14|l<<7|o)>>2*n-7*a;r.push(127&n),t&&a++}return r.map(e=>String.fromCharCode(e)).join("")}})}}}),System.register("network/gameopt/PingInfo",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameopts/GameOpts",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;t("isHumanPlayerInfo",e=>"name"in e),(e=i=i||{})[e.Brutal=0]="Brutal",e[e.Medium=1]="Medium",e[e.Easy=2]="Easy",t("AiDifficulty",i)}}}),System.register("network/gameopt/SlotInfo",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Closed=0]="Closed",e[e.Open=1]="Open",e[e.OpenObserver=2]="OpenObserver",e[e.Player=3]="Player",e[e.Ai=4]="Ai",t("SlotType",i)}}}),System.register("network/gameopt/Parser",["data/DataStream","network/gameopt/MapNameLegacyEncoder","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/FileNameEncoder","util/Base64","util/string"],function(e,t){"use strict";var o,c,s,a,h,u,d,i;t&&t.id;return{setters:[function(e){o=e},function(e){c=e},function(e){s=e},function(e){a=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("Parser",i=class{parseOptions(e){let i={},[t,r,,s]=e.split(":"),a=t.split(",");a.shift(),a.shift(),i.gameSpeed=6-Number(a.shift()),i.credits=Number(a.shift()),i.unitCount=Number(a.shift()),i.shortGame=Boolean(Number(a.shift())),i.superWeapons=Boolean(Number(a.shift())),i.buildOffAlly=Boolean(Number(a.shift())),i.mcvRepacks=Boolean(Number(a.shift())),i.cratesAppear=Boolean(Number(a.shift())),i.gameMode=Number(a.shift()),i.hostTeams=Boolean(Number(a.shift()));var n=a.shift();if(i.mapTitle=u.Base64.isBase64(n)?d.binaryStringToUtf16(u.Base64.decode(n)):(new c.MapNameLegacyEncoder).decode(n),i.maxSlots=Number(a.shift()),i.mapOfficial=Boolean(Number(a.shift())),i.mapSizeBytes=Number(a.shift()),i.mapName=(new h.FileNameEncoder).decode(a.shift()),i.mapDigest=a.shift(),i.humanPlayers=this.parsePlayerOpts(r),i.aiPlayers=[],s){var o=s.slice(0,-1).split(",");if(o.length%5!=0)throw new Error("Couldn't parse gameopt: unexpected ai data length "+o.length);for(let e=0,t=Math.floor(o.length/5);e<t;++e){var l={difficulty:Number(o[5*e]),countryId:Number(o[5*e+1]),colorId:Number(o[5*e+2]),startPos:Number(o[5*e+3]),teamId:Number(o[5*e+4])};i.aiPlayers.push(-1!==l.countryId?l:void 0)}}return i}parsePlayerOpts(e){var t=e.split(",");if(t.length%8!=0)throw new Error("Couldn't parse gameopt: unexpected players data length "+t.length);let i=[];for(let s=0,a=Math.floor(t.length/8);s<a;++s){var r={name:t[8*s],countryId:Number(t[8*s+1]),colorId:Number(t[8*s+2]),startPos:Number(t[8*s+3]),teamId:Number(t[8*s+4])};i.push(r)}return i}parsePingData(e){var t=e.split(",").slice(1);if(t.length%2)throw new Error("Couldn't parse gameopt: unexpected ping data length "+t.length);let i=[];for(let r=0,s=Math.floor(t.length/2);r<s;++r)i.push({playerName:t[2*r],ping:Number(t[2*r+1])});return i}parseSlotData(e){var i;let r=[];for(i of e.slice(1,-1).split(",")){let t={};if("@Closed@"===i)t.type=s.SlotType.Closed;else if("@Open@"===i)t.type=s.SlotType.Open;else if("@OpenObserver@"===i)t.type=s.SlotType.OpenObserver;else if(-1!==["@EasyAI@","@MediumAI@","@HardAI@"].indexOf(i)){t.type=s.SlotType.Ai;let e;if("@EasyAI@"===i)e=a.AiDifficulty.Easy;else if("@MediumAI@"===i)e=a.AiDifficulty.Medium;else{if("@HardAI@"!==i)throw new Error("Couldn't parse gameopt: unknown slot type "+i);e=a.AiDifficulty.Brutal}t.difficulty=e}else t.type=s.SlotType.Player,t.name=i;r.push(t)}return r}parsePlayerActions(e){let t=new o.DataStream(e);var i=t.readUint8();let r=[];for(let n=0;n<i;++n){var s=t.readUint8(),a=t.readUint16(),a=0<a?t.readUint8Array(a):new Uint8Array;r.push({id:s,params:a})}return r}parseAllPlayerActions(e){var t=e.readUint8();let i=new Map;for(let a=0;a<t;++a){var r=e.readUint8(),s=e.readUint16(),s=0<s?e.readUint8Array(s):new Uint8Array,s=this.parsePlayerActions(s);i.set(r,s)}return i}parseMapData(e){return d.uint8ArrayToBinaryString(e)}})}}}),System.register("Config",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Config",i=class{load(e){let t=e.getSection("General");if(!t)throw new Error("Missing [General] section in application config");this.generalData=t,this.viewport={width:t.getNumber("viewport.width"),height:t.getNumber("viewport.height")};let i=e.getSection("Sentry");i&&(this.sentry={dsn:i.getString("dsn"),env:i.getString("env"),defaultIntegrations:i.getBool("defaultIntegrations"),lazyLoad:i.getBool("lazyLoad",!0)})}get defaultLanguage(){return this.generalData.getString("defaultLanguage","en-US")}get serversUrl(){return this.generalData.getString("serversUrl","servers.ini")}get gameresBaseUrl(){return this.generalData.getString("gameresBaseUrl")||void 0}get gameResArchiveUrl(){return this.generalData.getString("gameResArchiveUrl")}get mapsBaseUrl(){return this.generalData.getString("mapsBaseUrl")}get modsBaseUrl(){return this.generalData.getString("modsBaseUrl")}get devMode(){return this.generalData.getBool("dev")}get discordUrl(){var e=this.generalData.getString("discordUrl");if(e.length)return e}get patchNotesUrl(){var e=this.generalData.getString("patchNotesUrl");if(e.length)return e}get ladderRulesUrl(){var e=this.generalData.getString("ladderRulesUrl");if(e.length)return e}get modSdkUrl(){var e=this.generalData.getString("modSdkUrl");if(e.length)return e}get donateUrl(){var e=this.generalData.getString("donateUrl");if(e.length)return e}get breakingNewsUrl(){var e=this.generalData.getString("breakingNewsUrl");if(e.length)return e}get quickMatchEnabled(){return this.generalData.getBool("quickMatchEnabled")}get unrankedQueueEnabled(){return this.generalData.getBool("unrankedQueueEnabled")}get botsEnabled(){return this.generalData.getBool("botsEnabled")}get wolv2Compat(){return this.generalData.getBool("wolv2Compat")}get oldClientsBaseUrl(){var e=this.generalData.getString("oldClientsBaseUrl");if(e.length)return e}get debugGameState(){return this.generalData.getBool("debugGameState")}})}}}),System.register("util/Routing",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Routing",i=class{constructor(){this.routes={}}addRoute(e,t){this.routes[e]={controller:t}}init(){window.addEventListener("hashchange",()=>this.router()),this.router()}async router(){let t=location.hash.slice(1)||"/";if(t.match(/^\//)){var[,i,...r]=t.split("/");this.routes["*"]&&await this.routes["*"].controller(r);let e=this.routes["/"+i];e.controller&&await e.controller(r)}}})}}}),System.register("engine/type/ObjectType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Aircraft=1]="Aircraft",e[e.Building=2]="Building",e[e.Infantry=3]="Infantry",e[e.Overlay=4]="Overlay",e[e.Smudge=5]="Smudge",e[e.Terrain=6]="Terrain",e[e.Vehicle=7]="Vehicle",e[e.Animation=8]="Animation",e[e.Projectile=9]="Projectile",e[e.VoxelAnim=10]="VoxelAnim",e[e.Debris=11]="Debris",t("ObjectType",i)}}}),System.register("game/rules/ObjectRules",["engine/type/ObjectType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectRules",r=class{constructor(e,t,i=-1){this.type=e,this.ini=t,this.index=i,this.parse()}static iniSpeedToLeptonsPerTick(e,t){return Math.min(256,256*e/t)}static iniRotToDegsPerTick(e){return e/256*360}parse(){this.alphaImage=this.ini.getString("AlphaImage")||void 0,this.alternateArcticArt=this.ini.getBool("AlternateArcticArt"),this.crushable=this.ini.getBool("Crushable",this.type===i.ObjectType.Infantry),this.crushSound=this.ini.getString("CrushSound")||void 0,this.dontScore=this.ini.getBool("DontScore"),this.insignificant=this.ini.getBool("Insignificant"),this.legalTarget=this.ini.getBool("LegalTarget",!0),this.noShadow=this.ini.getBool("NoShadow"),this.uiName=this.ini.getString("UIName")}get name(){return this.ini.name}get imageName(){let e=this.ini.getString("Image");return e&&"null"!==e||(e=this.name),e}}),r.IMAGE_NONE="none"}}}),System.register("game/math/GameMath",["util/math"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("GameMath",i=class{static reverseSinTableLookup(e,t,i,r){for(;t<=i;){var s=Math.floor((t+i)/2),a=this.SIN_TABLE[s];if(a===e)return s;(r?e<a:a<e)?t=s+1:i=s-1}return Math.abs(e-this.SIN_TABLE[t])<Math.abs(e-this.SIN_TABLE[i])?t:i}static pow(e,t){if(!Number.isFinite(e)||!Number.isFinite(t)||Number.isSafeInteger(e)&&Number.isSafeInteger(t))return e**t;if(!Number.isSafeInteger(t))throw new Error("Exponent must be a safe integer");return Math.floor(e*this.EXP_10_PRECISION)**t/this.EXP_10_PRECISION**t}static sqrt(e){if(0===e)return 0;var t;let i=e/3;for(;t=i,i=(e/i+i)/2,5e-15<Math.abs(t-i););return i}static sin(e){if(!Number.isFinite(e))return NaN;if(!e)return e;var t=e/(2*Math.PI)-Math.floor(e/(2*Math.PI)),t=Math.floor(t*this.SIN_TABLE.length);return this.SIN_TABLE[t]}static cos(e){return this.sin(e+Math.PI/2)}static asin(e){if(!r.isBetween(e,-1,1))return NaN;if(!e)return 0;let t;var i=this.SIN_TABLE.length;return t=0<e?2*Math.PI*this.reverseSinTableLookup(e,0,i/4,!1)/i:Math.PI-2*Math.PI*this.reverseSinTableLookup(e,i/2,.75*i,!0)/i,t}static acos(e){return Math.PI/2-this.asin(e)}static atan2(e,t){if(Number.isNaN(t)||Number.isNaN(e))return NaN;let i;return i=Number.isFinite(e)||Number.isFinite(t)?Number.isFinite(t)&&0!==e?Number.isFinite(e)&&0!==t?this.atan2FiniteNonZero(e,t):this.signIncZero(e)*Math.PI*.5:this.signIncZero(e)*(this.signIncZero(t)<0?Math.PI:0):Math.sign(e)*Math.PI*(0<Math.sign(t)?.25:.75),i}static atan2FiniteNonZero(e,t){var i=Math.abs(t),r=Math.abs(e),s=Math.min(i,r)/Math.max(i,r),a=s*s;let n=((-.0464964749*a+.15931422)*a-.327622764)*a*s+s;return i<r&&(n=Math.PI/2-n),t<0&&(n=Math.PI-n),e<0&&(n=-n),n}static signIncZero(e){return e===-1/0||1/e<0?-1:1}}),i.PRECISION=6,i.EXP_10_PRECISION=10**i.PRECISION,i.SIN_TABLE=[0,.004848117819001859,.009696121685978396,.014543897651582654,.01939133177182437,.024238310110748135,.0290847187431114,.03393044375706223,.03877537125681671,.043619387365336,.04846237822700296,.05330423001029823,.05814482891047582,.06298406115223795,.06782181299240934,.0726579707226106,.07749242067193093,.08232504920959989,.08715574274765817,.09198438774362744,.09681087070317909,.10163507818280187,.10645689679246824,.11127621319829964,.11609291412523022,.12090688635966935,.12571801675216268,.13052619222005157,.13533129975013108,.14013322640130627,.14493185930724672,.1497270856790396,.15451879280784048,.15930686806752256,.16409119891732396,.1688716729044928,.17364817766693033,.17842060093583212,.18318883053832663,.18795275440011186,.19271226054808968,.19746723711299752,.20221757233203794,.20696315455150538,.2117038722294107,.21643961393810288,.22117026836688775,.2258957243246448,.23061587074244014,.2353305966761376,.24003979130900588,.2447433439543238,.24944114405798126,.25413308120107847,.25881904510252074,.26349892562161076,.2681726127606373,.272839996667461,.27750096763809573,.28215541611928774,.2868032327110902,.29144430816943495,.2960785334086999,.3007057995042731,.3053259976951131,.30993901938630514,.31454475615161365,.31914309973603083,.323733942058321,.328317175213561,.33289269147567657,.3374603832999741,.3420201433256687,.34657186437840753,.3511154394727888,.3556507618148765,.3601777248047104,.36469622203881186,.3692061473126844,.3737073946233105,.3781998581716425,.3826834323650898,.3871580118200006,.3916234913641391,.3960797660391568,.4005267311030606,.4049642820326736,.4093923145260926,.4138107245051391,.4182194081178064,.42261826174069944,.4270071819814715,.4313860656812534,.4357548099170794,.4401133120043048,.44446146949902104,.4487991802004621,.4531263421534082,.4574428536505808,.4617486132350339,.46604351970253877,.4703274721039625,.4746003697476404,.4788621122017435,.4831125992966384,.48735173112724234,.49157940805537054,.49579553071207916,.49999999999999994,.5041927170956704,.5083735834518556,.5125425007998652,.5166993711518628,.5208440968031697,.5249765803345602,.5290967246145525,.5332044328016912,.5372996083468239,.5413821549953696,.5454519767895825,.549508978070806,.5535530634817223,.5575841379685927,.5616021067834929,.5656068754865385,.5695983499481065,.573576436351046,.5775410411928851,.5814920712880266,.5854294337699405,.5893530360933448,.593262786036382,.5971585917027862,.6010403615240428,.6049080042615417,.6087614290087207,.6126005451932028,.6164252625789254,.62023549126826,.6240311417041269,.6278121246720986,.6315783513024975,.6353297330724851,.6390661818081416,.6427876096865393,.6464939292378065,.6501850533471834,.6538608952570697,.6575213685690636,.6611663872459932,.6647958656139378,.6684097183642425,.6720078605555224,.6755902076156601,.6791566753437932,.6827071799122926,.6862416378687335,.6897599661378576,.6932620820235242,.696747903210655,.7002173477671685,.7036703341459059,.7071067811865475,.710526608117521,.713929734557899,.7173160805192894,.7206855664077146,.7240381130254825,.7273736415730487,.7306920736508674,.7339933312612352,.7372773368101241,.7405440131090046,.7437932833766612,.747025071240996,.7502393007408245,.7534358963276606,.7566147828674927,.7597758856425494,.7629191303530553,.766044443118978,.7691517504817651,.7722409794060692,.7753120572814658,.7783649119241599,.7813994715786823,.7844156649195757,.7874134210530723,.7903926695187593,.7933533402912352,.7962953637817558,.7992186708398696,.8021231927550437,.8050088612582783,.8078756085237111,.8107233671702122,.8135520702629676,.8163616513150519,.8191520442889918,.821923183598318,.8246750041091067,.8274074411415104,.8301204304712788,.8328139083312671,.8354878114129364,.8381420768678404,.8407766423091032,.8433914458128856,.845986425919841,.848561521636559,.8511166724369997,.8536518182639162,.8561668995302665,.8586618571206132,.8611366323925137,.8635911671778986,.8660254037844386,.8684392849969005,.870832754078492,.8732057547721958,.8755582313020908,.8778901283746645,.8802013911801111,.8824919653936212,.8847617971766577,.8870108331782216,.8892390205361062,.8914463068781385,.8936326403234122,.8957979694835052,.8979422434636881,.9000654118641211,.9021674247810376,.9042482328079179,.9063077870366499,.9083460390586793,.9103629409661466,.9123584453530141,.9143325053161794,.9162850744565779,.918216106880274,.9201255571995389,.9220133805339185,.9238795325112867,.9257239692688903,.9275466474543786,.9293475242268224,.9311265572577219,.9328837047320004,.9346189253489884,.9363321783233931,.9380234233862578,.9396926207859083,.9413397312888874,.942964716180876,.9445675372676047,.9461481568757504,.947706537853822,.9492426435730339,.9507564379281666,.9522478853384153,.9537169507482269,.955163599628123,.9565877979755122,.9579895123154889,.9593687097016201,.9607253577167205,.9620594244736131,.9633708786158803,.9646596893185995,.9659258262890683,.9671692597675166,.9683899605278059,.969587899878116,.97076304966162,.9719153822571454,.9730448705798238,.9741514880817275,.9752352087524931,.9762960071199334,.9773338582506355,.9783487377505475,.9793406217655515,.980309486982024,.9812553106273847,.9821780704706308,.98307774482286,.9839543125377807,.984807753012208,.9856380461865492,.9864451725452739,.987229113117374,.987989849476809,.9887273637429388,.9894416385809445,.9901326572022359,.9908004033648453,.9914448613738104,.9920660160815423,.9926638528881819,.993238357741943,.9937895171394426,.9943173181260184,.9948217482960331,.9953027957931658,.9957604493106914,.9961946980917455,.9966055319295779,.996992941167792,.9973569167005722,.9976974499728977,.9980145329807433,.9983081582712682,.9985783189429907,.9988250086459504,.9990482215818578,.99924795250423,.9994241967185149,.9995769500822006,.9997062090049132,.9998119704485015,.9998942319271075,.9999529915072262,.9999882478077495,1,.9999882478077495,.9999529915072262,.9998942319271075,.9998119704485015,.9997062090049132,.9995769500822006,.9994241967185149,.99924795250423,.9990482215818578,.9988250086459504,.9985783189429907,.9983081582712682,.9980145329807433,.9976974499728977,.9973569167005722,.996992941167792,.9966055319295779,.9961946980917455,.9957604493106914,.9953027957931658,.9948217482960331,.9943173181260184,.9937895171394426,.993238357741943,.9926638528881819,.9920660160815423,.9914448613738105,.9908004033648453,.9901326572022359,.9894416385809446,.9887273637429388,.987989849476809,.987229113117374,.9864451725452739,.9856380461865492,.984807753012208,.9839543125377807,.98307774482286,.9821780704706307,.9812553106273847,.9803094869820241,.9793406217655516,.9783487377505476,.9773338582506356,.9762960071199334,.9752352087524931,.9741514880817276,.9730448705798238,.9719153822571455,.9707630496616201,.969587899878116,.9683899605278059,.9671692597675166,.9659258262890683,.9646596893185995,.9633708786158803,.9620594244736133,.9607253577167205,.9593687097016202,.9579895123154889,.9565877979755123,.9551635996281231,.9537169507482269,.9522478853384153,.9507564379281666,.949242643573034,.9477065378538221,.9461481568757505,.9445675372676048,.942964716180876,.9413397312888873,.9396926207859084,.9380234233862579,.9363321783233931,.9346189253489885,.9328837047320006,.9311265572577219,.9293475242268225,.9275466474543786,.9257239692688904,.9238795325112867,.9220133805339185,.920125557199539,.918216106880274,.916285074456578,.9143325053161794,.9123584453530141,.9103629409661467,.9083460390586793,.90630778703665,.904248232807918,.9021674247810377,.9000654118641213,.8979422434636883,.8957979694835051,.8936326403234123,.8914463068781386,.8892390205361062,.8870108331782218,.8847617971766579,.8824919653936212,.8802013911801111,.8778901283746644,.8755582313020909,.8732057547721958,.8708327540784921,.8684392849969006,.8660254037844387,.8635911671778987,.8611366323925138,.858661857120613,.8561668995302665,.8536518182639163,.8511166724369997,.8485615216365591,.8459864259198412,.8433914458128856,.8407766423091031,.8381420768678404,.8354878114129364,.8328139083312672,.8301204304712789,.8274074411415107,.8246750041091069,.8219231835983182,.819152044288992,.8163616513150518,.8135520702629675,.8107233671702123,.8078756085237112,.8050088612582784,.802123192755044,.7992186708398695,.7962953637817556,.7933533402912352,.7903926695187593,.7874134210530723,.7844156649195758,.7813994715786824,.7783649119241601,.775312057281466,.7722409794060693,.769151750481765,.766044443118978,.7629191303530551,.7597758856425494,.756614782867493,.7534358963276608,.7502393007408243,.7470250712409959,.7437932833766611,.7405440131090045,.7372773368101241,.7339933312612353,.7306920736508675,.7273736415730488,.7240381130254827,.7206855664077148,.7173160805192896,.713929734557899,.710526608117521,.7071067811865476,.703670334145906,.7002173477671687,.6967479032106549,.6932620820235241,.6897599661378576,.6862416378687336,.6827071799122926,.6791566753437933,.6755902076156604,.6720078605555225,.6684097183642426,.6647958656139381,.6611663872459935,.6575213685690636,.6538608952570697,.6501850533471835,.6464939292378067,.6427876096865395,.6390661818081418,.635329733072485,.6315783513024975,.6278121246720986,.6240311417041269,.6202354912682602,.6164252625789255,.612600545193203,.6087614290087209,.6049080042615419,.6010403615240432,.5971585917027862,.593262786036382,.5893530360933449,.5854294337699406,.5814920712880268,.5775410411928852,.5735764363510459,.5695983499481064,.5656068754865385,.5616021067834929,.5575841379685929,.5535530634817224,.5495089780708062,.5454519767895827,.5413821549953699,.5372996083468241,.5332044328016912,.5290967246145525,.5249765803345602,.5208440968031698,.516699371151863,.5125425007998654,.5083735834518555,.5041927170956703,.49999999999999994,.49579553071207916,.49157940805537065,.48735173112724245,.48311259929663863,.4788621122017437,.47460036974764064,.47032747210396275,.46604351970253877,.4617486132350339,.45744285365058085,.4531263421534083,.44879918020046233,.4444614694990212,.4401133120043047,.43575480991707927,.43138606568125343,.4270071819814714,.4226182617406995,.4182194081178065,.4138107245051393,.40939231452609276,.4049642820326738,.40052673110306086,.3960797660391572,.39162349136413904,.38715801182000065,.3826834323650899,.37819985817164264,.3737073946233107,.3692061473126843,.36469622203881175,.3601777248047104,.3556507618148765,.35111543947278884,.34657186437840765,.3420201433256689,.3374603832999743,.33289269147567685,.32831717521356135,.3237339420583214,.31914309973603083,.3145447561516137,.30993901938630525,.30532599769511326,.30070579950427334,.29607853340870016,.2914443081694349,.2868032327110902,.28215541611928774,.2775009676380958,.2728399966674611,.26817261276063753,.263498925621611,.258819045102521,.2541330812010788,.24944114405798165,.24474334395432376,.24003979130900596,.2353305966761377,.23061587074244033,.225895724324645,.22117026836688802,.21643961393810274,.21170387222941067,.20696315455150538,.20221757233203796,.19746723711299763,.19271226054808982,.18795275440011205,.18318883053832688,.17842060093583242,.17364817766693072,.16887167290449276,.16409119891732402,.15930686806752267,.15451879280784062,.1497270856790398,.14493185930724697,.14013322640130613,.135331299750131,.13052619222005157,.12571801675216274,.12090688635966945,.11609291412523036,.11127621319829985,.1064568967924685,.10163507818280217,.09681087070317945,.09198438774362741,.0871557427476582,.08232504920959997,.07749242067193107,.07265797072261079,.0678218129924096,.06298406115223781,.05814482891047573,.0533042300102982,.04846237822700297,.04361938736533607,.038775371256816835,.03393044375706242,.029084718743111644,.02423831011074843,.01939133177182472,.014543897651583058,.009696121685978408,.004848117819001927,12246467991473532e-32,-.004848117819001238,-.009696121685978163,-.01454389765158237,-.019391331771824474,-.02423831011074774,-.029084718743111398,-.03393044375706173,-.03877537125681659,-.04361938736533583,-.048462378227003174,-.05330423001029795,-.05814482891047593,-.06298406115223758,-.06782181299240934,-.07265797072261056,-.07749242067193128,-.08232504920959974,-.08715574274765794,-.09198438774362716,-.09681087070317876,-.10163507818280193,-.10645689679246781,-.1112762131982996,-.11609291412523012,-.12090688635966965,-.1257180167521625,-.13052619222005177,-.13533129975013078,-.14013322640130632,-.14493185930724675,-.14972708567904,-.1545187928078404,-.15930686806752198,-.16409119891732377,-.16887167290449254,-.17364817766693047,-.17842060093583176,-.18318883053832663,-.1879527544001114,-.1927122605480896,-.19746723711299738,-.20221757233203816,-.20696315455150513,-.21170387222941087,-.21643961393810252,-.2211702683668878,-.22589572432464475,-.23061587074244053,-.23533059667613745,-.2400397913090053,-.2447433439543235,-.24944114405798098,-.2541330812010786,-.25881904510252035,-.2634989256216107,-.26817261276063686,-.2728399966674609,-.27750096763809556,-.2821554161192879,-.28680323271108993,-.29144430816943506,-.29607853340869994,-.30070579950427306,-.30532599769511304,-.3099390193863046,-.3145447561516135,-.3191430997360306,-.3237339420583211,-.3283171752135607,-.33289269147567657,-.3374603832999737,-.34202014332566866,-.3465718643784074,-.35111543947278906,-.35565076181487626,-.36017772480471055,-.3646962220388115,-.3692061473126845,-.3737073946233105,-.3781998581716428,-.38268343236508967,-.38715801182000004,-.3916234913641388,-.39607976603915657,-.40052673110306064,-.4049642820326732,-.40939231452609254,-.41381072450513867,-.4182194081178062,-.4226182617406993,-.4270071819814716,-.4313860656812532,-.43575480991707943,-.4401133120043045,-.444461469499021,-.4487991802004621,-.4531263421534085,-.4574428536505806,-.46174861323503374,-.46604351970253854,-.47032747210396214,-.4746003697476404,-.47886211220174313,-.4831125992966384,-.4873517311272422,-.4915794080553708,-.49579553071207894,-.5000000000000001,-.50419271709567,-.5083735834518556,-.5125425007998652,-.5166993711518633,-.5208440968031696,-.5249765803345596,-.5290967246145523,-.533204432801691,-.5372996083468239,-.5413821549953693,-.5454519767895825,-.5495089780708056,-.5535530634817222,-.5575841379685926,-.5616021067834931,-.5656068754865384,-.5695983499481065,-.5735764363510458,-.577541041192885,-.5814920712880266,-.5854294337699408,-.5893530360933448,-.5932627860363815,-.597158591702786,-.6010403615240426,-.6049080042615417,-.6087614290087203,-.6126005451932028,-.6164252625789249,-.6202354912682599,-.6240311417041268,-.6278121246720987,-.6315783513024973,-.6353297330724852,-.6390661818081416,-.6427876096865393,-.6464939292378065,-.6501850533471829,-.6538608952570695,-.6575213685690635,-.6611663872459933,-.6647958656139376,-.6684097183642425,-.6720078605555221,-.6755902076156601,-.6791566753437931,-.6827071799122927,-.6862416378687334,-.6897599661378577,-.693262082023524,-.696747903210655,-.7002173477671685,-.7036703341459061,-.7071067811865475,-.7105266081175206,-.7139297345578989,-.7173160805192892,-.7206855664077146,-.7240381130254823,-.7273736415730487,-.7306920736508671,-.7339933312612352,-.737277336810124,-.7405440131090048,-.743793283376661,-.747025071240996,-.7502393007408242,-.7534358963276607,-.7566147828674927,-.7597758856425493,-.7629191303530554,-.7660444431189779,-.7691517504817651,-.7722409794060688,-.7753120572814659,-.7783649119241597,-.7813994715786822,-.7844156649195754,-.7874134210530722,-.7903926695187589,-.7933533402912349,-.7962953637817558,-.79921867083987,-.8021231927550437,-.8050088612582785,-.8078756085237111,-.8107233671702119,-.8135520702629674,-.8163616513150515,-.8191520442889916,-.8219231835983181,-.8246750041091064,-.8274074411415104,-.830120430471279,-.8328139083312671,-.8354878114129365,-.8381420768678401,-.8407766423091032,-.8433914458128855,-.8459864259198411,-.8485615216365587,-.8511166724369996,-.8536518182639165,-.8561668995302664,-.8586618571206132,-.8611366323925135,-.8635911671778986,-.8660254037844385,-.8684392849969005,-.8708327540784918,-.8732057547721956,-.8755582313020905,-.8778901283746643,-.8802013911801112,-.8824919653936215,-.8847617971766578,-.8870108331782218,-.889239020536106,-.8914463068781383,-.8936326403234122,-.8957979694835049,-.897942243463688,-.9000654118641208,-.9021674247810375,-.9042482328079179,-.90630778703665,-.9083460390586792,-.9103629409661468,-.912358445353014,-.9143325053161795,-.9162850744565778,-.918216106880274,-.9201255571995388,-.9220133805339183,-.9238795325112865,-.9257239692688903,-.9275466474543786,-.9293475242268223,-.9311265572577219,-.9328837047320003,-.9346189253489884,-.9363321783233929,-.9380234233862578,-.9396926207859082,-.9413397312888873,-.9429647161808761,-.9445675372676049,-.9461481568757504,-.9477065378538222,-.9492426435730339,-.9507564379281666,-.9522478853384153,-.9537169507482267,-.9551635996281229,-.956587797975512,-.9579895123154888,-.9593687097016201,-.9607253577167205,-.9620594244736131,-.9633708786158804,-.9646596893185994,-.9659258262890683,-.9671692597675166,-.9683899605278059,-.9695878998781159,-.97076304966162,-.9719153822571452,-.9730448705798238,-.9741514880817276,-.975235208752493,-.9762960071199334,-.9773338582506355,-.9783487377505475,-.9793406217655514,-.980309486982024,-.9812553106273846,-.9821780704706307,-.98307774482286,-.9839543125377805,-.984807753012208,-.9856380461865493,-.9864451725452739,-.9872291131173742,-.9879898494768089,-.9887273637429387,-.9894416385809445,-.9901326572022358,-.9908004033648452,-.9914448613738104,-.9920660160815423,-.9926638528881818,-.993238357741943,-.9937895171394426,-.9943173181260184,-.994821748296033,-.9953027957931658,-.9957604493106913,-.9961946980917455,-.9966055319295779,-.996992941167792,-.9973569167005722,-.9976974499728977,-.9980145329807433,-.9983081582712682,-.9985783189429907,-.9988250086459504,-.9990482215818578,-.99924795250423,-.9994241967185149,-.9995769500822006,-.9997062090049132,-.9998119704485015,-.9998942319271076,-.9999529915072262,-.9999882478077495,-1,-.9999882478077495,-.9999529915072262,-.9998942319271076,-.9998119704485015,-.9997062090049132,-.9995769500822006,-.9994241967185149,-.99924795250423,-.9990482215818578,-.9988250086459504,-.9985783189429907,-.9983081582712682,-.9980145329807433,-.9976974499728977,-.9973569167005724,-.996992941167792,-.9966055319295779,-.9961946980917455,-.9957604493106914,-.9953027957931658,-.9948217482960331,-.9943173181260185,-.9937895171394426,-.993238357741943,-.9926638528881819,-.9920660160815424,-.9914448613738105,-.9908004033648453,-.9901326572022358,-.9894416385809446,-.9887273637429387,-.987989849476809,-.9872291131173742,-.986445172545274,-.9856380461865493,-.9848077530122081,-.9839543125377807,-.9830777448228601,-.9821780704706308,-.9812553106273846,-.9803094869820241,-.9793406217655515,-.9783487377505476,-.9773338582506355,-.9762960071199335,-.9752352087524931,-.9741514880817276,-.9730448705798239,-.9719153822571454,-.9707630496616201,-.969587899878116,-.968389960527806,-.9671692597675167,-.9659258262890684,-.9646596893185995,-.9633708786158806,-.9620594244736133,-.9607253577167206,-.9593687097016202,-.9579895123154889,-.9565877979755121,-.955163599628123,-.9537169507482268,-.9522478853384154,-.9507564379281668,-.949242643573034,-.9477065378538223,-.9461481568757506,-.944567537267605,-.9429647161808762,-.9413397312888874,-.9396926207859083,-.9380234233862579,-.936332178323393,-.9346189253489885,-.9328837047320004,-.9311265572577221,-.9293475242268224,-.9275466474543788,-.9257239692688904,-.9238795325112866,-.9220133805339186,-.9201255571995389,-.9182161068802742,-.9162850744565779,-.9143325053161796,-.9123584453530141,-.9103629409661469,-.9083460390586794,-.9063077870366503,-.9042482328079181,-.9021674247810376,-.9000654118641209,-.8979422434636882,-.895797969483505,-.8936326403234123,-.8914463068781384,-.8892390205361063,-.887010833178222,-.8847617971766579,-.8824919653936216,-.8802013911801113,-.8778901283746645,-.8755582313020907,-.8732057547721959,-.870832754078492,-.8684392849969007,-.8660254037844386,-.8635911671778989,-.8611366323925137,-.8586618571206134,-.8561668995302666,-.8536518182639167,-.8511166724369998,-.848561521636559,-.8459864259198413,-.8433914458128857,-.8407766423091034,-.8381420768678404,-.8354878114129367,-.8328139083312672,-.8301204304712791,-.8274074411415107,-.8246750041091067,-.8219231835983183,-.8191520442889918,-.8163616513150517,-.8135520702629676,-.8107233671702121,-.8078756085237113,-.8050088612582788,-.802123192755044,-.7992186708398701,-.796295363781756,-.7933533402912352,-.7903926695187591,-.7874134210530724,-.7844156649195756,-.7813994715786825,-.7783649119241599,-.7753120572814661,-.7722409794060691,-.7691517504817653,-.7660444431189781,-.7629191303530556,-.7597758856425495,-.7566147828674927,-.753435896327661,-.7502393007408246,-.7470250712409963,-.7437932833766612,-.740544013109005,-.7372773368101242,-.7339933312612357,-.7306920736508676,-.7273736415730492,-.7240381130254828,-.7206855664077145,-.7173160805192891,-.7139297345578991,-.7105266081175208,-.7071067811865477,-.7036703341459063,-.7002173477671687,-.6967479032106556,-.6932620820235246,-.6897599661378577,-.6862416378687334,-.6827071799122926,-.679156675343793,-.6755902076156605,-.6720078605555223,-.6684097183642427,-.6647958656139378,-.6611663872459935,-.6575213685690637,-.6538608952570701,-.6501850533471836,-.6464939292378064,-.6427876096865396,-.6390661818081416,-.6353297330724854,-.6315783513024976,-.627812124672099,-.624031141704127,-.6202354912682606,-.6164252625789255,-.6126005451932034,-.6087614290087209,-.6049080042615417,-.6010403615240425,-.5971585917027863,-.5932627860363818,-.589353036093345,-.585429433769941,-.5814920712880269,-.5775410411928856,-.5735764363510465,-.5695983499481065,-.5656068754865391,-.561602106783493,-.5575841379685926,-.5535530634817225,-.5495089780708059,-.5454519767895828,-.5413821549953696,-.5372996083468242,-.5332044328016913,-.5290967246145529,-.5249765803345603,-.5208440968031696,-.5166993711518632,-.5125425007998651,-.5083735834518559,-.5041927170956704,-.5000000000000004,-.49579553071207927,-.49157940805537115,-.48735173112724256,-.48311259929663913,-.4788621122017438,-.47460036974764036,-.4703274721039621,-.4660435197025389,-.46174861323503363,-.45744285365058096,-.4531263421534088,-.44879918020046244,-.4444614694990217,-.4401133120043052,-.43575480991708015,-.4313860656812539,-.42700718198147153,-.4226182617406992,-.4182194081178066,-.413810724505139,-.40939231452609287,-.40496428203267354,-.400526731103061,-.3960797660391569,-.39162349136413954,-.38715801182000076,-.3826834323650904,-.37819985817164276,-.3737073946233104,-.3692061473126848,-.36469622203881186,-.3601777248047109,-.3556507618148766,-.3511154394727894,-.34657186437840776,-.34202014332566943,-.3374603832999744,-.3328926914756765,-.32831717521356063,-.32373394205832107,-.31914309973603056,-.3145447561516138,-.3099390193863049,-.30532599769511337,-.30070579950427384,-.2960785334087003,-.29144430816943584,-.2868032327110907,-.28215541611928785,-.2775009676380955,-.2728399966674612,-.2681726127606372,-.2634989256216111,-.2588190451025207,-.2541330812010789,-.24944114405798135,-.24474334395432432,-.24003979130900607,-.23533059667613823,-.23061587074244044,-.2258957243246447,-.22117026836688813,-.21643961393810288,-.21170387222941123,-.2069631545515055,-.20221757233203852,-.19746723711299774,-.19271226054809037,-.1879527544001122,-.18318883053832655,-.17842060093583256,-.1736481776669304,-.16887167290449245,-.16409119891732413,-.15930686806752234,-.15451879280784075,-.14972708567904036,-.1449318593072471,-.14013322640130713,-.13533129975013158,-.13052619222005168,-.1257180167521624,-.12090688635966958,-.11609291412523004,-.11127621319829996,-.10645689679246818,-.10163507818280229,-.09681087070317913,-.09198438774362797,-.08715574274765832,-.08232504920960054,-.0774924206719312,-.07265797072261047,-.06782181299240972,-.06298406115223794,-.0581448289104763,-.05330423001029832,-.04846237822700354,-.043619387365336194,-.038775371256817404,-.03393044375706254,-.02908471874311221,-.02423831011074855,-.019391331771824397,-.014543897651582293,-.009696121685978531,-.004848117819001606]}}}),System.register("game/math/Vector2",["game/math/GameMath"],function(e,t){"use strict";var n,i;t&&t.id;return{setters:[function(e){n=e}],execute:function(){i=class extends THREE.Vector2{length(){return n.GameMath.sqrt(this.x*this.x+this.y*this.y)}angle(){let e=n.GameMath.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e}distanceTo(e){return n.GameMath.sqrt(this.distanceToSquared(e))}rotateAround(e,t){var i=n.GameMath.cos(t),r=n.GameMath.sin(t),s=this.x-e.x,a=this.y-e.y;return this.x=s*i-a*r+e.x,this.y=s*r+a*i+e.y,this}},e("Vector2",i)}}}),System.register("game/math/Cylindrical",["game/math/GameMath"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends THREE.Cylindrical{setFromVector3(e){return this.radius=i.GameMath.sqrt(e.x*e.x+e.z*e.z),this.theta=i.GameMath.atan2(e.x,e.z),this.y=e.y,this}},e("Cylindrical",r)}}}),System.register("game/math/Quaternion",["game/math/GameMath"],function(e,t){"use strict";var g,i;t&&t.id;return{setters:[function(e){g=e}],execute:function(){i=class extends THREE.Quaternion{setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var i=e.x,r=e.y,s=e.z,a=e.order,n=g.GameMath.cos(i/2),o=g.GameMath.cos(r/2),l=g.GameMath.cos(s/2),i=g.GameMath.sin(i/2),r=g.GameMath.sin(r/2),s=g.GameMath.sin(s/2);return"XYZ"===a?(this._x=i*o*l+n*r*s,this._y=n*r*l-i*o*s,this._z=n*o*s+i*r*l,this._w=n*o*l-i*r*s):"YXZ"===a?(this._x=i*o*l+n*r*s,this._y=n*r*l-i*o*s,this._z=n*o*s-i*r*l,this._w=n*o*l+i*r*s):"ZXY"===a?(this._x=i*o*l-n*r*s,this._y=n*r*l+i*o*s,this._z=n*o*s+i*r*l,this._w=n*o*l-i*r*s):"ZYX"===a?(this._x=i*o*l-n*r*s,this._y=n*r*l+i*o*s,this._z=n*o*s-i*r*l,this._w=n*o*l+i*r*s):"YZX"===a?(this._x=i*o*l+n*r*s,this._y=n*r*l+i*o*s,this._z=n*o*s-i*r*l,this._w=n*o*l-i*r*s):"XZY"===a&&(this._x=i*o*l-n*r*s,this._y=n*r*l-i*o*s,this._z=n*o*s+i*r*l,this._w=n*o*l+i*r*s),!1!==t&&this.onChangeCallback(),this}setFromAxisAngle(e,t){var i=t/2,r=g.GameMath.sin(i);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=g.GameMath.cos(i),this.onChangeCallback(),this}setFromRotationMatrix(e){let t=e.elements,i=t[0],r=t[4],s=t[8],a=t[1],n=t[5],o=t[9],l=t[2],c=t[6],h=t[10],u=i+n+h,d;return 0<u?(d=.5/g.GameMath.sqrt(u+1),this._w=.25/d,this._x=(c-o)*d,this._y=(s-l)*d,this._z=(a-r)*d):n<i&&h<i?(d=2*g.GameMath.sqrt(1+i-n-h),this._w=(c-o)/d,this._x=.25*d,this._y=(r+a)/d,this._z=(s+l)/d):h<n?(d=2*g.GameMath.sqrt(1+n-i-h),this._w=(s-l)/d,this._x=(r+a)/d,this._y=.25*d,this._z=(o+c)/d):(d=2*g.GameMath.sqrt(1+h-i-n),this._w=(a-r)/d,this._x=(s+l)/d,this._y=(o+c)/d,this._z=.25*d),this.onChangeCallback(),this}length(){return g.GameMath.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);var i=this._x,r=this._y,s=this._z,a=this._w;let n=a*e._w+i*e._x+r*e._y+s*e._z;if(n<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,n=-n):this.copy(e),1<=n)return this._w=a,this._x=i,this._y=r,this._z=s,this;var o=1-n*n;if(o<=Number.EPSILON){var l=1-t;return this._w=l*a+t*this._w,this._x=l*i+t*this._x,this._y=l*r+t*this._y,this._z=l*s+t*this._z,this.normalize()}var c=g.GameMath.sqrt(o),l=g.GameMath.atan2(c,n),o=g.GameMath.sin((1-t)*l)/c,c=g.GameMath.sin(t*l)/c;return this._w=a*o+this._w*c,this._x=i*o+this._x*c,this._y=r*o+this._y*c,this._z=s*o+this._z*c,this.onChangeCallback(),this}},e("Quaternion",i)}}}),System.register("game/math/Matrix4",["game/math/GameMath","game/math/Vector3"],function(e,t){"use strict";var b,i,r,c,s,a,n,h;t&&t.id;return{setters:[function(e){b=e},function(e){i=e}],execute:function(){r=class extends THREE.Matrix4{extractRotation(e){let t=this.elements;var i=e.elements,r=1/c.setFromMatrixColumn(e,0).length(),s=1/c.setFromMatrixColumn(e,1).length(),a=1/c.setFromMatrixColumn(e,2).length();return t[0]=i[0]*r,t[1]=i[1]*r,t[2]=i[2]*r,t[3]=0,t[4]=i[4]*s,t[5]=i[5]*s,t[6]=i[6]*s,t[7]=0,t[8]=i[8]*a,t[9]=i[9]*a,t[10]=i[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");let t=this.elements;var i,r,s,a,n,o,l,c,h,u,d,g,p=e.x,m=e.y,f=e.z,y=b.GameMath.cos(p),T=b.GameMath.sin(p),v=b.GameMath.cos(m),p=b.GameMath.sin(m),m=b.GameMath.cos(f),f=b.GameMath.sin(f);return"XYZ"===e.order?(r=y*m,a=y*f,s=T*m,i=T*f,t[0]=v*m,t[4]=-v*f,t[8]=p,t[1]=a+s*p,t[5]=r-i*p,t[9]=-T*v,t[2]=i-r*p,t[6]=s+a*p,t[10]=y*v):"YXZ"===e.order?(i=v*m,r=v*f,s=p*m,a=p*f,t[0]=i+a*T,t[4]=s*T-r,t[8]=y*p,t[1]=y*f,t[5]=y*m,t[9]=-T,t[2]=r*T-s,t[6]=a+i*T,t[10]=y*v):"ZXY"===e.order?(c=v*m,n=v*f,o=p*m,l=p*f,t[0]=c-l*T,t[4]=-y*f,t[8]=o+n*T,t[1]=n+o*T,t[5]=y*m,t[9]=l-c*T,t[2]=-y*p,t[6]=T,t[10]=y*v):"ZYX"===e.order?(n=y*m,o=y*f,l=T*m,c=T*f,t[0]=v*m,t[4]=l*p-o,t[8]=n*p+c,t[1]=v*f,t[5]=c*p+n,t[9]=o*p-l,t[2]=-p,t[6]=T*v,t[10]=y*v):"YZX"===e.order?(d=y*v,h=y*p,u=T*v,g=T*p,t[0]=v*m,t[4]=g-d*f,t[8]=u*f+h,t[1]=f,t[5]=y*m,t[9]=-T*m,t[2]=-p*m,t[6]=h*f+u,t[10]=d-g*f):"XZY"===e.order&&(h=y*v,u=y*p,d=T*v,g=T*p,t[0]=v*m,t[4]=-f,t[8]=p*m,t[1]=h*f+g,t[5]=y*m,t[9]=u*f-d,t[2]=d*f-u,t[6]=T*m,t[10]=g*f+h),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}lookAt(e,t,i){s.set(0,0,0),a.set(0,0,0),n.set(0,0,0);const r=this.elements;return n.subVectors(e,t),0===n.lengthSq()&&(n.z=1),n.normalize(),s.crossVectors(i,n),0===s.lengthSq()&&(1===Math.abs(i.z)?n.x+=1e-4:n.z+=1e-4,n.normalize(),s.crossVectors(i,n)),s.normalize(),a.crossVectors(n,s),r[0]=s.x,r[4]=a.x,r[8]=n.x,r[1]=s.y,r[5]=a.y,r[9]=n.y,r[2]=s.z,r[6]=a.z,r[10]=n.z,this}getMaxScaleOnAxis(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return b.GameMath.sqrt(Math.max(t,i,e))}makeRotationX(e){var t=b.GameMath.cos(e),i=b.GameMath.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){var t=b.GameMath.cos(e),i=b.GameMath.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){var t=b.GameMath.cos(e),i=b.GameMath.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){var i=b.GameMath.cos(t),r=b.GameMath.sin(t),s=1-i,a=e.x,n=e.y,o=e.z,l=s*a,c=s*n;return this.set(l*a+i,l*n-r*o,l*o+r*n,0,l*n+r*o,c*n+i,c*o-r*a,0,l*o-r*n,c*o+r*a,s*o*o+i,0,0,0,0,1),this}decompose(e,t,i){var r=this.elements;let s=c.set(r[0],r[1],r[2]).length();var a=c.set(r[4],r[5],r[6]).length(),n=c.set(r[8],r[9],r[10]).length();this.determinant()<0&&(s=-s),e.x=r[12],e.y=r[13],e.z=r[14],h.copy(this);var o=1/s,l=1/a,r=1/n;return h.elements[0]*=o,h.elements[1]*=o,h.elements[2]*=o,h.elements[4]*=l,h.elements[5]*=l,h.elements[6]*=l,h.elements[8]*=r,h.elements[9]*=r,h.elements[10]*=r,t.setFromRotationMatrix(h),i.x=s,i.y=a,i.z=n,this}},e("Matrix4",r),c=new i.Vector3,s=new i.Vector3,a=new i.Vector3,n=new i.Vector3,h=new r}}}),System.register("game/math/Euler",["util/math","game/math/GameMath","game/math/Quaternion","game/math/Vector3"],function(e,t){"use strict";var d,g,i,r,s,a;t&&t.id;return{setters:[function(e){d=e},function(e){g=e},function(e){i=e},function(e){r=e}],execute:function(){s=class extends THREE.Euler{constructor(){super(...arguments),this.isEuler=!0}setFromRotationMatrix(e,t,i){var r=e.elements,s=r[0],a=r[4],n=r[8],o=r[1],l=r[5],c=r[9],h=r[2],u=r[6],r=r[10];return"XYZ"===(t=t||this._order)?(this._y=g.GameMath.asin(d.clamp(n,-1,1)),Math.abs(n)<.99999?(this._x=g.GameMath.atan2(-c,r),this._z=g.GameMath.atan2(-a,s)):(this._x=g.GameMath.atan2(u,l),this._z=0)):"YXZ"===t?(this._x=g.GameMath.asin(-d.clamp(c,-1,1)),Math.abs(c)<.99999?(this._y=g.GameMath.atan2(n,r),this._z=g.GameMath.atan2(o,l)):(this._y=g.GameMath.atan2(-h,s),this._z=0)):"ZXY"===t?(this._x=g.GameMath.asin(d.clamp(u,-1,1)),Math.abs(u)<.99999?(this._y=g.GameMath.atan2(-h,r),this._z=g.GameMath.atan2(-a,l)):(this._y=0,this._z=g.GameMath.atan2(o,s))):"ZYX"===t?(this._y=g.GameMath.asin(-d.clamp(h,-1,1)),Math.abs(h)<.99999?(this._x=g.GameMath.atan2(u,r),this._z=g.GameMath.atan2(o,s)):(this._x=0,this._z=g.GameMath.atan2(-a,l))):"YZX"===t?(this._z=g.GameMath.asin(d.clamp(o,-1,1)),Math.abs(o)<.99999?(this._x=g.GameMath.atan2(-c,l),this._y=g.GameMath.atan2(-h,s)):(this._x=0,this._y=g.GameMath.atan2(n,r))):"XZY"===t?(this._z=g.GameMath.asin(-d.clamp(a,-1,1)),Math.abs(a)<.99999?(this._x=g.GameMath.atan2(u,l),this._y=g.GameMath.atan2(n,s)):(this._x=g.GameMath.atan2(-c,r),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==i&&this.onChangeCallback(),this}reorder(e){return a.setFromEuler(this),this.setFromQuaternion(a,e)}toVector3(e){return e?e.set(this._x,this._y,this._z):new r.Vector3(this._x,this._y,this._z)}},e("Euler",s),a=new i.Quaternion}}}),System.register("game/math/Spherical",["util/math","game/math/GameMath"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends THREE.Spherical{setFromVector3(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=r.GameMath.atan2(e.x,e.z),this.phi=r.GameMath.acos(i.clamp(e.y/this.radius,-1,1))),this}},e("Spherical",s)}}}),System.register("game/math/Vector3",["util/math","game/math/GameMath","game/math/Quaternion"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends THREE.Vector3{applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(n.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(n.setFromAxisAngle(e,t))}length(){return r.GameMath.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}projectOnPlane(e){return o.copy(this).projectOnVector(e),this.sub(o)}reflect(e){return this.sub(o.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){var t=this.dot(e)/r.GameMath.sqrt(this.lengthSq()*e.lengthSq());return r.GameMath.acos(i.clamp(t,-1,1))}distanceTo(e){return r.GameMath.sqrt(this.distanceToSquared(e))}setFromSpherical(e){var t=r.GameMath.sin(e.phi)*e.radius;return this.x=t*r.GameMath.sin(e.theta),this.y=r.GameMath.cos(e.phi)*e.radius,this.z=t*r.GameMath.cos(e.theta),this}setFromCylindrical(e){return this.x=e.radius*r.GameMath.sin(e.theta),this.y=e.y,this.z=e.radius*r.GameMath.cos(e.theta),this}},e("Vector3",a),n=new s.Quaternion,o=new a}}}),System.register("game/Coords",["game/math/GameMath","game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var i,r,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){a=e}],execute:function(){e("Coords",n=class n{static tileToWorld(e,t){return{x:e*n.LEPTONS_PER_TILE,y:t*n.LEPTONS_PER_TILE}}static vecWorldToGround(e){return new r.Vector2(e.x,e.z)}static vecGroundToWorld(e){return new a.Vector3(e.x,0,e.y)}static tileHeightToWorld(e){return e*(n.LEPTONS_PER_TILE/2)*n.zScale}static worldToTileHeight(e){return e/(n.LEPTONS_PER_TILE/2*n.zScale)}static tile3dToWorld(e,t,i){var r=n.tileToWorld(e,t),s=n.tileHeightToWorld(i);return new a.Vector3(r.x,s,r.y)}static screenDistanceToWorld(e,t){return{x:Math.floor((e+2*t)/2*n.ISO_WORLD_SCALE),y:Math.floor((2*t-e)/2*n.ISO_WORLD_SCALE)}}static getWorldTileSize(){return n.LEPTONS_PER_TILE}}),n.ISO_TILE_SIZE=30,n.LEPTONS_PER_TILE=256,n.ISO_WORLD_SCALE=n.LEPTONS_PER_TILE/n.ISO_TILE_SIZE,n.ISO_CAMERA_ALPHA=Math.PI/6,n.ISO_CAMERA_BETA=Math.PI/4,n.COS_ISO_CAMERA_BETA=i.GameMath.cos(n.ISO_CAMERA_BETA),n.zScale=n.COS_ISO_CAMERA_BETA/i.GameMath.cos(n.ISO_CAMERA_ALPHA)}}}),System.register("game/art/SequenceType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Ready=0]="Ready",e[e.Guard=1]="Guard",e[e.Prone=2]="Prone",e[e.Walk=3]="Walk",e[e.FireUp=4]="FireUp",e[e.Down=5]="Down",e[e.Crawl=6]="Crawl",e[e.Up=7]="Up",e[e.FireProne=8]="FireProne",e[e.Idle1=9]="Idle1",e[e.Idle2=10]="Idle2",e[e.Die1=11]="Die1",e[e.Die2=12]="Die2",e[e.Hover=13]="Hover",e[e.Fly=14]="Fly",e[e.FireFly=15]="FireFly",e[e.Tumble=16]="Tumble",e[e.AirDeathStart=17]="AirDeathStart",e[e.AirDeathFalling=18]="AirDeathFalling",e[e.AirDeathFinish=19]="AirDeathFinish",e[e.Tread=20]="Tread",e[e.Swim=21]="Swim",e[e.WetAttack=22]="WetAttack",e[e.WetIdle1=23]="WetIdle1",e[e.WetIdle2=24]="WetIdle2",e[e.WetDie1=25]="WetDie1",e[e.WetDie2=26]="WetDie2",e[e.Deploy=27]="Deploy",e[e.Deployed=28]="Deployed",e[e.DeployedFire=29]="DeployedFire",e[e.DeployedIdle=30]="DeployedIdle",e[e.Undeploy=31]="Undeploy",e[e.Paradrop=32]="Paradrop",e[e.Cheer=33]="Cheer",e[e.Panic=34]="Panic",t("SequenceType",i)}}}),System.register("game/art/SequenceReader",["game/art/SequenceType"],function(e,t){"use strict";var s,a,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){a=new Map([["E",5],["S",3],["W",1],["N",7]]),e("SequenceReader",i=class{readIni(e){let t=new Map;for(var[i,r]of e.entries){i=s.SequenceType[i];void 0!==i&&(r=r.split(","),r={type:i,startFrame:Number(r[0]),frameCount:Number(r[1]),facingMult:Number(r[2]),onlyFacing:r[3]?a.get(r[3]):void 0},t.set(i,r))}return t}})}}}),System.register("engine/type/LightingType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Global=1]="Global",e[e.Level=2]="Level",e[e.Ambient=3]="Ambient",e[e.Full=4]="Full",e[e.Default=5]="Default",t("LightingType",i)}}}),System.register("engine/type/TerrainType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Default=0]="Default",e[e.Tunnel=5]="Tunnel",e[e.Railroad=6]="Railroad",e[e.Rock1=7]="Rock1",e[e.Rock2=8]="Rock2",e[e.Water=9]="Water",e[e.Shore=10]="Shore",e[e.Pavement=11]="Pavement",e[e.Dirt=12]="Dirt",e[e.Clear=13]="Clear",e[e.Rough=14]="Rough",e[e.Cliff=15]="Cliff",t("TerrainType",i)}}}),System.register("game/type/LandType",["engine/type/TerrainType"],function(t,e){"use strict";var i,r,s;e&&e.id;return t("getLandType",function(e){if(!s.has(e))throw new Error("Unknown terrain type "+e);return s.get(e)}),{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.Clear=0]="Clear",e[e.Road=1]="Road",e[e.Rock=2]="Rock",e[e.Beach=3]="Beach",e[e.Rough=4]="Rough",e[e.Railroad=5]="Railroad",e[e.Weeds=6]="Weeds",e[e.Water=7]="Water",e[e.Wall=8]="Wall",e[e.Tiberium=9]="Tiberium",e[e.Cliff=10]="Cliff",t("LandType",r),s=new Map([[i.TerrainType.Default,r.Clear],[i.TerrainType.Clear,r.Clear],[i.TerrainType.Tunnel,r.Cliff],[i.TerrainType.Railroad,r.Railroad],[i.TerrainType.Rock1,r.Rock],[i.TerrainType.Rock2,r.Rock],[i.TerrainType.Water,r.Water],[i.TerrainType.Shore,r.Beach],[i.TerrainType.Pavement,r.Road],[i.TerrainType.Dirt,r.Road],[i.TerrainType.Rough,r.Rough],[i.TerrainType.Cliff,r.Cliff]])}}}),System.register("game/type/ArmorType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Flak=1]="Flak",e[e.Plate=2]="Plate",e[e.Light=3]="Light",e[e.Medium=4]="Medium",e[e.Heavy=5]="Heavy",e[e.Wood=6]="Wood",e[e.Steel=7]="Steel",e[e.Concrete=8]="Concrete",e[e.Special_1=9]="Special_1",e[e.Special_2=10]="Special_2",t("ArmorType",i)}}}),System.register("game/rules/OverlayRules",["game/type/LandType","game/rules/ObjectRules","game/type/ArmorType"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends r.ObjectRules{parse(){super.parse(),this.armor=this.ini.getEnum("Armor",s.ArmorType,s.ArmorType.None,!0),this.crate=this.ini.getBool("Crate");var e=this.ini.getBool("IsARock");this.isARock=e,this.isRubble=this.ini.getBool("IsRubble"),this.isVeinholeMonster=this.ini.getBool("IsVeinholeMonster"),this.isVeins=this.ini.getBool("IsVeins"),this.land=this.ini.getEnum("Land",i.LandType,i.LandType.Clear),this.noUseTileLandType=!!this.ini.getString("NoUseTileLandType"),this.strength=this.ini.getNumber("Strength"),this.tiberium=this.ini.getBool("Tiberium");var t=this.ini.getBool("Wall");this.wall=t,this.radarInvisible=this.ini.getBool("RadarInvisible",!t&&!e)}},e("OverlayRules",a)}}}),System.register("game/SideType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.GDI=0]="GDI",e[e.Nod=1]="Nod",e[e.Civilian=2]="Civilian",e[e.Mutant=3]="Mutant",t("SideType",i)}}}),System.register("game/rules/CountryRules",["game/SideType"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=(new Map).set("GDI",i.SideType.GDI).set("Nod",i.SideType.Nod).set("Civilian",i.SideType.Civilian).set("Mutant",i.SideType.Mutant),s=new Map([["Americans","STT:PlayerSideAmerica"],["Alliance","STT:PlayerSideKorea"],["French","STT:PlayerSideFrance"],["Germans","STT:PlayerSideGermany"],["British","STT:PlayerSideBritain"],["Africans","STT:PlayerSideLibya"],["Arabs","STT:PlayerSideIraq"],["Confederation","STT:PlayerSideCuba"],["Russians","STT:PlayerSideRussia"]]),e("CountryRules",a=class{constructor(e){this.id=e}readIni(e){this.name=e.name,this.uiName=e.getString("UIName"),this.uiTooltip=e.get("UITooltip")||s.get(this.name);var t=e.getString("Side");if(!t)throw new Error(`Missing Side for country "${this.name}"`);var i=r.get(t);if(void 0===i)throw new Error(`Unknown side "${t}" for country "${this.name}"`);this.side=i,this.multiplay=e.getBool("Multiplay"),this.multiplayPassive=e.getBool("MultiplayPassive"),this.veteranAircraft=e.getArray("VeteranAircraft"),this.veteranInfantry=e.getArray("VeteranInfantry"),this.veteranUnits=e.getArray("VeteranUnits")}})}}}),System.register("game/rules/WeaponRules",["game/rules/ObjectRules"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("WeaponRules",r=class{constructor(e){this.rules=e,this.parse()}parse(){this.ambientDamage=this.rules.getNumber("AmbientDamage"),this.anim=this.rules.getArray("Anim"),this.areaFire=this.rules.getBool("AreaFire"),this.burst=this.rules.getNumber("Burst",1),this.cellRangefinding=this.rules.getBool("CellRangefinding"),this.damage=this.rules.getNumber("Damage"),this.decloakToFire=this.rules.getBool("DecloakToFire",!0),this.fireOnce=this.rules.getBool("FireOnce"),this.isAlternateColor=this.rules.getBool("IsAlternateColor"),this.isElectricBolt=this.rules.getBool("IsElectricBolt"),this.isHouseColor=this.rules.getBool("IsHouseColor"),this.isLaser=this.rules.getBool("IsLaser"),this.isRadBeam=this.rules.getBool("IsRadBeam"),this.isSonic=this.rules.getBool("IsSonic"),this.laserDuration=this.rules.getNumber("LaserDuration"),this.limboLaunch=this.rules.getBool("LimboLaunch"),this.minimumRange=this.rules.getNumber("MinimumRange"),this.name=this.rules.name,this.neverUse=this.rules.getBool("NeverUse"),this.omniFire=this.rules.getBool("OmniFire"),this.projectile=this.rules.getString("Projectile"),this.radLevel=this.rules.getNumber("RadLevel"),this.range=this.rules.getNumber("Range"),-2===this.range&&(this.range=Number.POSITIVE_INFINITY),this.report=this.rules.getArray("Report"),this.revealOnFire=this.rules.getBool("RevealOnFire",!0),this.rof=this.rules.getNumber("ROF"),this.sabotageCursor=this.rules.getBool("SabotageCursor"),this.spawner=this.rules.getBool("Spawner");var e=this.rules.getNumber("Speed");this.iniSpeed=e,this.speed=i.ObjectRules.iniSpeedToLeptonsPerTick(e,100),this.suicide=this.rules.getBool("Suicide"),this.useSparkParticles=this.rules.getBool("UseSparkParticles"),this.warhead=this.rules.getString("Warhead")}})}}}),System.register("game/rules/AudioVisualRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("AudioVisualRules",i=class{readIni(e){this.ini=e,this.ambientChangeRate=e.getNumber("AmbientChangeRate"),this.ambientChangeStep=e.getNumber("AmbientChangeStep"),this.behind=e.getString("Behind"),this.bridgeExplosions=e.getArray("BridgeExplosions"),this.chronoBeamColor=e.getNumberArray("ChronoBeamColor"),this.chronoBlast=e.getString("ChronoBlast"),this.chronoBlastDest=e.getString("ChronoBlastDest"),this.chronoPlacement=e.getString("ChronoPlacement"),this.chronoSparkle1=e.getString("ChronoSparkle1"),this.conditionRed=e.getNumber("ConditionRed"),this.conditionYellow=e.getNumber("ConditionYellow"),this.creditTicks=e.getArray("CreditTicks"),this.extraAircraftLight=e.getNumber("ExtraAircraftLight"),this.extraInfantryLight=e.getNumber("ExtraInfantryLight"),this.extraUnitLight=e.getNumber("ExtraUnitLight");let t=e.getString("DamageFireTypes");t=t||"FIRE01,FIRE02,FIRE03",this.fireNames=t.split(/\.|,/).filter(e=>""!==e),this.flyerHelper=e.getString("FlyerHelper"),this.gravity=e.getNumber("Gravity"),this.idleActionFrequency=60*e.getNumber("IdleActionFrequency"),this.impactLandSound=e.getString("ImpactLandSound")||void 0,this.impactWaterSound=e.getString("ImpactWaterSound")||void 0,this.infantryExplode=e.getString("InfantryExplode"),this.flamingInfantry=e.getString("FlamingInfantry"),this.infantryHeadPop=e.getString("InfantryHeadPop"),this.infantryNuked=e.getString("InfantryNuked"),this.ironCurtainInvokeAnim=e.getString("IronCurtainInvokeAnim"),this.messageDuration=e.getNumber("MessageDuration",10),this.metallicDebris=e.getArray("MetallicDebris"),this.nukeTakeOff=e.getString("NukeTakeOff"),this.deadBodies=e.getArray("DeadBodies"),this.wake=e.getString("Wake"),this.parachute=e.getString("Parachute"),this.moveFlash=e.getString("MoveFlash"),this.warpOut=e.getString("WarpOut"),this.warpAway=e.getString("WarpAway"),this.weaponNullifyAnim=e.getString("WeaponNullifyAnim"),this.weatherConClouds=e.getArray("WeatherConClouds"),this.weatherConBoltExplosion=e.getString("WeatherConBoltExplosion"),this.weatherConBolts=e.getArray("WeatherConBolts")}})}}}),System.register("game/rules/general/RadarRules",[],function(t,e){"use strict";var i,r;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.GenericCombat=0]="GenericCombat",e[e.GenericNonCombat=1]="GenericNonCombat",e[e.DropZone=2]="DropZone",e[e.BaseUnderAttack=3]="BaseUnderAttack",e[e.HarvesterUnderAttack=4]="HarvesterUnderAttack",e[e.EnemyObjectSensed=5]="EnemyObjectSensed",t("RadarEventType",i),t("RadarRules",r=class{readIni(e){return this.eventSuppressionDistances=e.getNumberArray("RadarEventSuppressionDistances"),this.eventVisibilityDurations=e.getNumberArray("RadarEventVisibilityDurations"),this.eventDurations=e.getNumberArray("RadarEventDurations"),this.flashFrameTime=e.getNumber("FlashFrameTime"),this.combatFlashTime=e.getNumber("RadarCombatFlashTime"),this.eventMinRadius=e.getNumber("RadarEventMinRadius"),this.eventSpeed=e.getNumber("RadarEventSpeed"),this.eventRotationSpeed=e.getNumber("RadarEventRotationSpeed"),this.eventColorSpeed=e.getNumber("RadarEventColorSpeed"),this}getEventSuppresionDistance(e){if(e>this.eventSuppressionDistances.length-1)throw new RangeError("No event suppression distance is defined for type "+i[e]);return this.eventSuppressionDistances[e]}getEventVisibilityDuration(e){if(e>this.eventVisibilityDurations.length-1)throw new RangeError("No event visibility duration is defined for type "+i[e]);return this.eventVisibilityDurations[e]}getEventDuration(e){if(e>this.eventDurations.length-1)throw new RangeError("No event duration is defined for type "+i[e]);return this.eventDurations[e]}})}}}),System.register("game/rules/general/RepairRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RepairRules",i=class{readIni(e){return this.reloadRate=e.getNumber("ReloadRate"),this.repairPercent=e.getNumber("RepairPercent"),this.repairRate=e.getNumber("RepairRate"),this.repairStep=e.getNumber("RepairStep"),this.uRepairRate=e.getNumber("URepairRate"),this.iRepairRate=e.getNumber("IRepairRate"),this.iRepairStep=e.getNumber("IRepairStep"),this}})}}}),System.register("game/rules/general/VeteranRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("VeteranRules",i=class{readIni(e){return this.veteranRatio=e.getNumber("VeteranRatio",3),this.veteranCombat=e.getNumber("VeteranCombat",1),this.veteranSpeed=e.getNumber("VeteranSpeed",1),this.veteranSight=Math.max(1,e.getNumber("VeteranSight",1)),this.veteranArmor=e.getNumber("VeteranArmor",1),this.veteranROF=e.getNumber("VeteranROF",1),this.veteranCap=e.getNumber("VeteranCap",2),this.initialVeteran=e.getBool("InitialVeteran"),this}})}}}),System.register("game/rules/general/CrewRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CrewRules",i=class{readIni(e){return this.alliedCrew=e.getString("AlliedCrew"),this.alliedSurvivorDivisor=e.getNumber("AlliedSurvivorDivisor"),this.crewEscape=e.getNumber("CrewEscape"),this.sovietCrew=e.getString("SovietCrew"),this.sovietSurvivorDivisor=e.getNumber("SovietSurvivorDivisor"),this.survivorRate=e.getNumber("SurvivorRate"),this}})}}}),System.register("game/rules/general/PrismRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("PrismRules",i=class{readIni(e){return this.type=e.getString("PrismType"),this.supportHeight=e.getNumber("PrismSupportHeight"),this.supportMax=e.getNumber("PrismSupportMax"),this.supportModifier=e.getNumber("PrismSupportModifier",1),this}})}}}),System.register("game/rules/general/ThreatRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ThreatRules",i=class{readIni(e){return this.myEffectivenessCoefficientDefault=e.getNumber("MyEffectivenessCoefficientDefault"),this.targetEffectivenessCoefficientDefault=e.getNumber("TargetEffectivenessCoefficientDefault"),this.targetSpecialThreatCoefficientDefault=e.getNumber("TargetSpecialThreatCoefficientDefault"),this.targetStrengthCoefficientDefault=e.getNumber("TargetStrengthCoefficientDefault"),this.targetDistanceCoefficientDefault=e.getNumber("TargetDistanceCoefficientDefault"),this}})}}}),System.register("game/rules/general/ParadropRules",["game/SideType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ParadropRules",r=class{readIni(e){if(this.allyParaDrop=this.readParadropSquad(e.getArray("AllyParaDropInf"),e.getNumberArray("AllyParaDropNum"),"Ally"),this.amerParaDrop=this.readParadropSquad(e.getArray("AmerParaDropInf"),e.getNumberArray("AmerParaDropNum"),"Amer"),this.sovParaDrop=this.readParadropSquad(e.getArray("SovParaDropInf"),e.getNumberArray("SovParaDropNum"),"Sov"),this.paradropPlane=e.getString("ParadropPlane"),!this.paradropPlane)throw new Error("Missing rules [General]->ParadropPlane");return this.paradropRadius=e.getNumber("ParadropRadius"),this}readParadropSquad(e,t,i){if(e.length!==t.length)throw new RangeError(`${i}ParaDropInf/Num size mismatch (${e.length}, ${t.length})`);let r=[];for(let s=0;s<e.length;++s)0<t[s]&&r.push({inf:e[s],num:t[s]});return r}getParadropSquads(e){switch(e){case i.SideType.GDI:return this.allyParaDrop;case i.SideType.Nod:return this.sovParaDrop;default:throw new Error(`Unhandled side type "${e}"`)}}})}}}),System.register("game/rules/general/LightningStormRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("LightningStormRules",i=class{readIni(e){return this.deferment=e.getNumber("LightningDeferment"),this.damage=e.getNumber("LightningDamage"),this.duration=e.getNumber("LightningStormDuration"),this.warhead=e.getString("LightningWarhead"),this.hitDelay=e.getNumber("LightningHitDelay"),this.scatterDelay=e.getNumber("LightningScatterDelay"),this.cellSpread=e.getNumber("LightningCellSpread"),this.separation=e.getNumber("LightningSeparation"),this}})}}}),System.register("game/rules/general/MissileRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MissileRules",i=class{})}}}),System.register("game/rules/general/V3RocketRules",["game/rules/general/MissileRules"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.MissileRules{readIni(e){return this.pauseFrames=e.getNumber("V3RocketPauseFrames"),this.tiltFrames=e.getNumber("V3RocketTiltFrames"),this.pitchInitial=e.getNumber("V3RocketPitchInitial"),this.pitchFinal=e.getNumber("V3RocketPitchFinal"),this.turnRate=e.getNumber("V3RocketTurnRate"),this.acceleration=e.getNumber("V3RocketAcceleration"),this.altitude=e.getNumber("V3RocketAltitude"),this.damage=e.getNumber("V3RocketDamage"),this.eliteDamage=e.getNumber("V3RocketEliteDamage"),this.bodyLength=e.getNumber("V3RocketBodyLength"),this.lazyCurve=e.getBool("V3RocketLazyCurve"),this.type=e.getString("V3RocketType"),this}},e("V3RocketRules",r)}}}),System.register("game/rules/general/DMislRules",["game/rules/general/MissileRules"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.MissileRules{readIni(e){return this.pauseFrames=e.getNumber("DMislPauseFrames"),this.tiltFrames=e.getNumber("DMislTiltFrames"),this.pitchInitial=e.getNumber("DMislPitchInitial"),this.pitchFinal=e.getNumber("DMislPitchFinal"),this.turnRate=e.getNumber("DMislTurnRate"),this.acceleration=e.getNumber("DMislAcceleration"),this.altitude=e.getNumber("DMislAltitude"),this.damage=e.getNumber("DMislDamage"),this.eliteDamage=e.getNumber("DMislEliteDamage"),this.bodyLength=e.getNumber("DMislBodyLength"),this.lazyCurve=e.getBool("DMislLazyCurve"),this.type=e.getString("DMislType"),this}},e("DMislRules",r)}}}),System.register("game/rules/general/HoverRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("HoverRules",i=class{readIni(e){return this.height=e.getNumber("HoverHeight"),this.dampen=e.getNumber("HoverDampen"),this.bob=e.getNumber("HoverBob"),this.boost=e.getNumber("HoverBoost"),this.acceleration=e.getNumber("HoverAcceleration"),this.brake=e.getNumber("HoverBrake"),this}})}}}),System.register("game/rules/GeneralRules",["game/rules/general/RadarRules","game/rules/general/RepairRules","game/rules/general/VeteranRules","game/rules/general/CrewRules","game/rules/general/PrismRules","game/rules/general/ThreatRules","game/rules/general/ParadropRules","game/rules/general/LightningStormRules","game/rules/general/V3RocketRules","game/rules/general/DMislRules","game/rules/general/HoverRules","util/math"],function(t,e){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m,f;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){var e;(e=p=p||{})[e.Power=0]="Power",e[e.Factory=1]="Factory",e[e.Barracks=2]="Barracks",e[e.Radar=3]="Radar",e[e.Tech=4]="Tech",e[e.Proc=5]="Proc",t("PrereqCategory",p),m=(new Map).set(p.Power,"PrerequisitePower").set(p.Factory,"PrerequisiteFactory").set(p.Barracks,"PrerequisiteBarracks").set(p.Radar,"PrerequisiteRadar").set(p.Tech,"PrerequisiteTech").set(p.Proc,"PrerequisiteProc"),t("GeneralRules",f=class{constructor(){this.prereqCategories=new Map}readIni(e){this.aircraftFogReveal=e.getNumber("AircraftFogReveal"),this.alliedDisguise=e.getString("AlliedDisguise"),this.baseUnit=e.getArray("BaseUnit"),this.bridgeVoxelMax=e.getNumber("BridgeVoxelMax"),this.buildSpeed=e.getFixed("BuildSpeed"),this.buildupTime=e.getNumber("BuildupTime"),this.chronoDelay=e.getNumber("ChronoDelay"),this.chronoDistanceFactor=e.getNumber("ChronoDistanceFactor",32),this.chronoHarvTooFarDistance=e.getNumber("ChronoHarvTooFarDistance"),this.chronoMinimumDelay=e.getNumber("ChronoMinimumDelay"),this.chronoRangeMinimum=e.getNumber("ChronoRangeMinimum"),this.chronoTrigger=e.getBool("ChronoTrigger",!0),this.cliffBackImpassability=e.getNumber("CliffBackImpassability",2),this.cloakDelay=e.getNumber("CloakDelay"),this.closeEnough=e.getNumber("CloseEnough"),this.crew=(new a.CrewRules).readIni(e),this.defaultMirageDisguises=e.getArray("DefaultMirageDisguises"),this.dMisl=(new u.DMislRules).readIni(e),this.dropPodWeapon=e.getString("DropPodWeapon"),this.engineer=e.getString("Engineer"),this.flightLevel=e.getNumber("FlightLevel"),this.guardAreaTargetingDelay=e.getNumber("GuardAreaTargetingDelay"),this.harvesterTooFarDistance=e.getNumber("HarvesterTooFarDistance"),this.harvesterUnit=e.getArray("HarvesterUnit"),this.hover=(new d.HoverRules).readIni(e),this.infantryBlinkDisguiseTime=e.getNumber("InfantryBlinkDisguiseTime"),this.lightningStorm=(new c.LightningStormRules).readIni(e),this.lowPowerPenaltyModifier=e.getNumber("LowPowerPenaltyModifier",1),this.minLowPowerProductionSpeed=e.getFixed("MinLowPowerProductionSpeed",.5),this.maxLowPowerProductionSpeed=e.getFixed("MaxLowPowerProductionSpeed",1),this.maximumCheerRate=e.getNumber("MaximumCheerRate"),this.maximumQueuedObjects=e.getNumber("MaximumQueuedObjects"),this.maxWaypointPathLength=e.getNumber("MaxWaypointPathLength"),this.multipleFactory=e.getFixed("MultipleFactory",1),this.normalTargetingDelay=e.getNumber("NormalTargetingDelay"),this.padAircraft=e.getArray("PadAircraft"),this.parachuteMaxFallRate=e.getNumber("ParachuteMaxFallRate"),this.paradrop=(new l.ParadropRules).readIni(e),this.prism=(new n.PrismRules).readIni(e),this.purifierBonus=e.getNumber("PurifierBonus"),this.radar=(new i.RadarRules).readIni(e),this.refundPercent=g.clamp(e.getNumber("RefundPercent"),0,1),this.repair=(new r.RepairRules).readIni(e),this.revealTriggerRadius=Math.min(10,e.getNumber("RevealTriggerRadius")),this.shipSinkingWeight=e.getNumber("ShipSinkingWeight"),this.sovietDisguise=e.getString("SovietDisguise"),this.spyMoneyStealPercent=e.getNumber("SpyMoneyStealPercent"),this.spyPowerBlackout=e.getNumber("SpyPowerBlackout"),this.technician=e.getString("Technician"),this.threat=(new o.ThreatRules).readIni(e),this.treeStrength=e.getNumber("TreeStrength"),this.v3Rocket=(new h.V3RocketRules).readIni(e),this.veteran=(new s.VeteranRules).readIni(e),this.wallBuildSpeedCoefficient=e.getFixed("WallBuildSpeedCoefficient"),this.readPrereqCategories(e)}readPrereqCategories(e){for(var[t,i]of m){if(!e.has(i))throw new Error(`Missing prerequisite category ${i} in [General] section`);this.prereqCategories.set(t,e.getArray(i))}}getMissileRules(e){switch(e){case this.v3Rocket.type:return this.v3Rocket;case this.dMisl.type:return this.dMisl;default:throw new Error(`Unsupported missile type "${e}"`)}}})}}}),System.register("game/type/SpeedType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Foot=0]="Foot",e[e.Track=1]="Track",e[e.Wheel=2]="Wheel",e[e.Hover=3]="Hover",e[e.Float=4]="Float",e[e.FloatBeach=5]="FloatBeach",e[e.Amphibious=6]="Amphibious",e[e.Winged=7]="Winged",t("SpeedType",i)}}}),System.register("game/rules/LandRules",["game/type/SpeedType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("LandRules",r=class{constructor(){this.speedModifiers=new Map}readIni(t){return this.buildable=t.getBool("Buildable",!1),[...t.entries.keys()].forEach(e=>{void 0!==i.SpeedType[e]&&this.speedModifiers.set(i.SpeedType[e],t.getNumber(e))}),this}getSpeedModifier(e){if(e===i.SpeedType.Foot&&0===this.speedModifiers.get(i.SpeedType.Track))return 0;let t=this.speedModifiers.get(e);return void 0===t&&(t=1),e!==i.SpeedType.Track&&e!==i.SpeedType.Wheel&&0<t&&(t=1),t}})}}}),System.register("game/gameobject/infantry/InfDeathType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Gunfire=1]="Gunfire",e[e.Explode=2]="Explode",e[e.ExplodeAlt=3]="ExplodeAlt",e[e.Fire=4]="Fire",e[e.Electro=5]="Electro",e[e.HeadExplode=6]="HeadExplode",e[e.Nuke=7]="Nuke",t("InfDeathType",i)}}}),System.register("game/rules/WarheadRules",["game/gameobject/infantry/InfDeathType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("WarheadRules",r=class{constructor(e){this.rules=e,this.verses=new Map,this.parse()}get name(){return this.rules.name}parse(){this.animList=this.rules.getArray("AnimList"),this.bombDisarm=this.rules.getBool("BombDisarm"),this.bullets=this.rules.getBool("Bullets"),this.cellSpread=this.rules.getNumber("CellSpread"),this.conventional=this.rules.getBool("Conventional"),this.culling=this.rules.getBool("Culling"),this.electricAssault=this.rules.getBool("ElectricAssault"),this.emEffect=this.rules.getBool("EMEffect"),this.infDeath=this.rules.getEnumNumeric("InfDeath",i.InfDeathType,i.InfDeathType.None),this.ivanBomb=this.rules.getBool("IvanBomb"),this.makesDisguise=this.rules.getBool("MakesDisguise"),this.mindControl=this.rules.getBool("MindControl"),this.nukeMaker=this.rules.getBool("NukeMaker"),this.paralyzes=this.rules.getNumber("Paralyzes"),this.parasite=this.rules.getBool("Parasite"),this.percentAtMax=this.rules.getNumber("PercentAtMax",1),this.proneDamage=this.rules.getNumber("ProneDamage",1),this.psychicDamage=this.rules.getBool("PsychicDamage"),this.radiation=this.rules.getBool("Radiation"),this.rocker=this.rules.getBool("Rocker"),this.sonic=this.rules.getBool("Sonic"),this.temporal=this.rules.getBool("Temporal");let e=this.rules.getFixedArray("Verses");e.forEach((e,t)=>this.verses.set(t,e)),this.wallAbsoluteDestroyer=this.rules.getBool("WallAbsoluteDestroyer"),this.wall=this.rules.getBool("Wall"),this.wood=this.rules.getBool("Wood")}})}}}),System.register("game/rules/ProjectileRules",["game/rules/ObjectRules"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.ObjectRules{parse(){super.parse();var e=this.ini.getNumber("ROT",0);let t=this.ini.getNumber("Acceleration");1!==e||t||(t=Number.POSITIVE_INFINITY),t=t||3,this.acceleration=t,this.arcing=this.ini.getBool("Arcing"),this.courseLockDuration=this.ini.getNumber("CourseLockDuration"),this.detonationAltitude=this.ini.getNumber("DetonationAltitude"),this.firersPalette=this.ini.getBool("FirersPalette"),this.flakScatter=this.ini.getBool("FlakScatter"),this.inaccurate=this.ini.getBool("Inaccurate"),this.inviso=this.ini.getBool("Inviso"),this.isAntiAir=this.ini.getBool("AA"),this.isAntiGround=this.ini.getBool("AG",!0),this.level=this.ini.getBool("Level"),this.rot=i.ObjectRules.iniRotToDegsPerTick(e),this.iniRot=e,this.shadow=this.ini.getBool("Shadow",!0),this.shrapnelWeapon=this.ini.getString("ShrapnelWeapon")||void 0,this.shrapnelCount=this.ini.getNumber("ShrapnelCount"),this.subjectToCliffs=this.ini.getBool("SubjectToCliffs"),this.subjectToElevation=this.ini.getBool("SubjectToElevation"),this.subjectToWalls=this.ini.getBool("SubjectToWalls"),this.vertical=this.ini.getBool("Vertical")}},e("ProjectileRules",r)}}}),System.register("data/mapObjects",["engine/type/ObjectType"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("MapObject",r=class{constructor(e){this.type=e}isStructure(){return this.type===i.ObjectType.Building}isVehicle(){return this.type===i.ObjectType.Vehicle}isInfantry(){return this.type===i.ObjectType.Infantry}isAircraft(){return this.type===i.ObjectType.Aircraft}isTerrain(){return this.type===i.ObjectType.Terrain}isSmudge(){return this.type===i.ObjectType.Smudge}isOverlay(){return this.type===i.ObjectType.Overlay}isNamed(){return"name"in this}isTechno(){return"health"in this}}),n=class extends r{},a=class extends n{},s=class extends a{constructor(){super(i.ObjectType.Building)}},e("Structure",s),s=class extends a{constructor(){super(i.ObjectType.Vehicle)}},e("Vehicle",s),s=class extends a{constructor(){super(i.ObjectType.Infantry)}},e("Infantry",s),a=class extends a{constructor(){super(i.ObjectType.Aircraft)}},e("Aircraft",a),a=class extends n{constructor(){super(i.ObjectType.Terrain)}},e("Terrain",a),n=class extends n{constructor(){super(i.ObjectType.Smudge)}},e("Smudge",n),n=class extends r{constructor(){super(i.ObjectType.Overlay)}},e("Overlay",n)}}}),System.register("game/rules/TerrainRules",["game/rules/ObjectRules","engine/TheaterType"],function(t,e){"use strict";var i,r,a,s;e&&e.id;function n(e,t){switch(e){case 0:case 1:return!0;case 2:return 0!=(t&a.Right);case 3:return 0!=(t&a.Left);case 4:return 0!=(t&a.Bottom);default:throw new Error('Invalid subCell "'+e)}}return t("testOccupationBit",n),{setters:[function(e){i=e},function(e){r=e}],execute:function(){var e;(e=a=a||{})[e.All=7]="All",e[e.Right=1]="Right",e[e.Left=2]="Left",e[e.Bottom=4]="Bottom",t("OccupationBits",a),s=class extends i.ObjectRules{parse(){super.parse(),this.animationRate=this.ini.getNumber("AnimationRate"),this.animationProbability=this.ini.getNumber("AnimationProbability"),this.gate=this.ini.getBool("Gate"),this.immune=this.ini.getBool("Immune"),this.isAnimated=this.ini.getBool("IsAnimated"),this.snowOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("SnowOccupationBits",a.All)),this.spawnsTiberium=this.ini.getBool("SpawnsTiberium"),this.strength=this.ini.getNumber("Strength"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.temperateOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("TemperateOccupationBits",a.All))}normalizeOccupationBits(e){return(e+8*Math.abs(Math.floor(e/8)))%8}getOccupationBits(e){return e!==r.TheaterType.Snow?this.temperateOccupationBits:this.snowOccupationBits}getOccupiedSubCells(e){var t,i=this.getOccupationBits(e),r=[0,1,2,3,4];if(i===a.All)return r;let s=[];for(t of r)n(t,i)&&s.push(t);return s}},t("TerrainRules",s)}}}),System.register("game/rules/SmudgeRules",["game/rules/ObjectRules"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.ObjectRules{parse(){super.parse(),this.burn=this.ini.getBool("Burn"),this.crater=this.ini.getBool("Crater"),this.width=this.ini.getNumber("Width",1),this.height=this.ini.getNumber("Height",1)}},e("SmudgeRules",r)}}}),System.register("game/rules/DebrisRules",["util/math","game/rules/ObjectRules"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.ObjectRules{parse(){super.parse(),this.damage=this.ini.getNumber("Damage"),this.damageRadius=this.ini.getNumber("DamageRadius"),this.duration=this.ini.getNumber("Duration"),this.elasticity=i.clamp(this.ini.getNumber("Elasticity",.75),0,1),this.expireAnim=this.ini.getString("ExpireAnim")||void 0,this.minAngularVelocity=this.ini.getNumber("MinAngularVelocity"),this.maxAngularVelocity=this.ini.getNumber("MaxAngularVelocity"),this.maxXYVel=this.ini.getNumber("MaxXYVel"),this.minZVel=this.ini.getNumber("MinZVel"),this.maxZVel=this.ini.getNumber("MaxZVel"),this.shareTurretData=this.ini.getBool("ShareTurretData"),this.shareBodyData=this.ini.getBool("ShareBodyData"),this.shareBarrelData=this.ini.getBool("ShareBarrelData"),this.shareSource=this.ini.get("ShareSource")||void 0,this.trailerAnim=this.ini.getString("TrailerAnim")||void 0,this.trailerSeparation=this.ini.getNumber("TrailerSeperation"),this.warhead=this.ini.getString("Warhead")||void 0}},e("DebrisRules",s)}}}),System.register("game/rules/ObjectRulesFactory",["engine/type/ObjectType","game/rules/ObjectRules","game/rules/TechnoRules","game/rules/OverlayRules","game/rules/TerrainRules","game/rules/SmudgeRules","game/rules/DebrisRules"],function(e,t){"use strict";var r,s,a,n,o,l,c,i;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("ObjectRulesFactory",i=class{create(e,t,i){switch(e){case r.ObjectType.Aircraft:case r.ObjectType.Building:case r.ObjectType.Infantry:case r.ObjectType.Vehicle:return new a.TechnoRules(e,t,i);case r.ObjectType.Overlay:return new n.OverlayRules(e,t,i);case r.ObjectType.Terrain:return new o.TerrainRules(e,t,i);case r.ObjectType.Smudge:return new l.SmudgeRules(e,t,i);case r.ObjectType.VoxelAnim:return new c.DebrisRules(e,t,i);default:return new s.ObjectRules(e,t,i)}}})}}}),System.register("game/rules/CombatDamageRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CombatDamageRules",i=class{readIni(e){this.ballisticScatter=e.getNumber("BallisticScatter"),this.bridgeStrength=e.getNumber("BridgeStrength"),this.c4Delay=e.getNumber("C4Delay"),this.c4Warhead=e.getString("C4Warhead"),this.deathWeapon=e.getString("DeathWeapon"),this.dMislEliteWarhead=e.getString("DMislEliteWarhead"),this.dMislWarhead=e.getString("DMislWarhead"),this.flameDamage=e.getString("FlameDamage"),this.ironCurtainDuration=e.getNumber("IronCurtainDuration"),this.ivanDamage=e.getNumber("IvanDamage"),this.ivanIconFlickerRate=e.getNumber("IvanIconFlickerRate"),this.ivanTimedDelay=e.getNumber("IvanTimedDelay"),this.ivanWarhead=e.getString("IvanWarhead"),this.splashList=e.getArray("SplashList"),this.v3EliteWarhead=e.getString("V3EliteWarhead"),this.v3Warhead=e.getString("V3Warhead")}})}}}),System.register("game/rules/TiberiumRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("TiberiumRules",i=class{readIni(e){return this.value=e.getNumber("Value"),this}})}}}),System.register("engine/type/TiberiumType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Riparius=0]="Riparius",e[e.Cruentus=1]="Cruentus",e[e.Vinifera=2]="Vinifera",e[e.Aboreus=3]="Aboreus",e[e.Ore=0]="Ore",e[e.Gems=1]="Gems",t("TiberiumType",i)}}}),System.register("game/rules/AiRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("AiRules",i=class{readIni(e){this.buildPower=e.getArray("BuildPower"),this.buildRefinery=e.getArray("BuildRefinery"),this.buildTech=e.getArray("BuildTech"),this.tiberiumFarScan=e.getNumber("TiberiumFarScan",50),this.tiberiumNearScan=e.getNumber("TiberiumNearScan",5)}})}}}),System.register("game/rules/ElevationModelRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ElevationModelRules",i=class{readIni(e){return this.increment=e.getNumber("ElevationIncrement"),this.incrementBonus=e.getNumber("ElevationIncrementBonus",1),this.bonusCap=e.getNumber("ElevationBonusCap"),this}getBonus(e,t){return e<=t?0:Math.min(this.bonusCap,Math.floor((e-t)/this.increment))*this.incrementBonus}})}}}),System.register("game/rules/RadiationRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RadiationRules",i=class{readIni(e){this.radDurationMultiple=e.getNumber("RadDurationMultiple"),this.radApplicationDelay=e.getNumber("RadApplicationDelay"),this.radLevelMax=e.getNumber("RadLevelMax"),this.radLevelDelay=e.getNumber("RadLevelDelay"),this.radLightDelay=e.getNumber("RadLightDelay"),this.radLevelFactor=e.getNumber("RadLevelFactor"),this.radLightFactor=e.getNumber("RadLightFactor"),this.radTintFactor=e.getNumber("RadTintFactor"),this.radColor=e.getNumberArray("RadColor"),this.radSiteWarhead=e.getString("RadSiteWarhead")}})}}}),System.register("game/type/SuperWeaponType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.MultiMissile=0]="MultiMissile",e[e.IronCurtain=1]="IronCurtain",e[e.LightningStorm=2]="LightningStorm",e[e.ChronoSphere=3]="ChronoSphere",e[e.ChronoWarp=4]="ChronoWarp",e[e.ParaDrop=5]="ParaDrop",e[e.AmerParaDrop=6]="AmerParaDrop",t("SuperWeaponType",i)}}}),System.register("game/rules/SuperWeaponRules",["game/type/SuperWeaponType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SuperWeaponRules",r=class{constructor(e){this.index=e}readIni(e){return this.disableableFromShell=e.getBool("DisableableFromShell"),this.isPowered=e.getBool("IsPowered",!0),this.name=e.name,this.preClick=e.getBool("PreClick"),this.preDependent=e.getEnum("PreDependent",i.SuperWeaponType,void 0),this.postClick=e.getBool("PostClick"),this.rechargeTime=e.getNumber("RechargeTime",5),this.showTimer=e.getBool("ShowTimer"),this.sidebarImage=e.getString("SidebarImage").toLowerCase(),this.type=e.getEnum("Type",i.SuperWeaponType,void 0),this.uiName=e.getString("UIName"),this.weaponType=e.getString("WeaponType")||void 0,this}})}}}),System.register("game/rules/CrateRules",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CrateRules",i=class{readIni(e){this.crateMaximum=e.getNumber("CrateMaximum"),this.crateMinimum=e.getNumber("CrateMinimum"),this.crateRadius=e.getNumber("CrateRadius"),this.crateRegen=e.getNumber("CrateRegen");let t=e.getString("UnitCrateType");return this.unitCrateType="none"!==t.toLowerCase()?t:void 0,this.healCrateSound=e.getString("HealCrateSound"),this.crateImg=e.getString("CrateImg"),this.waterCrateImg=e.getString("WaterCrateImg"),this.freeMCV=e.getBool("FreeMCV"),this}})}}}),System.register("game/order/OrderType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Move=0]="Move",e[e.ForceMove=1]="ForceMove",e[e.Attack=2]="Attack",e[e.ForceAttack=3]="ForceAttack",e[e.AttackMove=4]="AttackMove",e[e.Guard=5]="Guard",e[e.GuardArea=6]="GuardArea",e[e.Capture=7]="Capture",e[e.Occupy=8]="Occupy",e[e.Deploy=9]="Deploy",e[e.DeploySelected=10]="DeploySelected",e[e.Stop=11]="Stop",e[e.Cheer=12]="Cheer",e[e.Dock=13]="Dock",e[e.Gather=14]="Gather",e[e.Repair=15]="Repair",e[e.Scatter=16]="Scatter",e[e.EnterTransport=17]="EnterTransport",e[e.PlaceBomb=18]="PlaceBomb",t("OrderType",i)}}}),System.register("gui/PointerType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Default=0]="Default",e[e.Mini=1]="Mini",e[e.Scroll=2]="Scroll",e[e.NoScroll=10]="NoScroll",e[e.Select=18]="Select",e[e.Move=31]="Move",e[e.NoMove=41]="NoMove",e[e.MoveMini=42]="MoveMini",e[e.NoActionMini=52]="NoActionMini",e[e.AttackRange=53]="AttackRange",e[e.AttackNoRange=58]="AttackNoRange",e[e.AttackMini=63]="AttackMini",e[e.Guard=68]="Guard",e[e.GuardMini=73]="GuardMini",e[e.Unknown1=78]="Unknown1",e[e.Unknown2=88]="Unknown2",e[e.Occupy=89]="Occupy",e[e.NoOccupy=99]="NoOccupy",e[e.OccupyMini=100]="OccupyMini",e[e.Deploy=110]="Deploy",e[e.NoDeploy=119]="NoDeploy",e[e.Unknown3=120]="Unknown3",e[e.Sell=129]="Sell",e[e.SellMini=139]="SellMini",e[e.NoSell=149]="NoSell",e[e.RepairMove=150]="RepairMove",e[e.SideRepair=170]="SideRepair",e[e.NoRepair=190]="NoRepair",e[e.Unknown4=191]="Unknown4",e[e.Unknown5=199]="Unknown5",e[e.Dynamite=204]="Dynamite",e[e.Unknown6=209]="Unknown6",e[e.Unknown7=214]="Unknown7",e[e.Unknown8=219]="Unknown8",e[e.Unknown9=224]="Unknown9",e[e.Unknown10=229]="Unknown10",e[e.Unknown11=234]="Unknown11",e[e.Unknwon12=239]="Unknwon12",e[e.Unknown13=249]="Unknown13",e[e.Para=259]="Para",e[e.Unknown14=269]="Unknown14",e[e.Storm=279]="Storm",e[e.Unknown15=299]="Unknown15",e[e.C4=309]="C4",e[e.Nuke=319]="Nuke",e[e.Unknown16=329]="Unknown16",e[e.Power=339]="Power",e[e.Unknown17=345]="Unknown17",e[e.Iron=346]="Iron",e[e.Unknown18=351]="Unknown18",e[e.Unknown19=356]="Unknown19",e[e.Chrono=357]="Chrono",e[e.DefuseBomb=369]="DefuseBomb",e[e.NoAction=384]="NoAction",e[e.Pan=385]="Pan",e[e.Unknown21=394]="Unknown21",e[e.AttackMove=404]="AttackMove",e[e.Unknown23=413]="Unknown23",e[e.Unknown24=422]="Unknown24",e[e.Unknown25=431]="Unknown25",e[e.Unknown26=432]="Unknown26",e[e.Unknown27=433]="Unknown27",e[e.Unknown28=434]="Unknown28",e[e.Beacon=435]="Beacon",t("PointerType",i)}}}),System.register("game/gameobject/task/system/TaskStatus",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Finished=2]="Finished",e[e.Cancelling=3]="Cancelling",e[e.Cancelled=4]="Cancelled",t("TaskStatus",i)}}}),System.register("data/map/tag/TagRepeatType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.OnceAny=0]="OnceAny",e[e.OnceAll=1]="OnceAll",e[e.Repeat=2]="Repeat",t("TagRepeatType",i)}}}),System.register("data/map/tag/Tag",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Tag",i=class{})}}}),System.register("game/map/Tile",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/map/TileCollection",["game/type/LandType","engine/type/TerrainType","util/typeGuard"],function(t,e){"use strict";var C,E,r,s,i;e&&e.id;return{setters:[function(e){C=e},function(e){E=e},function(e){r=e}],execute:function(){var e;(e=s=s||{})[e.Top=0]="Top",e[e.TopLeft=1]="TopLeft",e[e.TopRight=2]="TopRight",e[e.Left=3]="Left",e[e.Right=4]="Right",e[e.BottomLeft=5]="BottomLeft",e[e.Bottom=6]="Bottom",e[e.BottomRight=7]="BottomRight",t("TileDirection",s),t("TileCollection",i=class{constructor(e,t,i,r){this.tileSets=t,this.generalRules=i;let s=this.rSize={width:0,height:0},a=this.dSize={width:0,height:0};for(let v=0,b=e.length;v<b;++v)s.width=Math.max(s.width,e[v].rx),s.height=Math.max(s.height,e[v].ry),a.width=Math.max(a.width,e[v].dx),a.height=Math.max(a.height,e[v].dy);s.width++,s.height++,a.width++,a.height++;let n=this.tilesByRxy=new Array(s.width*s.height);n.fill(void 0);let o=this.tilesByDxy=new Array(a.width*a.height);o.fill(void 0);let l=this.tiles=new Array(e.length),c=[],h=this.bridgeSetTiles=[],u=new Set(Object.values(E.TerrainType));this.minTileHeight=Number.POSITIVE_INFINITY;for(let S=this.maxTileHeight=0,w=e.length;S<w;++S){var d=e[S],g=t.getTileImage(d.tileNum,d.subTile,r),p=g.terrainType;if(!u.has(p))throw new Error(`Tile (${d.rx}, ${d.ry}) has unknown terrain type "${p}"`);var m={...d,terrainType:p,landType:C.getLandType(p),onBridgeLandType:void 0,rampType:g.rampType,id:d.rx+"_"+d.ry,occluded:!1},f=m.rx,y=m.ry,T=m.dx,p=m.dy;l[S]=m,n[f+y*s.width]=m,o[T+p*a.width]=m,this.minTileHeight=Math.min(this.minTileHeight,m.z),this.maxTileHeight=Math.max(this.maxTileHeight,m.z),4!==g.height||m.terrainType!==E.TerrainType.Cliff&&!t.isCliffTile(m.tileNum)||c.push(m),t.isHighBridgeBoundaryTile(d.tileNum)&&h.push(m)}this.computeLandBehindCliffTiles(c),this.cutoffTileHeight=this.computeCutoffTileHeight()}computeLandBehindCliffTiles(t){if(!(this.generalRules.cliffBackImpassability<2)){let e=[[-2,-2],[-1,-1],[-1,1],[1,-1],[0,1],[1,0]];t.forEach(t=>{for(var[i,r]of e){let e=this.getByMapCoords(t.rx+i,t.ry+r);e&&e.z<t.z&&e.terrainType!==E.TerrainType.Cliff&&e.terrainType!==E.TerrainType.Rough&&0===e.rampType&&(e.landType=C.LandType.Rock)}})}}getTileRadarColor(e){let t=this.tileSets.getTileImage(e.tileNum,e.subTile,()=>0);return t.radarLeft.clone().multiplyScalar(.5)}getAll(){return[...this.tiles]}forEach(e){for(let t=0,i=this.tiles.length;t<i;++t)e(this.tiles[t],t)}reduce(t,e){let i=e;return this.forEach(e=>{i=t(i,e)}),i}getMinTileHeight(){return this.minTileHeight}getMaxTileHeight(){return this.maxTileHeight}getCutoffTileHeight(){return this.cutoffTileHeight}computeCutoffTileHeight(){var t=this.dSize.width-1;let i=this.dSize.height-1,r=0,s=!0;for(;s&&0<i;){for(let e=1;e<t-3;e++){var a=this.getByDisplayCoords(e,i);a&&(s=!1,a.z>r&&(r=a.z))}s&&i--}return r}getAllBridgeSetTiles(){return this.bridgeSetTiles}getAllNeighbourTiles(e){var t=e.rx,i=e.ry;return[this.getByMapCoords(t+1,i+1),this.getByMapCoords(t-1,i-1),this.getByMapCoords(t-1,i+1),this.getByMapCoords(t+1,i-1),this.getByMapCoords(t,i+1),this.getByMapCoords(t+1,i),this.getByMapCoords(t-1,i),this.getByMapCoords(t,i-1)].filter(r.isNotNullOrUndefined)}getNeighbourTile(e,t){var i=e.rx,r=e.ry;switch(t){case s.Bottom:return this.getByMapCoords(i+1,r+1);case s.Top:return this.getByMapCoords(i-1,r-1);case s.Left:return this.getByMapCoords(i-1,r+1);case s.Right:return this.getByMapCoords(i+1,r-1);case s.BottomLeft:return this.getByMapCoords(i,r+1);case s.BottomRight:return this.getByMapCoords(i+1,r);case s.TopLeft:return this.getByMapCoords(i-1,r);case s.TopRight:return this.getByMapCoords(i,r-1);default:throw new Error("Invalid direction")}}getByDisplayCoords(e,t){if(!(e>=this.dSize.width||t>=this.dSize.height))return this.tilesByDxy[e+t*this.dSize.width]}getByMapCoords(e,t){if(!(e>=this.rSize.width||t>=this.rSize.height))return this.tilesByRxy[e+t*this.rSize.width]}getMapSize(){return this.rSize}getDisplaySize(){return this.dSize}getInRectangle(e,t){let i,r,s,a;a=t?(i=e.rx,r=e.ry,s=t.width,t.height):(i=e.x,r=e.y,s=e.width,e.height);let n=[];for(let c=0;c<s;c++)for(let e=0;e<a;e++){var o=i+c,l=r+e,l=this.getByMapCoords(o,l);l&&n.push(l)}return n}getPlaceholderTile(e,t){var i=this.tiles[0],i=i.dx-i.rx+i.ry+1;return{rx:e,ry:t,dx:e-t+i-1,dy:e+t-i-1,z:0,id:e+"_"+t,landType:C.LandType.Rock,terrainType:E.TerrainType.Rock1,rampType:0,subTile:0,tileNum:0,occluded:!1,onBridgeLandType:void 0}}})}}}),System.register("game/gameobject/unit/ZoneType",["game/type/LandType"],function(t,e){"use strict";var i,r;e&&e.id;return t("getZoneType",function(e){return[i.LandType.Water,i.LandType.Beach].includes(e)?r.Water:r.Ground}),{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.Ground=0]="Ground",e[e.Air=1]="Air",e[e.Water=2]="Water",t("ZoneType",r)}}}),System.register("game/map/TileOccupation",["game/type/LandType","util/event","game/gameobject/unit/ZoneType"],function(t,e){"use strict";var r,s,a,i,n;e&&e.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){var e;(e=i=i||{})[e.All=0]="All",e[e.Ground=1]="Ground",e[e.Air=2]="Air",t("LayerType",i),t("TileOccupation",n=class{constructor(e){this.tiles=e,this.tileOccupation=[],this.emptyTiles=new Set,this._onChange=new s.EventDispatcher;let t=this.tileOccupation;for(var i of e.getAll())t[i.rx]=t[i.rx]||[],t[i.rx][i.ry]=new Set,this.emptyTiles.add(i)}get onChange(){return this._onChange.asEvent()}occupyTileRange(e,t){let i=this.calculateTilesForGameObject(e,t);i.forEach(e=>this.occupyTile(e,t)),this._onChange.dispatch(this,{tiles:i,object:t,type:"added"})}unoccupyTileRange(e,t){let i=this.calculateTilesForGameObject(e,t);i.forEach(e=>this.unoccupyTile(e,t)),this._onChange.dispatch(this,{tiles:i,object:t,type:"removed"})}occupySingleTile(e,t){this.occupyTile(e,t),this._onChange.dispatch(this,{tiles:[e],object:t,type:"added"})}unoccupySingleTile(e,t){this.unoccupyTile(e,t),this._onChange.dispatch(this,{tiles:[e],object:t,type:"removed"})}calculateTilesForGameObject(e,t){return this.tiles.getInRectangle(e,t.getFoundation())}occupyTile(e,t){let i=this.tileOccupation[e.rx]?.[e.ry];i&&(i.add(t),this.emptyTiles.delete(e),e.landType=this.computeTileLandType(e),e.onBridgeLandType=this.computeOnBridgeLandType(e))}unoccupyTile(e,t){let i=this.tileOccupation[e.rx]?.[e.ry];i&&(i.delete(t),i.size||this.emptyTiles.add(e),e.landType=this.computeTileLandType(e),e.onBridgeLandType=this.computeOnBridgeLandType(e))}isTileOccupiedBy(e,t){return!!this.tileOccupation[e.rx]?.[e.ry]?.has(t)}computeTileLandType(e){if(e.landType===r.LandType.Rock)return r.LandType.Rock;var t,i=r.getLandType(e.terrainType);for(t of this.tileOccupation[e.rx]?.[e.ry]??[]){if((t.isOverlay()||t.isBuilding())&&t.rules.wall)return r.LandType.Wall;if(t.isOverlay()&&t.isTiberium())return r.LandType.Tiberium;if(t.isOverlay()&&t.rules.land!==r.LandType.Clear&&!t.isBridge()&&!t.isBridgePlaceholder())return t.rules.land}return i}computeOnBridgeLandType(e){for(var t of this.tileOccupation[e.rx]?.[e.ry]??[])if(t.isOverlay()&&t.isBridge())return t.isHighBridge()?r.LandType.Road:t.rules.land}getTileZone(e,t=!1){return a.getZoneType(t?e.landType:e.onBridgeLandType??e.landType)}getBridgeOnTile(e){for(var t of this.tileOccupation[e.rx]?.[e.ry]??[])if(t.isOverlay()&&t.isBridge())return t}getObjectsOnTile(e){return[...this.tileOccupation[e.rx]?.[e.ry]??[]]}getGroundObjectsOnTile(e){let t=[];for(var i of this.tileOccupation[e.rx]?.[e.ry]??[])i.isTechno()&&!i.isBuilding()&&i.zone===a.ZoneType.Air||t.push(i);return t}getAirObjectsOnTile(e){let t=[];for(var i of this.tileOccupation[e.rx]?.[e.ry]??[])i.isUnit()&&i.zone===a.ZoneType.Air&&t.push(i);return t}getObjectsOnTileByLayer(e,t){if(t===i.Ground)return this.getGroundObjectsOnTile(e);if(t===i.Air)return this.getAirObjectsOnTile(e);if(t===i.All)return this.getObjectsOnTile(e);throw new Error(`Unhandled layer type "${t}"`)}getEmptyTiles(){return[...this.emptyTiles]}})}}}),System.register("game/map/BridgeOverlayTypes",["util/math"],function(t,e){"use strict";var i,r,s;e&&e.id;return{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.NotBridge=0]="NotBridge",e[e.Concrete=1]="Concrete",e[e.Wood=2]="Wood",t("OverlayBridgeType",r),t("BridgeOverlayTypes",s=class{static getOverlayBridgeType(e){return i.isBetween(e,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)||i.isBetween(e,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)?r.Concrete:i.isBetween(e,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||i.isBetween(e,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)?r.Wood:r.NotBridge}static isBridge(e){return this.isHighBridge(e)||this.isLowBridge(e)}static isBridgePlaceholder(e){return this.bridgePlaceholderIds.includes(e)}static isHighBridge(e){return i.isBetween(e,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||i.isBetween(e,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)}static isLowBridge(e){return i.isBetween(e,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)||i.isBetween(e,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)}static isXBridge(e){return e===this.minHighBridgeWoodId||e===this.minHighBridgeConcreteId||i.isBetween(e,this.minLowBridgeWoodId,this.minLowBridgeWoodId+8)||i.isBetween(e,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+21)||i.isBetween(e,this.minLowBridgeConcreteId,this.minLowBridgeConcreteId+8)||i.isBetween(e,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+21)}static isLowBridgeHead(e){return i.isBetween(e,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+25)||i.isBetween(e,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+25)}static isLowBridgeHeadStart(e){return i.isBetween(e,this.minLowBridgeWoodId+20,this.minLowBridgeWoodId+23)||i.isBetween(e,this.minLowBridgeConcreteId+20,this.minLowBridgeConcreteId+23)}static calculateLowBridgeOverlayId(e,t){let i;if(e===r.Concrete)i=this.minLowBridgeConcreteId;else{if(e!==r.Wood)throw new Error("Not implemented");i=this.minLowBridgeWoodId}return i+(t?0:9)}static calculateHighBridgeOverlayId(e,t){let i;if(e===r.Concrete)i=this.minHighBridgeConcreteId;else{if(e!==r.Wood)throw new Error("Not implemented");i=this.minHighBridgeWoodId}return i+(t?0:1)}}),s.minLowBridgeWoodId=74,s.maxLowBridgeWoodId=99,s.minLowBridgeConcreteId=205,s.maxLowBridgeConcreteId=230,s.minHighBridgeConcreteId=24,s.maxHighBridgeConcreteId=25,s.minHighBridgeWoodId=237,s.maxHighBridgeWoodId=238,s.bridgePlaceholderIds=[100,101,231,232]}}}),System.register("engine/type/OverlayTibType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NotSpecial=0]="NotSpecial",e[e.Riparius=1]="Riparius",e[e.Cruentus=2]="Cruentus",e[e.Vinifera=4]="Vinifera",e[e.Aboreus=8]="Aboreus",e[e.Ore=1]="Ore",e[e.Gems=2]="Gems",e[e.All=15]="All",t("OverlayTibType",i)}}}),System.register("game/map/OreOverlayTypes",["engine/type/OverlayTibType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("OreOverlayTypes",r=class{static getOverlayTibType(e){return this.isRiparius(e)?i.OverlayTibType.Riparius:this.isCruentus(e)?i.OverlayTibType.Cruentus:this.isVinifera(e)?i.OverlayTibType.Vinifera:this.isAboreus(e)?i.OverlayTibType.Aboreus:i.OverlayTibType.NotSpecial}static isRiparius(e){return e>=this.minIdRiparius&&e<=this.maxIdRiparius}static isCruentus(e){return e>=this.minIdCruentus&&e<=this.maxIdCruentus}static isVinifera(e){return e>=this.minIdVinifera&&e<=this.maxIdVinifera}static isAboreus(e){return e>=this.minIdAboreus&&e<=this.maxIdAboreus}}),r.minIdRiparius=102,r.maxIdRiparius=127,r.minIdCruentus=27,r.maxIdCruentus=38,r.minIdVinifera=127,r.maxIdVinifera=146,r.minIdAboreus=147,r.maxIdAboreus=166}}}),System.register("game/gameobject/infantry/StanceType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Guard=1]="Guard",e[e.Prone=2]="Prone",e[e.Deployed=3]="Deployed",e[e.Paradrop=4]="Paradrop",e[e.Cheer=5]="Cheer",t("StanceType",i)}}}),System.register("game/gameobject/locomotor/Locomotor",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameobject/trait/interface/NotifyUnspawn",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onUnspawn=Symbol(),e("NotifyUnspawn",i)}}}),System.register("game/gameobject/trait/interface/NotifyOwnerChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyOwnerChange",i)}}}),System.register("game/Hashable",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameobject/trait/interface/NotifyTick",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onTick=Symbol(),e("NotifyTick",i)}}}),System.register("game/type/MovementZone",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Amphibious=0]="Amphibious",e[e.AmphibiousCrusher=1]="AmphibiousCrusher",e[e.AmphibiousDestroyer=2]="AmphibiousDestroyer",e[e.Crusher=3]="Crusher",e[e.CrusherAll=4]="CrusherAll",e[e.Destroyer=5]="Destroyer",e[e.Fly=6]="Fly",e[e.Infantry=7]="Infantry",e[e.InfantryDestroyer=8]="InfantryDestroyer",e[e.Normal=9]="Normal",e[e.Subterranean=10]="Subterranean",e[e.Water=11]="Water",t("MovementZone",i)}}}),System.register("game/AttackerInfo",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameobject/common/DeathType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Demolish=2]="Demolish",e[e.Crush=3]="Crush",e[e.Temporal=4]="Temporal",e[e.Sink=5]="Sink",t("DeathType",i)}}}),System.register("game/gameobject/task/system/CallbackTask",["game/gameobject/task/system/Task"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.Task{constructor(e){super(),this.cb=e}onTick(e){return this.cb(e),!0}},e("CallbackTask",r)}}}),System.register("data/encoding/Format80",["data/DataStream"],function(e,t){"use strict";var d,i;t&&t.id;return{setters:[function(e){d=e}],execute:function(){e("Format80",i=class{static decode(e,t){var i=new Uint8Array(t);return this.decodeInto(e,i),i}static decodeInto(e,t){let i=new d.DataStream(new DataView(e.buffer,e.byteOffset,e.byteLength)),r=0;for(;;){var s=i.readUint8();if(0==(128&s)){var a=i.readUint8(),n=3+((112&s)>>4);this.replicatePrevious(t,r,r-(((15&s)<<8)+a),n),r+=n}else if(0==(64&s)){n=63&s;if(0==n)return r;t.set(i.readUint8Array(n),r),r+=n}else{s=63&s;if(62==s)for(var o=i.readInt16(),l=i.readUint8(),c=r+o;r<c;r++)t[r]=l;else if(63==s){o=i.readInt16();let e=i.readInt16();if(e>=r)throw new Error(`srcIndex >= destIndex  ${e}  `+r);for(var h=r+o;r<h;r++)t[r]=t[e++]}else{s=3+s;let e=i.readInt16();if(e>=r)throw new Error(`srcIndex >= destIndex  ${e}  `+r);for(var u=r+s;r<u;r++)t[r]=t[e++]}}}}static replicatePrevious(i,r,s,a){if(r<s)throw new Error(`srcIndex > destIndex  ${s}  `+r);if(r-s==1)for(let e=0;e<a;e++)i[r+e]=i[r-1];else for(let t=0;t<a;t++)i[r+t]=i[s+t]}})}}}),System.register("data/encoding/MiniLzo",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MiniLzo",i=class{static decompress(e,t){var i={inputBuffer:e,outputBuffer:null},r=lzo1x.decompress(i,{outputSize:t});if(0!==r)throw new Error("MiniLzo decode failed with code "+r);return i.outputBuffer}})}}}),System.register("data/encoding/Format5",["data/encoding/Format80","data/encoding/MiniLzo"],function(e,t){"use strict";var c,h,i;t&&t.id;return{setters:[function(e){c=e},function(e){h=e}],execute:function(){e("Format5",i=class{static decode(e,t,i=5){var r=new Uint8Array(t);return this.decodeInto(e,r,i),r}static decodeInto(i,r,s=5){var e=r.length;let a=0,n=0;for(;n<e;){var o=i[a+1]<<8|i[a];a+=2;var l=i[a+1]<<8|i[a];if(a+=2,!o||!l)break;let e;e=80===s?c.Format80.decode(i.subarray(a,a+o),l):h.MiniLzo.decompress(i.subarray(a,a+o),l);for(let t=0;t<l;++t)r[n+t]=e[t];a+=o,n+=l}}})}}}),System.register("data/Bitmap",[],function(t,e){"use strict";var a,i,r;e&&e.id;function d(e){switch(e){case a.Indexed:return 1;case a.Rgb:return 3;case a.Rgba:return 4;default:throw new Error("Unsupported pixel format "+e)}}return{setters:[],execute:function(){var e;(e=a=a||{})[e.Rgb=1]="Rgb",e[e.Rgba=2]="Rgba",e[e.Indexed=3]="Indexed",t("PixelFormat",a),t("Bitmap",i=class{constructor(e,t,i,r=a.Rgba){var s=d(r);this.data=i||new Uint8Array(s*e*t),this.pixelFormat=r,this.width=e,this.height=t}drawIndexedImage(t,e,i){var r=d(this.pixelFormat);const s=this.data;var a=this.width,n=r*a,o=r*a*this.height;let l=0+n*i+r*e,c=0;for(let u=0;u<t.height;u++){for(let e=0;e<t.width;e++){var h=t.data[c];0!==h&&0<=l&&l<o&&(s[l]=h,3<=r&&(s[l+1]=0,s[l+2]=0),4===r&&(s[l+3]=255)),l+=r,c++}l+=n-t.width*r}}}),r=class extends i{constructor(e,t,i){super(e,t,i,a.Indexed)}},t("IndexedBitmap",r),r=class extends i{constructor(e,t,i){super(e,t,i,a.Rgb)}},t("RgbBitmap",r),r=class extends i{constructor(e,t,i){super(e,t,i,a.Rgba)}drawRgbaImage(t,e,i){const r=this.data;var s=this.width,a=4*s,n=4*s*this.height;let o=0+a*i+4*e,l=0;for(let c=0;c<t.height;c++){for(let e=0;e<t.width;e++)0<=o&&o<n&&(r[o]=t.data[l],r[o+1]=t.data[l+1],r[o+2]=t.data[l+2],r[o+3]=t.data[l+3]),o+=4,l+=4;o+=a-4*t.width}}},t("RgbaBitmap",r)}}}),System.register("data/map/trigger/TriggerEventType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NoEvent=0]="NoEvent",e[e.EnteredBy=1]="EnteredBy",e[e.SpiedBy=2]="SpiedBy",e[e.AttackedByAny=6]="AttackedByAny",e[e.DestroyedByAny=7]="DestroyedByAny",e[e.AnyEvent=8]="AnyEvent",e[e.DestroyedAllUnits=9]="DestroyedAllUnits",e[e.DestroyedAllBuildings=10]="DestroyedAllBuildings",e[e.DestroyedAll=11]="DestroyedAll",e[e.CreditsExceed=12]="CreditsExceed",e[e.ElapsedTime=13]="ElapsedTime",e[e.MissionTimerExpired=14]="MissionTimerExpired",e[e.DestroyedBuildings=15]="DestroyedBuildings",e[e.DestroyedUnits=16]="DestroyedUnits",e[e.NoFactoriesLeft=17]="NoFactoriesLeft",e[e.BuildBuilding=19]="BuildBuilding",e[e.BuildUnit=20]="BuildUnit",e[e.BuildInfantry=21]="BuildInfantry",e[e.BuildAircraft=22]="BuildAircraft",e[e.CrossesHorizontalLine=25]="CrossesHorizontalLine",e[e.CrossesVerticalLine=26]="CrossesVerticalLine",e[e.GlobalIsSet=27]="GlobalIsSet",e[e.GlobalIsCleared=28]="GlobalIsCleared",e[e.DestroyedOrCaptured=29]="DestroyedOrCaptured",e[e.LowPower=30]="LowPower",e[e.DestroyedBridge=31]="DestroyedBridge",e[e.BuildingExists=32]="BuildingExists",e[e.ComesNearWaypoint=34]="ComesNearWaypoint",e[e.LocalIsSet=36]="LocalIsSet",e[e.LocalIsCleared=37]="LocalIsCleared",e[e.FirstDamagedCombat=38]="FirstDamagedCombat",e[e.HalfHealthCombat=39]="HalfHealthCombat",e[e.QuarterHealthCombat=40]="QuarterHealthCombat",e[e.FirstDamagedAny=41]="FirstDamagedAny",e[e.HalfHealthAny=42]="HalfHealthAny",e[e.QuarterHealthAny=43]="QuarterHealthAny",e[e.AttackedByHouse=44]="AttackedByHouse",e[e.AmbientLightBelow=45]="AmbientLightBelow",e[e.AmbientLightAbove=46]="AmbientLightAbove",e[e.ElapsedScenarioTime=47]="ElapsedScenarioTime",e[e.DestroyedOrCapturedOrInfiltrated=48]="DestroyedOrCapturedOrInfiltrated",e[e.PickupCrate=49]="PickupCrate",e[e.PickupCrateAny=50]="PickupCrateAny",e[e.RandomDelay=51]="RandomDelay",e[e.CreditsBelow=52]="CreditsBelow",e[e.SpyEnteringAsHouse=53]="SpyEnteringAsHouse",e[e.SpyEnteringAsInfantry=54]="SpyEnteringAsInfantry",e[e.DestroyedAllUnitsNaval=55]="DestroyedAllUnitsNaval",e[e.DestroyedAllUnitsLand=56]="DestroyedAllUnitsLand",e[e.BuildingNotExists=57]="BuildingNotExists",t("TriggerEventType",i)}}}),System.register("data/map/trigger/TriggerEvent",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerActionType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NoAction=0]="NoAction",e[e.FireSale=9]="FireSale",e[e.TextTrigger=11]="TextTrigger",e[e.DestroyTrigger=12]="DestroyTrigger",e[e.ChangeHouse=14]="ChangeHouse",e[e.RevealMap=16]="RevealMap",e[e.RevealAroundWaypoint=17]="RevealAroundWaypoint",e[e.PlaySoundFx=19]="PlaySoundFx",e[e.PlaySpeech=21]="PlaySpeech",e[e.ForceTrigger=22]="ForceTrigger",e[e.TimerStart=23]="TimerStart",e[e.TimerStop=24]="TimerStop",e[e.TimerExtend=25]="TimerExtend",e[e.TimerShorten=26]="TimerShorten",e[e.TimerSet=27]="TimerSet",e[e.GlobalSet=28]="GlobalSet",e[e.GlobalClear=29]="GlobalClear",e[e.DestroyObject=32]="DestroyObject",e[e.AddOneTimeSuperWeapon=33]="AddOneTimeSuperWeapon",e[e.AddRepeatingSuperWeapon=34]="AddRepeatingSuperWeapon",e[e.AllChangeHouse=36]="AllChangeHouse",e[e.ResizePlayerView=40]="ResizePlayerView",e[e.PlayAnimAt=41]="PlayAnimAt",e[e.DetonateWarhead=42]="DetonateWarhead",e[e.ReshroudMap=51]="ReshroudMap",e[e.EnableTrigger=53]="EnableTrigger",e[e.DisableTrigger=54]="DisableTrigger",e[e.CreateRadarEvent=55]="CreateRadarEvent",e[e.LocalSet=56]="LocalSet",e[e.LocalClear=57]="LocalClear",e[e.SellBuilding=60]="SellBuilding",e[e.TurnOffBuilding=61]="TurnOffBuilding",e[e.TurnOnBuilding=62]="TurnOnBuilding",e[e.ApplyOneHundredDamage=63]="ApplyOneHundredDamage",e[e.ForceEnd=69]="ForceEnd",e[e.DestroyTag=70]="DestroyTag",e[e.SetAmbientStep=71]="SetAmbientStep",e[e.SetAmbientRate=72]="SetAmbientRate",e[e.SetAmbientLight=73]="SetAmbientLight",e[e.NukeStrike=95]="NukeStrike",e[e.PlaySoundFxAt=99]="PlaySoundFxAt",e[e.UnrevealAroundWaypoint=101]="UnrevealAroundWaypoint",e[e.LightningStrike=102]="LightningStrike",e[e.TimerText=103]="TimerText",e[e.CreateCrate=108]="CreateCrate",e[e.IronCurtainAt=109]="IronCurtainAt",e[e.EvictOccupiers=111]="EvictOccupiers",e[e.Cheer=113]="Cheer",e[e.StopSoundsAt=116]="StopSoundsAt",t("TriggerActionType",i)}}}),System.register("data/map/trigger/TriggerAction",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/map/trigger/Trigger",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/map/tag/TagsReader",["data/map/tag/TagRepeatType"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("TagsReader",i=class{read(e){let t=[];for(var[i,r]of e.entries){var s=r.split(",");s.length<3?console.warn(`Invalid tag ${i}=${r}. Skipping.`):(r=Number(s[0]),void 0!==a.TagRepeatType[r]?(s={id:i,repeatType:r,name:s[1],triggerId:s[2]},t.push(s)):console.warn(`Invalid repeat value ${r} for tag id ${i}. Skipping.`))}return t}})}}}),System.register("data/map/trigger/TriggerReader",["data/map/trigger/TriggerEventType","data/map/trigger/TriggerActionType"],function(e,t){"use strict";var h,c,i;t&&t.id;return{setters:[function(e){h=e},function(e){c=e}],execute:function(){e("TriggerReader",i=class{read(e,t,i,r){let s=this.readTriggers(e),{events:a,unknownEventTypes:n}=this.readEvents(t),{actions:o,unknownActionTypes:l}=this.readActions(i),c=[...r.values()],h=new Set(s);for(let p of s.values()){var u=a.get(p.id);u&&p.events.push(...u);u=o.get(p.id);u&&p.actions.push(...u),!p.attachedTriggerId||(u=s.find(e=>e.id===p.attachedTriggerId))&&(p.attachedTrigger=u,h.delete(u))}for(let m of h){var d=c.find(e=>e.triggerId===m.id);if(d){let e=m;for(;e;)e.tag=d,e=e.attachedTrigger}else{let e=m;for(;e;){console.warn(`Trigger ${e.id} has no associated tag or valid root trigger. Skipping.`);var g=s.indexOf(e);-1!==g&&s.splice(g,1),e=e.attachedTrigger}}}return{triggers:s,unknownEventTypes:n,unknownActionTypes:l}}readTriggers(e){let t=[];for(var[i,r]of e.entries){var s=r.split(",");s.length<8?console.warn(`Invalid trigger ${i}=${r}. Skipping.`):(s={id:i,houseName:s[0],attachedTriggerId:"<none>"!==s[1]?s[1]:void 0,attachedTrigger:void 0,name:s[2],disabled:Boolean(Number(s[3])),difficulties:{easy:Boolean(Number(s[4])),medium:Boolean(Number(s[5])),hard:Boolean(Number(s[6]))},events:[],actions:[],tag:void 0},t.push(s))}return t}readEvents(e){let s=new Map,a=new Set;for(var[n,t]of e.entries){let r=t.split(",");if(r.length<4)console.warn(`Invalid event ${n}=${t}. Skipping.`);else{var o=Number(r.shift());let t=[];for(let i=0;i<o;i++){var l=Number(r.shift()),c=Number(r.shift());let e=r.splice(0,2===c?2:1);void 0!==h.TriggerEventType[l]?(c={triggerId:n,eventIndex:i,type:l,params:[c,...e.map(e=>e||"0")]},t.push(c)):(a.add(l),console.warn(`Unknown event type ${l} for trigger id ${n}. Skipping.`))}s.set(n,t)}}return{events:s,unknownEventTypes:a}}readActions(e){let r=new Map,s=new Set;for(var[a,t]of e.entries){let i=t.split(",");if(i.length<9)console.warn(`Invalid action ${a}=${t}. Skipping.`);else{var n=Number(i.shift());if(i.length<8*n)console.warn(`Invalid action ${a}=${t}. Skipping.`);else{let e=[];for(let t=0;t<n;t++){var o=Number(i.shift()),l=i.splice(0,7);void 0!==c.TriggerActionType[o]?(l={triggerId:a,index:t,type:o,params:[Number(l[0]||"0"),l[1]||"0",l[2]||"0",l[3]||"0",l[4]||"0",l[5]||"0",l[6]?this.readAZActionParam(l[6]):0]},e.push(l)):(s.add(o),console.warn(`Unknown action type ${o} for trigger id "${a}". Skipping.`))}r.set(a,e)}}}return{actions:r,unknownActionTypes:s}}readAZActionParam(e){var t="Z".charCodeAt(0),i="A".charCodeAt(0),t=t-i+1;return 1<e.length?e.charCodeAt(1)-i+(e.charCodeAt(0)-i+1)*t:e.charCodeAt(0)-i}})}}}),System.register("data/map/MapLighting",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MapLighting",i=class{constructor(){this.level=0,this.ambient=1,this.red=1,this.green=1,this.blue=1,this.ground=0,this.forceTint=!1}read(e,t=""){return this.level=e.getNumber(t+"Level",.032),this.ambient=e.getNumber(t+"Ambient",1),this.red=e.getNumber(t+"Red",1),this.green=e.getNumber(t+"Green",1),this.blue=e.getNumber(t+"Blue",1),this.ground=e.getNumber(t+"Ground",0),this}copy(e){return this.level=e.level,this.ambient=e.ambient,this.red=e.red,this.green=e.green,this.blue=e.blue,this.ground=e.ground,this.forceTint=e.forceTint,this}})}}}),System.register("data/map/tag/CellTag",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("data/map/tag/CellTagsReader",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CellTagsReader",i=class{read(e,t){let i=[];for(var[r,s]of e.entries){r={tagId:s,coords:this.readCoords(Number(r),t)};i.push(r)}return i}readCoords(e,t){var i=t<4?128:1e3;return{x:e%i,y:Math.floor(e/i)}}})}}}),System.register("data/map/Variable",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Variable",i=class i{constructor(e,t){this.name=e,this.value=t}clone(){return new i(this.name,this.value)}})}}}),System.register("data/map/SpecialFlags",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SpecialFlags",i=class{read(e){return this.initialVeteran=e.getBool("InitialVeteran"),this}})}}}),System.register("data/MapFile",["data/mapObjects","data/IniFile","engine/TheaterType","util/string","data/encoding/Format5","data/Bitmap","data/map/tag/TagsReader","data/map/trigger/TriggerReader","data/DataStream","data/map/MapLighting","data/map/tag/CellTagsReader","data/map/Variable","data/map/SpecialFlags"],function(e,t){"use strict";var c,i,s,b,S,a,r,n,w,o,l,h,u,d;t&&t.id;return{setters:[function(e){c=e},function(e){i=e},function(e){s=e},function(e){b=e},function(e){S=e},function(e){a=e},function(e){r=e},function(e){n=e},function(e){w=e},function(e){o=e},function(e){l=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.IniFile{fromString(e){super.fromString(e);let t=this.getSection("Map");if(!t)throw new Error("[Map] section not found");var i=t.getNumberArray("Size");if(this.fullSize={x:i[0],y:i[1],width:i[2],height:i[3]},i=t.getNumberArray("LocalSize"),this.localSize={x:i[0],y:i[1],width:i[2],height:i[3]},this.theaterType=t.getEnum("Theater",s.TheaterType,s.TheaterType.None,!0),this.theaterType===s.TheaterType.None)throw new Error(`Unsupported theater type "${t.getString("Theater")}"`);let r=this.getSection("Basic");i=this.iniFormat=r?.getNumber("NewINIFormat")??0;return this.readTiles(),r?.getBool("MultiplayerOnly")&&this.readWaypoints(this.getOrCreateSection("Waypoints")),this.readStructures(this.getOrCreateSection("Structures")),this.readVehicles(),this.readInfantries(),this.readAircrafts(),this.readTerrains(this.getOrCreateSection("Terrain")),this.readOverlays(),this.readSmudges(),this.readLighting(),this.readTagsAndTriggers(),this.readCellTags(i),this.readVariableNames(),this.startingLocations=this.readStartingLocations(this.waypoints),this.specialFlags=(new u.SpecialFlags).read(this.getOrCreateSection("SpecialFlags")),this}readStartingLocations(e){let t=[];var i;for(i of e.filter(e=>e.number<8).sort((e,t)=>e.number<t.number?-1:1))t.push({x:i.rx,y:i.ry});return t}readLighting(){var e=this.getOrCreateSection("Lighting");this.lighting=(new o.MapLighting).read(e),this.ionLighting=(new o.MapLighting).read(e,"Ion"),this.ionLighting.forceTint=!0}readTagsAndTriggers(){this.tags=(new r.TagsReader).read(this.getOrCreateSection("Tags"));var e=this.getOrCreateSection("Triggers"),t=this.getOrCreateSection("Events"),i=this.getOrCreateSection("Actions"),{triggers:e,unknownEventTypes:t,unknownActionTypes:i}=(new n.TriggerReader).read(e,t,i,this.tags);this.triggers=e,this.unknownEventTypes=t,this.unknownActionTypes=i}readCellTags(e){this.cellTags=(new l.CellTagsReader).read(this.getOrCreateSection("CellTags"),e)}readVariableNames(){var e,t,i=this.getOrCreateSection("VariableNames");let r=new Map;for([e,t]of i.entries){var s,a,n=Number(e);Number.isNaN(n)?console.warn(`Map [VariableNames] contains non-numeric index "${e}". Skipping.`):([s,a]=t.split(","),a=new h.Variable(s,Boolean(Number(a))),r.set(n,a))}this.variables=r}readTiles(){let e=this.getSection("IsoMapPack5");if(!e)throw new Error("[IsoMapPack5] section not found");var t=b.base64StringToUint8Array(e.getConcatenatedValues()),i=(2*this.fullSize.width-1)*this.fullSize.height,r=new Uint8Array(11*i+4);S.Format5.decodeInto(t,r);let s=new w.DataStream(r.buffer),a=2*this.fullSize.width-1;var n,o,l,c,r=this.fullSize.height,h=(e,t)=>t*a+e;this.tiles=new Array(a*r);for(let T=this.maxTileNum=0;T<i;T++){var u=s.readUint16(),d=s.readUint16(),g=Math.max(0,s.readInt16());this.maxTileNum=Math.max(this.maxTileNum,g),s.readInt16();var p=s.readUint8(),m=s.readUint8();s.readUint8();var f=u-d+this.fullSize.width-1,y=u+d-this.fullSize.width-1;0<=f&&f<2*this.fullSize.width&&0<=y&&y<2*this.fullSize.height&&(p={dx:f,dy:y,rx:u,ry:d,z:m,tileNum:g,subTile:p},this.tiles[h(f,Math.floor(y/2))]=p)}for(let v=0;v<this.fullSize.height;v++)for(let e=0;e<=2*this.fullSize.width-2;e++)null==this.tiles[h(e,v)]&&(n=e,c=(o=2*v+e%2)-(l=(n+o)/2+1)+this.fullSize.width+1,this.tiles[h(e,v)]={dx:n,dy:o,rx:l,ry:c,z:0,tileNum:0,subTile:0})}readWaypoints(e){this.waypoints=[];for(var[t,i]of e.entries){var r;let e;isNaN(r=parseInt(t,10))||isNaN(e=parseInt(i,10))||(t=Math.floor(e/1e3),i=e-1e3*t,this.waypoints.push({number:r,rx:i,ry:t}))}}readStructures(e){this.structures=[];for(var[,t]of e.entries){t=t.split(",");if(!(t.length<=15)){let e=new c.Structure;e.owner=t[0],e.name=t[1],e.health=Number(t[2]),e.rx=Number(t[3]),e.ry=Number(t[4]),e.tag=this.readTagId(t[6]),e.poweredOn=Boolean(Number(t[9])),this.structures.push(e)}}}readTagId(e){return"none"!==e.toLowerCase()?e:void 0}readVehicles(){this.vehicles=[];let e=this.getSection("Units");if(e)for(var t of e.entries.values()){var i=t.split(",");if(i.length<=11)console.warn(`Invalid Vehicle entry: "${t}"`);else{let e=new c.Vehicle;e.owner=i[0],e.name=i[1],e.health=Number(i[2]),e.rx=Number(i[3]),e.ry=Number(i[4]),e.direction=Number(i[5]),e.tag=this.readTagId(i[7]),e.veterancy=Number(i[8]),e.onBridge="1"===i[10],this.vehicles.push(e)}}}readInfantries(){this.infantries=[];let e=this.getSection("Infantry");if(e)for(var t of e.entries.values()){var i=t.split(",");let e=new c.Infantry;i.length<=8?console.warn(`Invalid Infantry entry: "${t}"`):(e.owner=i[0],e.name=i[1],e.health=Number(i[2]),e.rx=Number(i[3]),e.ry=Number(i[4]),e.subCell=Number(i[5]),e.direction=Number(i[7]),e.tag=this.readTagId(i[8]),e.veterancy=Number(i[9]),e.onBridge="1"===i[11],this.infantries.push(e))}}readAircrafts(){this.aircrafts=[];let e=this.getSection("Aircraft");if(e)for(var t of e.entries.values()){t=t.split(",");let e=new c.Aircraft;e.owner=t[0],e.name=t[1],e.health=Number(t[2]),e.rx=Number(t[3]),e.ry=Number(t[4]),e.direction=Number(t[5]),e.tag=this.readTagId(t[7]),e.veterancy=Number(t[8]),e.onBridge="1"===t[t.length-4],this.aircrafts.push(e)}}readTerrains(e){this.terrains=[];for(var[t,i]of e.entries){t=Number(t);if(!isNaN(t)){let e=new c.Terrain;e.name=i,e.rx=t%1e3,e.ry=Math.floor(t/1e3),this.terrains.push(e)}}}readOverlays(){this.overlays=[],this.maxOverlayId=0;let t=this.getSection("OverlayPack");if(t){var i=b.base64StringToUint8Array(t.getConcatenatedValues()),r=new Uint8Array(1<<18);S.Format5.decodeInto(i,r,80);let e=this.getSection("OverlayDataPack");if(e){var i=b.base64StringToUint8Array(e.getConcatenatedValues()),s=new Uint8Array(1<<18);S.Format5.decodeInto(i,s,80);for(let t=0;t<this.fullSize.height;t++)for(let e=2*this.fullSize.width-2;0<=e;e--){var a=e,n=2*t+e%2,o=(a+n)/2+1,l=n-o+this.fullSize.width+1,a=o+512*l,n=r[a];if(255!==n){a=s[a];let e=new c.Overlay;e.id=n,e.value=a,e.rx=o,e.ry=l,this.overlays.push(e),this.maxOverlayId=Math.max(this.maxOverlayId,n)}}}else console.warn("[OverlayDataPack] section not found. Skipping.")}else console.warn("[Overlay] section not found. Skipping.")}readSmudges(){this.smudges=[];let e=this.getSection("Smudge");if(e)for(var t of e.entries.values()){t=t.split(",");if(t.length<=2)console.warn(`Invalid Smudge entry: "${t}"`);else{let e=new c.Smudge;e.name=t[0],e.rx=Number(t[1]),e.ry=Number(t[2]),this.smudges.push(e)}}}decodePreviewImage(){let e=this.getSection("Preview"),t=this.getSection("PreviewPack");if(e&&t){var[,,i,r]=e.getArray("Size").map(e=>Number(e)),s=b.base64StringToUint8Array(t.getConcatenatedValues()),r=new a.RgbBitmap(i,r);return S.Format5.decodeInto(s,r.data),r}}},e("MapFile",d)}}}),System.register("game/map/MapBounds",["util/geometry","game/Coords","util/event"],function(e,t){"use strict";var s,a,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){i=e}],execute:function(){e("MapBounds",r=class{constructor(){this.mapCutoffHeight=0,this.mapBuildableSize={x:0,y:0,width:0,height:0},this.localSize={x:0,y:0,width:0,height:0},this.fullSize={width:0,height:0},this.clampedFullSize={x:0,y:0,width:0,height:0},this.rawLocalSize={x:0,y:0,width:0,height:0},this._onLocalResize=new i.EventDispatcher}get onLocalResize(){return this._onLocalResize.asEvent()}fromMapFile(e,t){this.fullSize={width:2*e.fullSize.width,height:2*e.fullSize.height},this.clampedFullSize={x:1,y:2,width:2*(e.fullSize.width-1)-1/a.Coords.ISO_TILE_SIZE,height:2*(e.fullSize.height-1)+1-1/a.Coords.ISO_TILE_SIZE},this.mapCutoffHeight=Math.max(9,t.getCutoffTileHeight());var i=Math.max(2,e.localSize.x),i={x:i,y:e.localSize.y,width:Math.min(e.fullSize.width-2-i,e.localSize.width),height:e.localSize.height};return this.updateRawLocalSize(i),this}updateRawLocalSize(e){this.rawLocalSize.width&&this.rawLocalSize.height&&!s.rectContainsRect(e,this.rawLocalSize)?console.warn("New map limits must be outside old limits. Skipping."):s.rectEquals(e,this.rawLocalSize)||(this.localSize=this.computeLocalSize(e,this.fullSize.height/2,this.mapCutoffHeight),this.rawLocalSize={...e},this.mapBuildableSize={x:this.localSize.x,y:this.localSize.y+4,width:this.localSize.width-2,height:this.localSize.height-8},this._onLocalResize.dispatch(this))}computeLocalSize(e,t,i){return{x:2*e.x,y:2*e.y-4,height:Math.min(2*(e.height+5)-1,2*t-2*(e.y-3)-i),width:2*e.width}}getLocalSize(){return this.localSize}getRawLocalSize(){return this.rawLocalSize}getFullSize(){return this.fullSize}getClampedFullSize(){return this.clampedFullSize}isWithinBounds(e){return s.rectContainsPoint(this.mapBuildableSize,{x:e.dx,y:e.dy-e.z})}clampWithinBounds(e){let{x:t,y:i}=s.rectClampPoint(this.mapBuildableSize,{x:e.dx,y:e.dy-e.z});return i+=t%2-i%2,i>this.mapBuildableSize.y+this.mapBuildableSize.height&&(i-=2),{dx:t,dy:i}}isWithinHardBounds(e){var t=e.x/a.Coords.LEPTONS_PER_TILE,i=(e.z??e.y)/a.Coords.LEPTONS_PER_TILE,r=t-i+this.fullSize.width/2-1,i=t+i-this.fullSize.width/2-1;return s.rectContainsPoint(this.clampedFullSize,{x:++r,y:++i})}})}}}),System.register("game/map/tileFinder/DirectionalTileFinder",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("DirectionalTileFinder",i=class{constructor(e,t,i,r,s,a,n,o=()=>!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.maxDistance=s,this.dirX=a,this.dirY=n,this.predicate=o,this.finished=!1,this.distance=r}getNextTile(){if(!this.finished){let t;do{let e={x:this.startTile.rx,y:this.startTile.ry};e.x+=this.distance*Math.sign(this.dirX),e.y+=this.distance*Math.sign(this.dirY);var i=this.tiles.getByMapCoords(e.x,e.y);if(i&&this.mapBounds.isWithinBounds(i)&&this.predicate(i)&&(t=i),this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,t}while(this.distance++,!t);return t}}})}}}),System.register("game/map/tileFinder/RadialTileFinder",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RadialTileFinder",i=class{constructor(e,t,i,r,s,a,n,o=!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.foundation=r,this.maxDistance=a,this.predicate=n,this.checkBounds=o,this.distance=s,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var r=(e,t)=>{var i=this.tiles.getByMapCoords(e,t);if(i&&(!this.checkBounds||this.mapBounds.isWithinBounds(i))&&this.predicate(i))return i};do{var s=this.startTile.rx-this.distance,a=this.startTile.ry-this.distance,n=this.startTile.rx+this.foundation.width-1+this.distance,o=this.startTile.ry+this.foundation.height-1+this.distance;let e,t,i;if(0<this.distance){for(e=n;e>=s;e--)i=r(e,o),i&&(yield i);for(t=o-1;t>=a;t--)i=r(n,t),i&&(yield i);for(e=s;e<n;e++)i=r(e,a),i&&(yield i);for(t=1+a;t<o;t++)i=r(s,t),i&&(yield i)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}}),System.register("game/map/Bridges",["game/map/TileCollection","game/map/BridgeOverlayTypes","game/map/tileFinder/DirectionalTileFinder","game/map/tileFinder/RadialTileFinder","game/theater/TileSets","engine/type/TerrainType","game/math/Vector2"],function(t,e){"use strict";var n,f,y,T,v,o,s,b,i;e&&e.id;return{setters:[function(e){n=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){o=e},function(e){s=e}],execute:function(){var e;(e=b=b||{})[e.None=0]="None",e[e.Start=1]="Start",e[e.End=2]="End",t("BridgeHeadType",b),t("Bridges",i=class{constructor(e,t,i,r,s){this.tileSets=e,this.tiles=t,this.tileOccupation=i,this.mapBounds=r,this.rules=s,this.pieces=new Set,this.piecesByTile=new Map,this.handleTileOccupationUpdate=({object:t,type:i})=>{if(t.isOverlay()&&t.isBridge()){var r=t.tile;let e=this.piecesByTile.get(r);if("added"===i){if(e)throw new Error(`A bridge piece already exists at tile (${r.rx},${r.ry})`);var s=this.findBridgeAdjacentTiles(t);e={obj:t,prev:void 0,next:void 0,headType:this.computeHead(t,s.prev,s.next)},this.piecesByTile.set(r,e),this.pieces.add(e),this.connectPiece(e,s.prev,s.next),this.updateOverlayData(e),e.prev&&this.updateOverlayData(e.prev),e.next&&this.updateOverlayData(e.next)}else{if(!e)throw new Error(`Bridge piece was alredy removed at tile (${r.rx},${r.ry})`);var a=e.prev,s=e.next;this.disconnectPiece(e),this.piecesByTile.delete(r),this.pieces.delete(e),a&&this.updateOverlayData(a),s&&this.updateOverlayData(s)}}},i.onChange.subscribe(this.handleTileOccupationUpdate)}getPieceAtTile(e){return this.piecesByTile.get(e)}handlePieceHealthChange(e){this.updateOverlayData(e),e.prev&&this.updateOverlayData(e.prev),e.next&&this.updateOverlayData(e.next)}findDominoPieces(t){let i=[],r=!1,e=t.next;if(t.headType===b.None||e)for(;e;){if(i.push(e),e.headType!==b.None){r=!0;break}e=e.next}else r=!0;if(r){r=!1,i.length=0;let e=t.prev;if(t.headType===b.None||e)for(;e;){if(i.push(e),e.headType!==b.None){r=!0;break}e=e.prev}else r=!0;if(r)return[]}return i}findBridgeAdjacentTiles(e){var t=e.isXBridge(),i=new s.Vector2(Number(t),Number(!t));let r=new s.Vector2(e.tile.rx,e.tile.ry);t=r.clone().sub(i),t=this.tiles.getByMapCoords(t.x,t.y),i=r.clone().add(i);return{prev:t,next:this.tiles.getByMapCoords(i.x,i.y)}}connectPiece(e,t,i){t&&(e.prev=this.getPieceAtTile(t),e.prev&&(e.prev.next=e)),i&&(e.next=this.getPieceAtTile(i),e.next&&(e.next.prev=e))}disconnectPiece(e){e.next&&(e.next.prev=void 0,e.next=void 0),e.prev&&(e.prev.next=void 0,e.prev=void 0)}computeHead(e,t,i){var r=e.tile;if(e.isHighBridge()){r=r.z+e.tileElevation;return t?.z===r?b.Start:i?.z===r?b.End:b.None}return f.BridgeOverlayTypes.isLowBridgeHead(e.overlayId)?f.BridgeOverlayTypes.isLowBridgeHeadStart(e.overlayId)?b.Start:b.End:b.None}updateOverlayData(t){let i=t.obj,r=t.prev,s=t.next,a=!1;var n=i.isXBridge(),o=f.BridgeOverlayTypes.getOverlayBridgeType(i.overlayId);if(f.BridgeOverlayTypes.isLowBridgeHead(i.overlayId)){let e=0;f.BridgeOverlayTypes.isLowBridgeHeadStart(i.overlayId)?(e=n?20:22,s||e++):(e=n?18:24,r||e++),i.overlayId=(o===f.OverlayBridgeType.Wood?f.BridgeOverlayTypes.minLowBridgeWoodId:f.BridgeOverlayTypes.minLowBridgeConcreteId)+e,i.value=e,a=!0}else{let e;var l,c,h=(i.healthTrait?.health??100)<=50;e=t.headType!==b.None?t.headType===b.Start?s?h?6:(s.obj.healthTrait?.health??100)<=50?5:0:n?8:7:r?h?6:(r.obj.healthTrait?.health??100)<=50?4:0:n?7:8:(n||(c=r,r=s,s=c),r||s?r?s?(l=(r.obj.healthTrait?.health??100)<=50,c=(s.obj.healthTrait?.health??100)<=50,h||l&&c?6:l?4:c?5:0):8:7:0),n||(e+=9),i.isHighBridge()?i.value=e:(i.overlayId=(o===f.OverlayBridgeType.Wood?f.BridgeOverlayTypes.minLowBridgeWoodId:f.BridgeOverlayTypes.minLowBridgeConcreteId)+e,i.value=e,a=!0)}a&&(i.name=this.rules.getOverlayName(i.overlayId))}findClosestBridgeSpec(i){let e=new T.RadialTileFinder(this.tiles,this.mapBounds,i,{width:1,height:1},1,3,e=>{if(e.z!==i.z)return!1;let t=this.tileOccupation.getBridgeOnTile(e);return!(!t?.isLowBridge()||this.getPieceAtTile(t.tile)?.headType===b.None)||!!this.tileSets.isHighBridgeBoundaryTile(e.tileNum)});var o=e.getNextTile();if(o){let r,t,s,a;var l=!this.tileOccupation.getBridgeOnTile(o);let e;if(l){var c=this.findHighBridgeBoundary(o);if(!c)return;r=c.tile,t=f.OverlayBridgeType.Concrete,this.tileSets.getSetNum(o.tileNum)===this.tileSets.getGeneralValue("WoodBridgeSet")&&(t=f.OverlayBridgeType.Wood),s=c.headType===v.HighBridgeHeadType.TopLeft||c.headType===v.HighBridgeHeadType.BottomRight,a=c.headType===v.HighBridgeHeadType.TopLeft||c.headType===v.HighBridgeHeadType.TopRight,e=c.headType}else{r=this.tileOccupation.getBridgeOnTile(o).tile;let e=this.getPieceAtTile(r);if(!e)throw new Error("Bridge head is not defined");var h=f.BridgeOverlayTypes.getOverlayBridgeType(e.obj.overlayId);if(h===f.OverlayBridgeType.NotBridge)throw new Error("Expected a bridge type");t=h,s=e.obj.isXBridge(),a=e.headType===b.Start}var u=Number(s)*(a?1:-1),d=Number(!s)*(a?1:-1);let n;if(l){o=new y.DirectionalTileFinder(this.tiles,this.mapBounds,r,1,100,u,d,e=>e.z===r.z&&this.tileSets.isHighBridgeBoundaryTile(e.tileNum)).getNextTile(),h=this.tileSets.getSetNum(r.tileNum);if(!o||this.tileSets.getSetNum(o.tileNum)!==h)return;o=this.findHighBridgeBoundary(o);if(!o)return;if(e!==this.tileSets.getOppositeHighBridgeHeadType(o.headType))return;n=o.tile}else{let t,i=1;for(var g=r.rx,p=r.ry;!t;){var m=this.tiles.getByMapCoords(g+u*i,p+d*i);if(!m)return;let e=this.getPieceAtTile(m);if(e&&e.obj.isXBridge()!==s)return;e?.headType===(a?b.End:b.Start)&&(t=e),i++}n=t.obj.tile}return{start:a?r:n,end:a?n:r,type:t,isHigh:l}}}findHighBridgeBoundary(s){var a,e=this.tileSets.getTile(s.tileNum),n=this.tileSets.getHighBridgeHeadType(e.index);if(void 0!==n){let i=0,r=0;switch(n){case v.HighBridgeHeadType.TopLeft:i=1,r=0;break;case v.HighBridgeHeadType.BottomRight:i=-1,r=0;break;case v.HighBridgeHeadType.TopRight:i=0,r=1;break;case v.HighBridgeHeadType.BottomLeft:i=0,r=-1;break;case v.HighBridgeHeadType.MiddleTlBr:i=1,r=0;break;case v.HighBridgeHeadType.MiddleTrBl:i=0,r=1;break;default:throw new Error(`Unhandled head type "${n}"`)}let e=new T.RadialTileFinder(this.tiles,this.mapBounds,s,{width:1,height:1},0,5,e=>e.terrainType===o.TerrainType.Pavement&&e.z>=s.z&&e.tileNum===s.tileNum),t=[];for(;a=e.getNextTile();)t.push(a);if(t.sort((e,t)=>100*(i?i*(t.rx-e.rx):r*(t.ry-e.ry))+(i?e.ry-t.ry:e.rx-t.rx)),t.length)return{tile:t[0],headType:n}}else console.warn(`Couldn't find a valid bridge type for index "${e.index}" @ ${s.rx},`+s.ry)}canBeRepaired(i){let e=this.createBridgePieceTileFinder(i,e=>!(this.getPieceAtTile(e)||this.tileSets.isHighBridgeMiddleTile(e.tileNum)&&e.z===i.start.z)),r=!1,s;for(var a=i.start.rx!==i.end.rx?n.TileDirection.BottomLeft:n.TileDirection.BottomRight;s=e.getNextTile();){r=!0;let e=this.tiles.getNeighbourTile(s,a),t=this.tiles.getNeighbourTile(e,a);if(i.isHigh){if([s,e,t].find(e=>this.tileOccupation.getGroundObjectsOnTile(e).some(e=>e.isBuilding()&&!e.rules.invisibleInGame)))return!1}else if([s,e,t].find(e=>this.tileOccupation.getGroundObjectsOnTile(e).some(e=>!(e.isUnit()||e.isSmudge()||e.isOverlay()&&e.isBridgePlaceholder()))))return!1}return r}getPieceTiles(e){var t=e.obj.tile,i=e.obj.isXBridge()?n.TileDirection.BottomLeft:n.TileDirection.BottomRight,r=this.tiles.getNeighbourTile(t,i);return[t,r,this.tiles.getNeighbourTile(r,i)]}findMapHighBridgeHeadTiles(){var e,t=this.tiles.getAllBridgeSetTiles();let i=new Set;for(e of t){var r=this.findHighBridgeBoundary(e);r&&i.add(r.tile)}return i}findBridgeSpecsForHeadTiles(e){let t=new Map;for(var i of e){i=this.findClosestBridgeSpec(i);i&&t.set(i.start.id+":"+i.end.id,i)}return[...t.values()]}findAllBridgeTiles(e){let t=[];var i,r=e.start.rx!==e.end.rx?n.TileDirection.BottomLeft:n.TileDirection.BottomRight;for(i of this.findNonBuildablePieceTiles(e)){var s=this.tiles.getNeighbourTile(i,r),a=this.tiles.getNeighbourTile(s,r);t.push(i,s,a)}return t}findBridgePieces(e){let t=this.createBridgePieceTileFinder(e,e=>!!this.getPieceAtTile(e)),i=[];for(var r;r=t.getNextTile();)i.push(this.getPieceAtTile(r));return i}findDestroyedPieceTiles(t){let e=this.createBridgePieceTileFinder(t,e=>!(this.getPieceAtTile(e)||this.tileSets.isHighBridgeMiddleTile(e.tileNum)&&e.z===t.start.z)),i=[];for(var r;r=e.getNextTile();)i.push(r);return i}findNonBuildablePieceTiles(t){let e=this.createBridgePieceTileFinder(t,e=>!(this.tileSets.isHighBridgeMiddleTile(e.tileNum)&&e.z===t.start.z)),i=[];for(var r;r=e.getNextTile();)i.push(r);return i}createBridgePieceTileFinder(e,t){var i=e.start.rx!==e.end.rx;return new y.DirectionalTileFinder(this.tiles,this.mapBounds,e.start,1,(i?e.end.rx-e.start.rx:e.end.ry-e.start.ry)-1,Number(i),Number(!i),t)}dispose(){this.pieces.forEach(e=>{e.prev=void 0,e.next=void 0}),this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}})}}}),System.register("util/QuadTree",[],function(e,t){"use strict";var n,a;t&&t.id;return{setters:[],execute:function(){n=new THREE.Vector2,e("QuadTree",a=class a{constructor(e,t){this.box=e,this.config=t,this.parentMap=new Map,this.objects=[]}add(e,t=!0){var i=this.config.getKey(e);if(this.box.containsPoint(i)){if(!this.regions)return this.parentMap.get(e)?.remove(e),this.parentMap.set(e,this),this.objects.push({key:i,value:e}),t&&this.update(),!0;for(var r of this.regions)if(r.add(e,t))return!0}return!1}remove(t,e=!0){let i=this.parentMap.get(t);i&&(i===this?(this.parentMap.delete(t),this.objects.splice(this.objects.findIndex(e=>e.value===t),1),e&&this.parent?.update()):i.remove(t,e))}updateObject(t){let i=this.parentMap.get(t);if(i){var e=this.config.getKey(t);if(i.box.containsPoint(e))i.objects.find(e=>e.value===t).key=e;else{i.remove(t,!1);let e=i.parent;for(;e&&!e.add(t,!1);)e=e.parent}}}queryRange(e,t=[]){if(this.box.intersectsBox(e))if(this.regions)for(var i of this.regions)i.queryRange(e,t);else for(var r of this.objects)e.containsPoint(r.key)&&t.push(r.value);return t}update(){let e=0;if(this.regions){for(var t of this.regions)e+=t.update();e<=this.config.joinThreshold&&this.join()}else e=this.objects.length,e>=this.config.splitThreshold&&this.split()&&this.update();return e}split(){if(this.regions||this.config.maxDepth<=1)return!1;var t,e,i={getKey:this.config.getKey,joinThreshold:this.config.joinThreshold,splitThreshold:this.config.splitThreshold,maxDepth:this.config.maxDepth-1},r=this.generateRegions(),s=this.objects;this.objects=[],this.regions=[];for(t of r){let e=new a(t,i);e.parentMap=this.parentMap,this.regions.push(e),e.parent=this}for(e of s)this.parentMap.delete(e.value),this.add(e.value,!1);return!0}join(){if(!this.regions)return!1;for(var e of this.regions){e.join(),e.parent=void 0;for(var t of e.objects)this.objects.push(t),this.parentMap.set(t.value,this)}return!(this.regions=void 0)}generateRegions(){let e=[this.box.clone()];var t=this.box.getCenter(n);let i=e[0],r=i.clone();i.max.x=t.x,r.min.x=t.x,e.push(r);for(let s=0,a=e.length;s<a;s++)i=e[s],r=i.clone(),i.max.y=t.y,r.min.y=t.y,e.push(r);return e}})}}}),System.register("game/map/TileOcclusion",["game/math/Vector2"],function(e,t){"use strict";var m,i;t&&t.id;return{setters:[function(e){m=e}],execute:function(){e("TileOcclusion",i=class{constructor(e){this.tiles=e,this.tileOcclusion=[];let t=this.tileOcclusion;for(var i of e.getAll())t[i.rx]=t[i.rx]||[],t[i.rx][i.ry]=new Set}addOccluder(t){let e=this.calculateTilesForGameObject(t);e.forEach(e=>this.occludeTile(e,t))}removeOccluder(t){let e=this.calculateTilesForGameObject(t);e.forEach(e=>this.unoccludeTile(e,t))}calculateTilesForGameObject(e){var t=e.art.occupyHeight,i=Math.max(0,t-2);let r=[];var s=e.getFoundation();for(let u=1;u<=i;u++)for(let e=0;e<s.width;e++)r.push(new m.Vector2(e-u,-u));for(let d=1;d<=i;d++)for(let e=1;e<s.height;e++)r.push(new m.Vector2(-d,e-d));r.push(...e.art.addOccupy);for(let{x:g,y:p}of e.art.removeOccupy){var a=r.findIndex(e=>e.x===g&&e.y===p);-1!==a&&r.splice(a,1)}var n,o,l=e.tile;let c=[];for({x:n,y:o}of r){var h=this.tiles.getByMapCoords(l.rx+n,l.ry+o);h&&c.push(h)}return c}occludeTile(e,t){this.tileOcclusion[e.rx][e.ry].add(t),e.occluded=!0}unoccludeTile(e,t){let i=this.tileOcclusion[e.rx][e.ry];i.delete(t),e.occluded=0<i.size}isTileOccluded(e){return 0<this.tileOcclusion[e.rx][e.ry].size}})}}}),System.register("game/theater/AutoLat",["game/map/TileCollection"],function(e,t){"use strict";var p,i;t&&t.id;return{setters:[function(e){p=e}],execute:function(){e("AutoLat",i=class{static calculate(u,d){let g=new Map;u.forEach(e=>{var t=d.getSetNum(e.tileNum);g.set(e,t),d.isCLAT(t)&&(t=d.getLAT(t),g.set(e,t),e.tileNum=d.getTileNumFromSet(t))}),u.forEach(t=>{var i=g.get(t);if(d.isLAT(i)){let e=0;var r=u.getNeighbourTile(t,p.TileDirection.TopRight),s=u.getNeighbourTile(t,p.TileDirection.BottomRight),a=u.getNeighbourTile(t,p.TileDirection.BottomLeft),n=u.getNeighbourTile(t,p.TileDirection.TopLeft);r&&d.canConnectTiles(i,g.get(r))&&(e+=1),s&&d.canConnectTiles(i,g.get(s))&&(e+=2),a&&d.canConnectTiles(i,g.get(a))&&(e+=4),n&&d.canConnectTiles(i,g.get(n))&&(e+=8),0<e&&(n=d.getCLATSet(i),t.tileNum=d.getTileNumFromSet(n,e))}else if(i===d.getGeneralValue("RampBase")&&!(t.rampType<1||4<t.terrainType)){let e=-1;var o=u.getNeighbourTile(t,p.TileDirection.TopRight),l=u.getNeighbourTile(t,p.TileDirection.BottomRight),c=u.getNeighbourTile(t,p.TileDirection.BottomLeft),h=u.getNeighbourTile(t,p.TileDirection.TopLeft);switch(t.rampType){case 1:h&&0===h.rampType&&e++,l&&0===l.rampType&&(e+=2);break;case 2:o&&0===o.rampType&&e++,c&&0===c.rampType&&(e+=2);break;case 3:l&&0===l.rampType&&e++,h&&0===h.rampType&&(e+=2);break;case 4:c&&0===c.rampType&&e++,o&&0===o.rampType&&(e+=2)}-1!==e&&(t.tileNum=d.getTileNumFromSet(d.getGeneralValue("RampSmooth"),3*(t.rampType-1)+e))}})}})}}}),System.register("game/math/Box2",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends THREE.Box2{},e("Box2",i)}}}),System.register("game/GameMap",["game/map/TileCollection","game/map/TileOccupation","game/map/Terrain","game/map/MapBounds","game/map/Bridges","util/QuadTree","game/map/TileOcclusion","game/theater/AutoLat","engine/TheaterType","game/math/Vector2","game/math/Box2"],function(e,t){"use strict";var l,c,h,u,d,g,p,m,f,y,T,i;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){e("GameMap",i=class{constructor(e,t,i,r){this.mapFile=e,this.tiles=new l.TileCollection(this.mapFile.tiles,t,i.general,r),this.mapBounds=(new u.MapBounds).fromMapFile(this.mapFile,this.tiles),this.tileOccupation=new c.TileOccupation(this.tiles),this.tileOcclusion=new p.TileOcclusion(this.tiles),this.terrain=new h.Terrain(this.tiles,this.mapFile.theaterType,this.mapBounds,this.tileOccupation,i),this.bridges=new d.Bridges(t,this.tiles,this.tileOccupation,this.mapBounds,i);let s=this.mapFile.tags;for(let o of this.mapFile.cellTags){let e=this.tiles.getByMapCoords(o.coords.x,o.coords.y);e&&(e.tag=s.find(e=>e.id===o.tagId))}var a=this.tiles.getMapSize(),n=Math.max(a.width,a.height)/5;this.technosByTile=new g.QuadTree(new T.Box2(new y.Vector2(0,0),new y.Vector2(a.width,a.height)),{getKey:e=>{var t=e.isBuilding()?e.centerTile:e.tile;return new y.Vector2(t.rx,t.ry)},maxDepth:this.computeQuadDepth(n),splitThreshold:10,joinThreshold:5}),this.mapFile.theaterType!==f.TheaterType.Snow&&m.AutoLat.calculate(this.tiles,t)}get startingLocations(){return this.mapFile.startingLocations}computeQuadDepth(e){if(e<=1)return 1;let t=0;for(;1<=e/2;)e/=2,t++;return t+(1<e?1:0)}getLighting(){return this.mapFile.lighting}getIonLighting(){return this.mapFile.ionLighting}getTheaterType(){return this.mapFile.theaterType}getTags(){return this.mapFile.tags}getTriggers(){return this.mapFile.triggers}getCellTags(){return this.mapFile.cellTags}getVariables(){return this.mapFile.variables}getWaypoint(t){return this.mapFile.waypoints.find(e=>e.number===t)}getTileAtWaypoint(e){var t=this.getWaypoint(e);if(t){t=this.tiles.getByMapCoords(t.rx,t.ry);if(t)return t}}isWithinBounds(e){return this.mapBounds.isWithinBounds(e)}clampWithinBounds(e){var t=this.mapBounds.clampWithinBounds(e);let i=this.tiles.getByDisplayCoords(t.dx,t.dy);if(i&&this.mapBounds.isWithinBounds(i)){let e=i;for(;e&&this.mapBounds.isWithinBounds(e);)i=e,e=this.tiles.getByDisplayCoords(e.dx,e.dy+2)}else{let e=0;for(;!i||!this.mapBounds.isWithinBounds(i);){if(30<e)throw new Error("Exceeded max elevation while trying to clamp tile to map bounds");i=this.tiles.getByDisplayCoords(t.dx,t.dy+e),e+=2}}return i}isWithinHardBounds(e){return this.mapBounds.isWithinHardBounds(e)}getInitialMapObjects(){return{terrains:this.mapFile.terrains,overlays:this.mapFile.overlays,smudges:this.mapFile.smudges,technos:[...this.mapFile.structures,...this.mapFile.infantries,...this.mapFile.vehicles,...this.mapFile.aircrafts]}}getObjectsOnTile(e){return this.tileOccupation.getObjectsOnTile(e)}getGroundObjectsOnTile(e){return this.tileOccupation.getGroundObjectsOnTile(e)}getTileZone(e,t=!1){return this.tileOccupation.getTileZone(e,t)}dispose(){this.terrain.dispose(),this.bridges.dispose()}})}}}),System.register("game/gameobject/unit/MovePositionHelper",["game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType"],function(e,t){"use strict";var g,p,m,i;t&&t.id;return{setters:[function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("MovePositionHelper",i=class{constructor(e){this.map=e}findPositions(e,r,s){let a=new Map,t=this.clusterObjects(e);if(!t.length)throw new Error("We should have found at least one cluster");let i=t.reduce((e,t)=>t.objects.size>e.objects.size?t:e,t[0]);t.splice(t.indexOf(i),1);let n=[],o=this.findCenterTile([...i.objects]);i.objects.forEach(t=>{var i=this.map.tiles.getByMapCoords(r.rx+t.tile.rx-o.rx,r.ry+t.tile.ry-o.ry),e=i?.onBridgeLandType?this.map.tileOccupation.getBridgeOnTile(i):void 0;if(!i||!this.map.mapBounds.isWithinBounds(i)||a.has(i)&&!this.tileHasRoom(t,a.get(i))||t.rules.movementZone===p.MovementZone.Fly&&!t.rules.airportBound&&!this.map.terrain.getPassableSpeed(i,m.SpeedType.Amphibious,!!e)||t.rules.movementZone!==p.MovementZone.Fly&&!this.isEligibleTile(i,e,s,r))n.push(t);else{let e=a.get(i);void 0===e&&(e=[],a.set(i,e)),e.push(t)}}),t.forEach(e=>n.push(...e.objects));let l=new g.RadialTileFinder(this.map.tiles,this.map.mapBounds,r,{width:1,height:1},1,5,()=>!0),c;for(;n.length&&(c=l.getNextTile());){var h=n[0],u=this.map.tileOccupation.getBridgeOnTile(c);if((!a.has(c)||this.tileHasRoom(h,a.get(c)))&&((h.rules.movementZone!==p.MovementZone.Fly||h.rules.airportBound||this.map.terrain.getPassableSpeed(c,m.SpeedType.Amphibious,!!u))&&(h.rules.movementZone===p.MovementZone.Fly||this.isEligibleTile(c,u,s,r)))){let e=a.get(c);void 0===e&&(e=[],a.set(c,e)),e.push(n.shift())}}let d=new Map;if(a.forEach((e,t)=>{e.forEach(e=>d.set(e,t))}),n.forEach(e=>d.set(e,r)),d.size!==e.length)throw new Error("We should have computed a number of positions equal to the number of input objects");return d}tileHasRoom(e,t){if(e.isInfantry()){if(t.find(e=>!e.isInfantry()))return!1;var i=e.rules.movementZone===p.MovementZone.Fly?1:3;return t.filter(e=>e.isInfantry()).length>=i?!1:!0}return!t.length}isEligibleTile(e,t,i,r){return i?.isHighBridge()||t?.isHighBridge()?e.z+(t?.tileElevation??0)===r.z+(i?.tileElevation??0):!(!i&&!t)||Math.abs(e.z-r.z)<2}clusterObjects(e){let s=new Map;e.forEach(e=>{var t=e.tile.rx+"_"+e.tile.ry;s.set(t,[...s.get(t)||[],e])});let t=[],a=new Set(e);for(;a.size;){let e=new Set,r=[];var i=[...a][0].tile;for(s.get(i.rx+"_"+i.ry).forEach(e=>{r.push(e)});r.length;){var n=r.shift();e.add(n),a.delete(n);for(let i=-1;i<=1;i++)for(let t=-1;t<=1;t++)if(i||t){let e=s.get(n.tile.rx+i+"_"+(n.tile.ry+t));e&&e.length&&e.forEach(e=>{a.has(e)&&(a.delete(e),r.push(e))})}}t.push({objects:e})}return t}findCenterTile(e){let t=0,i=0;e.forEach(e=>{t+=e.tile.rx,i+=e.tile.ry}),t=Math.round(t/e.length),i=Math.round(i/e.length);let r=this.map.tiles.getByMapCoords(t,i);if(!r&&(r=e.find(e=>Math.abs(e.tile.rx-t)<=1&&Math.abs(e.tile.ry-i)<=1)?.tile,!r))throw new Error("At least one adjacent object should have been found");return r}})}}}),System.register("game/map/tileFinder/RandomTileFinder",["game/math/GameMath"],function(e,t){"use strict";var l,i;t&&t.id;return{setters:[function(e){l=e}],execute:function(){e("RandomTileFinder",i=class{constructor(e,t,i,r,s,a,n=!1,o=!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.maxDistance=r,this.rng=s,this.predicate=a,this.includeStartTile=n,this.checkBounds=o,this.pool=[],this.pool=new Array(l.GameMath.pow(2*this.maxDistance+1,2)).fill(0).map((e,t)=>t),this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){for(var e=(e,t)=>{var i=this.tiles.getByMapCoords(e,t);if(this.includeStartTile||i!==this.startTile)return i&&(!this.checkBounds||this.mapBounds.isWithinBounds(i))&&this.predicate(i)?i:void 0},t=2*this.maxDistance+1;this.pool.length;){var i=1<this.pool.length?this.rng.generateRandomInt(0,this.pool.length):0,r=this.pool.splice(i,1)[0],i=r%t,r=Math.floor(r/t),r=e(this.startTile.rx-this.maxDistance+i,this.startTile.ry-this.maxDistance+r);r&&(yield r)}}})}}}),System.register("game/gameobject/unit/ScatterPositionHelper",["game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RandomTileFinder"],function(e,t){"use strict";var i,u,r;t&&t.id;return{setters:[function(e){i=e},function(e){u=e}],execute:function(){e("ScatterPositionHelper",r=class{constructor(e){this.game=e,this.movePositionHelper=new i.MovePositionHelper(e.map)}findPositions(e,t){let i=new Set,r=new Map;for(var s of e){var a=this.findFreeMovePosition(s,i,t);a&&(r.set(s,a),i.add(a.tile))}return r}findFreeMovePosition(i,e,{ignoredBlockers:t,excludedTiles:r,noSlopes:s}={}){let a=this.game.map,n=i.onBridge?a.tileOccupation.getBridgeOnTile(i.tile):void 0,o=new u.RandomTileFinder(a.tiles,a.mapBounds,i.tile,1,this.game,e=>{if(r?.includes(e))return!1;var t=a.tileOccupation.getBridgeOnTile(e);return(t&&this.movePositionHelper.isEligibleTile(e,t,n,i.tile)||this.movePositionHelper.isEligibleTile(e,void 0,n,i.tile))&&(!s||0===e.rampType)}),l,c;for(;;){var h=o.getNextTile();if(!h)break;if(l=h,c=a.tileOccupation.getBridgeOnTile(h),c&&!this.movePositionHelper.isEligibleTile(h,c,n,i.tile)&&(c=void 0),!e.has(h)){let e=a.terrain.findObstacles({tile:h,onBridge:c},i);if(t&&t.length&&(e=e.filter(e=>!t.includes(e.obj))),!e.length)break}}if(l)return{tile:l,onBridge:c}}})}}}),System.register("game/gameobject/task/ScatterTask",["game/gameobject/task/move/MoveTask","game/gameobject/task/system/Task","game/gameobject/unit/ScatterPositionHelper","game/type/MovementZone"],function(e,t){"use strict";var s,i,a,n,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){a=e},function(e){n=e}],execute:function(){r=class extends i.Task{constructor(e,t,i){super(),this.game=e,this.target=t,this.options=i}onStart(i){if(!i.moveTrait.isDisabled()&&i.rules.movementZone!==n.MovementZone.Fly){let e,t;if(this.target)({tile:e,toBridge:t}=this.target);else{var r=new a.ScatterPositionHelper(this.game).findPositions([i],this.options).get(i);if(!r)return;e=r.tile,t=!!r.onBridge}this.children.push(new s.MoveTask(this.game,e,t,{closeEnoughTiles:0,ignoredBlockers:this.options?.ignoredBlockers}))}}onTick(e){return!0}},e("ScatterTask",r)}}}),System.register("game/trait/interface/NotifyAttack",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onAttack=Symbol(),e("NotifyAttack",i)}}}),System.register("game/gameobject/unit/CollisionType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Ground=1]="Ground",e[e.Wall=2]="Wall",e[e.Cliff=3]="Cliff",e[e.OnBridge=4]="OnBridge",e[e.UnderBridge=5]="UnderBridge",e[e.Shore=6]="Shore",t("CollisionType",i)}}}),System.register("game/Target",["game/Coords","game/type/LandType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Target",s=class{constructor(e,t,i){this.tileOccupation=i,this.isOre=!1,e?e.isOverlay()&&e.isBridge()?(this.bridge=e,this.tile=t):e.isOverlay()&&e.isTiberium()?(this.isOre=!0,this.tile=e.tile):(this.obj=e,this.tile=e.isBuilding()?e.centerTile:e.tile):(t.landType===r.LandType.Tiberium&&(this.isOre=!0),this.tile=t)}equals(e){return this.obj===e.obj&&this.tile===e.tile&&this.bridge===e.bridge&&this.isOre===e.isOre}getWorldCoords(){return this.obj?this.obj.position.worldPosition:i.Coords.tile3dToWorld(this.tile.rx+.5,this.tile.ry+.5,this.tile.z+(this.bridge?.tileElevation??0))}isBridge(){return!this.obj&&!!this.bridge}getBridge(){return this.bridge||(this.obj?.isUnit()&&this.obj.onBridge?this.tileOccupation.getBridgeOnTile(this.obj.tile):void 0)}})}}}),System.register("game/math/geometry",["util/math","game/math/GameMath","game/math/Matrix4","game/math/Quaternion","game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var r,s,i,a,n,o,l,c,h,u,d,g;t&&t.id;function p(e){return e*THREE.Math.RAD2DEG}function m(e){return e*THREE.Math.DEG2RAD}function f(e){return Math.round(p(e.angle()))}function y(e,t){var i=p(2*s.GameMath.acos(Math.abs(r.clamp(e.dot(t),-1,1))));return Math.round(i)}function T(e,t=new a.Quaternion){return t.setFromRotationMatrix(c.lookAt(e,h,u))}return e("radToDeg",p),e("degToRad",m),e("rotateVec2",function(e,t){var i=m(Math.floor(t));return e.rotateAround(l,i)}),e("angleDegFromVec2",f),e("angleDegBetweenVec2",function(e,t){var i=f(e),r=f(t);return Math.min((i-r+360)%360,(r-i+360)%360)}),e("angleDegBetweenVec3",function(e,t){return y(T(e,d),T(t,g))}),e("quaternionFromVec3",T),e("rotateVec3Towards",function(e,t,i){var r=e.length(),s=T(t,d),a=T(e,g);!function(e,t,i){var r=y(e,t);if(0!==r){r=Math.min(1,i/r);e.slerp(t,r)}}(a,s,i),e.set(0,0,1).applyQuaternion(a).setLength(r)}),{setters:[function(e){r=e},function(e){s=e},function(e){i=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=new n.Vector2,c=new i.Matrix4,h=new o.Vector3(0,0,0),u=new o.Vector3(0,1,0),d=new a.Quaternion,g=new a.Quaternion}}}),System.register("game/gameobject/unit/FacingUtil",["game/math/Vector2","game/math/geometry"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("FacingUtil",s=class s{static tick(e,t,i){if(e===t)return{facing:e,delta:0};var r=(e-t+360)%360,s=(t-e+360)%360;if(Math.min(r,s)<i)return{facing:t,delta:0};r=(s<=r?1:-1)*i;return{facing:(e+r+360)%360,delta:r}}static fromMapCoords(e){return(-r.angleDegFromVec2(e)-90+720)%360}static toMapCoords(e){return r.rotateVec2(new i.Vector2(1e3,0),s.toWorldDeg(e)).round().normalize()}static toWorldDeg(e){return-(e+90)}})}}}),System.register("game/event/EventType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Cheer=0]="Cheer",e[e.UnitDeployUndeploy=1]="UnitDeployUndeploy",e[e.WeaponFire=2]="WeaponFire",e[e.ObjectDestroy=3]="ObjectDestroy",e[e.ObjectSpawn=4]="ObjectSpawn",e[e.ObjectUnspawn=5]="ObjectUnspawn",e[e.ObjectMorph=6]="ObjectMorph",e[e.ObjectLiftOff=7]="ObjectLiftOff",e[e.ObjectLand=8]="ObjectLand",e[e.ObjectCrashing=9]="ObjectCrashing",e[e.ObjectDisguiseChange=10]="ObjectDisguiseChange",e[e.ObjectCloakChange=11]="ObjectCloakChange",e[e.ObjectAttacked=12]="ObjectAttacked",e[e.ShipSubmergeChange=13]="ShipSubmergeChange",e[e.BridgeRepair=14]="BridgeRepair",e[e.BuildStatusChange=15]="BuildStatusChange",e[e.BuildingPlace=16]="BuildingPlace",e[e.BuildingFailedPlace=17]="BuildingFailedPlace",e[e.BuildingSell=18]="BuildingSell",e[e.BuildingRepairFull=19]="BuildingRepairFull",e[e.BuildingCapture=20]="BuildingCapture",e[e.BuildingInfiltration=21]="BuildingInfiltration",e[e.BuildingGarrison=22]="BuildingGarrison",e[e.BuildingEvacuate=23]="BuildingEvacuate",e[e.BuildingRepairStart=24]="BuildingRepairStart",e[e.UnitRepairStart=25]="UnitRepairStart",e[e.UnitRepairFinish=26]="UnitRepairFinish",e[e.UnitRecycle=27]="UnitRecycle",e[e.InflictDamage=28]="InflictDamage",e[e.HealthChange=29]="HealthChange",e[e.WarheadDetonate=30]="WarheadDetonate",e[e.PlayerDefeated=31]="PlayerDefeated",e[e.PlayerResigned=32]="PlayerResigned",e[e.PlayerDropped=33]="PlayerDropped",e[e.DeployNotAllowed=34]="DeployNotAllowed",e[e.PowerChange=35]="PowerChange",e[e.PowerLow=36]="PowerLow",e[e.PowerRestore=37]="PowerRestore",e[e.RadarOnOff=38]="RadarOnOff",e[e.ObjectOwnerChange=39]="ObjectOwnerChange",e[e.RadarEvent=40]="RadarEvent",e[e.InsufficientFunds=41]="InsufficientFunds",e[e.RallyPointChange=42]="RallyPointChange",e[e.PrimaryFactoryChange=43]="PrimaryFactoryChange",e[e.FactoryProduceUnit=44]="FactoryProduceUnit",e[e.ObjectTeleport=45]="ObjectTeleport",e[e.AllianceChange=46]="AllianceChange",e[e.UnitPromote=47]="UnitPromote",e[e.EnterTransport=48]="EnterTransport",e[e.LeaveTransport=49]="LeaveTransport",e[e.EnterObject=50]="EnterObject",e[e.EnterTile=51]="EnterTile",e[e.SuperWeaponReady=52]="SuperWeaponReady",e[e.SuperWeaponActivate=53]="SuperWeaponActivate",e[e.LightningStormManifest=54]="LightningStormManifest",e[e.LightningStormCloud=55]="LightningStormCloud",e[e.CratePickup=56]="CratePickup",e[e.PingLocation=57]="PingLocation",e[e.StalemateDetect=58]="StalemateDetect",e[e.TriggerSoundFx=59]="TriggerSoundFx",e[e.TriggerStopSoundFx=60]="TriggerStopSoundFx",e[e.TriggerEva=61]="TriggerEva",e[e.TriggerAnim=62]="TriggerAnim",e[e.TriggerText=63]="TriggerText",e[e.TimerExpire=64]="TimerExpire",t("EventType",i)}}}),System.register("game/event/WarheadDetonateEvent",["game/event/EventType"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("WarheadDetonateEvent",i=class{constructor(e,t,i,r){this.target=e,this.position=t,this.explodeAnim=i,this.isLightningStrike=r,this.type=s.EventType.WarheadDetonate}})}}}),System.register("game/WeaponType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Primary=0]="Primary",e[e.Secondary=1]="Secondary",e[e.DeathWeapon=2]="DeathWeapon",t("WeaponType",i)}}}),System.register("game/gameobject/trait/TiberiumTrait",["game/map/OreOverlayTypes","engine/type/OverlayTibType","engine/type/TiberiumType","game/type/LandType"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("TiberiumTrait",n=class n{constructor(e){this.gameObject=e}static canBePlacedOn(e,t){return[a.LandType.Clear,a.LandType.Road,a.LandType.Rough].includes(e.landType)&&!t.getGroundObjectsOnTile(e).find(e=>!e.isSmudge()&&!e.isUnit())}getTiberiumType(){var e=i.OreOverlayTypes.getOverlayTibType(this.gameObject.overlayId);switch(e){case r.OverlayTibType.Ore:return s.TiberiumType.Ore;case r.OverlayTibType.Gems:return s.TiberiumType.Gems;case r.OverlayTibType.Vinifera:return s.TiberiumType.Ore;default:throw new Error("Unsupported tiberium type "+e)}}collectBail(){var e=this.getBailCount();if(e<=0)throw new Error("Attempted to collect an ore bail, but there are none left");return this.gameObject.value--,1<e?this.getTiberiumType():void 0}spawnBails(e){this.gameObject.value=Math.min(n.maxBails,this.gameObject.value+e)}removeBails(e){this.gameObject.value=Math.max(-1,this.gameObject.value-e)}getBailCount(){return this.gameObject.value+1}dispose(){this.gameObject=void 0}}),n.maxBails=11}}}),System.register("game/gameobject/common/AnimTerrainEffect",["engine/type/ObjectType","game/map/TileCollection","game/type/LandType","game/gameobject/trait/TiberiumTrait"],function(e,t){"use strict";var o,l,c,a,i;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e},function(e){a=e}],execute:function(){e("AnimTerrainEffect",i=class{destroyOre(i,e,r){if(e.landType===c.LandType.Tiberium&&(r.art.hasObject(i,o.ObjectType.Animation)?r.art.getAnimation(i):void 0)?.crater){let t=r.map.getObjectsOnTile(e).find(e=>e.isOverlay()&&e.isTiberium());if(t){var s=Math.ceil(a.TiberiumTrait.maxBails/2),s=i.startsWith("S_CLSN")?s:r.generateRandomInt(1,s);let e=t.traits.get(a.TiberiumTrait);e.removeBails(s),e.getBailCount()||r.unspawnObject(t)}}}spawnSmudges(e,s,a){if(s.landType===c.LandType.Clear&&0===s.rampType&&a.map.mapBounds.isWithinBounds(s)&&!a.map.getObjectsOnTile(s).find(e=>!e.isUnit())){var n=a.art.hasObject(e,o.ObjectType.Animation)?a.art.getAnimation(e):void 0;if(n?.crater){let t=n?.forceBigCraters?2:1,i=n?.scorch,r=[l.TileDirection.Bottom,l.TileDirection.BottomLeft,l.TileDirection.BottomRight].every(e=>a.map.tiles.getNeighbourTile(s,e));n=[...a.rules.smudgeRules.values()].filter(e=>(e.crater&&e.width===t&&e.height===t||i&&e.burn)&&!((1<e.width||1<e.height)&&!r));n.length&&(n=n[a.generateRandomInt(0,n.length-1)].name,n=a.createObject(o.ObjectType.Smudge,n),a.spawnObject(n,s))}}}})}}}),System.register("game/event/ObjectAttackedEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("ObjectAttackedEvent",i=class{constructor(e,t,i){this.target=e,this.attacker=t,this.incidental=i,this.type=r.EventType.ObjectAttacked}})}}}),System.register("game/Warhead",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask","game/gameobject/task/ScatterTask","game/map/BridgeOverlayTypes","game/trait/interface/NotifyAttack","game/type/ArmorType","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Coords","util/math","game/gameobject/unit/FacingUtil","engine/type/ObjectType","game/event/WarheadDetonateEvent","game/WeaponType","game/rules/WeaponRules","data/IniSection","game/rules/ProjectileRules","game/gameobject/common/AnimTerrainEffect","game/event/ObjectAttackedEvent"],function(e,t){"use strict";var n,a,I,i,r,o,l,c,k,B,j,N,L,D,s,F,h,u,d,g,_,p,m;t&&t.id;return{setters:[function(e){n=e},function(e){a=e},function(e){I=e},function(e){i=e},function(e){r=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){s=e},function(e){F=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){_=e},function(e){p=e}],execute:function(){e("Warhead",m=class{constructor(e){this.rules=e}canDamage(e,t,i){return!(!e.isSpawned||e.isDisposed||e.isDestroyed||e.isCrashing)&&(!(e.isTechno()&&e.warpedOutTrait.isInvulnerable()&&!this.rules.temporal)&&((!e.isUnit()||!e.moveTrait.reservedPathNodes.find(e=>e.tile===t))&&(!!e.healthTrait&&((!e.isUnit()||e.zone!==I.ZoneType.Air||i===I.ZoneType.Air)&&(!(!e.isUnit()&&i===I.ZoneType.Air)&&((!e.isBuilding()||!e.rules.invisibleInGame)&&(!((e.isTechno()||e.isTerrain())&&e.rules.immune&&!this.rules.temporal)&&(!(e.isTechno()&&!e.rules.warpable&&this.rules.temporal)&&(!(this.rules.radiation&&(!e.isUnit()||e.rules.immuneToRadiation))&&(!(this.rules.psychicDamage&&(!e.isUnit()||e.rules.immuneToPsionics))&&(!e.isOverlay()||!o.BridgeOverlayTypes.isLowBridgeHead(e.overlayId))))))))))))}computeDamage(e,t,i=!1){let r=e;if(0<e&&t.isTechno()&&t.invulnerableTrait.isActive())return 0;if(t.isAircraft()&&t.missileSpawnTrait&&t.zone!==I.ZoneType.Air)return 0;if(this.rules.radiation||this.rules.temporal||!t.isInfantry()||t.stance!==a.StanceType.Prone||(r*=this.rules.proneDamage),t.isTechno()||t.isOverlay()||t.isTerrain()){let e=t.isTerrain()?c.ArmorType.Wood:t.rules.armor;var s;t.isOverlay()&&t.isBridge()&&((s=o.BridgeOverlayTypes.getOverlayBridgeType(t.overlayId))===o.OverlayBridgeType.Wood?e=c.ArmorType.Wood:s===o.OverlayBridgeType.Concrete&&(e=c.ArmorType.Concrete)),i&&t.isOverlay()&&(t.isBridge()||t.rules.wall)||(r*=this.rules.verses.get(e)),0<r&&t.isTechno()&&t.veteranTrait&&(r/=t.veteranTrait.getVeteranArmorMultiplier()),0<r&&t.isUnit()&&(r/=t.crateBonuses.armor)}return(t.isOverlay()||t.isBuilding())&&t.rules.wall&&(this.rules.wallAbsoluteDestroyer?r=Number.POSITIVE_INFINITY:this.rules.wall||this.rules.wood&&t.rules.armor===c.ArmorType.Wood||(r=0)),t.isOverlay()&&t.isBridge()&&(this.rules.wall||(r=0)),r=0<r?Math.floor(r):Math.ceil(r),r}inflictDamage(e,t,i,r,s=!1){let a=t.healthTrait;return e===Number.POSITIVE_INFINITY&&(e=a.getHitPoints()),a.inflictDamage(e,i,r),r.traits.filter(l.NotifyAttack).forEach(e=>{e[l.NotifyAttack.onAttack](t,i?.obj,r)}),t.onAttack(r,i),r.events.dispatch(new p.ObjectAttackedEvent(t,i,s)),t.isTechno()&&!this.rules.temporal&&this.supressOrScatterTarget(t,r),!a.health&&(t.isInfantry()&&(t.infDeathType=this.rules.infDeath),this.rules.temporal&&(t.deathType=n.DeathType.Temporal),t.isUnit()&&t.crashableTrait&&t.zone===I.ZoneType.Air&&!this.rules.temporal?t.crashableTrait.crash(i):r.destroyObject(t,i,void 0,s),!0)}supressOrScatterTarget(e,t){e.rules.fraidycat||e.isVehicle()&&!e.owner.isCombatant()&&e.rules.insignificant?e.unitOrderTrait.hasTasks()||(e.isInfantry()&&(e.isPanicked=!0),e.unitOrderTrait.addTask(new r.ScatterTask(t)),e.isInfantry()&&e.unitOrderTrait.addTask(new i.CallbackTask(()=>e.isPanicked=!1).setCancellable(!1))):e.isInfantry()&&e.suppressionTrait?.supress()}createDummyWeaponInfo(){return{minRange:0,range:0,speed:Number.POSITIVE_INFINITY,type:h.WeaponType.Primary,rules:new u.WeaponRules(new d.IniSection("Dummy")),projectileRules:new g.ProjectileRules(s.ObjectType.Projectile,new d.IniSection("Dummy")),warhead:this}}detonate(i,e,t,r,s,a,n,o,l,c,h,u,d,g=!1){var p,m,f,y=l?.weapon??this.createDummyWeaponInfo(),T=l?.obj,v=l?.player,b=d?d/N.Coords.LEPTONS_PER_TILE:this.rules.cellSpread,S=this.rules.percentAtMax;let w=new Set,C=new Map,E=new B.RangeHelper(i.map.tileOccupation),x=new j.RadialTileFinder(i.map.tiles,i.map.mapBounds,t,{width:1,height:1},0,Math.ceil(b),()=>!0);for(;p=x.getNextTile();)for(m of i.map.getObjectsOnTile(p))if((!w.has(m)||m.isBuilding())&&(n!==k.CollisionType.UnderBridge||!m.isUnit()||!m.onBridge)&&!(T&&m.isTechno()&&m.rules.typeImmune&&m.owner===v&&m.name===T.name)&&this.canDamage(m,p,a)&&(!m.isOverlay()||!(!n&&.1<Math.abs(m.tileElevation-r)||n===k.CollisionType.OnBridge&&!m.isBridge()))){let e=m.isBuilding()?p===t?0:E.distance3(p,s)/N.Coords.LEPTONS_PER_TILE:m.isTerrain()||m.isOverlay()?E.distance3(p,t)/N.Coords.LEPTONS_PER_TILE:E.distance3(m,s)/N.Coords.LEPTONS_PER_TILE;if(e<.001&&(e=0),!(c&&m.isInfantry()&&v)||m.owner!==v&&!i.alliances.areAllied(m.owner,v)){if(!b)if(m.isTerrain()){if(p!==t||!this.rules.wall)continue}else if(!c&&(p!==t||!m.isBuilding()&&m!==(o.obj||o.getBridge())))continue;b&&e>b||(w.add(m),C.set(m,m.isBuilding()?(C.get(m)||[]).concat(e):[e]))}}let O=!1,A;for(f of w)if(!f.isDestroyed&&!f.isCrashing){var M,R=this.computeDamage(e,f,h);if(R)for(var P of C.get(f)){let t=R;if(0<b&&Number.isFinite(t)&&(t=L.lerp(t,S*t,P/b)),Math.abs(t)<1&&(!b||.25<=t/R)&&(t=+Math.sign(t)),t=0<t?Math.floor(t):Math.ceil(t),t){let e=f.healthTrait;if(t<0){if(!T)throw new Error("Expected healer object to be set");if(e.healBy(-t,T,i),100===e.health)break}else{if(f===o.obj&&P<1&&(A=f),this.inflictDamage(t,f,l,i,!A))break;f.isVehicle()&&this.rules.rocker&&(0<(M=L.clamp(R/300,0,1))&&(P=D.FacingUtil.fromMapCoords(f.position.getMapPosition().clone().sub(N.Coords.vecWorldToGround(s)))-f.direction,f.applyRocking(P,M)))}}}else f.isTechno()&&f.invulnerableTrait.isActive()&&(O=!0)}y=y.rules.radLevel;y&&b&&i.mapRadiationTrait.createRadSite(t,y,b+1);y=g?void 0:O?i.rules.audioVisual.weaponNullifyAnim:this.pickExplodeAnim(e,A,a,i,h);if(!O&&a===I.ZoneType.Ground){let e=new _.AnimTerrainEffect;y&&e.destroyOre(y,t,i),u&&e.spawnSmudges(u,t,i),y&&e.spawnSmudges(y,t,i)}i.events.dispatch(new F.WarheadDetonateEvent(this,s,y,h))}pickExplodeAnim(t,i,r,s,a){if(t){if(a)return s.rules.audioVisual.weatherConBoltExplosion;if(this.rules.conventional&&r===I.ZoneType.Water&&(!i||i.isBuilding()||i.isVehicle()&&i.submergibleTrait)){var n=s.rules.combatDamage.splashList;return n[L.clamp(Math.floor(t/50),0,n.length-1)]}n=this.rules.animList.length;let e;return n?(e=s.rules.combatDamage.c4Warhead===this.rules.name?n-1:this.rules.emEffect?s.generateRandomInt(0,n-1):L.clamp(Math.floor(t/25),0,n-1),this.rules.animList[e]):void 0}}}),m.SPECIAL_WARHEAD_NAME="Special",m.HE_WARHEAD_NAME="HE"}}}),System.register("game/WeaponInfo",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameobject/unit/RangeHelper",["game/Coords","util/math","game/gameobject/unit/ZoneType","game/type/MovementZone","game/math/Vector2"],function(e,t){"use strict";var s,a,o,l,c,h,n,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=e=>void 0!==e.position,n=e=>void 0!==e.addScalar,e("RangeHelper",i=class{constructor(e){this.tileOccupation=e}isInWeaponRange(e,t,i,r,s){var a=s??e;if(i.rules.limboLaunch&&2<Math.abs((h(a)?a.position.tileElevation+a.tile.z:a.z)-(h(t)?t.position.tileElevation+t.tile.z:t.z)))return!1;var{minRange:n,range:o}=this.computeWeaponRangeVsTarget(a,t,i,r);return i.rules.cellRangefinding?this.isInTileRange(a,t,n,o):e.isUnit()&&e.rules.movementZone===l.MovementZone.Fly?this.isInRange2(a,t,n,o):this.isInRange3(a,t,n,o)}computeWeaponRangeVsTarget(e,t,i,r){let s=0;var a,n;return!h(t)||!t.isBuilding()||i.projectileRules.arcing||i.projectileRules.vertical||i.warhead.rules.ivanBomb||1<(n=t.getFoundation()).width&&1<n.height&&(s+=Math.ceil(Math.min(n.width,n.height)/2)),!i.projectileRules.subjectToElevation||i.projectileRules.arcing&&!h(t)||(a=h(e)?e.tile.z+e.tileElevation:e.z,(n=h(t)?t.tile.z+t.tileElevation:t.z)<a&&(s+=r.elevationModel.getBonus(a,n))),i.projectileRules.isAntiAir&&h(e)&&e.isTechno()&&h(t)&&t.isUnit()&&t.zone===o.ZoneType.Air&&(s+=e.rules.airRangeBonus),{minRange:i.minRange,range:i.range+s}}isInRange(e,t,i,r,s=!1){return s?this.isInTileRange(e,t,i,r):e.isUnit()&&e.rules.movementZone===l.MovementZone.Fly?this.isInRange2(e,t,i,r):this.isInRange3(e,t,i,r)}isInRange3(e,t,i,r){return a.isBetween(this.distance3(e,t)/s.Coords.LEPTONS_PER_TILE,i,r)}isInRange2(e,t,i,r){return a.isBetween(this.distance2(e,t)/s.Coords.LEPTONS_PER_TILE,i,r)}distance3(e,t){let i=h(e)?e.position.worldPosition:n(e)?e:s.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z);var r=h(t)?t.position.worldPosition:n(t)?t:s.Coords.tile3dToWorld(t.rx+.5,t.ry+.5,t.z);return i.distanceTo(r)}distance2(e,t){let i=h(e)?new c.Vector2(e.position.worldPosition.x,e.position.worldPosition.z):n(e)?new c.Vector2(e.x,e.z):new c.Vector2(e.rx+.5,e.ry+.5).multiplyScalar(s.Coords.LEPTONS_PER_TILE);var r=h(t)?new c.Vector2(t.position.worldPosition.x,t.position.worldPosition.z):n(t)?new c.Vector2(t.x,t.z):new c.Vector2(t.rx+.5,t.ry+.5).multiplyScalar(s.Coords.LEPTONS_PER_TILE);return i.distanceTo(r)}isInTileRange(e,t,i,r){return a.isBetween(this.tileDistance(e,t),i,r)}tileDistance(e,t){var i,r=h(e)?this.tileOccupation.calculateTilesForGameObject(e.tile,e):Array.isArray(e)?e:[e],s=h(t)?this.tileOccupation.calculateTilesForGameObject(t.tile,t):Array.isArray(t)?t:[t];let a=new c.Vector2,n=new c.Vector2,o=Number.POSITIVE_INFINITY;for(i of r)for(var l of s){a.set(i.rx,i.ry),n.set(l.rx,l.ry);l=a.distanceTo(n);l<=o&&(o=l)}return o}})}}}),System.register("game/gameobject/task/TurnTask",["game/gameobject/task/system/Task","game/gameobject/unit/FacingUtil"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.Task{constructor(e){super(),this.direction=e,this.cancellable=!1}onTick(e){if(e.direction===this.direction)return!(e.spinVelocity=0);var t=e.rules.rot,{facing:i,delta:t}=r.FacingUtil.tick(e.direction,this.direction,t);return e.direction=i,e.spinVelocity=t,!1}},e("TurnTask",s)}}}),System.register("game/gameobject/task/system/WaitTicksTask",["game/gameobject/task/system/Task"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.Task{constructor(e){super(),this.ticks=e}onTick(){return!!this.isCancelling()||!(0<this.ticks--)}},e("WaitTicksTask",r)}}}),System.register("game/GameSpeed",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("GameSpeed",i=class i{static computeGameSpeed(e){let t;return t=6===e?60:5===e?45:60/(6-e),t/i.BASE_TICKS_PER_SECOND}}),i.BASE_TICKS_PER_SECOND=15}}}),System.register("game/gameobject/task/system/WaitMinutesTask",["game/gameobject/task/system/WaitTicksTask","game/GameSpeed"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.WaitTicksTask{constructor(e){super(Math.floor(r.GameSpeed.BASE_TICKS_PER_SECOND*e*60))}},e("WaitMinutesTask",s)}}}),System.register("game/type/LocomotorType",["game/type/SpeedType"],function(t,e){"use strict";var i,r;e&&e.id;return{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.Statue=0]="Statue",e[e.Aircraft=1]="Aircraft",e[e.Chrono=2]="Chrono",e[e.Hover=3]="Hover",e[e.Infantry=4]="Infantry",e[e.Jumpjet=5]="Jumpjet",e[e.Missile=6]="Missile",e[e.Ship=7]="Ship",e[e.Vehicle=8]="Vehicle",t("LocomotorType",r),t("locomotorTypesByClsId",new Map([["{4A582746-9839-11d1-B709-00A024DDAFD1}",r.Aircraft],["{4A582747-9839-11d1-B709-00A024DDAFD1}",r.Chrono],["{4A582742-9839-11d1-B709-00A024DDAFD1}",r.Hover],["{4A582744-9839-11d1-B709-00A024DDAFD1}",r.Infantry],["{92612C46-F71F-11d1-AC9F-006008055BB5}",r.Jumpjet],["{B7B49766-E576-11d3-9BD9-00104B972FE8}",r.Missile],["{2BEA74E1-7CCA-11d3-BE14-00104B62A16C}",r.Ship],["{4A582741-9839-11d1-B709-00A024DDAFD1}",r.Vehicle]])),t("defaultSpeedsByLocomotor",new Map([[r.Infantry,i.SpeedType.Foot],[r.Ship,i.SpeedType.Float],[r.Hover,i.SpeedType.Hover],[r.Jumpjet,i.SpeedType.Winged],[r.Aircraft,i.SpeedType.Winged],[r.Missile,i.SpeedType.Winged]]))}}}),System.register("game/gameobject/task/harvester/TeleportMoveToRefineryTask",["game/gameobject/task/move/MoveTask","game/type/LocomotorType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.MoveTask{constructor(e,t,i,r){super(e,i??t,!1,{closeEnoughTiles:i?void 0:0,strictCloseEnough:!i}),this.teleportTile=t,this.teleportCondition=r}onStart(e){if(super.onStart(e),!e.harvesterTrait||e.rules.locomotor!==r.LocomotorType.Chrono)throw new Error(`Vehicle ${e.name} is not a chrono miner`)}onTick(e){return!e.moveTrait.isDisabled()&&(!(this.isCancelling()||e.moveTrait.moveState!==s.MoveState.ReachedNextWaypoint||e.tile===this.teleportTile||!this.tryTeleportToRefinery(e))||!0===super.onTick(e)&&(this.isCancelling()||e.tile===this.teleportTile||this.tryTeleportToRefinery(e),!0))}tryTeleportToRefinery(e){return(!this.teleportCondition||!1!==this.teleportCondition(e,this.teleportTile))&&(!this.game.map.terrain.findObstacles({tile:this.teleportTile,onBridge:void 0},e).length&&(e.moveTrait.teleportUnitToTile(this.teleportTile,void 0,!0,!0,this.game),e.zone===a.ZoneType.Air&&(e.zone=a.ZoneType.Ground,e.position.tileElevation=0),!0))}},e("TeleportMoveToRefineryTask",n)}}}),System.register("game/gameobject/task/harvester/GatherOreTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/HarvesterTrait","game/type/LandType","game/gameobject/task/move/MoveTask","game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/unit/RangeHelper","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone"],function(e,t){"use strict";var i,h,n,u,o,l,c,d,r,s,g,p,m,f,a;t&&t.id;return{setters:[function(e){i=e},function(e){h=e},function(e){n=e},function(e){u=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){d=e},function(e){r=e},function(e){s=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=[[8,5,6],[3,0,2],[7,4,1]],a=class extends i.Task{constructor(e,t,i=!1){super(),this.game=e,this.initialTarget=t,this.explicitOrder=i,this.forceMoveTried=!1,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new s.RangeHelper(e.map.tileOccupation),this.scanNearRadius=e.rules.ai.tiberiumNearScan,this.scanFarRadius=e.rules.ai.tiberiumFarScan,this.strictTarget=i}onStart(e){if(!e.isVehicle()||!e.harvesterTrait)throw new Error(`Unit ${e.name} is not a harvester.`);e.harvesterTrait.status=n.HarvesterStatus.MovingToOreSite,e.harvesterTrait.lastGatherExplicit=this.explicitOrder}onEnd(e){e.harvesterTrait.status!==n.HarvesterStatus.LookingForOreSite&&(e.harvesterTrait.status=n.HarvesterStatus.Idle)}onTick(i){if(this.isCancelling())return!0;let r=i.harvesterTrait;if(r.status===n.HarvesterStatus.MovingToOreSite){if(this.target=this.initialTarget?.landType===u.LandType.Tiberium?this.initialTarget:this.findClosestReachableOreSite(i,r.lastOreSite??i.tile,!0),r.lastOreSite=this.target,!this.target){r.status=n.HarvesterStatus.LookingForOreSite;let e=this.getRefineryOnTile(i.tile);if(e&&1===i.unitOrderTrait.getTasks().length){let t=i.rules.movementZone===m.MovementZone.Fly;var s=new h.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,e.tile,e.getFoundation(),1,5,e=>t||0<this.game.map.terrain.getPassableSpeed(e,i.rules.speedType,!1)&&Math.abs(e.z-i.tile.z)<2&&!this.game.map.terrain.findObstacles({tile:e,onBridge:void 0},i).length).getNextTile();s&&i.unitOrderTrait.addTasks(new o.MoveTask(this.game,s,!1),new g.CallbackTask(()=>{[p.MoveResult.Success,p.MoveResult.CloseEnough,p.MoveResult.Cancel].includes(i.moveTrait.lastMoveResult)||this.children.push(new d.WaitMinutesTask(1/60))}))}return!0}var a=this.game.rules.general.closeEnough,s=this.rangeHelper.tileDistance(i.tile,this.target)<=a;if(i.tile!==this.target&&(i.tile.landType!==u.LandType.Tiberium||!s||this.strictTarget)){if(i.tile!==this.target&&s&&i.tile.landType!==u.LandType.Tiberium){s=this.findClosestReachableOreSite(i,i.tile,!1,!0);if(s)this.target=s,r.lastOreSite=this.target;else{if(!this.forceMoveTried)return this.forceMoveTried=!0,this.children.push(new o.MoveTask(this.game,this.target,!1,{closeEnoughTiles:0,strictCloseEnough:!0})),!1;if(this.forceMoveTried=!1,!r.isEmpty())return this.returnOreIfPossible(i),!0;s=this.findClosestReachableOreSite(i,i.tile,!0,!0);if(!s)return r.status=n.HarvesterStatus.LookingForOreSite,!0;this.target=s,r.lastOreSite=this.target}}return this.children.push(new o.MoveTask(this.game,this.target,!1,{closeEnoughTiles:a}),new g.CallbackTask(()=>{[p.MoveResult.Success,p.MoveResult.CloseEnough,p.MoveResult.Cancel].includes(i.moveTrait.lastMoveResult)||this.children.push(new d.WaitMinutesTask(5/60))})),!1}this.target=i.tile,r.lastOreSite=this.target,r.status=n.HarvesterStatus.Harvesting,this.forceMoveTried=!1,this.strictTarget=!1}if(r.status!==n.HarvesterStatus.Harvesting)return!1;{if(r.isFull())return this.returnOreIfPossible(i),!0;let e=this.game.map.getObjectsOnTile(i.tile).find(e=>e.isOverlay()&&e.isTiberium());if(!e)return this.findClosestReachableOreSite(i,r.lastOreSite??i.tile,!1)||r.isEmpty()?(r.status=n.HarvesterStatus.MovingToOreSite,this.onTick(i)):(this.returnOreIfPossible(i),!0);let t=e.traits.get(l.TiberiumTrait);a=t.collectBail();if(t.getBailCount()||this.game.unspawnObject(e),void 0!==a)if(a===c.TiberiumType.Ore)r.ore++;else{if(a!==c.TiberiumType.Gems)throw new Error("Unsupported tiberium type "+a);r.gems++}return[...i.owner.buildings].some(e=>e.rules.refinery)||this.explicitOrder?(this.children.push(new d.WaitMinutesTask(1/60)),!1):!0}}findClosestReachableOreSite(t,i,e,r=!1){let s=t.rules.movementZone===m.MovementZone.Fly;var a,n=e=>e.landType===u.LandType.Tiberium&&(!r||(s||!this.game.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length));if(n(i))return i;let o=1;if(!e){let e=new h.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,i,{width:1,height:1},o,o,n),t=[];for(;a=e.getNextTile();)t.push(a);if(t.length){let e=t.map(e=>{var t=this.game.map.getObjectsOnTile(e).find(e=>e.isOverlay()&&e.isTiberium());if(!t)throw new Error(`Ore should exist on tile ${e.rx},${e.ry} b/c of landType`);return{tile:e,ore:t}});return e.sort((e,t)=>1e3*(t.ore.value-e.ore.value)+(f[1+t.tile.ry-i.ry][1+t.tile.rx-i.rx]-f[1+e.tile.ry-i.ry][1+e.tile.rx-i.rx])),e[0].tile}o=2}var l=e?this.scanFarRadius:this.scanNearRadius;let c=new h.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,i,{width:1,height:1},o,l,n);return c.getNextTile()}getRefineryOnTile(e){return this.game.map.getObjectsOnTile(e).find(e=>e.isBuilding()&&e.rules.refinery)}returnOreIfPossible(e){1===e.unitOrderTrait.getTasks().length&&e.unitOrderTrait.addTask(new r.ReturnOreTask(this.game))}getTargetLinesConfig(e){return{pathNodes:this.initialTarget?[{tile:this.initialTarget,onBridge:void 0}]:[]}}},e("GatherOreTask",a)}}}),System.register("game/gameobject/task/harvester/ReturnOreTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","engine/type/TiberiumType","game/gameobject/trait/HarvesterTrait","game/gameobject/task/harvester/TeleportMoveToRefineryTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/math/Vector2"],function(e,t){"use strict";var i,s,r,l,c,h,u,d,g,p,m,f,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Task{constructor(e,t,i=!1,r=!1){super(),this.game=e,this.forceTarget=t,this.resetLastOreSite=i,this.explicitOrder=r,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new s.RangeHelper(e.map.tileOccupation)}onStart(e){if(!e.isVehicle()||!e.harvesterTrait)throw new Error(`Unit ${e.name} is not a harvester.`);e.harvesterTrait.status=d.HarvesterStatus.MovingToRefinery,this.resetLastOreSite&&(e.harvesterTrait.lastOreSite=void 0)}onEnd(e){this.target?.isSpawned&&(this.target.dockTrait.undockUnit(e),this.target.dockTrait.unreserveDockForUnit(e)),e.harvesterTrait.status!==d.HarvesterStatus.LookingForRefinery&&(e.harvesterTrait.status=d.HarvesterStatus.Idle)}onTick(r){if(this.isCancelling())return!0;let s=r.harvesterTrait;if(s.status===d.HarvesterStatus.LookingForRefinery)return!0;if(s.status===d.HarvesterStatus.MovingToRefinery){if(!this.target||!this.isValidTargetRefinery(this.target,r)||r.tile!==this.findRefineryDockingTile(this.target)){var a=this.forceTarget??this.findClosestReachableRefinery(r);if(!a)return s.status=d.HarvesterStatus.LookingForRefinery,!0;this.target&&this.target!==a&&this.target.dockTrait.hasReservedDockForUnit(r)&&this.target.dockTrait.unreserveDockForUnit(r),this.target=a}let e=this.target.dockTrait.getFirstAvailableDockNumber(),t=!1;void 0===e&&(e=this.target.dockTrait.getFirstEmptyDockNumber(),void 0!==e&&(t=!this.target.dockTrait.hasReservedDockForUnit(r)));let i=this.findRefineryDockingTile(this.target);var n=this.rangeHelper.tileDistance(r,i);if(void 0===e||t||n>this.game.rules.general.harvesterTooFarDistance&&!this.explicitOrder){var o=this.findReachableQueueingTile(r);return o?(r.tile!==o&&this.children.push(r.rules.teleporter?new g.TeleportMoveToRefineryTask(this.game,i,o,()=>this.chronoMinerCanTeleport(r,i,this.target)):new l.MoveTask(this.game,o,!1),new m.CallbackTask(()=>{r.moveTrait.lastMoveResult===f.MoveResult.Fail?s.status=d.HarvesterStatus.LookingForRefinery:r.moveTrait.lastMoveResult===f.MoveResult.CloseEnough?this.children.push(new h.WaitMinutesTask(5/60)):r.moveTrait.lastMoveResult===f.MoveResult.Success&&this.children.push(new h.WaitMinutesTask(2/60))})),!1):!0}if(this.target.dockTrait.hasReservedDockForUnit(r)||this.target.dockTrait.reserveDockAt(r,e),void 0===this.reservedDockNumber&&(this.reservedDockNumber=this.target.dockTrait.getReservedDockForUnit(r)),r.tile!==i)return this.children.push(r.rules.teleporter?new g.TeleportMoveToRefineryTask(this.game,i,void 0,()=>this.chronoMinerCanTeleport(r,i,this.target)):new l.MoveTask(this.game,i,!1,{closeEnoughTiles:0,strictCloseEnough:!0}),new m.CallbackTask(()=>{r.moveTrait.lastMoveResult===f.MoveResult.Fail&&(s.status=d.HarvesterStatus.LookingForRefinery)})),!1;s.status=d.HarvesterStatus.Docking}if(!this.isValidTargetRefinery(this.target,r))return s.status=d.HarvesterStatus.MovingToRefinery,this.forceTarget=void 0,this.onTick(r);if(s.status===d.HarvesterStatus.Docking){if(270!==r.direction)return this.children.push(new c.TurnTask(270)),!1;this.target.dockTrait.dockUnitAt(r,this.reservedDockNumber),this.reservedDockNumber=void 0,s.status=d.HarvesterStatus.PreparingToUnload}if(s.status===d.HarvesterStatus.PreparingToUnload)return this.preventOpportunityFire=!0,this.children.push(new h.WaitMinutesTask(2/60)),s.status=d.HarvesterStatus.Unloading,!1;if(s.status!==d.HarvesterStatus.Unloading)return!1;a=s.ore*this.game.rules.getTiberium(u.TiberiumType.Ore).value+s.gems*this.game.rules.getTiberium(u.TiberiumType.Gems).value;this.target.owner.credits+=a;n=[...this.target.owner.buildings].filter(e=>e.rules.orePurifier&&(!e.poweredTrait||!this.target.owner.powerTrait?.isLowPower())).length,o=this.game.rules.general.purifierBonus;return this.target.owner.credits+=n*Math.floor(a*o),s.ore=0,s.gems=0,1===r.unitOrderTrait.getTasks().length&&r.unitOrderTrait.addTask(new p.GatherOreTask(this.game)),!0}isValidTargetRefinery(e,t){return e.isSpawned&&this.game.areFriendly(e,t)&&!e.warpedOutTrait.isActive()}findClosestReachableRefinery(i){let r=this.rangeHelper,e=[...i.owner.buildings].filter(e=>e.rules.refinery&&e.dockTrait&&!e.warpedOutTrait.isActive()).sort((e,t)=>r.distance2(i,e)-r.distance2(i,t));var t=e[0],s=e.find(e=>0<e.dockTrait.getAvailableDockCount());return!s||t&&r.tileDistance(i,s.centerTile)-r.tileDistance(i,t.centerTile)>this.game.rules.general.harvesterTooFarDistance?t:s}findReachableQueueingTile(t){if(this.target.art.queueingCell){var e=new n.Vector2(this.target.tile.rx,this.target.tile.ry).add(this.target.art.queueingCell),e=this.game.map.tiles.getByMapCoords(e.x,e.y);if(e&&this.isValidQueueingTile(e,t))return e}return new r.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,e=>this.isValidQueueingTile(e,t)).getNextTile()}isValidQueueingTile(e,t){return t.zone===a.ZoneType.Air||0<this.game.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&Math.abs(e.z-this.target.tile.z)<2&&!e.onBridgeLandType}findRefineryDockingTile(e){var t={x:e.tile.rx+e.getFoundation().width-1,y:e.tile.ry+Math.floor(e.getFoundation().height/2)};return this.game.map.tiles.getByMapCoords(t.x,t.y)}chronoMinerCanTeleport(e,t,i){let r=this.rangeHelper;var s=r.tileDistance(e,t);return!(!this.forceTarget&&s>this.game.rules.general.chronoHarvTooFarDistance)&&(!(s<=1)&&(!!this.isValidTargetRefinery(i,e)&&!(0===i.dockTrait.getAvailableDockCount()&&!i.dockTrait.hasReservedDockForUnit(e))))}},e("ReturnOreTask",o)}}}),System.register("game/gameobject/trait/interface/NotifySpawn",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onSpawn=Symbol(),e("NotifySpawn",i)}}}),System.register("game/gameobject/trait/interface/NotifyTeleport",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onBeforeTeleport=Symbol(),e("NotifyTeleport",i)}}}),System.register("game/gameobject/trait/interface/NotifyOrder",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onPush=Symbol(),e("NotifyOrder",i)}}}),System.register("game/gameobject/trait/HarvesterTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder","game/order/OrderType","game/type/LandType"],function(t,e){"use strict";var i,s,a,r,n,o,l,c,h,u,d,g;e&&e.id;return{setters:[function(e){i=e},function(e){s=e},function(e){a=e},function(e){r=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var e;(e=d=d||{})[e.Idle=0]="Idle",e[e.LookingForOreSite=1]="LookingForOreSite",e[e.MovingToOreSite=2]="MovingToOreSite",e[e.Harvesting=3]="Harvesting",e[e.LookingForRefinery=4]="LookingForRefinery",e[e.MovingToRefinery=5]="MovingToRefinery",e[e.Docking=6]="Docking",e[e.PreparingToUnload=7]="PreparingToUnload",e[e.Unloading=8]="Unloading",t("HarvesterStatus",d),g=class{constructor(e){this.storage=e,this.ore=0,this.gems=0,this.status=d.Idle,this.lastGatherExplicit=!1,this.autoGatherOnNextIdle=!1,this.ticksSinceLastRefineryCheck=0,this.ticksSinceLastOreCheck=0}[r.NotifySpawn.onSpawn](e,t){e.owner.isCombatant()&&t.afterTick(()=>{e.unitOrderTrait.addTask(new a.GatherOreTask(t))})}[n.NotifyOwnerChange.onChange](e,t,i){!t.isCombatant()&&e.owner.isCombatant()&&i.afterTick(()=>{e.unitOrderTrait.addTask(new a.GatherOreTask(i))})}[i.NotifyTick.onTick](e,t){this.status===d.LookingForRefinery?this.ticksSinceLastRefineryCheck++>5*o.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastRefineryCheck=0,e.unitOrderTrait.hasTasks()?this.ticksSinceLastRefineryCheck=-25*o.GameSpeed.BASE_TICKS_PER_SECOND:[...e.owner.buildings].some(e=>e.rules.refinery)||this.lastGatherExplicit?e.unitOrderTrait.addTask(new s.ReturnOreTask(t)):this.status=d.Idle):this.status===d.LookingForOreSite?this.ticksSinceLastOreCheck++>20*o.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastOreCheck=0,e.unitOrderTrait.hasTasks()||e.unitOrderTrait.addTask(new a.GatherOreTask(t))):this.status===d.Idle&&this.autoGatherOnNextIdle&&e.unitOrderTrait.isIdle()&&e.tile.landType===u.LandType.Tiberium&&(this.autoGatherOnNextIdle=!1,e.unitOrderTrait.addTask(new a.GatherOreTask(t,e.tile,!0)))}[l.NotifyTeleport.onBeforeTeleport](e,t,i,r){!r&&e.owner.isCombatant()&&(this.status=d.Idle,this.lastOreSite=void 0,i&&e.rules.teleporter&&t.afterTick(()=>{e.unitOrderTrait.addTask(new(this.isFull()?s.ReturnOreTask:a.GatherOreTask)(t))}))}[c.NotifyOrder.onPush](e,t){this.autoGatherOnNextIdle=[h.OrderType.AttackMove,h.OrderType.Move,h.OrderType.ForceMove,h.OrderType.Scatter].includes(t),[d.LookingForRefinery,d.LookingForOreSite].includes(this.status)&&(this.status=d.Idle)}isFull(){return this.ore+this.gems>=this.storage}isEmpty(){return!this.ore&&!this.gems}getHash(){return 100*this.ore+this.gems}debugGetState(){return{ore:this.ore,gems:this.gems}}},t("HarvesterTrait",g)}}}),System.register("game/gameobject/trait/interface/NotifyDestroy",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onDestroy=Symbol(),e("NotifyDestroy",i)}}}),System.register("game/event/LeaveTransportEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("LeaveTransportEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.LeaveTransport}})}}}),System.register("game/gameobject/trait/TransportTrait",["util/math","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/task/ScatterTask","game/event/LeaveTransportEvent","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/ZoneType"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class{constructor(e){this.obj=e,this.units=[],this.loadQueue=[]}unitFitsInside(e){return e.rules.size<=this.obj.rules.sizeLimit&&e.rules.size<=this.getAvailableCapacity()}getAvailableCapacity(){return this.obj.rules.passengers-this.units.reduce((e,t)=>e+t.rules.size,0)}addToLoadQueue(e){return this.loadQueue.push(e),this.loadQueue.length-1}unitIsFirstInLoadQueue(e){return this.loadQueue[0]===e}removeFromLoadQueue(e){var t=this.loadQueue.indexOf(e);-1!==t&&this.loadQueue.splice(t,1)}[n.NotifyTick.onTick](e,t){this.loadQueue=this.loadQueue.filter(e=>!e.isDestroyed&&!e.isCrashing)}[r.NotifyDestroy.onDestroy](e,t,i,r){var s=!!e.armedTrait?.deathWeapon,a=i?.weapon?.warhead.rules.parasite;if(r||s||e.zone===o.ZoneType.Air||a)for(var n of this.units)s&&n.armedTrait&&(n.armedTrait.deathWeapon=void 0),n.position.tileElevation=e.position.tileElevation,n.zone=e.zone,n.onBridge=e.onBridge,n.position.tile=e.tile,t.destroyObject(n,i,!0);else this.spawnSurvivors(t);this.units=[]}spawnSurvivors(e){var t=this.obj;if(this.units.length){for(var i of this.units)0<e.map.terrain.getPassableSpeed(t.tile,i.rules.speedType,t.onBridge)?(i.owner.addOwnedObject(i),i.position.tileElevation=t.onBridge?e.map.tileOccupation.getBridgeOnTile(t.tile).tileElevation:0,i.onBridge=t.onBridge,i.zone=e.map.getTileZone(t.tile,!t.onBridge),e.unlimboObject(i,t.tile),i.unitOrderTrait.addTask(new s.ScatterTask(e))):(i.position.tileElevation=t.position.tileElevation,i.zone=t.zone,i.onBridge=t.onBridge,i.position.tile=t.tile,e.destroyObject(i,{player:i.owner}));e.events.dispatch(new a.LeaveTransportEvent(t))}}getHash(){return i.fnv32a(this.units.map(e=>e.getHash()))}debugGetState(){return this.units.map(e=>e.debugGetState())}dispose(){this.obj=void 0}},e("TransportTrait",l)}}}),System.register("game/gameobject/trait/TurretTrait",["game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.facing=0,this.desiredFacing=0}isRotating(){return this.facing!==this.desiredFacing}[r.NotifyTick.onTick](e){var t;this.desiredFacing!==this.facing&&(t=e.rules.rot,this.facing=i.FacingUtil.tick(this.facing,this.desiredFacing,t||Number.POSITIVE_INFINITY).facing)}},e("TurretTrait",s)}}}),System.register("game/art/FlhCoords",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("FlhCoords",i=class i{constructor(e){this.forward=0,this.lateral=0,this.vertical=0,e&&3===e.length&&this.fromArray(e)}fromArray(e){return this.forward=e[0],this.lateral=e[1],this.vertical=e[2],this}clone(){return new i([this.forward,this.lateral,this.vertical])}})}}}),System.register("game/event/WeaponFireEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("WeaponFireEvent",r=class{constructor(e,t){this.weapon=e,this.gameObject=t,this.type=i.EventType.WeaponFire}})}}}),System.register("game/type/LandTargeting",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.LandOk=0]="LandOk",e[e.LandNotOk=1]="LandNotOk",e[e.LandSecondary=2]="LandSecondary",t("LandTargeting",i)}}}),System.register("game/type/NavalTargeting",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.UnderwaterNever=0]="UnderwaterNever",e[e.UnderwaterSecondary=1]="UnderwaterSecondary",e[e.UnderwaterOnly=2]="UnderwaterOnly",e[e.OrganicSecondary=3]="OrganicSecondary",e[e.SealSpecial=4]="SealSpecial",e[e.NavalAll=5]="NavalAll",e[e.NavalNone=6]="NavalNone",t("NavalTargeting",i)}}}),System.register("game/WeaponTargeting",["game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/type/LandTargeting","game/type/LandType","game/type/NavalTargeting","game/type/SpeedType","game/WeaponType"],function(e,t){"use strict";var r,s,i,a,n,o,l,c;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){e("WeaponTargeting",c=class{constructor(e,t,i,r,s,a){this.weaponType=e,this.projectileRules=t,this.weaponRules=i,this.warheadRules=r,this.gameObject=s,this.generalRules=a,this.targetChecks=[],this.initConditions()}initConditions(){this.projectileRules.isAntiGround||this.targetChecks.push(e=>!!e);const a=this.generalRules.prism.type;this.gameObject.name===a&&this.weaponType===l.WeaponType.Secondary?this.targetChecks.push((e,t,i,r,s)=>!(!s||!e?.isBuilding()||e.name!==a||e.owner!==this.gameObject.owner)):this.warheadRules.electricAssault?this.targetChecks.push((e,t,i,r,s)=>!(!r&&!s||!e?.isBuilding()||!e.overpoweredTrait||e.owner!==this.gameObject.owner)):this.weaponRules.damage<0?this.targetChecks.push((e,t,i)=>!!(e!==this.gameObject&&e?.isUnit()&&i.areFriendly(e,this.gameObject)&&e.healthTrait.health<100&&this.gameObject.isAircraft()===e.isAircraft())):(this.gameObject.rules.attackCursorOnFriendlies||this.warheadRules.bombDisarm?this.targetChecks.push((e,t,i,r,s)=>!s&&!!(!this.warheadRules.bombDisarm||e?.isTechno()&&e.tntChargeTrait?.hasCharge())):this.targetChecks.push((e,t,i,r)=>!((!r||this.warheadRules.mindControl)&&e?.isTechno()&&i.areFriendly(e,this.gameObject))),this.targetChecks.push((e,t,i)=>!(e?.isTechno()&&e.cloakableTrait?.isCloaked()&&!i.alliances.haveSharedIntel(this.gameObject.owner,e.owner))),this.weaponRules.limboLaunch&&this.targetChecks.push((e,t,i,r,s)=>!(s&&e&&(e.isVehicle()||e.isAircraft())&&e.parasiteableTrait?.isInfested())),this.gameObject.rules.ivan&&this.targetChecks.push(e=>!(!e?.isTechno()||!e.tntChargeTrait||e.tntChargeTrait.hasCharge())),this.warheadRules.parasite&&this.targetChecks.push((e,t,i,r)=>!!(!e&&r||e?.isInfantry()||(e?.isVehicle()||e?.isAircraft())&&e.parasiteableTrait)),this.warheadRules.mindControl&&this.targetChecks.push(e=>!(!e?.isTechno()||!e.mindControllableTrait)),this.warheadRules.temporal||this.targetChecks.push((e,t,i,r,s)=>!(s&&e?.isTechno()&&e.warpedOutTrait.isInvulnerable()))),this.targetChecks.push((e,t)=>this.canTargetZone(e,t))}canTarget(t,i,r,s,a){return this.targetChecks.every(e=>e(t,i,r,s,a))}canTargetZone(e,t){let i;if(e?.isUnit()){if(e?.isInfantry()&&e.stance===r.StanceType.Paradrop)return this.projectileRules.isAntiAir&&(this.projectileRules.isAntiGround||this.weaponType===l.WeaponType.Secondary);if(e.zone===s.ZoneType.Air)return this.projectileRules.isAntiAir;if(this.weaponType===l.WeaponType.Secondary&&this.projectileRules.isAntiAir)return!1;i=e.zone}else i=t.landType===a.LandType.Water?s.ZoneType.Water:s.ZoneType.Ground;return i===s.ZoneType.Water?this.canTargetNaval(this.gameObject.rules.navalTargeting,this.gameObject,e,this.weaponType):this.canTargetLand(this.gameObject.rules.landTargeting,this.weaponType)}canTargetLand(e,t){switch(e){case i.LandTargeting.LandOk:return!0;case i.LandTargeting.LandNotOk:return!1;case i.LandTargeting.LandSecondary:return t===l.WeaponType.Secondary;default:throw new Error(`Unhandled LandTargeting value "${e}"`)}}canTargetNaval(e,t,i,r){switch(e){case n.NavalTargeting.UnderwaterNever:return!i||!(i.isVehicle()&&i.submergibleTrait?.isSubmerged());case n.NavalTargeting.UnderwaterSecondary:return i&&i.isVehicle()&&i.submergibleTrait&&!t.rules.spawned?r===l.WeaponType.Secondary:r===l.WeaponType.Primary;case n.NavalTargeting.UnderwaterOnly:return!!(i&&i.isVehicle()&&i.submergibleTrait);case n.NavalTargeting.OrganicSecondary:return i?.isTechno()&&i.rules.organic?r===l.WeaponType.Secondary:r===l.WeaponType.Primary;case n.NavalTargeting.SealSpecial:return i?.isTechno()&&i.rules.naval&&!i.rules.organic&&(i.isBuilding()||i.rules.speedType===o.SpeedType.Float)?r===l.WeaponType.Secondary:r===l.WeaponType.Primary;case n.NavalTargeting.NavalAll:return!0;case n.NavalTargeting.NavalNone:return!1;default:throw new Error(`Unhandled NavalTargeting value "${e}"`)}}})}}}),System.register("game/Weapon",["game/Warhead","game/art/FlhCoords","game/event/WeaponFireEvent","game/math/geometry","game/rules/ObjectRules","game/Coords","engine/type/ObjectType","game/WeaponTargeting","game/WeaponType","game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var h,u,d,g,i,p,a,m,r,f,y,s,T,v,b,S;t&&t.id;return{setters:[function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){i=e},function(e){p=e},function(e){a=e},function(e){m=e},function(e){r=e},function(e){f=e},function(e){y=e}],execute:function(){s=50,T=5,v=2,b=1,e("Weapon",S=class S{constructor(e,t,i,r,s,a,n){this.type=e,this.gameObject=t,this.rules=i,this.warhead=r,this.projectileRules=s,this.flh=a,this.targeting=n,this.cooldownTicks=0,this.burstsLeft=0,this.burstIndex=0,this.useBurstDelay=!1,this.lateralMuzzleMult=1,this.distributedFireAngle=t.rules.distributedFire&&t.rules.radialFireSegments?-90:0}static factory(e,t,i,r,s){var a=r.getWeapon(e);let n=a.warhead;n===h.Warhead.SPECIAL_WARHEAD_NAME&&(n=S.findSpecialWarheadName(a,i,r));var o=new h.Warhead(r.getWarhead(n)),l=r.getProjectile(a.projectile),c=new m.WeaponTargeting(t,l,a,o.rules,i,r.general);return new this(t,i,a,o,l,s||new u.FlhCoords,c)}static findSpecialWarheadName(e,t,i){let r;if(!e.spawner)throw new Error(`Weapon "${e.name} can't use "Special" warhead without Spawner=yes`);if(t.rules.spawns===i.general.v3Rocket.type)r=i.combatDamage.v3Warhead;else if(t.rules.spawns===i.general.dMisl.type)r=i.combatDamage.dMislWarhead;else{if(!t.rules.spawns)throw new Error(`Can't use "Special" warhead on unit type "${t.name}" without "Spawns"`);var s=i.getObject(t.rules.spawns,a.ObjectType.Aircraft);if(!s.primary)throw new Error(`Spawned unit "${s.name}" doesn't have a primary weapon`);r=i.getWeapon(s.primary).warhead}return r}static computeSpeed(e,t){return t.arcing?.75*i.ObjectRules.iniSpeedToLeptonsPerTick(s,100):!t.rot||t.inviso||e.isLaser||e.isElectricBolt?Number.POSITIVE_INFINITY:e.speed}get name(){return this.rules.name}get minRange(){return this.rules.minimumRange}get range(){return this.gameObject.isBuilding()&&!this.gameObject.overpoweredTrait&&this.type===r.WeaponType.Secondary&&this.gameObject.primaryWeapon?Math.min(this.gameObject.primaryWeapon.rules.range,this.rules.range):this.rules.range}get speed(){return S.computeSpeed(this.rules,this.projectileRules)}get rof(){let e=this.rules.rof;return this.gameObject.isBuilding()&&this.gameObject.garrisonTrait?.isOccupied()&&(e/=this.gameObject.garrisonTrait.units.length),this.gameObject.veteranTrait&&(e*=this.gameObject.veteranTrait.getVeteranRofMultiplier()),Math.floor(e)}getCooldownTicks(){return this.cooldownTicks}expireCooldown(){this.cooldownTicks=0}resetCooldown(){this.cooldownTicks=this.rof}hasBurstsLeft(){return 0<this.burstsLeft}resetBursts(){this.burstsLeft=0,this.burstIndex=0,this.resetCooldown(),this.gameObject.ammoTrait&&0<this.gameObject.ammoTrait.ammo&&this.gameObject.ammoTrait.ammo--}tick(){0<this.cooldownTicks&&this.cooldownTicks--}getBurstsFired(){return this.burstIndex}fire(s,a,e=1){let n=this.gameObject,t,o=0;if(!n.airSpawnTrait||!this.rules.spawner||(t=n.airSpawnTrait.prepareLaunch(n,s,a),o=n.airSpawnTrait.availableSpawns,t)){this.burstsLeft?(this.burstsLeft--,this.burstIndex++,this.lateralMuzzleMult*=-1):(this.useBurstDelay=!1,this.burstIndex=0,t?this.burstsLeft=o:this.gameObject.isAircraft()?this.burstsLeft=this.projectileRules.iniRot<=1?T-1:this.gameObject.rules.fighter?b-1:v-1:(this.burstsLeft=this.rules.burst-1,this.useBurstDelay=!0),this.lateralMuzzleMult=1),0<this.burstsLeft&&(t&&0<o?this.cooldownTicks=this.rules.iniSpeed:this.gameObject.isAircraft()?this.cooldownTicks=this.rules.rof:this.cooldownTicks=this.useBurstDelay&&void 0!==this.gameObject.rules.burstDelay[this.burstIndex]?this.gameObject.rules.burstDelay[this.burstIndex]:a.generateRandomInt(3,5)),this.burstsLeft||this.resetBursts(),this.rules.limboLaunch&&(a.limboObject(this.gameObject,{selected:a.getUnitSelection().isSelected(this.gameObject),controlGroup:a.getUnitSelection().getOrCreateSelectionModel(this.gameObject).getControlGroupNumber()}),this.warhead.rules.parasite&&(s.obj?.isVehicle()||s.obj?.isAircraft())&&s.obj.parasiteableTrait&&(s.obj.parasiteableTrait.beingBoarded=!0));let i=t??a.createProjectile(this.projectileRules.name,this.gameObject,this,s,!1);i.isAircraft()||(i.baseDamageMultiplier=e*(this.gameObject.isUnit()?this.gameObject.crateBonuses.firepower:1));let r=this.flh.clone();r.lateral*=this.lateralMuzzleMult;var l=n.position.getMapPosition();if(a.map.isWithinHardBounds(l)){i.position.moveToLeptons(l),i.position.tileElevation=n.position.tileElevation;let e=new f.Vector2(r.lateral,r.forward);var c=this.getMuzzleFacing()+this.distributedFireAngle;e=g.rotateVec2(e,c);l=new f.Vector2(0,n.art.turretOffset),l=g.rotateVec2(l,n.direction);e.add(l),n.rules.radialFireSegments&&n.rules.distributedFire&&(l=Math.floor(180/n.rules.radialFireSegments),this.distributedFireAngle=(this.distributedFireAngle+l+90)%180-90),i.direction=c,n.isBuilding()&&n.rules.turretAnim&&(h=p.Coords.screenDistanceToWorld(n.rules.turretAnimX,n.rules.turretAnimY),c=n.getFoundationCenterOffset(),i.position.moveByLeptons(-c.x+h.x,-c.y+h.y));let t=new y.Vector3(e.x,r.vertical,-e.y);var h=t.clone().add(i.position.worldPosition);if(a.map.isWithinHardBounds(h)&&i.position.moveByLeptons3(t),i.tileElevation<0&&(i.position.tileElevation=0),i.isAircraft()?a.unlimboObject(i,i.position.tile):a.spawnObject(i,i.position.tile),this.rules.revealOnFire&&s.obj?.isTechno()){let e=a.mapShroudTrait.getPlayerShroud(s.obj.owner);e?.isShrouded(n.tile,n.tileElevation)&&e.revealTemporarily(n)}this.rules.decloakToFire&&this.gameObject.cloakableTrait?.uncloak(a),a.events.dispatch(new d.WeaponFireEvent(this,this.gameObject))}else t&&(t.owner.removeOwnedObject(t),t.dispose())}}getMuzzleFacing(){let e=this.gameObject,t;return t=!e.isInfantry()&&!e.isAircraft()&&(e.isBuilding()||e.isVehicle())&&e.turretTrait?e.turretTrait.facing:e.direction,t}}),S.NUKE_PAYLOAD_NAME="NukePayload"}}}),System.register("game/gameobject/trait/DeployerTrait",["game/gameobject/infantry/StanceType","game/gameobject/trait/interface/NotifyTick"],function(t,e){"use strict";var r,i,s,a;e&&e.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){var e;(e=s=s||{})[e.None=0]="None",e[e.PreparingToFire=1]="PreparingToFire",e[e.FiringUp=2]="FiringUp",e[e.Firing=3]="Firing",a=class{constructor(e){this.gameObject=e,this.deployed=!1,this.deployFireDelay=0,this.deployFireState=s.None,this.fireUpDelay=0,this.deployFireCount=0}isDeployed(){return this.deployed}setDeployed(t){var i=this.deployed;if((this.deployed=t)!==i){let e=this.gameObject;e.isInfantry()&&(e.stance=t?r.StanceType.Deployed:r.StanceType.None),t?(this.deployFireState=s.PreparingToFire,i=this.gameObject.armedTrait?.getDeployFireWeapon(),this.deployWeapon=i?.rules.areaFire?i:void 0,this.deployFireDelay=15+((i===e.primaryWeapon?e.secondaryWeapon:e.primaryWeapon)?.getCooldownTicks()??0),this.deployFireCount=0,this.undeployDelay=this.gameObject.rules.undeployDelay||void 0):(this.deployFireState===s.FiringUp&&(e.isFiring=!1),this.deployFireState=s.None,this.deployWeapon=void 0)}}toggleDeployed(){this.setDeployed(!this.isDeployed())}[i.NotifyTick.onTick](e,t){if(void 0!==this.undeployDelay&&(0<this.undeployDelay&&this.undeployDelay--,this.undeployDelay<=0&&[s.None,s.PreparingToFire].includes(this.deployFireState)))return this.undeployDelay=void 0,void this.setDeployed(!1);if(this.deployWeapon&&this.deployFireState!==s.None){if(this.deployFireState===s.PreparingToFire){if(0<this.deployFireDelay--||0===e.ammo)return;if(0<this.computeDeployFireCooldown(this.deployWeapon,t))return;this.fireUpDelay=Math.max(1,e.art.fireUp),this.deployFireState=s.FiringUp}if(this.deployFireState===s.FiringUp){if(e.isFiring=!0,0<this.fireUpDelay--)return;this.deployFireState=s.Firing}var i;this.deployFireState===s.Firing&&(e.isFiring=!1,i=e.onBridge?t.map.tileOccupation.getBridgeOnTile(e.tile):void 0,this.deployWeapon.fire(t.createTarget(i,e.tile),t),this.deployFireCount++,(this.deployWeapon===e.primaryWeapon?e.secondaryWeapon:e.primaryWeapon)?.resetCooldown(),this.deployWeapon.rules.fireOnce?(this.deployFireState=s.None,this.deployWeapon=void 0):this.deployFireState=s.PreparingToFire)}}computeDeployFireCooldown(t,i){if(t.rules.radLevel&&t.rules.areaFire){var r=this.gameObject.tile,s=i.mapRadiationTrait.getRadSiteLevel(r);if(!s)return 0;r=i.rules.radiation;let e=Math.max(0,s*r.radDurationMultiple-r.radLevelDelay);return 1===this.deployFireCount&&(r=r.radDurationMultiple*t.rules.radLevel,e=Math.max(0,e-Math.floor(.25*r))),e}return t.getCooldownTicks()}getHash(){return this.deployed?1:0}debugGetState(){return{deployed:this.deployed}}dispose(){this.gameObject=void 0}},t("DeployerTrait",a)}}}),System.register("game/gameobject/trait/interface/NotifySell",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onSell=Symbol(),e("NotifySell",i)}}}),System.register("game/gameobject/unit/VeteranLevel",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Veteran=1]="Veteran",e[e.Elite=2]="Elite",t("VeteranLevel",i)}}}),System.register("game/gameobject/trait/CrewedTrait",["game/gameobject/trait/interface/NotifySell","game/gameobject/trait/interface/NotifyDestroy","game/SideType","engine/type/ObjectType","game/gameobject/task/ScatterTask","game/gameobject/Infantry","game/gameobject/unit/VeteranLevel"],function(e,t){"use strict";var i,r,d,g,p,m,f,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e}],execute:function(){s=class{[i.NotifySell.onSell](e,t){this.spawnSurvivors(e,t)}[r.NotifyDestroy.onDestroy](e,t,i,r){r||i?.obj===e&&i.weapon?.rules.suicide||e.isVehicle()&&e.moveTrait.isMoving()||e.crashableTrait||this.spawnSurvivors(e,t)}spawnSurvivors(r,s){var e=s.rules.general.crew,t=r.owner.country.side;let i,a;if(t===d.SideType.GDI)i=e.alliedSurvivorDivisor,a=e.alliedCrew;else{if(t!==d.SideType.Nod)return;i=e.sovietSurvivorDivisor,a=e.sovietCrew}let n=s.sellTrait.computeRefundValue(r)/i;n=0<n&&n<1?1:Math.floor(n),n=r.isVehicle()?Math.min(1,n):Math.min(5,n);let o=[];for(let u=0;u<n;u++)o.push(a);if(0<o.length){r.rules.constructionYard&&(o[o.length-1]=s.rules.general.engineer);var l,c=s.map.tiles.getInRectangle(r.tile,r.getFoundation()).filter(e=>s.map.isWithinBounds(e));let i=[...c];for(l of o){var h=s.rules.getObject(l,g.ObjectType.Infantry);if(s.map.terrain.getPassableSpeed(r.tile,h.speedType,!r.isBuilding()&&r.onBridge,void 0,!0)){let e=s.createUnitForPlayer(h,r.owner),t=i.length?i.splice(s.generateRandomInt(0,i.length-1),1)[0]:void 0;t=t||c[s.generateRandomInt(0,c.length-1)],e.isInfantry()&&(e.position.subCell=m.Infantry.SUB_CELLS[0]),e.veteranTrait&&r.owner.canProduceVeteran(e.rules)&&e.veteranTrait.setVeteranLevel(f.VeteranLevel.Veteran),s.spawnObject(e,t),r.isBuilding()&&e.unitOrderTrait.addTask(new p.ScatterTask(s,void 0,{ignoredBlockers:r.isDestroyed?void 0:[r]}))}}}}},e("CrewedTrait",s)}}}),System.register("game/gameobject/trait/GunnerTrait",["game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class{[i.NotifyTick.onTick](e){var t,i;!!e.transportTrait.units.length!==this.lastHadGunner&&(this.lastHadGunner=!!e.transportTrait.units.length,i=t=e.transportTrait.units[0]?.rules.ifvMode??0,(t=e.rules.turretIndexesByIfvMode.get(t)??0)<e.rules.turretCount&&(e.turretNo=t,e.armedTrait?.selectSpecialWeapon(i,e.veteranLevel===r.VeteranLevel.Elite)))}getUiNameForIfvMode(e,t){switch(e){case 0:return"tip:rocket";case 1:return"tip:repair";case 2:case 4:case 5:return"tip:machinegun";default:return t?"name:"+t.toLowerCase():void 0}}},e("GunnerTrait",s)}}}),System.register("game/gameobject/trait/interface/NotifyAttack",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onAttack=Symbol(),e("NotifyAttack",i)}}}),System.register("game/gameobject/trait/interface/NotifyHeal",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onHeal=Symbol(),e("NotifyHeal",i)}}}),System.register("util/bresenham",[],function(e,t){"use strict";t&&t.id;return e("bresenham",function(s,a,n,o,l){let i=[];l=l||((e,t)=>{i.push({x:e,y:t})});var e=n-s,t=o-a,c=Math.abs(e),h=Math.abs(t);let u=0;var d=0<e?1:-1,g=0<t?1:-1;if(h<c)for(let e=s,t=a;d<0?e>=n:e<=n;e+=d)l(e,t),u+=h,u<<1>=c&&(t+=g,u-=c);else for(let i=s,r=a;g<0?r>=o:r<=o;r+=g)l(i,r),u+=c,u<<1>=h&&(i+=d,u-=h);return i}),{setters:[],execute:function(){}}}),System.register("game/gameobject/unit/LosHelper",["util/bresenham","game/type/LandType"],function(e,t){"use strict";var g,p,m,i;t&&t.id;return{setters:[function(e){g=e},function(e){p=e}],execute:function(){m=e=>void 0!==e.position,e("LosHelper",i=class{constructor(e,t){this.tiles=e,this.tileOccupation=t}hasLineOfSight(e,t,i){var r=i.warhead.rules.wall||!i.projectileRules.subjectToWalls,s=i.projectileRules.subjectToCliffs,a=i.rules.spawner;let n=0,o=!1;if(!r||s||a){var l,c,h=m(e)?e.tile:e,u=m(t)?t.tile:t;for({x:l,y:c}of g.bresenham(h.rx,h.ry,u.rx,u.ry)){var d=this.tiles.getByMapCoords(l,c);if(!d)return!1;if(!r&&d.landType===p.LandType.Wall)return!1;if(s)if(d.landType===p.LandType.Cliff){if(d.z>h.z)return!1;o=!0}else{if(d.z>h.z&&o)return!1;o=!1}if(a&&n<2&&this.tileOccupation.getBridgeOnTile(d)?.isHighBridge())return!1;n++}}return!0}})}}}),System.register("game/gameobject/task/move/MoveInWeaponRangeTask",["game/gameobject/task/move/MoveTask","game/gameobject/GameObject","game/gameobject/unit/RangeHelper","game/Coords","game/gameobject/unit/LosHelper","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RandomTileFinder","game/type/LocomotorType","util/bresenham","game/gameobject/unit/FacingUtil","game/math/Vector2"],function(e,t){"use strict";var i,n,s,o,a,l,c,h,r,u,d,g,p,m,f;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){s=e},function(e){o=e},function(e){a=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){r=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("STRAFE_CLOSE_ENOUGH",2),f=class extends i.MoveTask{constructor(e,t,i,r){super(e,t instanceof n.GameObject?t.isBuilding()?t.centerTile:t.tile:t,i,{pathFinderIgnoredBlockers:t instanceof n.GameObject&&0<r.range?[t]:void 0}),this.target=t,this.weapon=r,this.recalcMinRange=!0,this.cancelRequested=!1,this.bomberInitialLock=!1,this.rangeHelper=new s.RangeHelper(e.map.tileOccupation),this.losHelper=new a.LosHelper(e.map.tiles,e.map.tileOccupation)}onStart(i){let e=this.target,r=this.game.map;if(e instanceof n.GameObject&&e.isBuilding()&&i.rules.movementZone!==c.MovementZone.Fly){let t=e.tile;var s=e instanceof n.GameObject?e.getFoundation():{width:1,height:1},s=new l.RadialTileFinder(r.tiles,r.mapBounds,t,s,1,5,e=>0<r.terrain.getPassableSpeed(e,i.rules.speedType,!1)&&Math.abs(e.z-t.z)<2).getNextTile();s&&this.rangeHelper.tileDistance(e,s)>Math.SQRT2&&this.updateTarget(s,!1)}this.bomberInitialLock=this.isCloseEnoughToDest(i,i.tile),super.onStart(i)}cancel(){this.bomberManeuverTile?this.cancelRequested=!0:super.cancel()}shouldAirStrafe(e){return e.rules.movementZone===c.MovementZone.Fly&&e.rules.locomotor===d.LocomotorType.Aircraft&&e.rules.fighter&&1<this.weapon.projectileRules.iniRot}isBombingRun(e){return e.rules.movementZone===c.MovementZone.Fly&&e.rules.locomotor===d.LocomotorType.Aircraft&&this.weapon.projectileRules.iniRot<=1}isAirStrafeCloseEnough(e){return this.rangeHelper.tileDistance(e,this.targetTile)<Math.min(this.weapon.range,2)}bomberCanReturn(e){return!this.bomberManeuverTile||this.rangeHelper.tileDistance(e,this.bomberManeuverTile)<=1}findStrafeDestination(t,i){let e=new u.RandomTileFinder(this.game.map.tiles,this.game.map.mapBounds,i,this.weapon.range,this.game,e=>this.rangeHelper.isInWeaponRange(t,i,this.weapon,this.game.rules,e));return e.getNextTile()}hasReachedDestination(e){return super.hasReachedDestination(e)||this.canStopAtTile(e,e.tile,e.onBridge)}canStopAtTile(t,e,i){if(t.zone!==h.ZoneType.Air&&this.target instanceof n.GameObject&&this.game.map.tileOccupation.isTileOccupiedBy(e,this.target)&&(!this.target.isUnit()||this.target.tile===e&&this.target.moveTrait.moveState!==r.MoveState.Moving))return!1;if(t.zone!==h.ZoneType.Air){if(!super.canStopAtTile(t,e,i))return!1}else if(this.game.map.tileOccupation.getAirObjectsOnTile(e).filter(e=>e.isUnit()&&e.moveTrait.moveState!==r.MoveState.Moving&&e!==t).length)return!1;return!(this.isBombingRun(t)&&!this.bomberCanReturn(e))&&(!!this.isCancelling()||this.isCloseEnoughToDest(t,e))}isCloseEnoughToDest(e,t){if(e.rules.balloonHover&&!e.rules.hoverAttack)return this.rangeHelper.isInTileRange(t,this.target,0,0);if(this.weapon.rules.cellRangefinding||!e.isInfantry())return this.rangeHelper.isInWeaponRange(e,this.target,this.weapon,this.game.rules,t)&&this.losHelper.hasLineOfSight(t,this.target,this.weapon);var i=e.zone===h.ZoneType.Air?e.position.computeSubCellOffset(e.position.desiredSubCell):e.position.getTileOffset(),{minRange:r,range:s}=this.rangeHelper.computeWeaponRangeVsTarget(t,this.target,this.weapon,this.game.rules),i=o.Coords.tile3dToWorld(t.rx+i.x/o.Coords.LEPTONS_PER_TILE,t.ry+i.y/o.Coords.LEPTONS_PER_TILE,t.z+e.position.tileElevation);return(e.isUnit()&&e.rules.movementZone===c.MovementZone.Fly?this.rangeHelper.isInRange2(i,this.target,r,s):this.rangeHelper.isInRange3(i,this.target,r,s))&&this.losHelper.hasLineOfSight(t,this.target,this.weapon)}findRelocationTile(t,e,i){if(i.rules.movementZone!==c.MovementZone.Fly)return super.findRelocationTile(t,e,i);{var r=this.game.map;let e=new u.RandomTileFinder(r.tiles,r.mapBounds,t,1,this.game,e=>this.isCancelling()||this.isCloseEnoughToDest(i,e));return e.getNextTile()}}retarget(e,t){var i=e instanceof n.GameObject?e.isBuilding()?e.centerTile:e.tile:e;this.bomberManeuverTile?this.bomberQueuedTargetTile=i:(this.updateTarget(i,t),this.recalcMinRange=!0),this.target=e,this.options?.ignoredBlockers&&(this.options.ignoredBlockers=e instanceof n.GameObject?[e]:void 0),this.options??(this.options={}),this.options.pathFinderIgnoredBlockers=e instanceof n.GameObject?[e]:void 0}onTick(s){if(this.recalcMinRange){this.recalcMinRange=!1;var e=this.findMinRangeRelocationTile(s,this.targetTile);if(e!==this.targetTile){if(!e)return this.cancel(),!1;this.updateTarget(e,!!e.onBridgeLandType)}}if(this.shouldAirStrafe(s)&&!this.isCancelling()&&(this.updateTarget(this.target instanceof n.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target,!1),!this.isAirStrafeCloseEnough(s)||(a=this.findStrafeDestination(s,this.targetTile))&&this.updateTarget(a,!1)),this.isBombingRun(s)&&!this.isCancelling()&&(!s.ammo||this.weapon.getBurstsFired()||this.bomberInitialLock)&&!this.bomberManeuverTile){this.bomberInitialLock=!1;let e=s.position.getMapPosition();var a=this.target instanceof n.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target;let t=new m.Vector2(a.rx+.5,a.ry+.5).clone().multiplyScalar(o.Coords.LEPTONS_PER_TILE).sub(e),i=t.length();i||(t.copy(p.FacingUtil.toMapCoords(s.direction)),i=Number.EPSILON);let r=e.clone().add(t.setLength(i+7*o.Coords.LEPTONS_PER_TILE));a=r.multiplyScalar(1/o.Coords.LEPTONS_PER_TILE).floor(),a=g.bresenham(a.x,a.y,s.tile.rx,s.tile.ry);if(!a.length)throw new Error("Bresenham returned no tiles");a=a[0];this.bomberManeuverTile=this.game.map.tiles.getByMapCoords(a.x,a.y)??this.game.map.tiles.getPlaceholderTile(a.x,a.y),this.options.allowOutOfBoundsTarget=!0,this.updateTarget(this.bomberManeuverTile,!1)}return this.bomberManeuverTile&&this.bomberCanReturn(s.tile)&&(this.bomberManeuverTile=void 0,this.bomberQueuedTargetTile&&(this.updateTarget(this.bomberQueuedTargetTile,!1),this.recalcMinRange=!0,this.bomberQueuedTargetTile=void 0)),this.cancelRequested&&(this.bomberManeuverTile||(this.cancelRequested=!1,this.cancel())),!!(this.isBombingRun(s)&&this.isCancelling()&&this.forceCancel(s))||super.onTick(s)}forceCancel(e){return!this.bomberManeuverTile&&super.forceCancel(e)}findMinRangeRelocationTile(e,t){var{minRange:i,range:r}=this.rangeHelper.computeWeaponRangeVsTarget(e,this.target,this.weapon,this.game.rules);return e.rules.locomotor===d.LocomotorType.Chrono?this.rangeHelper.isInRange(e,this.target,r-1,r,this.weapon.rules.cellRangefinding)?t:this.findTileInRange(e,t,r-1,2*r)??t:this.rangeHelper.isInRange(e,this.target,i,Number.POSITIVE_INFINITY,this.weapon.rules.cellRangefinding)?t:this.findTileInRange(e,t,2*i,r-i)}findTileInRange(t,e,i,r){let s=this.game.map;var a,n=new m.Vector2(t.tile.rx-e.rx,t.tile.ry-e.ry).setLength(i).floor().add(new m.Vector2(e.rx,e.ry));let o;for(a of g.bresenham(n.x,n.y,e.rx,e.ry))if(o=s.tiles.getByMapCoords(a.x,a.y),o)break;if(o){let e=new l.RadialTileFinder(s.tiles,s.mapBounds,o,{width:1,height:1},0,r,e=>this.rangeHelper.isInWeaponRange(t,this.target,this.weapon,this.game.rules,e)&&this.losHelper.hasLineOfSight(e,this.target,this.weapon)&&0<s.terrain.getPassableSpeed(e,t.rules.speedType,!!e.onBridgeLandType)&&!s.terrain.findObstacles({tile:e,onBridge:!!e.onBridgeLandType},t).length);return e.getNextTile()}}},e("MoveInWeaponRangeTask",f)}}}),System.register("game/gameobject/task/system/TaskRunner",["game/gameobject/task/system/TaskStatus"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("TaskRunner",i=class{tick(e,t){this.tickChildren(e,t)}startTask(e,t){if(e.status!==o.TaskStatus.NotStarted)throw new Error("Attempted to start a task with status "+e.status);e.status=o.TaskStatus.Running,e.onStart(t)}tickTask(e,t){let i=this.tickChildren(e.children,t);var r=e.children.find(e=>e.blocking);if(!i&&r)return!1;if(!t.isSpawned)return!1;if(e.status===o.TaskStatus.NotStarted)throw new Error("Attempted tick on a non-started task");if(e.isRunning()||e.isCancelling()){var s=e.isCancelling(),a=!!e.waitingForChildrenToFinish||e.onTick(t);e.children.length&&!r&&a&&(i=e.children.every(e=>e.status===o.TaskStatus.Cancelled||e.status===o.TaskStatus.Finished),e.waitingForChildrenToFinish=!i);a=a&&i;return a&&(e.onEnd(t),e.status=s?o.TaskStatus.Cancelled:o.TaskStatus.Finished),a}return!0}tickChildren(r,s){let a=!0;if(r.length){let t=new Set,i;for(;s.isSpawned&&(i=r.find(e=>!t.has(e)));){let e;if(i.status===o.TaskStatus.NotStarted&&this.startTask(i,s),i.status===o.TaskStatus.Running||i.status===o.TaskStatus.Cancelling)e=!0===this.tickTask(i,s);else{if(i.status!==o.TaskStatus.Cancelled)throw new Error("Unhandled task status "+o.TaskStatus[i.status]);e=!0}if(e){var n=r.indexOf(i);-1!==n&&r.splice(n,1)}else{if(a=!1,i.blocking)break;t.add(i)}}}return a}})}}}),System.register("game/type/VhpScan",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Strong=2]="Strong",t("VhpScan",i)}}}),System.register("game/event/ObjectDisguiseChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectDisguiseChangeEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.ObjectDisguiseChange}})}}}),System.register("game/gameobject/trait/DisguiseTrait",["engine/type/ObjectType","game/event/ObjectDisguiseChangeEvent","game/SideType","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/MoveTrait"],function(e,t){"use strict";var r,s,i,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class{constructor(){this.isActive=!1,this.cooldownTicks=0}isDisguised(){return this.isActive}getDisguise(){return this.isActive?this.disguisedAs:void 0}hasTerrainDisguise(){return this.getDisguise()?.rules.type===r.ObjectType.Terrain}disguiseAs(e,t,i){this.disguisedAs={rules:e.rules,owner:e.owner},this.isActive=!0,i.events.dispatch(new s.ObjectDisguiseChangeEvent(t))}revealDisguise(e,t){this.cooldownTicks=t.rules.general.infantryBlinkDisguiseTime,this.isActive=!1,t.events.dispatch(new s.ObjectDisguiseChangeEvent(e))}[o.NotifySpawn.onSpawn](e,t){var i;!this.disguisedAs&&e.rules.permaDisguise&&e.isInfantry()&&e.owner.country&&((i=this.getDefaultInfantryDisguise(e.owner.country.side,t.rules.general))&&(i=t.rules.getObject(i,r.ObjectType.Infantry),this.disguisedAs={rules:i,owner:e.owner},this.isActive=!0))}getDefaultInfantryDisguise(e,t){switch(e){case i.SideType.GDI:return t.alliedDisguise;case i.SideType.Nod:return t.sovietDisguise;default:return}}[l.NotifyTick.onTick](e,t){e.rules.permaDisguise||(e.attackTrait?.attackState===a.AttackState.JustFired||e.moveTrait.moveState!==c.MoveState.Idle?this.revealDisguise(e,t):0<this.cooldownTicks?this.cooldownTicks--:!this.isActive&&e.rules.disguiseWhenStill&&(this.isActive=!0,this.disguisedAs={rules:this.selectRandomMirageDisguise(t),owner:void 0},t.events.dispatch(new s.ObjectDisguiseChangeEvent(e))))}[n.NotifyDamage.onDamage](e,t){this.revealDisguise(e,t)}selectRandomMirageDisguise(e){var t=e.rules.general.defaultMirageDisguises;if(!t.length)throw new Error("No default mirage disguises are defined");t=t[e.generateRandomInt(0,t.length-1)];return e.rules.getObject(t,r.ObjectType.Terrain)}},e("DisguiseTrait",h)}}}),System.register("game/gameobject/trait/AttackTrait",["util/typeGuard","game/type/ArmorType","game/gameobject/unit/ZoneType","game/gameobject/task/AttackTask","game/SideType","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyDamage","game/gameobject/task/system/TaskRunner","game/Target","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/Coords","game/gameobject/trait/interface/NotifyTeleport","game/type/VhpScan","game/gameobject/unit/LosHelper","game/math/Vector2","game/math/Box2"],function(t,e){"use strict";var n,s,h,u,a,i,r,o,l,c,d,g,p,m,f,y,T,v,b,S,w,C;e&&e.id;return{setters:[function(e){n=e},function(e){s=e},function(e){h=e},function(e){u=e},function(e){a=e},function(e){i=e},function(e){r=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e}],execute:function(){var e;(e=w=w||{})[e.Idle=0]="Idle",e[e.CheckRange=1]="CheckRange",e[e.PrepareToFire=2]="PrepareToFire",e[e.FireUp=3]="FireUp",e[e.Firing=4]="Firing",e[e.JustFired=5]="JustFired",t("AttackState",w),C=class{constructor(e,t){this.disabled=!1,this.attackState=w.Idle,this.passiveScanCooldownTicks=0,this.taskRunner=new l.TaskRunner,this.distributedFireHistory=new Map,this.rangeHelper=new r.RangeHelper(t),this.losHelper=new v.LosHelper(e,t)}isIdle(){return this.attackState===w.Idle}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}isOnCooldown(e){let t=[e.primaryWeapon,e.secondaryWeapon],i=e.armedTrait?.getDeployFireWeapon();return i?.rules.areaFire&&!i.rules.fireOnce&&(t=t.filter(e=>e!==i)),t.some(e=>0<(e?.getCooldownTicks()??0))}expirePassiveScanCooldown(){this.passiveScanCooldownTicks=0}cancelOpportunityFire(){this.opportunityFireTask?.cancel()}selectDefaultWeapon(e){let i;if((e.isInfantry()||e.isVehicle())&&e.rules.deployFire){let t=e.armedTrait?.getDeployFireWeapon();i=e.deployerTrait?.isDeployed()?t&&!t.rules.areaFire?t:void 0:[e.primaryWeapon,e.secondaryWeapon].find(e=>e!==t)}else i=e.isBuilding()&&e.garrisonTrait?e.garrisonTrait.isOccupied()?e.owner.country.side===a.SideType.GDI?e.primaryWeapon:e.secondaryWeapon??e.primaryWeapon:void 0:e.isBuilding()&&e.overpoweredTrait?e.overpoweredTrait.getWeapon():e.primaryWeapon;return i}selectWeaponVersus(e,t,i,r=!1,s=!1){var a=t.tile;const n=t instanceof c.Target?t.obj:t;var o=this.getAvailableWeapons(e,s,n?.isOverlay()||r&&!n);return this.selectWeaponFromList(e,n,a,o,i,r,s,!1)}selectWeaponFromList(e,t,i,r,s,a,n,o){if((!t?.isInfantry()&&!t?.isVehicle()||!t.disguiseTrait||this.canAttackThroughDisguise(e,t,t.disguiseTrait,s,a,n,o))&&(t?.isBuilding()&&t.overpoweredTrait&&t.owner===e.owner&&r.find(e=>e.warhead.rules.electricAssault)&&(r=r.filter(e=>e.warhead.rules.electricAssault)),!(n&&t?.isAircraft()&&t.missileSpawnTrait&&t.zone!==h.ZoneType.Air))){var l=t?.isTechno()?t.rules.armor:void 0;for(const c of r)if(c.targeting.canTarget(t,i,s,a,n)&&(void 0===l||this.checkArmor(c.warhead.rules,l,n)))return c}}getAvailableWeapons(e,t,i){let r;var s;return r=(e.isInfantry()||e.isVehicle())&&e.rules.deployFire&&e.armedTrait?(s=e.armedTrait.getDeployFireWeapon(),[e.deployerTrait?.isDeployed()?s.rules.areaFire?void 0:s:s===e.secondaryWeapon?e.primaryWeapon:e.secondaryWeapon]):e.isBuilding()&&e.garrisonTrait?e.garrisonTrait.isOccupied()?[e.owner.country.side===a.SideType.GDI?e.primaryWeapon:e.secondaryWeapon??e.primaryWeapon]:[]:e.isBuilding()&&e.overpoweredTrait?[e.overpoweredTrait.getWeapon()]:i||t?[e.primaryWeapon,!i&&t&&e.secondaryWeapon&&(e.secondaryWeapon.projectileRules.isAntiAir||e.secondaryWeapon.rules.spawner||e.secondaryWeapon.warhead.rules.electricAssault)?e.secondaryWeapon:void 0]:[e.primaryWeapon,e.secondaryWeapon],r.filter(e=>e&&!e.rules.neverUse)}canAttackThroughDisguise(e,t,i,r,s,a,n){if(!s&&i.hasTerrainDisguise()&&!r.areFriendly(e,t)&&!e.owner.sharedDetectDisguiseTrait?.has(t))return!1;if(a){if(n&&t.moveTrait.isIdle()&&!e.rules.detectDisguise&&!r.areFriendly(t,e))return!1;var o=i.getDisguise();if(o?.owner&&!e.rules.detectDisguise&&!e.owner.sharedDetectDisguiseTrait?.has(t)&&(o.owner===e.owner||r.alliances.areAllied(e.owner,o.owner)))return!1}return!0}checkArmor(e,t,i){var r=e.ivanBomb||e.bombDisarm||e.nukeMaker?1:e.verses.get(t);return void 0===r?(console.warn(`Unhandled ArmorType ${s.ArmorType[t]} in warhead ${e.name} verses`),!1):!(100*r<=(i?1:0))}createAttackTask(e,t,i,r,s){return new u.AttackTask(e,e.createTarget(t,i),r,s)}[i.NotifyTick.onTick](a,n){if(!this.isDisabled()){var e;if(this.opportunityFireTask&&(!a.unitOrderTrait.hasTasks()||a.isUnit()&&!a.unitOrderTrait.getTasks()[0].preventOpportunityFire||(a.unitOrderTrait.getTasks()[0]instanceof u.AttackTask?this.opportunityFireTask=void 0:this.opportunityFireTask.cancel()),this.opportunityFireTask&&(e=[this.opportunityFireTask],this.taskRunner.tick(e,a),e.length||(this.opportunityFireTask=void 0))),!this.opportunityFireTask&&this.retaliateTarget){var o=this.retaliateTarget;this.retaliateTarget=void 0;let e;!a.unitOrderTrait.hasTasks()&&n.isValidTarget(o)&&(e=this.selectWeaponVersus(a,o,n,!1))&&a.unitOrderTrait.addTask(this.createAttackTask(n,o,o.tile,e,{holdGround:a.rules.movementZone===m.MovementZone.Fly}))}if(!this.opportunityFireTask&&this.shouldPassiveAcquire(a))if(0<this.passiveScanCooldownTicks)this.passiveScanCooldownTicks--;else{this.passiveScanCooldownTicks=a.guardMode?n.rules.general.guardAreaTargetingDelay:n.rules.general.normalTargetingDelay;let e=this.selectDefaultWeapon(a);o=a.unitOrderTrait.hasTasks();let t=void 0,i,r;!o&&a.guardMode&&e&&a.owner.isCombatant()&&(t=a.armedTrait?.computeGuardScanRange(e),i=a.guardArea?.tile,r=50);let s=!1;if(e){var l=this.scanForTarget(a,e,n,t,i);if(l.target){let{target:e,weapon:t}=l;var c=this.createAttackTask(n,e,e.tile,t,{holdGround:o||a.rules.movementZone===m.MovementZone.Fly&&!a.guardMode||a.rules.movementZone!==m.MovementZone.Fly&&e.isUnit()&&e.zone===h.ZoneType.Air||(a.isInfantry()||a.isVehicle())&&!!a.disguiseTrait||!a.owner.isCombatant(),disallowTurning:o,leashTiles:r,passive:!0});o?this.opportunityFireTask=c:a.unitOrderTrait.addTask(c),s=!0,o||!a.guardMode||a.guardArea||(a.guardArea={tile:a.tile,onBridge:!!a.isUnit()&&a.onBridge})}}s||o||!a.secondaryWeapon?.warhead.rules.electricAssault||(e=a.secondaryWeapon,(l=this.scanForTarget(a,e,n,void 0,void 0,!0)).target&&({target:c,weapon:l}=l,l=this.createAttackTask(n,c,c.tile,l,{passive:!0}),a.unitOrderTrait.addTask(l),s=!0)),!s&&!o&&a.guardArea&&a.isUnit()&&a.moveTrait&&!a.moveTrait.isDisabled()&&a.guardArea.tile!==a.tile&&a.unitOrderTrait.addTasks(new d.MoveTask(n,a.guardArea.tile,a.guardArea.onBridge),new g.CallbackTask(()=>{[p.MoveResult.Success,p.MoveResult.CloseEnough].includes(a.moveTrait.lastMoveResult)||a.resetGuardModeToIdle(),a.guardArea=void 0}))}}}[o.NotifyDamage.onDamage](e,t,i,r){this.isDisabled()||!this.retaliateTarget&&!this.opportunityFireTask&&r&&r.obj&&r.weapon&&this.shouldRetaliate(e,t,i,r.obj,r.weapon.warhead)&&(this.retaliateTarget=r.obj)}[y.NotifyTeleport.onBeforeTeleport](e,t,i,r){r||(this.attackState=w.Idle,this.currentTarget=void 0,this.retaliateTarget=void 0,this.opportunityFireTask=void 0)}shouldPassiveAcquire(e){if(!e.owner.isCombatant()&&e.rules.needsEngineer||!e.rules.canPassiveAquire||!e.primaryWeapon)return!1;if(e.mindControllerTrait?.isAtCapacity())return!1;if(e.isUnit()&&e.rules.opportunityFire){if(e.unitOrderTrait.hasTasks()&&e.unitOrderTrait.getTasks()[0].preventOpportunityFire)return!1}else if(e.unitOrderTrait.hasTasks())return!1;return!0}shouldRetaliate(e,t,i,r,s){return!(i<1||t.areFriendly(e,r)||!e.rules.canRetaliate||!e.primaryWeapon||s.rules.temporal||r.rules.missileSpawn||e.unitOrderTrait.hasTasks()||!t.isValidTarget(r)||(r.isInfantry()||r.isVehicle())&&r.disguiseTrait&&!e.rules.detectDisguise||e.mindControllerTrait?.isAtCapacity()||!this.selectWeaponVersus(e,r,t,!1)||(e.isBuilding()||r.isBuilding()?this.rangeHelper.tileDistance(e,r):this.rangeHelper.distance2(e,r)/f.Coords.LEPTONS_PER_TILE)>e.sight)}scanForTarget(e,t,i,r,s,a=!1){let n={},o=Number.NEGATIVE_INFINITY;var l=this.getAvailableWeapons(e,!0,!1),c=r??(e.rules.guardRange||t.range)+1+3+i.rules.elevationModel.bonusCap+(t.projectileRules.isAntiAir?e.rules.airRangeBonus:0);for(const d of this.scanTechnosAround(e,c,i)){var h,u=this.selectWeaponFromList(e,d,d.tile,l,i,!1,!0,!0);u&&this.canPassiveAcquire(d,i)&&i.isValidTarget(d)&&(r?this.rangeHelper.isInRange(e,d,u.minRange,r,u.rules.cellRangefinding)&&(!s||this.rangeHelper.isInRange2(s,d,0,r)):this.rangeHelper.isInWeaponRange(e,d,u,i.rules))&&(a||this.losHelper.hasLineOfSight(e,d,u))&&(h=this.rangeHelper.distance3(e,d)/f.Coords.LEPTONS_PER_TILE,(h=this.computeThreat(d,e,u,h,i.rules.general.threat))>o&&(n={target:d,weapon:u},o=h))}return n.target&&e.rules.distributedFire&&this.updateDistributedFireHistory(n),n}scanTechnosAround(e,t,i){var r=e.getFoundation();const s=new b.Vector2(e.tile.rx,e.tile.ry),a=new b.Vector2(e.tile.rx+r.width-1,e.tile.ry+r.height-1);s.addScalar(-t),a.addScalar(t);r=new S.Box2(s,a);return i.map.technosByTile.queryRange(r)}canPassiveAcquire(e,t){return!e.owner.isNeutral&&!e.rules.civilian&&!e.rules.insignificant&&(1<e.rules.threatPosed||0<e.rules.specialThreatValue&&!e.isBuilding()||e.rules.harvester||e.name===t.rules.general.paradrop.paradropPlane)}computeThreat(e,t,i,r,s){let a=[e.primaryWeapon,e.secondaryWeapon].filter(n.isNotNullOrUndefined).map(e=>e.warhead.rules.verses.get(t.rules.armor)??0).reduce((e,t)=>Math.max(e,t),0)*s.targetEffectivenessCoefficientDefault;return e.attackTrait?.currentTarget?.obj===t&&(a*=-1),a+=e.rules.specialThreatValue*s.targetSpecialThreatCoefficientDefault,a+=(i.warhead.rules.verses.get(e.rules.armor)??0)*s.myEffectivenessCoefficientDefault,a+=e.healthTrait.health/100*s.targetStrengthCoefficientDefault,a+=r*s.targetDistanceCoefficientDefault,t.rules.distributedFire&&(a-=1e6*(this.distributedFireHistory.get(e)??0)),t.rules.vhpScan===T.VhpScan.Strong&&e.healthTrait.getProjectedHitPoints()<=0&&(a-=1e6),a}updateDistributedFireHistory(e){if(50!==this.distributedFireHistory.get(e.target)){for(var[t,i]of this.distributedFireHistory)i--,i<=0?this.distributedFireHistory.delete(t):this.distributedFireHistory.set(t,i);this.distributedFireHistory.set(e.target,50)}}dispose(){this.distributedFireHistory.clear()}},t("AttackTrait",C)}}}),System.register("game/gameobject/task/AttackTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/gameobject/task/system/WaitMinutesTask","game/WeaponType","game/gameobject/task/move/MoveInWeaponRangeTask","game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/AttackTrait","game/gameobject/GameObject","game/gameobject/unit/LosHelper","game/gameobject/trait/MoveTrait","game/GameSpeed","game/Coords","engine/type/ObjectType","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/unit/ZoneType","game/type/MovementZone","game/gameobject/task/system/TaskStatus","game/gameobject/task/move/MoveTask","game/math/Vector3","game/math/Vector2"],function(e,t){"use strict";var i,s,d,g,p,m,f,y,T,v,a,b,S,w,n,C,E,x,O,r,o,A,M,R,P,I,l;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){a=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){n=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){r=e},function(e){o=e},function(e){A=e},function(e){M=e}],execute:function(){R=3,I=4*(P=11.25),l=class l extends i.Task{constructor(e,t,i,r={}){super(),this.game=e,this.target=t,this.weapon=i,this.options=r,this.moveExecuted=!1,this.moveAttempts=0,this.rangeCheckCooldown=0,this.lastInRangeTargetPosition=new A.Vector3,this.lastInRangeSelfPosition=new A.Vector3,this.initialIndirectTarget=!1,this.forceDropTarget=!1,this.rangeHelper=new s.RangeHelper(e.map.tileOccupation),this.losHelper=new a.LosHelper(e.map.tiles,e.map.tileOccupation),this.targetLinesConfig={pathNodes:[]},this.updateTargetLines(this.target,!0)}duplicate(){return new l(this.game,this.target,this.weapon,this.options)}getWeapon(){return this.weapon}setWeapon(e){this.weapon=e}setForceAttack(e){this.options.force=e}requestTargetUpdate(e){this.target.equals(e)||(this.needsTargetUpdate=e)}onTargetChange(e){let t=e.attackTrait,i=this.target;t.currentTarget=i,this.lastValidTargetPosition=i.obj?{tile:i.tile,onBridge:i.getBridge()}:void 0,this.initialTargetOwner=i.obj?.isTechno()?i.obj.owner:void 0,this.initialIndirectTarget=!i.obj&&this.game.map.tileOccupation.getObjectsOnTile(i.tile).some(e=>e.isOverlay()&&!e.isBridgePlaceholder()||e.isTerrain()),this.updateTargetLines(i,!0)}updateTargetLines(e,t){this.targetLinesConfig.target=e.obj,this.targetLinesConfig.pathNodes=e.obj?[]:[{tile:e.tile,onBridge:e.getBridge()}],this.targetLinesConfig.isAttack=t}onStart(t){if(!t.attackTrait)throw new Error(`Object ${t.name} has no attack trait`);if(0!==t.ammo){let e=this.game.map.tileOccupation;var i,r;t.attackTrait.attackState=T.AttackState.CheckRange,this.onTargetChange(t),this.initialSelfPosition={tile:t.tile,onBridge:t.isUnit()&&t.onBridge?e.getBridgeOnTile(t.tile):void 0},this.weapon.rules.limboLaunch&&t.isUnit()&&!this.target.obj&&(this.forceDropTarget=!0,{reachable:i,fallback:r}=this.findReachableMeleePosition(this.target.tile,!!this.target.getBridge(),{width:1,height:1},t),!i&&r&&(this.lastValidTargetPosition=r,this.updateTargetLines(this.game.createTarget(r.onBridge,r.tile),!1))),this.weapon.rules.limboLaunch&&this.target.obj?.isTechno()&&t.isUnit()&&!this.rangeHelper.isInWeaponRange(t,this.target.obj,this.weapon,this.game.rules)&&({reachable:i,fallback:r}=this.findReachableMeleePosition(this.target.obj.tile,this.target.obj.isUnit()&&this.target.obj.onBridge,this.target.obj.getFoundation(),t),i||(1<(t.unitOrderTrait.waypointPath?.waypoints?.length??0)?this.cancel():(this.forceDropTarget=!0,r&&(this.lastValidTargetPosition=r,this.updateTargetLines(this.game.createTarget(r.onBridge,r.tile),!1))))),this.rangeHelper.isInWeaponRange(t,this.target.obj??this.target.tile,this.weapon,this.game.rules)&&t.isUnit()&&t.rules.movementZone===O.MovementZone.Fly&&t.zone!==x.ZoneType.Air&&(t.rules.hoverAttack||t.isAircraft())&&this.children.push(new o.MoveTask(this.game,t.tile,!1).setCancellable(!1))}else this.cancel()}findReachableMeleePosition(r,e,t,s){let i=this.game.map,a=i.tileOccupation,n=e?a.getBridgeOnTile(r):void 0,o=new E.MovePositionHelper(i),l=s.rules.movementZone===O.MovementZone.Fly,c=(e,t)=>l||0<i.terrain.getPassableSpeed(e,s.rules.speedType,!!t)&&o.isEligibleTile(e,t,n,r)&&!i.terrain.findObstacles({tile:e,onBridge:t},s).length,h,u=new C.RadialTileFinder(i.tiles,i.mapBounds,r,t,1,Math.ceil(this.weapon.rules.range),e=>{let t=!1;var i;return c(e,void 0)&&(h=h??{tile:e,onBridge:void 0},t=!0),void 0!==e.onBridgeLandType&&(i=a.getBridgeOnTile(e),c(e,i)&&(h=h??{tile:e,onBridge:i},t=!0)),!!t&&this.rangeHelper.isInWeaponRange(s,r,this.weapon,this.game.rules,e)});return{reachable:u.getNextTile(),fallback:h}}onEnd(e){e.isVehicle()&&e.turretTrait&&(e.turretTrait.desiredFacing=e.direction),e.attackTrait.attackState=T.AttackState.Idle,e.attackTrait.currentTarget=void 0;var t=this.game.rules.general.prism.type;e.isBuilding()&&e.name===t&&this.weapon.type!==g.WeaponType.Secondary&&this.countSupportBeamsAndFireDownTowers(e,t),this.weapon.rules.limboLaunch&&e.attackTrait.expirePassiveScanCooldown(),(e.isInfantry()||e.isVehicle())&&(e.isFiring=!1),this.weapon.hasBurstsLeft()&&this.weapon.resetBursts()}forceCancel(t){if(t.rules.movementZone!==O.MovementZone.Fly)return!1;if(!this.cancellable||this.children.some(e=>!e.cancellable))return!1;if(this.status===r.TaskStatus.Running||this.status===r.TaskStatus.Cancelling){if(this.children.filter(e=>e instanceof o.MoveTask).some(e=>!e.forceCancel(t)))return!1;this.onEnd(t),(t.isInfantry()||t.isVehicle())&&(t.isFiring=!1)}return this.status=r.TaskStatus.Cancelled,!0}onTick(i){let r=i.attackTrait;(i.isInfantry()||i.isVehicle())&&r.attackState!==T.AttackState.Firing&&(i.isFiring=!1);let s=this.target.obj,a=this.children.find(e=>e instanceof p.MoveInWeaponRangeTask);if(this.isCancelling()&&r.attackState!==T.AttackState.FireUp)return!i.airSpawnTrait?.isLaunchingMissiles()&&(a?.cancel(),!0);let n=!1;if(r.attackState===T.AttackState.FireUp){if(r.isDisabled())return!0;r.attackState=T.AttackState.Firing,n=!0}if(r.attackState===T.AttackState.Firing){if(this.initialIndirectTarget&&!this.game.map.getObjectsOnTile(this.target.tile).find(e=>e.isOverlay()&&!e.isBridgePlaceholder()||e.isTerrain()))return this.cancel(),this.onTick(i);if(n){var o=this.target.obj||this.target.tile;if(!this.game.isValidTarget(this.target.obj)||this.shouldDropTarget(this.target.obj)||!this.weapon.targeting.canTarget(this.target.obj,this.target.tile,this.game,!!this.options.force,!!this.options.passive)||!this.rangeHelper.isInWeaponRange(i,o,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(i,o,this.weapon))return r.attackState=T.AttackState.CheckRange,this.onTick(i)}if(this.weapon.rules.limboLaunch){if((s?.isVehicle()||s?.isAircraft())&&s.parasiteableTrait?.isInfested())return!0;if(i.rules.movementZone!==O.MovementZone.Fly&&s?.isUnit()&&s.zone===x.ZoneType.Air)return!0}if(this.target.tile.onBridgeLandType&&i.tile.onBridgeLandType&&i.isUnit()&&(this.game.map.tileOccupation.getBridgeOnTile(this.target.tile)?.isHighBridge()||this.game.map.tileOccupation.getBridgeOnTile(i.tile)?.isHighBridge()))if((s?s.isUnit()&&(s.zone===x.ZoneType.Air||s.onBridge):this.target.isBridge())!==(i.zone===x.ZoneType.Air||i.onBridge)&&this.game.map.bridges.findHighBridgeBoundary(i.tile)?.tile===this.game.map.bridges.findHighBridgeBoundary(this.target.tile)?.tile)return!0;let e=1;o=this.game.rules.general.prism.type;if(i.isBuilding()&&i.name===o&&this.weapon.type!==g.WeaponType.Secondary&&(o=this.countSupportBeamsAndFireDownTowers(i,o),e=1+o*this.game.rules.general.prism.supportModifier),this.weapon.rules.spawner&&(i.isVehicle()||i.isAircraft())&&i.parasiteableTrait?.isParalyzed())return!0;if(0===i.ammo)return i.isAircraft()&&(i.rules.fighter||i.rules.spawned)&&a?.cancel(),!0;let t=!1;if(this.weapon.rules.limboLaunch&&a){if(!a.forceCancel(i))return!1;i.moveTrait.lastTargetOffset=void 0,i.moveTrait.lastVelocity=void 0,t=!0}return(this.weapon.fire(this.target,this.game,e),t)?!0:!!this.weapon.rules.fireOnce||(!(!this.options.passive||!i.rules.distributedFire)||(r.attackState=T.AttackState.JustFired,!1))}if(r.attackState===T.AttackState.JustFired)return r.attackState=T.AttackState.PrepareToFire,this.onTick(i);this.needsTargetUpdate&&(this.target=this.needsTargetUpdate,s=this.target.obj,this.needsTargetUpdate=void 0,this.onTargetChange(i),s||a?.retarget(this.target.tile,!!this.target.getBridge())),s?.isTechno()&&s.replacedBy&&(l=this.game.createTarget(s.replacedBy,s.replacedBy.tile),this.target=l,s=s.replacedBy,this.onTargetChange(i));let t=this.game.isValidTarget(s)&&!this.shouldDropTarget(s);if(t){let e=this.weapon.targeting.canTarget(s,this.target.tile,this.game,!!this.options.force,!!this.options.passive);if(!e||!i.armedTrait.isEquippedWithWeapon(this.weapon)){var l=r.selectWeaponVersus(i,this.target,this.game,this.options.force,this.options.passive);if(l){if(this.setWeapon(l),r.attackState!==T.AttackState.CheckRange)return r.attackState=T.AttackState.CheckRange,this.onTick(i);e=!0}else e=!1}t=e}if(t&&(c=this.lastTargetTpCheck,s?.isUnit()&&c&&s.moveTrait.lastTeleportTick>=c?(t=!1,this.rangeCheckCooldown=0):this.lastTargetTpCheck=this.game.currentTick),t&&s&&(this.lastValidTargetPosition={tile:s.tile,onBridge:this.target.getBridge()}),t||(this.targetLinesConfig.isAttack=!1),r.attackState===T.AttackState.CheckRange){if(0<this.rangeCheckCooldown)return this.rangeCheckCooldown--,!1;let e=this.target.obj?t?this.target.obj:this.lastValidTargetPosition.tile:this.target.tile;var c=this.target.obj?t?this.target.obj.isBuilding()?this.target.obj.centerTile:this.target.obj.tile:this.lastValidTargetPosition.tile:this.target.tile;if(!this.rangeHelper.isInWeaponRange(i,e,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(i,e,this.weapon)||i.isUnit()&&i.rules.balloonHover&&!i.rules.hoverAttack&&!a&&i.tile!==c||i.isAircraft()&&this.weapon.projectileRules.iniRot<=1&&!a){if(i.isUnit()&&!this.options.holdGround&&this.game.map.isWithinBounds(c)){if(a){if(a.target!==this.target.obj||t)if(t&&this.target.obj&&this.rangeHelper.tileDistance(this.target.obj,this.lastSelfMoveTargetTile)>this.weapon.range)a.retarget(this.target.obj,!!this.target.getBridge()),this.lastSelfTileBeforeMove=i.tile,this.lastSelfMoveTargetTile=this.target.obj?.tile??this.target.tile;else{if(void 0!==this.options.leashTiles&&this.rangeHelper.tileDistance(this.initialSelfPosition.tile,i.tile)>this.options.leashTiles)return a.cancel(),!0;var h=e instanceof v.GameObject&&e.isUnit()?e.moveTrait.baseSpeed:0,u=Math.ceil((this.rangeHelper.tileDistance(i,e)-(this.weapon.range+1))/((i.moveTrait.baseSpeed+h)/w.Coords.LEPTONS_PER_TILE));0<u&&(this.rangeCheckCooldown=Math.min(S.GameSpeed.BASE_TICKS_PER_SECOND,u))}else{let e;e=void 0!==this.options.leashTiles?this.game.createTarget(this.initialSelfPosition.onBridge,this.initialSelfPosition.tile):this.game.createTarget(this.lastValidTargetPosition.onBridge,this.lastValidTargetPosition.tile),r.currentTarget=e,a.retarget(e.tile,e.isBridge()),this.updateTargetLines(e,!1)}return!1}if(!i.moveTrait||i.moveTrait.isDisabled())return!0;if(this.isCancelling())return!0;if(i.tile===this.lastSelfTileBeforeMove||this.moveExecuted&&i.moveTrait.lastMoveResult===b.MoveResult.Fail?this.moveAttempts++:this.moveAttempts=0,this.weapon.rules.limboLaunch&&i.defaultToGuardArea&&s&&this.moveExecuted&&i.moveTrait.lastMoveResult===b.MoveResult.Fail&&this.rangeHelper.isInRange(i,s,0,i.armedTrait.computeGuardScanRange(this.weapon),!0))return!0;if(this.moveAttempts>R)return!0;0<this.moveAttempts&&this.children.push(new d.WaitMinutesTask(1/60));h=e,u=s&&!t?this.lastValidTargetPosition.onBridge:this.target.getBridge();return a=new p.MoveInWeaponRangeTask(this.game,h,!!u,this.weapon),a.blocking=!1,this.children.push(a),this.moveExecuted=!0,this.lastSelfTileBeforeMove=i.tile,this.lastSelfMoveTargetTile=h instanceof v.GameObject?h.tile:h,this.onTick(i)}return!0}if(this.moveExecuted=!1,this.moveAttempts=0,a&&(i.rules.balloonHover&&!i.rules.hoverAttack||i.rules.fighter||i.rules.spawned||i.rules.movementZone===O.MovementZone.Fly&&!this.rangeHelper.isInRange2(i,this.target.obj??this.target.tile,this.weapon.minRange,this.weapon.range-1)||a.cancel()),a&&(i.isInfantry()&&!i.rules.balloonHover||this.weapon.rules.spawner))return!1;if(a?.children.some(e=>!e.cancellable)&&this.weapon.rules.limboLaunch)return!1;if(a&&a.shouldAirStrafe(i)&&this.target.obj?.isUnit()&&this.target.obj.moveTrait.isMoving()&&1<this.weapon.range&&!this.rangeHelper.isInRange2(i,this.target.obj,this.weapon.minRange,this.weapon.range-1))return!1;r.attackState=T.AttackState.PrepareToFire}if(r.attackState!==T.AttackState.PrepareToFire)return!1;if(!t||r.isDisabled())return a?.cancel(),!0;u=this.target.getWorldCoords(),h=i.position.worldPosition;if(!(this.lastInRangeTargetPosition.length()&&this.lastInRangeTargetPosition.equals(u)&&this.lastInRangeSelfPosition.length()&&this.lastInRangeSelfPosition.equals(h)))return this.lastInRangeTargetPosition.copy(u),this.lastInRangeSelfPosition.copy(h),r.attackState=T.AttackState.CheckRange,this.onTick(i);if(!(this.weapon.rules.omniFire||i.rules.omniFire&&i.rules.fighter)){var h=(new A.Vector3).copy(u).sub(h),e=m.FacingUtil.fromMapCoords(new M.Vector2(h.x,h.z)),h=this.weapon.projectileRules.rot?I:P;if((i.isVehicle()||i.isBuilding())&&i.turretTrait){if(i.turretTrait.desiredFacing=e,Math.abs(e-i.turretTrait.facing)>=h)return!1}else if(Math.abs(e-i.direction)>=h){if(i.isAircraft())return i.direction=m.FacingUtil.tick(i.direction,e,i.rules.rot).facing,!1;if(a)return!1;if(i.isVehicle())return!!this.options.disallowTurning||(this.children.push(new f.TurnTask(e)),!1);i.direction=e}}if(!this.losHelper.hasLineOfSight(i,this.target.obj||this.target.tile,this.weapon))return r.attackState=T.AttackState.CheckRange,this.onTick(i);if(r.isOnCooldown(i))return!1;if(this.weapon.warhead.rules.temporal&&i.temporalTrait.getTarget()===this.target.obj)return!1;if(this.weapon.rules.suicide&&this.weapon.type!==g.WeaponType.DeathWeapon)return this.game.destroyObject(i,{player:i.owner,obj:i,weapon:this.weapon}),!0;e=this.game.rules.general.prism.type;return i.isBuilding()&&i.name===e&&this.weapon.type!==g.WeaponType.Secondary&&this.fireUpPrismSupportTowers(i,e),(i.isInfantry()||i.isVehicle())&&(i.isFiring=!0),i.art.fireUp?(this.children.push(new y.WaitTicksTask(i.art.fireUp).setCancellable(!1)),r.attackState=T.AttackState.FireUp,!1):(r.attackState=T.AttackState.Firing,this.onTick(i))}shouldDropTarget(e){return this.forceDropTarget||e?.isTechno()&&(this.weapon.rules.limboLaunch&&((e.isVehicle()||e.isAircraft())&&e.parasiteableTrait?.isInfested()||e.invulnerableTrait.isActive())||e.warpedOutTrait.isInvulnerable()&&!this.weapon.warhead.rules.temporal||this.initialTargetOwner!==e.owner)}fireUpPrismSupportTowers(t,i){var e;for(e of t.owner.getOwnedObjectsByType(n.ObjectType.Building).filter(e=>e.name===i&&e.secondaryWeapon&&!e.unitOrderTrait.hasTasks()&&e.attackTrait&&!e.attackTrait.isDisabled()&&!e.attackTrait.isOnCooldown(e)).filter(e=>this.rangeHelper.isInWeaponRange(e,t,e.secondaryWeapon,this.game.rules)).slice(0,this.game.rules.general.prism.supportMax))e.unitOrderTrait.addTask(e.attackTrait.createAttackTask(this.game,t,t.centerTile,e.secondaryWeapon,{passive:!0}))}countSupportBeamsAndFireDownTowers(t,i){var e,r=t.owner.getOwnedObjectsByType(n.ObjectType.Building).filter(e=>e.name===i&&e.attackTrait?.currentTarget?.obj===t);for(e of r)e.unitOrderTrait.getCurrentTask()?.cancel();return Math.min(this.game.rules.general.prism.supportMax,r.length)}getTargetLinesConfig(){return this.targetLinesConfig}},e("AttackTask",l)}}}),System.register("game/gameobject/trait/ParasiteableTrait",["game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","game/gameobject/Vehicle","game/gameobject/trait/interface/NotifyAttack","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyHeal","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/type/MovementZone","game/gameobject/task/system/WaitMinutesTask","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/AttackTask"],function(e,t){"use strict";var n,o,i,r,s,a,l,c,h,u,d,g,p,m,f,y;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=()=>i.ROCKING_TICKS+2,y=class{constructor(e){this.gameObject=e,this.beingBoarded=!1}infest(e,t){this.beingBoarded=!1,this.parasite=e,this.parasiteWeapon=t,e.rules.organic?this.damageTickCooldown=f():this.damageTickCooldown=0,this.lastExternalDamageInflicted=void 0,this.lastExternalDamageTick=void 0,t.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!0)}isInfested(){return!(!this.parasite||this.parasite.isDestroyed)||this.beingBoarded}isParalyzed(){return!!this.parasiteWeapon?.warhead.rules.paralyzes}uninfest(){this.parasite&&(this.parasiteWeapon.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!1),this.parasite=void 0,this.parasiteWeapon=void 0)}getParasite(){return this.parasite}[h.NotifyTick.onTick](r,s){if(this.parasite)if(this.parasite.isDestroyed)this.uninfest();else if(0<this.damageTickCooldown)this.damageTickCooldown--;else{let e=this.parasiteWeapon;this.damageTickCooldown=this.parasite.rules.organic?f():e.getCooldownTicks();let t=e.rules.damage;this.parasite.veteranTrait&&(t*=this.parasite.veteranTrait.getVeteranDamageMultiplier());let i=e.warhead.computeDamage(t,r);this.canBeCulled(r,this.parasite,e,s)&&(i=r.healthTrait.getHitPoints()),e.warhead.inflictDamage(i,r,{player:this.parasite.owner,obj:this.parasite,weapon:e},s),r.isCrashing?(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(r,s)):!r.isDestroyed&&r.isVehicle()&&r.zone!==o.ZoneType.Air&&e.warhead.rules.rocker&&r.applyRocking(90*(.5<=s.generateRandom()?1:-1),1)}}canBeCulled(e,t,i,r){if(!i.warhead.rules.culling)return!1;var s=r.rules.audioVisual,s=t.veteranTrait?.isElite()?s.conditionYellow:s.conditionRed;return e.healthTrait.health<=100*s}[a.NotifyHeal.onHeal](e,t,i,r){var s;!this.parasite||this.parasite.isDestroyed||r===e||e.isAircraft()&&r?.rules.unitReload||(this.parasite.rules.organic?(s=this.parasite,this.evictOrDestroyParasite(e,t),this.stunParasite(s,t)):(this.parasite.deathType=n.DeathType.None,t.destroyObject(this.parasite,r?{player:r.owner,obj:r}:void 0),this.uninfest()))}[l.NotifyDamage.onDamage](e,t,i,r){r?.obj!==this.parasite&&(this.lastExternalDamageInflicted=i,this.lastExternalDamageTick=t.currentTick)}[r.NotifyAttack.onAttack](i,r,s){if(this.parasite&&!this.parasite.isDestroyed&&r?.weapon?.warhead.rules.sonic){var a,n=this.parasite;this.evictOrDestroyParasite(i,s),this.stunParasite(n,s);let e=r.weapon.warhead;e.canDamage(n,n.tile,n.zone)&&(a=e.computeDamage(r.weapon.rules.damage,n),e.inflictDamage(a,n,r,s));let t=r.obj?.unitOrderTrait.getCurrentTask();t instanceof m.AttackTask&&t.getWeapon().warhead.rules.sonic&&t.cancel()}}[s.NotifyDestroy.onDestroy](e,t,i,r){this.parasite&&!this.parasite.isDestroyed&&(r||!this.parasite.invulnerableTrait.isActive()&&this.shouldSupressParasite(t,this.parasite,i)?(this.parasite.deathType=n.DeathType.None,t.destroyObject(this.parasite,i,r),this.uninfest()):(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(e,t)))}shouldSupressParasite(e,t,i){return i?.obj!==t||this.lastExternalDamageInflicted&&this.lastExternalDamageInflicted>t.rules.suppressionThreshold&&e.currentTick-this.lastExternalDamageTick<2*this.lastExternalDamageInflicted}[c.NotifyTeleport.onBeforeTeleport](e,t,i,r){var s;i&&r&&this.parasite&&!this.parasite.isDestroyed&&(this.parasiteWeapon.expireCooldown(),s=this.parasite,this.evictOrDestroyParasite(e,t,!0),s.isDestroyed||this.stunParasite(s,t))}stunParasite(e,t){e.unitOrderTrait.addTaskToFront(new d.WaitMinutesTask(10/60).setCancellable(!1)),e.isVehicle()&&e.submergibleTrait&&(e.submergibleTrait.emerge(e,t),e.cloakableTrait?.uncloak(t),e.submergibleTrait.setCooldown(10*g.GameSpeed.BASE_TICKS_PER_SECOND))}evictOrDestroyParasite(r,s,e=!1){if(this.parasite&&!this.parasite.isDestroyed){var a=r.zone===o.ZoneType.Air;if(a&&this.parasite.rules.movementZone!==u.MovementZone.Fly||!a&&!s.map.terrain.getPassableSpeed(r.tile,this.parasite.rules.speedType,r.onBridge)&&!s.map.getObjectsOnTile(r.tile).find(e=>e.isBuilding()))this.parasite.deathType=n.DeathType.None,s.destroyObject(this.parasite,{player:r.owner,obj:r});else{let t=r.tile,i=r.onBridge;if(!e&&!r.isDestroyed||this.parasite.rules.organic){let e=new p.RadialTileFinder(s.map.tiles,s.map.mapBounds,t,{width:1,height:1},1,1,e=>0<s.map.terrain.getPassableSpeed(e,this.parasite.rules.speedType,i)&&!s.map.terrain.findObstacles({tile:e,onBridge:i},this.parasite).length);a=e.getNextTile();if(!a)return this.parasite.deathType=n.DeathType.None,s.destroyObject(this.parasite,{player:r.owner,obj:r}),void this.uninfest();t=a}this.parasite.onBridge=i,this.parasite.position.subCell=this.parasite.isInfantry()?r.position.subCell:0,this.parasite.zone=s.map.getTileZone(t,!i),this.parasite.position.tileElevation=i?s.map.tileOccupation.getBridgeOnTile(t).tileElevation:0,this.parasite.resetGuardModeToIdle(),s.unlimboObject(this.parasite,t,!0)}this.uninfest()}}destroyParasite(e,t){this.parasite&&(this.parasite.deathType=n.DeathType.None,t.destroyObject(this.parasite,e),this.uninfest())}dispose(){this.gameObject=void 0}},e("ParasiteableTrait",y)}}}),System.register("game/event/ObjectCrashingEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectCrashingEvent",r=class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectCrashing}})}}}),System.register("game/gameobject/unit/TargetUtil",["game/math/Vector3","game/math/geometry","game/math/GameMath"],function(e,t){"use strict";var l,n,c,i;t&&t.id;return{setters:[function(e){l=e},function(e){n=e},function(e){c=e}],execute:function(){e("TargetUtil",i=class{static computeInterceptPoint(e,t,i,r){let s=e.clone().sub(i);var a=r.length(),n=t*t-a*a,o=2*s.dot(r),a=-s.dot(s);if(o*o-4*n*a<0)return new l.Vector3;n=(-o+c.GameMath.sqrt(o*o-4*n*a))/(2*n);return r.clone().multiplyScalar(n).add(i)}static computeTurnCircle(e,t,i,r){var s=r/n.degToRad(Math.abs(i));let a=n.rotateVec2(t.clone(),90*-Math.sign(i));return{center:isFinite(s)?a.setLength(s).add(e):e.clone(),radius:s}}})}}}),System.register("game/event/ObjectLiftOffEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectLiftOffEvent",r=class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectLiftOff}})}}}),System.register("game/event/ObjectLandEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectLandEvent",r=class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectLand}})}}}),System.register("game/gameobject/locomotor/JumpjetLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var C,E,x,O,A,M,l,c,R,r,P,i;t&&t.id;return{setters:[function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){l=e},function(e){c=e},function(e){R=e},function(e){r=e},function(e){P=e}],execute:function(){e("JumpjetLocomotor",i=class{constructor(e){this.game=e,this.allowOutOfBounds=!0,this.currentMoveDir=new r.Vector2,this.currentHorizSpeed=0}static tickStationary(t,i){if(t.zone===A.ZoneType.Air){var r=t.tile.onBridgeLandType?i.map.tileOccupation.getBridgeOnTile(t.tile):void 0,s=!t.rules.balloonHover&&(!t.unitOrderTrait.getCurrentTask()?.preventLanding||!t.rules.hoverAttack)&&(i.map.getGroundObjectsOnTile(t.tile).find(e=>e.isBuilding()&&e.dockTrait?.isDocked(t))||i.map.getTileZone(t.tile)!==A.ZoneType.Water&&0<i.map.terrain.getPassableSpeed(t.tile,c.SpeedType.Foot,!!t.tile.onBridgeLandType)&&0===i.map.terrain.findObstacles({tile:t.tile,onBridge:r},t).length);let e;e=s?(a=t.tile.z+(r?.tileElevation??0),C.Coords.tileHeightToWorld(a)):(n=t.tile.z+i.map.getGroundObjectsOnTile(t.tile).filter(e=>!(e.isInfantry()&&e.stance===R.StanceType.Paradrop)).reduce((e,t)=>Math.max(e,t.tileElevation+t.art.height),0),C.Coords.tileHeightToWorld(n)+t.rules.jumpjetHeight);var a,n,o=t.position.worldPosition.y;e!==o?(a=t.rules.jumpjetClimb,n=Math.abs(e-o),a=Math.sign(e-o)*Math.min(a,n),n=t.tileElevation,t.position.moveByLeptons3(new P.Vector3(0,a,0)),t.moveTrait.handleElevationChange(n,i)):s&&(t.zone=A.ZoneType.Ground,t.onBridge=!!r,i.events.dispatch(new l.ObjectLandEvent(t)))}}static tickCrash(e,t,i){var r=2*e.rules.jumpjetCrash;return e.direction=(e.direction-6+360)%360,new P.Vector3(0,-r,0)}onNewWaypoint(e,t,i){this.currentMoveDir=E.FacingUtil.toMapCoords(e.direction),this.cancelDestLeptons=void 0}tick(t,e,i,r){if(t.zone!==A.ZoneType.Air&&(t.onBridge=!1,t.zone=A.ZoneType.Air,this.game.events.dispatch(new M.ObjectLiftOffEvent(t))),r){if(!this.cancelDestLeptons){let e=t.tile;this.game.map.isWithinBounds(e)||(e=this.game.map.clampWithinBounds(e)),this.cancelDestLeptons=this.computeCancelDest(e,i)}i=this.cancelDestLeptons}var s=t.position.getMapPosition();let a=i.clone().sub(s),n=this.findTilesToCheckForBlockers(t.tile,s,this.currentMoveDir,a.length());var o=n.map(e=>e.z+this.game.map.getGroundObjectsOnTile(e).filter(e=>!(e.isDestroyed||e.isInfantry()&&e.stance===R.StanceType.Paradrop)).reduce((e,t)=>Math.max(e,t.tileElevation+t.art.height),0)).reduce((e,t)=>Math.max(e,t),0);let l=0;(void 0===this.lastClearZ||2<o-this.lastClearZ)&&(l=4);var c,h=C.Coords.tileHeightToWorld(o),u=C.Coords.tileHeightToWorld(o+l),d=t.position.worldPosition.y,g=E.FacingUtil.fromMapCoords(a),p=a.length()<t.rules.jumpjetSpeed;let m=0;h<=d&&!p&&({facing:b,delta:c}=E.FacingUtil.tick(t.direction,g,t.rules.jumpjetTurnRate),m=c,t.direction=b,this.currentMoveDir.copy(E.FacingUtil.toMapCoords(t.direction))),t.isVehicle()&&(t.spinVelocity=m);let f,y=!1,T=0,v=0;var b=t.rules.jumpjetClimb;d<u?(T=Math.min(b,u-d),f=!1,this.currentHorizSpeed=0):(this.lastClearZ=o,o=h+t.rules.jumpjetHeight,f=!0,o!==d&&(h=Math.abs(o-d),T=Math.sign(o-d)*Math.min(b,h),f=h<=b),b=this.currentHorizSpeed,this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,t.rules.jumpjetSpeed),y=g===t.direction?(v=Math.min(b,a.length()),b>=a.length()):((s=b||m?x.TargetUtil.computeTurnCircle(s,this.currentMoveDir,Math.sign(m)*t.rules.jumpjetTurnRate,b):void 0)&&O.circleContainsPoint(s,i)?(v=0,this.currentHorizSpeed=0):v=b,!1));let S;S=p?(y=!0,a):this.currentMoveDir.clone().setLength(v);let w=new P.Vector3(S.x,T,S.y);p=w.clone();return t.moveTrait.velocity.copy(p),{distance:w,done:y&&f}}findTilesToCheckForBlockers(e,t,i,r){var s=i.clone().setLength(Math.min(r,C.Coords.LEPTONS_PER_TILE)).add(t).multiplyScalar(1/C.Coords.LEPTONS_PER_TILE).floor(),a=this.game.map.tiles.getByMapCoords(s.x,s.y);if(!a||a===e)return[e];s=Math.sign(a.rx-e.rx),a=Math.sign(a.ry-e.ry);let n=[e],o;return s&&(o=this.game.map.tiles.getByMapCoords(e.rx+s,e.ry),o&&n.push(o)),a&&(o=this.game.map.tiles.getByMapCoords(e.rx,e.ry+a),o&&n.push(o)),s&&a&&(o=this.game.map.tiles.getByMapCoords(e.rx+s,e.ry+a),o&&n.push(o)),n}computeCancelDest(e,t){var i=t.clone().multiplyScalar(1/C.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(C.Coords.LEPTONS_PER_TILE),i=t.clone().sub(i);return new r.Vector2(e.rx,e.ry).multiplyScalar(C.Coords.LEPTONS_PER_TILE).add(i)}})}}}),System.register("game/gameobject/task/MoveToDockTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/gameobject/trait/interface/NotifyTick","game/Coords","game/math/Vector2"],function(t,e){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var e;(e=d=d||{})[e.Idle=0]="Idle",e[e.MoveToQueueingTile=1]="MoveToQueueingTile",e[e.WaitForTurn=2]="WaitForTurn",e[e.MoveToDock=3]="MoveToDock",e[e.Docking=4]="Docking",e[e.Docked=5]="Docked",g=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.dockingStatus=d.Idle}onStart(e){if(!this.target.dockTrait)throw new Error(`Target object "${this.target.name}" is not a valid dock`);var t;this.target.dockTrait.hasReservedDockForUnit(e)?this.dockingStatus=d.MoveToDock:void 0!==(t=this.target.dockTrait.getFirstAvailableDockNumber())?(this.target.dockTrait.reserveDockAt(e,t),this.dockingStatus=d.MoveToDock):this.target.helipadTrait?this.cancel():this.dockingStatus=d.MoveToQueueingTile}onEnd(e){this.dockingStatus!==d.Docked&&this.target.isSpawned&&(this.target.dockTrait.undockUnit(e),this.target.dockTrait.unreserveDockForUnit(e)),this.dockingStatus=d.Idle}onTick(e){if(this.isCancelling())return!0;if(!this.isValidTarget(this.target,e))return!0;if(this.dockingStatus===d.MoveToQueueingTile){var t=this.findReachableQueueingTile(e);if(!t)return!0;if(e.tile!==t)return this.children.push(new s.MoveTask(this.game,t,!1,{closeEnoughTiles:5}),new n.CallbackTask(()=>{e.moveTrait.lastMoveResult===o.MoveResult.Fail?this.cancel():e.moveTrait.lastMoveResult===o.MoveResult.CloseEnough&&(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)||(this.dockingStatus=d.WaitForTurn))})),!1;this.dockingStatus=d.WaitForTurn}if(this.dockingStatus===d.WaitForTurn){var i=this.target.dockTrait.getFirstAvailableDockNumber();if(void 0===i)return this.children.push(new a.WaitMinutesTask(1/60)),!1;this.target.dockTrait.reserveDockAt(e,i),this.dockingStatus=d.MoveToDock}if(this.dockingStatus===d.MoveToDock){var r=this.target.dockTrait.getReservedDockForUnit(e),i=this.target.dockTrait.getDockTile(r),r=h.Coords.vecWorldToGround(this.target.dockTrait.getDockOffset(r)).add(this.target.position.getMapPosition()).sub(new u.Vector2(i.rx,i.ry).multiplyScalar(h.Coords.LEPTONS_PER_TILE));if(e.tile!==i)return this.children.push(new s.MoveTask(this.game,i,!1,{targetOffset:e.isAircraft()?r:void 0,closeEnoughTiles:0,strictCloseEnough:!0}),new n.CallbackTask(()=>{e.moveTrait.lastMoveResult===o.MoveResult.Fail&&this.cancel()})),this.game.afterTick(()=>e.unitOrderTrait[c.NotifyTick.onTick](e,this.game)),!1;this.dockingStatus=d.Docking}if(this.dockingStatus!==d.Docking)return!1;r=this.target.dockTrait.getReservedDockForUnit(e);return this.target.dockTrait.unreserveDockForUnit(e),this.target.dockTrait.dockUnitAt(e,r),e.isAircraft()&&e.airportBoundTrait&&this.target.helipadTrait&&(e.airportBoundTrait.preferredAirport=this.target),this.dockingStatus=d.Docked,!0}isValidTarget(e,t){return e.isSpawned&&this.game.areFriendly(e,t)}findReachableQueueingTile(t){var e=this.target.getFoundation(),e=new u.Vector2(this.target.tile.rx+e.width,this.target.tile.ry+e.height),e=this.game.map.tiles.getByMapCoords(e.x,e.y);return e&&this.isValidQueueingTile(e,t)?e:new r.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,e=>this.isValidQueueingTile(e,t)).getNextTile()}isValidQueueingTile(e,t){return(t.rules.movementZone===l.MovementZone.Fly||0<this.game.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&Math.abs(e.z-this.target.tile.z)<2&&!e.onBridgeLandType&&!this.game.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length)&&!this.game.map.tileOccupation.isTileOccupiedBy(e,this.target)}},t("MoveToDockTask",g)}}}),System.register("game/gameobject/locomotor/WingedLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/task/MoveToDockTask","game/gameobject/trait/interface/NotifyTick","game/math/Vector2","game/math/Vector3","util/math","game/math/GameMath"],function(t,e){"use strict";var E,x,O,A,M,R,h,u,d,g,r,P,I,k,B,i;e&&e.id;return{setters:[function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){r=e},function(e){P=e},function(e){I=e},function(e){k=e}],execute:function(){var e;0,(e=B=B||{})[e.None=0]="None",e[e.CircleStrafe=1]="CircleStrafe",e[e.HoverStrafe=2]="HoverStrafe",t("WingedLocomotor",i=class{constructor(e){this.game=e,this.allowOutOfBounds=!0,this.lastDestLeptons=new r.Vector2,this.currentMoveDir=new r.Vector2,this.currentHorizSpeed=0,this.maneuverType=B.None,this.deceleratingToTurn=!1}static tickStationary(s,a){if(s.zone===M.ZoneType.Air){var n=s.tile.onBridgeLandType?a.map.tileOccupation.getBridgeOnTile(s.tile):void 0;let e=s.rules.landable&&!s.unitOrderTrait.getCurrentTask()?.preventLanding,i=s.spawnLinkTrait?.getParent();e&&i?e=!((!i.isUnit()||!i.onBridge)&&n||i.tile!==s.tile):e&&!s.airportBoundTrait&&(e=a.map.getTileZone(s.tile)!==M.ZoneType.Water&&0<a.map.terrain.getPassableSpeed(s.tile,u.SpeedType.Foot,!!s.tile.onBridgeLandType)&&0===a.map.terrain.findObstacles({tile:s.tile,onBridge:n},s).length);let r;if(e){let e=s.airportBoundTrait?.preferredAirport?.dockTrait;var o=e?.isDocked(s)||e?.hasReservedDockForUnit(s);if(!s.airportBoundTrait||o){var l=o?0:270;if(s.direction!==l)return void(s.direction=x.FacingUtil.tick(s.direction,l,s.rules.rot).facing)}if(s.airportBoundTrait){let e=s.airportBoundTrait.preferredAirport;if(!e?.dockTrait?.isDocked(s))return e?.dockTrait?.getAvailableDockCount()||(e=s.airportBoundTrait.findAvailableAirport(s),s.airportBoundTrait.preferredAirport=e,e&&(l=e.dockTrait.getFirstAvailableDockNumber(),e.dockTrait.reserveDockAt(s,l))),void(e?(s.unitOrderTrait.addTask(new d.MoveToDockTask(a,e)),s.unitOrderTrait[g.NotifyTick.onTick](s,a)):s.crashableTrait.crash(void 0))}let t;t=i?i.tile.z+i.tileElevation:s.tile.z+(n?.tileElevation??0),r=E.Coords.tileHeightToWorld(t)}else{var t=s.tile.z+(n?.tileElevation??0),c=s.rules.flightLevel??a.rules.general.flightLevel;r=E.Coords.tileHeightToWorld(t)+c}t=s.position.worldPosition.y;r!==t?(c=Math.abs(r-t),t=Math.sign(r-t)*Math.min(30,c),c=s.tileElevation,s.position.moveByLeptons3(new P.Vector3(0,t,0)),s.moveTrait.handleElevationChange(c,a)):e&&(s.zone=M.ZoneType.Ground,i?i.airSpawnTrait.storeAircraft(s,a):s.onBridge=!!n,a.events.dispatch(new h.ObjectLandEvent(s)))}}static tickCrash(e,t,i){i.rollDelta??(i.rollDelta=t.generateRandomInt(-15,15)),i.pitchDelta??(i.pitchDelta=t.generateRandomInt(0,15)),e.roll+=i.rollDelta,e.pitch+=i.pitchDelta;var r=E.Coords.vecWorldToGround(e.moveTrait.velocity);return new P.Vector3(r.x,-30,r.y)}onNewWaypoint(e,t,i){this.currentHorizSpeed=E.Coords.vecWorldToGround(e.moveTrait.velocity).length(),this.cancelDestLeptons=void 0}tick(t,e,i,r){if(r){if(!this.cancelDestLeptons){let e=t.tile;this.game.map.isWithinBounds(e)||(e=this.game.map.clampWithinBounds(e)),this.cancelDestLeptons=this.computeCancelDest(e,i)}i=this.cancelDestLeptons}var s=t.position.getMapPosition();let a=i.clone().sub(s);var n=a.length();this.lastDestLeptons.equals(i)||(this.lastDestLeptons.copy(i),r?this.maneuverType=B.HoverStrafe:t.zone===M.ZoneType.Air&&this.currentHorizSpeed<5?this.maneuverType=n>E.Coords.LEPTONS_PER_TILE?B.CircleStrafe:B.HoverStrafe:this.maneuverType=B.None,this.deceleratingToTurn=!1),t.zone!==M.ZoneType.Air&&(t.onBridge=!1,t.zone=M.ZoneType.Air,this.game.events.dispatch(new R.ObjectLiftOffEvent(t)));var o=t.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(t.tile):void 0,l=t.tile.z+(o?.tileElevation??0),c=t.rules.flightLevel??this.game.rules.general.flightLevel,h=E.Coords.tileHeightToWorld(l)+c,o=t.position.worldPosition.y,u=x.FacingUtil.fromMapCoords(a);t.direction===u&&this.maneuverType===B.None&&n<=E.Coords.LEPTONS_PER_TILE?this.maneuverType=B.HoverStrafe:t.direction===u&&this.maneuverType===B.CircleStrafe&&(this.maneuverType=B.None);let d;switch(this.maneuverType){case B.HoverStrafe:if(t.attackTrait?.currentTarget){let e=E.Coords.vecWorldToGround(t.attackTrait.currentTarget.getWorldCoords());d=x.FacingUtil.fromMapCoords(e.sub(s))}else d=t.airportBoundTrait?.preferredAirport?.dockTrait?.hasReservedDockForUnit(t)?0:270;break;case B.CircleStrafe:case B.None:d=u;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}var{facing:g,delta:p}=x.FacingUtil.tick(t.direction,d,t.rules.rot);t.direction=g,t.roll=Math.sign(p)*t.rules.pitchAngle;let m;switch(this.maneuverType){case B.HoverStrafe:m=u;break;case B.CircleStrafe:m=(g-90*Math.sign(p)+360)%360;break;case B.None:m=g;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}void 0===this.thrustFacing&&(this.thrustFacing=m);var l=5<this.currentHorizSpeed?t.rules.rot:Number.POSITIVE_INFINITY,{facing:c,delta:l}=x.FacingUtil.tick(this.thrustFacing,m,l);this.thrustFacing=c,this.currentMoveDir.copy(x.FacingUtil.toMapCoords(this.thrustFacing));let f=!1,y=0,T=0;let v=!0;h!==o&&(S=Math.abs(h-o),y=Math.sign(h-o)*Math.min(30,S),v=S<=30);let b=t.rules.speed;n<=E.Coords.LEPTONS_PER_TILE&&this.maneuverType!==B.CircleStrafe&&(b=I.lerp(1,b/2,k.GameMath.sqrt(n/E.Coords.LEPTONS_PER_TILE))),this.deceleratingToTurn?this.currentHorizSpeed=Math.max(0,this.currentHorizSpeed-2):this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,b);var S=this.currentHorizSpeed;this.deceleratingToTurn=!1,f=l?(l=S||l?O.TargetUtil.computeTurnCircle(s,this.currentMoveDir,Math.sign(l)*t.rules.rot,S):void 0,0!==S&&!A.circleContainsPoint(l,i)||(this.maneuverType===B.HoverStrafe||n>E.Coords.LEPTONS_PER_TILE?this.deceleratingToTurn=!0:this.maneuverType===B.None&&(this.maneuverType=B.HoverStrafe)),T=S,!1):(T=Math.min(S,n),n<=S);let w;w=n<1?(f=!0,a):f?a:this.currentMoveDir.clone().setLength(T);let C=new P.Vector3(w.x,y,w.y);n=C.clone();return t.moveTrait.velocity.copy(n),{distance:C,done:f&&v}}computeCancelDest(e,t){var i=t.clone().multiplyScalar(1/E.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(E.Coords.LEPTONS_PER_TILE),i=t.clone().sub(i);return new r.Vector2(e.rx,e.ry).multiplyScalar(E.Coords.LEPTONS_PER_TILE).add(i)}})}}}),System.register("game/gameobject/trait/interface/NotifyCrash",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onCrash=Symbol(),e("NotifyCrash",i)}}}),System.register("game/gameobject/trait/CrashableTrait",["game/event/ObjectCrashingEvent","game/type/LocomotorType","game/gameobject/trait/interface/NotifyTick","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/WingedLocomotor","game/gameobject/trait/interface/NotifyCrash"],function(e,t){"use strict";var o,l,i,c,h,u,r;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){i=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){r=class{constructor(e){this.gameObject=e,this.crashingEvtSent=!1,this.crashState={}}[i.NotifyTick.onTick](i,r){if(i.isCrashing){if(this.crashingEvtSent||(this.crashingEvtSent=!0,i.traits.filter(u.NotifyCrash).forEach(e=>e[u.NotifyCrash.onCrash](i,r)),r.events.dispatch(new o.ObjectCrashingEvent(i))),i.rules.locomotor!==l.LocomotorType.Jumpjet&&i.rules.locomotor!==l.LocomotorType.Aircraft)throw new Error("Crashing logic not implemented for locomotor "+l.LocomotorType[i.rules.locomotor]);{let e;if(i.rules.locomotor===l.LocomotorType.Jumpjet)e=c.JumpjetLocomotor.tickCrash(i,r,this.crashState);else{if(i.rules.locomotor!==l.LocomotorType.Aircraft)throw new Error(`Unhandled locomotor type "${i.rules.locomotor}"`);if(!i.isAircraft())throw new Error(`Obj "${i.name}#${i.id} is not an aircraft`);e=h.WingedLocomotor.tickCrash(i,r,this.crashState)}let t=!1;var s,a,n=e.clone().add(i.position.worldPosition);r.map.isWithinHardBounds(n)?(a=i.tile,s=i.tileElevation,i.position.moveByLeptons3(e),i.tile!==a&&i.moveTrait.handleTileChange(a,void 0,!1,r),a=(n=i.tile.onBridgeLandType?r.map.tileOccupation.getBridgeOnTile(i.tile):void 0)?.tileElevation??0,i.position.tileElevation=Math.max(i.position.tileElevation,a),i.position.tileElevation===a&&(i.zone=r.map.getTileZone(i.tile),i.onBridge=!!n,t=!0),i.tileElevation!==s&&i.moveTrait.handleElevationChange(s,r)):t=!0,t&&r.destroyObject(i,this.attackerInfo)}}}crash(e){this.attackerInfo=e,this.gameObject.isCrashing=!0,this.gameObject.cachedTraits.tick.length=0,this.gameObject.cachedTraits.tick=[this]}dispose(){this.gameObject=void 0}},e("CrashableTrait",r)}}}),System.register("game/event/ShipSubmergeChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ShipSubmergeChangeEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.ShipSubmergeChange}})}}}),System.register("game/gameobject/trait/SubmergibleTrait",["game/event/ShipSubmergeChangeEvent","game/GameSpeed","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class{constructor(){this.isActive=!1}isSubmerged(){return this.isActive}setCooldown(e){this.cooldownTicks=e}[n.NotifyTick.onTick](e,t){this.isActive||e.parasiteableTrait?.isInfested()||(e.attackTrait&&e.attackTrait.attackState!==s.AttackState.Idle&&!e.moveTrait.isMoving()?this.cooldownTicks=Math.max(this.cooldownTicks??0,5*r.GameSpeed.BASE_TICKS_PER_SECOND):this.cooldownTicks??(this.cooldownTicks=Math.floor(60*t.rules.general.cloakDelay*r.GameSpeed.BASE_TICKS_PER_SECOND)),0<this.cooldownTicks&&this.cooldownTicks--,this.cooldownTicks<=0&&(this.isActive=!0,t.events.dispatch(new i.ShipSubmergeChangeEvent(e))))}[a.NotifyDamage.onDamage](e,t){this.emerge(e,t)}emerge(e,t){this.isActive&&(this.isActive=!1,this.cooldownTicks=void 0,t.events.dispatch(new i.ShipSubmergeChangeEvent(e)))}},e("SubmergibleTrait",o)}}}),System.register("game/gameobject/trait/interface/NotifyTileChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onTileChange=Symbol(),e("NotifyTileChange",i)}}}),System.register("game/gameobject/trait/HoverBobTrait",["game/GameSpeed","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","game/Coords","game/gameobject/trait/interface/NotifyTileChange","game/math/GameMath"],function(e,t){"use strict";var r,i,s,a,n,o,l;t&&t.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class{constructor(){this.prevHoverBobLeptons=0,this.spawnTick=0}[s.NotifySpawn.onSpawn](e,t){this.setBaseElevation(e,t),this.spawnTick=t.currentTick}[n.NotifyTileChange.onTileChange](e,t,i,r){r&&(this.prevHoverBobLeptons=0,this.setBaseElevation(e,t))}setBaseElevation(e,t){e.position.tileElevation=(e.onBridge?t.map.tileOccupation.getBridgeOnTile(e.tile)?.tileElevation??0:0)+a.Coords.worldToTileHeight(t.rules.general.hover.height)}[i.NotifyTick.onTick](e,t){var i=this.computeHoverBobLeptons(t.currentTick,t.rules.general.hover),r=i-this.prevHoverBobLeptons;this.prevHoverBobLeptons=i;i=a.Coords.tileHeightToWorld(e.position.tileElevation);e.position.tileElevation=a.Coords.worldToTileHeight(i+r)}computeHoverBobLeptons(e,t){var i=(e-this.spawnTick)/r.GameSpeed.BASE_TICKS_PER_SECOND/(60*t.bob);return.1*t.height*o.GameMath.sin(2*i*Math.PI)}},e("HoverBobTrait",l)}}}),System.register("game/gameobject/unit/CrateBonuses",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CrateBonuses",i=class{constructor(){this.firepower=1,this.armor=1,this.speed=1}})}}}),System.register("game/gameobject/trait/TilterTrait",["game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTileChange"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.tilt={pitch:0,yaw:0}}[i.NotifySpawn.onSpawn](e){this.tilt=this.computeTilt(e.tile.rampType)}[r.NotifyTileChange.onTileChange](e){this.tilt=this.computeTilt(e.tile.rampType)}computeTilt(e){let t,i;return 0===e||17<=e?t=i=0:i=e<=4?(t=25,-90*e):(t=25,225-(e-1)%4*90),{pitch:t,yaw:i}}},e("TilterTrait",s)}}}),System.register("game/gameobject/Vehicle",["engine/type/ObjectType","game/gameobject/trait/HarvesterTrait","game/gameobject/trait/TransportTrait","game/gameobject/trait/MoveTrait","game/gameobject/trait/TurretTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/GunnerTrait","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/SubmergibleTrait","game/type/LocomotorType","game/gameobject/trait/HoverBobTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/TilterTrait"],function(e,t){"use strict";var r,n,o,l,c,s,h,i,u,d,g,p,m,f,y,a,T,v;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){s=e},function(e){h=e},function(e){i=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){a=e},function(e){T=e}],execute:function(){e("ROCKING_TICKS",34),v=class extends i.Techno{constructor(e,t,i){super(r.ObjectType.Vehicle,e,t,i),this.direction=0,this.spinVelocity=0,this.crateBonuses=new a.CrateBonuses,this.turretNo=0,this.onBridge=!1,this.isSinker=!1,this.isFiring=!1,this.zone=t.naval?s.ZoneType.Water:s.ZoneType.Ground}get isMoving(){return this.moveTrait.isMoving()}static factory(e,t,i,r,s){let a=new this(e,t,i);return a.isSinker=!t.underwater&&(t.weight>=r.general.shipSinkingWeight||!t.naval),a.moveTrait=new l.MoveTrait(a,s),a.traits.add(a.moveTrait),t.crashable&&(a.crashableTrait=new p.CrashableTrait(a),a.traits.add(a.crashableTrait)),t.crewed&&(a.crewedTrait=new u.CrewedTrait,a.traits.add(a.crewedTrait)),t.harvester&&(a.harvesterTrait=new n.HarvesterTrait(t.storage),a.traits.add(a.harvesterTrait)),t.passengers&&(a.transportTrait=new o.TransportTrait(a),a.traits.add(a.transportTrait),t.gunner&&(a.gunnerTrait=new d.GunnerTrait,a.traits.add(a.gunnerTrait))),t.turret&&(a.turretTrait=new c.TurretTrait,a.traits.add(a.turretTrait)),t.consideredAircraft&&!t.landable||a.traits.add(new h.DockableTrait),t.parasiteable&&(a.parasiteableTrait=new g.ParasiteableTrait(a),a.traits.add(a.parasiteableTrait)),t.naval&&t.underwater&&(a.submergibleTrait=new m.SubmergibleTrait,a.traits.add(a.submergibleTrait)),t.locomotor===f.LocomotorType.Hover&&a.traits.add(new y.HoverBobTrait),[f.LocomotorType.Vehicle,f.LocomotorType.Chrono].includes(t.locomotor)&&i.isVoxel&&(a.tilterTrait=new T.TilterTrait,a.traits.add(a.tilterTrait)),a}isUnit(){return!0}isVehicle(){return!0}getUiName(){if(this.gunnerTrait){var e=this.armedTrait.getSpecialWeaponIndex(),t=this.gunnerTrait.getUiNameForIfvMode(e,this.transportTrait?.units[0]?.name),e="name:"+this.name;return t?`{${t}} {${e}}`:e}return super.getUiName()}update(e){this.rocking&&(this.rocking.ticksLeft--,this.rocking.ticksLeft||(this.rocking=void 0)),super.update(e)}applyRocking(e,t){this.rocking={ticksLeft:this.rocking?.ticksLeft??34,facing:e,factor:t}}},e("Vehicle",v)}}}),System.register("game/gameobject/Unit",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameobject/trait/DockableTrait",["game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTeleport"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class{[i.NotifyUnspawn.onUnspawn](e){this.undock(e),this.reservedDock?.dockTrait.unreserveDockForUnit(e)}[r.NotifyOwnerChange.onChange](e){e.owner!==this.dock?.owner&&this.undock(e),e.owner!==this.reservedDock?.owner&&this.reservedDock?.dockTrait.unreserveDockForUnit(e)}[s.NotifyTeleport.onBeforeTeleport](e,t,i,r){r||this.undock(e)}undock(e){this.dock&&!this.dock.isDisposed&&this.dock.dockTrait.undockUnit(e)}dispose(){this.dock=void 0,this.reservedDock=void 0}},e("DockableTrait",a)}}}),System.register("game/gameobject/trait/AirportBoundTrait",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("AirportBoundTrait",i=class{constructor(e){this.airportNames=e}findAvailableAirport(e){return[...e.owner.buildings].find(e=>e.dockTrait&&this.airportNames.includes(e.name)&&0<e.dockTrait.getAvailableDockCount())}})}}}),System.register("game/gameobject/trait/SpawnLinkTrait",["game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/unit/RangeHelper","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var n,o,l,c,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){i=e}],execute:function(){r=class{setParent(e){this.parent=e}getParent(){return this.parent}[i.NotifyTick.onTick](r,s){if(this.parent&&r.attackTrait&&r.primaryWeapon){let e=this.parent.attackTrait?.currentTarget,t=r.unitOrderTrait.getCurrentTask(),i=new l.RangeHelper(s.map.tileOccupation);var a=this.parent.armedTrait?.getWeapons().find(e=>e.rules.spawner);r.ammo&&!(e&&r.attackTrait.currentTarget?e.equals(r.attackTrait.currentTarget):e===r.attackTrait.currentTarget||!e&&this.parent.isUnit()&&(this.parent.unitOrderTrait.getCurrentTask()instanceof o.MoveTask||this.parent.unitOrderTrait.getCurrentTask()instanceof n.AttackTask))&&(!e||a&&i.isInWeaponRange(this.parent,e.obj??e.tile,a,s.rules))?e&&r.primaryWeapon.targeting.canTarget(e.obj,e.tile,s,!0,!1)?!t||t instanceof o.MoveTask?(r.unitOrderTrait.cancelAllTasks(),r.unitOrderTrait.addTask(r.attackTrait.createAttackTask(s,e.obj,e.tile,r.primaryWeapon,{force:!0}))):r.attackTrait.attackState!==c.AttackState.Idle&&t.requestTargetUpdate(e):t?t instanceof o.MoveTask||t.cancel():this.tryMoveToParent(r,this.parent,s):this.tryMoveToParent(r,this.parent,s)}}tryMoveToParent(t,i,r){if(t.tile!==i.tile){let e=t.unitOrderTrait.getCurrentTask();e?e instanceof o.MoveTask&&e.updateTarget(i.tile,!!i.isUnit()&&i.onBridge):t.unitOrderTrait.addTask(new o.MoveTask(r,i.tile,!!i.isUnit()&&i.onBridge,{closeEnoughTiles:0,strictCloseEnough:!0}))}}},e("SpawnLinkTrait",r)}}}),System.register("game/gameobject/trait/MissileSpawnTrait",["game/gameobject/unit/CollisionType","game/gameobject/trait/interface/NotifyDestroy"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{setWarhead(e){return this.warhead=e,this}setDamage(e){return this.damage=e,this}setLauncher(e){return this.launcher=e,this}[r.NotifyDestroy.onDestroy](e,t){this.warhead&&this.damage&&this.launcher&&this.warhead.detonate(t,this.damage,e.tile,e.tileElevation,e.position.worldPosition,e.zone,i.CollisionType.None,t.createTarget(void 0,e.tile),{player:e.owner,obj:this.launcher,weapon:void 0},!1,!1,void 0)}dispose(){this.launcher=void 0}},e("MissileSpawnTrait",s)}}}),System.register("game/gameobject/task/system/TaskGroup",["game/gameobject/task/system/Task"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.Task{constructor(...e){super(),this.children.push(...e)}onTick(e){return!0}},e("TaskGroup",r)}}}),System.register("game/gameobject/trait/UnlandableTrait",["game/math/Vector2","util/bresenham","util/typeGuard","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var s,a,n,r,o,l,i,c;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){r=e},function(e){o=e},function(e){l=e},function(e){i=e}],execute:function(){c=class{constructor(){this.enabled=!0}setEnabled(e){this.enabled=e}[i.NotifyTick.onTick](e,t){var i;this.enabled&&(e.owner.isNeutral||e.name===t.rules.general.paradrop.paradropPlane)&&e.unitOrderTrait.isIdle()&&(i=this.chooseExitTile(e.tile,t),e.unitOrderTrait.addTask(new l.TaskGroup(new r.MoveTask(t,i,!1,{allowOutOfBoundsTarget:!0}),new o.CallbackTask(e=>t.unspawnObject(e))).setCancellable(!1)))}chooseExitTile(e,t){var i=t.map.tiles.getMapSize(),r=.5<t.generateRandom()?new s.Vector2(Math.floor(i.width/2),0):new s.Vector2(0,Math.floor(i.height/2)),i=new s.Vector2(e.rx,e.ry),r=a.bresenham(i.x,i.y,r.x,r.y).map(e=>t.map.tiles.getByMapCoords(e.x,e.y)).filter(n.isNotNullOrUndefined);if(!r.length)throw new Error("No valid exit tile found");return r[r.length-1]}},e("UnlandableTrait",c)}}}),System.register("game/gameobject/Aircraft",["engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AirportBoundTrait","game/gameobject/trait/SpawnLinkTrait","game/gameobject/trait/MissileSpawnTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/UnlandableTrait"],function(e,t){"use strict";var r,n,s,o,i,l,c,h,u,d,a,g,p;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){s=e},function(e){o=e},function(e){i=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){a=e},function(e){g=e}],execute:function(){p=class extends i.Techno{constructor(e,t,i){super(r.ObjectType.Aircraft,e,t,i),this.pitch=0,this.yaw=0,this.roll=0,this.onBridge=!1,this.zone=s.ZoneType.Ground,this.crateBonuses=new a.CrateBonuses}get direction(){return this.yaw}set direction(e){this.yaw=e}get isMoving(){return this.moveTrait.isMoving()}static factory(e,t,i,r,s){let a=new this(e,t,i);return a.rules.airportBound&&a.rules.dock.length&&(a.airportBoundTrait=new h.AirportBoundTrait(a.rules.dock),a.traits.add(a.airportBoundTrait)),a.rules.missileSpawn||(a.crashableTrait=new c.CrashableTrait(a),a.traits.add(a.crashableTrait)),a.rules.spawned&&(a.rules.missileSpawn?(a.missileSpawnTrait=new d.MissileSpawnTrait,a.traits.add(a.missileSpawnTrait)):(a.spawnLinkTrait=new u.SpawnLinkTrait,a.traits.add(a.spawnLinkTrait))),a.moveTrait=new n.MoveTrait(a,s),a.traits.add(a.moveTrait),t.dock.length&&a.traits.add(new o.DockableTrait),t.landable&&e!==r.general.paradrop.paradropPlane||a.traits.add(new g.UnlandableTrait),t.parasiteable&&(a.parasiteableTrait=new l.ParasiteableTrait(a),a.traits.add(a.parasiteableTrait)),a}isUnit(){return!0}isAircraft(){return!0}},e("Aircraft",p)}}}),System.register("util/array",[],function(e,t){"use strict";t&&t.id;return e("findReverse",function(e,t){for(let i=e.length-1;0<=i;i--)if(t(e[i],i,e))return e[i]}),e("findIndexReverse",function(e,t){for(let i=e.length-1;0<=i;i--)if(t(e[i],i,e))return i;return-1}),e("equals",function(e,t){if(e.length!==t.length)return!1;for(let i=0,r=e.length;i<r;i++)if(e[i]!==t[i])return!1;return!0}),{setters:[],execute:function(){}}}),System.register("game/gameobject/task/move/MoveAsideTask",["game/gameobject/task/system/Task","game/gameobject/unit/MovePositionHelper","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/MoveTrait","game/gameobject/task/move/MoveTask","game/math/geometry","game/type/MovementZone","game/gameobject/infantry/StanceType"],function(e,t){"use strict";var i,l,c,h,u,d,g,p,m;t&&t.id;return{setters:[function(e){i=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class m extends i.Task{constructor(e,t){super(),this.game=e,this.fromDirection=t,this.resolved=!1,this.chainPushIssued=!1}onEnd(e){e.moveTrait.collisionState=h.CollisionState.Resolved}onTick(i){if(this.timeoutTicks=void 0===this.timeoutTicks?0:this.timeoutTicks+1,40<this.timeoutTicks||this.resolved||this.isCancelling())return!0;let r=this.game.map,e=new l.MovePositionHelper(r),s=i.onBridge?r.tileOccupation.getBridgeOnTile(i.tile):void 0,t,a;for(let o=0;o<360;o+=45)if((0!==o||this.chainPushIssued)&&180!==o){var n=d.rotateVec2(this.fromDirection.clone(),o).round(),n=r.tiles.getByMapCoords(i.tile.rx+Math.sign(n.x),i.tile.ry+Math.sign(n.y));if(n&&r.mapBounds.isWithinBounds(n)&&(a=!s||s.isHighBridge()?r.tileOccupation.getBridgeOnTile(n):void 0,i.rules.movementZone===g.MovementZone.Fly||!r.terrain.findObstacles({tile:n,onBridge:a},i).length&&e.isEligibleTile(n,a,s,i.tile))){t=n;break}}if(t)return this.resolved=!0,i.isInfantry()&&i.deployerTrait&&i.deployerTrait.isDeployed()&&i.deployerTrait.setDeployed(!1),!!i.moveTrait.isDisabled()||(this.children.push(new u.MoveTask(this.game,t,!!a,{closeEnoughTiles:0,strictCloseEnough:!0})),!1);{if(this.chainPushIssued)return this.children.push(new c.WaitTicksTask(5)),!1;let t=r.tiles.getByMapCoords(i.tile.rx+Math.sign(this.fromDirection.x),i.tile.ry+Math.sign(this.fromDirection.y));if(!t||!r.mapBounds.isWithinBounds(t))return!0;a=!s||s.isHighBridge()?r.tileOccupation.getBridgeOnTile(t):void 0;let e=r.tileOccupation.getGroundObjectsOnTile(t).filter(e=>e.isUnit()&&e.owner===i.owner&&e.tile===t&&e.onBridge===!!a&&!(e.isInfantry()&&e.stance===p.StanceType.Paradrop)&&!(e.isAircraft()&&e.missileSpawnTrait));return e.find(e=>e.moveTrait.collisionState===h.CollisionState.Waiting||e.unitOrderTrait.hasTasks())?(this.children.push(new c.WaitTicksTask(5)),i.moveTrait.collisionState=h.CollisionState.Waiting,i.moveTrait.moveState=h.MoveState.PlanMove,!1):(e.forEach(e=>{e.unitOrderTrait.addTask(new m(this.game,this.fromDirection))}),this.children.push(new c.WaitTicksTask(1)),i.moveTrait.collisionState=h.CollisionState.Waiting,i.moveTrait.moveState=h.MoveState.PlanMove,!(this.chainPushIssued=!0))}}},e("MoveAsideTask",m)}}}),System.register("game/gameobject/Terrain",["engine/type/ObjectType","game/gameobject/GameObject"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.GameObject{constructor(e,t,i){super(r.ObjectType.Terrain,e,t,i),this.radarInvisible=this.rules.radarInvisible}static factory(e,t,i){return new this(e,t,i)}},e("Terrain",s)}}}),System.register("game/gameobject/locomotor/ChronoLocomotor",["game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var i,n,r;t&&t.id;return{setters:[function(e){i=e},function(e){n=e}],execute:function(){e("ChronoLocomotor",r=class{constructor(e){this.game=e,this.ignoresTerrain=!0,this.distanceToWaypoint=new i.Vector2}onNewWaypoint(e,t){}tick(e,t,i,r){if(r)return{distance:new n.Vector3,done:!0};this.distanceToWaypoint.copy(t).sub(e.position.getMapPosition());var s,a=this.game.rules.general;return a.chronoTrigger&&(a=(s=this.distanceToWaypoint.length())<a.chronoRangeMinimum?a.chronoMinimumDelay:s/a.chronoDistanceFactor,e.warpedOutTrait.setTimed(a,!1,this.game)),{distance:new n.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!0,isTeleport:!0}}})}}}),System.register("game/math/LineCurve",["game/math/Vector2"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends THREE.LineCurve{constructor(e,t){super(e||new i.Vector2,t||new i.Vector2)}getPoint(e,t){return super.getPoint(e,t||new i.Vector2)}},e("LineCurve",r)}}}),System.register("game/math/CurvePath",["game/math/LineCurve"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends THREE.CurvePath{closePath(){let e=this.curves[0].getPoint(0);var t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new i.LineCurve(t,e))}},e("CurvePath",r)}}}),System.register("game/math/QuadraticBezierCurve",["game/math/Vector2"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){i=class extends THREE.QuadraticBezierCurve{constructor(e,t,i){super(e||new r.Vector2,t||new r.Vector2,i||new r.Vector2)}getPoint(e,t){return super.getPoint(e,t||new r.Vector2)}},e("QuadraticBezierCurve",i)}}}),System.register("game/gameobject/locomotor/DriveLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/Coords","game/math/geometry","game/math/Vector2","game/math/Vector3","game/math/CurvePath","game/math/LineCurve","game/math/QuadraticBezierCurve","util/math"],function(t,e){"use strict";var c,a,h,o,u,d,l,g,p,s,m,i;e&&e.id;return{setters:[function(e){c=e},function(e){a=e},function(e){h=e},function(e){o=e},function(e){u=e},function(e){d=e},function(e){l=e},function(e){g=e},function(e){p=e},function(e){s=e}],execute:function(){var e;(e=m=m||{})[e.None=0]="None",e[e.Start=1]="Start",e[e.Normal=2]="Normal",e[e.End=3]="End",e[e.Single=4]="Single",t("DriveLocomotor",i=class{constructor(e){this.game=e,this.hasMomentum=!1,this.moveOnCurve=!1,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=m.None}selectNextWaypoint(e,i){if(this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==m.End?m.Normal:m.Start,this.initialPosition=e.position.getMapPosition(),this.currentWaypointType!==m.Start?e.moveTrait.speedPenalty=0:this.currentSpeed=0,1<i.length){var r=i[i.length-1],s=i[i.length-2],a=new u.Vector2(r.tile.rx-e.tile.rx,r.tile.ry-e.tile.ry),n=Math.abs(o.angleDegFromVec2(a)-o.angleDegFromVec2(new u.Vector2(s.tile.rx-r.tile.rx,s.tile.ry-r.tile.ry)));if(!Math.abs(c.FacingUtil.fromMapCoords(a)-e.direction)&&0<n&&n<90&&this.hasMomentum){this.moveOnCurve=!0,this.currentWaypointType=2===i.length?this.currentWaypointType===m.Start?m.Single:m.End:m.Normal;let e=this.initialPosition;a=new u.Vector2(r.tile.rx+.5,r.tile.ry+.5).multiplyScalar(h.Coords.LEPTONS_PER_TILE);let t=new u.Vector2(s.tile.rx+.5,s.tile.ry+.5).multiplyScalar(h.Coords.LEPTONS_PER_TILE);n=e.clone().lerp(a,.5),r=t.clone().lerp(a,.5);return this.steerCurve=new l.CurvePath,this.steerCurve.add(new g.LineCurve(e,n)),this.steerCurve.add(new p.QuadraticBezierCurve(n,a,r)),this.steerCurve.add(new g.LineCurve(r,t)),this.lastPosition=e,s}}else this.currentWaypointType=this.currentWaypointType===m.Start?m.Single:m.End;return this.hasMomentum=!0,this.moveOnCurve=!1,i[i.length-1]}onNewWaypoint(e,t,i){let r=(new u.Vector2).copy(t).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=this.moveOnCurve?this.steerCurve.getLength():r.length();var s=c.FacingUtil.fromMapCoords(r);if(s!==e.direction&&(this.pointTurretToTarget(e,i),!this.moveOnCurve))return e.moveTrait.velocity.set(0,0,0),[new a.TurnTask(s)]}tick(i,r,e){this.pointTurretToTarget(i,e);let s=this.currentSpeed;s=i.rules.accelerates?(l=this.distanceTravelled/this.totalDistanceToTravel,this.currentSpeed=this.applyAcceleration(i,s,i.moveTrait.baseSpeed,l)):this.currentSpeed=i.moveTrait.baseSpeed,1<s&&(s=Math.floor(s));let t=this.game.map.terrain.getPassableSpeed(i.tile,i.rules.speedType,i.onBridge,void 0,!0);t?i.moveTrait.lastTileSpeed=t:t=i.moveTrait.lastTileSpeed,s*=t,1<s&&(s=Math.floor(s)),this.carryOverDistance&&(s=this.carryOverDistance);var a=i.position.getMapPosition();let n;if(this.moveOnCurve){var o=this.steerCurve.getLength(),l=Math.min(this.distanceTravelled+s,o);this.carryOverDistance=Math.max(0,this.distanceTravelled+s-o),this.distanceTravelled=l;let e=this.steerCurve.getPointAt(this.distanceTravelled/o),t=this.steerCurve.getTangentAt(this.distanceTravelled/o);l=t.clone().setLength(s);i.moveTrait.velocity.set(l.x,0,l.y);var o=i.rules.rot,{facing:l,delta:o}=c.FacingUtil.tick(i.direction,c.FacingUtil.fromMapCoords(t),o);i.direction=l,i.spinVelocity=o;o=this.lastPosition;this.lastPosition=e.clone(),n=e.sub(o)}else{let e=(new u.Vector2).copy(r).sub(a);a=Math.min(e.length(),s);n=e.clone().setLength(a);let t=n.clone();this.carryOverDistance&&t.add(h.Coords.vecWorldToGround(i.moveTrait.velocity)),i.moveTrait.velocity.set(t.x,0,t.y),this.distanceTravelled+=a,this.carryOverDistance=Math.max(0,s-e.length())}return{distance:new d.Vector3(n.x,0,n.y),done:!n.length()||!!this.carryOverDistance}}pointTurretToTarget(t,i){if(t.turretTrait){t.attackTrait?.currentTarget?.obj&&(i=t.attackTrait.currentTarget.obj.position.getMapPosition());var r=t.position.getMapPosition();let e=(new u.Vector2).copy(i).sub(r);e.length()&&(r=c.FacingUtil.fromMapCoords(e),t.turretTrait.desiredFacing=r)}}applyAcceleration(e,t,i,r){if(this.currentWaypointType===m.Single)return i/2;if(this.currentWaypointType!==m.End)return Math.min(t+e.rules.accelerationFactor*i,i);return this.moveOnCurve&&this.currentWaypointType===m.End&&(r=r<=.5?0:2*(r-.5)),s.lerp(1,i,1-r)}})}}}),System.register("game/gameobject/locomotor/FootLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var r,n,i,o,s;t&&t.id;return{setters:[function(e){r=e},function(e){n=e},function(e){i=e},function(e){o=e}],execute:function(){e("FootLocomotor",s=class{constructor(e){this.game=e,this.currentMoveDirection=new i.Vector2,this.distanceToWaypoint=new i.Vector2,this.endPauseFrames=0}onNewWaypoint(e,t){this.currentMoveDirection.copy(t).sub(e.position.getMapPosition());var i=r.FacingUtil.fromMapCoords(this.currentMoveDirection);i!==e.direction&&(e.direction=i),this.endPauseFrames=1}onWaypointUpdate(e,t){this.onNewWaypoint(e,t)}tick(e,t){let i=e.moveTrait.baseSpeed;i=Math.floor(i),e.stance===n.StanceType.Prone&&(i/=2),e.isPanicked&&(i*=2);let r=this.game.map.terrain.getPassableSpeed(e.tile,e.rules.speedType,e.onBridge,void 0,!0);r?this.lastTileSpeed=r:r=this.lastTileSpeed||1,i*=r,i=Math.floor(i),this.distanceToWaypoint.copy(t).sub(e.position.getMapPosition());var s=this.distanceToWaypoint.clone().setLength(i);e.moveTrait.velocity.set(s.x,0,s.y);var a=Math.min(this.distanceToWaypoint.length(),i),s=!a&&0<this.endPauseFrames--;return this.distanceToWaypoint.setLength(a),{distance:new o.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!this.distanceToWaypoint.length()&&!s}}})}}}),System.register("game/gameobject/locomotor/HoverLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/GameSpeed","game/math/geometry","game/math/Vector2","game/math/Vector3"],function(t,e){"use strict";var d,g,n,p,o,m,f,i;e&&e.id;return{setters:[function(e){d=e},function(e){g=e},function(e){n=e},function(e){p=e},function(e){o=e},function(e){m=e}],execute:function(){var e;(e=f=f||{})[e.None=0]="None",e[e.Start=1]="Start",e[e.Normal=2]="Normal",e[e.End=3]="End",e[e.Single=4]="Single",t("HoverLocomotor",i=class{constructor(e){this.hoverRules=e,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=f.None,this.nextWaypointDir=new o.Vector2}selectNextWaypoint(e,t){var i,r;return this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==f.End?f.Normal:f.Start,this.initialPosition=e.position.getMapPosition(),this.currentWaypointType===f.Start&&(this.currentSpeed=0),t.length<=1?(this.currentWaypointType=this.currentWaypointType===f.Start?f.Single:f.End,(r=t[t.length-1])&&this.nextWaypointDir.set(r.tile.rx-e.tile.rx,r.tile.ry-e.tile.ry)):(i=t[t.length-1],r=t[t.length-2],this.nextWaypointDir.set(r.tile.rx-i.tile.rx,r.tile.ry-i.tile.ry)),t[t.length-1]}onNewWaypoint(e,t,i){let r=(new o.Vector2).copy(t).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=r.length();var s=this.maxSpeed=e.moveTrait.baseSpeed,a=60*this.hoverRules.acceleration*n.GameSpeed.BASE_TICKS_PER_SECOND;this.acceleration=s/a;a=60*this.hoverRules.brake*n.GameSpeed.BASE_TICKS_PER_SECOND;this.deceleration=s/a}tick(e,t){var i=e.position.getMapPosition();let r=t.clone().sub(i);var s=r.length(),i=this.maxSpeed;this.currentWaypointType===f.Single?this.currentSpeed=i/2:this.currentWaypointType===f.End?(a=this.computeBrakeDistance(this.currentSpeed,this.deceleration),this.totalDistanceToTravel-this.distanceTravelled<=a&&(this.currentSpeed=Math.max(0,this.currentSpeed-this.deceleration))):this.currentSpeed=Math.min(this.currentSpeed+this.acceleration,i);var a=g.FacingUtil.fromMapCoords(r),i=g.FacingUtil.fromMapCoords(this.nextWaypointDir);let n=a,o=e.rules.rot;this.currentWaypointType===f.Normal&&a!==i&&(a=(l=p.angleDegBetweenVec2(this.nextWaypointDir,g.FacingUtil.toMapCoords(e.direction)))/o,a=Math.max(this.currentSpeed*a,this.totalDistanceToTravel),this.totalDistanceToTravel-this.distanceTravelled<=a&&(n=i,o=l/((this.totalDistanceToTravel-this.distanceTravelled)/this.currentSpeed)));var l=g.FacingUtil.tick(e.direction,n,o)["facing"];e.direction=l;let c=this.currentSpeed;this.carryOverDistance&&(c=this.carryOverDistance);l=Math.min(c,s);let h=r.clone().setLength(l),u=h.clone();return this.carryOverDistance&&u.add(d.Coords.vecWorldToGround(e.moveTrait.velocity)),e.moveTrait.velocity.set(u.x,0,u.y),this.distanceTravelled+=l,this.carryOverDistance=Math.max(0,c-s),{distance:new m.Vector3(h.x,0,h.y),done:!h.length()||!!this.carryOverDistance}}computeBrakeDistance(e,t){var i=e/t;return Math.max(0,e*i-t*i*i/2)}})}}}),System.register("game/math/CubicBezierCurve3",["game/math/Vector3"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){i=class extends THREE.CubicBezierCurve3{constructor(e,t,i,r){super(e||new s.Vector3,t||new s.Vector3,i||new s.Vector3,r||new s.Vector3)}getPoint(e,t){return super.getPoint(e,t||new s.Vector3)}},e("CubicBezierCurve3",i)}}}),System.register("game/gameobject/locomotor/MissileLocomotor",["game/Coords","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/math/geometry","game/gameobject/unit/FacingUtil","game/math/Vector3","game/math/Vector2","game/math/CubicBezierCurve3","game/math/GameMath"],function(t,e){"use strict";var p,m,f,y,T,v,b,S,w,C,i;e&&e.id;return{setters:[function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){var e;(e=C=C||{})[e.Boost=0]="Boost",e[e.Midcourse=1]="Midcourse",e[e.Terminal=2]="Terminal",t("MissileLocomotor",i=class{constructor(e,t){this.game=e,this.missileRules=t,this.flightPhase=C.Boost}selectNextWaypoint(e,t){var i=t[t.length-1],r=this.game.map.tileOccupation.getBridgeOnTile(i.tile),r=i.tile.z+(r?.tileElevation??0);return this.targetPosition=p.Coords.tile3dToWorld(i.tile.rx+.5,i.tile.ry+.5,r),this.cruiseAltitude=p.Coords.tileHeightToWorld(r)+this.missileRules.altitude,i}onNewWaypoint(e,t,i){}tick(i,e,t){let r=i.position.worldPosition.clone(),s=this.targetPosition.clone().sub(r);i.zone!==m.ZoneType.Air&&(i.onBridge=!1,i.zone=m.ZoneType.Air,this.game.events.dispatch(new f.ObjectLiftOffEvent(i)));let a;var n;a=this.currentVelocity?(n=i.rules.speed,Math.min(this.currentVelocity.length()+this.missileRules.acceleration,n)):(g=this.missileRules.acceleration,this.missileRules.lazyCurve?this.currentVelocity=new v.Vector3(s.x,0,s.z):this.currentVelocity=p.Coords.vecGroundToWorld(T.FacingUtil.toMapCoords(i.direction)),y.rotateVec3Towards(this.currentVelocity,new v.Vector3(this.currentVelocity.x,1e8,this.currentVelocity.z),i.pitch),g),this.currentVelocity.setLength(a);let o=!1;switch(this.flightPhase){case C.Boost:if(!(i.position.worldPosition.y>=this.cruiseAltitude)){o=!1;break}this.flightPhase=C.Midcourse;case C.Midcourse:var l,c=new b.Vector2(s.x,s.z).length();if(!this.missileRules.lazyCurve){y.rotateVec3Towards(this.currentVelocity,new v.Vector3(this.currentVelocity.x,0,this.currentVelocity.z),i.rules.rot),this.currentVelocity.y<1&&(l=this.currentVelocity.length(),this.currentVelocity.y=0,this.currentVelocity.setLength(l)),y.rotateVec3Towards(this.currentVelocity,new v.Vector3(s.x,this.currentVelocity.y,s.z),i.rules.rot),i.direction=T.FacingUtil.fromMapCoords(p.Coords.vecWorldToGround(this.currentVelocity)),i.pitch=Math.sign(this.currentVelocity.y)*y.angleDegBetweenVec3(this.currentVelocity,new v.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),c/(r.y-this.targetPosition.y)<1&&(this.flightPhase=C.Terminal);break}this.flightPhase=C.Terminal;var h=r.clone().add(this.currentVelocity.clone().setLength(c/3/w.GameMath.cos(y.degToRad(i.pitch)))),u=this.targetPosition.clone().lerp(r,.15).setY(h.y);this.descentCurve=new S.CubicBezierCurve3(r,h,u,this.targetPosition);case C.Terminal:h=this.missileRules.bodyLength;if(this.missileRules.lazyCurve){var d=this.descentCurve.getLength();this.descentTravelled??(this.descentTravelled=0),this.descentTravelled+=Math.min(a,d-h-this.descentTravelled);u=this.descentTravelled/d;let e=this.descentCurve.getPointAt(u),t=this.descentCurve.getTangentAt(u);this.currentVelocity.copy(e.sub(r));u=t.clone().setY(0);i.pitch=Math.sign(t.y-u.y)*y.angleDegBetweenVec3(u,t),o=1<=(this.descentTravelled+h)/d}else{y.rotateVec3Towards(this.currentVelocity,s,i.rules.rot),i.direction=T.FacingUtil.fromMapCoords(p.Coords.vecWorldToGround(this.currentVelocity)),i.pitch=Math.sign(this.currentVelocity.y)*y.angleDegBetweenVec3(this.currentVelocity,new v.Vector3(this.currentVelocity.x,0,this.currentVelocity.z));d=s.length()-h;(d<a||d<1)&&(this.currentVelocity.copy(s.clone().addScalar(-h)),o=!0)}break;default:throw new Error(`Unhandled flight phase "${this.flightPhase}"`)}var g=r.clone().add(this.currentVelocity);return this.game.map.isWithinHardBounds(g)?(i.moveTrait.velocity.copy(this.currentVelocity),{distance:this.currentVelocity,done:o}):(this.game.destroyObject(i),{done:!0,distance:new v.Vector3})}})}}}),System.register("game/gameobject/locomotor/LocomotorFactory",["game/type/LocomotorType","game/gameobject/locomotor/ChronoLocomotor","game/gameobject/locomotor/DriveLocomotor","game/gameobject/locomotor/FootLocomotor","game/gameobject/locomotor/HoverLocomotor","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/MissileLocomotor","game/gameobject/locomotor/WingedLocomotor"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("LocomotorFactory",h=class{constructor(e){this.game=e}create(e){var t=e.rules.locomotor;switch(t){case i.LocomotorType.Infantry:return new a.FootLocomotor(this.game);case i.LocomotorType.Jumpjet:return new o.JumpjetLocomotor(this.game);case i.LocomotorType.Vehicle:case i.LocomotorType.Ship:return new s.DriveLocomotor(this.game);case i.LocomotorType.Chrono:return e.isVehicle()&&e.harvesterTrait&&e.rules.teleporter?new s.DriveLocomotor(this.game):new r.ChronoLocomotor(this.game);case i.LocomotorType.Aircraft:return new c.WingedLocomotor(this.game);case i.LocomotorType.Missile:return new l.MissileLocomotor(this.game,this.game.rules.general.getMissileRules(e.name));case i.LocomotorType.Hover:return new n.HoverLocomotor(this.game.rules.general.hover);default:throw new Error("Unhandled locomotor type "+t)}}})}}}),System.register("game/event/ObjectTeleportEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("ObjectTeleportEvent",i=class{constructor(e,t,i){this.target=e,this.isChronoshift=t,this.prevTile=i,this.type=r.EventType.ObjectTeleport}})}}}),System.register("game/type/PowerupType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Armor=0]="Armor",e[e.Firepower=1]="Firepower",e[e.HealBase=2]="HealBase",e[e.Money=3]="Money",e[e.Reveal=4]="Reveal",e[e.Speed=5]="Speed",e[e.Veteran=6]="Veteran",e[e.Unit=7]="Unit",e[e.Invulnerability=8]="Invulnerability",e[e.IonStorm=9]="IonStorm",e[e.Gas=10]="Gas",e[e.Tiberium=11]="Tiberium",e[e.Pod=12]="Pod",e[e.Cloak=13]="Cloak",e[e.Darkness=14]="Darkness",e[e.Explosion=15]="Explosion",e[e.ICBM=16]="ICBM",e[e.Napalm=17]="Napalm",e[e.Squad=18]="Squad",t("PowerupType",i)}}}),System.register("game/gameobject/unit/VeteranAbility",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.FASTER=0]="FASTER",e[e.STRONGER=1]="STRONGER",e[e.FIREPOWER=2]="FIREPOWER",e[e.SCATTER=3]="SCATTER",e[e.ROF=4]="ROF",e[e.SIGHT=5]="SIGHT",e[e.SELF_HEAL=6]="SELF_HEAL",e[e.CLOAK=7]="CLOAK",e[e.EXPLODES=8]="EXPLODES",e[e.RADAR_INVISIBLE=9]="RADAR_INVISIBLE",e[e.SENSORS=10]="SENSORS",e[e.FEARLESS=11]="FEARLESS",e[e.C4=12]="C4",e[e.GUARD_AREA=13]="GUARD_AREA",e[e.CRUSHER=14]="CRUSHER",t("VeteranAbility",i)}}}),System.register("game/gameobject/task/move/MoveTask",["game/gameobject/task/system/Task","game/gameobject/Infantry","game/type/MovementZone","util/array","game/type/SpeedType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/WaitTicksTask","game/gameobject/task/move/MoveAsideTask","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","util/Logger","game/Coords","game/gameobject/task/system/TaskStatus","game/gameobject/unit/ZoneType","game/gameobject/locomotor/LocomotorFactory","game/map/tileFinder/RandomTileFinder","game/event/ObjectTeleportEvent","game/gameobject/trait/interface/NotifyTeleport","game/type/PowerupType","game/gameobject/task/ScatterTask","game/gameobject/unit/VeteranAbility","game/math/Vector2"],function(e,t){"use strict";var i,n,y,T,v,b,S,w,l,o,s,a,C,r,E,c,h,x,O,A,M,R,P,I,k,B,j,u;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){l=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){C=e},function(e){r=e},function(e){E=e},function(e){c=e},function(e){h=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e}],execute:function(){I=1.5,k=200,B=40,j=5,u=class u extends i.Task{constructor(e,t,i,r){super(),this.game=e,this.targetTile=t,this.toBridge=i,this.options=r,this.preventOpportunityFire=!1,this.logger=a.AppLogger.get("move"),this.destinationLeptons=new P.Vector2,this.currentWaypointLeptons=new P.Vector2,this.needsPathUpdate=!1,this.targetChangeRequested=!1,this.allObstaclesAreBlockers=!1,this.blockedPathNodes=[],this.unreachableTargets=[],this.pushTried=!1,this.cancelProcessed=!1,this.cancelRepositionPending=!1,this.targetLinesConfig={pathNodes:[]}}duplicate(){return new u(this.game,this.targetTile,this.toBridge,this.options)}onStart(e){if(e.moveTrait.currentWaypoint)throw new Error("Nested move tasks are not supported");void 0===e.moveTrait.locomotor&&(e.moveTrait.locomotor=new c.LocomotorFactory(this.game).create(e)),e.moveTrait.lastTargetOffset?this.targetOffset=e.moveTrait.lastTargetOffset:this.targetOffset=this.computeTargetOffset(e),e.moveTrait.lastVelocity&&(e.moveTrait.velocity=e.moveTrait.lastVelocity),this.path||(this.computePath(e,e.moveTrait.locomotor),this.targetLinesConfig.isRecalc=!1),this.updateDestination(this.path,this.targetOffset),e.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,e.moveTrait.lastMoveResult=void 0,e.moveTrait.lastTargetOffset=void 0,e.moveTrait.lastVelocity=void 0}computeTargetOffset(e){return this.options?.targetOffset??(e.isInfantry()?e.position.getTileOffset():e.position.computeSubCellOffset(0))}computePath(e,t){let i;i=this.options?.allowOutOfBoundsTarget||this.game.map.mapBounds.isWithinBounds(this.targetTile)?e.rules.movementZone===y.MovementZone.Fly?this.computeAirPath(e):t.ignoresTerrain?this.computeDirectJumpPath(e):(this.blockedPathNodes=this.blockedPathNodes.filter(e=>e.obj.isSpawned&&e.node.tile===e.obj.tile),this.computeGroundPath(e)):[],e.rules.movementZone===y.MovementZone.Fly?(this.targetLinesConfig.pathNodes=i.map(({tile:e,onBridge:t})=>({tile:e,onBridge:t})),i.length&&(this.targetLinesConfig.pathNodes[0].onBridge=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0)):this.targetLinesConfig.pathNodes=i,this.path=i}computeAirPath(e){return[{tile:this.targetTile,onBridge:void 0},{tile:e.tile,onBridge:void 0}]}computeDirectJumpPath(t){let i=this.game.map;var e=t.onBridge?i.tileOccupation.getBridgeOnTile(t.tile):void 0;let r=this.targetTile,s=this.toBridge?i.tileOccupation.getBridgeOnTile(this.targetTile):void 0,a=this.options?.ignoredBlockers;var n=new o.RadialTileFinder(i.tiles,i.mapBounds,r,{width:1,height:1},0,5,e=>0<i.terrain.getPassableSpeed(e,t.rules.speedType,!!e.onBridgeLandType,a)&&!i.terrain.findObstacles({tile:e,onBridge:!!e.onBridgeLandType},t).find(e=>!a?.includes(e.obj))).getNextTile();return n?(n!==r&&(r=n,s=i.tileOccupation.getBridgeOnTile(r)),[{tile:r,onBridge:s},{tile:t.tile,onBridge:e}]):[]}computeGroundPath(t){let e=t.tile,i=t.onBridge?this.game.map.tileOccupation.getBridgeOnTile(e):void 0;t.moveTrait.moveState===b.MoveState.Moving&&t.moveTrait.currentWaypoint&&(e=t.moveTrait.currentWaypoint.tile,i=t.moveTrait.currentWaypoint.onBridge);let r;var s=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0,a=this.nodeIsBlockedForPathfinding({tile:this.targetTile,onBridge:s},t);if(Math.abs(e.rx-this.targetTile.rx)<=1&&Math.abs(e.ry-this.targetTile.ry)<=1&&new l.MovePositionHelper(this.game.map).isEligibleTile(e,i,s,this.targetTile)&&a)r=[];else{const o=this.game.map.getObjectsOnTile(e).find(e=>e.isBuilding());if(o&&!this.game.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)){this.options??(this.options={});var n=this.options?.ignoredBlockers?.includes(o);if(this.options.ignoredBlockers=[...new Set([...this.options?.ignoredBlockers??[],o])],!n&&o.dockTrait){let t=new Set(o.dockTrait?.getAllDockTiles()),e=this.game.map.tileOccupation.calculateTilesForGameObject(o.tile,o);e.filter(e=>!t.has(e)).forEach(e=>this.blockedPathNodes.push({node:{tile:e,onBridge:void 0},obj:o}))}}n=this.game.map.getGroundObjectsOnTile(this.targetTile).find(e=>(e.isInfantry()||e.isVehicle())&&e.disguiseTrait?.hasTerrainDisguise()&&!(this.game.alliances.haveSharedIntel(t.owner,e.owner)||e.owner.sharedDetectDisguiseTrait?.has(t)));n&&this.blockedPathNodes.push({node:{tile:this.targetTile,onBridge:s},obj:n}),r=this.game.map.terrain.computePath(t.rules.speedType,e,!!i,this.targetTile,this.toBridge,{maxExpandedNodes:this.allObstaclesAreBlockers?Math.min(300,this.options?.maxExpandedPathNodes??Number.POSITIVE_INFINITY):this.options?.maxExpandedPathNodes,bestEffort:!this.options?.strictCloseEnough,ignoredBlockers:[...new Set([...this.options?.ignoredBlockers??[],...this.options?.pathFinderIgnoredBlockers??[]])],excludeTiles:this.allObstaclesAreBlockers||this.blockedPathNodes.length?e=>this.nodeIsBlockedForPathfinding(e,t):void 0})}return r}nodeIsBlockedForPathfinding(t,e){return this.allObstaclesAreBlockers?!!this.game.map.terrain.findObstacles(t,e).find(e=>!this.options?.ignoredBlockers?.includes(e.obj)):!!this.blockedPathNodes.find(({node:e})=>e.tile===t.tile&&e.onBridge===t.onBridge)}updateDestination(e,t){var i=e.length?e[0].tile:this.targetTile;this.destinationLeptons.set(i.rx*C.Coords.LEPTONS_PER_TILE,i.ry*C.Coords.LEPTONS_PER_TILE).add(t)}canStopAtTile(t,i,r){if(t.zone===E.ZoneType.Air){if((!t.isAircraft()||!t.airportBoundTrait)&&!t.rules.spawned&&(!this.game.map.terrain.getPassableSpeed(i,v.SpeedType.Amphibious,r)||this.game.map.getObjectsOnTile(i).filter(e=>e.isBuilding()&&!e.isDestroyed&&!e.dockTrait?.hasReservedDockForUnit(t)&&!t.rules.dock.includes(e.name)||e.isUnit()&&e.tile===i&&e.moveTrait.moveState!==b.MoveState.Moving&&e!==t).length))return!1}else if(t.isInfantry()){let e=this.game.map.getGroundObjectsOnTile(i).filter(e=>e.isInfantry()&&e.tile===i&&e.onBridge===r&&e.moveTrait.moveState!==b.MoveState.Moving&&e!==t);if(2<e.length||e.find(e=>e.position.subCell===t.position.subCell))return!1}return!(t.zone!==E.ZoneType.Air&&t.rules.tooBigToFitUnderBridge&&!r&&i.onBridgeLandType&&this.game.map.tileOccupation.getBridgeOnTile(i)?.isHighBridge())&&!(!this.isCancelling()&&this.options?.strictCloseEnough&&void 0!==this.options?.closeEnoughTiles&&!this.isCloseEnoughToDest(t,i,this.options.closeEnoughTiles))}isCloseEnoughToDest(e,t,i){if(void 0===i)return!0;let r=new s.RangeHelper(this.game.map.tileOccupation);return!(r.tileDistance(this.targetTile,t)>i)}hasReachedDestination(e){return!this.path.length}updateTarget(e,t){this.targetTile=e,this.toBridge=t,this.needsPathUpdate=!0,this.targetChangeRequested=!0}onEnd(e){e.moveTrait.collisionState=b.CollisionState.Resolved,e.moveTrait.currentWaypoint=void 0,this.targetOffset.equals(this.computeTargetOffset(e))||(e.moveTrait.lastTargetOffset=this.targetOffset)}forceCancel(e){return!(!this.cancellable||this.children.some(e=>!e.cancellable))&&(!(!this.options?.allowOutOfBoundsTarget&&!this.game.map.isWithinBounds(e.tile))&&(this.status!==r.TaskStatus.Running&&this.status!==r.TaskStatus.Cancelling||(e.moveTrait.unreservePathNodes(),e.moveTrait.lastMoveResult=b.MoveResult.Cancel,this.onEnd(e),e.moveTrait.lastTargetOffset=this.targetOffset,e.moveTrait.lastVelocity=e.moveTrait.velocity.clone()),this.status=r.TaskStatus.Cancelled,!0))}onTick(s){if(s.moveTrait.isDisabled()&&s.moveTrait.moveState===b.MoveState.ReachedNextWaypoint)return!!this.isCancelling()&&(s.moveTrait.lastMoveResult=b.MoveResult.Cancel,!0);this.needsPathUpdate&&(s.moveTrait.moveState===b.MoveState.PlanMove&&(this.inPlanningForTicks=void 0,s.moveTrait.currentWaypoint=void 0,s.moveTrait.collisionState=b.CollisionState.Resolved,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,s.moveTrait.velocity.set(0,0,0)),this.computePath(s,s.moveTrait.locomotor),this.path.length||this.unreachableTargets.push({tile:this.targetTile,toBridge:this.toBridge}),this.updateDestination(this.path,this.targetOffset),this.targetLinesConfig.isRecalc=!this.targetChangeRequested,this.targetChangeRequested=!1,this.needsPathUpdate=!1,this.allObstaclesAreBlockers=!1);let i=this.game.map;if(s.moveTrait.moveState===b.MoveState.ReachedNextWaypoint){s.moveTrait.unreservePathNodes();var r=this.path.findIndex(e=>e===s.moveTrait.currentWaypoint);if(-1!==r?this.path.splice(r):this.path.pop(),s.moveTrait.currentWaypoint=void 0,this.isCancelling()?!this.cancelProcessed:this.hasReachedDestination(s)){var a=!this.isCancelling()&&!this.isCloseEnoughToDest(s,s.tile,this.options?.closeEnoughTiles);if(!a&&this.canStopAtTile(s,s.tile,s.onBridge))return s.moveTrait.lastMoveResult=this.isCancelling()?b.MoveResult.Cancel:b.MoveResult.Success,!0;{if(this.unreachableTargets.length>j)return s.moveTrait.lastMoveResult=b.MoveResult.Fail,this.log(s,"bail_max_unreachable_dest"),!0;let e=s.tile,t=s.onBridge?i.tileOccupation.getBridgeOnTile(e):void 0;a&&(e=this.targetTile,t=this.toBridge?i.tileOccupation.getBridgeOnTile(e):void 0);r=this.findRelocationTile(e,t,s);if(!r)return s.moveTrait.lastMoveResult=a?b.MoveResult.Fail:b.MoveResult.CloseEnough,this.log(s,"bail_no_free_dest"),!0;a=!t||t.isHighBridge()?i.tileOccupation.getBridgeOnTile(r):void 0;return this.updateTarget(r,!!a),this.isCancelling()&&(this.cancelProcessed=!0,this.cancelRepositionPending=!0),!1}}if(this.cancelProcessed&&!this.path.length)return s.moveTrait.lastMoveResult=b.MoveResult.Cancel,!0;this.cancelProcessed=!1,s.moveTrait.moveState=b.MoveState.PlanMove;let e=s.moveTrait.locomotor;s.moveTrait.currentWaypoint=e.selectNextWaypoint?e.selectNextWaypoint(s,this.path):this.path[this.path.length-1],this.currentWaypointLeptons.set(s.moveTrait.currentWaypoint.tile.rx,s.moveTrait.currentWaypoint.tile.ry).multiplyScalar(C.Coords.LEPTONS_PER_TILE).add(this.targetOffset);a=e.onNewWaypoint(s,this.currentWaypointLeptons,this.destinationLeptons);if(a)return this.children.push(...a),!1}if(s.moveTrait.moveState===b.MoveState.PlanMove){if(this.isCancelling()&&!this.cancelRepositionPending)return s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s);if(this.inPlanningForTicks=void 0===this.inPlanningForTicks?0:this.inPlanningForTicks+1,this.inPlanningForTicks>k)return this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,s.moveTrait.velocity.set(0,0,0),this.log(s,"repath_plan_timeout"),!1;if(s.rules.movementZone!==y.MovementZone.Fly&&!s.moveTrait.locomotor.ignoresTerrain){let t=this.path.slice(this.path.indexOf(s.moveTrait.currentWaypoint)).reverse();var n,e,o=s.moveTrait.velocity.length();for(n of t){if(!i.terrain.getPassableSpeed(n.tile,s.rules.speedType,!!n.onBridge,this.options?.ignoredBlockers))return this.options?.stopOnBlocker&&i.terrain.findObstacles(n,s).some(e=>e.obj===this.options.stopOnBlocker)?(s.moveTrait.lastMoveResult=b.MoveResult.CloseEnough,!0):(this.needsPathUpdate=!0,s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s));if(!n.onBridge){var l=i.getGroundObjectsOnTile(n.tile).find(e=>e.isOverlay()&&e.rules.crate);if(l)if(this.game.crateGeneratorTrait.peekInsideCrate(l)===A.PowerupType.Unit){this.game.crateGeneratorTrait.pickupCrate(s,l,this.game);l=this.game.map.getGroundObjectsOnTile(n.tile).find(e=>e.isUnit()&&!e.onBridge);if(l)return this.needsPathUpdate=!0,this.blockedPathNodes.push({node:n,obj:l}),s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s)}}for(e of i.terrain.findObstacles(n,s).filter(e=>!this.options?.ignoredBlockers?.includes(e.obj))){if(e.static)return this.needsPathUpdate=!0,s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s);if(e.obj.rules.crushable){if(!(s.rules.speedType!==v.SpeedType.Track||!s.crusher||e.obj.isTechno()&&this.game.areFriendly(e.obj,s)))continue;if(!e.obj.isTechno())return this.needsPathUpdate=!0,s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s)}if(e.obj.isTerrain()){if(!s.isInfantry())throw new Error(`Obstacle ${e.obj.name} should be a blocker for non infantry`);var c=this.findFreeSubCell(s,n);return void 0!==c?this.relocateToSubCell(s,c):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:n,obj:e.obj}),s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint),this.onTick(s)}if(!e.obj.isTechno())throw new Error("Unexpected obstacle of type "+e.obj.type);const f=e.obj;var h=f.isUnit()?f.moveTrait.velocity.length():0;if(!f.isAircraft()||f.zone!==E.ZoneType.Ground||!this.options?.ignoredBlockers?.some(e=>e.isBuilding()&&e.dockTrait?.isDocked(f))){if(1===t.length&&f.isUnit()&&h&&o&&o<=h&&s.direction===f.direction&&f.tile===n.tile&&f.moveTrait.currentWaypoint?.tile!==n.tile)break;if(f.isBuilding()||f.moveTrait.moveState===b.MoveState.Idle||f.moveTrait.collisionState!==b.CollisionState.Resolved){if(!o&&s.moveTrait.collisionState!==b.CollisionState.Resolved&&f.isUnit()&&f.moveTrait.collisionState!==b.CollisionState.Resolved)return this.inPlanningForTicks+1>k&&(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(s,"repath_waited_too_long_blocker "+f.id),s.moveTrait.velocity.set(0,0,0)),!1;{if(f.isInfantry()&&s.isInfantry()&&f.moveTrait.collisionState===b.CollisionState.Resolved){var u=this.findFreeSubCell(s,n);if(void 0!==u)return this.relocateToSubCell(s,u),this.onTick(s)}c=T.findIndexReverse(this.path.slice(0,this.path.indexOf(n)),e=>!i.terrain.findObstacles(e,s).length);if(-1===c){if(this.canStopAtTile(s,s.tile,s.onBridge)&&this.isCloseEnoughToDest(s,s.tile,this.options?.closeEnoughTiles))return s.moveTrait.lastMoveResult=b.MoveResult.CloseEnough,this.log(s,"bail_waypoints_blocked_close_enough"),!0;if(!(0===this.options?.closeEnoughTiles||Math.abs(s.tile.rx-this.targetTile.rx)<=1&&Math.abs(s.tile.ry-this.targetTile.ry)<=1))return this.needsPathUpdate=!0,this.blockedPathNodes.push(...this.path.slice(0,this.path.indexOf(n)+1).map(e=>({node:e,obj:i.terrain.findObstacles(e,s)[0].obj}))),s.moveTrait.velocity.set(0,0,0),this.log(s,"repath_waypoints_blocked_too_far"),!1}let e;if(e=-1!==c?(u=this.path[c],i.terrain.computePath(s.rules.speedType,s.tile,s.onBridge,u.tile,!!u.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:e=>!!i.terrain.findObstacles(e,s).length})):[],e.length||f.owner!==s.owner||1!==t.length)return e.length?(this.path.splice(c,this.path.length,...e),s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s)):((d=this.selectWeaponVsObstacle(s,f))?(this.children.push(s.attackTrait.createAttackTask(this.game,f,f.tile,d,{passive:!0,holdGround:!0})),s.moveTrait.velocity.set(0,0,0)):this.options?.forceWaitOnPathBlocked?(this.children.push(new S.WaitTicksTask(B)),this.inPlanningForTicks=0,s.moveTrait.velocity.set(0,0,0),s.moveTrait.collisionState=b.CollisionState.Waiting):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:n,obj:f}),f.isBuilding()&&(this.allObstaclesAreBlockers=!0),this.log(s,"repath_unavoidable_blocker "+f.id),s.moveTrait.velocity.set(0,0,0)),!1);d=f.unitOrderTrait.hasTasks();if(this.pushTried||f.isBuilding()||f.moveTrait.collisionState===b.CollisionState.Waiting||d||f.isAircraft()&&f.missileSpawnTrait)return!this.options?.forceWaitOnPathBlocked&&(f.isBuilding()||d&&f.moveTrait.moveState===b.MoveState.Idle||this.inPlanningForTicks+B>k)?(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(s,"repath_blocker_busy_wait_timeout "+f.id),s.moveTrait.velocity.set(0,0,0)):(this.children.push(new S.WaitTicksTask(B)),this.options?.forceWaitOnPathBlocked?this.inPlanningForTicks=0:this.inPlanningForTicks+=B,s.moveTrait.velocity.set(0,0,0),s.moveTrait.collisionState=b.CollisionState.Waiting),!1;var d,d=new P.Vector2(f.tile.rx-s.tile.rx,f.tile.ry-s.tile.ry);return this.pushTried=!0,f.unitOrderTrait.addTask(new w.MoveAsideTask(this.game,d)),this.children.push(new S.WaitTicksTask(1)),s.moveTrait.velocity.set(0,0,0),s.moveTrait.collisionState=b.CollisionState.Waiting,this.log(s,"push "+f.id),!1}}if(!o)return this.inPlanningForTicks>B&&(s.moveTrait.collisionState=b.CollisionState.Waiting),!1;if(180===Math.abs(s.direction-f.direction))return s.moveTrait.velocity.set(0,0,0),s.moveTrait.collisionState=b.CollisionState.Waiting,!1;if(Math.abs(s.direction-f.direction)<=45&&h*I<o){h=this.path.indexOf(n);if(5<=h){let e=T.findIndexReverse(this.path.slice(0,h-5),e=>!i.terrain.findObstacles(e,s).length);if(-1!==e){h=this.path[e],h=i.terrain.computePath(s.rules.speedType,s.tile,s.onBridge,h.tile,!!h.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:t=>!!i.terrain.findObstacles(t,s).length||this.path.findIndex(e=>e.tile===t.tile&&e.onBridge===t.onBridge)>e});if(h.length)return this.path.splice(e,this.path.length,...h),s.moveTrait.currentWaypoint=void 0,s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s)}}return s.moveTrait.collisionState=b.CollisionState.Waiting,s.moveTrait.velocity.set(0,0,0),!1}return s.moveTrait.velocity.set(0,0,0),s.moveTrait.collisionState=b.CollisionState.Waiting,!1}}}if(s.rules.speedType===v.SpeedType.Track&&o){var g,p=this.path.indexOf(s.moveTrait.currentWaypoint);if(0<p){let t=this.path[p-1];for(g of i.getGroundObjectsOnTile(t.tile).filter(e=>e.isUnit()&&e.onBridge===!!t.onBridge&&e.rules.crushable&&e.veteranTrait?.hasVeteranAbility(R.VeteranAbility.SCATTER)&&!this.game.areFriendly(e,s)))g.unitOrderTrait.hasTasks()||g.unitOrderTrait.addTask(new M.ScatterTask(this.game))}}s.moveTrait.reservedPathNodes.length||(s.moveTrait.reservedPathNodes.push(...t),t.forEach(e=>{i.tileOccupation.occupySingleTile(e.tile,s)}))}s.moveTrait.moveState=b.MoveState.Moving,this.inPlanningForTicks=void 0,this.unreachableTargets.length=0,this.pushTried=!1,s.moveTrait.collisionState===b.CollisionState.Waiting&&(s.moveTrait.collisionState=b.CollisionState.Resolved)}if(s.moveTrait.moveState===b.MoveState.Moving){let e=s.moveTrait.locomotor,{distance:t,done:i,isTeleport:r}=e.tick(s,this.currentWaypointLeptons,this.destinationLeptons,(this.isCancelling()||!this.path.length)&&!this.cancelRepositionPending);if(r&&s.traits.filter(O.NotifyTeleport).forEach(e=>{e[O.NotifyTeleport.onBeforeTeleport](s,this.game,!0,!0)}),t.length()){a=s.tile,p=e.allowOutOfBounds;if(t.y?(m=s.tileElevation,s.position.moveByLeptons3(t,p),s.moveTrait.handleElevationChange(m,this.game)):s.position.moveByLeptons(t.x,t.z,p),s.tile!==a){var m=s.onBridge?this.game.map.tileOccupation.getBridgeOnTile(a):void 0,p=T.findReverse(this.path,e=>e.tile===s.tile),m=p?p.onBridge:m||s.moveTrait.currentWaypoint.onBridge?this.game.map.tileOccupation.getBridgeOnTile(s.tile):void 0;if(s.moveTrait.handleTileChange(a,m,!1,this.game,r),r&&(s.moveTrait.lastTeleportTick=this.game.currentTick,this.game.events.dispatch(new x.ObjectTeleportEvent(s,!0,a))),s.isDestroyed)return!0}}if(i)return s.moveTrait.moveState=b.MoveState.ReachedNextWaypoint,this.onTick(s)}return!1}selectWeaponVsObstacle(e,t){let i;if(!this.game.areFriendly(t,e)&&e.attackTrait&&!e.attackTrait.isDisabled()&&e.attackTrait.isIdle()&&(i=e.attackTrait.selectWeaponVersus(e,t,this.game,!1,!0))&&i.name!==e.armedTrait?.deathWeapon?.name&&(!i.rules.limboLaunch||!i.warhead.rules.parasite)&&!i.warhead.rules.mindControl)return i}findRelocationTile(r,s,a){let n=this.game.map,i;if(a.rules.movementZone===y.MovementZone.Fly){let e=new h.RandomTileFinder(n.tiles,n.mapBounds,r,1,this.game,e=>!0);i=e.getNextTile()}else{let e=new l.MovePositionHelper(n),t=new o.RadialTileFinder(n.tiles,n.mapBounds,r,{width:1,height:1},0,5,t=>{let i=!s||s.isHighBridge()?n.tileOccupation.getBridgeOnTile(t):void 0;return!this.unreachableTargets.find(e=>e.tile===t&&e.toBridge===!!i)&&(a.zone===E.ZoneType.Air||!n.terrain.findObstacles({tile:t,onBridge:i},a).length&&e.isEligibleTile(t,i,s,r))&&this.canStopAtTile(a,t,!!i)});i=t.getNextTile()}return i}findFreeSubCell(t,i){let e=this.game.map.getGroundObjectsOnTile(i.tile);var r=e.filter(e=>e.isInfantry()&&e.onBridge===!!i.onBridge&&e!==t).map(e=>e.position.desiredSubCell),s=e.filter(e=>e.isTerrain()).map(e=>e.rules.getOccupiedSubCells(this.game.map.getTheaterType())).flat();let a=[...r,...s];return n.Infantry.SUB_CELLS.find(e=>-1===a.indexOf(e))}relocateToSubCell(e,t){e.position.desiredSubCell=t;var i=e.position.computeSubCellOffset(t);this.targetOffset=i,this.currentWaypointLeptons.set(e.moveTrait.currentWaypoint.tile.rx,e.moveTrait.currentWaypoint.tile.ry).multiplyScalar(C.Coords.LEPTONS_PER_TILE).add(this.targetOffset),this.updateDestination(this.path,this.targetOffset),e.moveTrait.locomotor.onWaypointUpdate?.(e,this.currentWaypointLeptons,this.destinationLeptons)}getTargetLinesConfig(e){var t;return this.path||((t=e.moveTrait).locomotor??(t.locomotor=new c.LocomotorFactory(this.game).create(e)),this.computePath(e,e.moveTrait.locomotor),this.targetLinesConfig.isRecalc=!1),this.targetLinesConfig}log(e,t){this.logger.debug(`<${e.id}>: `+t)}},e("MoveTask",u)}}}),System.register("game/trait/interface/NotifyTileChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onTileChange=Symbol(),e("NotifyTileChange",i)}}}),System.register("game/event/EnterTileEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("EnterTileEvent",r=class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.EnterTile}})}}}),System.register("game/trait/interface/NotifyElevationChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onElevationChange=Symbol(),e("NotifyElevationChange",i)}}}),System.register("game/gameobject/trait/MoveTrait",["game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/ZoneType","game/gameobject/infantry/InfDeathType","game/event/ObjectTeleportEvent","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyTeleport","game/type/LocomotorType","game/gameobject/locomotor/JumpjetLocomotor","game/type/SpeedType","game/gameobject/locomotor/WingedLocomotor","game/gameobject/infantry/StanceType","game/trait/interface/NotifyTileChange","game/gameobject/trait/interface/NotifyTileChange","game/event/EnterTileEvent","game/math/Vector3","game/trait/interface/NotifyElevationChange"],function(t,e){"use strict";var i,r,s,h,u,o,d,l,a,n,g,c,p,m,f,y,T,v,b,S,w,C,E;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){h=e},function(e){u=e},function(e){o=e},function(e){d=e},function(e){l=e},function(e){a=e},function(e){n=e},function(e){g=e},function(e){c=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){var e;(e=b=b||{})[e.Idle=0]="Idle",e[e.ReachedNextWaypoint=1]="ReachedNextWaypoint",e[e.PlanMove=2]="PlanMove",e[e.Moving=3]="Moving",t("MoveState",b),(e=S=S||{})[e.Success=0]="Success",e[e.Cancel=1]="Cancel",e[e.CloseEnough=2]="CloseEnough",e[e.Fail=3]="Fail",t("MoveResult",S),(e=w=w||{})[e.Waiting=0]="Waiting",e[e.Resolved=1]="Resolved",t("CollisionState",w),C=e=>e instanceof i.MoveTask||e.children[0]&&C(e.children[0]),E=class{constructor(e,t){this.gameObject=e,this.tileOccupation=t,this.disabled=!1,this.speedPenalty=0,this.velocity=new T.Vector3,this.reservedPathNodes=[],this.moveState=b.Idle,this.collisionState=w.Resolved}get baseSpeed(){return this.gameObject.rules.speed*(this.gameObject.veteranTrait?.getVeteranSpeedMultiplier()??1)*this.gameObject.crateBonuses.speed*(this.gameObject.isVehicle()&&this.gameObject.healthTrait.health<=50&&this.gameObject.rules.locomotor!==a.LocomotorType.Hover?.75:1)*(1-this.speedPenalty)}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}isMoving(){return this.moveState===b.Moving}isIdle(){return this.moveState===b.Idle}isWaiting(){return this.collisionState===w.Waiting}[r.NotifyTick.onTick](e,t){var i;this.moveState!==b.Idle&&this.collisionState===w.Resolved&&((i=e.unitOrderTrait.getCurrentTask())&&C(i)||(this.velocity.set(0,0,0),this.moveState=b.Idle,this.locomotor=void 0,!i&&!e.attackTrait?.currentTarget&&e.isVehicle()&&e.turretTrait&&(e.turretTrait.desiredFacing=e.direction))),this.moveState===b.Idle&&(e.rules.locomotor===a.LocomotorType.Jumpjet?n.JumpjetLocomotor.tickStationary(e,t):e.isAircraft()&&e.rules.locomotor===a.LocomotorType.Aircraft&&c.WingedLocomotor.tickStationary(e,t))}[s.NotifyDestroy.onDestroy](e,t){this.unreservePathNodes()}teleportUnitToTile(e,t,i,r,s){let a=this.gameObject;var n=a.tile;a.traits.filter(l.NotifyTeleport).forEach(e=>{e[l.NotifyTeleport.onBeforeTeleport](a,s,i,r)}),a.position.tileElevation=a.tileElevation,a.position.tile=e,a.position.subCell=a.position.desiredSubCell,this.handleTileChange(n,t,!0,s,!0),r||(this.unreservePathNodes(),this.speedPenalty=0,this.velocity.set(0,0,0),this.moveState=b.Idle,this.collisionState=w.Resolved,this.locomotor=void 0,this.currentWaypoint=void 0,this.lastTargetOffset=void 0,this.lastVelocity=void 0,this.lastMoveResult=S.Cancel,a.isVehicle()&&(a.spinVelocity=0,a.turretTrait&&(a.turretTrait.desiredFacing=a.direction))),this.lastTeleportTick=s.currentTick,s.events.dispatch(new o.ObjectTeleportEvent(a,i,n))}handleTileChange(t,e,i,r,s=!1){const a=this.gameObject;if(r.map.tileOccupation.unoccupyTileRange(t,a),r.map.tileOccupation.occupyTileRange(a.tile,a),r.map.technosByTile.updateObject(a),a.zone!==h.ZoneType.Air){var n=a.onBridge?r.map.tileOccupation.getBridgeOnTile(t):void 0,o=a.onBridge?t.onBridgeLandType:t.landType,l=e?a.tile.onBridgeLandType:a.tile.landType;o!==l&&(0<r.rules.getLandRules(l).getSpeedModifier(a.rules.speedType)||a.rules.speedType===g.SpeedType.Amphibious||s)&&(a.zone=h.getZoneType(l)),e!==n&&(a.position.tileElevation+=-(n?.tileElevation??0)+(e?.tileElevation??0),a.onBridge=!!e);var c,n=a.moveTrait.reservedPathNodes.findIndex(e=>e.tile===a.tile&&!!e.onBridge===a.onBridge);if(-1!==n&&a.moveTrait.reservedPathNodes.splice(n,1),a.crusher)for(c of r.map.getGroundObjectsOnTile(a.tile).filter(e=>(!e.isUnit()||e.onBridge===a.onBridge)&&e.rules.crushable&&!(e.isInfantry()&&e.stance===p.StanceType.Paradrop)&&(!(e.isTechno()&&!i)||!r.areFriendly(e,a))))c.isDestroyed||(c.isInfantry()&&(c.infDeathType=u.InfDeathType.None),a.isVehicle()&&c.isOverlay()&&c.rules.wall&&a.applyRocking(0,.5),c.deathType=d.DeathType.Crush,r.destroyObject(c,{player:a.owner,obj:a}));a.onBridge||(n=r.map.tileOccupation.getGroundObjectsOnTile(a.tile).find(e=>e.isOverlay()&&e.rules.crate))&&r.crateGeneratorTrait.pickupCrate(a,n,r)}r.traits.filter(m.NotifyTileChange).forEach(e=>{e[m.NotifyTileChange.onTileChange](a,r,t,s)}),a.traits.filter(f.NotifyTileChange).forEach(e=>{e[f.NotifyTileChange.onTileChange](a,r,t,s)}),r.events.dispatch(new y.EnterTileEvent(a.tile,a))}handleElevationChange(t,i){i.traits.filter(v.NotifyElevationChange).forEach(e=>{e[v.NotifyElevationChange.onElevationChange](this.gameObject,i,t)})}unreservePathNodes(){this.reservedPathNodes.forEach(e=>{e.tile!==this.gameObject.tile&&this.tileOccupation.unoccupySingleTile(e.tile,this.gameObject)}),this.reservedPathNodes.length=0}dispose(){this.gameObject=void 0}},t("MoveTrait",E)}}}),System.register("game/gameobject/trait/SuppressionTrait",["game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class{constructor(){this.suppressionTicks=0,this.enabled=!0}disable(){this.enabled=!1}isSuppressed(){return this.enabled&&0<this.suppressionTicks}supress(){this.enabled&&(this.suppressionTicks=30)}[i.NotifyTick.onTick](){0<this.suppressionTicks&&this.suppressionTicks--}},e("SuppressionTrait",r)}}}),System.register("game/gameobject/trait/IdleActionTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/ScatterTask","game/GameSpeed"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class{constructor(){this.cooldownTicks=Number.POSITIVE_INFINITY,this._actionDueThisTick=!1}[i.NotifyTick.onTick](e,t){this._actionDueThisTick=!1;var i=!e.unitOrderTrait.hasTasks();i&&!this.idle?this.resetCooldown(t):i?0===this.cooldownTicks?(this.doIdleAction(e,t),this.resetCooldown(t)):this.cooldownTicks--:this.cooldownTicks=Number.POSITIVE_INFINITY,this.idle=i}doIdleAction(e,t){if(e.isInfantry()){if(e.rules.fraidycat)if(.5<t.generateRandom())return void e.unitOrderTrait.addTask(new r.ScatterTask(t,void 0,{noSlopes:!0}));this._actionDueThisTick=!0}}actionDueThisTick(){return this._actionDueThisTick}resetCooldown(e){var t=e.rules.audioVisual.idleActionFrequency,i=e.generateRandom()*t*.5,i=Math.max(0,t-i);this.cooldownTicks=Math.floor(i*s.GameSpeed.BASE_TICKS_PER_SECOND)}},e("IdleActionTrait",a)}}}),System.register("game/gameobject/trait/AgentTrait",["game/rules/TechnoRules","util/math"],function(e,t){"use strict";var a,n,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){e("AgentTrait",i=class{infiltrate(e,t,i){var r,s;t.rules.radar&&![...t.owner.buildings].some(e=>e.rules.spySat)&&i.mapShroudTrait.resetShroud(t.owner,i),0<t.rules.power&&(r=i.rules.general.spyPowerBlackout,t.owner.powerTrait?.setBlackoutFor(r,i)),t.superWeaponTrait&&t.superWeaponTrait.getSuperWeapon(t)?.resetTimer(),0<t.rules.storage&&(s=n.clamp(i.rules.general.spyMoneyStealPercent,0,1),s=Math.floor(t.owner.credits*s),t.owner.credits-=s,e.owner.credits+=s),!i.rules.ai.buildTech.includes(t.name)||void 0!==(s=t.rules.aiBasePlanningSide)&&e.owner.production.addStolenTech(s),[a.FactoryType.InfantryType,a.FactoryType.UnitType].includes(t.factoryTrait?.type)&&e.owner.production?.addVeteranType(t.factoryTrait.type)}})}}}),System.register("game/gameobject/Infantry",["engine/type/ObjectType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/gameobject/trait/MoveTrait","game/gameobject/trait/SuppressionTrait","game/gameobject/Techno","game/gameobject/trait/IdleActionTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AgentTrait","game/gameobject/unit/CrateBonuses"],function(e,t){"use strict";var r,s,a,n,o,l,i,c,h,u,d,g;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){i=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class extends i.Techno{constructor(e,t,i){super(r.ObjectType.Infantry,e,t,i),this.direction=0,this.onBridge=!1,this.zone=s.ZoneType.Ground,this._stance=a.StanceType.None,this.isFiring=!1,this.isPanicked=!1,this.infDeathType=n.InfDeathType.Gunfire,this.crateBonuses=new d.CrateBonuses}get isMoving(){return this.moveTrait.isMoving()}static factory(e,t,i,r){let s=new this(e,t,i);return s.moveTrait=new o.MoveTrait(s,r),s.traits.add(s.moveTrait),s.rules.crashable&&(s.crashableTrait=new h.CrashableTrait(s),s.traits.add(s.crashableTrait)),s.rules.proneWhenAttacked&&(s.suppressionTrait=new l.SuppressionTrait,s.traits.add(s.suppressionTrait)),s.rules.agent&&(s.agentTrait=new u.AgentTrait,s.traits.add(s.agentTrait)),s.idleActionTrait=new c.IdleActionTrait,s.traits.add(s.idleActionTrait),s}get stance(){return this._stance===a.StanceType.None&&this.suppressionTrait?.isSuppressed()?a.StanceType.Prone:this._stance}set stance(e){this._stance=e,this.moveTrait.setDisabled([a.StanceType.Deployed,a.StanceType.Cheer].includes(e)),this.attackTrait?.setDisabled([a.StanceType.Paradrop,a.StanceType.Cheer].includes(e))}isUnit(){return!0}isInfantry(){return!0}},e("Infantry",g),g.SUB_CELLS=[2,4,3]}}}),System.register("game/event/BuildingEvacuateEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingEvacuateEvent",r=class{constructor(e,t){this.target=e,this.player=t,this.type=i.EventType.BuildingEvacuate}})}}}),System.register("game/gameobject/trait/GarrisonTrait",["game/gameobject/trait/interface/NotifyDestroy","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyDamage","util/math","game/event/BuildingEvacuateEvent","game/gameobject/task/ScatterTask"],function(e,t){"use strict";var i,d,r,s,g,p,a;t&&t.id;return{setters:[function(e){i=e},function(e){d=e},function(e){r=e},function(e){s=e},function(e){g=e},function(e){p=e}],execute:function(){a=class{constructor(e,t,i){this.building=e,this.evacThreshold=t,this.maxOccupants=i,this.units=[]}isOccupied(){return!!this.units.length}canBeOccupied(){return this.building.healthTrait.health>100*this.evacThreshold}[r.NotifyDamage.onDamage](e,t){e.healthTrait.health<=100*this.evacThreshold&&this.evacuate(t)}[i.NotifyDestroy.onDestroy](e,t,i,r){if(r){for(var s of this.units)t.destroyObject(s,i,!0);this.units=[]}else this.evacuate(t)}getHash(){return s.fnv32a(this.units.map(e=>e.getHash()))}debugGetState(){return{units:this.units.map(e=>e.debugGetState())}}dispose(){this.building=void 0}evacuate(r,s=!1){let a=this.building,n=this.units;if(n.length){let e=new Map;for(var o of n)e.set(o.rules.speedType,(e.get(o.rules.speedType)||[]).concat(o));for(let[t,i]of e){var l,c=new d.RadialTileFinder(r.map.tiles,r.map.mapBounds,a.tile,a.art.foundation,1,1,e=>0<r.map.terrain.getPassableSpeed(e,t,!1)&&Math.abs(e.z-a.tile.z)<2&&!r.map.terrain.findObstacles({tile:e,onBridge:void 0},i[0]).length).getNextTile();for(l of i){var h=n.indexOf(l);c?(n.splice(h,1),r.unlimboObject(l,c),l.unitOrderTrait.addTask(new p.ScatterTask(r))):s||(r.destroyObject(l,{player:l.owner}),n.splice(h,1))}}var u=a.owner;n.length||a.isDestroyed||r.changeObjectOwner(a,r.getCivilianPlayer()),r.events.dispatch(new g.BuildingEvacuateEvent(a,u))}}},e("GarrisonTrait",a)}}}),System.register("game/event/BuildStatusChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildStatusChangeEvent",r=class{constructor(e,t){this.target=e,this.status=t,this.type=i.EventType.BuildStatusChange}})}}}),System.register("game/event/PowerLowEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PowerLowEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.PowerLow}})}}}),System.register("game/event/PowerRestoreEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PowerRestoreEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.PowerRestore}})}}}),System.register("game/event/PowerChangeEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("PowerChangeEvent",i=class{constructor(e,t,i){this.target=e,this.power=t,this.drain=i,this.type=r.EventType.PowerChange}})}}}),System.register("game/trait/interface/NotifyPower",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{}).onPowerLow=Symbol(),e.onPowerRestore=Symbol(),e.onPowerChange=Symbol(),t("NotifyPower",i)}}}),System.register("game/player/trait/PowerTrait",["game/event/PowerLowEvent","game/event/PowerRestoreEvent","game/event/PowerChangeEvent","game/trait/interface/NotifyPower","util/math"],function(t,e){"use strict";var i,r,n,o,s,a,l;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){var e;(e=a=a||{})[e.Low=0]="Low",e[e.Normal=1]="Normal",t("PowerLevel",a),t("PowerTrait",l=class{constructor(e){this.player=e,this.power=0,this.drain=0,this.level=a.Normal,this.blackoutFrames=0,this.powerByObject=new Map}isLowPower(){return this.level===a.Low}setBlackoutFor(e,t){var i=0<this.blackoutFrames;this.blackoutFrames=e,i||this.updateLevel(t)}updateBlackout(e){0<this.blackoutFrames&&(this.blackoutFrames--,this.blackoutFrames<=0&&this.updateLevel(e))}getBlackoutDuration(){return this.blackoutFrames}updateFrom(t,i,r){var s=t.rules.power;if(s){if(s<0)"add"!==i&&"remove"!==i||(this.drain+="add"===i?-s:s);else{let e=0;if("add"===i){var a=Math.ceil(s*t.healthTrait.health/100);this.powerByObject.set(t,a),e=a}else if("update"===i||"remove"===i){a=this.powerByObject.get(t);if(void 0===a)throw new Error("Cannot update power before add.");e="update"===i?(s=Math.ceil(s*t.healthTrait.health/100),this.powerByObject.set(t,s),s-a):(this.powerByObject.delete(t),-a)}this.power+=e}this.updateLevel(r),r.traits.filter(o.NotifyPower).forEach(e=>{e[o.NotifyPower.onPowerChange](this.player,r)}),r.events.dispatch(new n.PowerChangeEvent(this.player,this.power,this.drain))}}updateLevel(t){var e=this.level;this.level=this.power>=this.drain&&!this.blackoutFrames?a.Normal:a.Low,this.level!==e&&(e===a.Normal&&this.level===a.Low&&(t.traits.filter(o.NotifyPower).forEach(e=>{e[o.NotifyPower.onPowerLow](this.player,t)}),t.events.dispatch(new i.PowerLowEvent(this.player))),e===a.Low&&this.level===a.Normal&&(t.traits.filter(o.NotifyPower).forEach(e=>{e[o.NotifyPower.onPowerRestore](this.player,t)}),t.events.dispatch(new r.PowerRestoreEvent(this.player))))}getHash(){return s.fnv32a([this.power,this.drain])}debugGetState(){return{power:this.power,drain:this.drain}}dispose(){this.player=void 0,this.powerByObject.clear()}})}}}),System.register("game/gameobject/trait/PoweredTrait",["game/player/trait/PowerTrait"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PoweredTrait",r=class{constructor(e){this.obj=e,this.turnedOn=!0}setTurnedOn(e){this.turnedOn=e}isCharged(){return!!this.obj.isBuilding()&&!!this.obj.overpoweredTrait?.hasChargersToPowerOn()}isPoweredOn(e=!1){return!(!this.obj||!this.turnedOn)&&(!(e||!this.isCharged())||(!this.obj.rules.power&&this.obj.rules.needsEngineer?!this.obj.owner.isNeutral:!!this.obj.owner.powerTrait&&this.obj.owner.powerTrait?.level!==i.PowerLevel.Low))}dispose(){this.obj=void 0}})}}}),System.register("game/player/production/ProductionQueue",["util/event"],function(t,e){"use strict";var r,n,o,i;e&&e.id;return{setters:[function(e){r=e}],execute:function(){var e;(e=n=n||{})[e.Structures=0]="Structures",e[e.Armory=1]="Armory",e[e.Infantry=2]="Infantry",e[e.Vehicles=3]="Vehicles",e[e.Aircrafts=4]="Aircrafts",e[e.Ships=5]="Ships",t("QueueType",n),(e=o=o||{})[e.Idle=0]="Idle",e[e.Active=1]="Active",e[e.OnHold=2]="OnHold",e[e.Ready=3]="Ready",t("QueueStatus",o),t("ProductionQueue",i=class{constructor(e,t,i){this.type=e,this._maxSize=t,this.maxItemQuantity=i,this.items=[],this.size=0,this._status=o.Idle,this._onUpdate=new r.EventDispatcher}get onUpdate(){return this._onUpdate.asEvent()}get status(){return this._status}set status(e){var t=this._status;(this._status=e)!==t&&this._onUpdate.dispatch(this)}get maxSize(){return this._maxSize}set maxSize(e){var t=this.size;this.size=Math.min(e,this.size);let i=0,r=0;for(;i<=this.size&&r<this.items.length;){let e=this.items[r];i+=e.quantity,i>this.size&&(e.quantity-=i-this.size),0<e.quantity&&r++}this._maxSize=e,this.items[r]&&this.items.splice(r),t!==this.size&&(this.size||(this._status=o.Idle),this._onUpdate.dispatch(this))}get currentSize(){return this.size}find(t){return this.items.filter(e=>e.rules===t)}getFirst(){return this.items[0]}getAll(){return[...this.items]}push(e,t,i){t=Math.min(this.maxSize-this.size,t);var r=this.find(e).reduce((e,t)=>e+t.quantity,0);t=Math.min(this.maxItemQuantity-r,t),this.items[this.items.length-1]?.rules===e?this.items[this.items.length-1].quantity+=t:this.items.push({rules:e,quantity:t,creditsEach:i,creditsSpent:0,creditsSpentLeftover:0,progress:0}),this.size+=t,t&&(this._status===o.Idle&&(this._status=o.Active),this._onUpdate.dispatch(this))}pop(e,t){this.remove(e,t,!1)}shift(e,t){this.remove(e,t,!0)}remove(e,t,i){let r=this.find(e);if(!r.length)throw new Error(`Can't remove non-existent item ${e.name} from queue `+n[this.type]);var s;if(r.reduce((e,t)=>e+t.quantity,0)<t)throw new Error(`Attempted to remove a quantity larger than the one in queue (${e.name})`);let a=t;for(;0<a;){let e=i?r.shift():r.pop();e.quantity<=a?(s=this.getFirst()===e,this.items.splice(this.items.indexOf(e),1),s&&(this._status=o.Active),a-=e.quantity):(e.quantity-=a,a=0)}this.size-=t,t&&(this.size||(this._status=o.Idle),this._onUpdate.dispatch(this))}notifyUpdated(){this._onUpdate.dispatch(this)}})}}}),System.register("game/gameobject/task/move/AttackMoveTargetTask",["game/gameobject/task/AttackTask","game/gameobject/trait/MoveTrait"],function(e,t){"use strict";var i,s,r;t&&t.id;return{setters:[function(e){i=e},function(e){s=e}],execute:function(){r=class r extends i.AttackTask{constructor(e,t,i){if(super(e,t,i),this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.internalTargetUpdateRequested=!1,this.scanCooldownTicks=0,!t.obj?.isTechno())throw new Error("Target must be a techno object");this.initialTarget=t,this.initialWeapon=i,this.requestedTarget=t}duplicate(){return new r(this.game,this.initialTarget,this.initialWeapon)}requestTargetUpdate(e){this.internalTargetUpdateRequested?(this.requestedTarget=e,this.internalTargetUpdateRequested=!1):(this.requestedTarget===this.initialTarget?this.requestedTarget=e:this.attackPerformed=!0,this.initialTarget=e),super.requestTargetUpdate(e)}onTargetChange(e){super.onTargetChange(e);var t=e.attackTrait.currentTarget;t&&t.obj!==this.initialTarget.obj&&t.obj!==this.requestedTarget.obj&&(this.requestedTarget===this.initialTarget&&(this.requestedTarget=t),this.initialTarget=t)}onTick(t){if(t.moveTrait.moveState===s.MoveState.Moving&&(this.passedFirstWaypoint=!0),this.scanCooldownTicks=Math.max(0,this.scanCooldownTicks-1),t.attackTrait&&!t.attackTrait.isDisabled()&&!this.isCancelling()&&(this.requestedTarget===this.initialTarget||this.attackPerformed)){if(!(t.moveTrait.isIdle()||t.tile===this.lastScanTile&&this.scanCooldownTicks)){this.lastScanTile=t.tile,this.scanCooldownTicks=this.game.rules.general.normalTargetingDelay;let e=t.attackTrait.selectDefaultWeapon(t);if(e&&(this.passedFirstWaypoint||!e.getCooldownTicks())){var i=t.attackTrait.scanForTarget(t,e,this.game);if(i.target){let{target:e,weapon:t}=i;if(!t.getCooldownTicks()){this.options.holdGround=!0,this.options.passive=!0,this.setWeapon(t);var r=this.game.createTarget(e,e.tile);return this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(r),this.attackPerformed=!1}}}}if(this.attackPerformed){if(!t.isSpawned){if(!this.forceCancel(t))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.options.holdGround=!1,this.options.passive=!1,this.setWeapon(this.initialWeapon),this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(this.initialTarget)}}r=super.onTick(t);return r&&this.requestedTarget!==this.initialTarget?(this.attackPerformed=!0,this.isCancelling()||t.attackTrait.isDisabled()):r}},e("AttackMoveTargetTask",r)}}}),System.register("game/gameobject/task/move/AttackMoveTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait"],function(e,t){"use strict";var i,s,r;t&&t.id;return{setters:[function(e){i=e},function(e){s=e}],execute:function(){r=class r extends i.MoveTask{constructor(){super(...arguments),this.attackPerformed=!1,this.passedFirstWaypoint=!1}duplicate(){return new r(this.game,this.targetTile,this.toBridge,this.options)}onTick(i){if(i.moveTrait.moveState===s.MoveState.Moving&&(this.passedFirstWaypoint=!0),i.moveTrait.moveState===s.MoveState.ReachedNextWaypoint&&i.attackTrait&&!i.attackTrait.isDisabled()&&!this.isCancelling()){let e=i.attackTrait.selectDefaultWeapon(i);if(e&&(this.passedFirstWaypoint||e&&!e.getCooldownTicks())){var r=i.attackTrait.scanForTarget(i,e,this.game);if(r.target){let{target:e,weapon:t}=r;if(!t.getCooldownTicks()){r=i.attackTrait.createAttackTask(this.game,e,e.tile,t,{holdGround:!0,passive:!0});return this.children.push(r),this.useChildTargetLines=!0,this.attackPerformed=!0,i.moveTrait.velocity.set(0,0,0),i.moveTrait.currentWaypoint=void 0,i.moveTrait.collisionState=s.CollisionState.Waiting,!1}}}if(this.attackPerformed){if(!i.isSpawned){if(!this.forceCancel(i))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.useChildTargetLines=!1,i.moveTrait.collisionState=s.CollisionState.Resolved,this.updateTarget(this.targetTile,this.toBridge)}}return super.onTick(i)}},e("AttackMoveTask",r)}}}),System.register("game/gameobject/task/move/ExitFactoryTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait","game/rules/TechnoRules","game/gameobject/task/ScatterTask","game/gameobject/task/AttackTask","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/AttackMoveTask"],function(e,t){"use strict";var s,a,n,o,l,c,h,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){i=class extends s.MoveTask{constructor(e,t,i,r){super(e,i,!1,{ignoredBlockers:[t],closeEnoughTiles:0,strictCloseEnough:!0,forceWaitOnPathBlocked:t.factoryTrait?.type!==n.FactoryType.InfantryType}),this.factory=t,this.rallyPoint=r,this.preventOpportunityFire=!0,this.rampBlockersPushed=!1,this.cancellable=!1}onStart(t){super.onStart(t),this.factory.factoryTrait?.type===n.FactoryType.UnitType&&(this.checkRampTiles=this.game.map.tileOccupation.calculateTilesForGameObject(this.factory.tile,this.factory).filter(e=>0<this.game.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)))}canStopAtTile(e,t,i){return!this.game.map.tileOccupation.isTileOccupiedBy(t,this.factory)&&super.canStopAtTile(e,t,i)}onTick(e){if(this.checkRampTiles){for(var t of this.checkRampTiles){var i,r;for(i of this.game.map.tileOccupation.getGroundObjectsOnTile(t))if(i.isUnit()){if(this.rampBlockersPushed)return!1;let e=new o.ScatterTask(this.game,void 0,{excludedTiles:this.checkRampTiles});e.setCancellable(!1);let t=i.unitOrderTrait.getCurrentTask();t?t.constructor!==s.MoveTask&&t.constructor!==l.AttackTask&&t.constructor!==h.AttackMoveTask&&t.constructor!==c.AttackMoveTargetTask||(r=t.duplicate(),t.cancel(),i.unitOrderTrait.addTaskNext(r),i.unitOrderTrait.addTaskNext(e)):i.unitOrderTrait.addTask(e)}}if(!this.rampBlockersPushed)return!(this.rampBlockersPushed=!0);this.checkRampTiles=void 0}return e.moveTrait.moveState===a.MoveState.ReachedNextWaypoint&&this.options?.ignoredBlockers&&!this.game.map.terrain.isBlockerObject(this.factory,e.tile,!1,e.rules.speedType)&&(this.options.ignoredBlockers=void 0,this.preventOpportunityFire=!1,this.rallyPoint&&(this.updateTarget(this.rallyPoint.tile,!!this.rallyPoint.onBridge),this.cancellable=!0,this.options.closeEnoughTiles=this.game.rules.general.closeEnough,this.options.strictCloseEnough=!1,this.options.forceWaitOnPathBlocked=!1)),super.onTick(e)}},e("ExitFactoryTask",i)}}}),System.register("game/map/tileFinder/CardinalTileFinder",["game/math/Vector2"],function(e,t){"use strict";var n,i;t&&t.id;return{setters:[function(e){n=e}],execute:function(){e("CardinalTileFinder",i=class{constructor(e,t,i,r,s,a=()=>!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.maxDistance=s,this.predicate=a,this.dirVec=new n.Vector2(10,0),this.finished=!1,this.diagonal=!0,this.distance=r}getNextTile(){if(!this.finished){let t;do{let e={x:this.startTile.rx,y:this.startTile.ry};e.x+=this.distance*Math.sign(this.dirVec.x),e.y+=this.distance*Math.sign(this.dirVec.y),this.dirVec.rotateAround(new n.Vector2,Math.PI/4*(this.diagonal?1:2)).round();var i=this.tiles.getByMapCoords(e.x,e.y);if(i&&this.mapBounds.isWithinBounds(i)&&this.predicate(i)&&(t=i),!this.dirVec.angle()){if(this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,t;this.distance++}}while(!t);return t}}})}}}),System.register("game/gameobject/trait/DockTrait",["game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySell","game/gameobject/trait/DockableTrait","game/Coords","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","util/typeGuard","game/gameobject/task/MoveToDockTask","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyUnspawn"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class{constructor(e,t,i,r){this.building=e,this.tiles=t,this.numberOfDocks=i,this.dockingOffsets=r,this.ticksWhenWarpedOut=!0,this.unitsByDockNumber=new Array(i).fill(void 0),this.reservedDocks=new Array(i).fill(void 0)}[l.NotifySpawn.onSpawn](){this.dockTiles=[];for(let t=0;t<this.numberOfDocks;t++){var e=this.findDockTile(t);if(!e)throw new Error(`Docking tile ${t} not found for object "${this.building.name}"`);this.dockTiles[t]=e}}[p.NotifyUnspawn.onUnspawn](){for(let e=0;e<this.numberOfDocks;e++)this.unreserveDockAt(e)}[o.NotifyTick.onTick](){for(let t=0;t<this.numberOfDocks;t++){var e=this.unitsByDockNumber[t];e&&e.tile!==this.getDockTile(t)&&this.undockUnit(e)}}[i.NotifyDestroy.onDestroy](e,t,i,r){var s=(e.rules.unitRepair||e.helipadTrait)&&!e.rules.naval&&!i?.weapon?.warhead.rules.temporal;if(s)for(var a of this.unitsByDockNumber)a&&!a.isDestroyed&&(s?t.destroyObject(a,i,r):this.undockUnit(a))}[s.NotifySell.onSell](r,s){if(r.helipadTrait&&this.hasDockedUnits()){var a,e,n;let t=[],i=0;for(a of[...r.owner.buildings].filter(e=>e.helipadTrait&&(e.dockTrait?.getAvailableDockCount()??!1)&&e!==r)){let e=a.dockTrait?.getAvailableDockCount()??0;for(;0<e&&i<this.unitsByDockNumber.length;)t.push(a),e--,i++;if(i===this.unitsByDockNumber.length)break}i=0;for(e of this.unitsByDockNumber)e&&((n=t[i])?e.unitOrderTrait.addTask(new h.MoveToDockTask(s,n)):e.unitOrderTrait.addTask(new g.TaskGroup(new u.MoveTask(s,e.tile,!1),new d.CallbackTask(e=>{e.crashableTrait?e.crashableTrait.crash({player:r.owner}):s.destroyObject(e,{player:r.owner})})).setCancellable(!1))),i++}else{var t,i=r.rules.unitRepair&&!r.rules.naval;for(t of this.unitsByDockNumber)t&&(i?s.sellTrait.sell(t):this.undockUnit(t))}}[r.NotifyOwnerChange.onChange](e,t,i){for(var r of this.unitsByDockNumber)r&&i.changeObjectOwner(r,e.owner)}getFirstAvailableDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var e=this.unitsByDockNumber.findIndex((e,t)=>!e&&!this.reservedDocks[t]);if(-1!==e)return e}}getAvailableDockCount(){return this.building?.warpedOutTrait.isActive()?0:this.unitsByDockNumber.filter((e,t)=>!e&&!this.reservedDocks[t]).length}getFirstEmptyDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var e=this.unitsByDockNumber.findIndex(e=>!e);if(-1!==e)return e}}getDockOffset(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);return this.dockingOffsets[e]}getDockTile(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);return this.dockTiles[e]}getDockNumberByTile(e){var t=this.dockTiles.indexOf(e);if(-1!==t)return t}getAllDockTiles(){return[...this.dockTiles]}findDockTile(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);var t=this.building.position.getMapPosition(),i=this.getDockOffset(e);return this.tiles.getByMapCoords(Math.floor((t.x+i.x)/n.Coords.LEPTONS_PER_TILE),Math.floor((t.y+i.z)/n.Coords.LEPTONS_PER_TILE))}isValidUnitForDock(e){return(this.building.unitRepairTrait&&e.isVehicle()&&!this.building.helipadTrait&&(!e.rules.consideredAircraft||e.rules.landable)||e.rules.dock.includes(this.building.name)&&!(e.isAircraft()&&!this.building.helipadTrait))&&this.building.rules.naval===e.rules.naval}dockUnitAt(e,t){if(t>this.numberOfDocks-1)throw new RangeError(`Index ${t} exceeds available docks (${this.numberOfDocks})`);if(this.unitsByDockNumber[t])throw new Error("Another unit is already docked at dock #"+t);let i=e.traits.find(a.DockableTrait);if(!i)throw new Error(`Unit "${e.name}" cannot be docked to `+this.building.name);this.unitsByDockNumber[t]=e,i.dock=this.building}undockUnitAt(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);let t=this.unitsByDockNumber[e];t&&(this.unitsByDockNumber[e]=void 0,t.traits.get(a.DockableTrait).dock=void 0)}undockUnit(e){var t=this.unitsByDockNumber.indexOf(e);-1!==t&&this.undockUnitAt(t)}isDocked(e){return this.unitsByDockNumber.includes(e)}hasDockedUnits(){return!!this.unitsByDockNumber.find(e=>e)}getDockedUnits(){return this.unitsByDockNumber.filter(c.isNotNullOrUndefined)}reserveDockAt(e,t){if(t>this.numberOfDocks-1)throw new RangeError(`Index ${t} exceeds available docks (${this.numberOfDocks})`);if(this.reservedDocks[t])throw new Error(`Dock #${t} is already reserved by `+this.reservedDocks[t].name);(this.reservedDocks[t]=e).traits.get(a.DockableTrait).reservedDock?.dockTrait.unreserveDockForUnit(e),e.traits.get(a.DockableTrait).reservedDock=this.building}unreserveDockAt(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);let t=this.reservedDocks[e];t&&(this.reservedDocks[e]=void 0,t.traits.get(a.DockableTrait).reservedDock=void 0)}unreserveDockForUnit(e){var t=this.reservedDocks.indexOf(e);-1!==t&&this.unreserveDockAt(t)}hasReservedDockForUnit(e){return!!this.reservedDocks.includes(e)}hasReservedDockAt(e){return!!this.reservedDocks[e]}getReservedDockForUnit(e){var t=this.reservedDocks.indexOf(e);if(-1!==t)return t}dispose(){this.building=void 0}},e("DockTrait",m)}}}),System.register("game/event/FactoryProduceUnitEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("FactoryProduceUnitEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.FactoryProduceUnit}})}}}),System.register("game/gameobject/trait/interface/NotifyWarpChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyWarpChange",i)}}}),System.register("game/trait/interface/NotifyProduceUnit",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onProduce=Symbol(),e("NotifyProduceUnit",i)}}}),System.register("game/gameobject/trait/FactoryTrait",["game/gameobject/trait/interface/NotifyTick","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/task/move/ExitFactoryTask","engine/type/TerrainType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/MoveTrait","game/map/tileFinder/CardinalTileFinder","game/gameobject/trait/DockTrait","game/event/FactoryProduceUnitEvent","game/gameobject/Infantry","game/map/TileOccupation","game/gameobject/task/move/MoveTask","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyProduceUnit","game/math/Vector2"],function(t,e){"use strict";var i,a,l,c,r,s,h,n,o,u,d,g,p,m,f,y,T,v,b,S;e&&e.id;return{setters:[function(e){i=e},function(e){a=e},function(e){l=e},function(e){c=e},function(e){r=e},function(e){s=e},function(e){h=e},function(e){n=e},function(e){o=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){var e;(e=b=b||{})[e.Idle=0]="Idle",e[e.Delivering=1]="Delivering",t("FactoryStatus",b),S=class{constructor(e,t=!1){this.type=e,this.isCloningVats=t,this.status=b.Idle}[s.NotifySpawn.onSpawn](e,t){this.resetRallyPoint(e,t)}resetRallyPoint(e,t){var i;[l.FactoryType.BuildingType,l.FactoryType.AircraftType].includes(this.type)||(i=this.computeDefaultRallyPoint(e,this.type,t.map),e.rallyTrait?.changeRallyPoint(i,e,t))}[f.NotifyWarpChange.onChange](t,e,i){if(t.owner.production){let e=[];e=this.type===l.FactoryType.BuildingType?[a.QueueType.Structures,a.QueueType.Armory]:[t.owner.production.getQueueTypeForFactory(this.type)];for(var r of e)t.owner.production.getQueue(r).notifyUpdated()}}[i.NotifyTick.onTick](i,r){if(this.status===b.Delivering){if(!this.deliveringUnit||this.deliveringUnit.isDestroyed){if(this.buildingProductionTicks=this.buildingProductionTicks??1,0<this.buildingProductionTicks--)return;this.buildingProductionTicks=void 0}else if(r.map.tileOccupation.isTileOccupiedBy(this.deliveringUnit.tile,i)){if(!this.deliveringUnit.rules.consideredAircraft)return;if(this.deliveringUnit.position.tileElevation<i.art.height)return}return this.status=b.Idle,void(this.deliveringUnit=void 0)}if(i.owner.production&&!i.warpedOutTrait.isActive()){let e=i.owner.production.getPrimaryFactory(this.type);if((e?.warpedOutTrait.isActive()||e===i||e?.factoryTrait?.deliveringUnit&&e.factoryTrait.type===l.FactoryType.UnitType)&&this.type!==l.FactoryType.BuildingType){let e=i.owner.production.getQueueForFactory(this.type);if(e&&e.status===a.QueueStatus.Ready){let t=e.getFirst();if(this.type===l.FactoryType.AircraftType){let e=this.produceAircraftAt(i,t,r);var s;if(!e)for(s of[...i.owner.buildings].filter(e=>e.factoryTrait?.type===l.FactoryType.AircraftType&&e.helipadTrait)){if(e)break;e=this.produceAircraftAt(s,t,r)}if(!e)return}else if(this.produceGroundUnitAt(i,t,r),!this.isCloningVats&&this.type===l.FactoryType.InfantryType){let e=[...i.owner.buildings].find(e=>e.factoryTrait&&e.rules.cloning);e?.factoryTrait.status===b.Idle&&e?.factoryTrait.produceGroundUnitAt(e,t,r)}i.owner.addUnitsBuilt(t.rules.type,1),t.creditsSpent=0,t.progress=0,e.shift(t.rules,1),e.currentSize&&(e.status=a.QueueStatus.Active)}}}}produceGroundUnitAt(e,t,i){let r=i.createUnitForPlayer(t.rules,e.owner);t.rules.trainable&&e.owner.canProduceVeteran(r.rules)&&r.veteranTrait?.setVeteranLevel(y.VeteranLevel.Veteran),r.isInfantry()&&(r.position.subCell=d.Infantry.SUB_CELLS[0]);let s=this.computeInternalRallyPoint(e,this.type,e.rallyTrait.getRallyPoint(),i.map);this.type!==l.FactoryType.UnitType&&(s=e.rallyTrait.findRallyPointforUnit(r,s,i.map,!1,e.tile.z));let a;var n;a=this.type===l.FactoryType.NavalUnitType?s:(n=this.computeExitCoords(e,this.type),i.map.tiles.getByMapCoords(Math.floor(n.rx),Math.floor(n.ry))),r.rules.consideredAircraft&&(s=a);let o;if(e.rallyTrait.getRallyPoint()!==s&&(o=e.rallyTrait.findRallyNodeForUnit(r,i.map)),r.isInfantry()){let t=i.map.tileOccupation.getObjectsOnTileByLayer(o?.tile??s,r.rules.consideredAircraft?g.LayerType.Air:g.LayerType.Ground).filter(e=>e.isInfantry()&&e.moveTrait.moveState!==h.MoveState.Moving).map(e=>e.position.subCell);r.position.subCell=d.Infantry.SUB_CELLS.find(e=>!t.includes(e))??d.Infantry.SUB_CELLS[0]}r.direction=270,i.spawnObject(r,a),i.traits.filter(T.NotifyProduceUnit).forEach(e=>{e[T.NotifyProduceUnit.onProduce](r,i)}),i.events.dispatch(new u.FactoryProduceUnitEvent(r)),r.rules.consideredAircraft?(n=o??{tile:s,onBridge:void 0},r.unitOrderTrait.addTask(new p.MoveTask(i,n.tile,!!n.onBridge,{closeEnoughTiles:i.rules.general.closeEnough}))):r.unitOrderTrait.addTask(new c.ExitFactoryTask(i,e,s,o)),this.status=b.Delivering,this.deliveringUnit=r}produceAircraftAt(e,t,i){let r=e.traits.find(o.DockTrait);if(!r)return!1;var s=r.getFirstAvailableDockNumber();if(void 0===s)return!1;let a=i.createUnitForPlayer(t.rules,e.owner);t.rules.trainable&&e.owner.canProduceVeteran(a.rules)&&a.veteranTrait?.setVeteranLevel(y.VeteranLevel.Veteran);var n=r.getDockOffset(s);return a.position.moveToLeptons(e.position.getMapPosition()),a.position.moveByLeptons3(n),i.spawnObject(a,a.position.tile),r.dockUnitAt(a,s),a.isAircraft()&&a.airportBoundTrait&&(a.airportBoundTrait.preferredAirport=e),i.traits.filter(T.NotifyProduceUnit).forEach(e=>{e[T.NotifyProduceUnit.onProduce](a,i)}),i.events.dispatch(new u.FactoryProduceUnitEvent(a)),!0}computeExitCoords(e,t){if(t===l.FactoryType.InfantryType)return this.computeBarracksDefaultExitCoords(e);if(t===l.FactoryType.UnitType)return this.computeWarFactoryExitCoords(e);throw new Error("Unsupported factory type "+l.FactoryType[t])}computeInternalRallyPoint(e,t,i,r){let s,a;if(t===l.FactoryType.NavalUnitType)a=this.computeNavalInternalRallyPoint(e,i,r);else{if(t===l.FactoryType.InfantryType)s=this.computeBarracksInternalRallyCoords(e);else{if(t!==l.FactoryType.UnitType)throw new Error("Unsupported factory type "+l.FactoryType[t]);s=this.computeWarFactoryInternalRallyCoords(e)}a=r.tiles.getByMapCoords(s.rx,s.ry)}return a??this.findTileAdjacentToBuilding(e,r)}computeDefaultRallyPoint(e,t,i){let r,s;if(t===l.FactoryType.NavalUnitType)s=this.computeNavalDefaultRallyPoint(e,i);else{if(t===l.FactoryType.InfantryType)r=this.computeBarracksInternalRallyCoords(e);else{if(t!==l.FactoryType.UnitType)throw new Error("Unsupported factory type "+l.FactoryType[t]);r=this.computeWarFactoryDefaultRallyCoords(e)}s=i.tiles.getByMapCoords(r.rx,r.ry)}return s??this.findTileAdjacentToBuilding(e,i)}findTileAdjacentToBuilding(e,t){return new m.RadialTileFinder(t.tiles,t.mapBounds,e.tile,e.getFoundation(),1,1,()=>!0).getNextTile()}computeBarracksDefaultExitCoords(e){var t=e.getFoundation();let i,r;return t.width<=2||t.height<=2?(i=t.width-1,r=t.height-1,e.rules.gdiBarracks&&2<t.width&&(i=Math.floor(t.width/2))):(i=0,r=t.height-1),{rx:e.tile.rx+i,ry:e.tile.ry+r}}computeBarracksInternalRallyCoords(e){var t=e.getFoundation();let{rx:i,ry:r}=this.computeBarracksDefaultExitCoords(e);return!(t.width<=2||t.height<=2)||e.rules.gdiBarracks?r+=1:e.rules.nodBarracks&&(i+=t.width<=2?1:0,r+=t.height<=2?1:0),{rx:i,ry:r}}computeWarFactoryExitCoords(e){var t=e.getFoundation();return{rx:e.tile.rx+Math.floor(t.width/2),ry:e.tile.ry+Math.floor(t.height/2)}}computeWarFactoryInternalRallyCoords(e){var t=e.getFoundation();return{rx:e.tile.rx+t.width-1,ry:e.tile.ry+Math.floor(t.height/2)}}computeWarFactoryDefaultRallyCoords(e){var t=e.getFoundation();return{rx:e.tile.rx+t.width,ry:e.tile.ry+Math.floor(t.height/2)}}computeNavalDefaultRallyPoint(e,t){let i=new n.CardinalTileFinder(t.tiles,t.mapBounds,e.centerTile,5,5,e=>e.terrainType===r.TerrainType.Water&&!t.getObjectsOnTile(e).find(e=>e.isBuilding()||e.isOverlay()&&e.isBridge()));return i.diagonal=!1,i.getNextTile()??t.tiles.getByMapCoords(e.tile.rx+e.getFoundation().width,e.tile.ry+e.getFoundation().height)}computeNavalInternalRallyPoint(e,t,i){var r=new v.Vector2(t.rx,t.ry).sub(new v.Vector2(e.centerTile.rx,e.centerTile.ry));return i.tiles.getByMapCoords(e.centerTile.rx+Math.sign(r.x)*(Math.floor(e.getFoundation().width/2)+1),e.centerTile.ry+Math.sign(r.y)*(Math.floor(e.getFoundation().height/2)+1))}},t("FactoryTrait",S)}}}),System.register("game/map/tileFinder/RadialBackFirstTileFinder",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RadialBackFirstTileFinder",i=class{constructor(e,t,i,r,s,a,n,o=!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.foundation=r,this.maxDistance=a,this.predicate=n,this.checkBounds=o,this.distance=s,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var r=(e,t)=>{var i=this.tiles.getByMapCoords(e,t);if(i&&(!this.checkBounds||this.mapBounds.isWithinBounds(i))&&this.predicate(i))return i};do{var s=this.startTile.rx-this.distance,a=this.startTile.ry-this.distance,n=this.startTile.rx+this.foundation.width-1+this.distance,o=this.startTile.ry+this.foundation.height-1+this.distance;let e,t,i;if(0<this.distance){for(t=1+a;t<o;t++)i=r(s,t),i&&(yield i);for(e=s;e<n;e++)i=r(e,a),i&&(yield i);for(t=o-1;t>=a;t--)i=r(n,t),i&&(yield i);for(e=n;e>=s;e--)i=r(e,o),i&&(yield i)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}}),System.register("game/gameobject/trait/FreeUnitTrait",["game/gameobject/trait/interface/NotifySpawn","engine/type/ObjectType","game/map/tileFinder/RadialBackFirstTileFinder"],function(e,t){"use strict";var i,n,o,r;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){o=e}],execute:function(){r=class{[i.NotifySpawn.onSpawn](s,a){if(!s.owner.isNeutral){let e;if(a.rules.hasObject(s.rules.freeUnit,n.ObjectType.Vehicle))e=a.rules.getObject(s.rules.freeUnit,n.ObjectType.Vehicle);else{if(!a.rules.hasObject(s.rules.freeUnit,n.ObjectType.Infantry))return void console.warn(`Free unit "${s.rules.freeUnit}" is not a vehicle or infantry type.`);e=a.rules.getObject(s.rules.freeUnit,n.ObjectType.Infantry)}let i=a.createUnitForPlayer(e,s.owner),r;var t=new o.RadialBackFirstTileFinder(a.map.tiles,a.map.mapBounds,s.tile,s.getFoundation(),1,1,e=>{var t=0<a.map.terrain.getPassableSpeed(e,i.rules.speedType,!1)&&Math.abs(e.z-s.tile.z)<2&&!a.map.terrain.findObstacles({tile:e,onBridge:void 0},i).length;return!r&&t&&(r=e),t&&!a.map.getObjectsOnTile(e).find(e=>e.isOverlay())}).getNextTile()??r;if(!t)return s.owner.removeOwnedObject(i),void i.dispose();a.spawnObject(i,t)}}},e("FreeUnitTrait",r)}}}),System.register("game/gameobject/trait/CabHutTrait",["engine/type/ObjectType","game/map/BridgeOverlayTypes","game/gameobject/task/ScatterTask","game/gameobject/unit/ZoneType","game/gameobject/common/DeathType"],function(e,t){"use strict";var c,h,n,o,s,i;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){n=e},function(e){o=e},function(e){s=e}],execute:function(){e("CabHutTrait",i=class{constructor(e,t){this.gameObject=e,this.bridges=t,this.checkedClosestBridge=!1}canRepairBridge(){var e=this.findClosestBridgeBounds();return e?this.bridges.canBeRepaired(e):(console.warn(`No bridge associated with hut at ${this.gameObject.tile.rx}, ${this.gameObject.tile.ry}.`),!1)}repairBridge(t,i){var r=this.findClosestBridgeBounds();if(!r)throw new Error("No bridge bounds found");var e=this.bridges.findDestroyedPieceTiles(r),s=r.start.rx!==r.end.rx;let a;a=r.isHigh?h.BridgeOverlayTypes.calculateHighBridgeOverlayId(r.type,s):h.BridgeOverlayTypes.calculateLowBridgeOverlayId(r.type,s);var n,o,l=t.rules.getOverlayName(a);for(n of e){let e=t.createObject(c.ObjectType.Overlay,l);e.overlayId=a,e.value=0,e.position.tileElevation=r.isHigh?4:0,t.spawnObject(e,n),this.updateUnitsUnderBridgePiece(n,r,t,i)}for(o of this.bridges.findBridgePieces(r))o.obj.bridgeTrait.bridgeSpec=r}updateUnitsUnderBridgePiece(e,t,i,r){var s;for(let a of this.bridges.getPieceTiles(this.bridges.getPieceAtTile(e)))if(t.isHigh){let e=i.map.getGroundObjectsOnTile(a).filter(e=>e.tile===a&&e.isUnit()&&!e.unitOrderTrait.hasTasks()&&e.rules.tooBigToFitUnderBridge);e.forEach(e=>e.unitOrderTrait.addTask(new n.ScatterTask(i)))}else for(s of i.map.getGroundObjectsOnTile(a))s.isUnit()&&(i.map.terrain.getPassableSpeed(a,s.rules.speedType,!0)?(s.zone=o.ZoneType.Ground,s.onBridge=!0):s.isDestroyed||i.destroyObject(s,{player:r}))}demolishBridge(e,t){var i=this.getBridgePieces();if(i)for(var r of i)r.obj.isLowBridge()&&e.map.getTileZone(r.obj.tile,!0)!==o.ZoneType.Water||r.obj.isDestroyed||(r.obj.deathType=s.DeathType.Demolish,e.destroyObject(r.obj,t,!0))}getBridgePieces(){var e=this.findClosestBridgeBounds();if(e)return this.bridges.findBridgePieces(e)}findClosestBridgeBounds(){return this.checkedClosestBridge||(this.checkedClosestBridge=!0,this.closestBridge=this.bridges.findClosestBridgeSpec(this.gameObject.tile)),this.closestBridge}dispose(){this.gameObject=void 0}})}}}),System.register("game/gameobject/trait/OilDerrickTrait",["game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class{constructor(){this.isActive=!1,this.produceCashCooldown=0}[s.NotifySpawn.onSpawn](e){e.owner.isNeutral||(this.isActive=!0)}[i.NotifyOwnerChange.onChange](e,t){t.isNeutral&&!e.owner.isNeutral&&(e.owner.credits=Math.max(0,e.owner.credits+e.rules.produceCashStartup),this.isActive=!0,this.produceCashCooldown=e.rules.produceCashDelay)}[r.NotifyTick.onTick](e){this.isActive&&(this.produceCashCooldown--,this.produceCashCooldown<=0&&(this.produceCashCooldown=e.rules.produceCashDelay,e.owner.credits=Math.max(0,e.owner.credits+e.rules.produceCashAmount)))}},e("OilDerrickTrait",a)}}}),System.register("game/gameobject/trait/OverpoweredTrait",["game/gameobject/task/AttackTask","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(e){this.obj=e,this.chargers=new Set}isOverpowered(){let e=1;return this.obj?.poweredTrait?.isPoweredOn(!0)||(e+=2),this.chargers.size>=e}hasChargersToPowerOn(){return 2<=this.chargers.size}chargeFrom(e){this.chargers.add(e),this.swapAttackTaskWeapon()}[r.NotifyTick.onTick](i){if(0<this.chargers.size){let t=!1;this.chargers.forEach(e=>{(e.isDestroyed||e.isCrashing||e.owner!==i.owner||e.attackTrait?.currentTarget?.obj!==i)&&(this.chargers.delete(e),t=!0)}),t&&this.swapAttackTaskWeapon()}}swapAttackTaskWeapon(){let e=this.obj?.unitOrderTrait.getCurrentTask();var t;e instanceof i.AttackTask&&((t=this.getWeapon())?e.setWeapon(t):e.cancel())}getWeapon(){return this.isOverpowered()?this.obj?.secondaryWeapon:this.obj?.primaryWeapon}dispose(){this.obj=void 0,this.chargers.clear()}},e("OverpoweredTrait",s)}}}),System.register("game/event/UnitRepairFinishEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("UnitRepairFinishEvent",r=class{constructor(e,t){this.target=e,this.from=t,this.type=i.EventType.UnitRepairFinish}})}}}),System.register("game/event/UnitRepairStartEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("UnitRepairStartEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.UnitRepairStart}})}}}),System.register("game/gameobject/trait/UnitRepairTrait",["game/event/UnitRepairFinishEvent","game/event/UnitRepairStartEvent","game/GameSpeed","game/math/Vector2","game/gameobject/task/move/MoveTask","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],function(t,e){"use strict";var n,o,l,r,c,h,i,s,u,a;e&&e.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){r=e},function(e){c=e},function(e){h=e},function(e){i=e},function(e){s=e}],execute:function(){var e;(e=u=u||{})[e.Idle=0]="Idle",e[e.Repairing=1]="Repairing",t("RepairStatus",u),a=class{constructor(){this.status=u.Idle,this.cooldownTicks=0,this.lastRepairTickSuccessful=!1}[i.NotifySpawn.onSpawn](e,t){this.resetRallyPoint(e,t)}resetRallyPoint(e,t){var i;e.factoryTrait||(i=this.computeDefaultRallyPoint(e,t.map),e.rallyTrait.changeRallyPoint(i,e,t))}[s.NotifyTick.onTick](t,i){if(t.dockTrait&&(!t.rules.needsEngineer||!t.owner.isNeutral))if(!t.dockTrait.hasDockedUnits()||t.dockTrait.getDockedUnits().some(e=>e.zone===h.ZoneType.Air)||t.poweredTrait&&!t.poweredTrait.isPoweredOn())this.status=u.Idle;else if(this.cooldownTicks<=0){var r,s,a=i.rules.general.repair,a=t.rules.unitReload?a.reloadRate:a.uRepairRate;this.cooldownTicks+=l.GameSpeed.BASE_TICKS_PER_SECOND*a*60;let e=!1;for(r of t.dockTrait.getDockedUnits())r.zone!==h.ZoneType.Air&&(r.healthTrait.health<100&&i.areFriendly(r,t)?(this.tickRepair(r,i,t)&&(e=!0),!e||this.status!==u.Idle&&this.lastRepairTickSuccessful||t.helipadTrait||i.events.dispatch(new o.UnitRepairStartEvent(r))):((s=t.rallyTrait.findRallyNodeForUnit(r,i.map))&&(t.dockTrait.undockUnit(r),r.unitOrderTrait.addTask(new c.MoveTask(i,s.tile,!!s.onBridge,{closeEnoughTiles:i.rules.general.closeEnough}))),t.helipadTrait||i.events.dispatch(new n.UnitRepairFinishEvent(r,t))));this.lastRepairTickSuccessful=e,this.status=e?u.Repairing:u.Idle}else this.cooldownTicks--}tickRepair(e,t,i){var r=t.rules.general.repair,s=Math.floor(r.repairStep),a=r.repairPercent;let n;if(a){r=a*e.purchaseValue/e.healthTrait.maxHitPoints,a=Math.min(i.owner.credits,Math.max(1,Math.floor(r*s)));if(n=r&&a?Math.floor(a/r):s,!a)return!1;i.owner.credits-=a}else n=s;return n=Math.min(n,e.healthTrait.maxHitPoints-e.healthTrait.getHitPoints()),!!n&&(e.healthTrait.healBy(n,i,t),!0)}computeDefaultRallyPoint(e,t){var i=e.getFoundation(),i=new r.Vector2(e.tile.rx,e.tile.ry+i.height);return t.tiles.getByMapCoords(i.x,i.y)??e.tile}},t("UnitRepairTrait",a)}}}),System.register("game/gameobject/trait/RallyTrait",["engine/type/TerrainType","game/map/tileFinder/RadialTileFinder","game/rules/TechnoRules","game/type/MovementZone","game/type/SpeedType"],function(e,t){"use strict";var l,c,h,u,d,i;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("RallyTrait",i=class{getRallyPoint(){return this.rallyPoint}changeRallyPoint(e,t,i){var r=this.findValidRallyPoint(t,e,i.map);r&&(this.rallyPoint=r)}findValidRallyPoint(i,e,r){let t=new c.RadialTileFinder(r.tiles,r.mapBounds,e,{width:1,height:1},0,20,e=>i.rules.naval===(e.terrainType===l.TerrainType.Water)&&!r.tileOccupation.isTileOccupiedBy(e,i)),s=t.getNextTile();if(!s&&i.factoryTrait?.type===h.FactoryType.NavalUnitType){var{width:a,height:n}=i.getFoundation();for(let t=0;t<a;t++)for(let e=0;e<n;e++){var o=r.tiles.getByMapCoords(i.tile.rx+t,i.tile.ry+e);if(!o)break;if(0<r.terrain.getPassableSpeed(o,d.SpeedType.Float,!1)){s=o;break}}}return s}findRallyNodeForUnit(e,t){if(this.rallyPoint){var i=this.findRallyPointforUnit(e,this.rallyPoint,t,!0);return{tile:i,onBridge:e.rules.naval?void 0:t.tileOccupation.getBridgeOnTile(i)}}}findRallyPointforUnit(i,e,r,s,a){let n=i.rules.naval?void 0:r.tileOccupation.getBridgeOnTile(e),o=i.rules.movementZone===u.MovementZone.Fly,t=new c.RadialTileFinder(r.tiles,r.mapBounds,e,{width:1,height:1},0,5,e=>{var t=!n||n.isHighBridge()?r.tileOccupation.getBridgeOnTile(e):void 0;return!(o?[]:r.terrain.findObstacles({tile:e,onBridge:t},i)).length&&(void 0===a||Math.abs(a-(e.z+(t?.tileElevation??0)))<4)&&(!s||!r.getObjectsOnTile(e).find(e=>e.isBuilding()&&!e.isDestroyed))&&(o||0<r.terrain.getPassableSpeed(e,i.rules.speedType,!!t))});return t.getNextTile()??e}})}}}),System.register("game/gameobject/unit/Timer",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Timer",i=class{constructor(){this.activeTicks=0}isActive(){return 0<this.activeTicks}setActiveFor(e,t){this.activeTicks=e,this.activeFor=e,this.activeSince=t}reset(){this.activeTicks=0,this.activeSince=void 0,this.activeFor=void 0}getTicksLeft(){return this.activeTicks}getInitialTicks(){return this.activeFor??0}tick(e){return 0<this.activeTicks&&(this.activeTicks--,this.activeTicks<=0||void 0!==this.activeSince&&e-this.activeSince>this.activeFor)&&(this.reset(),!0)}})}}}),System.register("game/gameobject/trait/C4ChargeTrait",["game/gameobject/common/DeathType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class{constructor(){this.timer=new r.Timer}hasCharge(){return this.timer.isActive()}setCharge(e,t){this.hasCharge()||(this.timer.setActiveFor(e),this.attackerInfo=t)}[s.NotifyTick.onTick](e,t){this.timer.isActive()&&!0===this.timer.tick(t.currentTick)&&(e.invulnerableTrait.isActive()||(e.isBuilding()&&e.cabHutTrait?e.cabHutTrait.demolishBridge(t,this.attackerInfo):(e.deathType=i.DeathType.Demolish,t.destroyObject(e,this.attackerInfo,!0))))}},e("C4ChargeTrait",a)}}}),System.register("game/gameobject/trait/HelipadTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyUnspawn"],function(e,t){"use strict";var s,i,r,a;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e}],execute:function(){a=class{[i.NotifyOwnerChange.onChange](e,t,i){this.checkAircraftsForPlayer(t,i)}[r.NotifyUnspawn.onUnspawn](e,t){this.checkAircraftsForPlayer(e.owner,t)}checkAircraftsForPlayer(e,t){let i=t.rules.general.padAircraft;var r;for(r of e.getOwnedObjectsByType(s.ObjectType.Aircraft).filter(e=>i.includes(e.name)))r.airportBoundTrait&&(r.airportBoundTrait.preferredAirport=void 0)}},e("HelipadTrait",a)}}}),System.register("game/gameobject/trait/AmmoTrait",["util/math"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("AmmoTrait",r=class{constructor(e,t=e){this.maxAmmo=e,this.ammo=t}get ammo(){return this._ammo}set ammo(e){this._ammo=i.clamp(e,0,this.maxAmmo)}isFull(){return this.ammo===this.maxAmmo}})}}}),System.register("game/gameobject/trait/UnitReloadTrait",["game/GameSpeed","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var s,i,r,a;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e}],execute:function(){a=class{[r.NotifyTick.onTick](t,i){if(t.dockTrait&&t.dockTrait.hasDockedUnits()&&!t.dockTrait.getDockedUnits().every(e=>!this.canReloadUnit(e)))if(void 0===this.cooldownTicks&&(this.cooldownTicks=s.GameSpeed.BASE_TICKS_PER_SECOND*i.rules.general.repair.reloadRate*60),this.cooldownTicks<=0){this.cooldownTicks=s.GameSpeed.BASE_TICKS_PER_SECOND*i.rules.general.repair.reloadRate*60;let e=t.dockTrait.getDockedUnits();var r;for(r of 0===e[0].ammo?e.slice(0,1):e)this.canReloadUnit(r)&&r.ammoTrait.ammo++}else this.cooldownTicks--}canReloadUnit(e){return!(!e.ammoTrait||!e.rules.manualReload||e.ammoTrait.isFull()||e.zone===i.ZoneType.Air)}},e("UnitReloadTrait",a)}}}),System.register("game/gameobject/task/WaitForBuildUpTask",["game/gameobject/Building","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/task/system/WaitMinutesTask"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends s.TaskGroup{constructor(e){super(new a.WaitMinutesTask(e),new r.CallbackTask(e=>e.buildStatus=i.BuildStatus.Ready)),this.cancellable=!1}},e("WaitForBuildUpTask",n)}}}),System.register("game/gameobject/trait/SuperWeaponTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn"],function(e,t){"use strict";var r,i,s,a,n;t&&t.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e}],execute:function(){n=class{constructor(e){this.name=e}getSuperWeapon(e){return e.owner.superWeaponsTrait?.get(this.name)}[s.NotifySpawn.onSpawn](e,t){this.addSuperWeaponToPlayerIfNeeded(e.owner,t)}[a.NotifyUnspawn.onUnspawn](e,t){this.removeSuperWeaponFromPlayerIfNeeded(e.owner)}[i.NotifyOwnerChange.onChange](e,t,i){this.removeSuperWeaponFromPlayerIfNeeded(t),this.addSuperWeaponToPlayerIfNeeded(e.owner,i)}addSuperWeaponToPlayerIfNeeded(t,i){if(t.superWeaponsTrait&&!t.superWeaponsTrait.has(this.name)){let e=i.createSuperWeapon(this.name,t);t.superWeaponsTrait.add(e),e.rules.isPowered&&t.powerTrait?.isLowPower()&&e.pauseTimer()}}removeSuperWeaponFromPlayerIfNeeded(e){let t=e.superWeaponsTrait;var i;t&&(e.getOwnedObjectsByType(r.ObjectType.Building).some(e=>e.superWeaponTrait?.name===this.name)||(i=t.get(this.name))&&!i.isGift&&t.remove(this.name))}},e("SuperWeaponTrait",n)}}}),System.register("game/map/MapShroud",["util/event","game/GameSpeed","engine/type/TerrainType","util/math"],function(t,e){"use strict";var i,r,a,v,s,n,o,b,S,l,c,h;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){a=e},function(e){v=e}],execute:function(){var e;s=5,o=4.25,S=(1<<(b=n=3))-1,(e=l=l||{})[e.Unexplored=0]="Unexplored",e[e.TemporaryReveal=1]="TemporaryReveal",e[e.Explored=2]="Explored",t("ShroudType",l),c=c||{},c[c.Darken=1<<b]="Darken",t("ShroudFlag",c),t("MapShroud",h=class h{constructor(){this.invalidations=new Map,this.temporaryReveals=new Map,this.fullInvalidation=!1,this._onChange=new i.EventDispatcher}get onChange(){return this._onChange.asEvent()}fromTiles(e){var t,i=e.getMapSize(),r=e.getMaxTileHeight(),r=this.padding=(r+r%2)/2;this.size={width:i.width+r,height:i.height+r},this.tiles=new Uint8Array(this.size.width*this.size.height),this.tiles.fill(l.Unexplored),this.tileElevation=new Uint8Array(this.size.width*this.size.height);for(t of e.getAll()){var s=this.getTileIndex(t);this.tileElevation[s]=Math.max(this.tileElevation[s],t.terrainType===a.TerrainType.Cliff&&0<t.z?t.z-1:t.z)}return this}getSize(){return this.size}getTileIndex(e){var{sx:t,sy:i}=this.rxyzToSxy(e.rx,e.ry,e.z);return t+i*this.size.width}rxyzToSxy(e,t,i){var r=(i|=0)+i%2;return{sx:e-r/2+this.padding,sy:t-r/2+this.padding}}sxyzToRxy(e,t,i){return{rx:e+Math.ceil(i/2)-this.padding,ry:t+Math.ceil(i/2)-this.padding}}shroudCoordsToWorld({sx:e,sy:t}){return this.sxyzToRxy(e,t,0)}findTilesAtShroudCoords({sx:e,sy:t},i){var r=i.getMaxTileHeight(),s=r+r%2;let a=[];for(let l=0;l<=s;l+=2){var n=l+l%2,{rx:o,ry:n}=this.sxyzToRxy(e,t,n),n=i.getByMapCoords(o,n);n?.z===l&&a.push(n)}return a}clone(){let e=new h;return e.tiles=this.tiles.slice(),e.size=this.size,e.padding=this.padding,e.tileElevation=this.tileElevation,e}copy(e){this.tiles=e.tiles.slice(),this.size=e.size,this.padding=e.padding,this.tileElevation=e.tileElevation}merge(e){if(this.size.width!==e.size.width||this.size.height!==e.size.height)throw new Error("Size mismatch");var t=e.tiles;for(let i=0,r=this.tiles.length;i<r;i++)this.tiles[i]=Math.max(t[i]&S,this.tiles[i]&S)|(t[i]|this.tiles[i])>>b<<b}isShrouded(e,t=0){var i=this.rxyzToSxy(e.rx,e.ry,e.z+t);return this.getShroudTypeByShroudCoords(i)===l.Unexplored}getShroudType(e){return this.tiles[this.getTileIndex(e)]&S}isFlagged(e,t){return 0!=(this.tiles[this.getTileIndex(e)]&t)}getShroudTypeByTileCoords(e,t,i){return this.getShroudTypeByShroudCoords(this.rxyzToSxy(e,t,i))}getShroudTypeByShroudCoords({sx:e,sy:t}){return e<0||t<0||e>=this.size.width||t>=this.size.height?l.Unexplored:this.tiles[e+t*this.size.width]&S??l.Unexplored}invalidateFull(){this.fullInvalidation=!0}invalidate(e,t,i){var r=e.sx+e.sy*this.size.width;let s=this.invalidations.get(r);s||(s={center:e,elevation:0,radius:0},this.invalidations.set(r,s)),s.elevation=Math.max(s.elevation,t),s.radius=Math.max(s.radius,i)}revealFrom(e){var t,i,r=e.sight;r&&(t=e.tile.z+e.tileElevation,i=this.rxyzToSxy(e.tile.rx,e.tile.ry,t),this.invalidate(i,t,r))}revealAround(e,t){var i=this.rxyzToSxy(e.rx,e.ry,e.z);this.invalidate(i,Number.POSITIVE_INFINITY,t)}unrevealAround(e,t){var i=[],r=this.rxyzToSxy(e.rx,e.ry,e.z);this.setValueAround(r,t,Number.POSITIVE_INFINITY,i,l.Unexplored,l.Explored),this._onChange.dispatch(this,{type:"incremental",coords:i})}revealTemporarily(e){var t=this.rxyzToSxy(e.tile.rx,e.tile.ry,e.tile.z+e.tileElevation);this.temporaryReveals.set(t,s*r.GameSpeed.BASE_TICKS_PER_SECOND)}revealObject(e){var t=this.rxyzToSxy(e.tile.rx,e.tile.ry,e.tile.z+e.tileElevation);this.invalidate(t,Number.POSITIVE_INFINITY,o)}toggleFlagsAround(e,t,i,r){var s=[],a=this.rxyzToSxy(e.rx,e.ry,e.z);this.setValueAround(a,t,Number.POSITIVE_INFINITY,s,void 0,void 0,r?{setFlags:i}:{clearFlags:i}),this._onChange.dispatch(this,{type:"incremental",coords:s})}update(){let i=[];if(this.invalidations.size){for(var e of this.invalidations.values())this.setValueAround(e.center,e.radius,e.elevation,i,l.Explored,[l.Unexplored,l.TemporaryReveal]);this.invalidations.clear()}this.temporaryReveals.size&&this.temporaryReveals.forEach((e,t)=>{e<=0?(this.setValueAround(t,n,Number.POSITIVE_INFINITY,i,l.Unexplored,l.TemporaryReveal),this.temporaryReveals.delete(t)):(e===s*r.GameSpeed.BASE_TICKS_PER_SECOND&&this.setValueAround(t,n,Number.POSITIVE_INFINITY,i,l.TemporaryReveal,l.Unexplored),this.temporaryReveals.set(t,e-1))}),this.fullInvalidation?(this.fullInvalidation=!1,this._onChange.dispatch(this,{type:"full"})):i.length&&this._onChange.dispatch(this,{type:"incremental",coords:i})}setValueAround(i,r,s,a,n,o=void 0,{setFlags:l,clearFlags:c}={}){var e=Math.ceil(r),h=v.clamp(i.sx-e,0,this.size.width-1),u=v.clamp(i.sx+e,0,this.size.width-1),d=v.clamp(i.sy-e,0,this.size.height-1),g=v.clamp(i.sy+e,0,this.size.height-1),p=this.size.width;for(let T=h;T<=u;T++)for(let t=d;t<=g;t++){var m=T+t*p,f=this.tiles[m]&S,y=this.tiles[m]>>b<<b;let e=y;void 0!==l&&(e|=l),void 0!==c&&(e&=~c),void 0!==o&&("number"!=typeof o?!o.includes(f):o!==f)||((T-i.sx)*(T-i.sx)+(t-i.sy)*(t-i.sy)>r*r+1||this.tileElevation[m]>=s+4||(this.tiles[m]=(n??f)|e,f===n&&y===e||a.push({sx:T,sy:t})))}}revealAll(){this.tiles.fill(l.Explored),this._onChange.dispatch(this,{type:"clear"})}reset(){this.tiles.fill(l.Unexplored),this._onChange.dispatch(this,{type:"cover"})}})}}}),System.register("game/gameobject/trait/GapGeneratorTrait",["game/GameSpeed","game/map/MapShroud","game/math/Box2","game/math/Vector2","game/rules/TechnoRules","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange"],function(e,t){"use strict";var c,l,h,u,d,g,i,r,s,a,n,o;t&&t.id;return{setters:[function(e){c=e},function(e){l=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class{constructor(e){this.radiusTiles=e,this.refreshTicks=0}[s.NotifyTick.onTick](e,t){0<this.refreshTicks&&this.refreshTicks--,this.refreshTicks<=0&&this.update(e,t)}[r.NotifySpawn.onSpawn](e,t){this.markGapTilesForFriendlies(e,e.owner,t,!0)}[a.NotifyUnspawn.onUnspawn](e,t){this.markGapTilesForFriendlies(e,e.owner,t,!1),this.update(e,t)}[i.NotifyOwnerChange.onChange](e,t,i){this.markGapTilesForFriendlies(e,t,i,!1),this.markGapTilesForFriendlies(e,e.owner,i,!0),this.update(e,i)}[n.NotifyWarpChange.onChange](e,t,i){this.markGapTilesForFriendlies(e,e.owner,t,!i),i&&this.update(e,t)}markGapTilesForFriendlies(i,e,r,t){let s=[e,...r.alliances.getAllies(e)],a;for(var n of s){let e=r.mapShroudTrait.getPlayerShroud(n);if(e&&(e.toggleFlagsAround(i.tile,this.radiusTiles,l.ShroudFlag.Darken,t),!t)){if(!a){let t=new g.RangeHelper(r.map.tileOccupation);a=s.map(e=>[...e.buildings]).flat().filter(e=>e.gapGeneratorTrait&&e!==i&&t.tileDistance(e,i)<=e.gapGeneratorTrait.radiusTiles+this.radiusTiles)}for(var o of a)e.toggleFlagsAround(o.tile,o.gapGeneratorTrait.radiusTiles,l.ShroudFlag.Darken,!0)}}}update(t,i){this.refreshTicks=5*c.GameSpeed.BASE_TICKS_PER_SECOND;let r;var s,a,n,o,l=t.owner.buildings.has(t)&&t.poweredTrait?.isPoweredOn();for(s of i.getCombatants())if(s!==t.owner&&!i.alliances.areAllied(t.owner,s)){let e=i.mapShroudTrait.getPlayerShroud(s);if(e)if(l){e.unrevealAround(t.tile,this.radiusTiles),r||(n=this.radiusTiles+d.TechnoRules.MAX_SIGHT,a=new u.Vector2(t.tile.rx,t.tile.ry).addScalar(-n),n=new u.Vector2(t.tile.rx,t.tile.ry).addScalar(n),r=i.map.technosByTile.queryRange(new h.Box2(a,n)));for(o of r)o.owner===s||i.alliances.areAllied(o.owner,s)?e.revealFrom(o):o.rules.revealToAll&&e.revealObject(o)}else[...s.buildings].some(e=>e.rules.spySat)&&e.revealAround(t.tile,this.radiusTiles)}}},e("GapGeneratorTrait",o)}}}),System.register("game/gameobject/trait/PsychicDetectorTrait",["game/Coords","game/GameSpeed","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyWarpChange"],function(e,t){"use strict";var h,i,u,r,s,a,n;t&&t.id;return{setters:[function(e){h=e},function(e){i=e},function(e){u=e},function(e){r=e},function(e){s=e}],execute:function(){a=i.GameSpeed.BASE_TICKS_PER_SECOND,n=class{constructor(e){this.radiusTiles=e,this.detectionLines=[],this.nextScan=a}[r.NotifyTick.onTick](e,t){e.owner.powerTrait?.isLowPower()?this.disable():(0<this.nextScan&&this.nextScan--,this.nextScan<=0&&(this.nextScan=a,this.detectionLines=this.scan(e,t)))}[s.NotifyWarpChange.onChange](e,t,i){i&&this.disable()}disable(){this.detectionLines.length&&(this.detectionLines=[],this.nextScan=0)}scan(t,i){var e=i.getCombatants().filter(e=>e!==t.owner&&!i.alliances.areAllied(e,t.owner));let r=[],s=new u.RangeHelper(i.map.tileOccupation);var a,n,o,l=e=>s.distance2(e,t)/h.Coords.LEPTONS_PER_TILE<=this.radiusTiles;for(a of e)for(var c of a.getOwnedObjects())c.attackTrait?.currentTarget?l((n=c.attackTrait.currentTarget).obj??n.tile)&&r.push({source:c,target:n}):c.isUnit()&&c.unitOrderTrait.targetLinesConfig&&((o=c.unitOrderTrait.targetLinesConfig).target?l(o.target)&&(n=i.createTarget(o.target,o.target.tile),r.push({source:c,target:n})):(o=o.pathNodes[0])&&l(o.tile)&&(o=i.createTarget(o.onBridge,o.tile),r.push({source:c,target:o})));return r}},e("PsychicDetectorTrait",n)}}}),System.register("game/gameobject/trait/HospitalTrait",["engine/type/ObjectType","game/event/UnitRepairFinishEvent","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/ScatterTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a,n,o,l,c;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=class{constructor(){this.healQueue=[]}addToHealQueue(e){return this.healQueue.push(e),this.healQueue.length-1}unitIsFirstInHealQueue(e){return this.healQueue[0]===e}removeFromHealQueue(e){var t=this.healQueue.indexOf(e);-1!==t&&this.healQueue.splice(t,1)}startHealing(e){if(this.unit)throw new Error(`Already busy healing unit ${i.ObjectType[this.unit.type]}#${this.unit.id}}`);this.unit=e,this.healTicks=5*s.GameSpeed.BASE_TICKS_PER_SECOND}[l.NotifyTick.onTick](e,t){var i;this.healQueue=this.healQueue.filter(e=>!e.isDestroyed&&!e.isCrashing),this.unit&&void 0!==this.healTicks&&(0<this.healTicks&&this.healTicks--,this.healTicks<=0&&(this.healTicks=void 0,this.removeFromHealQueue(this.unit),this.unit.healthTrait.healToFull(e,t),e.ammoTrait&&e.ammoTrait.ammo--,this.evacuate(this.unit,e,t),i=this.unit,this.unit=void 0,t.events.dispatch(new r.UnitRepairFinishEvent(i,e))))}[o.NotifyDestroy.onDestroy](e,t,i){this.unit&&(t.destroyObject(this.unit,i,!0),this.unit=void 0)}evacuate(t,i,r){let e;var s={x:i.tile.rx,y:i.tile.ry+i.art.foundation.height},s=r.map.tiles.getByMapCoords(s.x,s.y);s&&r.map.isWithinBounds(s)&&this.canEvacuateTo(s,t,i,r)&&(e=s),e=e||new a.RadialTileFinder(r.map.tiles,r.map.mapBounds,i.tile,i.art.foundation,1,1,e=>this.canEvacuateTo(e,t,i,r)).getNextTile(),e?(r.unlimboObject(t,e),t.unitOrderTrait.addTask(new n.ScatterTask(r))):r.destroyObject(t,{player:t.owner})}canEvacuateTo(e,t,i,r){return 0<r.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&Math.abs(e.z-i.tile.z)<2&&!r.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length}},e("HospitalTrait",c)}}}),System.register("game/gameobject/Building",["engine/type/ObjectType","game/gameobject/trait/GarrisonTrait","game/gameobject/trait/TurretTrait","game/rules/TechnoRules","game/event/BuildStatusChangeEvent","game/gameobject/trait/PoweredTrait","game/gameobject/trait/FactoryTrait","game/gameobject/trait/DockTrait","game/gameobject/trait/FreeUnitTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/CabHutTrait","game/gameobject/trait/OilDerrickTrait","game/gameobject/trait/WallTrait","game/Coords","game/gameobject/trait/OverpoweredTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/trait/RallyTrait","game/gameobject/trait/C4ChargeTrait","game/gameobject/trait/HelipadTrait","game/gameobject/trait/UnitReloadTrait","game/gameobject/task/WaitForBuildUpTask","game/gameobject/trait/SuperWeaponTrait","game/gameobject/trait/GapGeneratorTrait","game/gameobject/trait/PsychicDetectorTrait","game/gameobject/trait/HospitalTrait","game/math/Vector2"],function(t,e){"use strict";var r,o,l,c,i,h,u,d,g,s,p,m,f,y,a,T,v,b,S,w,C,n,E,x,O,A,M,R,P;e&&e.id;return{setters:[function(e){r=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){i=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){s=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){a=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){n=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e}],execute:function(){var e;(e=R=R||{})[e.BuildUp=0]="BuildUp",e[e.Ready=1]="Ready",e[e.BuildDown=2]="BuildDown",t("BuildStatus",R),P=class extends s.Techno{constructor(e,t,i){super(r.ObjectType.Building,e,t,i),this.showWeaponRange=!1,this.wallType=[0,0,0,0],this.direction=0,this.buildStatus=R.BuildUp,this.lastBuildStatus=this.buildStatus}static factory(e,t,i,r,s,a){let n=new this(e,t,r);return t.canBeOccupied&&(n.garrisonTrait=new o.GarrisonTrait(n,i.audioVisual.conditionRed,t.maxNumberOccupants),n.traits.add(n.garrisonTrait)),t.canC4&&!t.wall&&(n.c4ChargeTrait=new S.C4ChargeTrait,n.traits.add(n.c4ChargeTrait)),t.bridgeRepairHut&&(n.cabHutTrait=new m.CabHutTrait(n,a),n.traits.add(n.cabHutTrait)),t.crewed&&(n.crewedTrait=new p.CrewedTrait,n.traits.add(n.crewedTrait)),t.turret&&(n.turretTrait=new l.TurretTrait,n.traits.add(n.turretTrait)),t.overpowerable&&(n.overpoweredTrait=new T.OverpoweredTrait(n),n.traits.add(n.overpoweredTrait)),(t.powered&&0!==t.power||t.needsEngineer)&&(n.poweredTrait=new h.PoweredTrait(n),n.traits.add(n.poweredTrait)),(t.factory||t.cloning)&&(n.factoryTrait=new u.FactoryTrait(t.cloning?c.FactoryType.InfantryType:t.factory,t.cloning),n.traits.add(n.factoryTrait)),t.superWeapon&&(n.superWeaponTrait=new E.SuperWeaponTrait(t.superWeapon),n.traits.add(n.superWeaponTrait)),t.numberOfDocks&&(n.dockTrait=new d.DockTrait(n,s,t.numberOfDocks,r.dockingOffsets),n.traits.add(n.dockTrait),t.helipad&&(n.helipadTrait=new w.HelipadTrait,n.traits.add(n.helipadTrait)),(t.unitRepair||t.unitReload)&&(n.unitRepairTrait=new v.UnitRepairTrait,n.traits.add(n.unitRepairTrait)),t.unitReload&&(n.unitReloadTrait=new C.UnitReloadTrait,n.traits.add(n.unitReloadTrait))),t.hospital&&(n.hospitalTrait=new A.HospitalTrait,n.traits.add(n.hospitalTrait)),(t.factory||t.cloning||t.numberOfDocks)&&(n.rallyTrait=new b.RallyTrait,n.traits.add(n.rallyTrait)),t.freeUnit&&n.traits.add(new g.FreeUnitTrait),t.produceCashStartup&&n.traits.add(new f.OilDerrickTrait),t.wall&&(n.wallTrait=new y.WallTrait,n.traits.add(n.wallTrait)),t.gapGenerator&&(n.gapGeneratorTrait=new x.GapGeneratorTrait(t.gapRadiusInCells),n.traits.add(n.gapGeneratorTrait)),t.psychicDetectionRadius&&(n.psychicDetectorTrait=new O.PsychicDetectorTrait(t.psychicDetectionRadius),n.traits.add(n.psychicDetectorTrait)),n}isBuilding(){return!0}getFoundation(){return this.art.foundation}getFoundationCenterOffset(){var e=this.getFoundation();return new M.Vector2(e.width/2*a.Coords.LEPTONS_PER_TILE,e.height/2*a.Coords.LEPTONS_PER_TILE)}update(e){this.buildStatus!==R.BuildUp||this.unitOrderTrait.hasTasks()||this.unitOrderTrait.addTask(new n.WaitForBuildUpTask(e.rules.general.buildupTime)),this.buildStatus!==this.lastBuildStatus&&(this.lastBuildStatus=this.buildStatus,e.events.dispatch(new i.BuildStatusChangeEvent(this,this.buildStatus))),this.attackTrait?.setDisabled(this.buildStatus!==R.Ready||!!this.poweredTrait&&!this.poweredTrait.isPoweredOn()),super.update(e)}},t("Building",P)}}}),System.register("util/disposable/Disposable",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/Traits",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Traits",i=class{constructor(){this.allTraits=[],this.traitsByTypeCache=new Map}add(e){this.allTraits.push(e),this.traitsByTypeCache.clear()}addToFront(e){this.allTraits.unshift(e),this.traitsByTypeCache.clear()}remove(e){var t=this.allTraits.indexOf(e);-1!==t&&(this.allTraits.splice(t,1),this.traitsByTypeCache.clear())}filter(t){let e=this.traitsByTypeCache.get(t);return e||(e="function"==typeof t?this.allTraits.filter(e=>e instanceof t):this.allTraits.filter(e=>this.traitImplements(e,t)),this.traitsByTypeCache.set(t,e)),e}get(e){var t=this.find(e);if(!t)throw new Error("No matching trait found");return t}find(e){return this.filter(e)[0]}getAll(){return this.allTraits}traitImplements(e,t){for(var i of Object.getOwnPropertyNames(t))if(void 0===e[t[i]])return!1;return!0}clear(){this.allTraits.length=0,this.traitsByTypeCache.clear()}dispose(){this.getAll().forEach(e=>e.dispose?.()),this.clear()}})}}}),System.register("game/player/trait/RadarTrait",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RadarTrait",i=class{constructor(){this.disabled=!0,this.activeEvents=[]}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}})}}}),System.register("game/player/production/Production",["game/player/production/ProductionQueue","game/rules/TechnoRules","engine/type/ObjectType","util/event","game/rules/GeneralRules","game/SideType"],function(e,t){"use strict";var n,r,i,a,s,o,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){r=e},function(e){i=e},function(e){a=e},function(e){s=e},function(e){o=e}],execute:function(){l=(new Map).set("POWER",s.PrereqCategory.Power).set("FACTORY",s.PrereqCategory.Factory).set("BARRACKS",s.PrereqCategory.Barracks).set("RADAR",s.PrereqCategory.Radar).set("TECH",s.PrereqCategory.Tech).set("PROC",s.PrereqCategory.Proc),e("Production",c=class c{constructor(e,t,i,r,s){this.player=e,this.maxTechLevel=t,this.gameOpts=i,this.rules=r,this.allAvailableObjects=s,this.buildSpeedModifier=1,this.queues=new Map,this._onQueueUpdate=new a.EventDispatcher,this.primaryFactories=new Map,this.factoryCounts=new Map,this.veteranTypes=new Set,this.stolenTech=new Set}static factory(e,t,i,r){let s=new c(e,t.mpDialogSettings.techLevel,i,t,r);var a=t.general.maximumQueuedObjects+1;return s.addQueue(n.QueueType.Structures,new n.ProductionQueue(n.QueueType.Structures,1,1)),s.addQueue(n.QueueType.Armory,new n.ProductionQueue(n.QueueType.Armory,1,1)),s.addQueue(n.QueueType.Infantry,new n.ProductionQueue(n.QueueType.Infantry,a,a)),s.addQueue(n.QueueType.Vehicles,new n.ProductionQueue(n.QueueType.Vehicles,a,a)),s.addQueue(n.QueueType.Ships,new n.ProductionQueue(n.QueueType.Ships,a,a)),s.addQueue(n.QueueType.Aircrafts,new n.ProductionQueue(n.QueueType.Aircrafts,0,a)),s}get onQueueUpdate(){return this._onQueueUpdate.asEvent()}addQueue(e,t){this.queues.set(e,t),t.onUpdate.subscribe(()=>this._onQueueUpdate.dispatch(this,t))}getQueue(e){var t=this.queues.get(e);if(!t)throw new Error("No queue found with type "+n.QueueType[e]);return t}getAllQueues(){return[...this.queues.values()]}getQueueTypeForObject(e){if(e.type===i.ObjectType.Building)return e.buildCat===r.BuildCat.Combat?n.QueueType.Armory:n.QueueType.Structures;if(e.type===i.ObjectType.Infantry)return n.QueueType.Infantry;if(e.type===i.ObjectType.Vehicle)return e.naval?n.QueueType.Ships:n.QueueType.Vehicles;if(e.type===i.ObjectType.Aircraft)return n.QueueType.Aircrafts;throw new Error("Unsupported object type "+i.ObjectType[e.type])}getQueueForObject(e){return this.getQueue(this.getQueueTypeForObject(e))}getQueueTypeForFactory(e){if(e===r.FactoryType.InfantryType)return n.QueueType.Infantry;if(e===r.FactoryType.UnitType)return n.QueueType.Vehicles;if(e===r.FactoryType.AircraftType)return n.QueueType.Aircrafts;if(e===r.FactoryType.NavalUnitType)return n.QueueType.Ships;throw new Error("Unsupported factory type "+r.FactoryType[e])}getFactoryTypeForQueueType(e){if(e===n.QueueType.Structures||e===n.QueueType.Armory)return r.FactoryType.BuildingType;if(e===n.QueueType.Infantry)return r.FactoryType.InfantryType;if(e===n.QueueType.Vehicles)return r.FactoryType.UnitType;if(e===n.QueueType.Aircrafts)return r.FactoryType.AircraftType;if(e===n.QueueType.Ships)return r.FactoryType.NavalUnitType;throw new Error("Unsupported queue type "+n.QueueType[e])}getQueueForFactory(e){return this.getQueue(this.getQueueTypeForFactory(e))}isAvailableForProduction(e){return e.isAvailableTo(this.player.country)&&-1!==e.techLevel&&e.techLevel<=this.maxTechLevel&&!(0===e.buildLimit&&!this.player.isAi)&&!(e.superWeapon&&this.rules.getSuperWeapon(e.superWeapon).disableableFromShell&&!this.gameOpts.superWeapons)&&this.hasFactoryFor(e)&&this.meetsPrerequisites(e)&&this.meetsStolenTech(e)}getAvailableObjects(){return this.allAvailableObjects.filter(e=>this.isAvailableForProduction(e))}hasFactoryFor(i){if(i.owner.length){let t=this.getFactoryTypeFor(i);return!![...this.player.buildings].find(e=>e.factoryTrait?.type===t&&(t!==r.FactoryType.UnitType||e.rules.naval===i.naval)&&!!e.rules.owner.find(e=>i.owner.includes(e)))}return!0}meetsStolenTech(e){return e.requiresStolenAlliedTech?this.stolenTech.has(o.SideType.GDI):!e.requiresStolenSovietTech||this.stolenTech.has(o.SideType.Nod)}getFactoryTypeFor(e){return e.type===i.ObjectType.Building?r.FactoryType.BuildingType:e.type===i.ObjectType.Infantry?r.FactoryType.InfantryType:e.type===i.ObjectType.Aircraft?r.FactoryType.AircraftType:e.naval?r.FactoryType.NavalUnitType:r.FactoryType.UnitType}meetsPrerequisites(e){let t=[...this.player.buildings].map(e=>e.name);var i;for(i of e.prerequisite)if(i=i.toUpperCase(),l.has(i)){var r=l.get(i);if(void 0===r)throw new Error("Unknown prereqName "+i);var s,a=this.rules.general.prereqCategories.get(r);if(void 0===a)throw new Error(`Missing prerequisite category ${r} in rules`);let e=!1;for(s of a)if(-1!==t.indexOf(s)){e=!0;break}if(!e)return!1}else if(-1===t.indexOf(i))return!1;return!0}getPrimaryFactory(e){return this.primaryFactories.get(e)}setPrimaryFactory(e){e.rules.factory&&this.primaryFactories.set(e.rules.factory,e)}isPrimaryFactory(e){return this.getPrimaryFactory(e.rules.factory)===e}incrementFactoryCount(e){this.factoryCounts.set(e,(this.factoryCounts.get(e)??0)+1)}decrementFactoryCount(e){if(!this.factoryCounts.get(e))throw new Error(`Can't decrement factory count ${r.FactoryType[e]}. Already 0`);this.factoryCounts.set(e,this.factoryCounts.get(e)-1)}getFactoryCount(e){return this.factoryCounts.get(e)??0}crownPrimaryFactoryHeir(t){var e=[...this.player.buildings].find(e=>e.rules.factory===t);e?this.primaryFactories.set(t,e):this.primaryFactories.delete(t)}hasAnyFactory(){return 0<this.primaryFactories.size}addVeteranType(e){this.veteranTypes.add(e)}hasVeteranType(e){return this.veteranTypes.has(e)}addStolenTech(e){this.stolenTech.add(e)}dispose(){this.queues.clear(),this.player=void 0}})}}}),System.register("game/event/SuperWeaponReadyEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SuperWeaponReadyEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.SuperWeaponReady}})}}}),System.register("game/SuperWeapon",["game/event/SuperWeaponReadyEvent","game/GameSpeed"],function(t,e){"use strict";var i,s,a,r;e&&e.id;return{setters:[function(e){i=e},function(e){s=e}],execute:function(){var e;(e=a=a||{})[e.Charging=0]="Charging",e[e.Paused=1]="Paused",e[e.Ready=2]="Ready",t("SuperWeaponStatus",a),t("SuperWeapon",r=class{constructor(e,t,i,r=!1){this.name=e,this.rules=t,this.owner=i,this.oneTimeOnly=r,this.status=a.Charging,this.isGift=!1,this.rechargeTicks=60*t.rechargeTime*s.GameSpeed.BASE_TICKS_PER_SECOND,this.chargeTicks=this.rechargeTicks,r&&(this.status=a.Ready,this.chargeTicks=0)}update(e){0<this.chargeTicks&&this.status!==a.Paused&&(this.chargeTicks--,0===this.chargeTicks&&(this.status=a.Ready,e.events.dispatch(new i.SuperWeaponReadyEvent(this))))}pauseTimer(){this.status=a.Paused}resumeTimer(){this.status=0<this.chargeTicks?a.Charging:a.Ready}resetTimer(){this.chargeTicks=this.rechargeTicks,this.status===a.Ready&&(this.status=a.Charging)}getTimerSeconds(){return this.chargeTicks/s.GameSpeed.BASE_TICKS_PER_SECOND}getChargeProgress(){return(this.rechargeTicks-this.chargeTicks)/this.rechargeTicks}})}}}),System.register("game/player/trait/SuperWeaponsTrait",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SuperWeaponsTrait",i=class{constructor(){this.superWeapons=new Map}getAll(){return[...this.superWeapons.values()]}add(e){this.superWeapons.set(e.name,e)}has(e){return this.superWeapons.has(e)}get(e){return this.superWeapons.get(e)}remove(e){this.superWeapons.delete(e)}})}}}),System.register("game/player/trait/SharedDetectDisguiseTrait",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SharedDetectDisguiseTrait",i=class{constructor(){this.objects=new Set}add(e){this.objects.add(e)}delete(e){this.objects.delete(e)}has(e){return this.objects.has(e)}dispose(){this.objects.clear()}})}}}),System.register("game/Player",["util/Color","engine/type/ObjectType","game/Traits","util/math"],function(e,t){"use strict";var s,i,a,r,n;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){a=e},function(e){r=e}],execute:function(){e("Player",n=class{constructor(e,t=void 0,i=0,r=new s.Color(255,0,0)){this.name=e,this.country=t,this.startLocation=i,this.color=r,this.isAi=!1,this.defeated=!1,this.resigned=!1,this.dropped=!1,this.objectsByType=new Map,this.objectsById=new Map,this.traits=new a.Traits,this._credits=0,this.score=0,this.unitsBuiltByType=new Map,this.unitsKilledByType=new Map,this.unitsLostByType=new Map,this.buildingsCaptured=0,this.cratesPickedUp=0,this.cheerCooldownTicks=0,this.isObserver=!t,this.isNeutral=!!t&&!t.isPlayable()}get credits(){return this._credits}set credits(e){if(e<0)throw new RangeError("Can't set credits to a negative value");this._credits=e}getOrCreateObjectsForType(e){let t=this.objectsByType.get(e);return t||(t=new Set,this.objectsByType.set(e,t)),t}addOwnedObject(e){let t=this.getOrCreateObjectsForType(e.type);t.add(e),(e.owner=this).objectsById.set(e.id,e)}removeOwnedObject(e){let t=this.objectsByType.get(e.type);if(!t||!t.has(e))throw new Error(`GameObject ${e.name} does not belong to player `+this.name);t.delete(e),this.objectsById.delete(e.id)}getOwnedObjectById(e){return this.objectsById.get(e)}getOwnedObjectsByType(e,t=!1){let i=[];return i=[...this.objectsByType.get(e)||new Set],t||(i=i.filter(e=>!e.limboData)),i}getOwnedObjects(e=!1){let t=[];return[...this.objectsByType.values()].forEach(e=>{e.forEach(e=>t.push(e))}),e||(t=t.filter(e=>!e.limboData)),t}removeAllOwnedObjects(){this.objectsByType.forEach(e=>e.clear()),this.objectsById.clear()}get buildings(){return this.getOrCreateObjectsForType(i.ObjectType.Building)}addUnitsBuilt(e,t){this.unitsBuiltByType.set(e,(this.unitsBuiltByType.get(e)??0)+t)}getUnitsBuilt(e){return void 0!==e?this.unitsBuiltByType.get(e)??0:[...this.unitsBuiltByType.values()].reduce((e,t)=>e+t,0)}addUnitsKilled(e,t){this.unitsKilledByType.set(e,(this.unitsKilledByType.get(e)??0)+t)}getUnitsKilled(e){return void 0!==e?this.unitsKilledByType.get(e)??0:[...this.unitsKilledByType.values()].reduce((e,t)=>e+t,0)}addUnitsLost(e,t){this.unitsLostByType.set(e,(this.unitsLostByType.get(e)??0)+t)}getUnitsLost(e){return void 0!==e?this.unitsLostByType.get(e)??0:[...this.unitsLostByType.values()].reduce((e,t)=>e+t,0)}isCombatant(){return!this.isNeutral&&!this.isObserver&&!this.defeated}canProduceVeteran(e){if(!this.production||!this.country)throw new Error("Non-combatants can't produce units");var t=this.production.getQueueTypeForObject(e),t=this.production.getFactoryTypeForQueueType(t);return this.production.hasVeteranType(t)||this.country.hasVeteranUnit(e.type,e.name)}getHash(){return r.fnv32a([this.credits,...this.traits.getAll().map(e=>e.getHash?.()??0)])}debugGetState(){return{name:this.name,credits:this.credits,traits:this.traits.getAll().reduce((e,t)=>{var i=t.debugGetState?.();return void 0!==i&&(e[t.constructor.name]=i),e},{})}}dispose(){this.traits.dispose(),this.production?.dispose()}})}}}),System.register("game/art/Art",["game/art/ObjectArt","engine/type/ObjectType","game/rules/ObjectRules","data/IniSection"],function(e,t){"use strict";var a,n,o,l,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){e("Art",i=class{constructor(e,t,i,r){this.rules=e,this.artIni=t,this.mapFile=i,this.logger=r,this.objectArt=new Map,this.parse()}hasObject(e,t){return this.objectArt.get(t)?.has(e)}getObject(e,t){if(!e)throw new Error(`Must specify an art name for type "${n.ObjectType[t]}"`);var i=this.objectArt.get(t)?.get(e);return i||(this.logger?.debug(`Missing art for object "${e}"`),new a.ObjectArt(t,this.rules.hasObject(e,t)?this.rules.getObject(e,t):new o.ObjectRules(t,new l.IniSection(e)),new l.IniSection(e)))}getAnimation(e){return this.getObject(e,n.ObjectType.Animation)}getProjectile(e){var t=this.rules.getProjectile(e),i=t.imageName;let r=this.artIni.getSection(i);return r||(this.logger?.debug(`Image ${i} (Projectile: ${e}) has no section in art.ini`),r=new l.IniSection(i)),a.ObjectArt.factory(t.type,t,this.artIni,r)}getIni(){return this.artIni}parse(){this.rules.allObjectRules.forEach((e,t)=>{let r=new Map;this.objectArt.set(t,r),e.forEach(e=>{var t=this.artIni.getSection(e.imageName),i=this.artIni.getSection(e.name);(t=this.applyUnitMapOverrides(e,this.mapFile,i,t))?(t=a.ObjectArt.factory(e.type,e,this.artIni,t),r.set(e.name,t)):this.logger?.debug(`${n.ObjectType[e.type]} "${e.name}" has no art section "${e.imageName}"`)})});let e=[[n.ObjectType.Animation,this.rules.animationNames]];e.forEach(([r,e])=>{let s=new Map;this.objectArt.set(r,s),e.forEach(e=>{var t,i=this.artIni.getSection(e);i?(t=new o.ObjectRules(r,new l.IniSection(e)),i=new a.ObjectArt(r,t,i),s.set(e,i)):this.logger?.debug(n.ObjectType[r]+` "${e}" has no art section`)})})}applyUnitMapOverrides(e,t,r,s){if([n.ObjectType.Infantry,n.ObjectType.Vehicle,n.ObjectType.Aircraft].includes(e.type)&&!!t?.getSection(e.name)?.getString("Image")&&r){let i=r.clone();s?.entries.forEach((e,t)=>{i.set(t,e)}),s=i,this.logger?.debug(`${n.ObjectType[e.type]} "${e.name}": `+`Using merged art sections ${e.name} and `+e.imageName)}return s}})}}}),System.register("game/gameobject/task/morph/PackBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/system/WaitMinutesTask"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends i.Task{onTick(e){return!(e.buildStatus!==r.BuildStatus.BuildDown&&(e.buildStatus=r.BuildStatus.BuildDown,!e.rules.wall))||(this.children.push(new s.WaitMinutesTask(.035)),!1)}},e("PackBuildingTask",a)}}}),System.register("util/disposable/LegacyDisposable",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("util/disposable/CompositeDisposable",[],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[],execute:function(){i=e=>!e.dispose,e("CompositeDisposable",r=class{constructor(){this.disposables=new Set}add(...e){e.map(e=>this.disposables.add("function"==typeof e?{dispose:e}:e))}remove(...e){e.map(e=>this.disposables.delete(e))}dispose(){this.disposables.forEach(e=>{"function"==typeof e?e():i(e)?e.destroy():e.dispose()}),this.disposables.clear()}})}}}),System.register("game/ConstructionWorker",["util/geometry","engine/type/ObjectType","game/type/SpeedType","game/map/tileFinder/CardinalTileFinder","game/gameobject/task/morph/PackBuildingTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","util/disposable/CompositeDisposable","game/event/EventType"],function(e,t){"use strict";var s,m,r,a,i,n,o,l,c,h;t&&t.id;return{setters:[function(e){s=e},function(e){m=e},function(e){r=e},function(e){a=e},function(e){i=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("ConstructionWorker",h=class{constructor(e,t,i,r,s){this.player=e,this.rules=t,this.art=i,this.map=r,this.game=s,this.adjacencyMaps=new Map,this.disposables=new l.CompositeDisposable;let a=({object:e})=>{e.isBuilding()&&this.adjacencyMaps.clear()};this.map.tileOccupation.onChange.subscribe(a),this.disposables.add(()=>this.map.tileOccupation.onChange.unsubscribe(a)),this.disposables.add(this.game.events.subscribe(c.EventType.AllianceChange,()=>this.adjacencyMaps.clear()),this.game.events.subscribe(c.EventType.ObjectOwnerChange,e=>{e.target.isBuilding()&&this.adjacencyMaps.clear()}),this.game.events.subscribe(c.EventType.ObjectDestroy,e=>{e.target.isBuilding()&&e.target.rules.leaveRubble&&this.adjacencyMaps.clear()}))}getAdjacentRect(e,t,i){return{x:e.rx-i,y:e.ry-i,width:t.width+2*i,height:t.height+2*i}}getAdjacencyMap(e){var t;let i=[];for(t of[...this.player.buildings,...this.game.gameOpts.buildOffAlly?this.game.alliances.getAllies(this.player).map(e=>[...e.buildings].filter(e=>e.rules.eligibileForAllyBuilding)).flat():[]])t.rules.baseNormal&&i.push(this.getAdjacentRect(t.tile,t.art.foundation,e));return i}meetsAdjacency(e,t){let i=this.adjacencyMaps.get(t);i||(i=this.getAdjacencyMap(t),this.adjacencyMaps.set(t,i));for(var r of i)if(s.rectIntersect(e,r))return!0;return!1}getPlacementPreview(e,t,i={}){var{normalizedTile:r=!1,ignoreObjects:s,ignoreAdjacent:a=!1}=i,n=this.rules.getBuilding(e),o=this.art.getObject(e,m.ObjectType.Building);let l=[];var c=o.foundation,h=r?t:this.normalizePlacementTileCoords(o,t);let u=!0;o={x:h.rx,y:h.ry,width:c.width,height:c.height};n.constructionYard||a||this.meetsAdjacency(o,n.adjacent)||(u=!1);for(let p=0;p<c.width;p++)for(let e=0;e<c.height;e++){var d={x:h.rx+p,y:h.ry+e},g=this.map.tiles.getByMapCoords(d.x,d.y);g&&l.push({rx:d.x,ry:d.y,buildable:u&&this.isTileBuildable(g,n,s)})}if(n.wall&&l[0].buildable){let e=this.getWallConnectingTiles(h,n);e.forEach(e=>{l.push({rx:e.rx,ry:e.ry,buildable:!0})})}return l}canPlaceAt(e,t,i={}){var{normalizedTile:r=!1,ignoreObjects:s,ignoreAdjacent:a=!1}=i,n=this.rules.getBuilding(e),o=this.art.getObject(e,m.ObjectType.Building),l=o.foundation,c=r?t:this.normalizePlacementTileCoords(o,t),o={x:c.rx,y:c.ry,width:l.width,height:l.height};if(!n.constructionYard&&!a&&!this.meetsAdjacency(o,n.adjacent))return!1;for(let u=0;u<l.width;u++)for(let e=0;e<l.height;e++){var h={x:c.rx+u,y:c.ry+e},h=this.map.tiles.getByMapCoords(h.x,h.y);if(!h||!this.isTileBuildable(h,n,s))return!1}return!0}placeAt(e,t,i=!1){let r=[],s=this.rules.getBuilding(e),a=i?t:this.normalizePlacementTile(e,t);if(s.wall){let t=[[a,s]],e=this.getWallConnectingTiles(a,s);e.forEach(e=>{e!==a&&t.push([e,s])});for(var n of t)r.push(this.executePlacement(n[0],n[1]));e.forEach(e=>{var t=this.map.getObjectsOnTile(e).find(e=>e.isBuilding()&&e.name===s.name&&e.owner===this.player);this.connectWall(t)})}else{var o,l=this.executePlacement(a,s);r.push(l);for(o of this.map.tileOccupation.calculateTilesForGameObject(a,l)){var c=this.map.getObjectsOnTile(o).find(e=>e.isSmudge());c&&this.game.unspawnObject(c)}}return r}normalizePlacementTileCoords(e,t){var i=e.foundationCenter;return{rx:t.rx-i.x,ry:t.ry-i.y}}normalizePlacementTile(e,t){var i=this.art.getObject(e,m.ObjectType.Building),r=this.normalizePlacementTileCoords(i,t),i=this.map.tiles.getByMapCoords(r.rx,r.ry);if(!i)throw new Error(`Can't build outside map (${r.rx}, ${r.ry})`);return i}unplace(e,t){e.unitOrderTrait.cancelAllTasks(),e.unitOrderTrait.addTasks(new o.TaskGroup(new i.PackBuildingTask,new n.CallbackTask(()=>{this.game.unspawnObject(e),e.rules.wall&&this.updateAdjacentWalls(e),t()})).setCancellable(!1))}executePlacement(e,t){let i=this.game.createObject(m.ObjectType.Building,t.name);return this.game.changeObjectOwner(i,this.player),i.purchaseValue=this.game.sellTrait.computePurchaseValue(t,this.player),this.game.spawnObject(i,e),i}getWallConnectingTiles(i,r){var s,a=r.guardRange+1;let n=[];for(s of[[0,1],[0,-1],[1,0],[-1,0]]){let e=[];for(let t=0;t<a;++t){var o={x:i.rx+s[0]*t,y:i.ry+s[1]*t},o=this.map.tiles.getByMapCoords(o.x,o.y);if(!o)break;if(this.map.getObjectsOnTile(o).find(e=>e.isBuilding()&&e.name===r.name&&e.owner===this.player)){n=n.concat(e);break}if(!this.isTileBuildable(o,r))break;e.push(o)}}return n}getAdjacentBuildingData(e,t){var i;let r=[];for(i of[[0,1],[0,-1],[1,0],[-1,0]]){var s={x:e.rx+i[0],y:e.ry+i[1]},a=this.map.tiles.getByMapCoords(s.x,s.y);a&&((s=this.map.getObjectsOnTile(a).find(e=>e.isBuilding()&&e.name===t&&e.owner===this.player))&&r.push({direction:i,tile:a,building:s}))}return r}updateAdjacentWalls(t){let e=new a.CardinalTileFinder(this.map.tiles,this.map.mapBounds,t.tile,1,1);for(e.diagonal=!1;i=e.getNextTile();){var i=this.map.getObjectsOnTile(i).find(e=>e.isBuilding()&&e.name===t.rules.name&&e.owner===this.player);i&&this.connectWall(i)}}connectWall(e){let t=this.getAdjacentBuildingData(e.tile,e.name);this.updateWallType(e,t.map(e=>e.direction)),t.forEach(e=>{let t=this.getAdjacentBuildingData(e.tile,e.building.name);this.updateWallType(e.building,t.map(e=>e.direction))})}updateWallType(e,t){e.wallType=[0,0,0,0];for(var i of t)0===i[0]&&-1===i[1]&&(e.wallType[0]=1),1===i[0]&&0===i[1]&&(e.wallType[1]=1),0===i[0]&&1===i[1]&&(e.wallType[2]=1),-1===i[0]&&0===i[1]&&(e.wallType[3]=1)}isTileBuildable(e,t,i){return!!this.map.isWithinBounds(e)&&(!this.game.mapShroudTrait.getPlayerShroud(this.player)?.isShrouded(e)&&(!this.map.getGroundObjectsOnTile(e).some(e=>!(i?.includes(e)||e.isBuilding()&&e.rules.invisibleInGame||e.isSmudge()))&&(t.waterBound?0<this.rules.getLandRules(e.landType).getSpeedModifier(r.SpeedType.Float):0===e.rampType&&this.rules.getLandRules(e.landType).buildable)))}dispose(){this.disposables.dispose()}})}}}),System.register("util/BoxedVar",["util/event"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BoxedVar",r=class{constructor(e){this._onChange=new i.EventDispatcher,this.value=e}get value(){return this._value}set value(e){var t=e!==this._value;this._value=e,t&&this._onChange.dispatch(this,e)}get onChange(){return this._onChange.asEvent()}})}}}),System.register("game/theater/rampHeights",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("rampHeights",[[0,0,0,0],[0,0,1,1],[1,0,0,1],[1,1,0,0],[0,1,1,0],[0,0,0,1],[1,0,0,0],[0,1,0,0],[0,0,1,0],[1,0,1,1],[1,1,0,1],[1,1,1,0],[0,1,1,1],[1,0,1,2],[2,1,0,1],[1,2,1,0],[0,1,2,1],[1,0,1,0],[0,1,0,1],[1,0,1,0],[0,1,0,1]])}}}),System.register("game/gameobject/ObjectPosition",["game/Coords","util/event","game/theater/rampHeights","game/math/Vector3","game/math/Vector2","util/math"],function(e,t){"use strict";var o,i,n,r,s,a,l;t&&t.id;return{setters:[function(e){o=e},function(e){i=e},function(e){n=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("ObjectPosition",l=class l{constructor(e,t){this.tiles=e,this.tileOccupation=t,this._worldPosition=new r.Vector3,this._tileOffset=new s.Vector2,this._centerOffset=new s.Vector2,this.desiredSubCell=0,this._tileElevation=0,this._onPositionChange=new i.EventDispatcher}get onPositionChange(){return this._onPositionChange.asEvent()}get worldPosition(){return this._worldPosition}get tile(){return this._tile}set tile(e){var t=!!this._tile&&e!==this._tile;(this._tile=e)&&(this.updateWorldPosition(e,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:t}))}get tileElevation(){return void 0===this._tileElevation?(void 0===this._computedTileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos()),this._computedTileElevation):this._tileElevation}set tileElevation(e){this._absoluteElevation=void 0,this._tileElevation=e,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}get subCell(){if(!this._tileOffset.x&&!this._tileOffset.y)return 0;var e=Math.sign(this._tileOffset.x/o.Coords.LEPTONS_PER_TILE-.5),t=Math.sign(this._tileOffset.y/o.Coords.LEPTONS_PER_TILE-.5);return e&&t?t+1+(e+1)/2+1:0}set subCell(e){this._tileOffset=this.computeSubCellOffset(e),this.desiredSubCell=e,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}getTileOffset(){return this._tileOffset.clone()}setTileOffset(e){this._tileOffset.copy(e),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}setCenterOffset(e){this._centerOffset.copy(e),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}getMapPosition(){if(this._tile)return new s.Vector2(this._tile.rx*o.Coords.LEPTONS_PER_TILE+this._tileOffset.x+this._centerOffset.x,this._tile.ry*o.Coords.LEPTONS_PER_TILE+this._tileOffset.y+this._centerOffset.y)}getBridgeBelow(){return this._tile?.onBridgeLandType?this.tileOccupation.getBridgeOnTile(this._tile):void 0}moveToTileCell(e,t=0){if(!this._tile)throw new Error("Tile is not set");var i=e!==this._tile;this._tile=e,this._tileOffset=this.computeSubCellOffset(t),this.desiredSubCell=t,this.updateWorldPosition(e,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:i})}moveToTileCoords(e,t,i=!1){var r=Math.floor(e),s=Math.floor(t),a=!this._tile||this._tile.rx!==r||this._tile.ry!==s;if(a){let e=this.tiles.getByMapCoords(r,s);if(!e){if(!i)throw new RangeError(`Attempted move to a non-existent tile: [${r},${s}]`);e=this.tiles.getPlaceholderTile(r,s)}this._tile=e}this._tileOffset.set((e-r)*o.Coords.LEPTONS_PER_TILE,(t-s)*o.Coords.LEPTONS_PER_TILE),this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:a})}moveToLeptons(e,t=!1){this.moveToTileCoords(e.x/o.Coords.LEPTONS_PER_TILE,e.y/o.Coords.LEPTONS_PER_TILE,t)}moveByLeptons(e,t,i=!1){if(!this._tile)throw new Error("Tile is not set");this.moveToTileCoords(this._tile.rx+(this._tileOffset.x+e)/o.Coords.LEPTONS_PER_TILE,this._tile.ry+(this._tileOffset.y+t)/o.Coords.LEPTONS_PER_TILE,i)}moveByLeptons3(e,t=!1){var i=this._worldPosition.y;this.moveByLeptons(e.x,e.z,t),this.setAbsoluteElevationWorld(i+e.y)}setAbsoluteElevationWorld(e){this._absoluteElevation=e,this._tileElevation=void 0,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}computeSubCellOffset(e){let t={width:0,height:0};var i;e&&(i=(e-1)%2*2-1,r=2*Math.floor((e-1)/2)-1,t={width:i*o.Coords.LEPTONS_PER_TILE/4,height:r*o.Coords.LEPTONS_PER_TILE/4});var r=o.Coords.LEPTONS_PER_TILE/2;return new s.Vector2(r+t.width,r+t.height)}interpolateRampHeight(e,t,i){var r=n.rampHeights[i],s=r[1],a=r[0];return s*(1-e)*(1-t)+r[2]*e*(1-t)+a*(1-e)*t+r[3]*e*t}updateWorldPosition(t,e){var i=e.x+this._centerOffset.x,r=e.y+this._centerOffset.y,s=i/o.Coords.LEPTONS_PER_TILE,a=r/o.Coords.LEPTONS_PER_TILE;let n;if(void 0!==this._tileElevation){let e=0;0!==t.rampType&&(e=this.interpolateRampHeight(s,a,t.rampType)),n=o.Coords.tileHeightToWorld(t.z+e+this._tileElevation)}else n=this._absoluteElevation;this._worldPosition.set(t.rx*o.Coords.LEPTONS_PER_TILE+i,n,t.ry*o.Coords.LEPTONS_PER_TILE+r),void 0===this._tileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos())}computeTileElevationFromWorldPos(){if(!this._tile)return 0;var e=a.roundToDecimals(o.Coords.worldToTileHeight(this._worldPosition.y),14),t=(this._tileOffset.x+this._centerOffset.x)/o.Coords.LEPTONS_PER_TILE,i=(this._tileOffset.y+this._centerOffset.y)/o.Coords.LEPTONS_PER_TILE;let r=0;return 0!==this._tile.rampType&&(r=this.interpolateRampHeight(t,i,this._tile.rampType)),e-this._tile.z-r}clone(){let e=new l(this.tiles,this.tileOccupation);return e._worldPosition=this._worldPosition.clone(),e._tile=this._tile,e._tileOffset=this._tileOffset.clone(),e._centerOffset=this._centerOffset.clone(),e._tileElevation=this._tileElevation,e._absoluteElevation=this._absoluteElevation,e._computedTileElevation=this._computedTileElevation,e}})}}}),System.register("game/gameobject/unit/CollisionHelper",["engine/type/TerrainType","game/type/LandType","game/gameobject/unit/CollisionType","game/gameobject/unit/ZoneType"],function(e,t){"use strict";var s,h,u,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){h=e},function(e){u=e},function(e){a=e}],execute:function(){e("CollisionHelper",i=class{constructor(e){this.tileOccupation=e}checkCollisions(e,t,i){var r,s=e.tile;let a,n;for(r of this.tileOccupation.getObjectsOnTile(s))r.isOverlay()&&r.isBridge()&&(a=r),r.isBuilding()&&(n=r);if(i.walls){if(e.tileElevation<=2&&s.landType===h.LandType.Wall)return u.CollisionType.Wall;if(i.buildings&&n?.tile===s&&e.tileElevation<=1.1&&i.buildings(n.owner))return u.CollisionType.Wall}if(i.shore&&s.landType!==h.LandType.Water)return u.CollisionType.Shore;if(i.ground&&e.tileElevation<0)return u.CollisionType.Ground;var o=e.tileElevation+s.z,l=t.tileElevation+t.tile.z;if(a?.isHighBridge()){var c=a.tile.z+a.tileElevation;if(c<l&&o<=c||l<c&&c-1<=o)return l<c?u.CollisionType.UnderBridge:u.CollisionType.OnBridge}else if(a?.isLowBridge()&&i.shore)return u.CollisionType.UnderBridge;if(i.cliffs){s=s.z-t.tile.z;if(e.tileElevation<0&&4<=s)return u.CollisionType.Cliff}return u.CollisionType.None}computeDetonationZone(e,t,i){let r=this.tileOccupation.getBridgeOnTile(e);return i===u.CollisionType.None&&t>1.5+(r?.tileElevation??0)?a.ZoneType.Air:r&&1.5<t||e.terrainType!==s.TerrainType.Water||r?.isLowBridge()?a.ZoneType.Ground:a.ZoneType.Water}})}}}),System.register("game/gameobject/Projectile",["game/gameobject/GameObject","engine/type/ObjectType","game/Weapon","game/WeaponType","game/gameobject/unit/FacingUtil","game/Coords","game/gameobject/unit/ZoneType","game/map/TileOccupation","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","game/gameobject/unit/TargetUtil","game/math/geometry","game/map/tileFinder/RandomTileFinder","util/math","game/type/MovementZone","game/gameobject/infantry/StanceType","game/gameobject/unit/MovePositionHelper","game/GameSpeed","game/gameobject/unit/VeteranLevel","game/gameobject/task/ScatterTask","game/Warhead","game/rules/ObjectRules","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector2","game/math/Vector3"],function(t,e){"use strict";var i,s,T,v,b,S,c,w,C,E,h,x,O,A,M,R,P,I,r,n,k,a,o,B,j,N,L,l;e&&e.id;return{setters:[function(e){i=e},function(e){s=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){c=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){h=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){r=e},function(e){n=e},function(e){k=e},function(e){a=e},function(e){o=e},function(e){B=e},function(e){j=e},function(e){N=e}],execute:function(){var e;0,(e=L=L||{})[e.Travel=0]="Travel",e[e.Impact=1]="Impact",e[e.Detonation=2]="Detonation",t("ProjectileState",L),l=class extends i.GameObject{constructor(e,t,i,r){super(s.ObjectType.Projectile,e,t,i),this.tileOccupation=r,this.state=L.Travel,this.detonationTimer=0,this.collisionType=B.CollisionType.None,this.direction=0,this.zone=c.ZoneType.Air,this.isShrapnel=!1,this.isNuke=!1,this.baseDamageMultiplier=1,this.veteranDamageMult=1,this.snapToTarget=!1,this.targetLockLost=!1,this.limboTravelTicks=0,this.homingTravelDistance=0,this.homingTravelTicks=0,this.velocity=new N.Vector3,this.sonicVisitedObjects=new Map,this.collisionHelper=new o.CollisionHelper(r)}get fromObject(){return this._fromObject}set fromObject(e){(this._fromObject=e)&&e.veteranTrait&&!e.isDestroyed&&(this.veteranDamageMult=e.veteranTrait.getVeteranDamageMultiplier())}get rot(){return this.fromWeapon.rules.isSonic?a.ObjectRules.iniRotToDegsPerTick(this.iniRot):this.rules.rot}get iniRot(){return this.fromWeapon.rules.isSonic?10:this.rules.iniRot}static factory(e,t,i,r){return new this(e,t,i,r)}onSpawn(a){var e;if(super.onSpawn(a),this.initialSelfPosition=this.position.worldPosition.clone(),!this.target.obj||this.fromWeapon.type===v.WeaponType.DeathWeapon||this.fromWeapon.rules.limboLaunch||!this.isHoming()&&this.fromWeapon.speed===Number.POSITIVE_INFINITY||this.rules.inaccurate||this.rules.arcing||this.rules.flakScatter||0<(e=this.computeBaseDamage(a))&&(e=this.fromWeapon.warhead.computeDamage(e,this.target.obj),this.target.obj.healthTrait?.projectDamage(e)),a.afterTick(()=>{let e=new E.RangeHelper(this.tileOccupation);var t=e.distance2(this.target.getWorldCoords(),this)/S.Coords.LEPTONS_PER_TILE;this.initialTileDistToTarget=t,this.maxSpeed=this.computeMaxSpeed(this.fromWeapon.speed,t,a.rules.audioVisual.gravity)}),this.isHoming()){if(1===this.iniRot&&(this.homingMoveDir=this.target.getWorldCoords().clone().sub(this.position.worldPosition)),this.fromObject?.isAircraft()&&this.rules.isAntiGround&&!this.rules.isAntiAir){let e=this.target.obj;!e?.isVehicle()||e.isDestroyed||e.veteranLevel!==r.VeteranLevel.Elite||e.unitOrderTrait.hasTasks()||e.unitOrderTrait.addTask(new n.ScatterTask(a))}}else if(this.rules.vertical){let e=this.position.clone();e.tileElevation=this.fromWeapon.warhead.rules.nukeMaker?S.Coords.worldToTileHeight(this.fromWeapon.projectileRules.detonationAltitude):0,this.aimPoint=e.worldPosition.clone()}else{let s=this.target.getWorldCoords().clone();a.afterTick(()=>{let e=this.target.getWorldCoords().clone().sub(s);var t=e.length()>S.Coords.LEPTONS_PER_TILE;let i=t?s:this.target.obj?.isUnit()&&this.target.obj.moveTrait.velocity.length()&&isFinite(this.maxSpeed)?this.computeAimPointVersusMovingTarget(this.target.obj,this.maxSpeed,this.position.worldPosition,a.map):this.target.getWorldCoords().clone();this.aimPoint=i,this.snapToTarget=!t&&isFinite(this.maxSpeed)&&!this.fromWeapon.warhead.rules.sonic,(this.rules.inaccurate||this.rules.flakScatter)&&(this.adjustAimForBallisticScatter(a,i),this.snapToTarget=!1),!t&&this.rules.arcing&&(this.rules.inaccurate?(this.overshootTiles=this.calculateInaccurateBallisticOvershoot(a),this.snapToTarget=!1):this.target.obj?.isVehicle()&&this.target.obj.moveTrait.isMoving()&&(this.overshootTiles=this.calculateBallisticOvershootVsMoving(a,this.target.obj),this.overshootTiles&&(this.snapToTarget=!1)));let r=i.clone().sub(this.position.worldPosition);r.length()<this.fromWeapon.speed&&this.update(a)})}}adjustAimForBallisticScatter(e,t){let i=e.rules.combatDamage.ballisticScatter,r;r=this.rules.flakScatter?(this.rules.inviso&&(i*=2),e.generateRandom()*i):i/2+e.generateRandom()*(i/2);let s=r*S.Coords.LEPTONS_PER_TILE;this.rules.flakScatter&&(n=t.clone().sub(this.initialSelfPosition).length(),s*=n/(this.fromWeapon.range*S.Coords.LEPTONS_PER_TILE));var a=x.rotateVec2(new j.Vector2(s,0),e.generateRandomInt(0,360)),n=S.Coords.vecWorldToGround(t).add(a).multiplyScalar(1/S.Coords.LEPTONS_PER_TILE).floor();e.map.tiles.getByMapCoords(n.x,n.y)&&t.add(new N.Vector3(a.x,0,a.y))}calculateBallisticOvershootVsMoving(e,t){let i=this.target.getWorldCoords().clone().sub(this.initialSelfPosition);var r=S.Coords.vecWorldToGround(i),s=S.Coords.vecWorldToGround(t.moveTrait.velocity),r=x.angleDegBetweenVec2(r,s),s=(90<r?180-r:r)/90,r=i.length()/S.Coords.LEPTONS_PER_TILE,s=s*r/5;return e.generateRandom()<=s?2*Math.min(1,r/5):0}calculateInaccurateBallisticOvershoot(e){return e.generateRandom()<=.5?2:0}update(n){if(void 0!==this.maxSpeed)if(super.update(n),this.state!==L.Impact){var r=this.velocity.clone(),o=this.position.clone();if(this.velocity.set(0,0,0),this.fromWeapon.rules.limboLaunch){if(!this.fromObject)throw new Error("Limbo launch projectile must be fired from a unit");if(this.fromObject.isDestroyed)return void n.destroyObject(this)}var l=this.updateSpeed(this.maxSpeed);this.speed=l;let a=this.target.getWorldCoords();if(this.lastTargetLockPosition&&(this.targetLockLost||a.clone().sub(this.lastTargetLockPosition).length()>=S.Coords.LEPTONS_PER_TILE)?(a=this.lastTargetLockPosition,this.targetLockLost=!0):this.lastTargetLockPosition=a.clone(),this.isHoming()){if(this.target.obj?.isUnit()&&(this.target.obj.isDestroyed||this.target.obj.isCrashing||!this.target.obj.isSpawned)&&(this.fromWeapon.rules.limboLaunch||this.homingTravelDistance>=2*S.Coords.LEPTONS_PER_TILE))return void this.detonate(n);if(this.homingMoveDir||(h=b.FacingUtil.toMapCoords(this.direction),this.homingMoveDir=new N.Vector3(h.x,0,h.y),this.fromObject?.isAircraft()&&(this.homingMoveDir.y=-9999999,this.homingMoveDir.normalize())),this.fromWeapon.rules.limboLaunch){if(!this.targetLockLost){if(10<this.limboTravelTicks)return this.position.moveToLeptons(this.target.obj.position.getMapPosition()),this.position.tileElevation=this.target.obj.position.tileElevation,void this.detonate(n);this.limboTravelTicks++}}else if(!this.isInHomingRange(a,n))return void this.detonate(n);let e=new E.RangeHelper(this.tileOccupation);var c=Math.floor(e.distance2(a,this)/S.Coords.LEPTONS_PER_TILE),h=2<c&&1<this.iniRot;let t=a.clone().sub(this.position.worldPosition),i=0;this.homingTravelTicks<this.rules.courseLockDuration||(h?(x.rotateVec3Towards(this.homingMoveDir,new N.Vector3(t.x,this.homingMoveDir.y,t.z),this.rot),this.rules.level||(u=A.clamp(Math.floor(this.initialTileDistToTarget)-1,0,2)+A.clamp(c-2,0,3)-this.position.tileElevation)&&(g=.25+6/this.iniRot*.1,i=S.Coords.tileHeightToWorld(Math.sign(u)*Math.min(Math.abs(u),g)))):x.rotateVec3Towards(this.homingMoveDir,t,this.rot)),this.direction=b.FacingUtil.fromMapCoords(new j.Vector2(this.homingMoveDir.x,this.homingMoveDir.z));var c=t.length(),u=Math.min(c,l);this.homingTravelDistance+=u,this.homingTravelTicks++;let r=!1,s=B.CollisionType.None;if(1<=u){let e=this.homingMoveDir.clone().setLength(u);i&&(e.y+=i),u===l&&this.velocity.copy(e);var d=e.clone().add(this.position.worldPosition);n.map.mapBounds.isWithinHardBounds(d)?this.position.moveByLeptons3(e):r=!0,s=this.checkObstacles(o,n),(s||u<l)&&(r=!0)}else this.position.moveByLeptons3(t),r=!0;r&&(this.collisionType=s,this.detonate(n,s))}else{let t=this.aimPoint.clone().sub(this.position.worldPosition);this.rules.vertical||(this.direction=b.FacingUtil.fromMapCoords(new j.Vector2(t.x,t.z))),this.rules.arcing&&(t.y=0);var g=Math.min(t.length(),l);if(t.setLength(g),this.rules.arcing){let e=S.Coords.vecWorldToGround(this.position.worldPosition.clone().sub(this.initialSelfPosition).add(t));var c=this.aimPoint.clone().sub(this.initialSelfPosition),s=e.length(),d=S.Coords.vecWorldToGround(c).length(),u=c.y,c=n.rules.audioVisual.gravity;t.y=(u/d*l+c/2*d/l)*s/l-c*(s/l)*(s/l)/2+this.initialSelfPosition.y-this.position.worldPosition.y}let e=!1;s=t.clone().add(this.position.worldPosition);n.map.isWithinHardBounds(s)?this.position.moveByLeptons3(t):e=!0;let i=B.CollisionType.None;if(1<=g?(g!==l&&!this.overshootTiles||this.velocity.copy(t),i=this.checkObstacles(o,n),(i||g<l)&&(e=!0)):e=!0,e){if(!i)if(this.overshootTiles){var p=S.Coords.vecWorldToGround(r).setLength(this.overshootTiles*S.Coords.LEPTONS_PER_TILE);if(x.rotateVec2(p,n.generateRandomInt(-45,45)),s=S.Coords.vecGroundToWorld(p).add(this.position.worldPosition),!n.map.isWithinHardBounds(s))return void n.unspawnObject(this);this.position.moveByLeptons(p.x,p.y)}else if(this.snapToTarget&&!this.targetLockLost){if(!n.map.isWithinHardBounds(a))return void n.unspawnObject(this);this.position.moveByLeptons3(a.clone().sub(this.position.worldPosition))}this.collisionType=i,this.isNuke?(this.state=L.Impact,this.detonationTimer=2.5*I.GameSpeed.BASE_TICKS_PER_SECOND):this.detonate(n,i)}}let e=this.fromWeapon.warhead;if(e.rules.sonic){var t,i,p=11/30*S.Coords.LEPTONS_PER_TILE,p=this.position.worldPosition.clone().add(this.velocity.clone().setLength(p)),p=S.Coords.vecWorldToGround(p).multiplyScalar(1/S.Coords.LEPTONS_PER_TILE).floor(),m=n.map.tiles.getByMapCoords(p.x,p.y);if(m&&m!==this.fromObject?.tile){var f,y=n.map.getTileZone(m);for(f of n.map.getGroundObjectsOnTile(m))if((!f.isUnit()||!f.onBridge)&&(!f.isTechno()||!f.rules.typeImmune||f.owner!==this.fromPlayer||f.name!==this.fromObject?.name)&&(!f.isAircraft()||!f.rules.spawned)&&e.canDamage(f,m,y)){let e=this.sonicVisitedObjects.get(f)??new Set;e.add(m),this.sonicVisitedObjects.set(f,e)}}for([t,i]of this.sonicVisitedObjects)for(var T of i)n.map.tileOccupation.isTileOccupiedBy(T,t)&&t.isSpawned&&(T=this.fromWeapon.rules.ambientDamage*this.veteranDamageMult*this.baseDamageMultiplier,T=e.computeDamage(T,t),e.inflictDamage(T,t,{player:this.fromPlayer,weapon:this.fromWeapon,obj:this.fromObject},n,t!==this.target.obj))}}else 0<this.detonationTimer?this.detonationTimer--:this.detonate(n,this.collisionType)}isHoming(){return!!this.rot&&!this.rules.arcing}isInHomingRange(t,i){let r=!0,s=this.target.obj;if(s?.isUnit()&&this.fromObject){let e=new E.RangeHelper(this.tileOccupation);var a,n=e.computeWeaponRangeVsTarget(this.fromObject,s,this.fromWeapon,i.rules).range;this.fromWeapon.rules.limboLaunch?r=e.isInRange3(this.initialSelfPosition,t,0,n+.5):(a=s.moveTrait.velocity.length())&&(this.fromObject.rules.movementZone===M.MovementZone.Fly?5<this.speed/a&&(r=e.isInRange2(this.initialSelfPosition,this.position.worldPosition,0,n)):isFinite(this.fromWeapon.speed)&&3.5<this.fromWeapon.speed/s.rules.speed&&(r=e.isInRange3(this.initialSelfPosition,this.position.worldPosition,0,n)))}return r}updateSpeed(e){let t;return t=this.isHoming()||this.rules.vertical?void 0===this.speed?Math.min(e,this.rules.acceleration):Math.min(e,this.speed+this.rules.acceleration):e,t}computeMaxSpeed(e,t,i){let r=e;return this.rules.arcing&&(r*=(1+i/6)/2,t=Math.floor(t),r*=t<=8?1:1+t/8*.5),this.fromWeapon.warhead.rules.sonic&&(r=Math.ceil(t*S.Coords.LEPTONS_PER_TILE/21)),r}checkObstacles(e,t){return this.fromWeapon.rules.limboLaunch?B.CollisionType.None:this.collisionHelper.checkCollisions(this.position,e,{cliffs:this.rules.subjectToCliffs,ground:this.isHoming(),shore:this.rules.level,walls:this.rules.subjectToWalls,buildings:e=>this.fromPlayer!==e&&!t.alliances.areAllied(this.fromPlayer,e)})}computeBaseDamage(e){var t=this.fromWeapon,i=t.warhead;let r=t.rules.damage;t.type===v.WeaponType.DeathWeapon&&i.rules.ivanBomb&&(r=e.rules.combatDamage.ivanDamage);let s=r*this.baseDamageMultiplier;return t.type===v.WeaponType.DeathWeapon&&this.fromObject&&(s*=this.fromObject.rules.deathWeaponDamageModifier),s*=this.veteranDamageMult,s}detonate(o,e=B.CollisionType.None){var i=this.fromWeapon;let r=i.warhead;var t,s=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,e);let l=this.tile;i.type===v.WeaponType.DeathWeapon&&r.rules.ivanBomb&&(r=new k.Warhead(o.rules.getWarhead(o.rules.combatDamage.ivanWarhead)));let a=this.computeBaseDamage(o);o.destroyObject(this),this.state=L.Detonation;let n=this.target.obj,c=!1;if(r.rules.parasite&&n?.isUnit()&&l===n.tile&&r.canDamage(n,l,s))if(n.isInfantry())a=Number.POSITIVE_INFINITY;else if(n.parasiteableTrait&&this.fromObject?.isUnit()){if(!(this.fromWeapon instanceof T.Weapon))throw new Error("Projectile with parasite warhead must have a weapon reference");n.parasiteableTrait.infest(this.fromObject,this.fromWeapon),c=!0}let h=!0;if(c&&(h=!1),r.rules.sonic&&(h=!1),r.rules.ivanBomb&&(h=!1,!n?.isTechno()||!n.tntChargeTrait||n.tntChargeTrait.hasCharge()||n.isDestroyed||n.warpedOutTrait.isInvulnerable()||(t=o.rules.combatDamage.ivanTimedDelay,n.tntChargeTrait.setCharge(t,o.currentTick,{player:this.fromPlayer}))),r.rules.bombDisarm&&(h=!1,n?.isTechno()&&n.tntChargeTrait?.hasCharge()&&!n.isDestroyed&&n.tntChargeTrait.removeCharge()),r.rules.mindControl&&(h=!1,this.fromObject&&!this.fromObject.isDestroyed&&n?.isTechno()&&n.mindControllableTrait&&!n.mindControllableTrait?.isActive()&&!o.areFriendly(n,this.fromObject)&&r.canDamage(n,l,s)&&!n.invulnerableTrait.isActive()&&this.fromObject.mindControllerTrait.control(n,o)),r.rules.temporal&&(h=!1,this.fromObject&&!this.fromObject.isDestroyed&&n?.isTechno()&&r.canDamage(n,l,s)&&!n.invulnerableTrait.isActive()&&(r.inflictDamage(0,n,{player:this.fromPlayer,weapon:i,obj:this.fromObject},o),this.fromObject.temporalTrait.updateTarget(n,i,o))),r.rules.makesDisguise&&(h=!1,this.fromObject&&!this.fromObject.isDestroyed&&(this.fromObject.isInfantry()||this.fromObject.isVehicle())&&n?.isUnit()&&n.type===this.fromObject.type&&this.fromObject.disguiseTrait?.disguiseAs(n,this.fromObject,o)),r.rules.electricAssault&&(this.fromObject?.isUnit()&&!this.fromObject.isDestroyed&&n?.isBuilding()&&!n.isDestroyed&&n.overpoweredTrait&&n.owner===this.fromPlayer&&n.overpoweredTrait.chargeFrom(this.fromObject),h=!1),h&&r.detonate(o,a,l,this.tileElevation,this.position.worldPosition,s,e,this.target,{player:this.fromPlayer,weapon:i,obj:this.fromObject},this.isShrapnel,!1,this.impactAnim),r.rules.nukeMaker){let e;e=this.fromObject?(u=T.Weapon.factory(T.Weapon.NUKE_PAYLOAD_NAME,v.WeaponType.Primary,this.fromObject,o.rules),o.createProjectile(u.projectileRules.name,this.fromObject,u,this.target,!1)):o.createLooseProjectile(T.Weapon.NUKE_PAYLOAD_NAME,this.fromPlayer,this.target),e.isNuke=!0,e.impactAnim="NUKEBALL";var u=this.target.tile;e.position.moveToTileCoords(u.rx+.5,u.ry+.5),e.position.tileElevation=this.position.tileElevation,o.spawnObject(e,u)}if(this.rules.shrapnelCount&&this.rules.shrapnelWeapon&&((this.target.obj?!this.target.obj.isBuilding():o.map.getGroundObjectsOnTile(this.target.tile).some(e=>e.isTerrain())&&!i.projectileRules.isAntiAir)||this.isShrapnel)){let t=o.rules.getWeapon(this.rules.shrapnelWeapon);var d,g=o.rules.getProjectile(t.projectile);let e=this.rules.shrapnelCount,i=new E.RangeHelper(o.map.tileOccupation),r=new C.RadialTileFinder(o.map.tiles,o.map.mapBounds,l,{width:1,height:1},1,t.range,e=>i.isInTileRange(l,e,t.minimumRange,t.range)),s=new Set;for(;0<Math.floor(e);){var p,m=r.getNextTile();if(!m)break;for(p of o.map.tileOccupation.getObjectsOnTileByLayer(m,g.isAntiAir?w.LayerType.Air:w.LayerType.Ground).filter(e=>o.isValidTarget(e)&&(e.isTerrain()||e.isTechno()&&e.owner!==this.fromPlayer&&!o.alliances.areAllied(e.owner,this.fromPlayer)&&!(e.isInfantry()&&e.stance===R.StanceType.Paradrop))))if(!s.has(p)&&(s.add(p),e=Math.max(0,e-1-(p.isTechno()?.5:0)),Math.floor(e)<=0))break}for(d of s){var f=o.createTarget(d.isTerrain()?void 0:d,d.tile);this.createShrapnel(o,f,t.name)}e=Math.floor(e);let a=new O.RandomTileFinder(o.map.tiles,o.map.mapBounds,l,t.range,o,e=>i.isInTileRange(l,e,t.minimumRange,t.range));for(let n=0;n<e;n++){var y=a.getNextTile();if(!y)break;y=o.createTarget(void 0,y);this.createShrapnel(o,y,t.name)}}if(i.rules.limboLaunch&&!c&&this.fromObject?.isUnit()){let s=this.fromObject;r.rules.parasite&&(this.target.obj.isVehicle()||this.target.obj?.isAircraft())&&this.target.obj.parasiteableTrait&&(this.target.obj.parasiteableTrait.beingBoarded=!1);let t,a;i=s.rules.movementZone===M.MovementZone.Fly;if(i)t=l,a=!1;else{let i=this.target.obj.isUnit()&&this.target.obj.tile.onBridgeLandType&&!this.target.obj.onBridge?void 0:o.map.tileOccupation.getBridgeOnTile(l),r=new P.MovePositionHelper(o.map),e=new C.RadialTileFinder(o.map.tiles,o.map.mapBounds,l,{width:1,height:1},0,1,e=>{var t=o.map.tileOccupation.getBridgeOnTile(e);return 0<o.map.terrain.getPassableSpeed(e,s.rules.speedType,!!t)&&r.isEligibleTile(e,t,i,l)&&(e===l||!o.map.terrain.findObstacles({tile:e,onBridge:i},s).length)});t=e.getNextTile(),a=!!t?.onBridgeLandType}t?(!i&&this.target.obj.isUnit()&&(s.onBridge=a,s.position.tileElevation=a?o.map.tileOccupation.getBridgeOnTile(t)?.tileElevation??0:0),o.unlimboObject(s,t),s.isInfantry()&&(s.position.subCell=this.target.obj.position.subCell),s.direction=this.direction):s.owner.removeOwnedObject(s)}}createShrapnel(e,t,i){let r=e.createLooseProjectile(i,this.fromPlayer,t);r.isShrapnel=!0,r.veteranDamageMult=this.veteranDamageMult,r.position.moveToLeptons(this.position.getMapPosition()),r.position.tileElevation=this.position.tileElevation,e.spawnObject(r,r.position.tile)}computeAimPointVersusMovingTarget(t,e,i,r){let s=t.position.worldPosition,a=s.clone();var n=e,o=t.moveTrait.velocity.length();if(n<3*o)return s.clone();let l=h.TargetUtil.computeInterceptPoint(i,n,s,t.moveTrait.velocity);if(l.length()){let e=l.clone().sub(s);n=e.length(),o=o,n=o?Math.ceil(n/o):0;if(l=s.clone().add(e.setLength(n*o)),r.isWithinHardBounds(l))if(t.zone!==c.ZoneType.Air){l.multiplyScalar(1/S.Coords.LEPTONS_PER_TILE);let e=t.position.clone();e.moveToTileCoords(l.x,l.z),a=e.worldPosition}else a=l;else a=s}return a.clone()}},t("Projectile",l)}}}),System.register("game/trait/interface/NotifyHealthChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyHealthChange",i)}}}),System.register("game/event/InflictDamageEvent",["game/event/EventType"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("InflictDamageEvent",i=class{constructor(e,t,i,r,s){this.target=e,this.attacker=t,this.damageHitPoints=i,this.currentHealth=r,this.prevHealth=s,this.type=a.EventType.InflictDamage}})}}}),System.register("game/gameobject/trait/interface/NotifyHealthChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyHealthChange",i)}}}),System.register("game/gameobject/unit/HealthLevel",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Green=0]="Green",e[e.Yellow=1]="Yellow",e[e.Red=2]="Red",t("HealthLevel",i)}}}),System.register("game/event/HealthChangeEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("HealthChangeEvent",i=class{constructor(e,t,i){this.target=e,this.currentHealth=t,this.prevHealth=i,this.type=r.EventType.HealthChange}})}}}),System.register("game/gameobject/trait/HealthTrait",["util/math","game/gameobject/trait/interface/NotifyDamage","game/trait/interface/NotifyHealthChange","game/event/InflictDamageEvent","game/gameobject/trait/interface/NotifyHealthChange","game/gameobject/trait/interface/NotifyHeal","game/gameobject/unit/HealthLevel","game/gameobject/trait/interface/NotifyTick","game/event/HealthChangeEvent"],function(e,t){"use strict";var i,a,r,n,s,o,l,c,h,u;t&&t.id;return{setters:[function(e){i=e},function(e){a=e},function(e){r=e},function(e){n=e},function(e){s=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){u=class{constructor(e,t,i,r){this.maxHitPoints=e,this.gameObject=t,this.conditionYellow=i,this.conditionRed=r,this.setHitPoints(e),this.projectedHitPoints=this.hitPoints}get health(){return this._computedHealth}set health(e){this.setHitPoints(0<e?Math.max(1,Math.floor(e*this.maxHitPoints/100)):0),this.projectedHitPoints=this.hitPoints}get level(){return this.health>100*this.conditionYellow?l.HealthLevel.Green:this.health>100*this.conditionRed?l.HealthLevel.Yellow:l.HealthLevel.Red}setHitPoints(e){if(e!==Math.floor(e))throw new Error(`Value ${e} is not an integer`);this.hitPoints=i.clamp(e,0,this.maxHitPoints),this._computedHealth=this.hitPoints/this.maxHitPoints*100}getHitPoints(){return this.hitPoints}getProjectedHitPoints(){return this.projectedHitPoints}inflictDamage(t,i,r){var e=this.hitPoints,s=this.health;this.applyHitPoints(e-t,r),e!==this.hitPoints&&0<t&&(this.gameObject.traits.filter(a.NotifyDamage).forEach(e=>{e[a.NotifyDamage.onDamage](this.gameObject,r,t,i)}),r.events.dispatch(new n.InflictDamageEvent(this.gameObject,i,t,this.health,s)))}healBy(e,i,r){if(e<0)throw new Error("Can't heal by negative value "+e);if(this.hitPoints<this.maxHitPoints){var s=this.hitPoints;this.applyHitPoints(this.hitPoints+e,r),this.projectedHitPoints=this.hitPoints;let t=this.hitPoints-s;this.gameObject.traits.filter(o.NotifyHeal).forEach(e=>{e[o.NotifyHeal.onHeal]?.(this.gameObject,r,t,i)})}}healToFull(i,r){if(this.hitPoints<this.maxHitPoints){var e=this.hitPoints;this.applyHitPoints(this.maxHitPoints,r),this.projectedHitPoints=this.hitPoints;let t=this.hitPoints-e;this.gameObject.traits.filter(o.NotifyHeal).forEach(e=>{e[o.NotifyHeal.onHeal]?.(this.gameObject,r,t,i)})}}applyHitPoints(e,t){let i=this.health;this.setHitPoints(e),i!==this.health&&(t.traits.filter(r.NotifyHealthChange).forEach(e=>{e[r.NotifyHealthChange.onChange](this.gameObject,t,i)}),this.gameObject.traits.filter(s.NotifyHealthChange).forEach(e=>{e[s.NotifyHealthChange.onChange](this.gameObject,t,i)}),t.events.dispatch(new h.HealthChangeEvent(this.gameObject,this.health,i)))}projectDamage(e){if(e<0)throw new Error("Projected damage must be positive");this.projectedHitPoints=Math.max(-30,this.projectedHitPoints-e)}[c.NotifyTick.onTick](e,t){t.currentTick%4==0&&(this.projectedHitPoints=Math.min(this.projectedHitPoints+1,this.hitPoints))}getHash(){return this.hitPoints}debugGetState(){return{hitPoints:this.hitPoints}}dispose(){this.gameObject=void 0}},e("HealthTrait",u)}}}),System.register("game/gameobject/trait/BridgeTrait",["game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/infantry/InfDeathType","game/type/LandType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType"],function(e,t){"use strict";var i,r,s,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class h{constructor(e){this.bridges=e,this.needsImageUpdate=!1,this.dominoHandled=!1}[i.NotifyDamage.onDamage](){this.needsImageUpdate=!0}[r.NotifyTick.onTick](e){this.needsImageUpdate&&(this.needsImageUpdate=!1,this.bridges.handlePieceHealthChange(this.bridges.getPieceAtTile(e.tile)))}[s.NotifyDestroy.onDestroy](r,s,a){var e=this.bridges.getPieceAtTile(r.tile);this.dominoHandled||this.bridges.findDominoPieces(e).filter(e=>!e.obj.isDestroyed).forEach(e=>{e.obj.traits.get(h).dominoHandled=!0,s.destroyObject(e.obj,a)});let t=s.map.tileOccupation.calculateTilesForGameObject(r.tile,r);t.forEach(e=>{let t=o.getLandType(e.terrainType),i=s.rules.getLandRules(t);s.map.getGroundObjectsOnTile(e).forEach(e=>{e.isUnit()&&e.onBridge&&!e.isDestroyed&&(r.isLowBridge()&&0<i.getSpeedModifier(e.rules.speedType)||e.isInfantry()&&e.stance===c.StanceType.Paradrop?(e.onBridge=!1,e.zone=l.getZoneType(t)):(e.isInfantry()&&(e.infDeathType=n.InfDeathType.None),s.destroyObject(e,a,!0)))})})}},e("BridgeTrait",h)}}}),System.register("game/map/OreSpread",["game/map/OreOverlayTypes","engine/type/OverlayTibType"],function(e,t){"use strict";var s,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e}],execute:function(){e("OreSpread",i=class{static calculateOverlayId(e,t){if(e!==a.OverlayTibType.NotSpecial){var i=t.dx,r=t.dy,i=Math.floor((r-9)/2%12*((r-8)/2%12)%12-(i-13)/2%12*((i-12)/2%12)%12+12e4);return i%=12,e===a.OverlayTibType.Ore?s.OreOverlayTypes.minIdRiparius+i:e===a.OverlayTibType.Gems?s.OreOverlayTypes.minIdCruentus+i:e===a.OverlayTibType.Vinifera?s.OreOverlayTypes.minIdVinifera+i:e===a.OverlayTibType.Aboreus?s.OreOverlayTypes.minIdAboreus+i:void 0}}})}}}),System.register("game/gameobject/trait/TiberiumTreeTrait",["game/gameobject/trait/interface/NotifyTick","game/map/tileFinder/RadialTileFinder","game/type/LandType","engine/type/ObjectType","game/map/OreSpread","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait"],function(t,e){"use strict";var i,l,c,h,u,d,g,r,s;e&&e.id;return{setters:[function(e){i=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){var e;(e=r=r||{})[e.Idle=0]="Idle",e[e.Spawning=1]="Spawning",t("SpawnStatus",r),s=class{constructor(e){this.rules=e,this.ticksSinceLastSpawn=0,this.cooldownTicks=Math.floor(1/this.rules.animationProbability),this.status=r.Idle}[i.NotifyTick.onTick](e,t){this.status=r.Idle,this.ticksSinceLastSpawn++>this.cooldownTicks&&(this.ticksSinceLastSpawn=0,this.status=r.Spawning,this.spawnTiberium(e.tile,t))}spawnTiberium(i,r){for(let o=1;o<=2;o++){let e=new l.RadialTileFinder(r.map.tiles,r.map.mapBounds,i,{width:1,height:1},o,o,e=>g.TiberiumTrait.canBePlacedOn(e,r.map));var s=e.getNextTile();if(s){var a=u.OreSpread.calculateOverlayId(d.OverlayTibType.Ore,s);if(void 0===a)throw new Error("Expected an overlayId");let e=r.createObject(h.ObjectType.Overlay,r.rules.getOverlayName(a));return e.overlayId=a,e.value=3,void r.spawnObject(e,s)}e=new l.RadialTileFinder(r.map.tiles,r.map.mapBounds,i,{width:1,height:1},o,o,e=>e.landType===c.LandType.Tiberium);let t;for(;!t;){var n=e.getNextTile();if(!n)break;t=r.map.getObjectsOnTile(n).find(e=>e.isOverlay()&&e.isTiberium()&&e.traits.get(g.TiberiumTrait).getBailCount()+1<=g.TiberiumTrait.maxBails)}if(t)return void t.traits.get(g.TiberiumTrait).spawnBails(1)}}},t("TiberiumTreeTrait",s)}}}),System.register("game/gameobject/trait/AutoRepairTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed"],function(e,t){"use strict";var i,r,n,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){n=e}],execute:function(){s=class{constructor(e=!1){this.freeRepair=e,this.disabled=!0,this.cooldownTicks=0,this.healLeftover=0}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}[i.NotifyTick.onTick](t,i){if(!this.isDisabled())if(100===t.healthTrait.health&&this.setDisabled(!0),this.cooldownTicks<=0){var r=i.rules.general.repair,s=t.isInfantry()?r.iRepairRate:t.isBuilding()?r.repairRate:r.uRepairRate;this.cooldownTicks+=n.GameSpeed.BASE_TICKS_PER_SECOND*s*60;var a=t.isInfantry()?r.iRepairStep:r.repairStep,s=this.freeRepair?0:r.repairPercent;let e;s?(r=s*t.purchaseValue/t.healthTrait.maxHitPoints,(s=Math.min(t.owner.credits,Math.max(1,Math.floor(r*a))))?(e=r?s/r:a,t.owner.credits-=s):(e=0,this.setDisabled(!0))):e=a,e&&(e+=this.healLeftover,e=Math.min(t.healthTrait.maxHitPoints-t.healthTrait.getHitPoints(),e),e&&(a=Math.floor(e),this.healLeftover=e-a,a&&t.healthTrait.healBy(a,t,i)))}else this.cooldownTicks--}[r.NotifyOwnerChange.onChange](){this.setDisabled(!0)}},e("AutoRepairTrait",s)}}}),System.register("game/trait/interface/NotifyTargetDestroy",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onDestroy=Symbol(),e("NotifyTargetDestroy",i)}}}),System.register("game/event/UnitPromoteEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("UnitPromoteEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.UnitPromote}})}}}),System.register("game/gameobject/trait/SelfHealingTrait",["game/gameobject/trait/interface/NotifyTick","game/GameSpeed"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.cooldownTicks=0}[i.NotifyTick.onTick](e,t){100!==e.healthTrait.health&&(this.cooldownTicks<=0?(this.cooldownTicks+=r.GameSpeed.BASE_TICKS_PER_SECOND*t.rules.general.repair.repairRate*60,e.healthTrait.healBy(1,e,t)):this.cooldownTicks--)}},e("SelfHealingTrait",s)}}}),System.register("game/event/ObjectCloakChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectCloakChangeEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.ObjectCloakChange}})}}}),System.register("game/gameobject/trait/CloakableTrait",["game/event/ObjectCloakChangeEvent","game/GameSpeed","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class{constructor(e,t){this.gameObject=e,this.cloakDelayMinutes=t,this.isActive=!1,this.resetCloakCooldown()}isCloaked(){return this.isActive}uncloak(e){var t=this.isActive;this.resetCloakCooldown(),t&&(this.isActive=!1,e.events.dispatch(new i.ObjectCloakChangeEvent(this.gameObject)))}resetCloakCooldown(){this.cooldownTicks=Math.floor(60*this.cloakDelayMinutes*r.GameSpeed.BASE_TICKS_PER_SECOND)}[a.NotifySpawn.onSpawn](e,t){this.resetCloakCooldown()}[n.NotifyTick.onTick](e,t){0<this.cooldownTicks&&this.cooldownTicks--,!(this.cooldownTicks<=0)||this.isActive||e.isVehicle()&&e.submergibleTrait&&!e.submergibleTrait.isSubmerged()||e.temporalTrait.getTarget()||(this.isActive=!0,t.events.dispatch(new i.ObjectCloakChangeEvent(this.gameObject)))}[s.NotifyDamage.onDamage](e,t){this.uncloak(t)}dispose(){this.gameObject=void 0}},e("CloakableTrait",o)}}}),System.register("game/gameobject/trait/ArmedTrait",["game/Weapon","game/WeaponType","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/VeteranLevel","util/typeGuard"],function(e,t){"use strict";var a,n,i,r,s,o,l;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){o=e}],execute:function(){l=class{constructor(e,t){this.gameObject=e,this.rules=t,this.specialWeaponIndex=0;var i=e.veteranLevel===s.VeteranLevel.Elite;e.rules.weaponCount?(this.selectSpecialWeapon(0,i),this.guardWeaponRangeOverride=this.primaryWeapon?.range):this.selectStandardWeapons(i)}selectStandardWeapons(e=!1){var t=this.gameObject,i=e&&t.rules.elitePrimary||t.rules.primary;i?(s=e?t.art.elitePrimaryFireFlh:t.art.primaryFireFlh,this.primaryWeapon=a.Weapon.factory(i,n.WeaponType.Primary,t,this.rules,s)):this.primaryWeapon=void 0;var r,s=e&&t.rules.eliteSecondary||t.rules.secondary;s?(r=e?t.art.eliteSecondaryFireFlh:t.art.secondaryFireFlh,this.secondaryWeapon=a.Weapon.factory(s,n.WeaponType.Secondary,t,this.rules,r)):this.secondaryWeapon=void 0,(t.explodes||t.crashableTrait)&&(r=t.rules.deathWeapon||!!t.crashableTrait&&this.secondaryWeapon?.rules.name||this.primaryWeapon?.rules.name||this.rules.combatDamage.deathWeapon,this.deathWeapon=a.Weapon.factory(r,n.WeaponType.DeathWeapon,t,this.rules))}selectSpecialWeapon(e,t=!1){let i=this.gameObject;var r=i.rules.weaponCount;if(r<1)throw new Error(`Object "${i.name}" doesn't support special weapons`);if(r-1<e)throw new RangeError(`Weapon index ${e} out of bounds (max ${r}) for object `+i.name);var s=t&&i.rules.getEliteWeaponAtIndex(e)||i.rules.getWeaponAtIndex(e);if(!s)throw new Error(`Missing weapon at index ${e} for object "${i.name}"`);r=i.art.getSpecialWeaponFlh(e);this.primaryWeapon=a.Weapon.factory(s,n.WeaponType.Primary,i,this.rules,r),this.secondaryWeapon=void 0,this.specialWeaponIndex=e,this.deathWeapon=this.primaryWeapon.rules.suicide?a.Weapon.factory(i.rules.deathWeapon||this.primaryWeapon.name,n.WeaponType.DeathWeapon,i,this.rules):void 0}toggleEliteWeapons(e){this.gameObject.rules.weaponCount?this.selectSpecialWeapon(this.specialWeaponIndex,e):this.selectStandardWeapons(e)}getSpecialWeaponIndex(){return this.specialWeaponIndex}computeGuardScanRange(t){var e=this.guardWeaponRangeOverride??[this.primaryWeapon,this.secondaryWeapon].filter(e=>e===t||e?.rules.neverUse).reduce((e,t)=>Math.max(e,t.range),0),e=Math.max(e,this.gameObject.rules.guardRange);return Math.min(15,2*e-1)}getDeployFireWeapon(){if(this.gameObject.rules.deployFire)return this.gameObject.rules.deployFireWeapon===n.WeaponType.Primary?this.primaryWeapon:this.secondaryWeapon}isEquippedWithWeapon(e){return[this.primaryWeapon,this.secondaryWeapon].includes(e)}getWeapons(){return[this.primaryWeapon,this.secondaryWeapon].filter(o.isNotNullOrUndefined)}[i.NotifyTick.onTick](){this.primaryWeapon&&this.primaryWeapon.tick(),this.secondaryWeapon&&this.secondaryWeapon.tick()}[r.NotifyDestroy.onDestroy](t,e,i){!this.deathWeapon||i?.weapon?.warhead.rules.temporal||t.crashableTrait&&!t.isCrashing||i?.obj?.isVehicle()&&i.weapon?.rules.suicide&&i.obj.transportTrait?.units.find(e=>e===t)||this.deathWeapon.fire(e.createTarget(t,t.tile),e)}dispose(){this.gameObject=void 0,this.primaryWeapon=void 0,this.secondaryWeapon=void 0,this.deathWeapon=void 0}},e("ArmedTrait",l)}}}),System.register("game/gameobject/trait/SensorsTrait",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SensorsTrait",i=class{})}}}),System.register("game/gameobject/trait/VeteranTrait",["game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyTargetDestroy","game/event/UnitPromoteEvent","game/gameobject/unit/VeteranAbility","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SensorsTrait"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class{constructor(e,t){this.gameObject=e,this.veteranRules=t,this.veteranLevel=i.VeteranLevel.None,this.xp=0,this.promotionThresh=e.rules.cost*t.veteranRatio+1}[r.NotifyTargetDestroy.onDestroy](e,t,i,r){e.isDestroyed&&!e.isCrashing||t.isTechno()&&(t.rules.dontScore||t.rules.insignificant||(i&&(i.warhead.rules.temporal||i.warhead.rules.parasite&&e.rules.organic)||!r.areFriendly(e,t))&&(this.veteranLevel>=this.veteranRules.veteranCap||this.gainXP(t.rules.cost*(t.veteranLevel+1))&&this.handlePromotion(e,r)))}setRelativeXP(e){this.gainXP(Math.floor(e*this.promotionThresh))}gainXP(e){if(this.xp+=e,this.xp>=this.promotionThresh){var t=Math.min(this.veteranLevel+Math.floor(this.xp/this.promotionThresh),this.veteranRules.veteranCap),i=t-this.veteranLevel;if(i)return this.xp-=i*this.promotionThresh,this.setVeteranLevel(t),!0}return!1}promote(e,t){var i=Math.min(this.veteranLevel+e,this.veteranRules.veteranCap);i-this.veteranLevel&&(this.setVeteranLevel(i),this.handlePromotion(this.gameObject,t))}isMaxLevel(){return this.veteranLevel===this.veteranRules.veteranCap}isElite(){return this.veteranLevel===i.VeteranLevel.Elite}setVeteranLevel(e){this.veteranLevel=e,this.veteranLevel===i.VeteranLevel.Elite&&this.gameObject.armedTrait?.toggleEliteWeapons(!0)}handlePromotion(e,t){this.hasVeteranAbility(a.VeteranAbility.SELF_HEAL)&&(e.traits.find(n.SelfHealingTrait)||t.addObjectTrait(e,new n.SelfHealingTrait)),this.hasVeteranAbility(a.VeteranAbility.CLOAK)&&(e.cloakableTrait||(e.cloakableTrait=new o.CloakableTrait(e,t.rules.general.cloakDelay),t.addObjectTrait(e,e.cloakableTrait))),this.hasVeteranAbility(a.VeteranAbility.EXPLODES)&&(e.explodes||(e.explodes=!0,e.armedTrait||(e.armedTrait=new l.ArmedTrait(e,t.rules),t.addObjectTrait(e,e.armedTrait)))),this.hasVeteranAbility(a.VeteranAbility.RADAR_INVISIBLE)&&(e.radarInvisible||(e.radarInvisible=!0)),this.hasVeteranAbility(a.VeteranAbility.SENSORS)&&(e.sensorsTrait||(e.sensorsTrait=new c.SensorsTrait,t.addObjectTrait(e,e.sensorsTrait))),e.isInfantry()&&this.hasVeteranAbility(a.VeteranAbility.FEARLESS)&&e.suppressionTrait?.disable(),this.hasVeteranAbility(a.VeteranAbility.C4)&&(e.c4||(e.c4=!0)),this.hasVeteranAbility(a.VeteranAbility.GUARD_AREA)&&(e.defaultToGuardArea||(e.defaultToGuardArea=!0,e.unitOrderTrait.isIdle()&&e.resetGuardModeToIdle())),this.hasVeteranAbility(a.VeteranAbility.CRUSHER)&&(e.crusher||(e.crusher=!0)),t.events.dispatch(new s.UnitPromoteEvent(e))}getVeteranSightMultiplier(){return this.getVeteranAbilityMultiplier(a.VeteranAbility.SIGHT)}getVeteranSpeedMultiplier(){return this.getVeteranAbilityMultiplier(a.VeteranAbility.FASTER)}getVeteranArmorMultiplier(){return this.getVeteranAbilityMultiplier(a.VeteranAbility.STRONGER)}getVeteranDamageMultiplier(){return this.getVeteranAbilityMultiplier(a.VeteranAbility.FIREPOWER)}getVeteranRofMultiplier(){return this.getVeteranAbilityMultiplier(a.VeteranAbility.ROF)}hasVeteranAbility(e){return this.veteranLevel===i.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(e)||this.veteranLevel>=i.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(e)}getVeteranAbilityMultiplier(e){let t=1;return(this.veteranLevel===i.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(e)||this.veteranLevel>=i.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(e))&&(t=this.getVeteranRulesMultiplier(e)),t}getVeteranRulesMultiplier(e){switch(e){case a.VeteranAbility.FASTER:return this.veteranRules.veteranSpeed;case a.VeteranAbility.STRONGER:return this.veteranRules.veteranArmor;case a.VeteranAbility.FIREPOWER:return this.veteranRules.veteranCombat;case a.VeteranAbility.ROF:return this.veteranRules.veteranROF;case a.VeteranAbility.SIGHT:return this.veteranRules.veteranSight;default:throw new Error("Unhandled VeteranAbility "+e)}}dispose(){this.gameObject=void 0}},e("VeteranTrait",h)}}}),System.register("game/gameobject/trait/InvulnerableTrait",["game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.timer=new i.Timer}isActive(){return this.timer.isActive()}setActiveFor(e,t){this.timer.setActiveFor(e,t)}[r.NotifyTick.onTick](e,t){this.timer.tick(t.currentTick)}},e("InvulnerableTrait",s)}}}),System.register("game/trait/interface/NotifyWarpChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyWarpChange",i)}}}),System.register("game/gameobject/trait/WarpedOutTrait",["game/gameobject/trait/interface/NotifyWarpChange","game/trait/interface/NotifyWarpChange","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var r,s,i,a;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e}],execute:function(){a=class{constructor(e){this.gameObject=e,this.ticksWhenWarpedOut=!0,this.remainingTicks=0,this.invulnerable=!1}isActive(){return 0<this.remainingTicks}setActive(e,t,i){this.remainingTicks=e?Number.POSITIVE_INFINITY:0,this.invulnerable=t,this.notifyChange(e,i)}setTimed(e,t,i){this.remainingTicks=e,this.invulnerable=t,this.notifyChange(!0,i)}debugSetActive(e){this.remainingTicks=e?Number.POSITIVE_INFINITY:0}notifyChange(t,i){i.traits.filter(s.NotifyWarpChange).forEach(e=>{e[s.NotifyWarpChange.onChange](this.gameObject,i,t)}),this.gameObject.traits.filter(r.NotifyWarpChange).forEach(e=>{e[r.NotifyWarpChange.onChange](this.gameObject,i,t)})}expire(e){this.remainingTicks=0,this.notifyChange(!1,e)}isInvulnerable(){return this.isActive()&&this.invulnerable}[i.NotifyTick.onTick](e,t){0<this.remainingTicks&&(this.remainingTicks--,this.remainingTicks<=0&&this.notifyChange(!1,t))}dispose(){this.gameObject=void 0}},e("WarpedOutTrait",a)}}}),System.register("game/gameobject/trait/TntChargeTrait",["game/Coords","game/Warhead","game/gameobject/common/DeathType","game/gameobject/unit/CollisionType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var l,c,r,h,i,s,a,n;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){r=e},function(e){h=e},function(e){i=e},function(e){s=e},function(e){a=e}],execute:function(){n=class{constructor(){this.timer=new i.Timer}hasCharge(){return this.timer.isActive()}setCharge(e,t,i){this.hasCharge()||(this.timer.setActiveFor(e,t),this.attackerInfo=i)}getChargeOwner(){return this.attackerInfo?.player}removeCharge(){this.timer.reset()}getTicksLeft(){return this.timer.getTicksLeft()}getInitialTicks(){return this.timer.getInitialTicks()}[a.NotifyTick.onTick](e,t){this.timer.isActive()&&!0===this.timer.tick(t.currentTick)&&(e.isBuilding()&&e.cabHutTrait&&e.cabHutTrait.demolishBridge(t,this.attackerInfo),this.detonateIvanWarhead(t,e))}[s.NotifyDestroy.onDestroy](e,t,i){this.timer.isActive()&&!i?.weapon?.warhead.rules.ivanBomb&&e.deathType!==r.DeathType.None&&e.deathType!==r.DeathType.Temporal&&(this.timer.reset(),this.detonateIvanWarhead(t,e))}detonateIvanWarhead(e,t){var i=e.rules.combatDamage.ivanDamage;let r=new c.Warhead(e.rules.getWarhead(e.rules.combatDamage.ivanWarhead));var s=t.tile,a=t.tileElevation,n=t.isUnit()?t.zone:e.map.getTileZone(s),o=!!t.isUnit()&&t.onBridge;r.detonate(e,i,s,a,t.isBuilding()?l.Coords.tile3dToWorld(s.rx+.5,s.ry+.5,s.z+a):t.position.worldPosition,n,o?h.CollisionType.OnBridge:h.CollisionType.None,e.createTarget(t,s),{...this.attackerInfo,weapon:void 0},!1,!1,void 0)}},e("TntChargeTrait",n)}}}),System.register("game/gameobject/trait/MindControllableTrait",["game/gameobject/trait/interface/NotifyUnspawn"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class{constructor(e){this.gameObject=e}getOriginalOwner(){return this.prevOwner}isActive(){return!!this.controller}getController(){return this.controller}controlBy(e,t){if(this.controller)throw new Error(`Object "${this.gameObject?.name}" is already mind controlled by "${e.name}"`);this.controller=e,this.prevOwner=this.gameObject.owner,t.changeObjectOwner(this.gameObject,e.owner)}restore(e){this.prevOwner&&(e.changeObjectOwner(this.gameObject,this.prevOwner),this.prevOwner=void 0,this.controller=void 0)}[i.NotifyUnspawn.onUnspawn](e,t){this.controller&&(this.controller.mindControllerTrait.cleanTarget(e),!e.isDestroyed&&e.limboData&&this.restore(t))}dispose(){this.gameObject=void 0}},e("MindControllableTrait",r)}}}),System.register("game/gameobject/trait/MindControllerTrait",["game/gameobject/trait/interface/NotifyUnspawn"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class{constructor(e,t=1){this.gameObject=e,this.maxCapacity=t,this.targets=[]}isActive(){return 0<this.targets.length}isAtCapacity(){return this.targets.length===this.maxCapacity}getTargets(){return this.targets}control(e,t){if(!this.gameObject)throw new Error("Trait already disposed");if(!e.mindControllableTrait)throw new Error(`Target "${e.name}" cannot be mind controlled`);if(e.isDisposed)throw new Error(`Target "${e.name}" is disposed`);for(e.mindControllableTrait.controlBy(this.gameObject,t),this.targets.push(e);this.targets.length>this.maxCapacity;){let e=this.targets.shift();e.mindControllableTrait.restore(t)}}cleanTarget(e){var t=this.targets.indexOf(e);-1!==t&&this.targets.splice(t,1)}[i.NotifyUnspawn.onUnspawn](e,t){for(var i of this.targets)i.mindControllableTrait.restore(t);this.targets.length=0}dispose(){this.gameObject=void 0}},e("MindControllerTrait",r)}}}),System.register("game/gameobject/trait/TemporalTrait",["game/gameobject/common/DeathType","game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var a,s,n,i,r,o;t&&t.id;return{setters:[function(e){a=e},function(e){s=e},function(e){n=e},function(e){i=e},function(e){r=e}],execute:function(){o=class{constructor(e){this.gameObject=e,this.ticksWhenWarpedOut=!0,this.attackers=new Set}[r.NotifyTick.onTick](e,t){if(e.attackTrait&&(e.attackTrait.currentTarget&&!e.warpedOutTrait.isActive()||this.releaseCurrentTarget(t)),void 0!==this.eraseTicks)for(var i of this.attackers){var r=i.temporalTrait.currentWeapon;if(!r)throw new Error(`Attacker "${i.name}" is no longer targeting "${e.name}"`);var s=r.rules.damage;if(this.eraseTicks-=s,this.eraseTicks<=0){e.deathType=a.DeathType.Temporal,t.destroyObject(e,{player:i.owner,obj:i,weapon:r},!0),this.eraseTicks=void 0;break}}}getTarget(){return this.currentTarget}updateTarget(t,e,i){if(this.currentTarget!==t){this.releaseCurrentTarget(i),this.currentTarget=t,this.currentWeapon=e;var r=t.temporalTrait.attackers.size;if(t.temporalTrait.attackers.add(this.gameObject),!r){t.warpedOutTrait.setActive(!0,!0,i);let e=t.unitOrderTrait.getCurrentTask();(e&&e instanceof s.AttackTask||e instanceof n.MoveTask)&&e.cancel(),t.temporalTrait.eraseTicks=10*t.healthTrait.maxHitPoints}}}releaseCurrentTarget(t){if(this.currentTarget){if(!this.currentTarget.isDisposed){let e=this.currentTarget.temporalTrait.attackers;e.delete(this.gameObject),e.size||(this.currentTarget.warpedOutTrait.expire(t),this.currentTarget.temporalTrait.eraseTicks=void 0)}this.currentTarget=void 0,this.currentWeapon=void 0}}[i.NotifyDestroy.onDestroy](e,t){this.releaseCurrentTarget(t)}dispose(){this.gameObject=void 0,this.attackers.clear()}},e("TemporalTrait",o)}}}),System.register("game/gameobject/trait/AirSpawnTrait",["game/Coords","engine/type/ObjectType","game/Warhead","game/gameobject/unit/CollisionType","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/ZoneType"],function(e,t){"use strict";var c,h,l,u,d,g,p,m,i,r,s,a,n,o,f,y,T;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){l=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){f=e},function(e){y=e}],execute:function(){T=class{constructor(){this.spawns=[],this.storage=[],this.missileLaunches=[],this.nextRegenTicks=[]}get availableSpawns(){return this.storage.length}debugSetStorage(e,t){this.storage.length=t,this.storage.fill(e,0,t)}isLaunchingMissiles(){return 0<this.missileLaunches.length}[s.NotifySpawn.onSpawn](e,t){var i=t.rules.getObject(e.rules.spawns,h.ObjectType.Aircraft);for(let r=0;r<e.rules.spawnsNumber;r++)this.pushNewSpawn(i,t,e)}[o.NotifyUnspawn.onUnspawn](e,t){this.destroySpawns(e,t)}[i.NotifyDestroy.onDestroy](e,t,i,r){this.destroySpawns(e,t,i,r)}pushNewSpawn(e,t,i){let r=t.createUnitForPlayer(e,i.owner);r.limboData={selected:!1,controlGroup:void 0},e.missileSpawn&&(r.pitch=90*t.rules.general.getMissileRules(e.name).pitchInitial),this.spawns.push(r),this.storage.push(r)}destroySpawns(e,t,i,r){for(var s of this.spawns)s.isDestroyed||(s.isSpawned&&!s.rules.missileSpawn&&s.crashableTrait?s.crashableTrait.crash(i):(s.isSpawned||(s.armedTrait&&(s.armedTrait.deathWeapon=void 0),s.position.tileElevation=e.position.tileElevation,s.zone=e.isUnit()?e.zone:y.ZoneType.Ground,s.onBridge=!!e.isUnit()&&e.onBridge,s.position.tile=e.tile),t.destroyObject(s,i,r)));this.spawns.length=0,this.storage.length=0,this.missileLaunches.length=0}[n.NotifyTick.onTick](r,s){var t;if(this.spawns=this.spawns.filter(e=>!e.isDestroyed),this.missileLaunches=this.missileLaunches.filter(e=>!e.missile.isDestroyed),this.spawns.length<r.rules.spawnsNumber){var i=r.rules.spawnsNumber-this.spawns.length,a=s.rules.getObject(r.rules.spawns,h.ObjectType.Aircraft);for(let e=0;e<i;e++)a.missileSpawn&&e&&void 0===this.nextRegenTicks[e]?this.nextRegenTicks[e]=this.nextRegenTicks[0]:((t=this.nextRegenTicks)[e]??(t[e]=r.rules.spawnRegenRate),0<this.nextRegenTicks[e]&&this.nextRegenTicks[e]--),this.nextRegenTicks[e]<=0&&this.pushNewSpawn(a,s,r);this.nextRegenTicks=this.nextRegenTicks.filter(e=>0<e)}if(this.storage.length){if(this.nextReloadTicks??(this.nextReloadTicks=r.rules.spawnReloadRate),0<this.nextReloadTicks&&this.nextReloadTicks--,this.nextReloadTicks<=0){for(var e of this.storage)e.ammoTrait&&e.ammoTrait.ammo<e.ammoTrait.maxAmmo&&e.ammoTrait.ammo++;this.nextReloadTicks=r.rules.spawnReloadRate}}else this.nextReloadTicks=void 0;for(let l of this.missileLaunches.slice()){var n=s.rules.general.getMissileRules(l.missile.name);if(l.pauseFrames??(l.pauseFrames=n.pauseFrames),0<l.pauseFrames&&l.pauseFrames--,l.pauseFrames<=0){var o=90*n.pitchFinal,n=90*(n.pitchFinal-n.pitchInitial)/n.tiltFrames;let i=l.missile;if(i.pitch<o)i.pitch=Math.min(o,i.pitch+n);else{i.unitOrderTrait.addTask(new p.TaskGroup(new d.MoveTask(s,l.targetTile,!!l.targetBridge),new g.CallbackTask(()=>{var e,t;i.isDestroyed||(s.unspawnObject(i),i.dispose(),t=c.Coords.vecGroundToWorld(m.FacingUtil.toMapCoords(i.direction).multiplyScalar(1)),e=l.targetWorldPos.clone().add(t),t=s.map.getTileZone(l.targetTile),l.warhead.detonate(s,l.damage,l.targetTile,l.targetBridge?.tileElevation??0,e,t,l.targetBridge?u.CollisionType.OnBridge:u.CollisionType.None,l.target,{player:i.owner,obj:r,weapon:void 0},!1,!1,void 0))})).setCancellable(!1));n=this.spawns.indexOf(i);if(-1===n)throw new Error("Missile not found in spawns list");this.spawns.splice(n,1),this.missileLaunches.splice(this.missileLaunches.indexOf(l),1)}}}}[r.NotifyOwnerChange.onChange](e,t,i){for(var r of this.spawns)r.isDestroyed||i.changeObjectOwner(r,e.owner)}[f.NotifyWarpChange.onChange](e,t,i){i&&this.removeMissileLaunches(t)}[a.NotifyTeleport.onBeforeTeleport](e,t,i,r){r||this.removeMissileLaunches(t)}removeMissileLaunches(e){if(this.missileLaunches.length){for(var t of this.missileLaunches){e.unspawnObject(t.missile),t.missile.dispose();t=this.spawns.indexOf(t.missile);if(-1===t)throw new Error("Missile not found in spawns list");this.spawns.splice(t,1)}this.missileLaunches.length=0}}prepareLaunch(r,s,a){if(this.storage.length){let i=this.storage[0];if(!i.ammo)return;if(this.storage.shift(),i.missileSpawnTrait){let e,t;var n=r.veteranTrait?.isElite(),o=a.rules;if(r.rules.spawns===o.general.v3Rocket.type)e=n?o.combatDamage.v3EliteWarhead:o.combatDamage.v3Warhead,t=n?o.general.v3Rocket.eliteDamage:o.general.v3Rocket.damage;else{if(r.rules.spawns!==o.general.dMisl.type)throw new Error(`Unhandled missile type "${r.rules.spawns}"`);e=n?o.combatDamage.dMislEliteWarhead:o.combatDamage.dMislWarhead,t=n?o.general.dMisl.eliteDamage:o.general.dMisl.damage}o=new l.Warhead(a.rules.getWarhead(e));i.missileSpawnTrait.setDamage(t).setWarhead(o).setLauncher(r),this.missileLaunches.push({missile:i,targetTile:(s.obj?.isUnit()?s.obj:s).tile,targetBridge:s.getBridge(),targetWorldPos:s.getWorldCoords().clone(),target:s,warhead:o,damage:t,pauseFrames:void 0})}else{if(!i.spawnLinkTrait)throw new Error(`Aircraft "${i.name}" must have Spawned=yes to be launchable`);i.spawnLinkTrait.setParent(r)}return i}}storeAircraft(e,t){if(!this.spawns.includes(e))throw new Error(`Object "${e.name}#${e.id}" not found in list of linked spawns`);if(e.limboData)throw new Error(`Object "${e.name}#${e.id}" is already in limbo`);t.limboObject(e,{selected:!1,controlGroup:void 0}),this.storage.push(e)}},e("AirSpawnTrait",T)}}}),System.register("game/gameobject/trait/SpawnDebrisTrait",["engine/type/ObjectType","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyCrash","game/gameobject/trait/interface/NotifyDestroy"],function(e,t){"use strict";var a,r,i,s,n;t&&t.id;return{setters:[function(e){a=e},function(e){r=e},function(e){i=e},function(e){s=e}],execute:function(){n=class{[i.NotifyCrash.onCrash](e,t){this.handleDestroy(e,t)}[s.NotifyDestroy.onDestroy](e,t,i){i?.weapon?.warhead.rules.temporal||e.isCrashing||e.deathType!==r.DeathType.Sink&&e.isSpawned&&this.handleDestroy(e,t)}handleDestroy(e,t){var i,r;(e.isVehicle()||e.isBuilding()||e.isOverlay())&&(i=e.isOverlay()?0:e.rules.minDebris,r=e.isOverlay()?t.rules.general.bridgeVoxelMax:e.rules.maxDebris,0<(r=t.generateRandomInt(i,r))&&this.spawnDebris(e,t,r))}spawnDebris(t,i,r){let s=t.position.getMapPosition();if(i.map.isWithinHardBounds(s)){let e=t.isOverlay()?[]:t.isVehicle()?t.rules.debrisTypes:t.rules.debrisAnims;e.length||(e=i.rules.audioVisual.metallicDebris),e=e.filter(e=>i.rules.hasObject(e,a.ObjectType.VoxelAnim)||i.art.hasObject(e,a.ObjectType.Animation)),new Array(r).fill(0).map(()=>e[i.generateRandomInt(0,e.length-1)]).map(e=>i.createObject(a.ObjectType.Debris,e)).forEach(e=>{e.position.moveToLeptons(s),e.position.tileElevation=t.position.tileElevation,i.spawnObject(e,e.position.tile)})}}},e("SpawnDebrisTrait",n)}}}),System.register("game/gameobject/Debris",["game/gameobject/GameObject","engine/type/ObjectType","game/gameobject/unit/ZoneType","game/Warhead","game/gameobject/unit/FacingUtil","game/gameobject/common/AnimTerrainEffect","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector3","util/math"],function(e,t){"use strict";var i,s,o,l,a,c,n,h,u,r,d;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){o=e},function(e){l=e},function(e){a=e},function(e){c=e},function(e){n=e},function(e){h=e},function(e){u=e},function(e){r=e}],execute:function(){d=class extends i.GameObject{constructor(e,t,i,r){super(s.ObjectType.Debris,e,t,i),this.age=0,this.direction=0,this.rotationAxis=new u.Vector3,this.angularVelocity=0,this.zone=o.ZoneType.Air,this.velocity=new u.Vector3,this.collisionHelper=new n.CollisionHelper(r)}static factory(e,t,i,r){return new this(e,t,i,r)}onSpawn(e){super.onSpawn(e),this.direction=e.generateRandomInt(0,359),this.xySpeed=r.lerp(0,this.rules.maxXYVel,e.generateRandom()),this.zSpeed=r.lerp(this.rules.minZVel,this.rules.maxZVel||1.5*this.rules.minZVel,e.generateRandom()),this.rotationAxis.set(e.generateRandom(),e.generateRandom(),e.generateRandom()).normalize(),this.angularVelocity=r.lerp(this.rules.minAngularVelocity,this.rules.maxAngularVelocity,e.generateRandom())}update(t){if(super.update(t),this.age++,this.rules.duration&&this.age>this.rules.duration)return this.velocity.set(0,0,0),void this.detonate(t);--this.zSpeed;var e=a.FacingUtil.toMapCoords(this.direction).setLength(this.xySpeed);let i=new u.Vector3(e.x,this.zSpeed,e.y);var r=this.position.clone(),e=i.clone().add(this.position.worldPosition);if(t.map.isWithinHardBounds(e)){this.position.moveByLeptons3(i);let e=!1;r=this.collisionHelper.checkCollisions(this.position,r,{cliffs:!0,ground:!0,shore:!1,walls:!0,buildings:!1});r&&(!([h.CollisionType.Ground,h.CollisionType.OnBridge].includes(r)&&0<this.rules.elasticity&&t.map.getTileZone(this.tile)!==o.ZoneType.Water)||Math.abs(this.zSpeed)<1?e=!0:(this.zSpeed=-this.zSpeed*this.rules.elasticity,this.velocity.y=-this.velocity.y*this.rules.elasticity,this.rotationAxis.negate())),e?(this.velocity.set(0,0,0),this.detonate(t,r)):this.velocity.copy(i)}else t.unspawnObject(this)}detonate(t,i=h.CollisionType.None){var e,r=this.rules.warhead?t.rules.getWarhead(this.rules.warhead):void 0,s=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,i);let a;s===o.ZoneType.Water?(e=t.rules.combatDamage.splashList,a=e[0]):(e=this.rules.expireAnim)&&t.rules.animationNames.has(e)&&(a=e),this.explodeAnim=a;let n=new c.AnimTerrainEffect;if(a&&n.spawnSmudges(a,this.tile,t),t.destroyObject(this),r){let e=new l.Warhead(r);e.detonate(t,this.rules.damage,this.tile,this.tileElevation,this.position.worldPosition,s,i,t.createTarget(void 0,this.tile),void 0,!1,!1,void 0,this.rules.damageRadius||void 0,!0)}}},e("Debris",d)}}}),System.register("game/gameobject/ObjectFactory",["engine/type/ObjectType","game/gameobject/Building","game/gameobject/Terrain","game/gameobject/Overlay","game/gameobject/Smudge","game/gameobject/Infantry","game/gameobject/Vehicle","game/gameobject/Aircraft","game/art/ObjectArt","data/IniSection","game/gameobject/trait/UnitOrderTrait","game/gameobject/ObjectPosition","game/gameobject/trait/AttackTrait","game/gameobject/Projectile","game/gameobject/trait/DeployerTrait","game/gameobject/trait/HealthTrait","game/gameobject/trait/BridgeTrait","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait","game/gameobject/trait/TiberiumTreeTrait","game/gameobject/trait/AutoRepairTrait","game/gameobject/trait/VeteranTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/AmmoTrait","game/gameobject/trait/DisguiseTrait","game/gameobject/trait/InvulnerableTrait","game/gameobject/trait/WarpedOutTrait","game/gameobject/trait/TntChargeTrait","game/gameobject/trait/MindControllableTrait","game/gameobject/trait/MindControllerTrait","game/gameobject/trait/TemporalTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/AirSpawnTrait","game/gameobject/trait/SpawnDebrisTrait","game/gameobject/Debris","game/rules/DebrisRules","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/SensorsTrait"],function(e,t){"use strict";var l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$,i;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e}],execute:function(){e("ObjectFactory",i=class{constructor(e,t,i,r){this.tiles=e,this.tileOccupation=t,this.bridges=i,this.nextObjectId=r}create(e,t,i,r){let s,a;e===l.ObjectType.Debris?s=i.hasObject(t,l.ObjectType.VoxelAnim)?(a=r.getObject(t,l.ObjectType.VoxelAnim),i.getObject(t,l.ObjectType.VoxelAnim)):(a=r.getAnimation(t),new K.DebrisRules(l.ObjectType.Debris,r.getIni().getOrCreateSection(t))):a=e===l.ObjectType.Projectile?(s=i.getProjectile(t),s.inviso?new f.ObjectArt(l.ObjectType.Projectile,s,new y.IniSection(t)):r.getProjectile(t)):(s=i.getObject(t,e),r.getObject(t,e));let n;switch(e){case l.ObjectType.Building:n=c.Building.factory(t,s,i,a,this.tiles,this.bridges);break;case l.ObjectType.Infantry:n=g.Infantry.factory(t,s,a,this.tileOccupation);break;case l.ObjectType.Vehicle:n=p.Vehicle.factory(t,s,a,i,this.tileOccupation);break;case l.ObjectType.Aircraft:n=m.Aircraft.factory(t,s,a,i,this.tileOccupation);break;case l.ObjectType.Terrain:n=h.Terrain.factory(t,s,a);break;case l.ObjectType.Overlay:n=u.Overlay.factory(t,s,a);break;case l.ObjectType.Smudge:n=d.Smudge.factory(t,s,a);break;case l.ObjectType.Projectile:n=S.Projectile.factory(t,s,a,this.tileOccupation);break;case l.ObjectType.Debris:n=z.Debris.factory(t,s,a,this.tileOccupation);break;default:throw new Error("Not implemented")}if(n.id=this.nextObjectId.value++,n.position=new v.ObjectPosition(this.tiles,this.tileOccupation),n.isUnit()?n.position.subCell=0:n.isBuilding()&&n.position.setCenterOffset(n.getFoundationCenterOffset()),n.isTechno()&&((n.rules.primary||n.rules.secondary||n.rules.weaponCount||n.rules.explodes)&&(n.armedTrait=new k.ArmedTrait(n,i),n.traits.add(n.armedTrait)),-1!==n.rules.ammo&&(o=n.rules.initialAmmo,n.ammoTrait=new j.AmmoTrait(n.rules.ammo,-1!==o?o:void 0),n.traits.add(n.ammoTrait)),n.unitOrderTrait=new T.UnitOrderTrait(n),n.traits.addToFront(n.unitOrderTrait),(n.primaryWeapon||n.secondaryWeapon)&&(n.attackTrait=new b.AttackTrait(this.tiles,this.tileOccupation),n.traits.add(n.attackTrait)),(n.isInfantry()||n.isVehicle())&&n.rules.deployer&&(n.deployerTrait=new w.DeployerTrait(n),n.traits.add(n.deployerTrait)),(n.isInfantry()||n.isVehicle())&&n.rules.canDisguise&&(n.disguiseTrait=new N.DisguiseTrait,n.traits.add(n.disguiseTrait)),n.rules.cloakable&&(n.cloakableTrait=new G.CloakableTrait(n,i.general.cloakDelay),n.traits.add(n.cloakableTrait)),n.rules.sensors&&(n.sensorsTrait=new $.SensorsTrait,n.traits.add(n.sensorsTrait)),n.autoRepairTrait=new P.AutoRepairTrait(!n.isBuilding()),n.traits.add(n.autoRepairTrait),n.rules.trainable&&(n.veteranTrait=new I.VeteranTrait(n,i.general.veteran),n.traits.add(n.veteranTrait)),n.rules.selfHealing&&n.traits.add(new B.SelfHealingTrait),n.invulnerableTrait=new L.InvulnerableTrait,n.traits.add(n.invulnerableTrait),n.warpedOutTrait=new D.WarpedOutTrait(n),n.traits.add(n.warpedOutTrait),n.temporalTrait=new H.TemporalTrait(n),n.traits.add(n.temporalTrait),n.rules.bombable&&(n.tntChargeTrait=new F.TntChargeTrait,n.traits.add(n.tntChargeTrait)),n.rules.immuneToPsionics||n.isBuilding()||(n.mindControllableTrait=new _.MindControllableTrait(n),n.traits.add(n.mindControllableTrait)),[n.primaryWeapon,n.secondaryWeapon].some(e=>e?.warhead.rules.mindControl)&&(n.mindControllerTrait=new U.MindControllerTrait(n),n.traits.add(n.mindControllerTrait)),n.rules.spawns&&(n.airSpawnTrait=new V.AirSpawnTrait,n.traits.add(n.airSpawnTrait)),n.rules.maxDebris&&n.traits.add(new W.SpawnDebrisTrait)),n.isTechno()||n.isOverlay()||n.isTerrain()){var o=n.isOverlay()&&x.BridgeOverlayTypes.isBridge(i.getOverlayId(n.name));let e=n.rules.strength;!e&&n.isTerrain()&&(e=i.general.treeStrength),o&&(e=i.combatDamage.bridgeStrength),(e||n.isTechno())&&(n.healthTrait=new C.HealthTrait(e,n,i.audioVisual.conditionYellow,i.audioVisual.conditionRed),n.traits.add(n.healthTrait)),n.isOverlay()&&o&&(n.bridgeTrait=new E.BridgeTrait(this.bridges),n.traits.add(n.bridgeTrait),x.BridgeOverlayTypes.getOverlayBridgeType(i.getOverlayId(n.name))===x.OverlayBridgeType.Concrete&&n.traits.add(new W.SpawnDebrisTrait))}return n.isOverlay()&&n.isOverlay()&&O.OreOverlayTypes.getOverlayTibType(i.getOverlayId(n.name))!==A.OverlayTibType.NotSpecial&&n.traits.add(new M.TiberiumTrait(n)),n.isTerrain()&&n.rules.spawnsTiberium&&n.traits.add(new R.TiberiumTreeTrait(n.rules)),n.cachedTraits.tick.push(...n.traits.filter(q.NotifyTick)),n}})}}}),System.register("game/PlayerList",["game/SideType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PlayerList",r=class{constructor(){this.players=[]}addPlayer(e){this.players.push(e)}getPlayerAt(e){if(e>=this.players.length)throw new RangeError(`Player #${e} out of bounds`);return this.players[e]}getPlayerByName(t){var e=this.players.find(e=>e.name===t);if(!e)throw new Error(`Player with name "${t}" not found`);return e}getPlayerNumber(e){var t=this.players.indexOf(e);if(-1===t)throw new Error(`Player ${e.name} not found`);return t}getCombatants(){return this.players.filter(e=>e.isCombatant())}getNonNeutral(){return this.players.filter(e=>!e.isNeutral)}getCivilian(){return this.players.find(e=>e.country?.side===i.SideType.Civilian)}getAll(){return this.players}})}}}),System.register("game/Alliances",["util/math"],function(t,e){"use strict";var i,a,r,s;e&&e.id;return{setters:[function(e){i=e}],execute:function(){var e;a=class{constructor(e,t){this.first=e,this.second=t}has(e){return this.first===e||this.second===e}equals(e){return this.first===e.first&&this.second===e.second||this.first===e.second&&this.second===e.first}},(e=r=r||{})[e.Requested=0]="Requested",e[e.Formed=1]="Formed",t("AllianceStatus",r),t("Alliances",s=class{constructor(e){this.playerList=e,this.alliances=[]}findByPlayers(e,t){let i=new a(e,t);return this.alliances.find(e=>e.players.equals(i))}filterByPlayer(t){return this.alliances.filter(e=>e.players.first===t||e.players.second===t)}request(e,t){if(!this.canRequestAlliance(t))throw new Error(`Player ${t.name} is not a human combatant.`);if(this.canFormAlliance(e,t)){if(this.findByPlayers(e,t))throw new Error("Can't request alliance because an alliance is already pending or formed between "+`${e.name} and ${t.name}.`);return this.setAlliance(e,t,r.Requested)}}cancelRequest(e,t){var i=this.findByPlayers(e,t);if(!i||i.status!==r.Requested)throw new Error(`There is no pending alliance request for player ${t.name} from player `+e.name);if(i.players.first!==e)throw new Error(`Can't cancel request initiated by the other player (${t.name})`);this.alliances.splice(this.alliances.indexOf(i),1)}acceptRequest(t,i){if(this.canFormAlliance(t,i)){let e=this.findByPlayers(t,i);if(!e||e.status!==r.Requested)throw new Error(`There is no pending alliance request for player ${i.name} from player `+t.name);if(e.players.first!==t)throw new Error("Can't accept own alliance request for player "+i.name);e.status=r.Formed}}setAlliance(e,t,i){if(!this.canFormAlliance(e,t))throw new Error(`Can't form alliance between players "${e.name}" and "${t.name}"`);var r;if(r=this.findByPlayers(e,t))throw new Error(`An alliance already exists between players ${e.name} and `+t.name);return r={players:new a(e,t),status:i},this.alliances.push(r),r}breakAlliance(e,t){var i=this.findByPlayers(e,t);if(!i||i.status!==r.Formed)throw new Error(`There is no alliance between player ${e.name} and player `+t.name);this.alliances.splice(this.alliances.indexOf(i),1)}areAllied(e,t){var i=this.findByPlayers(e,t);return!!i&&i.status===r.Formed}getAllies(t){return this.filterByPlayer(t).filter(e=>e.status===r.Formed).map(e=>e.players.first===t?e.players.second:e.players.first)}haveSharedIntel(e,t){return e.isObserver||t.isObserver||e===t||this.areAllied(e,t)}canRequestAlliance(e){return e.isCombatant()&&!e.isAi}canFormAlliance(t,i){let e=this.getHostilePlayers();if(0===e.filter(e=>e.has(t)&&!e.has(i)).length)return!1;if(0===e.filter(e=>e.has(i)&&!e.has(t)).length)return!1;let r=new a(t,i);return!!e.filter(e=>!e.equals(r)).length}getHostilePlayers(){var t,i=this.playerList.getCombatants();let r=[];for(let s=0;s<i.length;s++)for(let e=s+1;e<i.length;e++)this.getAllies(i[s]).includes(i[e])||(t=new a(i[s],i[e]),r.push(t));return r}getHash(){return i.fnv32a(this.alliances.map(e=>[this.playerList.getPlayerNumber(e.players.first),this.playerList.getPlayerNumber(e.players.second),e.status]).flat())}debugGetState(){return this.alliances.map(e=>({first:e.players.first,second:e.players.second,status:e.status}))}})}}}),System.register("game/gameobject/selection/SelectionLevel",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Hover=1]="Hover",e[e.Selected=2]="Selected",e[e.SelectedHover=3]="SelectedHover",t("SelectionLevel",i)}}}),System.register("game/gameobject/selection/SelectionModel",["game/gameobject/selection/SelectionLevel"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SelectionModel",r=class{constructor(e){this.selectionLevel=i.SelectionLevel.None,e.isBuilding()&&e.rules.wall?this.maxSelectionLevel=i.SelectionLevel.None:this.maxSelectionLevel=e.rules.selectable?i.SelectionLevel.Selected|i.SelectionLevel.Hover:i.SelectionLevel.Hover}getSelectionLevel(){return this.selectionLevel}setSelectionLevel(e){this.selectionLevel=Math.min(this.maxSelectionLevel,e)}setHover(e){this.setSelectionLevel(e?this.selectionLevel|i.SelectionLevel.Hover:this.selectionLevel&~i.SelectionLevel.Hover)}setSelected(e){this.setSelectionLevel(e?this.selectionLevel|i.SelectionLevel.Selected:this.selectionLevel&~i.SelectionLevel.Selected)}isHovered(){return this.selectionLevel>>i.SelectionLevel.Hover&1}isSelected(){return this.selectionLevel>=i.SelectionLevel.Selected}getControlGroupNumber(){return this.controlGroupNumber}setControlGroupNumber(e){this.controlGroupNumber=e}})}}}),System.register("game/gameobject/selection/SelectionList",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameobject/selection/UnitSelection",["game/gameobject/selection/SelectionModel","util/math"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("UnitSelection",s=class{constructor(){this.selectedUnits=new Set,this.selectionModelsByUnit=new Map,this.groups=new Map,this.hashNeedsUpdate=!0}getOrCreateSelectionModel(e){let t=this.selectionModelsByUnit.get(e);return t||(t=new i.SelectionModel(e),this.selectionModelsByUnit.set(e,t)),t}deselectAll(){this.selectedUnits.forEach(e=>this.selectionModelsByUnit.get(e)?.setSelected(!1)),this.selectedUnits.clear(),this.hashNeedsUpdate=!0}addToSelection(e){this.selectedUnits.add(e),this.getOrCreateSelectionModel(e).setSelected(!0),this.hashNeedsUpdate=!0}removeFromSelection(e){e.forEach(e=>{this.selectedUnits.delete(e),this.getOrCreateSelectionModel(e).setSelected(!1)}),this.hashNeedsUpdate=!0}getSelectedUnits(){return[...this.selectedUnits].filter(e=>!e.isDestroyed&&!e.isCrashing&&!e.isDisposed&&e.isSpawned)}isSelected(e){return this.selectedUnits.has(e)}cleanupUnit(e){this.selectionModelsByUnit.delete(e),this.selectedUnits.delete(e),this.unassignUnitsFromGroup([e]),this.hashNeedsUpdate=!0}updateHash(){this.hash=r.fnv32a([...this.selectedUnits].map(e=>e.id))}getHash(){return this.hashNeedsUpdate&&(this.updateHash(),this.hashNeedsUpdate=!1),this.hash}createGroup(e){this.addUnitsToGroup(e,this.getSelectedUnits())}addUnitsToGroup(e,t,i=!0){this.unassignUnitsFromGroup(t);let r=this.groups.get(e);r||(r=new Set,this.groups.set(e,r)),i&&([...r.values()].forEach(e=>this.selectionModelsByUnit.get(e)?.setControlGroupNumber(void 0)),r.clear());for(var s of t)r.add(s),this.getOrCreateSelectionModel(s).setControlGroupNumber(e)}addGroupToSelection(e){if(this.groups.has(e))for(var t of[...this.groups.get(e)])this.addToSelection(t)}selectGroup(e){this.deselectAll(),this.addGroupToSelection(e)}getGroupUnits(e){return[...this.groups.get(e)??[]]}unassignUnitsFromGroup(e){for(var t of this.groups.values())for(var i of e)t.delete(i)}})}}}),System.register("game/StartingUnitsGenerator",["engine/type/ObjectType"],function(e,t){"use strict";var p,i;t&&t.id;return{setters:[function(e){p=e}],execute:function(){e("StartingUnitsGenerator",i=class{static generate(e,t,i,r){var s,a=i.reduce((e,t)=>e+t.cost,0)/i.length*e;let n=[],o=a,l=(i=i.filter(e=>e.isAvailableTo(r)&&e.hasOwner(r))).filter(e=>t.includes(e.name));for(s of l){if(o<=0)break;var c=2/3/l.length,c=Math.ceil(c*a/s.cost);o-=c*s.cost,n.push({name:s.name,type:p.ObjectType.Vehicle,count:c})}var h,u=i.filter(e=>!l.includes(e)),d=o/u.length;for(h of u){if(o<=0)break;var g=Math.ceil(d/h.cost);o-=g*h.cost,n.push({name:h.name,type:p.ObjectType.Infantry,count:g})}return n}})}}}),System.register("game/event/GameEvent",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/event/ObjectOwnerChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectOwnerChangeEvent",r=class{constructor(e,t){this.target=e,this.prevOwner=t,this.type=i.EventType.ObjectOwnerChange}})}}}),System.register("game/event/RadarEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("RadarEvent",i=class{constructor(e,t,i){this.target=e,this.radarEventType=t,this.tile=i,this.type=r.EventType.RadarEvent}})}}}),System.register("game/event/ObjectDestroyEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("ObjectDestroyEvent",i=class{constructor(e,t,i){this.target=e,this.attackerInfo=t,this.incidental=i,this.type=r.EventType.ObjectDestroy}})}}}),System.register("game/event/LightningStormManifestEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("LightningStormManifestEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.LightningStormManifest}})}}}),System.register("game/event/LightningStormCloudEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("LightningStormCloudEvent",r=class{constructor(e){this.position=e,this.type=i.EventType.LightningStormCloud}})}}}),System.register("game/event/SuperWeaponActivateEvent",["game/event/EventType"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("SuperWeaponActivateEvent",i=class{constructor(e,t,i,r,s){this.target=e,this.owner=t,this.atTile=i,this.atTile2=r,this.noSfxWarning=s,this.type=a.EventType.SuperWeaponActivate}})}}}),System.register("game/event/BuildingInfiltrationEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingInfiltrationEvent",r=class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.BuildingInfiltration}})}}}),System.register("game/event/PingLocationEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PingLocationEvent",r=class{constructor(e,t){this.tile=e,this.player=t,this.type=i.EventType.PingLocation}})}}}),System.register("game/event/BuildingPlaceEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingPlaceEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.BuildingPlace}})}}}),System.register("game/event/BuildingFailedPlaceEvent",["game/event/EventType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("BuildingFailedPlaceEvent",i=class{constructor(e,t,i){this.name=e,this.player=t,this.tile=i,this.type=r.EventType.BuildingFailedPlace}})}}}),System.register("game/event/PlayerResignedEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PlayerResignedEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.PlayerResigned}})}}}),System.register("game/event/PlayerDisconnectedEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PlayerDroppedEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.PlayerDropped}})}}}),System.register("game/event/AllianceChangeEvent",["game/event/EventType"],function(t,e){"use strict";var r,i,s;e&&e.id;return{setters:[function(e){r=e}],execute:function(){var e;(e=i=i||{})[e.Requested=0]="Requested",e[e.Formed=1]="Formed",e[e.Broken=2]="Broken",t("AllianceEventType",i),t("AllianceChangeEvent",s=class{constructor(e,t,i){this.alliance=e,this.changeType=t,this.from=i,this.type=r.EventType.AllianceChange}})}}}),System.register("game/event/EventMap",["game/event/EventType"],function(e,t){"use strict";t&&t.id;return{setters:[function(e){0}],execute:function(){}}}),System.register("game/GameEventBus",["util/event"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("GameEventBus",i=class{constructor(){this.dispatcher=new r.EventDispatcher,this.dispatchersByType=new Map}dispatch(e){this.dispatcher.dispatch(void 0,e),this.dispatchersByType.get(e.type)?.dispatch(void 0,e)}subscribe(e,t){let i=void 0,r;return r="function"==typeof e?e:(i=e,t),void 0===i?(this.dispatcher.subscribe(r),()=>this.unsubscribe(r)):this.subscribeType(i,r)}unsubscribe(e,t){let i=void 0,r;r="function"==typeof e?e:(i=e,t),void 0===i?this.dispatcher.unsubscribe(r):this.unsubscribeType(i,r)}subscribeType(e,t){let i=this.dispatchersByType.get(e);return i||(i=new r.EventDispatcher,this.dispatchersByType.set(e,i)),i.subscribe(t),()=>this.unsubscribeType(e,t)}unsubscribeType(e,t){this.dispatchersByType.get(e)?.unsubscribe(t)}})}}}),System.register("game/event/PlayerDefeatedEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PlayerDefeatedEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.PlayerDefeated}})}}}),System.register("game/trait/interface/NotifyTick",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onTick=Symbol(),e("NotifyTick",i)}}}),System.register("game/trait/interface/NotifyDestroy",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onDestroy=Symbol(),e("NotifyDestroy",i)}}}),System.register("game/trait/interface/NotifySpawn",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onSpawn=Symbol(),e("NotifySpawn",i)}}}),System.register("game/event/BuildingSellEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingSellEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.BuildingSell}})}}}),System.register("game/trait/SellTrait",["game/event/BuildingSellEvent","game/gameobject/trait/interface/NotifySell"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("SellTrait",s=class{constructor(e,t){this.game=e,this.generalRules=t}sell(t){if(!t.rules.unsellable){let e=this.computeRefundValue(t);e&&(t.rules.wall&&(e=0),t.traits.filter(r.NotifySell).forEach(e=>{e[r.NotifySell.onSell](t,this.game)}),t.isBuilding()?this.game.getConstructionWorker(t.owner).unplace(t,()=>this.afterObjectUnspawned(t,e)):(this.game.unspawnObject(t),this.afterObjectUnspawned(t,e)))}}afterObjectUnspawned(e,t){e.owner.credits+=t,e.isBuilding()&&this.game.events.dispatch(new i.BuildingSellEvent(e)),e.dispose()}computeRefundValue(e){let t=0;return 0<e.rules.soylent?t=e.rules.soylent:e.rules.cost&&(t=e.purchaseValue,e.owner.isAi||(t=Math.floor(t*this.generalRules.refundPercent))),t}computePurchaseValue(e,t){return e.cost}dispose(){this.game=void 0}})}}}),System.register("game/trait/interface/NotifyUnspawn",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onUnspawn=Symbol(),e("NotifyUnspawn",i)}}}),System.register("game/trait/interface/NotifyOwnerChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyOwnerChange",i)}}}),System.register("game/trait/interface/NotifyAllianceChange",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyAllianceChange",i)}}}),System.register("game/event/RadarOnOffEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("RadarOnOffEvent",r=class{constructor(e,t){this.target=e,this.radarEnabled=t,this.type=i.EventType.RadarOnOff}})}}}),System.register("game/trait/interface/NotifySuperWeaponActivate",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onActivate=Symbol(),e("NotifySuperWeaponActivate",i)}}}),System.register("game/trait/interface/NotifySuperWeaponDeactivate",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onDeactivate=Symbol(),e("NotifySuperWeaponDeactivate",i)}}}),System.register("game/trait/RadarTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","game/event/RadarOnOffEvent","game/trait/interface/NotifyOwnerChange","game/gameobject/unit/RangeHelper","game/rules/general/RadarRules","game/event/RadarEvent","game/trait/interface/NotifyAttack","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifySuperWeaponActivate","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponDeactivate"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m,f;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class{constructor(){this.activeLightningStrikes=new Map}[i.NotifySpawn.onSpawn](e,t){e.isBuilding()&&e.rules.radar&&this.updateRadarForPlayer(e.owner,t)}[r.NotifyUnspawn.onUnspawn](e,t){e.isBuilding()&&e.rules.radar&&this.updateRadarForPlayer(e.owner,t)}[s.NotifyPower.onPowerLow](e,t){this.updateRadarForPlayer(e,t)}[s.NotifyPower.onPowerRestore](e,t){this.updateRadarForPlayer(e,t)}[s.NotifyPower.onPowerChange](){}[o.NotifyOwnerChange.onChange](e,t,i){e.rules.radar&&(this.updateRadarForPlayer(t,i),this.updateRadarForPlayer(e.owner,i))}[d.NotifyWarpChange.onChange](e,t){e.rules.radar&&this.updateRadarForPlayer(e.owner,t)}[g.NotifySuperWeaponActivate.onActivate](e,t,i){if(e===p.SuperWeaponType.LightningStorm){this.activeLightningStrikes.set(t,(this.activeLightningStrikes.get(t)??0)+1);for(var r of i.getCombatants())r===t||i.alliances.areAllied(r,t)||this.updateRadarForPlayer(r,i)}}[m.NotifySuperWeaponDeactivate.onDeactivate](e,t,i){if(e===p.SuperWeaponType.LightningStorm){var r=(this.activeLightningStrikes.get(t)??0)-1;if(0<r?this.activeLightningStrikes.set(t,r):this.activeLightningStrikes.delete(t),r<=0)for(var s of i.getCombatants())this.updateRadarForPlayer(s,i)}}updateRadarForPlayer(i,r){var e,t;i.radarTrait&&(e=i.radarTrait?.isDisabled(),t=![...i.buildings].find(e=>e.rules.radar&&!e.warpedOutTrait.isActive())||i.powerTrait.level===a.PowerLevel.Low||[...this.activeLightningStrikes.entries()].some(([e,t])=>t&&e!==i&&!r.alliances.areAllied(e,i)),i.radarTrait.setDisabled(t),e!==t&&r.events.dispatch(new n.RadarOnOffEvent(i,!t)))}[u.NotifyAttack.onAttack](e,t,i){e.isTechno()&&(!e.isBuilding()||e.rules.canBeOccupied||e.rules.needsEngineer?e.isVehicle()&&e.harvesterTrait&&this.addEventForPlayer(c.RadarEventType.HarvesterUnderAttack,e.owner,e.tile,i):this.addEventForPlayer(c.RadarEventType.BaseUnderAttack,e.owner,e.tile,i))}addEventForPlayer(r,e,s,a){let n=e.radarTrait;if(n){let t=a.rules.general.radar;n.activeEvents=n.activeEvents.filter(e=>a.currentTick-e.startTick<t.getEventDuration(e.type));let i=new l.RangeHelper(a.map.tileOccupation);!!n.activeEvents.find(e=>e.type===r&&i.isInTileRange(s,e.tile,0,t.getEventSuppresionDistance(e.type)))||(n.activeEvents.push({startTick:a.currentTick,tile:s,type:r}),a.events.dispatch(new h.RadarEvent(e,r,s)))}}},e("RadarTrait",f)}}}),System.register("game/trait/MapShroudTrait",["game/map/MapShroud","game/trait/interface/NotifyTick","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyAllianceChange","util/typeGuard","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/RadarTrait","game/rules/general/RadarRules","engine/type/ObjectType","game/trait/interface/NotifyPower","game/trait/interface/NotifyElevationChange"],function(e,t){"use strict";var s,i,r,a,n,o,l,c,h,u,d,g,p;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=class{constructor(e,t){this.map=e,this.alliances=t,this.shroudByPlayer=new Map,this.revealedToAll=new Set,this.gapGenerators=new Set,this.handleTileOccupationUpdate=({object:e,type:t})=>{if("removed"!==t&&e.isTechno()){var i,r=e.owner;for(i of[r,...this.alliances.getAllies(r)])this.shroudByPlayer.get(i)?.revealFrom(e)}}}getPlayerShroud(e){return this.shroudByPlayer.get(e)}init(t){t.map.tileOccupation.onChange.subscribe(this.handleTileOccupationUpdate);let i=(new s.MapShroud).fromTiles(this.map.tiles);for(var r of t.getCombatants()){let e=i.clone();this.shroudByPlayer.set(r,e),this.revealObjects(e,r,t),e.update()}}[g.NotifyElevationChange.onElevationChange](e,t,i){if(Math.floor(e.tileElevation)!==Math.floor(i)){var r,s=e.owner;for(r of[s,...this.alliances.getAllies(s)])this.shroudByPlayer.get(r)?.revealFrom(e)}}[i.NotifyTick.onTick](e){for(var[t,i]of this.shroudByPlayer)t.defeated&&!t.isObserver?this.shroudByPlayer.delete(t):i.update()}[r.NotifyOwnerChange.onChange](e,t,i){if(e.isBuilding()&&e.rules.spySat&&(this.revealMap(e.owner,i),t.getOwnedObjectsByType(u.ObjectType.Building).find(e=>e.rules.spySat)||this.resetShroud(t,i)),e.isSpawned)for(var r of[e.owner,...i.alliances.getAllies(e.owner)])this.shroudByPlayer.get(r)?.revealFrom(e)}[a.NotifyAllianceChange.onChange](t,e,i){if(e){let e=this.getPlayerShroud(t.players.first);var r,s,a=i.alliances.getAllies(t.players.first).map(e=>this.getPlayerShroud(e)).filter(n.isNotNullOrUndefined);for(r of a)e.merge(r);e.invalidateFull();for(s of a)s.copy(e),s.invalidateFull()}}[o.NotifySpawn.onSpawn](e,t){if(e.isBuilding()){if(e.rules.spySat&&this.revealMap(e.owner,t),e.rules.revealToAll){this.revealedToAll.add(e);for(var i of t.getCombatants())i===e.owner||t.alliances.areAllied(e.owner,i)||(this.shroudByPlayer.get(i)?.revealObject(e),t.traits.get(c.RadarTrait).addEventForPlayer(h.RadarEventType.EnemyObjectSensed,i,e.centerTile,t))}e.gapGeneratorTrait&&this.gapGenerators.add(e)}}[l.NotifyUnspawn.onUnspawn](e,t){e.isBuilding()&&(e.rules.spySat&&(e.owner.getOwnedObjectsByType(u.ObjectType.Building).find(e=>e.rules.spySat)||this.resetShroud(e.owner,t)),e.rules.revealToAll&&this.revealedToAll.delete(e),e.gapGeneratorTrait&&this.gapGenerators.delete(e))}[d.NotifyPower.onPowerLow](e,t){this.updateGaps(t,e)}[d.NotifyPower.onPowerRestore](e,t){this.updateGaps(t,e)}[d.NotifyPower.onPowerChange](e,t){}revealMap(e,t){this.shroudByPlayer.get(e)?.revealAll(),this.markOwnGapTiles(t,e),this.updateGaps(t)}resetShroud(e,t){let i=this.shroudByPlayer.get(e);i&&(i.reset(),this.markOwnGapTiles(t,e),this.revealObjects(i,e,t))}revealObjects(t,e,i){var r;for(r of[...e.getOwnedObjects(),...i.alliances.getAllies(e).map(e=>e.getOwnedObjects()).flat()])t.revealFrom(r);this.revealedToAll.forEach(e=>t.revealObject(e))}updateGaps(e,t){for(var i of this.gapGenerators)t&&i.owner!==t||i.gapGeneratorTrait.update(i,e)}markOwnGapTiles(e,t){for(var i of this.gapGenerators)i.owner!==t&&!e.alliances.areAllied(i.owner,t)||this.getPlayerShroud(t)?.toggleFlagsAround(i.tile,i.gapGeneratorTrait.radiusTiles,s.ShroudFlag.Darken,!0)}dispose(){this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}},e("MapShroudTrait",p)}}}),System.register("game/event/ObjectUnspawnEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectUnspawnEvent",r=class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectUnspawn}})}}}),System.register("game/event/ObjectSpawnEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectSpawnEvent",r=class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectSpawn}})}}}),System.register("game/trait/MapRadiationTrait",["game/gameobject/infantry/StanceType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Warhead","util/event","util/math","game/trait/interface/NotifyTick"],function(e,t){"use strict";var l,c,h,i,r,u,s,a;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){i=e},function(e){r=e},function(e){u=e},function(e){s=e}],execute:function(){a=class{constructor(e){this.map=e,this.radSites=new Map,this.radLevelByTile=new Map,this._onChange=new r.EventDispatcher}get onChange(){return this._onChange.asEvent()}getRadLevel(e){return this.radLevelByTile.get(e)}[s.NotifyTick.onTick](e){var t;this.radLevelByTile.size&&(t=e.rules.radiation,void 0===this.nextDamage?this.nextDamage=Math.max(0,t.radApplicationDelay-1):this.nextDamage<=0?(this.applyDamage(e),this.nextDamage=Math.max(0,t.radApplicationDelay)):this.nextDamage--,void 0===this.nextDecay?this.nextDecay=Math.max(0,t.radLevelDelay-1):this.nextDecay<=0?(this.applyDecay(Math.ceil(t.radLevelDelay/t.radDurationMultiple)),this.radLevelByTile.size?this.nextDecay=Math.max(0,t.radLevelDelay):this.nextDecay=void 0):this.nextDecay--)}applyDamage(a){let n=a.rules.radiation,o=new i.Warhead(a.rules.getWarhead(n.radSiteWarhead));this.radLevelByTile.forEach((e,t)=>{var i,r,s=Math.min(n.radLevelMax,e)*n.radLevelFactor;for(i of a.map.getGroundObjectsOnTile(t).filter(e=>e.isUnit()&&!(e.isInfantry()&&e.stance===l.StanceType.Paradrop&&1<e.tileElevation)))o.canDamage(i,t,i.zone)&&(0<(r=o.computeDamage(s,i))&&o.inflictDamage(r,i,void 0,a,!0))})}applyDecay(s){var e=new Set(this.radLevelByTile.keys());this.radLevelByTile.clear(),this.radSites.forEach(({radLevel:e,radius:t},i)=>{var r=e-s;r<=0?this.radSites.delete(i):(this.radSites.set(i,{radLevel:r,radius:t}),this.setRadLevelAround(i,t,r))}),this._onChange.dispatch(this,e)}createRadSite(e,t,i){var r;(t-=this.radSites.get(e)?.radLevel??0)<=0||(this.radSites.set(e,{radLevel:(this.radSites.get(e)?.radLevel??0)+t,radius:i}),(r=this.setRadLevelAround(e,i,t)).size&&this._onChange.dispatch(this,r))}setRadLevelAround(e,t,i){let r=new c.RangeHelper(this.map.tileOccupation),s=new h.RadialTileFinder(this.map.tiles,this.map.mapBounds,e,{width:1,height:1},0,t,e=>!!e,!1);var a;let n=new Set;for(;a=s.getNextTile();){var o=r.tileDistance(e,a);o<=t&&(o=Math.ceil(u.lerp(i,0*i,o/t)),this.radLevelByTile.set(a,Math.min(1e3,(this.radLevelByTile.get(a)??0)+o)),n.add(a))}return n}getRadSiteLevel(e){return this.radSites.get(e)?.radLevel}},e("MapRadiationTrait",a)}}}),System.register("util/Serializable",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/action/ActionType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NoAction=0]="NoAction",e[e.DropPlayer=1]="DropPlayer",e[e.ObserveGame=2]="ObserveGame",e[e.ResignGame=3]="ResignGame",e[e.DebugCommand=4]="DebugCommand",e[e.PlaceBuilding=5]="PlaceBuilding",e[e.SellBuilding=6]="SellBuilding",e[e.ToggleRepair=7]="ToggleRepair",e[e.SelectUnits=8]="SelectUnits",e[e.OrderUnits=9]="OrderUnits",e[e.UpdateQueue=10]="UpdateQueue",e[e.ToggleAlliance=11]="ToggleAlliance",e[e.ActivateSuperWeapon=12]="ActivateSuperWeapon",e[e.PingLocation=13]="PingLocation",t("ActionType",i)}}}),System.register("game/action/Action",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Action",i=class{constructor(e){this.actionType=e}unserialize(e){}serialize(){return new Uint8Array}print(){return""}})}}}),System.register("game/action/ActionFactory",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ActionFactory",i=class{constructor(){this.factories=new Map}registerFactory(e,t){this.factories.set(e,t)}create(e){let t=this.factories.get(e);if(!t)throw new Error("No factory registered for action type "+e);return t.create()}})}}}),System.register("game/action/ActionQueue",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ActionQueue",i=class{constructor(){this.actions=[]}push(...e){this.actions.push(...e)}getLast(){return this.actions[this.actions.length-1]}dequeueAll(){var e=[...this.actions];return this.actions.length=0,e}dequeueLast(){return this.actions.pop()}clear(){this.actions.length=0}})}}}),System.register("game/trait/interface/NotifyPlaceBuilding",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onPlace=Symbol(),e("NotifyPlaceBuilding",i)}}}),System.register("game/action/PlaceBuildingAction",["game/action/Action","data/DataStream","game/event/BuildingPlaceEvent","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/trait/FactoryTrait","game/action/ActionType","game/event/BuildingFailedPlaceEvent","game/trait/interface/NotifyPlaceBuilding","engine/type/ObjectType"],function(e,t){"use strict";var i,r,s,o,l,c,a,n,h,u,d;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){a=e},function(e){n=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.Action{constructor(e){super(a.ActionType.PlaceBuilding),this.game=e}unserialize(e){let t=new r.DataStream(e);this.buildingRules=this.game.rules.getTechnoByInternalId(t.readUint32(),u.ObjectType.Building),this.tile={x:t.readUint16(),y:t.readUint16()}}serialize(){let e=new r.DataStream(8);return e.writeUint32(this.buildingRules.index),e.writeUint16(this.tile.x),e.writeUint16(this.tile.y),e.toUint8Array()}print(){return`Place building ${this.buildingRules.name} at tile (${this.tile.x}, ${this.tile.y})`}process(){var e=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(e){var t=this.player;const i=this.tryPlaceBuilding(t,e);i?(this.game.traits.filter(h.NotifyPlaceBuilding).forEach(e=>{e[h.NotifyPlaceBuilding.onPlace](i,this.game)}),this.game.events.dispatch(new s.BuildingPlaceEvent(i))):this.game.events.dispatch(new n.BuildingFailedPlaceEvent(this.buildingRules.name,t,e))}else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}tryPlaceBuilding(r,s){var a=this.buildingRules;if(r.production){let i=r.production.getQueueForObject(a);if(i.status===o.QueueStatus.Ready&&i.getFirst().rules===a){let t=this.game.getConstructionWorker(r);if(r.production.isAvailableForProduction(a)&&t.canPlaceAt(a.name,s,{normalizedTile:!0})){var n=t.placeAt(a.name,s,!0);r.addUnitsBuilt(u.ObjectType.Building,1),i.shift(a,1);let e=r.production.getPrimaryFactory(l.FactoryType.BuildingType);return e&&(e.factoryTrait.status=c.FactoryStatus.Delivering),n[0]}}}}},e("PlaceBuildingAction",d)}}}),System.register("game/action/SellBuildingAction",["game/action/Action","data/DataStream","game/gameobject/Building","game/action/ActionType"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.Action{constructor(e){super(a.ActionType.SellBuilding),this.game=e}unserialize(e){this.buildingId=new r.DataStream(e).readUint32()}serialize(){return new r.DataStream(4).writeUint32(this.buildingId).toUint8Array()}print(){return"Sell building "+this.buildingId}process(){var t=this.player;if(this.game.getWorld().hasObjectId(this.buildingId)){let e=this.game.getObjectById(this.buildingId);e.isBuilding()&&(t!==e.owner||e.isDestroyed||e.buildStatus!==s.BuildStatus.Ready||e.warpedOutTrait.isActive()||this.game.sellTrait.sell(e))}}},e("SellBuildingAction",n)}}}),System.register("game/event/BuildingRepairStartEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingRepairStartEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.BuildingRepairStart}})}}}),System.register("game/action/ToggleRepairAction",["game/action/Action","data/DataStream","game/gameobject/trait/AutoRepairTrait","game/event/BuildingRepairStartEvent","game/action/ActionType"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Action{constructor(e){super(n.ActionType.ToggleRepair),this.game=e}unserialize(e){this.buildingId=new r.DataStream(e).readUint32()}serialize(){return new r.DataStream(4).writeUint32(this.buildingId).toUint8Array()}print(){return"Toggle repair "+this.buildingId}process(){var e=this.player;if(this.game.getWorld().hasObjectId(this.buildingId)){let t=this.game.getObjectById(this.buildingId);if(t.isBuilding()&&e===t.owner&&!t.isDestroyed&&t.rules.repairable&&t.rules.clickRepairable&&100!==t.healthTrait.health){let e=t.traits.get(s.AutoRepairTrait);e.setDisabled(!e.isDisabled()),e.isDisabled()||this.game.events.dispatch(new a.BuildingRepairStartEvent(t))}}}},e("ToggleRepairAction",o)}}}),System.register("game/action/ToggleAllianceAction",["game/action/Action","game/Alliances","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/action/ActionType"],function(e,t){"use strict";var i,o,l,c,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){r=e}],execute:function(){s=class extends i.Action{constructor(e){super(r.ActionType.ToggleAlliance),this.game=e}unserialize(e){this.toPlayer=this.game.getPlayer(e[0]),this.toggle=Boolean(e[1])}serialize(){return new Uint8Array([this.game.getPlayerNumber(this.toPlayer),this.toggle?1:0])}print(){return`Toggle alliance ${this.toggle?"on":"off"} with `+this.toPlayer.name}process(){var e=this.game.rules.mpDialogSettings;if(e.alliesAllowed&&e.allyChangeAllowed){var a,n=this.player,t=this.toPlayer,e=this.toggle;let i=n,r=t,s=this.game.alliances;if(!n.defeated&&s.canRequestAlliance(r)){let t=s.findByPlayers(i,r);t?t.status===o.AllianceStatus.Formed?e||(s.breakAlliance(i,r),this.game.onAllianceChange(t,i,!1)):t.status===o.AllianceStatus.Requested&&(t.players.first===r?e&&s.canFormAlliance(i,r)&&(s.acceptRequest(r,i),this.game.onAllianceChange(t,i,!0),1!==(n=this.game.getCombatants().filter(e=>e!==i&&!s.areAllied(i,e))).length||(a=s.findByPlayers(n[0],i))&&s.cancelRequest(a.players.first,a.players.second),1!==(a=this.game.getCombatants().filter(e=>e!==r&&!s.areAllied(r,e))).length||(a=s.findByPlayers(a[0],r))&&s.cancelRequest(a.players.first,a.players.second)):e||(s.cancelRequest(i,r),this.game.events.dispatch(new l.AllianceChangeEvent(t,l.AllianceEventType.Broken,i)),this.game.traits.filter(c.NotifyAllianceChange).forEach(e=>{e[c.NotifyAllianceChange.onChange](t,!1,this.game)}))):e&&s.canFormAlliance(i,r)&&((e=s.request(i,r))&&this.game.events.dispatch(new l.AllianceChangeEvent(e,l.AllianceEventType.Requested,i)))}}}},e("ToggleAllianceAction",s)}}}),System.register("game/action/UpdateQueueAction",["game/action/Action","data/DataStream","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/ActionType"],function(t,e){"use strict";var i,s,l,c,r,h,a;e&&e.id;return{setters:[function(e){i=e},function(e){s=e},function(e){l=e},function(e){c=e},function(e){r=e}],execute:function(){var e;(e=h=h||{})[e.Add=0]="Add",e[e.Cancel=1]="Cancel",e[e.Pause=2]="Pause",e[e.Resume=3]="Resume",t("UpdateType",h),a=class extends i.Action{constructor(e){super(r.ActionType.UpdateQueue),this.game=e}unserialize(e){let t=new s.DataStream(e);var i,r;this.queueType=t.readUint8(),this.updateType=t.readUint8(),this.updateType!==h.Add&&this.updateType!==h.Cancel||(i=t.readUint32(),r=t.readUint8(),this.item=this.game.rules.getTechnoByInternalId(i,r),this.quantity=t.readUint16())}serialize(){let e=new s.DataStream(9);if(e.dynamicSize=!1,e.writeUint8(this.queueType),e.writeUint8(this.updateType),this.updateType===h.Add||this.updateType===h.Cancel){if(void 0===this.quantity)throw new Error("Missing quantity");if(65535<this.quantity)throw new Error("Maximum quantity exceeded");e.writeUint32(this.item.index),e.writeUint8(this.item.type),e.writeUint16(this.quantity)}return new Uint8Array(e.buffer,e.byteOffset,e.position)}print(){return this.updateType===h.Resume?"Resume queue "+l.QueueType[this.queueType]:this.updateType===h.Add?`Add to queue ${this.item.name} x `+this.quantity:this.updateType===h.Pause?`Put queue ${l.QueueType[this.queueType]} on hold.`:this.updateType===h.Cancel?`Cancel ${this.item.name} x `+this.quantity:"Unhandled queue update type "+this.updateType}process(){let t=this.player,i=this.item,r=t.production.getQueue(this.queueType);if(this.updateType===h.Resume)r.status===l.QueueStatus.OnHold&&(r.status=l.QueueStatus.Active);else if(this.updateType===h.Add){let e=r.find(i);var s,a;(r.status===l.QueueStatus.Active||r.status===l.QueueStatus.Idle||r.status===l.QueueStatus.OnHold&&e[0]!==r.getFirst()||r.status===l.QueueStatus.Ready&&i.type!==c.ObjectType.Building)&&(s=e.reduce((e,t)=>e+t.quantity,0),a=t.getOwnedObjectsByType(i.type,!0).filter(e=>e.name===i.name).length,(a=Number.isFinite(i.buildLimit)?Math.max(0,i.buildLimit-(a+s)):Number.POSITIVE_INFINITY)&&t.production.isAvailableForProduction(i)&&(n=Math.min(r.maxSize-r.currentSize,r.maxItemQuantity-s,a),0<(o=Math.min(this.quantity,n))&&r.push(i,o,i.cost)))}else if(this.updateType===h.Cancel){if([l.QueueStatus.Ready,l.QueueStatus.OnHold,l.QueueStatus.Active].includes(r.status)){let e=r.find(i);var n,o;e.length&&(n=e.reduce((e,t)=>e+t.quantity,0),0<(o=Math.min(n,this.quantity))&&(r.pop(i,o),o===n&&(t.credits+=e[0].creditsSpent)))}}else this.updateType===h.Pause&&r.status===l.QueueStatus.Active&&(r.status=l.QueueStatus.OnHold)}},t("UpdateQueueAction",a)}}}),System.register("game/gameobject/selection/UnitSelectionLite",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("UnitSelectionLite",i=class{constructor(e){this.player=e,this.selectedUnits=new Set}update(e){var t,i=[...e].reverse().find(e=>e.owner!==this.player);i&&(e=[i]),this.selectedUnits.clear();for(t of e)t.rules.selectable&&this.selectedUnits.add(t)}getSelectedUnits(){return[...this.selectedUnits].filter(e=>!e.isDestroyed&&!e.isCrashing)}isSelected(e){return this.selectedUnits.has(e)}})}}}),System.register("game/action/OrderActionContext",["game/gameobject/selection/UnitSelectionLite"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("OrderActionContext",r=class{constructor(){this.unitSelectionByPlayer=new Map}getOrCreateSelection(e){let t=this.unitSelectionByPlayer.get(e);return t||(t=new i.UnitSelectionLite(e),this.unitSelectionByPlayer.set(e,t)),t}})}}}),System.register("game/event/ObjectMorphEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObjectMorphEvent",r=class{constructor(e,t){this.from=e,this.to=t,this.type=i.EventType.ObjectMorph}})}}}),System.register("game/gameobject/task/morph/MorphIntoTask",["game/gameobject/task/system/Task","engine/type/ObjectType","game/gameobject/Building","game/gameobject/task/move/MoveTask","game/event/ObjectMorphEvent","game/gameobject/task/TurnTask","game/gameobject/task/morph/PackBuildingTask"],function(e,t){"use strict";var i,o,r,l,c,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){o=e},function(e){r=e},function(e){l=e},function(e){c=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.Task{constructor(e){super(),this.game=e}onStart(e){if(!this.morphInto)throw new Error("morphInto not set");e.isBuilding()&&e.buildStatus!==r.BuildStatus.BuildDown&&this.morphInto.type!==o.ObjectType.Building&&this.children.push(new a.PackBuildingTask),e.isVehicle()&&this.morphInto.type===o.ObjectType.Building&&this.children.push(new s.TurnTask(180))}onTick(t){if(!this.morphInto)throw new Error("morphInto not set");let e=this.game.getUnitSelection();var i=e.isSelected(t),r=e.getOrCreateSelectionModel(t).getControlGroupNumber(),s=this.morphInto;let a;if(s.type===o.ObjectType.Building){if(t.isVehicle()&&t.parasiteableTrait?.isInfested())return!0;var n=t.tile;let e=this.game.getConstructionWorker(t.owner);if(!e.canPlaceAt(this.morphInto.name,n,{ignoreAdjacent:!0,ignoreObjects:[t]}))return!0;this.game.unspawnObject(t),t.dispose(),[a]=e.placeAt(this.morphInto.name,n),a.healthTrait.health=t.healthTrait.health}else{let e=t.unitOrderTrait.getTasks().filter(e=>e instanceof l.MoveTask);this.game.unspawnObject(t),t.dispose(),a=this.game.createUnitForPlayer(this.morphInto,t.owner),a.direction=180,a.healthTrait.health=t.healthTrait.health;n=t.art.foundationCenter;this.game.spawnObject(a,this.game.map.tiles.getByMapCoords(t.tile.rx+n.x,t.tile.ry+n.y)),e.forEach(e=>a.unitOrderTrait.addTask(e))}return a.purchaseValue=t.purchaseValue,t.replacedBy=a,i&&e.addToSelection(a),void 0!==r&&e.addUnitsToGroup(r,[a],!1),this.game.events.dispatch(new c.ObjectMorphEvent(t,a)),!0}},e("MorphIntoTask",n)}}}),System.register("game/gameobject/task/morph/DeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MorphIntoTask{onStart(e){var t=e.rules.deploysInto;if(!t)throw new Error(`Object type "${e.name}" doesn't deploy into anything`);this.morphInto=this.game.rules.getObject(t,r.ObjectType.Building),super.onStart(e)}onTick(e){return!!this.isCancelling()||super.onTick(e)}},e("DeployIntoTask",s)}}}),System.register("game/event/UnitDeployUndeployEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("UnitDeployUndeployEvent",r=class{constructor(e,t){this.unit=e,this.deployType=t,this.type=i.EventType.UnitDeployUndeploy}})}}}),System.register("game/event/PrimaryFactoryChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PrimaryFactoryChangeEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.PrimaryFactoryChange}})}}}),System.register("game/gameobject/task/EvacuateTransportTask",["game/event/LeaveTransportEvent","game/gameobject/unit/FacingUtil","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/ScatterTask","game/gameobject/task/system/Task","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask"],function(t,e){"use strict";var a,b,r,n,o,i,l,c,h,u,d,s;e&&e.id;return{setters:[function(e){a=e},function(e){b=e},function(e){r=e},function(e){n=e},function(e){o=e},function(e){i=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var e;(e=d=d||{})[e.None=0]="None",e[e.OnlyPassengers=1]="OnlyPassengers",e[e.All=2]="All",s=class extends i.Task{constructor(e,t){super(),this.game=e,this.soft=t,this.evacState=d.None,this.evacTries=0,this.turnPerformed=!1,this.preventLanding=!1}forceEvac(){this.evacState=d.All}onStart(e){if(!e.transportTrait)throw new Error(`Object "${e.name}" is not a valid transport`);var t=e.transportTrait;0<t.units.length&&(this.evacState=this.evacState!==d.OnlyPassengers&&1!==t.units.length||!e.rules.gunner?d.OnlyPassengers:d.All)}onTick(e){if(this.isCancelling()||this.evacState===d.None)return!0;if(e.zone===h.ZoneType.Air)return this.children.push(new u.CallbackTask(()=>e.zone!==h.ZoneType.Air)),!1;let t=e.transportTrait.units;if(!t.length||e.rules.gunner&&1===t.length&&this.evacState!==d.All)return!0;var i=t[t.length-1],r=this.findValidEvacTarget(e,i);if(r&&!this.turnPerformed){this.turnPerformed=!0;var s=(r.dir+180)%360;if(e.direction!==s)return this.children.push(new l.TurnTask(s)),!1}return this.evacuateUnit(i,e,r)?(t.pop(),this.children.push(new c.WaitMinutesTask(1/60)),!1):!(++this.evacTries<=3)||(this.children.push(new c.WaitMinutesTask(.05)),!1)}evacuateUnit(e,t,i){if(!i)return!this.soft&&(e.position.tile=t.tile,e.position.tileElevation=t.tileElevation,e.onBridge=t.onBridge,e.zone=t.zone,this.game.destroyObject(e,{player:e.owner}),!0);var{spawnNode:r,moveNode:s}=i;return e.position.tileElevation=r.onBridge?.tileElevation??0,e.onBridge=!!r.onBridge,e.zone=this.game.map.getTileZone(r.tile,!r.onBridge),this.game.unlimboObject(e,r.tile),e.unitOrderTrait.unmarkNextQueuedOrder(),s?e.unitOrderTrait.addTask(new n.MoveTask(this.game,s.tile,!!s.onBridge)):e.unitOrderTrait.addTask(new o.ScatterTask(this.game)),this.game.events.dispatch(new a.LeaveTransportEvent(t)),!0}findValidEvacTarget(a,n){let o=this.game.map,l=new r.MovePositionHelper(o);var c,h,u,d,g,e=a.onBridge?o.tileOccupation.getBridgeOnTile(a.tile):void 0,t=(a.direction+180)%360;let p;for(let i=0;i<=180;i+=45)for(c of i&&i<180?[t+i,t-i]:[t]){var m=b.FacingUtil.toMapCoords(c);let t=a.tile,i=e,r;for(let s=1;s<=2;s++){if(2===s){if(!r)break;t=r.tile,i=r.onBridge}var f,y=a.tile.rx+Math.sign(m.x)*s,T=a.tile.ry+Math.sign(m.y)*s,v=o.tiles.getByMapCoords(y,T);if(!v||!o.mapBounds.isWithinBounds(v))break;let e=[o.tileOccupation.getBridgeOnTile(v)];e[0]&&e.push(void 0);for(f of e)if(h=v,u=f,d=i,g=t,0<o.terrain.getPassableSpeed(h,n.rules.speedType,!!u)&&l.isEligibleTile(h,u,d,g)&&!o.terrain.findObstacles({tile:h,onBridge:u},n).length){if(1!==s)return{spawnNode:r,moveNode:{tile:v,onBridge:f},dir:c};r={tile:v,onBridge:f},p={spawnNode:r,moveNode:void 0,dir:c}}}}if(p)return p}},t("EvacuateTransportTask",s)}}}),System.register("game/order/DeployOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/morph/DeployIntoTask","game/gameobject/infantry/StanceType","game/gameobject/task/system/CallbackTask","game/event/UnitDeployUndeployEvent","game/event/PrimaryFactoryChangeEvent","game/gameobject/task/EvacuateTransportTask","game/type/SpeedType"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.Order{constructor(e,t){super(t?r.OrderType.Deploy:r.OrderType.DeploySelected),this.game=e,this.targeted=t,this.minimapAllowed=!1,this.getPointerType=()=>this.isAllowed()?s.PointerType.Deploy:s.PointerType.NoDeploy,this.targetOptional=!t,this.singleSelectionRequired=t}isValid(){if(this.targeted&&(!this.target.obj||this.target.obj!==this.sourceObject))return!1;let e=this.sourceObject;return!!(e.isInfantry()&&e.deployerTrait&&![n.StanceType.Cheer].includes(e.stance)||e.isVehicle()&&e.deployerTrait||e.isVehicle()&&e.rules.deploysInto||e.isVehicle()&&e.transportTrait||e.isBuilding()&&e.rules.factory&&!e.owner.production?.isPrimaryFactory(e)||e.isBuilding()&&e.garrisonTrait?.units.length)}isAllowed(){let t=this.sourceObject;if(t.isVehicle()&&t.transportTrait)return!!(t.transportTrait.units.length&&0<this.game.map.terrain.getPassableSpeed(t.tile,u.SpeedType.Foot,t.onBridge));if((t.isInfantry()||t.isVehicle())&&t.deployerTrait)return!0;if(t.isVehicle()&&t.rules.deploysInto){if(t.parasiteableTrait?.isInfested())return!1;let e=this.game.getConstructionWorker(t.owner);if(t.moveTrait.currentWaypoint?.onBridge)return!1;var i=t.moveTrait.currentWaypoint?.tile??t.tile;return e.canPlaceAt(t.rules.deploysInto,i,{ignoreObjects:[t],ignoreAdjacent:!0})}if(t.isBuilding()&&t.rules.factory)return!0;if(t.isBuilding()&&t.garrisonTrait?.units.length)return!0;throw new Error("Shouldn't reach this point. Missed a case.")}process(){const e=this.sourceObject;return e.isVehicle()&&e.transportTrait?[new h.EvacuateTransportTask(this.game,!0)]:e.isBuilding()&&e.rules.factory?void 0:e.isVehicle()&&e.rules.deploysInto?[new a.DeployIntoTask(this.game)]:(e.isInfantry()||e.isVehicle())&&e.deployerTrait?[new o.CallbackTask(()=>{e.deployerTrait.toggleDeployed(),this.game.events.dispatch(new l.UnitDeployUndeployEvent(e,e.deployerTrait.isDeployed()?"undeploy":"deploy"))})]:e.isBuilding()&&e.garrisonTrait?.units.length?[new o.CallbackTask(()=>{e.garrisonTrait.evacuate(this.game,!0)})]:void 0}onAdd(t,e){let i=this.sourceObject;if(i.isBuilding()&&i.rules.factory)return i.owner.production.setPrimaryFactory(i),this.game.events.dispatch(new c.PrimaryFactoryChangeEvent(i)),!1;if(i.isVehicle()&&i.transportTrait&&!e&&this.isValid()&&this.isAllowed()){let e=t.find(e=>e.constructor===h.EvacuateTransportTask&&!e.isCancelling());if(e)return e.forceEvac(),!1}return!0}},e("DeployOrder",d)}}}),System.register("game/gameobject/task/morph/UndeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MorphIntoTask{onStart(e){var t=e.rules.undeploysInto;if(!t)throw new Error(`Object type "${e.name}" doesn't undeploy into anything`);this.morphInto=this.game.rules.getObject(t,r.ObjectType.Vehicle),super.onStart(e)}},e("UndeployIntoTask",s)}}}),System.register("game/order/OrderFeedbackType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Move=1]="Move",e[e.Attack=2]="Attack",e[e.Enter=3]="Enter",e[e.Capture=4]="Capture",e[e.SpecialAttack=5]="SpecialAttack",t("OrderFeedbackType",i)}}}),System.register("game/event/RallyPointChangeEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("RallyPointChangeEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.RallyPointChange}})}}}),System.register("game/gameobject/task/move/MoveToBlockTask",["game/gameobject/trait/MoveTrait","game/gameobject/task/system/Task","game/gameobject/task/move/MoveTask"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends r.Task{constructor(e,t){super(),this.game=e,this.target=t,this.preventOpportunityFire=!1,this.useChildTargetLines=!0,this.attackPerformed=!1}onStart(e){this.children.push(new s.MoveTask(this.game,this.target.centerTile,!1,{closeEnoughTiles:1,pathFinderIgnoredBlockers:[this.target],stopOnBlocker:this.target}))}onTick(e){if(this.attackPerformed||this.isCancelling()||!e.attackTrait||e.attackTrait.isDisabled())return!0;if(e.moveTrait.lastMoveResult!==i.MoveResult.CloseEnough)return!0;var t=e.attackTrait.selectWeaponVersus(e,this.target,this.game,!0);return!t||(this.children.push(e.attackTrait.createAttackTask(this.game,this.target,this.target.tile,t,{force:!0})),!(this.attackPerformed=!0))}},e("MoveToBlockTask",a)}}}),System.register("game/order/MoveOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/morph/UndeployIntoTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/event/RallyPointChangeEvent","game/type/MovementZone","game/type/SpeedType","game/gameobject/task/AttackTask","game/gameobject/Building","game/gameobject/task/WaitForBuildUpTask","game/gameobject/task/move/MoveToBlockTask","game/type/LandType"],function(e,t){"use strict";var i,s,n,r,a,o,l,c,h,u,d,g,p,m,f;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){n=e},function(e){r=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class extends i.Order{constructor(e,t,i,r=!1){super(r?s.OrderType.ForceMove:s.OrderType.Move),this.game=e,this.map=t,this.unitSelection=i,this.forceMove=r,this.targetOptional=!1,this.feedbackType=o.OrderFeedbackType.Move}getPointerType(e){let t=this.isAllowed();var i,r,s,a;return!t||this.forceMove||this.sourceObject.isBuilding()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)||(i=!!this.target.getBridge(),r=this.sourceObject.rules.speedType,s=this.sourceObject.rules.movementZone===c.MovementZone.Fly,a=this.map.getObjectsOnTile(this.target.tile).some(e=>(e.isInfantry()||e.isVehicle())&&e.disguiseTrait?.hasTerrainDisguise()),t=s?this.sourceObject.rules.airportBound||this.target.tile.landType===m.LandType.Cliff||0<this.map.terrain.getPassableSpeed(this.target.tile,h.SpeedType.Amphibious,i)&&!a:0<this.map.terrain.getPassableSpeed(this.target.tile,r,i)&&!a&&!(this.target.obj?.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))),e?t?n.PointerType.MoveMini:n.PointerType.NoActionMini:t?n.PointerType.Move:n.PointerType.NoMove}isValid(){return!(this.sourceObject.isBuilding()&&(!this.sourceObject.rules.undeploysInto||this.sourceObject.rules.constructionYard&&!this.game.gameOpts.mcvRepacks)&&!this.sourceObject.rallyTrait?.getRallyPoint())&&(this.forceMove||!this.target.obj||(this.target.obj.isOverlay()||this.target.obj.isBuilding())&&this.target.obj.rules.wall||this.target.obj.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)||(this.target.obj.isInfantry()||this.target.obj.isVehicle())&&!!this.target.obj.disguiseTrait?.hasTerrainDisguise()||this.target.obj.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))}isAllowed(){return(!this.sourceObject.isUnit()||!this.sourceObject.moveTrait.isDisabled())&&(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)?this.sourceObject.rules.moveToShroud:!(!this.forceMove&&this.target.obj?.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)))}process(){const e=this.sourceObject;if(!e.isBuilding()||!e.rallyTrait?.getRallyPoint()){var t=this.game.rules.general.closeEnough;return e.isBuilding()&&e.rules.undeploysInto?[new r.UndeployIntoTask(this.game),new a.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:t})]:e.isUnit()?this.isEnemyBuildingBlock()?[new p.MoveToBlockTask(this.game,this.target.obj)]:[new a.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:t})]:void 0}}isEnemyBuildingBlock(){return this.forceMove&&this.sourceObject.isVehicle()&&this.target.obj?.isBuilding()&&!this.game.areFriendly(this.sourceObject,this.target.obj)}onAdd(t,e){var i=this.sourceObject.isBuilding()&&this.sourceObject.rules.undeploysInto;if(i&&this.sourceObject.buildStatus===d.BuildStatus.BuildUp)return this.sourceObject.unitOrderTrait.getTasks().find(e=>e instanceof g.WaitForBuildUpTask)?.setCancellable(!0),!0;if(!i&&this.sourceObject.isBuilding()&&this.sourceObject.rallyTrait?.getRallyPoint())return this.sourceObject.rallyTrait.changeRallyPoint(this.target.tile,this.sourceObject,this.game),this.game.events.dispatch(new l.RallyPointChangeEvent(this.sourceObject)),!1;if(!this.isEnemyBuildingBlock()&&!e&&this.isValid()&&this.isAllowed()){this.sourceObject.attackTrait?.cancelOpportunityFire();let e=t.find(e=>e.constructor===a.MoveTask&&!e.isCancelling());if(e)return e.updateTarget(this.target.tile,!!this.target.getBridge()),e.children.length&&e.children[0]instanceof u.AttackTask&&e.children[0].cancel(),t.splice(t.indexOf(e)+1),this.sourceObject.unitOrderTrait.clearOrders(),!1;if(this.sourceObject.isUnit()&&this.sourceObject.rules.movementZone===c.MovementZone.Fly){let e=t.find(e=>e.constructor===u.AttackTask&&!e.isCancelling());e&&e.forceCancel(this.sourceObject)&&t.splice(t.indexOf(e))}}return!0}},e("MoveOrder",f)}}}),System.register("game/gameobject/task/move/MoveOutsideTask",["game/gameobject/task/move/MoveTask"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.MoveTask{constructor(e,t){super(e,t.tile,!1,{ignoredBlockers:[t]}),this.target=t,this.cancellable=!1}canStopAtTile(e,t,i){return!this.game.map.tileOccupation.isTileOccupiedBy(t,this.target)&&super.canStopAtTile(e,t,i)}},e("MoveOutsideTask",r)}}}),System.register("game/gameobject/task/move/MoveInsideTask",["game/gameobject/task/move/MoveTask"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class r extends i.MoveTask{constructor(e,t){super(e,r.chooseTargetFoundationTile(t,e),!1,{ignoredBlockers:[t],closeEnoughTiles:0}),this.target=t}static chooseTargetFoundationTile(t,i){if(t.isBuilding()){let e=t.centerTile;return i.map.mapBounds.isWithinBounds(e)||(e=i.map.tileOccupation.calculateTilesForGameObject(t.tile,t).find(e=>i.map.mapBounds.isWithinBounds(e))??t.tile),e}return t.tile}hasReachedDestination(e){return super.hasReachedDestination(e)||this.canStopAtTile(e,e.tile,e.onBridge)}canStopAtTile(e,t,i){var r=this.game.map.tileOccupation.isTileOccupiedBy(t,this.target);return(!this.isCancelling()||!r)&&!(!this.isCancelling()&&!r)}isCloseEnoughToDest(e,t,i){return this.game.map.tileOccupation.isTileOccupiedBy(t,this.target)}},e("MoveInsideTask",r)}}}),System.register("game/event/BuildingGarrisonEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingGarrisonEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.BuildingGarrison}})}}}),System.register("game/event/EnterObjectEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("EnterObjectEvent",r=class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.EnterObject}})}}}),System.register("game/gameobject/task/GarrisonBuildingTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingGarrisonEvent","game/event/EnterObjectEvent"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(e){return!this.target.isDestroyed&&this.target.garrisonTrait?.canBeOccupied()&&this.target.garrisonTrait.units.length<this.target.garrisonTrait.maxOccupants&&!(this.target.garrisonTrait.units.length&&this.target.garrisonTrait.units[0].owner!==e.owner)&&!e.mindControllableTrait?.isActive()}onTick(e){if(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())return!0;let t=this.target.garrisonTrait;return this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)):(this.game.limboObject(e,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(e).getControlGroupNumber()}),t.units.length||(e.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,e.owner),this.game.events.dispatch(new a.BuildingGarrisonEvent(this.target))),this.game.events.dispatch(new n.EnterObjectEvent(this.target,e)),t.units.push(e),!0):!!this.movePerformed||(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,!(this.preventOpportunityFire=!0))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("GarrisonBuildingTask",o)}}}),System.register("game/event/UnitRecycleEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("UnitRecycleEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.UnitRecycle}})}}}),System.register("game/gameobject/task/EnterRecyclerTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/type/LocomotorType","game/type/MovementZone","game/event/UnitRecycleEvent","game/event/EnterObjectEvent"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return e.rules.movementZone!==o.MovementZone.Fly&&e.rules.locomotor!==n.LocomotorType.Chrono&&0<this.game.sellTrait.computeRefundValue(e)&&this.target.rules.cloning&&!this.target.isDestroyed&&this.target.buildStatus===r.BuildStatus.Ready&&e.owner===this.target.owner}onTick(e){return!!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())||(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new s.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)):(this.game.sellTrait.sell(e),this.game.events.dispatch(new l.UnitRecycleEvent(e)),this.game.events.dispatch(new c.EnterObjectEvent(this.target,e)),!0):!!this.movePerformed||(this.children.push(new a.MoveInsideTask(this.game,this.target)),!(this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("EnterRecyclerTask",h)}}}),System.register("game/gameobject/task/InfiltrateBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingInfiltrationEvent","game/event/EnterObjectEvent"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return e.rules.infiltrate&&this.target.rules.spyable&&!this.target.isDestroyed&&this.target.buildStatus!==r.BuildStatus.BuildDown&&!this.game.areFriendly(e,this.target)}onTick(e){return!!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())||(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new s.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)):(this.game.unspawnObject(e),e.agentTrait?.infiltrate(e,this.target,this.game),this.game.events.dispatch(new n.BuildingInfiltrationEvent(this.target,e)),this.game.events.dispatch(new o.EnterObjectEvent(this.target,e)),!0):!!this.movePerformed||(this.children.push(new a.MoveInsideTask(this.game,this.target)),!(this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("InfiltrateBuildingTask",l)}}}),System.register("game/gameobject/task/EnterHospitalTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/type/MovementZone","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/event/EnterObjectEvent"],function(t,e){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var e;(e=d=d||{})[e.MoveToQueueingTile=0]="MoveToQueueingTile",e[e.WaitForTurn=1]="WaitForTurn",e[e.MoveToTarget=2]="MoveToTarget",e[e.EnterTarget=3]="EnterTarget",e[e.ClearTarget=4]="ClearTarget",g=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.movePerformed=!1}isAllowed(e){return e.rules.movementZone!==a.MovementZone.Fly&&e.healthTrait.health<100&&this.target.hospitalTrait&&!this.target.isDestroyed&&!this.target.warpedOutTrait.isActive()&&this.game.areFriendly(e,this.target)&&(!this.target.ammoTrait||0<this.target.ammoTrait.ammo)}onStart(e){if(!this.target.hospitalTrait)throw new Error(`Target ${this.target.name} is not a valid hospital`);0<this.target.hospitalTrait.addToHealQueue(e)?this.state=d.MoveToQueueingTile:this.state=d.MoveToTarget}onEnd(e){!this.target.isDestroyed&&e.isSpawned&&this.target.hospitalTrait.removeFromHealQueue(e)}onTick(i){if(this.isCancelling()&&this.state!==d.EnterTarget||this.state===d.ClearTarget||i.moveTrait.isDisabled())return!0;if(this.state===d.MoveToQueueingTile){let t=new n.MovePositionHelper(this.game.map);var e=new o.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,e=>0<this.game.map.terrain.getPassableSpeed(e,i.rules.speedType,!1)&&t.isEligibleTile(e,void 0,void 0,this.target.tile)).getNextTile();return!e||(this.children.push(new l.MoveTask(this.game,e,!1,{closeEnoughTiles:5})),this.children.push(new c.CallbackTask(()=>{[h.MoveResult.Success,h.MoveResult.CloseEnough].includes(i.moveTrait.lastMoveResult)||this.cancel()})),this.state=d.WaitForTurn,this.queueingTile=e,!1)}if(this.state===d.WaitForTurn){if(!this.target.hospitalTrait.unitIsFirstInHealQueue(i))return!1;this.queueingTile=void 0,this.state=d.MoveToTarget}if(this.state===d.MoveToTarget){if(!this.isAllowed(i))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(i.tile,this.target))return!!this.movePerformed||(this.children.push(new s.MoveInsideTask(this.game,this.target)),!(this.movePerformed=!0));this.state=d.EnterTarget}return this.state===d.EnterTarget&&(!this.isAllowed(i)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),this.state=d.ClearTarget,!1):(this.game.limboObject(i,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(i).getControlGroupNumber()}),this.target.hospitalTrait.startHealing(i),this.game.events.dispatch(new u.EnterObjectEvent(this.target,i)),!0))}getTargetLinesConfig(e){return{target:this.queueingTile?void 0:this.target,pathNodes:this.queueingTile?[{tile:this.queueingTile,onBridge:void 0}]:[]}}},t("EnterHospitalTask",g)}}}),System.register("game/order/OccupyOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/GarrisonBuildingTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/type/MovementZone","game/type/LocomotorType","game/gameobject/task/EnterRecyclerTask","game/gameobject/task/InfiltrateBuildingTask","game/gameobject/task/EnterHospitalTask"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class extends i.Order{constructor(e){super(r.OrderType.Occupy),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=o.OrderFeedbackType.Capture}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){return!!(this.target.obj?.isSpawned&&this.target.obj?.isBuilding()&&this.sourceObject.isInfantry())&&(!!this.isInfantryRecycle(this.sourceObject,this.target.obj)||(this.target.obj.isBuilding()&&this.target.obj.hospitalTrait?this.game.areFriendly(this.sourceObject,this.target.obj)&&this.sourceObject.isInfantry():this.target.obj.garrisonTrait?this.target.obj.garrisonTrait.canBeOccupied()&&this.sourceObject.rules.occupier&&!(this.target.obj.garrisonTrait.units.length&&this.target.obj.garrisonTrait.units[0].owner!==this.sourceObject.owner)&&!this.sourceObject.mindControllableTrait?.isActive()&&!this.sourceObject.mindControllerTrait?.isActive():!(!this.target.obj.rules.spyable||!this.sourceObject.rules.infiltrate||this.game.areFriendly(this.sourceObject,this.target.obj))))}isInfantryRecycle(e,t){return t.rules.cloning&&e.owner===t.owner}isAllowed(){var e=this.target.obj,t=this.sourceObject;return this.isInfantryRecycle(t,e)?t.rules.movementZone!==l.MovementZone.Fly&&t.rules.locomotor!==c.LocomotorType.Chrono&&0<this.game.sellTrait.computeRefundValue(t):e.hospitalTrait?t.healthTrait.health<100&&t.rules.movementZone!==l.MovementZone.Fly:!e.garrisonTrait||e.garrisonTrait.units.length<e.rules.maxNumberOccupants}process(){var e=this.target.obj,t=this.sourceObject;return this.isInfantryRecycle(t,e)?[new h.EnterRecyclerTask(this.game,e)]:e.hospitalTrait?[new d.EnterHospitalTask(this.game,e)]:e.garrisonTrait?[new a.GarrisonBuildingTask(this.game,e)]:[new u.InfiltrateBuildingTask(this.game,e)]}onAdd(t,e){if(!e){let e=t.find(e=>e instanceof a.GarrisonBuildingTask||e instanceof u.InfiltrateBuildingTask);if(this.isValid()&&this.isAllowed()&&e&&!e.isCancelling()&&e.target===this.target.obj)if(new n.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("OccupyOrder",g)}}}),System.register("game/gameobject/task/PlantC4Task",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/GameSpeed","game/event/EnterObjectEvent"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(e){return!this.target.isDestroyed&&!this.target.invulnerableTrait.isActive()}onTick(e){if(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target))return!!this.movePerformed||(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,!(this.preventOpportunityFire=!0));if(!this.isAllowed(e)||this.isCancelling())return this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0);var t=Math.floor(60*this.game.rules.combatDamage.c4Delay*a.GameSpeed.BASE_TICKS_PER_SECOND);return this.target.c4ChargeTrait.setCharge(t,{player:e.owner,obj:e}),this.game.events.dispatch(new n.EnterObjectEvent(this.target,e)),this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)}getTargetLinesConfig(e){return{target:this.target,pathNodes:[],isAttack:!0}}},e("PlantC4Task",o)}}}),System.register("game/order/AttackOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/AttackTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/unit/LosHelper","game/type/ArmorType","game/gameobject/task/PlantC4Task","game/gameobject/unit/ZoneType","game/gameobject/task/move/MoveTask","game/type/MovementZone","game/type/LocomotorType"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class extends i.Order{constructor(e,{forceAttack:t,noIvanBomb:i}={}){super(t?r.OrderType.ForceAttack:r.OrderType.Attack),this.game=e,this.isC4=!1,this.forceAttack=!!t,this.ivanBombAllowed=!i||!!t,this.targetOptional=!1,this.feedbackType=o.OrderFeedbackType.None,this.rangeHelper=new n.RangeHelper(this.game.map.tileOccupation),this.losHelper=new l.LosHelper(this.game.map.tiles,e.map.tileOccupation)}getPointerType(e,t){if(!this.isAllowed())return e?s.PointerType.NoActionMini:s.PointerType.NoAction;if(this.isC4)return s.PointerType.C4;var i=this.sourceObject.attackTrait?.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);if(i?.rules.sabotageCursor)return s.PointerType.C4;if(this.ivanBombAllowed&&this.sourceObject.rules.ivan&&i?.warhead.rules.ivanBomb)return s.PointerType.Dynamite;if(i?.warhead.rules.bombDisarm)return s.PointerType.DefuseBomb;if(i&&i.rules.damage<0)return s.PointerType.RepairMove;i=t.every(e=>{if(!e.attackTrait)return!0;var t=e.attackTrait.selectWeaponVersus(e,this.target,this.game,this.forceAttack);return!t||this.rangeHelper.isInWeaponRange(e,this.target.obj||this.target.tile,t,this.game.rules)&&this.losHelper.hasLineOfSight(e,this.target.obj||this.target.tile,t)});return e?s.PointerType.AttackMini:i?s.PointerType.AttackRange:s.PointerType.AttackNoRange}isValid(){if(!this.sourceObject.attackTrait)return!1;if(this.forceAttack&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.isBuilding())return!1;let e=this.target.obj;var t=this.game.map.getGroundObjectsOnTile(this.target.tile).find(e=>e.isTerrain());if(this.terminal=!e&&!t,this.sourceObject.c4&&e?.isBuilding()&&e.c4ChargeTrait&&(this.forceAttack||!this.game.areFriendly(e,this.sourceObject)||e.cabHutTrait))return this.isC4=!0,this.feedbackType=o.OrderFeedbackType.SpecialAttack,!0;if(this.isC4=!1,this.feedbackType=o.OrderFeedbackType.Attack,!this.game.isValidTarget(e))return!1;if(!e&&t?.rules.immune)return!1;if(!(e||this.target.tile!==this.sourceObject.tile||this.sourceObject.isUnit()&&this.sourceObject.zone===u.ZoneType.Air))return!1;if(e===this.sourceObject)return!1;t=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return!!t&&(!(!this.ivanBombAllowed&&t.warhead.rules.ivanBomb)&&(!(e?.isBuilding()&&e.cabHutTrait&&!t.warhead.rules.ivanBomb&&!t.warhead.rules.bombDisarm)&&(!!(this.sourceObject.isUnit()&&this.sourceObject.moveTrait&&!this.sourceObject.moveTrait.isDisabled()||this.rangeHelper.isInWeaponRange(this.sourceObject,e||this.target.tile,t,this.game.rules))&&(!(this.sourceObject.airSpawnTrait&&t.rules.spawner&&!this.game.map.isWithinBounds(this.target.tile))&&(!!this.forceAttack||(!e?.isBuilding()||!e.hospitalTrait)&&(!(!e||!e.healthTrait)&&(!e.isDestroyed&&!e.isCrashing&&(!(!e.isOverlay()||!(t.warhead.rules.wall||t.warhead.rules.wood&&e.rules.armor===c.ArmorType.Wood))||e.isTechno()))))))))}isAllowed(){return!this.sourceObject.attackTrait.isDisabled()}process(){if(this.isC4)return[new h.PlantC4Task(this.game,this.target.obj)];var e=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return[new a.AttackTask(this.game,this.target,e,{force:this.forceAttack})]}onAdd(t,e){let i=this.sourceObject;if(!e&&i.isUnit()&&this.isValid()&&this.isAllowed())if(i.rules.movementZone===g.MovementZone.Fly){let e=t.find(e=>(e.constructor===d.MoveTask||e.constructor===a.AttackTask)&&!e.isCancelling());e&&(i.moveTrait.currentWaypoint?.tile===this.target.tile||i.isAircraft()||e.constructor===a.AttackTask)&&e.forceCancel(i)&&t.splice(t.indexOf(e))}else{t.length&&i.isUnit()&&(i.rules.locomotor===p.LocomotorType.Vehicle||i.rules.locomotor===p.LocomotorType.Ship)&&(i.moveTrait.speedPenalty=.5);let e=t.find(e=>e.constructor===a.AttackTask&&!e.isCancelling());if(e?.getWeapon().warhead.rules.temporal)return e.setForceAttack(this.forceAttack),e.requestTargetUpdate(this.target),!1}return!0}},e("AttackOrder",m)}}}),System.register("game/order/StopOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/type/LocomotorType","game/gameobject/task/system/CallbackTask"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Order{constructor(e){super(r.OrderType.Stop),this.game=e,this.getPointerType=()=>s.PointerType.NoAction}isValid(){return this.sourceObject.isTechno()}isAllowed(){return!0}process(){return[new n.CallbackTask(e=>{!e.isUnit()||e.rules.locomotor!==a.LocomotorType.Vehicle&&e.rules.locomotor!==a.LocomotorType.Ship||(e.moveTrait.speedPenalty=0)})]}onAdd(e,t){let i=this.sourceObject;return t||!e.length||!i.isUnit()||i.rules.locomotor!==a.LocomotorType.Vehicle&&i.rules.locomotor!==a.LocomotorType.Ship||(i.moveTrait.speedPenalty=.5),i.isBuilding()&&i.rallyTrait?.getRallyPoint()&&(i.unitRepairTrait?.resetRallyPoint(i,this.game),i.factoryTrait?.resetRallyPoint(i,this.game)),!0}},e("StopOrder",o)}}}),System.register("game/gameobject/task/CheerTask",["game/gameobject/task/system/Task","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/task/system/WaitMinutesTask"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.Task{constructor(){super(),this.executed=!1,this.cancellable=!1}onTick(e){return this.executed?(e.stance=s.StanceType.None,!0):!e.isInfantry()||!e.art.sequences.has(r.SequenceType.Cheer)||(e.stance!==s.StanceType.None&&e.stance!==s.StanceType.Guard||(e.stance=s.StanceType.Cheer,this.children.push(new a.WaitMinutesTask(1/60).setCancellable(!1)),!(this.executed=!0)))}},e("CheerTask",n)}}}),System.register("game/order/CheerOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/CheerTask","game/gameobject/infantry/StanceType"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Order{constructor(){super(r.OrderType.Cheer),this.getPointerType=()=>s.PointerType.NoAction}isValid(){return this.sourceObject.isInfantry()&&[n.StanceType.None,n.StanceType.Guard].includes(this.sourceObject.stance)}isAllowed(){return!0}process(){return[new a.CheerTask]}},e("CheerOrder",o)}}}),System.register("game/order/DockOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/Building","game/gameobject/task/harvester/ReturnOreTask","game/order/OrderFeedbackType","game/gameobject/task/MoveToDockTask"],function(e,t){"use strict";var i,r,s,a,n,o,l,c;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends i.Order{constructor(e){super(r.OrderType.Dock),this.game=e,this.targetOptional=!1,this.feedbackType=o.OrderFeedbackType.Move}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){if(!this.target.obj?.isBuilding()||this.target.obj.isDestroyed||!this.target.obj.dockTrait||this.target.obj.buildStatus!==a.BuildStatus.Ready||!this.sourceObject.isUnit()||this.target.obj.warpedOutTrait.isActive())return!1;var e=!(this.target.obj.rules.refinery||this.target.obj.unitRepairTrait);return this.game.areFriendly(this.target.obj,this.sourceObject)&&this.target.obj.dockTrait.isValidUnitForDock(this.sourceObject)&&!this.target.obj.dockTrait.isDocked(this.sourceObject)&&!(this.target.obj.unitRepairTrait&&!this.sourceObject.rules.dock.includes(this.target.obj.name)&&100===this.sourceObject.healthTrait.health)&&(!e||(0<(this.target.obj.dockTrait.getAvailableDockCount()??0)||this.target.obj.dockTrait.hasReservedDockForUnit(this.sourceObject)))}isAllowed(){return!0}process(){var e=this.target.obj;return e.rules.refinery&&this.sourceObject.isVehicle()&&this.sourceObject.harvesterTrait?[new n.ReturnOreTask(this.game,e,!0,!0)]:e.unitRepairTrait||this.sourceObject.rules.dock.includes(e.name)?[new l.MoveToDockTask(this.game,e)]:[]}},e("DockOrder",c)}}}),System.register("game/order/GatherOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/harvester/GatherOreTask","game/order/OrderFeedbackType"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Order{constructor(e){super(r.OrderType.Gather),this.game=e,this.targetOptional=!1,this.feedbackType=n.OrderFeedbackType.Move}getPointerType(e){return e?s.PointerType.AttackMini:s.PointerType.AttackNoRange}isValid(){return!(!this.sourceObject.isVehicle()||!this.sourceObject.harvesterTrait||this.sourceObject.moveTrait.isDisabled()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation))&&this.target.isOre}isAllowed(){return!0}process(){return[new a.GatherOreTask(this.game,this.target.tile,!0)]}},e("GatherOrder",o)}}}),System.register("game/order/AttackMoveOrder",["game/order/OrderType","gui/PointerType","game/gameobject/task/move/AttackMoveTask","game/order/OrderFeedbackType","game/type/MovementZone","game/order/AttackOrder","game/gameobject/task/PlantC4Task","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/MoveTask","game/gameobject/task/AttackTask","game/type/LocomotorType"],function(e,t){"use strict";var i,n,r,s,o,a,l,c,h,u,d,g;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){r=e},function(e){s=e},function(e){o=e},function(e){a=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class extends a.AttackOrder{constructor(e,t){super(e),this.map=t,this.orderType=i.OrderType.AttackMove,this.targetOptional=!1,this.feedbackType=s.OrderFeedbackType.Attack}getPointerType(t,i){if(this.target.obj?.isTechno()){let e=super.getPointerType(t,i);return e!==n.PointerType.AttackRange&&e!==n.PointerType.AttackNoRange||(e=n.PointerType.AttackMove),e}let e=this.isAllowed();var r,s,a;return e&&(r=!!this.target.getBridge(),s=this.sourceObject.rules.speedType,a=this.sourceObject.rules.movementZone===o.MovementZone.Fly,e=a||0<this.map.terrain.getPassableSpeed(this.target.tile,s,r)||!!this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)),t?e?n.PointerType.AttackMini:n.PointerType.NoActionMini:e?n.PointerType.AttackMove:n.PointerType.NoMove}isValid(){return this.sourceObject.isUnit()&&!!this.sourceObject.attackTrait&&!this.sourceObject.rules.preventAttackMove&&!(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)&&(!this.target.obj?.isTechno()||super.isValid())}isAllowed(){return!(!this.target.obj?.isTechno()&&this.sourceObject.moveTrait.isDisabled())&&super.isAllowed()}process(){if(this.target.obj?.isTechno()){if(this.isC4)return[new l.PlantC4Task(this.game,this.target.obj)];var e=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game);return[new c.AttackMoveTargetTask(this.game,this.target,e)]}return[new r.AttackMoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})]}onAdd(t,e){if(!this.target.obj?.isTechno())return!0;let i=this.sourceObject;if(!e&&i.isUnit()&&this.isValid()&&this.isAllowed())if(i.rules.movementZone===o.MovementZone.Fly){let e=t.find(e=>[h.MoveTask,u.AttackTask,c.AttackMoveTargetTask].includes(e.constructor)&&!e.isCancelling());e&&(i.moveTrait.currentWaypoint?.tile===this.target.tile||i.isAircraft()||e.constructor===u.AttackTask||e.constructor===c.AttackMoveTargetTask)&&e.forceCancel(i)&&t.splice(t.indexOf(e))}else t.length&&i.isUnit()&&(i.rules.locomotor===d.LocomotorType.Vehicle||i.rules.locomotor===d.LocomotorType.Ship)&&(i.moveTrait.speedPenalty=.5);return!0}},e("AttackMoveOrder",g)}}}),System.register("game/event/BuildingRepairFullEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingRepairFullEvent",r=class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.BuildingRepairFull}})}}}),System.register("game/event/BridgeRepairEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BridgeRepairEvent",r=class{constructor(e,t){this.source=e,this.tile=t,this.type=i.EventType.BridgeRepair}})}}}),System.register("game/gameobject/task/RepairBuildingTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingRepairFullEvent","game/event/BridgeRepairEvent","game/event/EnterObjectEvent"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return this.target.cabHutTrait?this.target.cabHutTrait.canRepairBridge():e.rules.engineer&&!this.target.isDestroyed&&this.target.rules.repairable&&this.target.healthTrait.health<100&&(!this.target.owner.isCombatant()||this.game.areFriendly(e,this.target))}onTick(e){return!!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())||(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)):(this.game.unspawnObject(e),this.target.cabHutTrait?(this.target.cabHutTrait.repairBridge(this.game,e.owner),this.game.events.dispatch(new n.BridgeRepairEvent(e.owner,this.target.centerTile))):(this.target.healthTrait.healToFull(e,this.game),this.game.events.dispatch(new a.BuildingRepairFullEvent(this.target,e.owner))),this.game.events.dispatch(new o.EnterObjectEvent(this.target,e)),!0):!!this.movePerformed||(this.children.push(new s.MoveInsideTask(this.game,this.target)),!(this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("RepairBuildingTask",l)}}}),System.register("game/order/RepairOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/RepairBuildingTask","game/order/OrderFeedbackType"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.Order{constructor(e){super(r.OrderType.Repair),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=o.OrderFeedbackType.Capture}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.RepairMove:s.PointerType.NoRepair}isValid(){return!!this.target.obj?.isBuilding()&&!this.target.obj.isDestroyed&&this.sourceObject.isInfantry()&&this.sourceObject.rules.engineer}isAllowed(){let e=this.target.obj;return e.cabHutTrait?e.cabHutTrait.canRepairBridge():!(!(e.rules.repairable&&e.healthTrait.health<100)||e.owner.isCombatant()&&!this.game.areFriendly(e,this.sourceObject))}process(){var e=this.target.obj;return[new n.RepairBuildingTask(this.game,e)]}onAdd(t,e){if(!e){let e=t.find(e=>e instanceof n.RepairBuildingTask);if(this.isValid()&&this.isAllowed()&&e&&!e.isCancelling()&&e.target===this.target.obj)if(new a.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("RepairOrder",l)}}}),System.register("game/order/GuardAreaOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/gameobject/trait/MoveTrait","game/gameobject/task/harvester/GatherOreTask"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class extends i.Order{constructor(e,t){super(t?r.OrderType.GuardArea:r.OrderType.Guard),this.game=e,this.targeted=t,this.getPointerType=e=>e?this.isAllowed()?s.PointerType.GuardMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Guard:s.PointerType.NoMove,this.terminal=!0,this.targetOptional=!t,this.minimapAllowed=t,this.feedbackType=t?o.OrderFeedbackType.Move:o.OrderFeedbackType.None}isValid(){return this.sourceObject.isUnit()&&(!!this.targetOptional||!this.sourceObject.moveTrait.isDisabled())&&!(this.target&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)}isAllowed(){return!0}process(){let t=this.targeted?this.target.tile:void 0;const e=this.sourceObject;if(!t&&e.isVehicle()&&e.harvesterTrait)return[new a.CallbackTask(()=>e.harvesterTrait.lastOreSite=void 0),new c.GatherOreTask(this.game,void 0,!0)];let i=[];return t&&i.push(new n.MoveTask(this.game,t,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})),i.push(new a.CallbackTask(e=>{t&&![l.MoveResult.Success,l.MoveResult.CloseEnough].includes(this.sourceObject.moveTrait?.lastMoveResult)||(this.sourceObject.guardMode=!0)})),i}},e("GuardAreaOrder",h)}}}),System.register("game/order/ScatterOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/ScatterTask","game/type/MovementZone"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Order{constructor(e){super(r.OrderType.Scatter),this.game=e,this.getPointerType=()=>s.PointerType.NoAction}isValid(){return(this.sourceObject.isInfantry()||this.sourceObject.isVehicle())&&this.sourceObject.rules.movementZone!==n.MovementZone.Fly&&!this.sourceObject.moveTrait.isDisabled()}isAllowed(){return!0}process(){if(!this.target)throw new Error("Target should be set for executing a scatter order. See OrderUnitsAction.");return[new a.ScatterTask(this.game,{tile:this.target.tile,toBridge:!!this.target.getBridge()})]}},e("ScatterOrder",o)}}}),System.register("game/event/EnterTransportEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("EnterTransportEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.EnterTransport}})}}}),System.register("game/gameobject/task/EnterTransportTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/EnterTransportEvent","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/event/EnterObjectEvent"],function(t,e){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){var e;(e=g=g||{})[e.MoveToQueueingTile=0]="MoveToQueueingTile",e[e.WaitForTurn=1]="WaitForTurn",e[e.MoveToTransport=2]="MoveToTransport",e[e.EnterTransport=3]="EnterTransport",e[e.ClearTransport=4]="ClearTransport",p=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(e){return!this.target.isDestroyed&&!this.target.isCrashing&&this.game.areFriendly(this.target,e)&&e.zone!==n.ZoneType.Air&&this.target.zone!==n.ZoneType.Air&&this.target.transportTrait.unitFitsInside(e)&&this.target.moveTrait.moveState===o.MoveState.Idle&&!this.target.warpedOutTrait.isActive()&&!e.mindControllableTrait?.isActive()&&!e.mindControllerTrait?.isActive()}onStart(e){if(!this.target.transportTrait)throw new Error(`Unit ${this.target.name} is not a valid transport`);this.initialTargetTile=this.target.tile,0<this.target.transportTrait.addToLoadQueue(e)?this.state=g.MoveToQueueingTile:this.state=g.MoveToTransport}onEnd(e){this.target.isDestroyed||this.target.transportTrait?.removeFromLoadQueue(e)}onTick(n){if(this.isCancelling()&&this.state!==g.EnterTransport||this.state===g.ClearTransport||n.moveTrait.isDisabled())return!0;if(this.target.tile!==this.initialTargetTile||this.target.moveTrait.moveState!==o.MoveState.Idle)return!0;if(this.state===g.MoveToQueueingTile){let r=new c.MovePositionHelper(this.game.map),s=this.target.onBridge?this.game.map.tileOccupation.getBridgeOnTile(this.target.tile):void 0,a;var e=new l.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,e=>{let t=[this.game.map.tileOccupation.getBridgeOnTile(e)];t[0]&&t.push(void 0);for(var i of t)if(0<this.game.map.terrain.getPassableSpeed(e,n.rules.speedType,!!i)&&r.isEligibleTile(e,i,s,this.target.tile))return a=i,!0;return!1}).getNextTile();return!e||(this.children.push(new h.MoveTask(this.game,e,!!a,{closeEnoughTiles:5})),this.children.push(new u.CallbackTask(()=>{[o.MoveResult.Success,o.MoveResult.CloseEnough].includes(n.moveTrait.lastMoveResult)||this.cancel()})),this.queueingNode={tile:e,onBridge:a},this.state=g.WaitForTurn,!1)}if(this.state===g.WaitForTurn){if(!this.target.transportTrait.unitIsFirstInLoadQueue(n))return!1;this.queueingNode=void 0,this.state=g.MoveToTransport}if(this.state===g.MoveToTransport){if(!this.isAllowed(n))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(n.tile,this.target))return!!this.movePerformed||(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,!(this.preventOpportunityFire=!0));this.state=g.EnterTransport}return this.state===g.EnterTransport&&(!this.isAllowed(n)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),this.state=g.ClearTransport,!1):(this.game.limboObject(n,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(n).getControlGroupNumber(),inTransport:!0}),this.game.events.dispatch(new a.EnterTransportEvent(this.target)),this.game.events.dispatch(new d.EnterObjectEvent(this.target,n)),this.target.transportTrait.units.push(n),!0))}getTargetLinesConfig(e){return{target:this.queueingNode?void 0:this.target,pathNodes:this.queueingNode?[this.queueingNode]:[]}}},t("EnterTransportTask",p)}}}),System.register("game/order/EnterTransportOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/task/EnterTransportTask","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.Order{constructor(e){super(r.OrderType.EnterTransport),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=n.OrderFeedbackType.Enter}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){return!(!this.target.obj?.isVehicle()||!this.target.obj.transportTrait||this.target.obj.isDestroyed||this.target.obj===this.sourceObject||!this.game.areFriendly(this.target.obj,this.sourceObject)||!this.sourceObject.isVehicle()&&!this.sourceObject.isInfantry())}isAllowed(){let e=this.target.obj,t=this.sourceObject;return t.zone!==l.ZoneType.Air&&e.zone!==l.ZoneType.Air&&e.transportTrait.unitFitsInside(t)&&e.moveTrait.moveState===c.MoveState.Idle&&!e.warpedOutTrait.isActive()&&!t.mindControllableTrait?.isActive()&&!t.mindControllerTrait?.isActive()}process(){let e=this.sourceObject,t=this.target.obj;return this.game.map.terrain.getPassableSpeed(t.tile,e.rules.speedType,e.onBridge)?[new o.EnterTransportTask(this.game,t)]:[new h.CallbackTask(()=>{t.unitOrderTrait.addTask(new u.MoveTask(this.game,e.tile,e.onBridge)),t.unitOrderTrait.addTask(new h.CallbackTask(()=>{this.game.map.terrain.getPassableSpeed(t.tile,e.rules.speedType,e.onBridge)&&e.unitOrderTrait.addTask(new o.EnterTransportTask(this.game,t))}))})]}onAdd(t,e){if(!e){let e=t.find(e=>e instanceof o.EnterTransportTask);if(this.isValid()&&this.isAllowed()&&e&&!e.isCancelling()&&e.target===this.target.obj)if(new a.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("EnterTransportOrder",d)}}}),System.register("game/event/BuildingCaptureEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("BuildingCaptureEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.BuildingCapture}})}}}),System.register("game/gameobject/task/CaptureBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingCaptureEvent","game/event/EnterObjectEvent"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return e.rules.engineer&&this.target.rules.capturable&&!this.target.isDestroyed&&this.target.buildStatus!==r.BuildStatus.BuildDown&&!this.game.areFriendly(e,this.target)}onTick(e){return!!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())||(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new s.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)):(this.game.unspawnObject(e),e.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,e.owner),this.game.events.dispatch(new n.BuildingCaptureEvent(this.target)),this.game.events.dispatch(new o.EnterObjectEvent(this.target,e)),!0):!!this.movePerformed||(this.children.push(new a.MoveInsideTask(this.game,this.target)),!(this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("CaptureBuildingTask",l)}}}),System.register("game/order/CaptureOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/CaptureBuildingTask","game/order/OrderFeedbackType"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.Order{constructor(e){super(r.OrderType.Capture),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=o.OrderFeedbackType.Capture}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){return!(this.target.obj?.isDestroyed||!this.target.obj?.isBuilding()||!this.sourceObject.isInfantry())&&(this.target.obj.rules.capturable&&this.sourceObject.rules.engineer&&!this.game.areFriendly(this.sourceObject,this.target.obj))}isAllowed(){return!0}process(){return[new n.CaptureBuildingTask(this.game,this.target.obj)]}onAdd(t,e){if(!e){let e=t.find(e=>e instanceof n.CaptureBuildingTask);if(this.isValid()&&this.isAllowed()&&e&&!e.isCancelling()&&e.target===this.target.obj)if(new a.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("CaptureOrder",l)}}}),System.register("game/order/OrderFactory",["game/order/OrderType","game/order/DeployOrder","game/order/MoveOrder","game/order/OccupyOrder","game/order/AttackOrder","game/order/StopOrder","game/order/CheerOrder","game/order/DockOrder","game/order/GatherOrder","game/order/AttackMoveOrder","game/order/RepairOrder","game/order/GuardAreaOrder","game/order/ScatterOrder","game/order/EnterTransportOrder","game/order/CaptureOrder"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e}],execute:function(){e("OrderFactory",y=class{constructor(e,t){this.game=e,this.map=t}create(e,t){switch(e){case i.OrderType.Deploy:return new r.DeployOrder(this.game,!0);case i.OrderType.DeploySelected:return new r.DeployOrder(this.game,!1);case i.OrderType.ForceMove:return new s.MoveOrder(this.game,this.map,t,!0);case i.OrderType.Move:return new s.MoveOrder(this.game,this.map,t);case i.OrderType.ForceAttack:return new n.AttackOrder(this.game,{forceAttack:!0});case i.OrderType.Attack:return new n.AttackOrder(this.game,{noIvanBomb:!0});case i.OrderType.PlaceBomb:return new n.AttackOrder(this.game);case i.OrderType.AttackMove:return new u.AttackMoveOrder(this.game,this.map);case i.OrderType.Capture:return new f.CaptureOrder(this.game);case i.OrderType.Occupy:return new a.OccupyOrder(this.game);case i.OrderType.Stop:return new o.StopOrder(this.game);case i.OrderType.Cheer:return new l.CheerOrder;case i.OrderType.Dock:return new c.DockOrder(this.game);case i.OrderType.Gather:return new h.GatherOrder(this.game);case i.OrderType.Repair:return new d.RepairOrder(this.game);case i.OrderType.Guard:return new g.GuardAreaOrder(this.game,!1);case i.OrderType.GuardArea:return new g.GuardAreaOrder(this.game,!0);case i.OrderType.Scatter:return new p.ScatterOrder(this.game);case i.OrderType.EnterTransport:return new m.EnterTransportOrder(this.game);default:throw new Error("Unhandled order type "+i.OrderType[e])}}})}}}),System.register("game/order/orderPriorities",["game/order/OrderType"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("orderPriorities",[i.OrderType.Occupy,i.OrderType.Dock,i.OrderType.Attack,i.OrderType.Capture,i.OrderType.Repair,i.OrderType.EnterTransport,i.OrderType.PlaceBomb,i.OrderType.Deploy,i.OrderType.Gather])}}}),System.register("game/event/CheerEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("CheerEvent",r=class{constructor(e){this.player=e,this.type=i.EventType.Cheer}})}}}),System.register("game/event/DeployNotAllowedEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("DeployNotAllowedEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.DeployNotAllowed}})}}}),System.register("game/action/OrderUnitsAction",["data/DataStream","game/action/Action","game/order/OrderType","game/order/orderPriorities","game/order/MoveOrder","game/gameobject/unit/MovePositionHelper","game/order/DeployOrder","game/event/CheerEvent","game/event/DeployNotAllowedEvent","util/typeGuard","game/gameobject/unit/ScatterPositionHelper","game/action/ActionType"],function(e,t){"use strict";var a,i,h,o,u,d,l,g,c,s,p,n,r;t&&t.id;return{setters:[function(e){a=e},function(e){i=e},function(e){h=e},function(e){o=e},function(e){u=e},function(e){d=e},function(e){l=e},function(e){g=e},function(e){c=e},function(e){s=e},function(e){p=e},function(e){n=e}],execute:function(){e("ORDER_UNIT_LIMIT",128),r=class extends i.Action{constructor(e,t,i,r){super(n.ActionType.OrderUnits),this.game=e,this.map=t,this.orderActionContext=i,this.orderFactory=r,this.queue=!1,this.isInvalid=!1}unserialize(e){let t=new a.DataStream(e);this.orderType=t.readUint8();var i=t.readUint8();if(0!==i){var r=t.readUint16(),s=t.readUint16();this.queue=2<i&&Boolean(t.readUint8());let e;if(3<i){i=t.readUint32();if(!this.game.getWorld().hasObjectId(i))return void(this.isInvalid=!0);e=this.game.getObjectById(i)}else e=void 0;s=this.map.tiles.getByMapCoords(r,s);s?this.target=this.game.createTarget(e,s):this.isInvalid=!0}}serialize(){let e=new a.DataStream(11);e.dynamicSize=!1,e.writeUint8(this.orderType);let t=0;e.writeUint8(t),this.target&&(e.writeUint16(this.target.tile.rx),e.writeUint16(this.target.tile.ry),t+=2,i=(this.target.obj||this.target.getBridge())?.id,!this.queue&&void 0===i||(e.writeUint8(Number(this.queue)),t+=1),void 0!==i&&(e.writeUint32(i),t+=1));var i=e.position;return 0<t&&(e.seek(1),e.writeUint8(t)),new Uint8Array(e.buffer,e.byteOffset,i)}print(){return this.isInvalid?"":h.OrderType[this.orderType]+" order "+(this.target?`[obj: ${(this.target.obj||this.target.getBridge())?.name||"<none>"}, `+`tile: ${this.target.tile.rx},${this.target.tile.ry}]`+(this.queue?"(queue)":""):"")}process(){if(!this.isInvalid){let n=this.player;const l=this.game.mapShroudTrait.getPlayerShroud(n);if(l){const c=this.target?.obj;if(c){let e=this.game.map.tileOccupation.calculateTilesForGameObject(c.tile,c);if(!e.find(e=>!l.isShrouded(e,c.tileElevation)))return}let e=this.validateOrders(n).slice(0,128),a=[],t=[],r=[],i=[],s=[];if(e.forEach(e=>{(e instanceof u.MoveOrder?t:e.orderType===h.OrderType.Scatter?r:e.orderType===h.OrderType.DeploySelected?i:e.orderType===h.OrderType.Cheer?s:a).push(e)}),t.length&&this.target)if(t[0].isEnemyBuildingBlock())t.forEach(e=>a.push(e));else{let r=this.target.getBridge();var o=t.map(e=>e.sourceObject);let s=new d.MovePositionHelper(this.map).findPositions(o,this.target.tile,r);t.forEach(e=>{var t=s.get(e.sourceObject),i=!r||r.isHighBridge()?this.map.tileOccupation.getBridgeOnTile(t):r,t=this.game.createTarget(i,t);e.target=t,a.push(e)})}if(r.length){o=r.map(e=>e.sourceObject).filter(e=>e.isInfantry()||e.isVehicle());let i=new p.ScatterPositionHelper(this.game).findPositions(o);r.forEach(e=>{var t=i.get(e.sourceObject);t&&(t=this.game.createTarget(t.onBridge,t.tile),e.target=t,a.push(e))})}if(i.length){let t=[];i.forEach(e=>{((e.sourceObject.isInfantry()||e.sourceObject.isVehicle())&&e.sourceObject.deployerTrait?t:a).push(e)});let e=t.filter(e=>!e.sourceObject.deployerTrait.isDeployed());e.length?e.forEach(e=>a.push(e)):t.forEach(e=>a.push(e))}s.length&&(n.cheerCooldownTicks||(n.cheerCooldownTicks=this.game.rules.general.maximumCheerRate,a.push(...s),this.game.events.dispatch(new g.CheerEvent(n)))),a.forEach(e=>e.sourceObject.unitOrderTrait.addOrder(e,this.queue)),this.updateWaypointPaths(a)}}}validateOrders(e){let i=this.orderActionContext.getOrCreateSelection(e);var r,s=i.getSelectedUnits();let t=this.orderFactory.create(this.orderType,i);t.target=this.target;let a=[];for(r of s)if(!(r.owner!==e||r.rules.spawned||r.isDestroyed||r.isCrashing||r.isDisposed||r.warpedOutTrait.isActive()||(t.sourceObject=r,t instanceof l.DeployOrder&&t.isValid()&&!t.isAllowed()&&this.game.events.dispatch(new c.DeployNotAllowedEvent(r)),t.singleSelectionRequired&&1<s.length)))if(t.isValid()&&t.isAllowed()){let e=this.orderFactory.create(this.orderType,i);e.set(r,this.target),a.push(e)}else{let t=!1;for(var n of o.orderPriorities){let e=this.orderFactory.create(n,i);if(e.set(r,this.target),!(e.singleSelectionRequired&&1<s.length)&&(e.targetOptional===!this.target&&e.isValid()&&e.isAllowed())){a.push(e),t=!0;break}}if(!t&&this.target&&this.orderType!==h.OrderType.Deploy){let e=this.orderFactory.create(h.OrderType.Move,i);e.set(r,this.target),e.isValid()&&e.isAllowed()&&a.push(e)}}return a}updateWaypointPaths(t){if(this.queue&&this.target){let e=t.map(e=>e.sourceObject);var i=[...new Set(e.map(e=>e.unitOrderTrait.waypointPath).filter(s.isNotNullOrUndefined))];if(i.length<=1){var r={orderType:this.orderType,target:this.target,terminal:t.some(e=>e.terminal),next:void 0};if(0===i.length){let t={units:e,waypoints:[r]};e.forEach(e=>{e.unitOrderTrait.waypointPath=t})}else{let e=i[0];e.waypoints[e.waypoints.length-1].next=r,e.waypoints.push(r)}}}}},e("OrderUnitsAction",r)}}}),System.register("game/action/SelectUnitsAction",["game/action/Action","game/action/ActionType","data/DataStream","game/action/OrderUnitsAction"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.Action{constructor(e,t){super(r.ActionType.SelectUnits),this.orderActionContext=t}get unitIds(){return this._unitIds}set unitIds(e){this._unitIds=e.slice(0,a.ORDER_UNIT_LIMIT)}unserialize(e){let t=new s.DataStream(e);this.unitIds=new Array(e.byteLength/4);for(let i=0;i<e.byteLength/4;i++)this.unitIds[i]=t.readUint32()}serialize(){let e=new s.DataStream(4*this.unitIds.length);e.dynamicSize=!1;for(var t of this.unitIds)e.writeUint32(t);return e.toUint8Array()}print(){return`Select unit(s) [${this.unitIds.join(",")}]`}process(){let e=this.player,t=[];for(var i of this.unitIds){i=e.getOwnedObjectById(i);i&&t.push(i)}this.orderActionContext.getOrCreateSelection(e).update(t)}},e("SelectUnitsAction",n)}}}),System.register("game/action/ResignGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends i.Action{constructor(e,t){super(s.ActionType.ResignGame),this.game=e,this.localPlayerName=t}process(){if(this.localPlayerName!==this.player.name){let e=this.player;this.game.removeAllPlayerAssets(e),e.isCombatant()&&(e.resigned=!0,this.game.events.dispatch(new r.PlayerResignedEvent(e)))}}},e("ResignGameAction",a)}}}),System.register("game/superweapon/SuperWeaponEffect",[],function(t,e){"use strict";var r,i;e&&e.id;return{setters:[],execute:function(){var e;(e=r=r||{})[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Finished=2]="Finished",t("EffectStatus",r),t("SuperWeaponEffect",i=class{constructor(e,t,i){this.type=e,this.owner=t,this.tile=i,this.status=r.NotStarted}onStart(e){}onTick(e){return!0}})}}}),System.register("game/gameobject/task/ParadropTask",["game/Coords","game/math/Vector3","game/gameobject/infantry/InfDeathType","game/gameobject/infantry/StanceType","game/gameobject/task/system/Task"],function(e,t){"use strict";var n,o,l,c,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){i=e}],execute:function(){r=class extends i.Task{constructor(e){super(),this.game=e}onTick(e){var t=Math.abs(this.game.rules.general.parachuteMaxFallRate),i=e.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(e.tile).tileElevation:0,r=n.Coords.tileHeightToWorld(i),s=e.tileElevation,a=n.Coords.tileHeightToWorld(s);return r<Math.max(r,a-t)?(e.position.moveByLeptons3(new o.Vector3(0,-t,0)),e.moveTrait.handleElevationChange(s,this.game),!1):(e.position.tileElevation=i,e.stance=c.StanceType.None,this.game.map.terrain.getPassableSpeed(e.tile,e.rules.speedType,e.onBridge)||(e.infDeathType=l.InfDeathType.None,this.game.destroyObject(e,void 0,!0)),!0)}},e("ParadropTask",r)}}}),System.register("game/superweapon/ParadropEffect",["game/Coords","engine/type/ObjectType","game/gameobject/Infantry","game/gameobject/infantry/StanceType","game/gameobject/task/move/MoveTask","game/gameobject/task/ParadropTask","game/gameobject/trait/UnlandableTrait","game/gameobject/unit/FacingUtil","game/gameobject/unit/RangeHelper","game/gameobject/unit/VeteranLevel","game/gameobject/unit/ZoneType","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/math/Vector2","util/bresenham","game/superweapon/SuperWeaponEffect"],function(t,e){"use strict";var c,h,s,r,u,d,g,p,i,m,f,a,y,T,o,n,v,l,b;e&&e.id;return{setters:[function(e){c=e},function(e){h=e},function(e){s=e},function(e){r=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){i=e},function(e){m=e},function(e){f=e},function(e){a=e},function(e){y=e},function(e){T=e},function(e){o=e},function(e){n=e}],execute:function(){var e;(e=v=v||{})[e.Spawning=0]="Spawning",e[e.EnRoute=1]="EnRoute",e[e.Dropping=2]="Dropping",e[e.TurningAround=3]="TurningAround",l=5*a.GameSpeed.BASE_TICKS_PER_SECOND,b=class extends n.SuperWeaponEffect{constructor(e,t,i,r,s){super(e,t,i),this.paradropSquad=r,this.state=v.Spawning,this.spawnDelay=s*l}onStart(e){this.passengerRules=e.rules.getObject(this.paradropSquad.inf,h.ObjectType.Infantry),this.passengerCount=this.paradropSquad.num}computeFlightPath(e,t,i){if(t.equals(e))throw new Error("Source and destination must be different");let r=e.clone().sub(t);var s=i.rules.general.paradrop.paradropRadius/c.Coords.LEPTONS_PER_TILE,s=t.clone().add(r.clone().setLength(r.length()+2*s)).floor();let a=o.bresenham(t.x,t.y,s.x,s.y).map(e=>i.map.tiles.getByMapCoords(e.x,e.y)??i.map.tiles.getPlaceholderTile(e.x,e.y));for(;a.length;){var n=a[0],n=c.Coords.tileToWorld(n.rx+.5,n.ry+.5);if(i.map.isWithinHardBounds(new T.Vector2(n.x,n.y)))break;a.shift()}if(!a.length)throw new Error("No valid paradrop path found");return{fromTile:a[0],toTile:a[a.length-1]}}onTick(s){if(this.state===v.Spawning){if(0<this.spawnDelay)return this.spawnDelay--,!1;var a=s.map.tiles.getMapSize(),n=[new T.Vector2(0,0),new T.Vector2(Math.floor(a.width/2),0),new T.Vector2(0,Math.floor(a.height/2))][s.generateRandomInt(0,2)];let t=this.passengerRules.speedType,e=new y.RadialTileFinder(s.map.tiles,s.map.mapBounds,this.tile,{width:1,height:1},0,50,e=>0<s.map.terrain.getPassableSpeed(e,t,!!e.onBridgeLandType));var o=this.targetTile=e.getNextTile();if(!o)return!0;let i=new T.Vector2(o.rx,o.ry);var{fromTile:l,toTile:a}=this.computeFlightPath(i,n,s),o=s.rules.general.paradrop.paradropPlane,n=s.rules.getObject(o,h.ObjectType.Aircraft);let r=this.pdPlane=s.createUnitForPlayer(n,this.owner);s.spawnObject(r,l),r.direction=p.FacingUtil.fromMapCoords(i.clone().sub(new T.Vector2(l.rx,l.ry))),r.position.tileElevation=c.Coords.worldToTileHeight(r.rules.flightLevel??s.rules.general.flightLevel),r.zone=f.ZoneType.Air,r.onBridge=!1,r.unitOrderTrait.addTask(new u.MoveTask(s,a,!1,{allowOutOfBoundsTarget:!0})),r.traits.get(g.UnlandableTrait).setEnabled(!1),this.state=v.EnRoute}if(!this.pdPlane||this.pdPlane.isDestroyed||this.pdPlane.isCrashing)return!0;o=this.targetTile;if(!this.pdPlane.unitOrderTrait.hasTasks())return this.state=v.TurningAround,this.pdPlane.unitOrderTrait.addTask(new u.MoveTask(s,o,!1,{allowOutOfBoundsTarget:!0})),!1;n=s.rules.general.paradrop.paradropRadius/c.Coords.LEPTONS_PER_TILE;let e=new i.RangeHelper(s.map.tileOccupation);l=e.isInTileRange(this.pdPlane.tile,o,0,n);if(this.state===v.EnRoute&&l&&(this.state=v.Dropping),this.state===v.Dropping)if(l&&0<this.passengerCount){a=this.pdPlane.tile;let t=!!a.onBridgeLandType;if(!s.map.terrain.getPassableSpeed(a,this.passengerRules.speedType,t))return!1;let e=s.map.getGroundObjectsOnTile(a);if(e.some(e=>e.isVehicle()&&e.onBridge===t||e.isBuilding()&&!e.isDestroyed||e.isInfantry()&&e.stance===r.StanceType.Paradrop))return!1;n=this.findFreeSubCell(s,a);if(!n)return!1;this.passengerCount--;let i=s.createUnitForPlayer(this.passengerRules,this.owner);i.stance=r.StanceType.Paradrop,i.position.tileElevation=this.pdPlane.tileElevation,i.position.subCell=n,i.onBridge=t,i.rules.trainable&&this.owner.canProduceVeteran(i.rules)&&i.veteranTrait?.setVeteranLevel(m.VeteranLevel.Veteran),s.spawnObject(i,a),i.unitOrderTrait.addTask(new d.ParadropTask(s).setCancellable(!1))}else{if(!(0<this.passengerCount))return this.pdPlane.unitOrderTrait.getCurrentTask().forceCancel(this.pdPlane),this.pdPlane.traits.get(g.UnlandableTrait).setEnabled(!0),!0;this.state=v.TurningAround,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(o,!!o.onBridgeLandType)}return this.state===v.TurningAround&&l&&(o=this.computeFlightPath(new T.Vector2(o.rx,o.ry),new T.Vector2(this.pdPlane.tile.rx,this.pdPlane.tile.ry),s)["toTile"],this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(o,!1),this.state=v.EnRoute),!1}findFreeSubCell(t,e){let i=t.map.getGroundObjectsOnTile(e).filter(e=>e.isTerrain()).map(e=>e.rules.getOccupiedSubCells(t.map.getTheaterType())).flat();var r=s.Infantry.SUB_CELLS.filter(e=>-1===i.indexOf(e));if(r.length)return 1<r.length?r[t.generateRandomInt(0,r.length-1)]:r[0]}},t("ParadropEffect",b)}}}),System.register("game/superweapon/NukeEffect",["game/Coords","engine/type/ObjectType","game/math/Vector2","game/Weapon","game/WeaponType","game/superweapon/SuperWeaponEffect"],function(e,t){"use strict";var a,n,o,l,c,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){i=e}],execute:function(){r=class extends i.SuperWeaponEffect{constructor(e,t,i,r){super(e,t,i),this.weaponType=r}onStart(t){var i=t.rules.getWeapon(this.weaponType),r=t.createTarget(void 0,this.tile),s=this.owner.getOwnedObjectsByType(n.ObjectType.Building).find(e=>e.rules.nukeSilo);if(s){let e=l.Weapon.factory(i.name,c.WeaponType.Primary,s,t.rules);e.fire(r,t)}else this.fireLooseNuke(i,r,t)}fireLooseNuke(t,i,r){var s=new o.Vector2(this.tile.rx+.5,this.tile.ry+.5).multiplyScalar(a.Coords.LEPTONS_PER_TILE);if(r.map.isWithinHardBounds(s)){let e=r.createLooseProjectile(t.name,this.owner,i);e.position.moveToLeptons(s),e.position.tileElevation=a.Coords.worldToTileHeight(e.rules.detonationAltitude),r.spawnObject(e,e.position.tile)}}onTick(e){return!0}},e("NukeEffect",r)}}}),System.register("game/superweapon/LightningStormEffect",["game/Coords","game/event/LightningStormCloudEvent","game/event/LightningStormManifestEvent","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/GameSpeed","game/map/tileFinder/RandomTileFinder","game/Warhead","game/superweapon/SuperWeaponEffect"],function(t,e){"use strict";var c,s,h,u,d,a,g,p,i,m,r;e&&e.id;return{setters:[function(e){c=e},function(e){s=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){a=e},function(e){g=e},function(e){p=e},function(e){i=e}],execute:function(){var e;(e=m=m||{})[e.Approaching=0]="Approaching",e[e.Manifesting=1]="Manifesting",r=class extends i.SuperWeaponEffect{constructor(){super(...arguments),this.state=m.Approaching,this.clouds=[]}onStart(e){var t=e.rules.general.lightningStorm;this.manifestStartTimer=t.deferment,this.manifestEndTimer=t.duration,this.nextDirectHitTimer=0,this.nextRandomHitTimer=0}onTick(t){if(this.state===m.Approaching&&(0<this.manifestStartTimer?this.manifestStartTimer--:(this.state=m.Manifesting,t.events.dispatch(new h.LightningStormManifestEvent(this.tile)))),this.state===m.Manifesting){var i,s=t.rules.general.lightningStorm;if(0<this.manifestEndTimer&&(this.manifestEndTimer--,0<this.nextDirectHitTimer&&this.nextDirectHitTimer--,this.nextDirectHitTimer<=0&&(this.nextDirectHitTimer=s.hitDelay,this.spawnCloudAt(this.tile,t)),0<this.nextRandomHitTimer&&this.nextRandomHitTimer--,this.nextRandomHitTimer<=0)){this.nextRandomHitTimer=s.scatterDelay;var a=Math.floor(s.cellSpread/2);let i=s.separation,r=new d.RangeHelper(t.map.tileOccupation),e=new g.RandomTileFinder(t.map.tiles,t.map.mapBounds,this.tile,a,t,t=>!this.clouds.some(e=>r.tileDistance(t,e.tile)<i),!1);a=e.getNextTile();a&&this.spawnCloudAt(a,t)}for(i of this.clouds.slice())if(0<i.ticksLeft){if(i.ticksLeft--,i.ticksLeft===Math.floor(i.durationTicks/2)){var r=s.warhead;let e=new p.Warhead(t.rules.getWarhead(r));var n=i.tile,o=t.map.tileOccupation.getBridgeOnTile(n),l=o?.tileElevation??0,r=t.map.getTileZone(n);e.detonate(t,s.damage,n,l,c.Coords.tile3dToWorld(n.rx+.5,n.ry+.5,n.z+l),r,o?u.CollisionType.OnBridge:u.CollisionType.None,t.createTarget(o,n),{player:this.owner,weapon:void 0},!1,!0,void 0)}}else this.clouds.splice(this.clouds.indexOf(i),1);if(!this.clouds.length&&this.manifestEndTimer<=0)return!0}return!1}spawnCloudAt(e,t){var i=t.rules.audioVisual.weatherConClouds,i=t.generateRandomInt(0,i.length-1);let r=t.art.getAnimation(t.rules.audioVisual.weatherConClouds[i]);i=r.art.getNumber("Rate",60*a.GameSpeed.BASE_TICKS_PER_SECOND)/60,i=Math.floor(a.GameSpeed.BASE_TICKS_PER_SECOND/i*60);this.clouds.push({tile:e,durationTicks:i,ticksLeft:i});i=(t.map.tileOccupation.getBridgeOnTile(e)?.tileElevation??0)+c.Coords.worldToTileHeight(t.rules.general.flightLevel),i=c.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z+i);t.events.dispatch(new s.LightningStormCloudEvent(i))}},t("LightningStormEffect",r)}}}),System.register("game/superweapon/IronCurtainEffect",["game/map/tileFinder/RadialTileFinder","game/superweapon/SuperWeaponEffect"],function(e,t){"use strict";var n,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){i=e}],execute:function(){r=class extends i.SuperWeaponEffect{onStart(e){var t,i,r=e.rules.combatDamage.ironCurtainDuration,s={player:this.owner};let a=new n.RadialTileFinder(e.map.tiles,e.map.mapBounds,this.tile,{width:1,height:1},0,1,()=>!0);for(;t=a.getNextTile();)for(i of e.map.getGroundObjectsOnTile(t))!i.isTechno()||i.isUnit()&&i.tile!==t||i.rules.missileSpawn||(i.rules.organic?i.isDestroyed||e.destroyObject(i,s):(i.invulnerableTrait.setActiveFor(r,e.currentTick),(i.isVehicle()||i.isAircraft())&&i.parasiteableTrait?.isInfested()&&i.parasiteableTrait.destroyParasite(s,e)))}onTick(e){return!0}},e("IronCurtainEffect",r)}}}),System.register("game/superweapon/ChronoSphereEffect",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType","game/superweapon/SuperWeaponEffect"],function(e,t){"use strict";var d,g,p,m,f,y,i,r;t&&t.id;return{setters:[function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){i=e}],execute:function(){r=class extends i.SuperWeaponEffect{constructor(e,t,i,r){super(e,t,i),this.tile2=r,this.objectsToTeleport=[]}onStart(t){this.delayTicks=t.rules.general.chronoDelay;let i=t.map.tiles;for(let o=-1;o<=1;o++)for(let e=-1;e<=1;e++){var r=i.getByMapCoords(this.tile.rx+o,this.tile.ry+e);if(r){var s,a=!!r.onBridgeLandType,n=i.getByMapCoords(this.tile2.rx+o,this.tile2.ry+e);for(s of t.map.getGroundObjectsOnTile(r))!s.isUnit()||s.tile!==r||s.onBridge!==a||s.isInfantry()&&s.stance===g.StanceType.Paradrop||s.isDisposed||(s.rules.organic&&!s.rules.teleporter||!n?t.destroyObject(s,{player:this.owner}):s.warpedOutTrait.isActive()||(s.warpedOutTrait.setActive(!0,!0,t),this.objectsToTeleport.push({obj:s,destTile:n})))}}}onTick(o){if(0<this.delayTicks&&this.delayTicks--,this.delayTicks)return!1;for(let{obj:h,destTile:u}of this.objectsToTeleport)if(h.isSpawned){let i=!1,r=u?o.map.tileOccupation.getBridgeOnTile(u):void 0,s=o.map.getGroundObjectsOnTile(u),a=s.find(e=>e.isBuilding());var l=s.some(e=>o.rules.general.padAircraft.includes(e.name)),t=o.rules.general.padAircraft.includes(h.name)&&!!a?.helipadTrait&&!!a.dockTrait?.getAllDockTiles().includes(u)&&!a.dockTrait.hasReservedDockAt(a.dockTrait.getDockNumberByTile(u))&&a.owner===h.owner;let e=!1,n=h.rules.speedType;h.rules.movementZone===f.MovementZone.Fly&&(n=y.SpeedType.Wheel);var c=o.map.mapBounds.isWithinBounds(u);if(!(t||o.map.terrain.getPassableSpeed(u,n,!!r)&&c)){let t=!1;if(!l&&(0<o.map.terrain.getPassableSpeed(u,n,!!r,void 0,!0)||!c)){a&&(i=!0);let e=new m.RadialTileFinder(o.map.tiles,o.map.mapBounds,u,{width:1,height:1},1,15,e=>0<o.map.terrain.getPassableSpeed(e,n,!!e.onBridgeLandType)&&!o.map.terrain.findObstacles({tile:e,onBridge:!!e.onBridgeLandType},h).length);c=e.getNextTile();c&&(u=c,r=o.map.tileOccupation.getBridgeOnTile(u),s=o.map.getGroundObjectsOnTile(u),t=!0)}t||(h.moveTrait.teleportUnitToTile(u,r,!0,!1,o),h.warpedOutTrait.setActive(!1,!0,o),o.map.getTileZone(u)===p.ZoneType.Water&&(h.deathType=d.DeathType.Sink),o.destroyObject(h,{player:this.owner}),e=!0)}if(!e||l)for(let t of s)t.isDisposed||t.isUnit()&&(this.objectsToTeleport.some(({obj:e})=>e===t)||t.onBridge!==!!r&&t.tile===u||2<Math.abs(t.tileElevation-h.tileElevation)||(t.isInfantry()&&t.stance!==g.StanceType.Paradrop&&(t.deathType=d.DeathType.Crush),o.destroyObject(t,{player:this.owner,obj:h})));if(!e){if(h.moveTrait.teleportUnitToTile(u,r,!0,!1,o),t&&a?.dockTrait){t=a.dockTrait.getAllDockTiles().indexOf(u);if(a.dockTrait.undockUnitAt(t),a.dockTrait.hasReservedDockAt(t))throw new Error("Target building dock is already reserved by another unit");a.dockTrait.dockUnitAt(h,t)}i?h.warpedOutTrait.setTimed(o.rules.general.chronoDelay,!1,o):h.warpedOutTrait.setActive(!1,!0,o)}}return!0}},e("ChronoSphereEffect",r)}}}),System.register("game/trait/SuperWeaponsTrait",["game/trait/interface/NotifyWarpChange","game/SuperWeapon","game/superweapon/SuperWeaponEffect","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponActivate","game/event/SuperWeaponActivateEvent","game/superweapon/ParadropEffect","game/superweapon/NukeEffect","game/superweapon/LightningStormEffect","game/superweapon/IronCurtainEffect","game/superweapon/ChronoSphereEffect","game/trait/interface/NotifySuperWeaponDeactivate"],function(e,t){"use strict";var i,o,s,r,a,g,p,m,f,y,T,v,b,n,l;t&&t.id;return{setters:[function(e){i=e},function(e){o=e},function(e){s=e},function(e){r=e},function(e){a=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){n=e}],execute:function(){l=class{constructor(){this.effects=[]}[a.NotifyTick.onTick](t){for(var e of t.getCombatants()){var i;for(i of e.superWeaponsTrait.getAll())i.update(t)}for(let r of this.effects)r.status===s.EffectStatus.NotStarted&&(r.onStart(t),r.status=s.EffectStatus.Running),r.onTick(t)&&(r.status=s.EffectStatus.Finished,t.traits.filter(n.NotifySuperWeaponDeactivate).forEach(e=>{e[n.NotifySuperWeaponDeactivate.onDeactivate](r.type,r.owner,t)}));this.effects=this.effects.filter(e=>e.status!==s.EffectStatus.Finished)}[r.NotifyPower.onPowerLow](e,t){e.superWeaponsTrait?.getAll()?.filter(e=>e.rules.isPowered).forEach(e=>{this.updateTimer(e,!1)})}[r.NotifyPower.onPowerRestore](e,t){e.superWeaponsTrait?.getAll()?.filter(e=>e.rules.isPowered).forEach(e=>{this.updateTimer(e,!0)})}[r.NotifyPower.onPowerChange](e,t){}[i.NotifyWarpChange.onChange](e,t){var i;e.owner.powerTrait&&e.isBuilding()&&e.superWeaponTrait&&((i=e.superWeaponTrait.getSuperWeapon(e))&&this.updateTimer(i,!e.owner.powerTrait.isLowPower()))}updateTimer(e,t){var i=this.superWeaponHasValidBuilding(e);t&&i?e.resumeTimer():e.pauseTimer()}superWeaponHasValidBuilding(t){return[...t.owner.buildings].find(e=>!(e.superWeaponTrait?.getSuperWeapon(e)!==t||e.warpedOutTrait.isActive()&&t.rules.isPowered))}addEffect(e){this.effects.push(e)}activateSuperWeapon(t,e,i,r,s){let a=e.superWeaponsTrait?.getAll().find(e=>e.rules.type===t);if(a&&a.status===o.SuperWeaponStatus.Ready){if(a.oneTimeOnly){e.superWeaponsTrait.remove(a.name);for(var n of e.buildings)n.rules.superWeapon===a.name&&n.superWeaponTrait&&n.superWeaponTrait.addSuperWeaponToPlayerIfNeeded(e,i)}else a.resetTimer();this.activateEffect(a.rules,e,i,r,s)}}activateEffect(e,i,r,s,a,n=!1){const o=e.type;if(void 0!==o){let t=[];switch(o){case g.SuperWeaponType.AmerParaDrop:for(var[l,c]of r.rules.general.paradrop.amerParaDrop.entries())t.push(new f.ParadropEffect(o,i,s,c,l));break;case g.SuperWeaponType.ParaDrop:{let e=r.rules.general.paradrop.getParadropSquads(i.country.side);for(var[h,u]of e.entries())t.push(new f.ParadropEffect(o,i,s,u,h));break}case g.SuperWeaponType.MultiMissile:if(!e.weaponType)throw new Error("Missing WeaponType in super weapon rules");t.push(new y.NukeEffect(o,i,s,e.weaponType));break;case g.SuperWeaponType.LightningStorm:t.push(new T.LightningStormEffect(o,i,s));break;case g.SuperWeaponType.IronCurtain:t.push(new v.IronCurtainEffect(o,i,s));break;case g.SuperWeaponType.ChronoSphere:if(!a)throw new Error("Missing tile2 action param");t.push(new b.ChronoSphereEffect(o,i,s,a))}for(var d of t)this.addEffect(d);r.traits.filter(p.NotifySuperWeaponActivate).forEach(e=>{e[p.NotifySuperWeaponActivate.onActivate](o,i,r,s,a)}),r.events.dispatch(new m.SuperWeaponActivateEvent(o,i,s,a,n))}}},e("SuperWeaponsTrait",l)}}}),System.register("game/action/ActivateSuperWeaponAction",["data/DataStream","game/action/Action","game/action/ActionType","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait"],function(e,t){"use strict";var r,i,s,a,n,o;t&&t.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Action{constructor(e){super(s.ActionType.ActivateSuperWeapon),this.game=e}unserialize(e){let t=new r.DataStream(e);this.superWeaponType=t.readUint8();var i=t.readUint8();this.tile={x:t.readUint16(),y:t.readUint16()},this.tile2=2<i?{x:t.readUint16(),y:t.readUint16()}:void 0}serialize(){let e=new r.DataStream(6+(this.tile2?4:0));return e.dynamicSize=!1,e.writeUint8(this.superWeaponType),e.writeUint8(this.tile2?4:2),e.writeUint16(this.tile.x),e.writeUint16(this.tile.y),this.tile2&&(e.writeUint16(this.tile2.x),e.writeUint16(this.tile2.y)),e.toUint8Array()}print(){return`Activate SuperW ${a.SuperWeaponType[this.superWeaponType]} at tile (${this.tile.x}, ${this.tile.y})`+(this.tile2?`, (${this.tile2.x}, ${this.tile2.y})`:"")}process(){var e,t=this.player,i=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);i?(e=this.tile2?this.game.map.tiles.getByMapCoords(this.tile2.x,this.tile2.y):void 0,this.game.traits.get(n.SuperWeaponsTrait).activateSuperWeapon(this.superWeaponType,t,this.game,i,e)):console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},e("ActivateSuperWeaponAction",o)}}}),System.register("game/api/ChatApi",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/action/DebugAction",["data/DataStream","game/action/Action","game/action/ActionType"],function(t,e){"use strict";var r,i,s,a,n,o;e&&e.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e}],execute:function(){var e;(e=a=a||{})[e.SetGlobalDebugText=0]="SetGlobalDebugText",e[e.SetUnitDebugText=1]="SetUnitDebugText",t("DebugCommandType",a),t("DebugCommand",n=class{constructor(e,t){this.type=e,this.params=t}}),o=class extends i.Action{constructor(e){super(s.ActionType.DebugCommand),this.game=e}unserialize(e){let t=new r.DataStream(e);var i=t.readUint8();i===a.SetUnitDebugText?this.command=new n(i,{unitId:t.readUint32(),label:t.readCString()||void 0}):i===a.SetGlobalDebugText?this.command=new n(i,{text:t.readCString()}):console.warn(`Debug command ${i} not implemented`)}serialize(){let e=new r.DataStream;if(e.writeUint8(this.command.type),this.command.type===a.SetUnitDebugText){var t=this.command.params;e.writeUint32(t.unitId),e.writeCString(t.label||"")}else{if(this.command.type!==a.SetGlobalDebugText)throw new Error(`Debug command ${this.command.type} not implemented`);t=this.command.params;e.writeCString(t.text)}return e.toUint8Array()}process(){if(this.command.type===a.SetUnitDebugText){var{unitId:t,label:i}=this.command.params;if(this.game.getWorld().hasObjectId(t)){let e=this.game.getObjectById(t);e.isTechno()&&(e.debugLabel=i)}}else this.command.type===a.SetGlobalDebugText?(i=this.command.params["text"],this.game.debugText.value=i):console.warn(`Debug command ${this.command.type} not implemented`)}},t("DebugAction",o)}}}),System.register("game/api/EventsApi",["game/event/EventType"],function(t,e){"use strict";var a,n,o,l,i,r,s;e&&e.id;return{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.ObjectOwnerChange=0]="ObjectOwnerChange",e[e.ObjectSpawn=1]="ObjectSpawn",e[e.ObjectUnspawn=2]="ObjectUnspawn",e[e.ObjectDestroy=3]="ObjectDestroy",t("ApiEventType",r),t("EventsApi",s=class{constructor(e){a.add(this),n.set(this,void 0),o.set(this,[]),__classPrivateFieldSet(this,n,e,"f")}subscribe(e,t){let i=void 0,r;r="function"==typeof e?e:(i=e,t);var s=__classPrivateFieldGet(this,n,"f").subscribe(e=>{var t=__classPrivateFieldGet(this,a,"m",l).call(this,e);!t||void 0!==i&&i!==t.type||r(t)});return __classPrivateFieldGet(this,o,"f").push(s),s}dispose(){for(var e of __classPrivateFieldGet(this,o,"f"))e();__classPrivateFieldGet(this,o,"f").length=0}}),n=new WeakMap,o=new WeakMap,a=new WeakSet,l=function(t){switch(t.type){case i.EventType.ObjectOwnerChange:return{type:r.ObjectOwnerChange,prevOwnerName:t.prevOwner.name,newOwnerName:t.target.owner.name,target:t.target.id};case i.EventType.ObjectSpawn:return{type:r.ObjectSpawn,target:t.gameObject.id};case i.EventType.ObjectUnspawn:return{type:r.ObjectUnspawn,target:t.gameObject.id};case i.EventType.ObjectDestroy:{let e=t;return e.target.isProjectile()?void 0:{type:r.ObjectDestroy,target:e.target.id,attackerInfo:e.attackerInfo?{playerName:e.attackerInfo.player.name,objId:e.attackerInfo.obj?.id,weaponName:e.attackerInfo.weapon?.rules.name}:void 0}}default:return}}}}}),System.register("game/api/interface/PlayerData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/interface/GameObjectData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/interface/UnitData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/interface/TileResourceData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/interface/PathNode",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/interface/PathFinderOptions",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/MapApi",["game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/math/Vector2"],function(e,t){"use strict";var r,a,s,n,o,l,i,c;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){i=e}],execute:function(){e("MapApi",c=class{constructor(e){r.add(this),a.set(this,void 0),s.set(this,void 0),__classPrivateFieldSet(this,a,e,"f"),__classPrivateFieldSet(this,s,e.map,"f")}getRealMapSize(){return __classPrivateFieldGet(this,s,"f").tiles.getMapSize()}getStartingLocations(){return __classPrivateFieldGet(this,s,"f").startingLocations.map(e=>new i.Vector2(e.x,e.y))}getTheaterType(){return __classPrivateFieldGet(this,s,"f").getTheaterType()}getTile(e,t){var i=__classPrivateFieldGet(this,s,"f").tiles.getByMapCoords(e,t);if(i&&__classPrivateFieldGet(this,s,"f").mapBounds.isWithinBounds(i))return i}getTilesInRect(e,t){let i=t?__classPrivateFieldGet(this,s,"f").tiles.getInRectangle(e,t):__classPrivateFieldGet(this,s,"f").tiles.getInRectangle(e);return i.filter(e=>__classPrivateFieldGet(this,s,"f").mapBounds.isWithinBounds(e))}getObjectsOnTile(e){return __classPrivateFieldGet(this,s,"f").getObjectsOnTile(e).map(e=>e.id)}hasBridgeOnTile(e){return!!e.onBridgeLandType}hasHighBridgeOnTile(e){return!!__classPrivateFieldGet(this,s,"f").tileOccupation.getBridgeOnTile(e)?.isHighBridge()}isPassableTile(e,t,i){return 0<__classPrivateFieldGet(this,s,"f").terrain.getPassableSpeed(e,t,i)}findPath(e,t,i,r){let s=__classPrivateFieldGet(this,a,"f").map.terrain.computePath(e,t.tile,t.onBridge,i.tile,i.onBridge,{bestEffort:r?.bestEffort,excludeTiles:r?.excludeNodes?e=>r.excludeNodes({tile:e.tile,onBridge:!!e.onBridge}):void 0,maxExpandedNodes:r?.maxExpandedNodes});return s.map(e=>({tile:e.tile,onBridge:!!e.onBridge}))}isVisibleTile(e,t,i=0){var r=__classPrivateFieldGet(this,a,"f").getPlayerByName(t);if(!r)throw new Error(`Player "${t}" doesn't exist`);return!__classPrivateFieldGet(this,a,"f").mapShroudTrait.getPlayerShroud(r)?.isShrouded(e,i)}getTileResourceData(e){var t=__classPrivateFieldGet(this,s,"f").getObjectsOnTile(e).find(e=>e.isOverlay()&&e.isTiberium()||e.isTerrain()&&e.rules.spawnsTiberium);return t?__classPrivateFieldGet(this,r,"m",n).call(this,t):void 0}getAllTilesResourceData(){var e;let t=[];for(e of __classPrivateFieldGet(this,a,"f").getWorld().getAllObjects()){var i=__classPrivateFieldGet(this,r,"m",n).call(this,e);i&&t.push(i)}return t}}),a=new WeakMap,s=new WeakMap,r=new WeakSet,n=function(t){let i;if(t.isOverlay()&&t.isTiberium()){let e=t.traits.get(o.TiberiumTrait);var r=e.getTiberiumType(),s=e.getBailCount();i={tile:t.tile,ore:r===l.TiberiumType.Ore?s:0,gems:r===l.TiberiumType.Gems?s:0,spawnsOre:!1}}else t.isTerrain()&&t.rules.spawnsTiberium&&(i={tile:t.tile,ore:0,gems:0,spawnsOre:!0});return i}}}}),System.register("game/api/interface/BuildingPlacementData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/interface/SuperWeaponData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/api/RulesApi",[],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[],execute:function(){e("RulesApi",r=class{constructor(e){i.set(this,void 0),__classPrivateFieldSet(this,i,e,"f")}get allObjectRules(){return __classPrivateFieldGet(this,i,"f").allObjectRules}get buildingRules(){return __classPrivateFieldGet(this,i,"f").buildingRules}get infantryRules(){return __classPrivateFieldGet(this,i,"f").infantryRules}get vehicleRules(){return __classPrivateFieldGet(this,i,"f").vehicleRules}get aircraftRules(){return __classPrivateFieldGet(this,i,"f").aircraftRules}get terrainRules(){return __classPrivateFieldGet(this,i,"f").terrainRules}get overlayRules(){return __classPrivateFieldGet(this,i,"f").overlayRules}get countryRules(){return __classPrivateFieldGet(this,i,"f").countryRules}get general(){return __classPrivateFieldGet(this,i,"f").general}get ai(){return __classPrivateFieldGet(this,i,"f").ai}get crateRules(){return __classPrivateFieldGet(this,i,"f").crateRules}get combatDamage(){return __classPrivateFieldGet(this,i,"f").combatDamage}get radiation(){return __classPrivateFieldGet(this,i,"f").radiation}hasObject(e,t){return __classPrivateFieldGet(this,i,"f").hasObject(e,t)}getObject(e,t){return __classPrivateFieldGet(this,i,"f").getObject(e,t)}getBuilding(e){return __classPrivateFieldGet(this,i,"f").getBuilding(e)}getWeapon(e){return __classPrivateFieldGet(this,i,"f").getWeapon(e)}getWarhead(e){return __classPrivateFieldGet(this,i,"f").getWarhead(e)}getProjectile(e){return __classPrivateFieldGet(this,i,"f").getProjectile(e)}getOverlayName(e){return __classPrivateFieldGet(this,i,"f").getOverlayName(e)}getOverlayId(e){return __classPrivateFieldGet(this,i,"f").getOverlayId(e)}getOverlay(e){return __classPrivateFieldGet(this,i,"f").getOverlay(e)}getCountry(e){return __classPrivateFieldGet(this,i,"f").getCountry(e)}getMultiplayerCountries(){return __classPrivateFieldGet(this,i,"f").getMultiplayerCountries()}getIni(){return __classPrivateFieldGet(this,i,"f").getIni()}}),i=new WeakMap}}}),System.register("game/api/GameApi",["game/player/trait/PowerTrait","game/api/MapApi","engine/type/ObjectType","game/GameSpeed","game/api/RulesApi"],function(e,t){"use strict";var r,n,s,a,i,o,l,c,h,u;t&&t.id;return{setters:[function(e){i=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("GameApi",u=class{constructor(e,t){r.add(this),n.set(this,void 0),s.set(this,void 0),__classPrivateFieldSet(this,n,e,"f"),__classPrivateFieldSet(this,s,t,"f"),this.mapApi=new o.MapApi(e),this.rulesApi=new h.RulesApi(e.rules)}isPlayerDefeated(e){return __classPrivateFieldGet(this,n,"f").getPlayerByName(e).defeated}areAlliedPlayers(e,t){var i=__classPrivateFieldGet(this,n,"f").getPlayerByName(e);if(!i)throw new Error(`Player "${e}" doesn't exist`);var r=__classPrivateFieldGet(this,n,"f").getPlayerByName(t);if(!r)throw new Error(`Player "${t}" doesn't exist`);return __classPrivateFieldGet(this,n,"f").alliances.areAllied(i,r)}canPlaceBuilding(e,t,i){var r=__classPrivateFieldGet(this,n,"f").getPlayerByName(e);if(!r)throw new Error(`Player "${e}" doesn't exist`);return __classPrivateFieldGet(this,n,"f").getConstructionWorker(r).canPlaceAt(t,i,{normalizedTile:!0})}getBuildingPlacementData(e){var t=__classPrivateFieldGet(this,n,"f").art.getObject(e,l.ObjectType.Building);return{foundation:t.foundation,foundationCenter:t.foundationCenter}}getPlayers(){return __classPrivateFieldGet(this,n,"f").getNonNeutralPlayers().map(e=>e.name)}getPlayerData(e){let t=__classPrivateFieldGet(this,n,"f").getPlayerByName(e);if(!t)throw new Error(`Player "${e}" doesn't exist`);return{name:t.name,country:t.country,startLocation:this.mapApi.getStartingLocations()[t.startLocation],isObserver:t.isObserver,isAi:t.isAi,isCombatant:t.isCombatant(),credits:t.credits,power:{total:t.powerTrait?.power??0,drain:t.powerTrait?.drain??0,isLowPower:t.powerTrait?.level===i.PowerLevel.Low},radarDisabled:!!t.radarTrait?.isDisabled()}}getAllTerrainObjects(){return __classPrivateFieldGet(this,n,"f").getWorld().getAllObjects().filter(e=>e.isTerrain()).map(e=>e.id)}getAllUnits(t=()=>!0){return __classPrivateFieldGet(this,n,"f").getWorld().getAllObjects().filter(e=>e.isTechno()&&t(e.rules)).map(e=>e.id)}getNeutralUnits(t=()=>!0){return __classPrivateFieldGet(this,n,"f").getCivilianPlayer().getOwnedObjects().filter(e=>t(e.rules)).map(e=>e.id)}getUnitsInArea(e){return __classPrivateFieldGet(this,n,"f").map.technosByTile.queryRange(e).map(e=>e.id)}getVisibleUnits(e,r,t=()=>!0){const s=__classPrivateFieldGet(this,n,"f").getPlayerByName(e);if(!s)throw new Error(`Player "${e}" doesn't exist`);if("self"===r)return s.getOwnedObjects().filter(e=>t(e.rules)).map(e=>e.id);let a;if("allied"===r)a=e=>e.owner===s||__classPrivateFieldGet(this,n,"f").alliances.areAllied(e.owner,s);else{if("hostile"!==r&&"enemy"!==r)throw new Error("Unexpected type "+r);{let i=__classPrivateFieldGet(this,n,"f").mapShroudTrait.getPlayerShroud(s);a=t=>__classPrivateFieldGet(this,n,"f").map.tileOccupation.calculateTilesForGameObject(t.tile,t).some(e=>!i?.isShrouded(e,t.tileElevation))&&t.owner!==s&&!__classPrivateFieldGet(this,n,"f").alliances.areAllied(t.owner,s)&&("enemy"!==r||t.owner.isCombatant())}}return __classPrivateFieldGet(this,n,"f").getWorld().getAllObjects().filter(e=>e.isTechno()&&a(e)&&t(e.rules)).map(e=>e.id)}getGameObjectData(t){if(__classPrivateFieldGet(this,n,"f").getWorld().hasObjectId(t)){let e=__classPrivateFieldGet(this,n,"f").getObjectById(t);return{id:e.id,type:e.type,name:e.name,rules:e.rules,tile:e.tile,tileElevation:e.tileElevation,worldPosition:e.position.worldPosition.clone(),foundation:e.getFoundation(),hitPoints:e.healthTrait?.getHitPoints(),maxHitPoints:e.healthTrait?.maxHitPoints}}}getUnitData(t){var i=this.getGameObjectData(t);if(i){let e=__classPrivateFieldGet(this,n,"f").getObjectById(t);if(!e.isTechno())throw new Error(`Game object with id ${t} is not a Techno type`);return{...i,owner:e.owner.name,sight:e.sight,veteranLevel:e.veteranLevel,guardMode:e.guardMode,purchaseValue:e.purchaseValue,primaryWeapon:e.primaryWeapon?__classPrivateFieldGet(this,r,"m",a).call(this,e.primaryWeapon):void 0,secondaryWeapon:e.secondaryWeapon?__classPrivateFieldGet(this,r,"m",a).call(this,e.secondaryWeapon):void 0,deathWeapon:e.armedTrait?.deathWeapon?__classPrivateFieldGet(this,r,"m",a).call(this,e.armedTrait.deathWeapon):void 0,attackState:e.attackTrait?.attackState,direction:e.direction,onBridge:e.isInfantry()||e.isVehicle()?e.onBridge:void 0,zone:e.isUnit()?e.zone:void 0,buildStatus:e.isBuilding()?e.buildStatus:void 0,factory:e.isBuilding()&&e.factoryTrait?{deliveringUnit:e.factoryTrait.deliveringUnit?.id,status:e.factoryTrait.status}:void 0,rallyPoint:e.isBuilding()?e.rallyTrait?.getRallyPoint():void 0,isPoweredOn:e.isBuilding()&&e.poweredTrait?.isPoweredOn(),hasWrenchRepair:e.isBuilding()&&!e.autoRepairTrait.isDisabled(),turretFacing:e.isBuilding()||e.isVehicle()?e.turretTrait?.facing:void 0,turretNo:e.isVehicle()?e.turretNo:void 0,garrisonUnitCount:e.isBuilding()?e.garrisonTrait?.units.length:void 0,garrisonUnitsMax:e.isBuilding()?e.garrisonTrait?.maxOccupants:void 0,isIdle:!e.unitOrderTrait.hasTasks(),canMove:e.isUnit()?!e.moveTrait.isDisabled():void 0,velocity:e.isUnit()?e.moveTrait.velocity.clone():void 0,stance:e.isInfantry()?e.stance:void 0,harvestedOre:e.isVehicle()?e.harvesterTrait?.ore:void 0,harvestedGems:e.isVehicle()?e.harvesterTrait?.gems:void 0,ammo:e.isAircraft()?e.ammo:void 0,isWarpedOut:e.warpedOutTrait.isActive(),mindControlledBy:e.mindControllableTrait?.getController()?.id,tntTimer:e.tntChargeTrait?.getTicksLeft()}}}getAllSuperWeaponData(){return __classPrivateFieldGet(this,n,"f").getCombatants().map(t=>t.superWeaponsTrait.getAll().map(e=>({playerName:t.name,type:e.rules.type,status:e.status,timerSeconds:e.getTimerSeconds()}))).flat()}getGeneralRules(){return __classPrivateFieldGet(this,n,"f").rules.general}getRulesIni(){return __classPrivateFieldGet(this,n,"f").rules.getIni()}getArtIni(){return __classPrivateFieldGet(this,n,"f").art.getIni()}getAiIni(){return __classPrivateFieldGet(this,n,"f").ai.getIni()}generateRandomInt(e,t){if(__classPrivateFieldGet(this,s,"f"))return __classPrivateFieldGet(this,n,"f").generateRandomInt(e,t);var i=this.generateRandom();return Math.round(i*(t-e))+e}generateRandom(){return __classPrivateFieldGet(this,s,"f")?__classPrivateFieldGet(this,n,"f").generateRandom():Math.random()}getTickRate(){return __classPrivateFieldGet(this,n,"f").speed.value*c.GameSpeed.BASE_TICKS_PER_SECOND}getBaseTickRate(){return c.GameSpeed.BASE_TICKS_PER_SECOND}getCurrentTick(){return __classPrivateFieldGet(this,n,"f").currentTick}getCurrentTime(){return __classPrivateFieldGet(this,n,"f").currentTime/1e3}}),n=new WeakMap,s=new WeakMap,r=new WeakSet,a=function(e){return{type:e.type,rules:e.rules,projectileRules:e.projectileRules,warheadRules:e.warhead.rules,minRange:e.minRange,maxRange:e.range,speed:e.speed,cooldownTicks:e.getCooldownTicks()}}}}}),System.register("util/format",["util/string"],function(e,t){"use strict";var a;t&&t.id;return e("formatTimeDuration",function(e,t=!1){var i=Math.floor(e/3600);e-=3600*i;var r=Math.floor(e/60),s=e-=60*r;return[...i||!t?[i]:[],a.pad(r,"00"),a.pad(s,"00")].join(":")}),{setters:[function(e){a=e}],execute:function(){}}}),System.register("game/api/LoggerApi",["util/format","util/Logger"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){n=e},function(e){o=e}],execute:function(){e("LoggerApi",l=class{constructor(e,t){i.add(this),r.set(this,void 0),s.set(this,void 0),__classPrivateFieldSet(this,r,e,"f"),__classPrivateFieldSet(this,s,t,"f")}setDebugLevel(e){__classPrivateFieldGet(this,r,"f").setLevel(e?o.AppLogger.DEBUG:o.AppLogger.WARN)}debug(...e){__classPrivateFieldGet(this,r,"f").debug(__classPrivateFieldGet(this,i,"m",a).call(this),...e)}info(...e){__classPrivateFieldGet(this,r,"f").info(__classPrivateFieldGet(this,i,"m",a).call(this),...e)}log(...e){__classPrivateFieldGet(this,r,"f").log(__classPrivateFieldGet(this,i,"m",a).call(this),...e)}warn(...e){__classPrivateFieldGet(this,r,"f").warn(__classPrivateFieldGet(this,i,"m",a).call(this),...e)}error(...e){__classPrivateFieldGet(this,r,"f").error(__classPrivateFieldGet(this,i,"m",a).call(this),...e)}time(e){__classPrivateFieldGet(this,r,"f").time(e)}timeEnd(e){__classPrivateFieldGet(this,r,"f").timeEnd(e)}}),r=new WeakMap,s=new WeakMap,i=new WeakSet,a=function(){return"["+n.formatTimeDuration(Math.floor(__classPrivateFieldGet(this,s,"f").getCurrentTime()))+"]"}}}}),System.register("game/api/ProductionApi",[],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[],execute:function(){e("ProductionApi",r=class{constructor(e){i.set(this,void 0),__classPrivateFieldSet(this,i,e,"f")}isAvailableForProduction(e){return __classPrivateFieldGet(this,i,"f").isAvailableForProduction(e)}getAvailableObjects(t){let e=__classPrivateFieldGet(this,i,"f").getAvailableObjects();return void 0!==t&&(e=e.filter(e=>this.getQueueTypeForObject(e)===t)),e}getQueueTypeForObject(e){return __classPrivateFieldGet(this,i,"f").getQueueTypeForObject(e)}getQueueData(e){let t=__classPrivateFieldGet(this,i,"f").getQueue(e);return{size:t.currentSize,maxSize:t.maxSize,status:t.status,type:t.type,items:t.getAll().map(e=>({rules:e.rules,quantity:e.quantity}))}}}),i=new WeakMap}}}),System.register("game/bot/Bot",[],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[],execute:function(){e("Bot",r=class{constructor(e,t){this.name=e,this.country=t,i.set(this,!1)}setGameApi(e){this.gameApi=e}setActionsApi(e){this.actionsApi=e}setProductionApi(e){this.productionApi=e}setLogger(e){this.logger=e,this.logger.setDebugLevel(__classPrivateFieldGet(this,i,"f"))}setDebugMode(e){return __classPrivateFieldSet(this,i,e,"f"),this.logger?.setDebugLevel(e),this}getDebugMode(){return __classPrivateFieldGet(this,i,"f")}onGameStart(e){}onGameTick(e){}onGameEvent(e,t){}}),i=new WeakMap}}}),System.register("game/api/ActionsApi",["game/action/ActionType","game/action/UpdateQueueAction","game/action/DebugAction"],function(e,t){"use strict";var l,a,n,c,o,h,u,d,g,r,i;t&&t.id;return{setters:[function(e){d=e},function(e){g=e},function(e){r=e}],execute:function(){e("ActionsApi",i=class{constructor(e,t,i,r,s){l.add(this),a.set(this,void 0),n.set(this,void 0),c.set(this,void 0),o.set(this,void 0),h.set(this,void 0),__classPrivateFieldSet(this,a,t,"f"),__classPrivateFieldSet(this,n,i,"f"),__classPrivateFieldSet(this,c,e,"f"),__classPrivateFieldSet(this,o,r,"f"),__classPrivateFieldSet(this,h,s,"f")}placeBuilding(t,i,r){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.PlaceBuilding,e=>{e.buildingRules=__classPrivateFieldGet(this,c,"f").rules.getBuilding(t),e.tile={x:i,y:r}})}sellBuilding(t){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.SellBuilding,e=>{e.buildingId=t})}toggleRepairWrench(t){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.ToggleRepair,e=>{e.buildingId=t})}toggleAlliance(t,i){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.ToggleAlliance,e=>{e.toPlayer=__classPrivateFieldGet(this,c,"f").getPlayerByName(t),e.toggle=i})}pauseProduction(t){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.UpdateQueue,e=>{e.queueType=t,e.updateType=g.UpdateType.Pause})}resumeProduction(t){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.UpdateQueue,e=>{e.queueType=t,e.updateType=g.UpdateType.Resume})}queueForProduction(t,e,i,r){let s=__classPrivateFieldGet(this,c,"f").rules.getObject(e,i);__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.UpdateQueue,e=>{e.queueType=t,e.updateType=g.UpdateType.Add,e.item=s,e.quantity=r})}unqueueFromProduction(t,e,i,r){let s=__classPrivateFieldGet(this,c,"f").rules.getObject(e,i);__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.UpdateQueue,e=>{e.queueType=t,e.updateType=g.UpdateType.Cancel,e.item=s,e.quantity=r})}activateSuperWeapon(t,i,r){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.ActivateSuperWeapon,e=>{e.superWeaponType=t,e.tile={x:i.rx,y:i.ry},e.tile2=r?{x:r.rx,y:r.ry}:void 0})}orderUnits(t,i,r,s,a){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.SelectUnits,e=>{e.unitIds=t});let n;if(r){let e,t;if(s){e=void 0;var o=__classPrivateFieldGet(this,c,"f").map.tiles.getByMapCoords(r,s);if(!o)throw new Error(`No tile found at rx,ry=${r},`+s);t=o,a&&(e=__classPrivateFieldGet(this,c,"f").map.tileOccupation.getBridgeOnTile(o))}else{if(!__classPrivateFieldGet(this,c,"f").getWorld().hasObjectId(r))return;e=__classPrivateFieldGet(this,c,"f").getObjectById(r),t=e.tile}n=__classPrivateFieldGet(this,c,"f").createTarget(e,t)}__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.OrderUnits,e=>{e.orderType=i,e.target=n})}sayAll(e){__classPrivateFieldGet(this,h,"f")?.sayAll(__classPrivateFieldGet(this,o,"f").name,e)}setGlobalDebugText(t){__classPrivateFieldGet(this,o,"f").getDebugMode()&&__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.DebugCommand,e=>{e.command=new r.DebugCommand(r.DebugCommandType.SetGlobalDebugText,{text:t||""})})}setUnitDebugText(t,i){__classPrivateFieldGet(this,o,"f").getDebugMode()&&__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.DebugCommand,e=>{e.command=new r.DebugCommand(r.DebugCommandType.SetUnitDebugText,{unitId:t,label:i})})}quitGame(){__classPrivateFieldGet(this,l,"m",u).call(this,d.ActionType.ResignGame)}}),a=new WeakMap,n=new WeakMap,c=new WeakMap,o=new WeakMap,h=new WeakMap,l=new WeakSet,u=function(e,t){let i=__classPrivateFieldGet(this,a,"f").create(e);i.player=__classPrivateFieldGet(this,c,"f").getPlayerByName(__classPrivateFieldGet(this,o,"f").name),t?.(i),__classPrivateFieldGet(this,n,"f").push(i)}}}}),System.register("game/api/interface/PlayerStats",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/type/PipColor",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Green=0]="Green",e[e.Yellow=1]="Yellow",e[e.White=2]="White",e[e.Red=3]="Red",e[e.Blue=4]="Blue",t("PipColor",i)}}}),System.register("game/api/index",["game/bot/Bot","game/api/EventsApi","game/math/GameMath","game/math/Box2","game/math/Vector2","game/math/Vector3","game/math/Euler","game/math/Quaternion","game/math/Matrix4","game/math/Spherical","game/math/Cylindrical","engine/TheaterType","engine/type/ObjectType","game/gameobject/Building","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/trait/AttackTrait","game/gameobject/trait/FactoryTrait","game/gameobject/unit/VeteranLevel","game/order/OrderType","game/player/production/ProductionQueue","game/rules/GeneralRules","game/rules/general/RadarRules","game/type/SpeedType","game/WeaponType","game/rules/TechnoRules","data/map/tag/TagRepeatType","engine/type/TerrainType","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranAbility","game/SideType","game/type/ArmorType","game/type/LandTargeting","game/type/LandType","game/type/LocomotorType","game/type/MovementZone","game/type/NavalTargeting","game/type/PipColor","game/type/SuperWeaponType","game/SuperWeapon","game/type/VhpScan"],function(t,e){"use strict";e&&e.id;return{setters:[function(e){t({Bot:e.Bot})},function(e){t({ApiEventType:e.ApiEventType})},function(e){t({GameMath:e.GameMath})},function(e){t({Box2:e.Box2})},function(e){t({Vector2:e.Vector2})},function(e){t({Vector3:e.Vector3})},function(e){t({Euler:e.Euler})},function(e){t({Quaternion:e.Quaternion})},function(e){t({Matrix4:e.Matrix4})},function(e){t({Spherical:e.Spherical})},function(e){t({Cylindrical:e.Cylindrical})},function(e){t({TheaterType:e.TheaterType})},function(e){t({ObjectType:e.ObjectType})},function(e){t({BuildStatus:e.BuildStatus})},function(e){t({StanceType:e.StanceType})},function(e){t({ZoneType:e.ZoneType})},function(e){t({AttackState:e.AttackState})},function(e){t({FactoryStatus:e.FactoryStatus})},function(e){t({VeteranLevel:e.VeteranLevel})},function(e){t({OrderType:e.OrderType})},function(e){t({QueueType:e.QueueType}),t({QueueStatus:e.QueueStatus})},function(e){t({PrereqCategory:e.PrereqCategory})},function(e){t({RadarEventType:e.RadarEventType})},function(e){t({SpeedType:e.SpeedType})},function(e){t({WeaponType:e.WeaponType})},function(e){t({FactoryType:e.FactoryType}),t({BuildCat:e.BuildCat})},function(e){t({TagRepeatType:e.TagRepeatType})},function(e){t({TerrainType:e.TerrainType})},function(e){t({InfDeathType:e.InfDeathType})},function(e){t({VeteranAbility:e.VeteranAbility})},function(e){t({SideType:e.SideType})},function(e){t({ArmorType:e.ArmorType})},function(e){t({LandTargeting:e.LandTargeting})},function(e){t({LandType:e.LandType})},function(e){t({LocomotorType:e.LocomotorType})},function(e){t({MovementZone:e.MovementZone})},function(e){t({NavalTargeting:e.NavalTargeting})},function(e){t({PipColor:e.PipColor})},function(e){t({SuperWeaponType:e.SuperWeaponType})},function(e){t({SuperWeaponStatus:e.SuperWeaponStatus})},function(e){t({VhpScan:e.VhpScan})}],execute:function(){}}}),System.register("game/bot/BotsLib",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/bot/DummyBot",["game/bot/Bot","game/order/OrderType"],function(t,e){"use strict";var i,r,s,a;e&&e.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){var e;(e=s=s||{})[e.Initial=0]="Initial",e[e.Deployed=1]="Deployed",e[e.Attacking=2]="Attacking",e[e.Defeated=3]="Defeated",a=class extends i.Bot{constructor(){super(...arguments),this.botState=s.Initial}onGameStart(t){var e=t.getTickRate();this.tickRatio=Math.ceil(e/5),this.enemyPlayers=t.getPlayers().filter(e=>e!==this.name&&!t.areAlliedPlayers(this.name,e))}onGameTick(e){if(e.getCurrentTick()%this.tickRatio==0)switch(this.botState){case s.Initial:{const i=e.getGeneralRules().baseUnit;if(e.getVisibleUnits(this.name,"self",e=>e.constructionYard).length){this.botState=s.Deployed;break}var t=e.getVisibleUnits(this.name,"self",e=>i.includes(e.name));t.length&&this.actionsApi.orderUnits([t[0]],r.OrderType.DeploySelected);break}case s.Deployed:break;case s.Attacking:e.getVisibleUnits(this.name,"self",e=>e.isSelectableCombatant).length||(this.botState=s.Defeated,this.actionsApi.quitGame())}}},t("DummyBot",a)}}}),System.register("game/bot/BotFactory",["game/gameopts/GameOpts","game/bot/DummyBot"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("BotFactory",s=class{constructor(e){this.botsLib=e}create(e){if(!e.isAi)throw new Error(`Player "${e.name}" is not an AI`);switch(e.aiDifficulty){case i.AiDifficulty.Easy:return new r.DummyBot(e.name,e.country.name);case i.AiDifficulty.Medium:if(this.botsLib.SupalosaBot)return new this.botsLib.SupalosaBot(e.name,e.country.name);default:throw new Error(`Unsupported AI difficulty "${e.aiDifficulty}"`)}}})}}}),System.register("game/BotManager",["util/disposable/CompositeDisposable","util/Logger","game/action/ActionQueue","game/api/ActionsApi","game/api/EventsApi","game/api/GameApi","game/api/LoggerApi","game/api/ProductionApi"],function(e,t){"use strict";var a,n,s,o,l,c,h,u,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){s=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("BotManager",i=class{constructor(e,t,i,r,s){this.actionFactory=e,this.actionQueue=t,this.botFactory=i,this.botDebugIndex=r,this.actionLogger=s,this.bots=new Map,this.disposables=new a.CompositeDisposable}static factory(e,t,i,r){return new this(e,new s.ActionQueue,t,i,r)}init(t){this.gameApi=new c.GameApi(t,!0);let e=new l.EventsApi(t.events);var i,r;for(i of t.getCombatants().filter(e=>e.isAi))this.bots.set(i,this.botFactory.create(i));this.updateDebugBotIndex(this.botDebugIndex.value,t);let s=e=>this.updateDebugBotIndex(e,t);this.botDebugIndex.onChange.subscribe(s),this.disposables.add(()=>this.botDebugIndex.onChange.unsubscribe(s)),e.subscribe(t=>this.bots.forEach(e=>e.onGameEvent(t,this.gameApi))),this.disposables.add(e);for(r of this.bots.values())r.setGameApi(this.gameApi),r.setActionsApi(new o.ActionsApi(t,this.actionFactory,this.actionQueue,r)),r.setProductionApi(new u.ProductionApi(t.getPlayerByName(r.name).production)),r.setLogger(new h.LoggerApi(n.AppLogger.get(r.name),this.gameApi)),r.onGameStart(this.gameApi)}update(e){var t,i;for(t of this.actionQueue.dequeueAll()){t.process();var r=t.print();r&&this.actionLogger.debug(`(${t.player.name})@${e.currentTick}: `+r)}for(i of e.getCombatants().filter(e=>e.isAi))this.bots.get(i).onGameTick(this.gameApi)}updateDebugBotIndex(e,t){var i,r=0<e?t.getAiPlayerName(e):void 0;for(i of this.bots.values())i.setDebugMode(i.name===r)}dispose(){this.gameApi=void 0,this.bots.clear(),this.disposables.dispose()}})}}}),System.register("game/gameopts/constants",["game/gameopts/GameOpts"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("RANDOM_COUNTRY_ID",-2),e("RANDOM_COLOR_ID",-2),e("RANDOM_START_POS",-2),e("NO_TEAM_ID",-2),e("OBS_COUNTRY_ID",-3),e("OBS_COLOR_ID",-2),e("RANDOM_COUNTRY_NAME","Random"),e("OBS_COUNTRY_NAME","Observer"),e("aiUiNames",(new Map).set(i.AiDifficulty.Easy,"GUI:AIDummy").set(i.AiDifficulty.Medium,"GUI:AIEasyBeta")),e("aiUiTooltips",new Map),e("RANDOM_COUNTRY_UI_NAME","GUI:RandomEx"),e("RANDOM_COUNTRY_UI_TOOLTIP","STT:PlayerSideRandom"),e("OBS_COUNTRY_UI_NAME","GUI:Observer"),e("OBS_COUNTRY_UI_TOOLTIP","STT:PlayerSideObserver"),e("RANDOM_COLOR_NAME","")}}}),System.register("game/event/StalemateDetectEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("StalemateDetectEvent",r=class{constructor(){this.type=i.EventType.StalemateDetect}})}}}),System.register("game/trait/StalemateDetectTrait",["game/event/StalemateDetectEvent","game/GameSpeed","game/trait/interface/NotifyDestroy","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyPlaceBuilding","game/trait/interface/NotifyProduceUnit","game/trait/interface/NotifyTick"],function(e,t){"use strict";var r,i,s,a,n,o,l,c;t&&t.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=class c{constructor(){this.stale=!1,this.allPlayersCredits=new Map,this.resetCountdown()}isStale(){return this.stale}getCountdownTicks(){return this.countdownTicks}resetCountdown(){this.countdownTicks=Math.floor(60*c.graceMinutes*i.GameSpeed.BASE_TICKS_PER_SECOND)}clearStale(){this.stale=!1,this.resetCountdown()}[l.NotifyTick.onTick](e){0<this.countdownTicks?this.countdownTicks--:this.stale||(this.stale=!0,this.resetCountdown(),e.events.dispatch(new r.StalemateDetectEvent));for(var t of e.getCombatants()){var i=this.allPlayersCredits.get(t);i!==t.credits&&(this.allPlayersCredits.set(t,t.credits),t.credits>(i??0)&&t.production.hasAnyFactory()&&this.clearStale())}}[o.NotifyProduceUnit.onProduce](){this.clearStale()}[n.NotifyPlaceBuilding.onPlace](e){e.wallTrait||this.clearStale()}[s.NotifyDestroy.onDestroy](e,t,i){!e.isBuilding()||e.owner.isNeutral||e.wallTrait||e.rules.insignificant||i?.obj&&t.areFriendly(e,i.obj)||this.clearStale()}[a.NotifyOwnerChange.onChange](e,t,i){e.isBuilding()&&!t.isNeutral&&(i.alliances.areAllied(e.owner,t)||this.clearStale())}},e("StalemateDetectTrait",c),c.graceMinutes=5}}}),System.register("game/Prng",["mersenne-twister"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Prng",r=class{constructor(e){this.prng=new i.default(e)}generateRandomInt(e,t){var i=this.prng.random();return this.lastRandom=i,Math.round(i*(t-e))+e}generateRandom(){var e=this.prng.random();return this.lastRandom=e}getLastRandom(){return this.lastRandom}})}}}),System.register("game/trigger/TriggerTarget",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/trigger/TriggerCondition",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("TriggerCondition",i=class{constructor(e,t){this.event=e,this.trigger=t,this.blocking=!1,this.targets=[]}init(e){var t=e.getAllPlayers().find(e=>e.country?.name===this.trigger.houseName);t&&(this.player=t)}setTargets(e){this.targets=e}reset(){}getDebugName(){return`${this.event.triggerId}[${this.event.eventIndex}] (${this.trigger.name}).`}})}}}),System.register("game/trigger/TriggerInstance",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/trigger/TriggerExecutor",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("TriggerExecutor",i=class{constructor(e,t){this.action=e,this.trigger=t}getDebugName(){return`${this.action.triggerId}[${this.action.index}] (${this.trigger.name}).`}})}}}),System.register("game/trigger/executor/AddSuperWeaponExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.oneTimeOnly=i,this.superWeaponIdx=Number(e.params[1])}execute(i){var r=[...i.rules.superWeaponRules.values()].find(e=>e.index===this.superWeaponIdx);if(r){let t=i.getAllPlayers().find(e=>e.country?.name===this.trigger.houseName);if(t&&t.superWeaponsTrait&&!t.superWeaponsTrait.has(r.name)){let e=i.createSuperWeapon(r.name,t,this.oneTimeOnly);e.isGift=!0,t.superWeaponsTrait.add(e)}}else console.warn(`No superweapon found with index "${this.superWeaponIdx}". `+`Skipping action ${this.getDebugName()}.`)}},e("AddSuperWeaponExecutor",r)}}}),System.register("game/trigger/executor/ApplyDamageExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],function(e,t){"use strict";var n,o,l,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.damage=i}execute(t){var e=Number(this.action.params[1]),i=t.map.getTileAtWaypoint(e);if(i){var r=t.rules.getWarhead(l.Warhead.HE_WARHEAD_NAME);let e=new l.Warhead(r);var s=t.map.tileOccupation.getBridgeOnTile(i),a=s?.tileElevation??0,r=t.map.getTileZone(i);e.detonate(t,this.damage,i,a,n.Coords.tile3dToWorld(i.rx+.5,i.ry+.5,i.z+a),r,s?o.CollisionType.OnBridge:o.CollisionType.None,t.createTarget(s,i),void 0,!1,!1,void 0)}else console.warn(`No valid location found for waypoint ${e}. `+`Skipping action ${this.getDebugName()}.`)}},e("ApplyDamageExecutor",r)}}}),System.register("game/trigger/executor/ChangeHouseAllExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){let i=e.getAllPlayers().find(e=>e.country?.name===this.trigger.houseName);if(i){let t=Number(this.action.params[1]);var r=e.getAllPlayers().find(e=>e.country?.id===t);if(r)for(var s of i.getOwnedObjects(!0))e.changeObjectOwner(s,r)}}},e("ChangeHouseAllExecutor",r)}}}),System.register("game/trigger/executor/ChangeHouseExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(e,t){"use strict";var s,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}execute(e,t){var i=e.getAllPlayers().find(e=>e.country?.id===this.houseId);if(i)for(var r of t)r instanceof s.GameObject&&r.isSpawned&&e.changeObjectOwner(r,i)}},e("ChangeHouseExecutor",r)}}}),System.register("game/trigger/executor/CheerExecutor",["engine/type/ObjectType","game/gameobject/task/CheerTask","game/trigger/TriggerExecutor"],function(e,t){"use strict";var r,s,i,a;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e}],execute:function(){a=class extends i.TriggerExecutor{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}execute(e){let t=e.getAllPlayers().filter(e=>e.country&&!e.defeated);if(-1!==this.houseId&&(t=t.filter(e=>e.country?.id===this.houseId)),t.length)for(var i of t[0].getOwnedObjectsByType(r.ObjectType.Infantry))i.unitOrderTrait.isIdle()&&i.unitOrderTrait.addTask(new s.CheerTask)}},e("CheerExecutor",a)}}}),System.register("game/trigger/executor/CreateCrateExecutor",["game/type/PowerupType","game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r,a,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){a=new Map([[0,e=>{var t=e.rules.powerups.powerups.find(e=>e.type===i.PowerupType.Money);return t?{...t,data:"5000"}:void 0}],[1,i.PowerupType.Unit],[2,i.PowerupType.HealBase],[3,i.PowerupType.Cloak],[4,i.PowerupType.Explosion],[5,i.PowerupType.Napalm],[6,i.PowerupType.Money],[7,i.PowerupType.Darkness],[8,i.PowerupType.Reveal],[9,i.PowerupType.Armor],[10,i.PowerupType.Speed],[11,i.PowerupType.Firepower],[12,i.PowerupType.ICBM],[13,void 0],[14,i.PowerupType.Veteran],[15,void 0],[16,i.PowerupType.Gas],[17,i.PowerupType.Tiberium],[18,void 0]]),s=class extends r.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),i=this.action.params[6],r=e.map.getTileAtWaypoint(i);if(r)if(a.has(t)){const s=a.get(t);t="function"==typeof s?s(e):e.rules.powerups.powerups.find(e=>e.type===s);t&&e.crateGeneratorTrait.spawnCrateAt(r,t,e)}else e.crateGeneratorTrait.spawnRandomCrateAt(r,e);else console.warn(`No valid location found for waypoint ${i}. `+`Skipping action ${this.getDebugName()}.`)}},e("CreateCrateExecutor",s)}}}),System.register("game/trigger/executor/CreateRadarEventExecutor",["game/rules/general/RadarRules","game/trait/RadarTrait","game/trigger/TriggerExecutor"],function(e,t){"use strict";var a,n,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1])-1;if(Object.values(a.RadarEventType).includes(t)){var i=this.action.params[6],r=e.map.getTileAtWaypoint(i);if(r)for(var s of e.getCombatants())e.traits.get(n.RadarTrait).addEventForPlayer(t,s,r,e);else console.warn(`No valid location found for waypoint ${i}. `+`Skipping action ${this.getDebugName()}.`)}else console.warn(`Unknown radar event type "${1+t}". Skipping action ${this.getDebugName()}.`)}},e("CreateRadarEventExecutor",r)}}}),System.register("game/trigger/executor/DestroyObjectExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerExecutor{execute(e,t){for(var i of t)i instanceof r.GameObject&&i.isSpawned&&e.destroyObject(i)}},e("DestroyObjectExecutor",s)}}}),System.register("game/trigger/executor/DestroyTagExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action.params[1];e.triggers.destroyTag(t)}},e("DestroyTagExecutor",r)}}}),System.register("game/trigger/executor/DestroyTriggerExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action.params[1];e.triggers.destroyTrigger(t)}},e("DestroyTriggerExecutor",r)}}}),System.register("game/trigger/executor/DetonateWarheadExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],function(e,t){"use strict";var l,c,h,i,r;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(r){var s=Number(this.action.params[1]),e=this.action.params[6],a=r.map.getTileAtWaypoint(e);if(a){let t;try{t=r.rules.getWeaponByInternalId(s)}catch(e){if(e instanceof RangeError)return void console.warn(`Weapon with internal ID "${s}" not found. `+`Skipping action ${this.getDebugName()}.`);throw e}let e;try{e=r.rules.getWarhead(t.warhead)}catch(e){return void console.warn(`Warhead "${t.warhead}" not found. `+`Skipping action ${this.getDebugName()}.`)}let i=new h.Warhead(e);var n=r.map.tileOccupation.getBridgeOnTile(a),o=n?.tileElevation??0,s=r.map.getTileZone(a);i.detonate(r,t.damage,a,o,l.Coords.tile3dToWorld(a.rx+.5,a.ry+.5,a.z+o),s,n?c.CollisionType.OnBridge:c.CollisionType.None,r.createTarget(n,a),void 0,!1,!1,void 0)}else console.warn(`No valid location found for waypoint ${e}. `+`Skipping action ${this.getDebugName()}.`)}},e("DetonateWarheadExecutor",r)}}}),System.register("game/trigger/executor/EvictOccupiersExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerExecutor{execute(e,t){for(var i of t)i instanceof r.GameObject&&i.isBuilding()&&i.garrisonTrait&&!i.isDestroyed&&i.garrisonTrait.evacuate(e)}},e("EvictOccupiersExecutor",s)}}}),System.register("game/trigger/executor/FireSaleExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}execute(e){var t=e.getAllPlayers().find(e=>e.country?.id===this.houseId);if(t)for(var i of t.buildings)e.sellTrait.sell(i)}},e("FireSaleExecutor",r)}}}),System.register("game/trigger/executor/ForceEndExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.end()}},e("ForceEndExecutor",r)}}}),System.register("game/trigger/executor/ForceTriggerExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action.params[1];e.triggers.forceTrigger(t,e)}},e("ForceTriggerExecutor",r)}}}),System.register("game/trigger/executor/GlobalVariableExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.value=i,this.variableIdx=Number(e.params[1])}execute(e){e.triggers.toggleGlobalVariable(this.variableIdx,this.value)}},e("GlobalVariableExecutor",r)}}}),System.register("game/trigger/executor/IronCurtainExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(e,t){"use strict";var a,n,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t,i,r=this.action.params[6],s=e.map.getTileAtWaypoint(r);s?!(t=e.getAllPlayers().find(e=>!e.defeated&&e.country?.name===this.trigger.houseName))||(i=[...e.rules.superWeaponRules.values()].find(e=>e.type===n.SuperWeaponType.IronCurtain))&&e.traits.get(a.SuperWeaponsTrait).activateEffect(i,t,e,s,void 0,!0):console.warn(`No valid location found for waypoint ${r}. `+`Skipping action ${this.getDebugName()}.`)}},e("IronCurtainExecutor",r)}}}),System.register("game/trigger/executor/LightningStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(e,t){"use strict";var a,n,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t,i,r=this.action.params[6],s=e.map.getTileAtWaypoint(r);s?!(t=e.getAllPlayers().find(e=>!e.defeated&&e.country?.name===this.trigger.houseName))||(i=[...e.rules.superWeaponRules.values()].find(e=>e.type===n.SuperWeaponType.LightningStorm))&&e.traits.get(a.SuperWeaponsTrait).activateEffect(i,t,e,s,void 0,!0):console.warn(`No valid location found for waypoint ${r}. `+`Skipping action ${this.getDebugName()}.`)}},e("LightningStrikeExecutor",r)}}}),System.register("game/trigger/executor/LocalVariableExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.value=i,this.variableIdx=Number(e.params[1])}execute(e){e.triggers.toggleLocalVariable(this.variableIdx,this.value)}},e("LocalVariableExecutor",r)}}}),System.register("game/trigger/executor/NoActionExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(){}},e("NoActionExecutor",r)}}}),System.register("game/trigger/executor/NukeStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(e,t){"use strict";var a,n,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t,i,r=this.action.params[6],s=e.map.getTileAtWaypoint(r);s?!(t=e.getAllPlayers().find(e=>!e.defeated&&e.country?.name===this.trigger.houseName))||(i=[...e.rules.superWeaponRules.values()].find(e=>e.type===n.SuperWeaponType.MultiMissile))&&e.traits.get(a.SuperWeaponsTrait).activateEffect(i,t,e,s,void 0,!0):console.warn(`No valid location found for waypoint ${r}. `+`Skipping action ${this.getDebugName()}.`)}},e("NukeStrikeExecutor",r)}}}),System.register("game/event/TriggerAnimEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("TriggerAnimEvent",r=class{constructor(e,t){this.name=e,this.tile=t,this.type=i.EventType.TriggerAnim}})}}}),System.register("game/trigger/executor/PlayAnimAtExecutor",["game/event/TriggerAnimEvent","game/trigger/TriggerExecutor"],function(e,t){"use strict";var a,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t,i=this.action,r=Number(i.params[1]),s=e.rules.getAnimationName(r);void 0!==s?(t=i.params[6],(i=e.map.getTileAtWaypoint(t))?e.events.dispatch(new a.TriggerAnimEvent(s,i)):console.warn(`No valid location found for waypoint ${t}. `+`Skipping action ${this.getDebugName()}.`)):console.warn(`No animation found for index "${r}". Skipping action `+this.getDebugName())}},e("PlayAnimAtExecutor",r)}}}),System.register("game/event/TriggerSoundFxEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("TriggerSoundFxEvent",r=class{constructor(e,t){this.soundId=e,this.tile=t,this.type=i.EventType.TriggerSoundFx}})}}}),System.register("game/trigger/executor/PlaySoundFxAtExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],function(e,t){"use strict";var s,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action,i=t.params[1],r=t.params[6],t=e.map.getTileAtWaypoint(r);t?e.events.dispatch(new s.TriggerSoundFxEvent(i,t)):console.warn(`No valid location found for waypoint ${r}. `+`Skipping action ${this.getDebugName()}.`)}},e("PlaySoundFxAtExecutor",r)}}}),System.register("game/trigger/executor/PlaySoundFxExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){e.events.dispatch(new i.TriggerSoundFxEvent(this.action.params[1]))}},e("PlaySoundFxExecutor",s)}}}),System.register("game/event/TriggerEvaEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("TriggerEvaEvent",r=class{constructor(e){this.soundId=e,this.type=i.EventType.TriggerEva}})}}}),System.register("game/trigger/executor/PlaySpeechExecutor",["game/event/TriggerEvaEvent","game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){e.events.dispatch(new i.TriggerEvaEvent(this.action.params[1]))}},e("PlaySpeechExecutor",s)}}}),System.register("game/trigger/executor/ReshroudMapExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){for(var t of e.getCombatants())e.mapShroudTrait.resetShroud(t,e)}},e("ReshroudMapExecutor",r)}}}),System.register("game/trigger/executor/ResizePlayerViewExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var[t,i,r,s]=this.action.params.slice(2,6).map(Number);e.map.mapBounds.updateRawLocalSize({x:t,y:i,width:r,height:s})}},e("ResizePlayerViewExecutor",r)}}}),System.register("game/trigger/executor/RevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),i=e.map.getTileAtWaypoint(t);if(i)for(var r of e.getCombatants())e.mapShroudTrait.getPlayerShroud(r)?.revealAround(i,e.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${t}. `+`Skipping action ${this.getDebugName()}.`)}},e("RevealAroundWaypointExecutor",r)}}}),System.register("game/trigger/executor/RevealMapExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){for(var t of e.getCombatants())e.mapShroudTrait.revealMap(t,e)}},e("RevealMapExecutor",r)}}}),System.register("game/trigger/executor/SellBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerExecutor{execute(e,t){for(var i of t)i instanceof r.GameObject&&i.isBuilding()&&!i.isDestroyed&&e.sellTrait.sell(i)}},e("SellBuildingExecutor",s)}}}),System.register("game/trigger/executor/SetAmbientLightExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1])/100;e.mapLightingTrait.setTargetAmbientIntensity(t)}},e("SetAmbientLightExecutor",r)}}}),System.register("util/number",[],function(e,t){"use strict";t&&t.id;return e("int32ToFloat32",function(e){let t=new DataView(new ArrayBuffer(4));return t.setInt32(0,e),t.getFloat32(0)}),{setters:[],execute:function(){}}}),System.register("game/trigger/executor/SetAmbientRateExecutor",["util/number","game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t=i.int32ToFloat32(Number(this.action.params[1]));e.mapLightingTrait.setAmbientChangeRate(t)}},e("SetAmbientRateExecutor",s)}}}),System.register("game/trigger/executor/SetAmbientStepExecutor",["util/number","game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t=i.int32ToFloat32(Number(this.action.params[1]));e.mapLightingTrait.setAmbientChangeStep(t)}},e("SetAmbientStepExecutor",s)}}}),System.register("game/event/TriggerStopSoundFxEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("TriggerStopSoundFxEvent",r=class{constructor(e){this.tile=e,this.type=i.EventType.TriggerStopSoundFx}})}}}),System.register("game/trigger/executor/StopSoundFxAtExecutor",["game/event/TriggerStopSoundFxEvent","game/trigger/TriggerExecutor"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerExecutor{execute(e){var t=this.action.params[6],i=e.map.getTileAtWaypoint(t);i?e.events.dispatch(new r.TriggerStopSoundFxEvent(i)):console.warn(`No valid location found for waypoint ${t}. `+`Skipping action ${this.getDebugName()}.`)}},e("StopSoundFxAtExecutor",s)}}}),System.register("game/event/TriggerTextEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("TriggerTextEvent",r=class{constructor(e){this.label=e,this.type=i.EventType.TriggerText}})}}}),System.register("game/trigger/executor/TextTriggerExecutor",["game/event/TriggerTextEvent","game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){e.events.dispatch(new i.TriggerTextEvent(this.action.params[1]))}},e("TextTriggerExecutor",s)}}}),System.register("game/trigger/executor/TimerExtendExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.addSeconds(Number(this.action.params[1]))}},e("TimerExtendExecutor",r)}}}),System.register("game/trigger/executor/TimerSetExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.setSeconds(Number(this.action.params[1]))}},e("TimerSetExecutor",r)}}}),System.register("game/trigger/executor/TimerShortenExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.addSeconds(-Number(this.action.params[1]))}},e("TimerShortenExecutor",r)}}}),System.register("game/trigger/executor/TimerStartExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.start()}},e("TimerStartExecutor",r)}}}),System.register("game/trigger/executor/TimerStopExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.stop()}},e("TimerStopExecutor",r)}}}),System.register("game/trigger/executor/TimerTextExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.text=this.action.params[1]}},e("TimerTextExecutor",r)}}}),System.register("game/trigger/executor/ToggleTriggerExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.triggerEnable=i}execute(e){var t=this.action.params[1];e.triggers.setTriggerEnabled(t,this.triggerEnable)}},e("ToggleTriggerExecutor",r)}}}),System.register("game/trigger/executor/TurnOnOffBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.turnOn=i}execute(e,t){for(var i of t)i instanceof r.GameObject&&i.isBuilding()&&i.poweredTrait?.setTurnedOn(this.turnOn)}},e("TurnOnOffBuildingExecutor",s)}}}),System.register("game/trigger/executor/UnrevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),i=e.map.getTileAtWaypoint(t);if(i)for(var r of e.getCombatants())e.mapShroudTrait.getPlayerShroud(r)?.unrevealAround(i,e.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${t}. `+`Skipping action ${this.getDebugName()}.`)}},e("UnrevealAroundWaypointExecutor",r)}}}),System.register("game/trigger/TriggerExecutorFactory",["data/map/trigger/TriggerActionType","game/trigger/executor/AddSuperWeaponExecutor","game/trigger/executor/ApplyDamageExecutor","game/trigger/executor/ChangeHouseAllExecutor","game/trigger/executor/ChangeHouseExecutor","game/trigger/executor/CheerExecutor","game/trigger/executor/CreateCrateExecutor","game/trigger/executor/CreateRadarEventExecutor","game/trigger/executor/DestroyObjectExecutor","game/trigger/executor/DestroyTagExecutor","game/trigger/executor/DestroyTriggerExecutor","game/trigger/executor/DetonateWarheadExecutor","game/trigger/executor/EvictOccupiersExecutor","game/trigger/executor/FireSaleExecutor","game/trigger/executor/ForceEndExecutor","game/trigger/executor/ForceTriggerExecutor","game/trigger/executor/GlobalVariableExecutor","game/trigger/executor/IronCurtainExecutor","game/trigger/executor/LightningStrikeExecutor","game/trigger/executor/LocalVariableExecutor","game/trigger/executor/NoActionExecutor","game/trigger/executor/NukeStrikeExecutor","game/trigger/executor/PlayAnimAtExecutor","game/trigger/executor/PlaySoundFxAtExecutor","game/trigger/executor/PlaySoundFxExecutor","game/trigger/executor/PlaySpeechExecutor","game/trigger/executor/ReshroudMapExecutor","game/trigger/executor/ResizePlayerViewExecutor","game/trigger/executor/RevealAroundWaypointExecutor","game/trigger/executor/RevealMapExecutor","game/trigger/executor/SellBuildingExecutor","game/trigger/executor/SetAmbientLightExecutor","game/trigger/executor/SetAmbientRateExecutor","game/trigger/executor/SetAmbientStepExecutor","game/trigger/executor/StopSoundFxAtExecutor","game/trigger/executor/TextTriggerExecutor","game/trigger/executor/TimerExtendExecutor","game/trigger/executor/TimerSetExecutor","game/trigger/executor/TimerShortenExecutor","game/trigger/executor/TimerStartExecutor","game/trigger/executor/TimerStopExecutor","game/trigger/executor/TimerTextExecutor","game/trigger/executor/ToggleTriggerExecutor","game/trigger/executor/TurnOnOffBuildingExecutor","game/trigger/executor/UnrevealAroundWaypointExecutor"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e}],execute:function(){e("TriggerExecutorFactory",q=class{create(e,t){switch(e.type){case i.TriggerActionType.NoAction:return new w.NoActionExecutor(e,t);case i.TriggerActionType.FireSale:return new m.FireSaleExecutor(e,t);case i.TriggerActionType.TextTrigger:return new D.TextTriggerExecutor(e,t);case i.TriggerActionType.DestroyTrigger:return new d.DestroyTriggerExecutor(e,t);case i.TriggerActionType.ChangeHouse:return new n.ChangeHouseExecutor(e,t);case i.TriggerActionType.RevealMap:return new I.RevealMapExecutor(e,t);case i.TriggerActionType.RevealAroundWaypoint:return new P.RevealAroundWaypointExecutor(e,t);case i.TriggerActionType.PlaySoundFx:return new O.PlaySoundFxExecutor(e,t);case i.TriggerActionType.PlaySpeech:return new A.PlaySpeechExecutor(e,t);case i.TriggerActionType.ForceTrigger:return new y.ForceTriggerExecutor(e,t);case i.TriggerActionType.TimerStart:return new H.TimerStartExecutor(e,t);case i.TriggerActionType.TimerStop:return new G.TimerStopExecutor(e,t);case i.TriggerActionType.TimerExtend:return new F.TimerExtendExecutor(e,t);case i.TriggerActionType.TimerShorten:return new U.TimerShortenExecutor(e,t);case i.TriggerActionType.TimerSet:return new _.TimerSetExecutor(e,t);case i.TriggerActionType.GlobalSet:return new T.GlobalVariableExecutor(e,t,!0);case i.TriggerActionType.GlobalClear:return new T.GlobalVariableExecutor(e,t,!1);case i.TriggerActionType.DestroyObject:return new h.DestroyObjectExecutor(e,t);case i.TriggerActionType.AddOneTimeSuperWeapon:return new r.AddSuperWeaponExecutor(e,t,!0);case i.TriggerActionType.AddRepeatingSuperWeapon:return new r.AddSuperWeaponExecutor(e,t,!1);case i.TriggerActionType.AllChangeHouse:return new a.ChangeHouseAllExecutor(e,t);case i.TriggerActionType.ResizePlayerView:return new R.ResizePlayerViewExecutor(e,t);case i.TriggerActionType.PlayAnimAt:return new E.PlayAnimAtExecutor(e,t);case i.TriggerActionType.DetonateWarhead:return new g.DetonateWarheadExecutor(e,t);case i.TriggerActionType.ReshroudMap:return new M.ReshroudMapExecutor(e,t);case i.TriggerActionType.EnableTrigger:return new W.ToggleTriggerExecutor(e,t,!0);case i.TriggerActionType.DisableTrigger:return new W.ToggleTriggerExecutor(e,t,!1);case i.TriggerActionType.CreateRadarEvent:return new c.CreateRadarEventExecutor(e,t);case i.TriggerActionType.LocalSet:return new S.LocalVariableExecutor(e,t,!0);case i.TriggerActionType.LocalClear:return new S.LocalVariableExecutor(e,t,!1);case i.TriggerActionType.SellBuilding:return new k.SellBuildingExecutor(e,t);case i.TriggerActionType.TurnOffBuilding:return new z.TurnOnOffBuildingExecutor(e,t,!1);case i.TriggerActionType.TurnOnBuilding:return new z.TurnOnOffBuildingExecutor(e,t,!0);case i.TriggerActionType.ApplyOneHundredDamage:return new s.ApplyDamageExecutor(e,t,100);case i.TriggerActionType.ForceEnd:return new f.ForceEndExecutor(e,t);case i.TriggerActionType.DestroyTag:return new u.DestroyTagExecutor(e,t);case i.TriggerActionType.SetAmbientStep:return new N.SetAmbientStepExecutor(e,t);case i.TriggerActionType.SetAmbientRate:return new j.SetAmbientRateExecutor(e,t);case i.TriggerActionType.SetAmbientLight:return new B.SetAmbientLightExecutor(e,t);case i.TriggerActionType.NukeStrike:return new C.NukeStrikeExecutor(e,t);case i.TriggerActionType.PlaySoundFxAt:return new x.PlaySoundFxAtExecutor(e,t);case i.TriggerActionType.UnrevealAroundWaypoint:return new K.UnrevealAroundWaypointExecutor(e,t);case i.TriggerActionType.LightningStrike:return new b.LightningStrikeExecutor(e,t);case i.TriggerActionType.TimerText:return new V.TimerTextExecutor(e,t);case i.TriggerActionType.CreateCrate:return new l.CreateCrateExecutor(e,t);case i.TriggerActionType.IronCurtainAt:return new v.IronCurtainExecutor(e,t);case i.TriggerActionType.EvictOccupiers:return new p.EvictOccupiersExecutor(e,t);case i.TriggerActionType.Cheer:return new o.CheerExecutor(e,t);case i.TriggerActionType.StopSoundsAt:return new L.StopSoundFxAtExecutor(e,t);default:throw new Error(`Unhandled action type "${i.TriggerActionType[e.type]}"`)}}})}}}),System.register("game/trigger/condition/AmbientLightCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.type=i,this.threshold=Number(e.params[1])/100}check(e){var t=this.previousAmbient,i=e.mapLightingTrait.getAmbient().ambient;return this.previousAmbient=i,void 0!==t&&t!==i&&("above"===this.type?i>=this.threshold&&t<this.threshold:i<=this.threshold&&t>this.threshold)}},e("AmbientLightCondition",r)}}}),System.register("game/trigger/condition/AnyEventCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(e){return!0}},e("AnyEventCondition",r)}}}),System.register("game/trigger/condition/AttackedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var s,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(r,e){return e.filter(e=>{if(e.type!==s.EventType.ObjectAttacked)return!1;let t=e.target;if(!t.isTechno()||!this.targets.includes(t))return!1;var i=e.attacker?.player;return(!i||!r.alliances.areAllied(i,t.owner)&&i!==t.owner)&&!e.incidental}).map(e=>e.target)}},e("AttackedByAnyCondition",r)}}}),System.register("game/trigger/condition/AttackedByHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}check(e,t){return t.filter(e=>{if(e.type!==r.EventType.ObjectAttacked)return!1;let t=e.target;if(!t.isTechno()||!this.targets.includes(t))return!1;var i=e.attacker?.player;return i&&(-1===this.houseId||i?.country?.id===this.houseId)}).map(e=>e.target)}},e("AttackedByHouseCondition",s)}}}),System.register("game/trigger/condition/BuildingExistsCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i=!1){super(e,t),this.negate=i,this.objectIndex=Number(e.params[1])}check(){if(!this.player)return!1;for(var e of this.player.buildings)if(e.rules.index===this.objectIndex)return!this.negate;return this.negate}},e("BuildingExistsCondition",r)}}}),System.register("game/trigger/condition/BuildObjectTypeCondition",["game/trigger/TriggerCondition","game/event/EventType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.objectType=i,this.objectIndex=Number(e.params[1])}check(e,t){return t.some(e=>e.type===r.EventType.ObjectSpawn&&e.gameObject.type===this.objectType&&e.gameObject.rules.index===this.objectIndex)}},e("BuildObjectTypeCondition",s)}}}),System.register("game/trigger/condition/ComesNearWaypointCondition",["game/event/EventType","game/gameobject/unit/RangeHelper","game/trigger/TriggerCondition"],function(e,t){"use strict";var r,s,i,a;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e}],execute:function(){a=class extends i.TriggerCondition{constructor(e,t){super(e,t)}init(e){super.init(e);var t=Number(this.event.params[1]);this.waypointTile=e.map.getTileAtWaypoint(t),this.waypointTile||console.warn(`No valid location found for waypoint ${t}. `+`Skipping event ${this.getDebugName()}.`)}check(t,e){if(!this.waypointTile||!this.player)return!1;for(var i of e)if(i.type===r.EventType.EnterTile&&i.source.owner===this.player){let e=new s.RangeHelper(t.map.tileOccupation);if(e.tileDistance(i.target,this.waypointTile)<2)return!0}return!1}},e("ComesNearWaypointCondition",a)}}}),System.register("game/trigger/condition/CreditsBelowCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.threshold=Number(e.params[1])}check(e,t){return!!this.player&&this.player.credits<this.threshold}},e("CreditsBelowCondition",r)}}}),System.register("game/trigger/condition/CreditsExceedCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.threshold=Number(e.params[1])}check(e,t){return!!this.player&&this.player.credits>this.threshold}},e("CreditsExceedCondition",r)}}}),System.register("game/trigger/condition/CrossHorizLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter(t=>t.type===i.EventType.EnterTile&&t.source.zone!==r.ZoneType.Air&&this.targets.some(e=>e.ry===t.target.ry)&&(-1===this.houseId||t.source.owner.country?.id===this.houseId)).map(e=>e.target)}},e("CrossHorizLineCondition",a)}}}),System.register("game/trigger/condition/CrossVertLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter(t=>t.type===i.EventType.EnterTile&&t.source.zone!==r.ZoneType.Air&&this.targets.some(e=>e.rx===t.target.rx)&&(-1===this.houseId||t.source.owner.country?.id===this.houseId)).map(e=>e.target)}},e("CrossVertLineCondition",a)}}}),System.register("game/trigger/condition/DestroyedAllBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some(e=>{if(e.type!==i.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isBuilding()||t.owner.country?.id!==this.houseId)&&!t.owner.buildings.size})&&(this.allDestroyed=!0)}},e("DestroyedAllBuildingsCondition",s)}}}),System.register("game/trigger/condition/DestroyedAllCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some(e=>{if(e.type!==i.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isTechno()||t.owner.country?.id!==this.houseId)&&!t.owner.getOwnedObjects(!0).length})&&(this.allDestroyed=!0)}},e("DestroyedAllCondition",s)}}}),System.register("game/trigger/condition/DestroyedAllUnitsCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some(e=>{if(e.type!==r.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isUnit()||t.owner.country?.id!==this.houseId)&&!this.hasUnitsLeft(t.owner)})&&(this.allDestroyed=!0)}hasUnitsLeft(e){var t;for(t of[i.ObjectType.Aircraft,i.ObjectType.Vehicle,i.ObjectType.Infantry])if(e.getOwnedObjectsByType(t,!0).length)return!0;return!1}},e("DestroyedAllUnitsCondition",a)}}}),System.register("game/trigger/condition/DestroyedAllUnitsLandCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some(e=>{if(e.type!==r.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isUnit()||t.owner.country?.id!==this.houseId)&&!this.hasLandUnitsLeft(t.owner)})&&(this.allDestroyed=!0)}hasLandUnitsLeft(e){var t;for(t of[i.ObjectType.Vehicle,i.ObjectType.Infantry])if(e.getOwnedObjectsByType(t,!0).filter(e=>!e.rules.naval).length)return!0;return!1}},e("DestroyedAllUnitsLandCondition",a)}}}),System.register("game/trigger/condition/DestroyedAllUnitsNavalCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some(e=>{if(e.type!==r.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isVehicle()||t.owner.country?.id!==this.houseId)&&!t.owner.getOwnedObjectsByType(i.ObjectType.Vehicle,!0).filter(e=>e.rules.naval).length})&&(this.allDestroyed=!0)}},e("DestroyedAllUnitsNavalCondition",a)}}}),System.register("game/trigger/condition/DestroyedBridgeCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var a,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(s,e){return e.filter(e=>{if(e.type!==a.EventType.ObjectDestroy)return!1;let t=e.target;if(!t.isOverlay()||!t.isBridge())return!1;var i=t.bridgeTrait?.bridgeSpec;if(!i)return!1;let r=s.map.bridges.findAllBridgeTiles(i);return r.find(e=>this.targets.includes(e))}).map(e=>e.target.tile)}},e("DestroyedBridgeCondition",r)}}}),System.register("game/trigger/condition/DestroyedBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.count=0,this.threshold=Number(e.params[1])}check(e,t){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var i of t)if(i.type===r.EventType.ObjectDestroy){let e=i.target;e.isBuilding()&&e.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},e("DestroyedBuildingsCondition",s)}}}),System.register("game/trigger/condition/DestroyedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var s,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(r,e){return e.filter(e=>{if(e.type!==s.EventType.ObjectDestroy)return!1;let t=e.target;if(!t.isTechno()||!this.targets.includes(t))return!1;var i=e.attackerInfo?.player;return(!i||!r.alliances.areAllied(i,t.owner)&&i!==t.owner)&&!e.incidental}).map(e=>e.target)}},e("DestroyedByAnyCondition",r)}}}),System.register("game/trigger/condition/DestroyedOrCapturedCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter(e=>{if(e.type!==i.EventType.ObjectDestroy&&e.type!==i.EventType.ObjectOwnerChange)return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))}).map(e=>e.target)}},e("DestroyedOrCapturedCondition",s)}}}),System.register("game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(){super(...arguments),this.eventsFilter=[i.EventType.ObjectDestroy,i.EventType.ObjectOwnerChange,i.EventType.BuildingInfiltration]}check(e,t){return t.filter(e=>{if(!this.eventsFilter.includes(e.type))return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))}).map(e=>e.target)}},e("DestroyedOrCapturedOrInfiltratedCondition",s)}}}),System.register("game/trigger/condition/DestroyedUnitsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.count=0,this.threshold=Number(e.params[1])}check(e,t){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var i of t)if(i.type===r.EventType.ObjectDestroy){let e=i.target;e.isUnit()&&e.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},e("DestroyedUnitsCondition",s)}}}),System.register("game/trigger/condition/ElapsedScenarioTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.timerTicks=Number(this.event.params[1])*i.GameSpeed.BASE_TICKS_PER_SECOND}check(e){return e.currentTick>this.timerTicks}},e("ElapsedScenarioTimeCondition",s)}}}),System.register("game/trigger/condition/ElapsedTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.elapsedTicks=0,this.timerTicks=Number(this.event.params[1])*i.GameSpeed.BASE_TICKS_PER_SECOND}check(e){return this.elapsedTicks++>this.timerTicks}reset(){this.elapsedTicks=0}},e("ElapsedTimeCondition",s)}}}),System.register("game/trigger/condition/EnteredByCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter(e=>(e.type===i.EventType.EnterObject||e.type===i.EventType.EnterTile)&&this.targets.includes(e.target)&&(e.type!==i.EventType.EnterTile||e.source.zone!==r.ZoneType.Air)&&(-1===this.houseId||e.source.owner.country?.id===this.houseId)).map(e=>e.target)}},e("EnteredByCondition",a)}}}),System.register("game/trigger/condition/GlobalVariableCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.value=i,this.blocking=!0,this.variableIdx=Number(e.params[1])}check(e){return e.triggers.getGlobalVariable(this.variableIdx)===this.value}},e("GlobalVariableCondition",r)}}}),System.register("game/trigger/condition/HealthBelowAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t,i){super(e,t),this.threshold=i}check(e,t){return t.filter(e=>{if(e.type!==i.EventType.HealthChange)return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))&&(e.currentHealth<this.threshold&&e.prevHealth>this.threshold)}).map(e=>e.target)}},e("HealthBelowAnyCondition",s)}}}),System.register("game/trigger/condition/HealthBelowCombatCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t,i){super(e,t),this.threshold=i}check(e,t){return t.filter(e=>{if(e.type!==i.EventType.InflictDamage)return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))&&(e.currentHealth<this.threshold&&e.prevHealth>this.threshold)}).map(e=>e.target)}},e("HealthBelowCombatCondition",s)}}}),System.register("game/trigger/condition/LocalVariableCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.value=i,this.blocking=!0,this.variableIdx=Number(e.params[1])}check(e){return e.triggers.getLocalVariable(this.variableIdx)===this.value}},e("LocalVariableCondition",r)}}}),System.register("game/trigger/condition/LowPowerCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}init(e){super.init(e),this.targetPlayer=e.getAllPlayers().find(e=>e.country?.id===this.houseId)}check(){return!!this.targetPlayer?.powerTrait?.isLowPower()}},e("LowPowerCondition",r)}}}),System.register("game/trigger/condition/NoEventCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(e){return!1}},e("NoEventCondition",r)}}}),System.register("game/trigger/condition/NoFactoriesLeftCondition",["game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(){if(!this.player)return!1;for(var e of this.player.buildings)if(e.factoryTrait)return!1;return!0}},e("NoFactoriesLeftCondition",r)}}}),System.register("game/trigger/condition/PickupCrateAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.some(e=>e.type===i.EventType.CratePickup)}},e("PickupCrateAnyCondition",s)}}}),System.register("game/trigger/condition/PickupCrateCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter(e=>e.type===i.EventType.CratePickup&&this.targets.includes(e.source)).map(e=>e.source)}},e("PickupCrateCondition",s)}}}),System.register("game/trigger/condition/RandomDelayCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(){super(...arguments),this.elapsedTicks=0}check(e){return this.timerTicks??(this.timerTicks=Math.floor(e.generateRandomInt(50,150)/100*Number(this.event.params[1]))*i.GameSpeed.BASE_TICKS_PER_SECOND),this.elapsedTicks++>this.timerTicks}reset(){this.timerTicks=void 0,this.elapsedTicks=0}},e("RandomDelayCondition",s)}}}),System.register("game/trigger/condition/SpiedByCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter(e=>e.type===i.EventType.BuildingInfiltration&&this.targets.includes(e.target)&&(-1===this.houseId||e.source.owner.country?.id===this.houseId)).map(e=>e.target)}},e("SpiedByCondition",s)}}}),System.register("game/trigger/condition/SpyEnteringAsHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}check(e,t){return t.filter(e=>{if(e.type!==i.EventType.BuildingInfiltration)return!1;var t=e.target;return!!this.targets.includes(t)&&(-1===this.houseId||e.source.disguiseTrait?.getDisguise()?.owner?.country?.id===this.houseId)}).map(e=>e.target)}},e("SpyEnteringAsHouseCondition",s)}}}),System.register("game/trigger/condition/SpyEnteringAsInfantryCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.infantryIdx=Number(e.params[1])}check(e,t){return t.filter(e=>{if(e.type!==i.EventType.BuildingInfiltration)return!1;var t=e.target;return!!this.targets.includes(t)&&e.source.disguiseTrait?.getDisguise()?.rules.index===this.infantryIdx}).map(e=>e.target)}},e("SpyEnteringAsInfantryCondition",s)}}}),System.register("game/trigger/condition/TimerExpiredCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.some(e=>e.type===i.EventType.TimerExpire)}},e("TimerExpiredCondition",s)}}}),System.register("game/trigger/TriggerConditionFactory",["data/map/trigger/TriggerEventType","engine/type/ObjectType","game/trigger/condition/AmbientLightCondition","game/trigger/condition/AnyEventCondition","game/trigger/condition/AttackedByAnyCondition","game/trigger/condition/AttackedByHouseCondition","game/trigger/condition/BuildingExistsCondition","game/trigger/condition/BuildObjectTypeCondition","game/trigger/condition/ComesNearWaypointCondition","game/trigger/condition/CreditsBelowCondition","game/trigger/condition/CreditsExceedCondition","game/trigger/condition/CrossHorizLineCondition","game/trigger/condition/CrossVertLineCondition","game/trigger/condition/DestroyedAllBuildingsCondition","game/trigger/condition/DestroyedAllCondition","game/trigger/condition/DestroyedAllUnitsCondition","game/trigger/condition/DestroyedAllUnitsLandCondition","game/trigger/condition/DestroyedAllUnitsNavalCondition","game/trigger/condition/DestroyedBridgeCondition","game/trigger/condition/DestroyedBuildingsCondition","game/trigger/condition/DestroyedByAnyCondition","game/trigger/condition/DestroyedOrCapturedCondition","game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition","game/trigger/condition/DestroyedUnitsCondition","game/trigger/condition/ElapsedScenarioTimeCondition","game/trigger/condition/ElapsedTimeCondition","game/trigger/condition/EnteredByCondition","game/trigger/condition/GlobalVariableCondition","game/trigger/condition/HealthBelowAnyCondition","game/trigger/condition/HealthBelowCombatCondition","game/trigger/condition/LocalVariableCondition","game/trigger/condition/LowPowerCondition","game/trigger/condition/NoEventCondition","game/trigger/condition/NoFactoriesLeftCondition","game/trigger/condition/PickupCrateAnyCondition","game/trigger/condition/PickupCrateCondition","game/trigger/condition/RandomDelayCondition","game/trigger/condition/SpiedByCondition","game/trigger/condition/SpyEnteringAsHouseCondition","game/trigger/condition/SpyEnteringAsInfantryCondition","game/trigger/condition/TimerExpiredCondition"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e}],execute:function(){e("TriggerConditionFactory",V=class{create(e,t){switch(e.type){case i.TriggerEventType.NoEvent:return new j.NoEventCondition(e,t);case i.TriggerEventType.EnteredBy:return new M.EnteredByCondition(e,t);case i.TriggerEventType.SpiedBy:return new _.SpiedByCondition(e,t);case i.TriggerEventType.AttackedByAny:return new n.AttackedByAnyCondition(e,t);case i.TriggerEventType.DestroyedByAny:return new w.DestroyedByAnyCondition(e,t);case i.TriggerEventType.AnyEvent:return new a.AnyEventCondition(e,t);case i.TriggerEventType.DestroyedAllUnits:return new y.DestroyedAllUnitsCondition(e,t);case i.TriggerEventType.DestroyedAllBuildings:return new m.DestroyedAllBuildingsCondition(e,t);case i.TriggerEventType.DestroyedAll:return new f.DestroyedAllCondition(e,t);case i.TriggerEventType.CreditsExceed:return new d.CreditsExceedCondition(e,t);case i.TriggerEventType.ElapsedTime:return new A.ElapsedTimeCondition(e,t);case i.TriggerEventType.MissionTimerExpired:return new G.TimerExpiredCondition(e,t);case i.TriggerEventType.DestroyedBuildings:return new S.DestroyedBuildingsCondition(e,t);case i.TriggerEventType.DestroyedUnits:return new x.DestroyedUnitsCondition(e,t);case i.TriggerEventType.NoFactoriesLeft:return new N.NoFactoriesLeftCondition(e,t);case i.TriggerEventType.BuildBuilding:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Building);case i.TriggerEventType.BuildUnit:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Vehicle);case i.TriggerEventType.BuildInfantry:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Infantry);case i.TriggerEventType.BuildAircraft:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Aircraft);case i.TriggerEventType.CrossesHorizontalLine:return new g.CrossHorizLineCondition(e,t);case i.TriggerEventType.CrossesVerticalLine:return new p.CrossVertLineCondition(e,t);case i.TriggerEventType.GlobalIsSet:return new R.GlobalVariableCondition(e,t,!0);case i.TriggerEventType.GlobalIsCleared:return new R.GlobalVariableCondition(e,t,!1);case i.TriggerEventType.DestroyedOrCaptured:return new C.DestroyedOrCapturedCondition(e,t);case i.TriggerEventType.LowPower:return new B.LowPowerCondition(e,t);case i.TriggerEventType.DestroyedBridge:return new b.DestroyedBridgeCondition(e,t);case i.TriggerEventType.BuildingExists:return new l.BuildingExistsCondition(e,t);case i.TriggerEventType.ComesNearWaypoint:return new h.ComesNearWaypointCondition(e,t);case i.TriggerEventType.LocalIsSet:return new k.LocalVariableCondition(e,t,!0);case i.TriggerEventType.LocalIsCleared:return new k.LocalVariableCondition(e,t,!1);case i.TriggerEventType.FirstDamagedCombat:return new I.HealthBelowCombatCondition(e,t,100);case i.TriggerEventType.HalfHealthCombat:return new I.HealthBelowCombatCondition(e,t,50);case i.TriggerEventType.QuarterHealthCombat:return new I.HealthBelowCombatCondition(e,t,25);case i.TriggerEventType.FirstDamagedAny:return new P.HealthBelowAnyCondition(e,t,100);case i.TriggerEventType.HalfHealthAny:return new P.HealthBelowAnyCondition(e,t,50);case i.TriggerEventType.QuarterHealthAny:return new P.HealthBelowAnyCondition(e,t,25);case i.TriggerEventType.AttackedByHouse:return new o.AttackedByHouseCondition(e,t);case i.TriggerEventType.AmbientLightBelow:return new s.AmbientLightCondition(e,t,"below");case i.TriggerEventType.AmbientLightAbove:return new s.AmbientLightCondition(e,t,"above");case i.TriggerEventType.ElapsedScenarioTime:return new O.ElapsedScenarioTimeCondition(e,t);case i.TriggerEventType.DestroyedOrCapturedOrInfiltrated:return new E.DestroyedOrCapturedOrInfiltratedCondition(e,t);case i.TriggerEventType.PickupCrate:return new D.PickupCrateCondition(e,t);case i.TriggerEventType.PickupCrateAny:return new L.PickupCrateAnyCondition(e,t);case i.TriggerEventType.RandomDelay:return new F.RandomDelayCondition(e,t);case i.TriggerEventType.CreditsBelow:return new u.CreditsBelowCondition(e,t);case i.TriggerEventType.SpyEnteringAsHouse:return new U.SpyEnteringAsHouseCondition(e,t);case i.TriggerEventType.SpyEnteringAsInfantry:return new H.SpyEnteringAsInfantryCondition(e,t);case i.TriggerEventType.DestroyedAllUnitsNaval:return new v.DestroyedAllUnitsNavalCondition(e,t);case i.TriggerEventType.DestroyedAllUnitsLand:return new T.DestroyedAllUnitsLandCondition(e,t);case i.TriggerEventType.BuildingNotExists:return new l.BuildingExistsCondition(e,t,!0);default:throw new Error(`Unhandled trigger event type "${i.TriggerEventType[e.type]}"`)}}})}}}),System.register("game/trigger/TriggerManager",["data/map/tag/TagRepeatType","game/trigger/TriggerExecutorFactory","game/trigger/TriggerConditionFactory","util/disposable/CompositeDisposable","data/map/Variable"],function(e,t){"use strict";var c,i,r,s,a,n;t&&t.id;return{setters:[function(e){c=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("TriggerManager",n=class{constructor(){this.disposables=new s.CompositeDisposable,this.triggerInstances=new Map,this.targetsByTag=new Map,this.conditionFactory=new r.TriggerConditionFactory,this.executorFactory=new i.TriggerExecutorFactory,this.pendingGameEvents=[],this.globalVariables=new Map,this.localVariables=new Map}init(t){var i,e,r,s,a=t.map.getInitialMapObjects()["technos"];for(let l of a)if(l.tag){let e=this.targetsByTag.get(l.tag);e||(e=[],this.targetsByTag.set(l.tag,e));var n=t.map.tiles.getByMapCoords(l.rx,l.ry);!n||(n=t.map.getObjectsOnTile(n).find(e=>e.name===l.name&&e.type===l.type))&&e.push(n)}for(i of t.map.getCellTags()){var o=t.map.tiles.getByMapCoords(i.coords.x,i.coords.y);if(o){let e=this.targetsByTag.get(i.tagId);e||(e=[],this.targetsByTag.set(i.tagId,e)),e.push(o)}else console.warn(`CellTag out of bounds at (${i.coords.x}, ${i.coords.y}). Skipping.`)}for([e,r]of t.map.getVariables())this.localVariables.set(e,r.clone());for(s of t.map.getTriggers())this.triggerInstances.set(s.id,this.createTriggerInstance(s,t));this.disposables.add(t.events.subscribe(e=>this.pendingGameEvents.push(e)))}createTriggerInstance(i,r){let s=this.targetsByTag.get(i.tag.id)??[];return{trigger:i,conditions:i.events.map(e=>{let t=this.conditionFactory.create(e,i);return t.setTargets(s),t.init(r),t}).sort((e,t)=>Number(t.blocking)-Number(e.blocking)),targets:s,remainingTargets:new Set(i.tag.repeatType===c.TagRepeatType.OnceAll?s:[]),disabled:i.disabled,finished:!1}}update(i){var r,s=this.pendingGameEvents.splice(0,this.pendingGameEvents.length);for(r of this.triggerInstances.values())if(!r.finished&&!r.disabled){let e=!0,t=[];for(var a of r.conditions){var n=a.check(i,s);if("boolean"==typeof n?n||(e=!1):n.length?t.push(...n):e=!1,a.blocking&&!e)break}if(e){var o=r.trigger;r.conditions.forEach(e=>e.reset?.());let e=[];if(o.tag.repeatType===c.TagRepeatType.OnceAll){for(var l of t)r.remainingTargets.delete(l);if(r.remainingTargets.size)continue;e=t.length?[t[t.length-1]]:[]}else e=r.targets;this.executeActions(o,e,i),o.tag.repeatType!==c.TagRepeatType.Repeat&&(r.finished=!0)}}}executeActions(t,i,r){for(var s of t.actions){let e=this.executorFactory.create(s,t);e.execute(r,i)}}setTriggerEnabled(e,t){let i=this.triggerInstances.get(e);i&&(i.disabled=!t)}forceTrigger(e,t){var i=this.triggerInstances.get(e);i&&this.executeActions(i.trigger,i.targets,t)}destroyTrigger(e){this.triggerInstances.delete(e)}destroyTag(e){let t=[];for(var[i,r]of this.triggerInstances)r.trigger.tag.id===e&&t.push(i);for(var s of t)this.destroyTrigger(s)}getGlobalVariable(e){return!!this.globalVariables.get(e)?.value}toggleGlobalVariable(e,t){let i=this.globalVariables.get(e);void 0===i?this.globalVariables.set(e,new a.Variable("No name",t)):i.value=t}getLocalVariable(e){return!!this.localVariables.get(e)?.value}toggleLocalVariable(e,t){let i=this.localVariables.get(e);void 0===i?this.localVariables.set(e,new a.Variable("No name",t)):i.value=t}dispose(){this.disposables.dispose()}})}}}),System.register("game/trait/MapLightingTrait",["data/map/MapLighting","game/GameSpeed","util/event","game/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class{constructor(e,t){this.mapLighting=new i.MapLighting,this._onChange=new s.EventDispatcher,this.ambientChangeRate=e.ambientChangeRate,this.ambientChangeStep=e.ambientChangeStep,t&&this.mapLighting.copy(t)}get onChange(){return this._onChange.asEvent()}setAmbientChangeRate(e){this.ambientChangeRate=e}setAmbientChangeStep(e){this.ambientChangeStep=e}setTargetAmbientIntensity(e){this.targetAmbient=e}getAmbient(){return this.mapLighting}[a.NotifyTick.onTick](){var e;void 0!==this.targetAmbient&&(this.ambientUpdateTicks??(this.ambientUpdateTicks=Math.floor(60*r.GameSpeed.BASE_TICKS_PER_SECOND*this.ambientChangeRate)),this.ambientUpdateTicks<=0?(this.ambientUpdateTicks=void 0,e=this.mapLighting.ambient,(e=this.targetAmbient-e)?(e=Math.sign(e)*Math.min(this.ambientChangeStep,Math.abs(e)),this.mapLighting.ambient+=e,this._onChange.dispatch(this,this.mapLighting)):this.targetAmbient=void 0):this.ambientUpdateTicks--)}},e("MapLightingTrait",n)}}}),System.register("game/event/TimerExpireEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("TimerExpireEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.TimerExpire}})}}}),System.register("game/CountdownTimer",["game/event/TimerExpireEvent","game/GameSpeed"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("CountdownTimer",s=class{constructor(){this.ticks=0,this.running=!1}getSeconds(){return Math.floor(this.ticks/r.GameSpeed.BASE_TICKS_PER_SECOND)}setSeconds(e){this.ticks=Math.max(0,Math.floor(r.GameSpeed.BASE_TICKS_PER_SECOND*e))}addSeconds(e){this.ticks=Math.max(0,this.ticks+Math.floor(r.GameSpeed.BASE_TICKS_PER_SECOND*e))}start(){this.running=!0}stop(){this.running=!1}isRunning(){return this.running}update(e){this.running&&(0<this.ticks?this.ticks--:(this.running=!1,e.events.dispatch(new i.TimerExpireEvent(this))))}})}}}),System.register("game/trait/interface/NotifyObjectTraitAdd",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onAdd=Symbol(),e("NotifyObjectTraitAdd",i)}}}),System.register("game/ai/Ai",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("Ai",i=class{constructor(e){this.ini=e}getIni(){return this.ini}})}}}),System.register("game/Game",["game/ConstructionWorker","game/gameopts/GameOpts","engine/type/ObjectType","util/event","game/map/OreSpread","game/gameobject/Infantry","game/Alliances","util/BoxedVar","game/StartingUnitsGenerator","game/map/tileFinder/CardinalTileFinder","game/type/SpeedType","game/Target","game/map/BridgeOverlayTypes","util/math","game/GameEventBus","game/event/ObjectDestroyEvent","game/event/PlayerDefeatedEvent","game/ini/GameModeType","game/Traits","game/trait/interface/NotifyTick","game/trait/interface/NotifyDestroy","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/event/ObjectOwnerChangeEvent","game/event/ObjectUnspawnEvent","game/trait/interface/NotifyTargetDestroy","game/gameobject/unit/VeteranLevel","game/event/ObjectSpawnEvent","engine/type/OverlayTibType","game/map/OreOverlayTypes","game/Weapon","game/GameSpeed","game/gameobject/common/DeathType","game/map/Bridges","game/SuperWeapon","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/gameopts/constants","game/gameobject/unit/ZoneType","game/Prng","game/trigger/TriggerManager","game/CountdownTimer","game/WeaponType","game/Warhead","game/trait/interface/NotifyObjectTraitAdd"],function(t,e){"use strict";var i,a,v,m,b,y,n,f,T,S,w,r,C,s,E,o,l,x,O,c,h,u,d,g,p,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$,Q;e&&e.id;return{setters:[function(e){i=e},function(e){a=e},function(e){v=e},function(e){m=e},function(e){b=e},function(e){y=e},function(e){n=e},function(e){f=e},function(e){T=e},function(e){S=e},function(e){w=e},function(e){r=e},function(e){C=e},function(e){s=e},function(e){E=e},function(e){o=e},function(e){l=e},function(e){x=e},function(e){O=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e}],execute:function(){var e;(e=$=$||{})[e.NotStarted=0]="NotStarted",e[e.Started=1]="Started",e[e.Ended=2]="Ended",t("GameStatus",$),t("Game",Q=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p){this.updatableObjects=new Set,this.constructionWorkers=new Map,this.currentTick=0,this.currentTime=0,this.countdownTimer=new W.CountdownTimer,this._onEnd=new m.EventDispatcher,this.afterTickCallbacks=[],this.events=new E.GameEventBus,this.traits=new O.Traits,this.debugText=new f.BoxedVar(""),this.world=e,this.map=t,this.rules=i,this.art=r,this.ai=s,this.id=a,this.startTimestamp=n,this.prng=new G.Prng(Number(a+""+n)),this.gameOpts=o,this.gameModeType=l,this.playerList=c,this.unitSelection=h,this.alliances=u,this.desiredSpeed=new f.BoxedVar(j.GameSpeed.computeGameSpeed(o.gameSpeed)),this.speed=new f.BoxedVar(this.desiredSpeed.value),this.nextObjectId=d,this.objectFactory=g,this.botManager=p,this.triggers=new V.TriggerManager}get onEnd(){return this._onEnd.asEvent()}addPlayer(e){this.playerList.addPlayer(e),this.constructionWorkers.set(e,this.createConstructionWorker(e))}getPlayer(e){return this.playerList.getPlayerAt(e)}getPlayerByName(e){return this.playerList.getPlayerByName(e)}getAiPlayerName(e){let t;return t="number"==typeof e?e:this.gameOpts.aiPlayers.indexOf(e),`@@AI${t+1}@@`}getPlayerNumber(e){return this.playerList.getPlayerNumber(e)}getCombatants(){return this.playerList.getCombatants()}getCivilianPlayer(){return this.playerList.getCivilian()}getAllPlayers(){return this.playerList.getAll()}getNonNeutralPlayers(){return this.playerList.getNonNeutral()}areFriendly(e,t){return e.owner===t.owner||this.alliances.areAllied(e.owner,t.owner)}getWorld(){return this.world}createConstructionWorker(e){return new i.ConstructionWorker(e,this.rules,this.art,this.map,this)}getConstructionWorker(e){var t=this.constructionWorkers.get(e);if(!t)throw new Error(`No construction worker found for player "${e.name}"`);return t}getUnitSelection(){return this.unitSelection}init(e){this.localPlayer=e,this.createMapObjects(),this.createPlayerInitialUnits(),this.map.terrain.computeAllPassabilityGraphs(),this.mapShroudTrait.init(this),this.crateGeneratorTrait.init(this),this.playerList.getAll().forEach(e=>e.credits=this.gameOpts.credits),this.rules.mpDialogSettings.alliesAllowed&&this.createInitialTeams()}start(){this.status=$.Started,this.currentTick=0,this.currentTime=0,this.botManager.init(this),this.triggers.init(this)}createInitialTeams(){for(let t=0;t<this.gameOpts.maxSlots;t++){var i=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(e=>e?.teamId===t&&e.countryId!==U.OBS_COUNTRY_ID).map(e=>a.isHumanPlayerInfo(e)?e.name:this.getAiPlayerName(e));if(1<i.length)for(let t=0;t<i.length-1;t++)for(let e=t+1;e<i.length;e++){var r=this.getPlayerByName(i[t]),s=this.getPlayerByName(i[e]),s=this.alliances.setAlliance(r,s,n.AllianceStatus.Formed);this.onAllianceChange(s,r,!0)}}}createMapObjects(){var e=this.rules.general.harvesterUnit.every(e=>!s.isBetween(this.rules.getObject(e,v.ObjectType.Vehicle).techLevel,0,this.rules.mpDialogSettings.techLevel)),t=this.map.getInitialMapObjects();this.createInitialMapTerrains(t.terrains,e),this.createInitialMapOverlays(t.overlays,e),this.createInitialMapSmudges(t.smudges),this.createInitialMapTechnos(t.technos)}createInitialMapTerrains(e,t){for(var i of e){var r,s,a=i.name;this.validateMapObjectRulesAndArt(a,v.ObjectType.Terrain)&&((r=this.map.tiles.getByMapCoords(i.rx,i.ry))?(s=this.rules.getObject(a,v.ObjectType.Terrain),t&&s.spawnsTiberium||(a=this.createObject(v.ObjectType.Terrain,a),this.spawnObject(a,r))):console.warn(`Invalid map object location (${i.rx},${i.ry})`,i))}}createInitialMapOverlays(e,r){let s=new Map,a=new Map;for(var n of e){var o=this.rules.getOverlayName(n.id);if(this.validateMapObjectRulesAndArt(o,v.ObjectType.Overlay)){let e=this.createObject(v.ObjectType.Overlay,o);e.overlayId=n.id,e.value=n.value;let t=n.rx,i=n.ry;e.isBridge()&&e.isHighBridge()&&(e.position.tileElevation=4,t+=e.isXBridge()?0:-1,i+=e.isXBridge()?-1:0);var l=this.map.tiles.getByMapCoords(t,i);if(l)if(e.rules.tiberium&&(o=k.OreOverlayTypes.getOverlayTibType(n.id),void 0!==(o=b.OreSpread.calculateOverlayId(o,l))&&o!==n.id&&(e.dispose(),e=this.createObject(v.ObjectType.Overlay,this.rules.getOverlayName(o)),e.overlayId=o,e.value=n.value)),C.BridgeOverlayTypes.isLowBridge(n.id))C.BridgeOverlayTypes.isBridgePlaceholder(n.id)||(s.set(l,n.value),1===n.value?a.set(l,e):e.dispose());else{if(e.isTiberium()){if(![I.OverlayTibType.Ore,I.OverlayTibType.Gems,I.OverlayTibType.Vinifera].includes(k.OreOverlayTypes.getOverlayTibType(e.overlayId))){console.warn(`Found unsupported TS tiberium overlay ${e.overlayId} @${l.rx},${l.ry}. Skipping.`);continue}if(this.map.getObjectsOnTile(l).find(e=>e.isTerrain())){e.dispose();continue}}r&&e.isTiberium()?e.dispose():this.spawnObject(e,l)}else console.warn(`Invalid map object location (${t},${i})`,n),e.dispose()}}for(var[t,i]of a){var c=i.isXBridge(),h=this.map.tiles.getByMapCoords(t.rx+(c?0:-1),t.ry+(c?-1:0)),c=this.map.tiles.getByMapCoords(t.rx+(c?0:1),t.ry+(c?1:0));h&&c&&(0===s.get(h)||2===s.get(c))?(i.value=0,this.spawnObject(i,h)):(i.dispose(),console.warn(`Invalid bridge segment @${t.rx},${t.ry}. Skipping.`))}var u,d=[...a.keys()].filter(e=>this.map.bridges.getPieceAtTile(e)?.headType!==L.BridgeHeadType.None),g=this.map.bridges.findMapHighBridgeHeadTiles();let p=this.map.bridges.findBridgeSpecsForHeadTiles([...d,...g]);for(u of p)for(var m of this.map.bridges.findBridgePieces(u))m.obj.bridgeTrait.bridgeSpec=u;var f,g=p.map(e=>this.map.bridges.findAllBridgeTiles(e)).flat(),y=C.BridgeOverlayTypes.bridgePlaceholderIds[0],T=this.rules.getOverlayName(y);for(f of g){let e=this.createObject(v.ObjectType.Overlay,T);e.overlayId=y,this.spawnObject(e,f)}}createInitialMapSmudges(e){for(var t of e){var i=t.name,r=this.map.tiles.getByMapCoords(t.rx,t.ry);r?(i=this.createObject(v.ObjectType.Smudge,i),this.spawnObject(i,r)):console.warn(`Invalid map object location (${t.rx},${t.ry})`,t)}}createInitialMapTechnos(e){let t=new Map(this.playerList.getAll().filter(e=>!!e.country).map(e=>[e.country.name,e])),i=this.map.getTags();for(let n of e){var r=n.name;if(this.validateMapObjectRulesAndArt(r,n.type)){var s=this.map.tiles.getByMapCoords(n.rx,n.ry);if(s){var a=t.get(n.owner);if(a){if(a.isNeutral){let t=this.createObject(n.type,r);n.tag&&(t.tag=i.find(e=>e.id===n.tag)),t.healthTrait.health=n.health/256*100;let e=!1;if(!t.healthTrait.health){if(!t.isBuilding()||!t.rules.leaveRubble){t.dispose();continue}e=!0}if(n.isInfantry()||n.isVehicle()||n.isAircraft()){t.direction=(-n.direction/256*360+360)%360,n.isInfantry()&&(t.position.subCell=n.subCell);let e=!1;n.onBridge&&(void 0===s.onBridgeLandType?console.warn(`Cannot place unit "${n.name}" on a bridge because `+`no bridge was found at ${s.rx}, `+s.ry):e=!0),t.onBridge=e,t.zone=H.getZoneType(e?s.onBridgeLandType:s.landType),e&&(t.position.tileElevation+=this.map.tileOccupation.getBridgeOnTile(s)?.tileElevation??0),n.veterancy&&t.veteranTrait?.setRelativeXP(n.veterancy)}else t.poweredTrait?.setTurnedOn(n.poweredOn);this.changeObjectOwner(t,a),this.spawnObject(t,s),e&&this.destroyObject(t,void 0,!0)}}else console.warn(`Invalid owner "${n.owner}" for map object`,n)}else console.warn(`Invalid map object location (${n.rx},${n.ry})`,n)}}}validateMapObjectRulesAndArt(e,t){return this.rules.hasObject(e,t)?!!this.art.hasObject(e,t)||(console.warn(`Map object '${e}' has no art section. Skipping.`),!1):(console.warn(`Map object '${e}' has no rules section. Skipping.`),!1)}createPlayerInitialUnits(){let e=this.playerList.getCombatants().map(e=>e.country);var i=[...this.rules.infantryRules.values(),...this.rules.vehicleRules.values()].filter(t=>t.allowedToStartInMultiplayer&&!t.naval&&-1!==t.techLevel&&t.techLevel<=this.rules.mpDialogSettings.techLevel&&!this.rules.general.baseUnit.includes(t.name)&&e.some(e=>t.isAvailableTo(e)&&t.hasOwner(e)));for(let f of this.playerList.getCombatants()){var l=this.map.startingLocations[f.startLocation],c=this.map.tiles.getByMapCoords(l.x,l.y);let t=this.rules.general.baseUnit.find(e=>{let t=this.rules.getObject(e,v.ObjectType.Vehicle);return t.isAvailableTo(f.country)&&t.hasOwner(f.country)});if(!t)throw new Error("No suitable MCV found for player country "+f.country);l=this.rules.getObject(t,v.ObjectType.Vehicle),l=this.createUnitForPlayer(l,f);this.spawnObject(l,c);let e=T.StartingUnitsGenerator.generate(this.gameOpts.unitCount,[...this.rules.vehicleRules.keys()],i,f.country);this.gameModeType===x.GameModeType.Unholy&&e.push(...this.rules.general.baseUnit.filter(e=>e!==t).map(e=>({name:e,type:v.ObjectType.Vehicle,count:1})));var h,u,d;let r=[],s=!1,a=new S.CardinalTileFinder(this.map.tiles,this.map.mapBounds,c,4,4,e=>!this.map.getGroundObjectsOnTile(e).find(e=>!(e.isSmudge()||e.isOverlay()&&e.isTiberium()))&&0<this.map.terrain.getPassableSpeed(e,w.SpeedType.Foot,!1)),n=new Map,o=0;for({name:h,type:u,count:d}of e){let i=d;for(;0<i;){let t;if(s||(t=a.getNextTile(),t?r.push(t):s=!0),s&&r.length){var g=r[o];let e=n.get(g);e||(e=new S.CardinalTileFinder(this.map.tiles,this.map.mapBounds,g,1,0,e=>!this.map.getGroundObjectsOnTile(e).find(e=>!(e.isSmudge()||e.isOverlay()&&e.isTiberium()))&&0<this.map.terrain.getPassableSpeed(e,w.SpeedType.Foot,!1)),n.set(g,e)),o=(o+1)%r.length,t=e.getNextTile()}if(t){var p,m=this.rules.getObject(h,u);if(u===v.ObjectType.Vehicle){g=this.createUnitForPlayer(m,f);this.applyInitialVeteran(g,f),this.spawnObject(g,t),i--}else{if(u!==v.ObjectType.Infantry)throw new Error("Should not reach this line");for(p of y.Infantry.SUB_CELLS.slice(0,i)){let e=this.createUnitForPlayer(m,f);e.position.subCell=p,this.applyInitialVeteran(e,f),this.spawnObject(e,t),i--}}}else i--}}}}applyInitialVeteran(e,t){e.veteranTrait&&(this.rules.general.veteran.initialVeteran?e.veteranTrait.setVeteranLevel(R.VeteranLevel.Elite):t.country.hasVeteranUnit(e.type,e.name)&&e.veteranTrait.setVeteranLevel(R.VeteranLevel.Veteran))}createObject(e,t){return this.objectFactory.create(e,t,this.rules,this.art)}createUnitForPlayer(e,t){if(![v.ObjectType.Aircraft,v.ObjectType.Vehicle,v.ObjectType.Infantry].includes(e.type))throw new Error(`Attempted to create an invalid unit type "${e.type}"`);let i=this.createObject(e.type,e.name);return this.changeObjectOwner(i,t),i.purchaseValue=this.sellTrait.computePurchaseValue(i.rules,t),i}createProjectile(e,t,i,r,s){let a=this.createObject(v.ObjectType.Projectile,e);return a.fromWeapon=i,a.fromObject=t,a.fromPlayer=t.owner,a.target=r,a.isShrapnel=s,a}createLooseProjectile(e,t,i){var r=this.rules.getWeapon(e),s=r.projectile,a=this.rules.getProjectile(s),n=this.rules.getWarhead(r.warhead),n={minRange:0,projectileRules:a,range:Number.POSITIVE_INFINITY,rules:r,speed:B.Weapon.computeSpeed(r,a),type:z.WeaponType.Primary,warhead:new K.Warhead(n)};let o=this.createObject(v.ObjectType.Projectile,s);return o.fromWeapon=n,o.fromObject=void 0,o.fromPlayer=t,o.target=i,o}createSuperWeapon(e,t,i=!1){var r=this.rules.getSuperWeapon(e);return new D.SuperWeapon(e,r,t,i)}createTarget(e,t){return new r.Target(e,t,this.map.tileOccupation)}isValidTarget(e){if(e){if(!e.isSpawned||e.isCrashing)return!1;if(!(e.rules.legalTarget||e.isBuilding()&&e.rules.hospital))return!1;if(e.isBuilding()&&e.rules.invisibleInGame)return!1}return!0}spawnObject(e,t){if(e.isTechno()&&e.limboData)throw new Error(`Object ${e.name}#${e.id} is in limbo. Use unlimboObject instead or clear limboData first`);this.doSpawnObject(e,t)}unspawnObject(e){e.isTechno()&&e.owner&&e.owner.removeOwnedObject(e),this.doUnspawnObject(e)}limboObject(e,t){e.limboData=t,this.doUnspawnObject(e)}unlimboObject(e,t,i=!1){var r=e.limboData;if(!r)throw new Error(`Object ${e.name}#${e.id} has no limboData attached`);e.limboData=void 0,this.doSpawnObject(e,t);let s=this.getUnitSelection();r.selected&&!i&&s.addToSelection(e),void 0!==r.controlGroup&&s.addUnitsToGroup(r.controlGroup,[e],!1)}doSpawnObject(t,e){var i,r;t.position.tile=e,t.isBuilding()&&(r=t.art.foundationCenter,i=e.rx+r.x,r=e.ry+r.y,t.centerTile=this.map.tiles.getByMapCoords(i,r)??this.map.tiles.getPlaceholderTile(i,r)),this.world.spawnObject(t),(t.cachedTraits.tick.length||t.isProjectile()||t.isDebris()||t.isTechno())&&this.updatableObjects.add(t),t.isTechno()&&this.map.technosByTile.add(t),t.isProjectile()||t.isDebris()||this.map.tileOccupation.occupyTileRange(e,t),t.art.canHideThings&&this.map.tileOcclusion.addOccluder(t),t.onSpawn(this),this.traits.filter(u.NotifySpawn).forEach(e=>{e[u.NotifySpawn.onSpawn](t,this)}),this.events.dispatch(new P.ObjectSpawnEvent(t))}doUnspawnObject(t){var e=t.tile;t.isProjectile()||t.isDebris()||this.map.tileOccupation.unoccupyTileRange(e,t),t.art.canHideThings&&this.map.tileOcclusion.removeOccluder(t),t.isTechno()&&(this.unitSelection.cleanupUnit(t),this.map.technosByTile.remove(t)),this.world.removeObject(t),this.updatableObjects.delete(t),t.onUnspawn(this),this.traits.filter(d.NotifyUnspawn).forEach(e=>{e[d.NotifyUnspawn.onUnspawn](t,this)}),this.events.dispatch(new A.ObjectUnspawnEvent(t))}destroyObject(t,i,e=!1,r=!1){if(t.isDestroyed)throw new Error(`Object with ID "${t.id}" is already destroyed`);if(t.isTechno()){let e=t.mindControllableTrait?.getOriginalOwner()??t.owner;!i||t.isBuilding()&&!e.isCombatant()||(i.player.addUnitsKilled(t.type,1),i.player===e||this.alliances.areAllied(i.player,e)||(i.player.score+=t.rules.points)),e.isNeutral||e.addUnitsLost(t.type,1)}if(t.isDestroyed=!0,t.healthTrait&&(t.healthTrait.health=0),t.onDestroy(this,i,e),this.traits.filter(h.NotifyDestroy).forEach(e=>{e[h.NotifyDestroy.onDestroy](t,this,i)}),i?.obj?.traits.filter(M.NotifyTargetDestroy).forEach(e=>{e[M.NotifyTargetDestroy.onDestroy](i.obj,t,i.weapon,this)}),this.events.dispatch(new o.ObjectDestroyEvent(t,i,r)),t.isBuilding()&&t.rules.leaveRubble&&t.deathType!==N.DeathType.Temporal){t.owner.removeOwnedObject(t),this.unitSelection.cleanupUnit(t);var s=this.map.tileOccupation.calculateTilesForGameObject(t.tile,t);this.map.terrain.invalidateTiles(s),t.art.canHideThings&&this.map.tileOcclusion.removeOccluder(t),this.updatableObjects.delete(t),t.onUnspawn(this),this.traits.filter(d.NotifyUnspawn).forEach(e=>{e[d.NotifyUnspawn.onUnspawn](t,this)}),this.events.dispatch(new A.ObjectUnspawnEvent(t))}else if(t.isSpawned)this.unspawnObject(t);else if(t.isTechno()&&t.owner){if(!t.limboData)throw new Error(`Object with ID "${t.id}" should be in limbo but has no limboData`);t.owner.removeOwnedObject(t)}t.dispose()}getObjectById(e){return this.world.getObjectById(e)}changeObjectOwner(t,e){const i=t.owner;i&&i.removeOwnedObject(t),e.addOwnedObject(t),i&&i!==e&&(this.traits.filter(g.NotifyOwnerChange).forEach(e=>{e[g.NotifyOwnerChange.onChange](t,i,this)}),t.onOwnerChange(i,this),this.events.dispatch(new p.ObjectOwnerChangeEvent(t,i)))}addObjectTrait(t,i){t.addTrait(i),this.traits.filter(q.NotifyObjectTraitAdd).forEach(e=>{e[q.NotifyObjectTraitAdd.onAdd](t,i,this)})}onAllianceChange(t,e,i){this.events.dispatch(new F.AllianceChangeEvent(t,i?F.AllianceEventType.Formed:F.AllianceEventType.Broken,e)),this.traits.filter(_.NotifyAllianceChange).forEach(e=>{e[_.NotifyAllianceChange.onChange](t,i,this)})}update(){if(this.status!==$.NotStarted){this.botManager.update(this),this.status!==$.Ended&&(void 0===this.lastGameEndCheck||1e3<=this.currentTime-this.lastGameEndCheck)&&(this.checkGameEndConditions(),this.lastGameEndCheck=this.currentTime);for(var e of[...this.updatableObjects])e.isSpawned&&e.update(this);if(this.playerList.getCombatants().forEach(e=>e.cheerCooldownTicks=Math.max(0,e.cheerCooldownTicks-1)),this.traits.filter(c.NotifyTick).forEach(e=>{e[c.NotifyTick.onTick](this)}),this.localPlayer&&!this.localPlayer.isObserver&&!this.localPlayer.defeated){var t=this.unitSelection.getSelectedUnits();if(1===t.length){let i=t[0];if(i.isTechno()&&i.owner!==this.localPlayer){let t=this.mapShroudTrait.getPlayerShroud(this.localPlayer);this.map.tileOccupation.calculateTilesForGameObject(i.tile,i).find(e=>!t.isShrouded(e,i.tileElevation))||(this.unitSelection.deselectAll(),this.unitSelection.cleanupUnit(i))}}}for(var i of this.afterTickCallbacks)i();this.afterTickCallbacks.length=0,this.triggers.update(this),this.countdownTimer.update(this),this.currentTick++,this.currentTime+=1e3/j.GameSpeed.BASE_TICKS_PER_SECOND}}afterTick(e){this.afterTickCallbacks.push(e)}checkGameEndConditions(){this.updateDefeatedPlayers(this.playerList.getCombatants()),(this.localPlayer?.defeated&&!this.localPlayer.isObserver||!this.alliances.getHostilePlayers().length&&1<this.gameOpts.humanPlayers.length+this.gameOpts.aiPlayers.length)&&this.end()}end(){this.status!==$.Ended&&(this.status=$.Ended,this._onEnd.dispatch(this,void 0))}updateDefeatedPlayers(e){let r=this.stalemateDetectTrait?.isStale()&&0===this.stalemateDetectTrait.getCountdownTicks(),s=this.gameOpts.shortGame;e.forEach(t=>{let i;if(r)i=!0;else{let e;e=s?(e=[...t.getOwnedObjectsByType(v.ObjectType.Building,!0)].some(e=>!e.rules.insignificant),e||t.getOwnedObjects(!0).some(e=>this.rules.general.baseUnit.includes(e.name))):t.getOwnedObjects(!0).some(e=>!e.rules.insignificant&&!e.limboData?.inTransport),i=!e}i&&(t.defeated=!0,this.removeAllPlayerAssets(t),this.events.dispatch(new l.PlayerDefeatedEvent(t)))})}removeAllPlayerAssets(e){e.getOwnedObjects().forEach(e=>{e.isDestroyed||this.destroyObject(e,void 0,!0)}),e.getOwnedObjects(!0).forEach(e=>{e.isDestroyed||(e.limboData?.inTransport?this.changeObjectOwner(e,this.getCivilianPlayer()):this.destroyObject(e,void 0,!0))})}generateRandomInt(e,t){return this.prng.generateRandomInt(e,t)}generateRandom(){return this.prng.generateRandom()}getHash(){return s.fnv32a([...new Uint8Array(new Float64Array([this.prng.getLastRandom()]).buffer),this.nextObjectId.value,...this.world.getAllObjects().map(e=>e.getHash()),...this.playerList.getAll().map(e=>e.getHash()),this.alliances.getHash(),...this.traits.getAll().map(e=>e.getHash?.()??0)])}debugGetState(){return{currentTick:this.currentTick,lastRandom:this.prng.getLastRandom(),nextObjectId:this.nextObjectId.value,objects:this.world.getAllObjects().map(e=>e.debugGetState()),players:this.playerList.getAll().map(e=>e.debugGetState()),alliances:this.alliances.debugGetState(),traits:this.traits.getAll().reduce((e,t)=>{var i=t.debugGetState?.();return void 0!==i&&(e[t.constructor.name]=i),e},{})}}dispose(){this.world.getAllObjects().forEach(e=>e.dispose()),this.playerList.getAll().forEach(e=>e.dispose()),this.constructionWorkers.forEach(e=>e.dispose()),this.botManager.dispose(),this.triggers.dispose(),this.map.dispose(),this.traits.dispose()}})}}}),System.register("game/gameobject/trait/interface/NotifyDamage",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){(i=i||{}).onDamage=Symbol(),e("NotifyDamage",i)}}}),System.register("game/gameobject/trait/WallTrait",["game/gameobject/trait/interface/NotifyDamage","game/type/LandType"],function(e,t){"use strict";var i,n,r;t&&t.id;return{setters:[function(e){i=e},function(e){n=e}],execute:function(){r=class{constructor(){this.linkedDamageHandled=!1}[i.NotifyDamage.onDamage](e,t,i,r){if(!this.linkedDamageHandled){var s=Math.floor(i/2);if(s)for(var a of t.map.tiles.getAllNeighbourTiles(e.tile))if(a.landType===n.LandType.Wall){let e=t.map.getObjectsOnTile(a).find(e=>(e.isBuilding()||e.isOverlay())&&e.wallTrait);e.wallTrait.linkedDamageHandled=!0,e.healthTrait.inflictDamage(s,r,t),e.wallTrait.linkedDamageHandled=!1,e.healthTrait.health||t.destroyObject(e,r)}}}},e("WallTrait",r)}}}),System.register("game/gameobject/Overlay",["engine/type/ObjectType","game/gameobject/GameObject","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","engine/type/OverlayTibType","game/gameobject/trait/WallTrait"],function(e,t){"use strict";var r,i,s,a,n,o,l;t&&t.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.GameObject{constructor(e,t,i){super(r.ObjectType.Overlay,e,t,i),this.radarInvisible=this.rules.radarInvisible}static factory(e,t,i){let r=new this(e,t,i);return t.wall&&(r.wallTrait=new o.WallTrait,r.traits.add(r.wallTrait)),r}isTiberium(){return a.OreOverlayTypes.getOverlayTibType(this.overlayId)!==n.OverlayTibType.NotSpecial}isBridge(){return s.BridgeOverlayTypes.isBridge(this.overlayId)}isXBridge(){return s.BridgeOverlayTypes.isXBridge(this.overlayId)}isHighBridge(){return s.BridgeOverlayTypes.isHighBridge(this.overlayId)}isLowBridge(){return s.BridgeOverlayTypes.isLowBridge(this.overlayId)}isBridgePlaceholder(){return s.BridgeOverlayTypes.isBridgePlaceholder(this.overlayId)}getFoundation(){let e={width:1,height:1};return this.isBridge()&&(this.isXBridge()?e.height+=2:e.width+=2),e}},e("Overlay",l)}}}),System.register("game/map/Terrain",["game/map/TileCollection","game/type/SpeedType","ngraph.graph","ngraph.path","util/typeGuard","game/map/tileFinder/RadialTileFinder","util/geometry","game/type/LandType","game/rules/TerrainRules"],function(e,t){"use strict";var h,c,r,f,a,y,n,u,o,i;t&&t.id;return{setters:[function(e){h=e},function(e){c=e},function(e){r=e},function(e){f=e},function(e){a=e},function(e){y=e},function(e){n=e},function(e){u=e},function(e){o=e}],execute:function(){e("Terrain",i=class{constructor(e,t,i,r,s){this.tiles=e,this.theaterType=t,this.mapBounds=i,this.tileOccupation=r,this.rules=s,this.passabilityGraphs=new Map,this.invalidatedTiles=new Map,this.handleTileOccupationUpdate=({tiles:e,object:i})=>{var t=e.filter(e=>{let t=c.SpeedType.Foot;return i.isTerrain()&&i.rules.getOccupationBits(this.theaterType)!==o.OccupationBits.All&&(t=c.SpeedType.Wheel),i.isOverlay()&&(i.isBridge()||i.isTiberium())||this.isBlockerObject(i,e,!1,t)||this.isBlockerObject(i,e,!0,t)||i.isBuilding()&&i.rules.leaveRubble});t.length&&this.invalidateTiles(t)},this.handleMapBoundsResize=()=>{this.passabilityGraphs.clear()},r.onChange.subscribe(this.handleTileOccupationUpdate),i.onLocalResize.subscribe(this.handleMapBoundsResize)}invalidateTiles(i){i.length&&[...this.passabilityGraphs.keys()].forEach(e=>{let t=this.invalidatedTiles.get(e);t?i.forEach(e=>t.add(e)):this.invalidatedTiles.set(e,new Set(i))})}computePath(t,e,i,r,s,{maxExpandedNodes:a=Number.POSITIVE_INFINITY,bestEffort:n=!0,excludeTiles:o,ignoredBlockers:l=[]}={}){let c=this.computePassabilityGraph(t);var h=l.map(e=>this.tileOccupation.calculateTilesForGameObject(e.tile,e)).reduce((e,t)=>e.concat(t),[]);if(h.length&&this.updatePassability(h,t,c,l),!this.getPassableSpeed(e,t,i,l))return h.length&&this.updatePassability(h,t,c),[];var u,d=this.getNodeId(r,s),g=!!c.hasNode(d);g||((u=new y.RadialTileFinder(this.tiles,this.mapBounds,r,{width:1,height:1},1,5,e=>0<this.getPassableSpeed(e,t,!1)&&Math.abs(e.z-r.z)<2&&!o?.({tile:e,onBridge:void 0,speed:100})).getNextTile())?(r=u,s=!1):(c.addNode(d,{tile:r,onBridge:void 0,speed:100}),a=Math.min(a,500)));let p=f.aStar(c,{bestEffort:n,maxExpandedNodes:a,distance(e,t){if(o?.(t.data)||!t.data.speed)return Number.POSITIVE_INFINITY;var i=Math.abs(e.data.tile.rx-t.data.tile.rx),r=Math.abs(e.data.tile.ry-t.data.tile.ry);return i+r+(Math.SQRT2-2)*Math.min(i,r)},heuristic(e,t,i){if(o?.(t.data)||!t.data.speed)return Number.POSITIVE_INFINITY;var r=Math.abs(e.data.tile.rx-t.data.tile.rx),s=Math.abs(e.data.tile.ry-t.data.tile.ry);let a=r+s+(Math.SQRT2-2)*Math.min(r,s);return i?.parent&&(s=(r=i.parent.node).data.tile.rx-e.data.tile.rx,r=r.data.tile.ry-e.data.tile.ry,i.dirX=s,i.dirY=r,s===i.parent.dirX&&r===i.parent.dirY||(a+=.2)),a}}),m=p.find(this.getNodeId(e,i),this.getNodeId(r,s)).map(e=>({tile:e.data.tile,onBridge:e.data.onBridge}));return(m.length<2||o&&m.length&&(!n&&m[0].tile!==r||m[m.length-1].tile!==e))&&(m=[]),!g&&c.hasNode(d)&&c.removeNode(d),h.length&&this.updatePassability(h,t,c),m}computeAllPassabilityGraphs(){Object.keys(c.SpeedType).forEach(e=>{var t=Number(e);isNaN(t)||t===c.SpeedType.Winged||this.computePassabilityGraph(t)})}computePassabilityGraph(t){let i=this.passabilityGraphs.get(t);if(i){let e=this.invalidatedTiles.get(t);e?.size&&(this.updatePassability([...e],t,i),e.clear())}else i=r.default({multigraph:!0}),this.passabilityGraphs.set(t,i),this.tiles.forEach(e=>{this.computePassability(e,t,i)});return i}updatePassability(e,t,i,r=[]){let s=new Set;e.forEach(e=>{[e,this.tiles.getNeighbourTile(e,h.TileDirection.Right),this.tiles.getNeighbourTile(e,h.TileDirection.BottomRight),this.tiles.getNeighbourTile(e,h.TileDirection.Bottom),this.tiles.getNeighbourTile(e,h.TileDirection.BottomLeft)].filter(a.isNotNullOrUndefined).forEach(e=>s.add(e))}),e.forEach(e=>{i.removeNode(this.getNodeId(e,!1)),i.removeNode(this.getNodeId(e,!0))}),s.forEach(e=>{this.computePassability(e,t,i,r)})}computePassability(e,t,i,r=[]){var s=[h.TileDirection.Left,h.TileDirection.TopLeft,h.TileDirection.Top,h.TileDirection.TopRight];let a=this.getPassableSpeed(e,t,!1,r);if(a){var n,o=this.getNodeId(e,!1);i.hasNode(o)||i.addNode(o,{speed:a,tile:e,onBridge:void 0});for(n of s)this.connectTiles(e,void 0,n,t,i,r)}var l=this.tileOccupation.getBridgeOnTile(e);if(l&&(a=this.getPassableSpeed(e,t,!0,r),a)){var c,o=this.getNodeId(e,!0);i.hasNode(o)||i.addNode(o,{speed:a,tile:e,onBridge:l});for(c of s)this.connectTiles(e,l,c,t,i,r)}}connectTiles(t,i,e,r,s,a=[]){var n=this.tiles.getNeighbourTile(t,e);if(n){let e=this.tileOccupation.getBridgeOnTile(n);var o=i||e?0:1;if(Math.abs(t.z+(i?.tileElevation??0)-(n.z+(e?.tileElevation??0)))>o){if(!e?.isHighBridge()&&!i?.isHighBridge()||0!==Math.abs(t.z-n.z)||!s.hasNode(this.getNodeId(t,!1)))return;i=e=void 0}var l=this.getPassableSpeed(n,r,!!e,a);l&&(o=this.getNodeId(n,!!e),s.hasNode(o)||s.addNode(o,{speed:l,tile:n,onBridge:e}),n=this.getNodeId(t,!!i),s.getLink(n,o)||s.addLink(n,o))}}getNodeId(e,t){return e.id+(t?"_bridge":"")}getPassableSpeed(e,t,i,r=[],s=!1){if(!this.mapBounds.isWithinBounds(e))return 0;let a=i?e.onBridgeLandType:e.landType;if(void 0===a)return 0;a===u.LandType.Wall&&t===c.SpeedType.Track&&(a=u.getLandType(e.terrainType));let n=this.rules.getLandRules(a);var o,l=n.getSpeedModifier(t);if(!l)return 0;if(!s)for(o of this.tileOccupation.getObjectsOnTile(e))if(this.isBlockerObject(o,e,i,t)&&!r.includes(o))return 0;return l}isBlockerObject(t,i,e,r){if(t.isTerrain()&&r===c.SpeedType.Foot&&t.rules.getOccupationBits(this.theaterType)!==o.OccupationBits.All)return!1;if(t.isBuilding()){if(t.rules.invisibleInGame)return!1;if(t.isDestroyed&&t.rules.leaveRubble)return!1;if(t.rules.gate)return!1;var s=t.art.foundation;let e=t.rules.numberImpassableRows;r===c.SpeedType.Foot?e=s.width:t.rules.weaponsFactory&&!e&&(e=s.width-1);s={x:t.tile.rx,y:t.tile.ry,width:(e||s.width)-1,height:s.height-1};return n.rectContainsPoint(s,{x:i.rx,y:i.ry})}return!(t.isAircraft()||t.isInfantry()||t.isVehicle()||t.isSmudge()||t.isOverlay()&&(e&&t.isBridge()||!e&&t.isHighBridge()||t.isTiberium()||t.rules.crate||t.isBridgePlaceholder())||r===c.SpeedType.Track&&t.rules.crushable)}findObstacles(t,e){var i,r,s=e.rules.speedType;let a=[];for(i of this.tileOccupation.getGroundObjectsOnTile(t.tile))i!==e&&(((r=this.isBlockerObject(i,t.tile,!!t.onBridge,s))||i.isUnit()&&(i.tile===t.tile&&i.onBridge===!!t.onBridge||i.moveTrait.reservedPathNodes.find(e=>e.tile===t.tile&&!!e.onBridge==!!t.onBridge))||s===c.SpeedType.Track&&i.rules.crushable||s===c.SpeedType.Foot&&i.isTerrain()||i.isBuilding()&&i.rules.gate)&&(r={obj:i,static:r},i.isInfantry()&&e.isInfantry()?i.position.desiredSubCell===e.position.desiredSubCell&&a.push(r):i.isTerrain()&&e.isInfantry()&&!i.rules.getOccupiedSubCells(this.theaterType).includes(e.position.desiredSubCell)||a.push(r)));return a}dispose(){this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate),this.mapBounds.onLocalResize.unsubscribe(this.handleMapBoundsResize)}})}}}),System.register("game/gameobject/task/system/TargetLinesConfig",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("cloneConfig",e=>e?{...e}:void 0),e("configsAreEqual",(e,t)=>!e&&!t||e?.isAttack===t?.isAttack&&e?.pathNodes===t?.pathNodes&&e?.target===t?.target),e("configHasTarget",e=>!(!e?.pathNodes.length&&!e?.target))}}}),System.register("game/gameobject/task/system/Task",["game/gameobject/task/system/TaskStatus"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Task",r=class{constructor(){this.status=i.TaskStatus.NotStarted,this.children=[],this.cancellable=!0,this.useChildTargetLines=!1,this.blocking=!0,this.waitingForChildrenToFinish=!1,this.preventOpportunityFire=!0,this.preventLanding=!0}isRunning(){return this.status===i.TaskStatus.Running}isCancelling(){return this.status===i.TaskStatus.Cancelling}setCancellable(e){return this.cancellable=e,this}onStart(e){}onEnd(e){}cancel(){if(this.cancellable)if(this.status===i.TaskStatus.Running)this.status=i.TaskStatus.Cancelling,this.children.length&&this.children.forEach(e=>e.cancel());else if(this.status===i.TaskStatus.NotStarted&&(this.status=i.TaskStatus.Cancelled,this.children.length))throw new Error("Should't have any children before starting a task")}getTargetLinesConfig(e){}})}}}),System.register("game/order/Order",["gui/PointerType","game/order/OrderFeedbackType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Order",s=class{constructor(e){this.orderType=e,this.targetOptional=!0,this.minimapAllowed=!0,this.singleSelectionRequired=!1,this.terminal=!1,this.feedbackType=r.OrderFeedbackType.None}getPointerType(e,t){return e?i.PointerType.Mini:i.PointerType.Default}set(e,t){return this.sourceObject=e,this.target=t,this}isValid(){return!0}isAllowed(){return!0}onAdd(e,t){return!0}})}}}),System.register("game/gameobject/trait/UnitOrderTrait",["game/gameobject/task/system/TaskRunner","game/gameobject/task/system/TaskStatus","game/gameobject/trait/interface/NotifyTick","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/task/system/CallbackTask","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder"],function(e,t){"use strict";var i,r,s,o,a,l,n,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){o=e},function(e){a=e},function(e){l=e},function(e){n=e},function(e){c=e}],execute:function(){h=class{constructor(e){this.gameObject=e,this.orders=[],this.queuedOrders=new Set,this.tasks=[],this.taskRunner=new i.TaskRunner}[s.NotifyTick.onTick](i,e){if(i.isSpawned){var r=this.hasTasks(),t=this.tasks.find(e=>!e.isCancelling());r&&this.taskRunner.tick(this.tasks,i);var s,a=this.orders.length;if(a&&(!r||!t)){let e,t=!1;for(;e=this.orders[0];)if(e.isValid()&&e.isAllowed()&&((s=e.process())&&(this.queuedOrders.has(e)&&(this.tasks.push(new o.WaitTicksTask(5)),this.tasks.push(new l.CallbackTask(()=>{i.resetGuardModeToIdle()}))),this.tasks.push(...s),r||this.taskRunner.tick(this.tasks,i)),t=!0),this.orders.shift(),this.queuedOrders.delete(e),this.waypointPath&&(this.currentWaypoint?(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.currentWaypoint=this.currentWaypoint?.next):this.currentWaypoint=this.waypointPath.waypoints[0],this.currentWaypoint||this.cleanupWaypointPath()),t)break}!a&&!r&&this.waypointPath&&this.currentWaypoint&&(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath());let e=t;for(;e?.useChildTargetLines;){var n=e.children.find(e=>!e.isCancelling());if(!n)break;e=n}this.targetLinesTask!==e&&(this.targetLinesTask=e,this.targetLinesConfig=e?.getTargetLinesConfig(this.gameObject))}}[a.NotifyOwnerChange.onChange](){this.clearOrders(),this.cancelAllTasks()}[n.NotifyTeleport.onBeforeTeleport](e,t,i,r){i&&!r&&(this.clearOrders(),this.tasks.length=0)}addOrder(t,e=!1){!1!==t.onAdd(this.tasks,e)?(e||(this.clearOrders(),this.tasks=this.tasks.filter(e=>e.status!==r.TaskStatus.NotStarted),this.tasks.forEach(e=>e.cancel())),this.orders.push(t),e&&this.queuedOrders.add(t),this.gameObject.traits.filter(c.NotifyOrder).forEach(e=>{e[c.NotifyOrder.onPush](this.gameObject,t.orderType)})):this.targetLinesTask=void 0}clearOrders(){this.orders.length=0,this.queuedOrders.clear(),this.currentWaypoint&&this.waypointPath&&this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath(),this.gameObject.resetGuardModeToIdle()}unmarkNextQueuedOrder(){this.orders.length&&this.queuedOrders.delete(this.orders[0])}hasTasks(){return!!this.tasks.length}isIdle(){return!this.orders.length&&!this.tasks.length}getCurrentTask(){return this.tasks[0]}cancelAllTasks(){this.tasks.forEach(e=>e.cancel())}addTask(e){this.tasks.push(e)}addTasks(...e){e.forEach(e=>this.addTask(e))}addTaskToFront(e){this.tasks.unshift(e)}addTaskNext(e){this.tasks.splice(1,0,e)}getTasks(){return[...this.tasks]}dispose(){this.clearOrders(),this.tasks.length=0,this.gameObject=void 0}cleanupWaypointPath(){this.waypointPath&&(this.waypointPath.units.splice(this.waypointPath.units.indexOf(this.gameObject),1),this.waypointPath.units.length||(this.waypointPath.waypoints.forEach(e=>e.next=void 0),this.waypointPath.waypoints.length=0),this.waypointPath=void 0),this.currentWaypoint=void 0}cleanupWaypoint(t,e){if(!e.units.find(e=>e!==this.gameObject&&(e.unitOrderTrait.currentWaypoint??e.unitOrderTrait.waypointPath?.waypoints[0])===t)&&!e.waypoints.find(e=>e.next===t)){var i=e.waypoints.indexOf(t);if(-1===i)throw new Error("Given waypoint not found in waypoint path");e.waypoints.splice(i,1)}}},e("UnitOrderTrait",h)}}}),System.register("game/gameobject/Techno",["game/gameobject/GameObject","game/rules/TechnoRules","game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.GameObject{constructor(e,t,i,r){super(e,t,i,r),this.explodes=this.rules.explodes,this.radarInvisible=this.rules.radarInvisible,this.c4=this.rules.c4,this.crusher=this.rules.crusher,this.defaultToGuardArea=this.rules.defaultToGuardArea,this.guardMode=this.rules.defaultToGuardArea,this.purchaseValue=this.rules.cost}get primaryWeapon(){return this.armedTrait?.primaryWeapon}get secondaryWeapon(){return this.armedTrait?.secondaryWeapon}get ammo(){return this.ammoTrait?.ammo}get sight(){return Math.min(r.TechnoRules.MAX_SIGHT,this.rules.sight*(this.veteranTrait?.getVeteranSightMultiplier()??1))}get veteranLevel(){return this.veteranTrait?.veteranLevel??s.VeteranLevel.None}resetGuardModeToIdle(){this.guardMode=this.defaultToGuardArea,this.guardArea=void 0}update(e){if(this.warpedOutTrait.isActive())for(var t of this.cachedTraits.tick)t.ticksWhenWarpedOut&&t[a.NotifyTick.onTick](this,e);else super.update(e)}isTechno(){return!0}},e("Techno",n)}}}),System.register("game/event/CratePickupEvent",["game/event/EventType"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("CratePickupEvent",i=class{constructor(e,t,i,r){this.target=e,this.player=t,this.source=i,this.tile=r,this.type=s.EventType.CratePickup}})}}}),System.register("game/trait/CrateGeneratorTrait",["engine/type/ObjectType","engine/type/TerrainType","game/event/CratePickupEvent","game/gameobject/unit/RangeHelper","game/gameobject/unit/ZoneType","game/gameopts/constants","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/type/PowerupType","game/type/SpeedType","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait","game/gameobject/trait/CloakableTrait","game/Warhead","game/gameobject/unit/CollisionType","game/map/tileFinder/RandomTileFinder","game/map/OreSpread","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait","game/math/Vector2","game/math/Box2"],function(e,t){"use strict";var S,i,a,n,g,r,o,w,C,s,l,E,x,O,A,M,R,P,I,k,c,h,u;t&&t.id;return{setters:[function(e){S=e},function(e){i=e},function(e){a=e},function(e){n=e},function(e){g=e},function(e){r=e},function(e){o=e},function(e){w=e},function(e){C=e},function(e){s=e},function(e){l=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){c=e},function(e){h=e}],execute:function(){e("UNSUPPORTED_POWERUP_TYPES",[C.PowerupType.IonStorm,C.PowerupType.Gas,C.PowerupType.Pod,C.PowerupType.Squad]),u=class{constructor(e){this.randomCrateSpawn=e,this.crates=[],this.availEdgeTiles=[],this.allTiles=[]}init(a){var n=a.map.tiles.getMapSize();let o=a.map.tiles,l=[],c=0;for(let d=0;d<n.width;++d){let e,t,i=!1,r=!1;for(let s=0;s<n.height;++s){var h=o.getByMapCoords(d,s);if(h&&this.canPlaceCrateOnTile(a,h)){var u=a.map.getTileZone(h)===g.ZoneType.Water;e?(u||(t=h),r=u):u?i=r=!0:e=t=h}else if(e&&!h)break}e&&(l.push(e),t&&t!==e&&l.push(t),i||r||c++)}this.availEdgeTiles=l,this.allTiles=o.getAll(),this.mapEdgeIsWater=0===c,this.minCrates=a.rules.crateRules.crateMinimum*a.gameOpts.humanPlayers.filter(e=>e.countryId!==r.OBS_COUNTRY_ID).length}[l.NotifyTick.onTick](t){for(var e of this.crates)e.ticksLeft--,e.ticksLeft<=0&&(t.unspawnObject(e.obj),e.obj.dispose());if(this.crates=this.crates.filter(e=>0<e.ticksLeft),this.randomCrateSpawn)for(let e=0;e<this.minCrates-this.crates.length&&this.spawnCrateAtRandom(this.allTiles,t);e++);}spawnCrateAtRandom(e,t){var i=this.chooseSpawnTile(e,t);if(i)return this.spawnRandomCrateAt(i,t)}spawnRandomCrateAt(e,t){if(this.canPlaceCrateOnTile(t,e)){var i=t.map.getTileZone(e,!0)===g.ZoneType.Water,i=this.choosePowerup(i,t.rules.powerups.powerups,t);if(i)return this.spawnCrateAt(e,i,t)}}spawnCrateAt(t,i,r){if(this.canPlaceCrateOnTile(r,t)){var s=r.map.getTileZone(t,!0)===g.ZoneType.Water,a=r.rules.crateRules,s=s?a.waterCrateImg:a.crateImg;let e=r.createObject(S.ObjectType.Overlay,s);e.overlayId=r.rules.getOverlayId(s),e.value=0,r.spawnObject(e,t);a=60*a.crateRegen*o.GameSpeed.BASE_TICKS_PER_SECOND*(.5+1.5*r.generateRandom());return this.crates.push({obj:e,powerup:i,ticksLeft:a}),e}}chooseSpawnTile(e,t){return t.generateRandom()<(this.mapEdgeIsWater?1/3:2/3)&&this.availEdgeTiles.length&&(e=this.availEdgeTiles),this.chooseRandomTile(e,t)}chooseRandomTile(e,t){let i;let r=0;for(;i=e[t.generateRandomInt(0,e.length-1)],r++,r<100&&!this.canPlaceCrateOnTile(t,i););if(100<=r){var s=t.map.tileOccupation.getEmptyTiles();if(!s.length)return;i=s[t.generateRandomInt(0,s.length-1)]}return i}canPlaceCrateOnTile(e,t){return e.map.mapBounds.isWithinBounds(t)&&!e.map.getGroundObjectsOnTile(t).length&&0<e.map.terrain.getPassableSpeed(t,s.SpeedType.Amphibious,!1)&&t.terrainType!==i.TerrainType.Shore&&0===t.rampType}choosePowerup(e,t,i){if((t=e?t.filter(e=>e.waterAllowed):t).length){var r,s=t.reduce((e,t)=>e+t.probShares,0),a=i.generateRandomInt(0,s);let e=0;for(r of t)if(e+=r.probShares,a<e)return r}}peekInsideCrate(t){return this.crates.find(e=>e.obj===t)?.powerup.type}pickupCrate(e,t,i){let r=this.crates.find(e=>e.obj===t);if(r){this.crates.splice(this.crates.indexOf(r),1),i.unspawnObject(r.obj),r.obj.dispose();let t=this.grantPowerup(e,r.powerup,r.obj.tile,i);var s;return void 0!==t&&(e.owner.cratesPickedUp++,s=i.rules.powerups.powerups.find(e=>e.type===t),i.events.dispatch(new a.CratePickupEvent(s,e.owner,e,r.obj.tile))),this.randomCrateSpawn&&this.spawnCrateAtRandom(this.allTiles,i),t}}grantPowerup(t,i,r,s){let a=t.owner,n=!1;if(a.isCombatant()){if(i.type===C.PowerupType.Unit){let e;if(![...a.buildings].some(e=>e.rules.constructionYard)&&s.rules.crateRules.freeMCV){let t=s.rules.general.baseUnit;if(!a.getOwnedObjects(!0).some(e=>t.includes(e.name))&&a.credits>=[...s.rules.ai.buildPower,...s.rules.ai.buildRefinery].map(e=>s.rules.getBuilding(e)).filter(e=>e.aiBasePlanningSide===a.country.side).reduce((e,t)=>e+t.cost,0)){var o=t.find(e=>{let t=s.rules.getObject(e,S.ObjectType.Vehicle);return t.isAvailableTo(a.country)&&t.hasOwner(a.country)});if(!o)throw new Error("No suitable MCV found for player country "+a.country);e=s.rules.getObject(o,S.ObjectType.Vehicle)}}if(e||(o=(o=s.rules.crateRules.unitCrateType)?s.rules.hasObject(o,S.ObjectType.Vehicle)?[s.rules.getObject(o,S.ObjectType.Vehicle)]:[]:[...s.rules.vehicleRules.values()].filter(e=>e.crateGoodie&&0<s.map.terrain.getPassableSpeed(r,e.speedType,!1))).length&&(e=o[s.generateRandomInt(0,o.length-1)]),e){let t=s.createUnitForPlayer(e,a);var l=new w.RadialTileFinder(s.map.tiles,s.map.mapBounds,r,{width:1,height:1},0,3,e=>0<s.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&!s.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length).getNextTile();l?(s.spawnObject(t,l),n=!0):(a.removeOwnedObject(t),t.dispose())}}else if(i.type===C.PowerupType.Money){if(!i.data)throw new Error("Money powerup missing data field");a.credits=Math.max(0,a.credits+Math.floor(Number(i.data)*(.55+2*s.generateRandom()*.45))),n=!0}else if(i.type===C.PowerupType.HealBase){var e;for(e of a.getOwnedObjects(!0))e.isDestroyed||e.healthTrait.healToFull(void 0,s);n=!0}else if(i.type===C.PowerupType.Reveal)s.mapShroudTrait.revealMap(a,s),n=!0;else if(i.type===C.PowerupType.Darkness)s.mapShroudTrait.resetShroud(a,s),n=!0;else if(i.type===C.PowerupType.Veteran){if(t.veteranTrait&&!t.veteranTrait.isMaxLevel()){n=!0;var c,h=Number(i.data);for(c of this.getUnitsInCrateRadius(s,r,a))c.veteranTrait?.promote(h,s)}}else if(i.type===C.PowerupType.Armor){if(1===t.crateBonuses.armor){n=!0;var u,d=Number(i.data);for(u of this.getUnitsInCrateRadius(s,r,a))1===u.crateBonuses.armor&&(u.crateBonuses.armor=d)}}else if(i.type===C.PowerupType.Firepower){if(1===t.crateBonuses.firepower){n=!0;var g,p=Number(i.data);for(g of this.getUnitsInCrateRadius(s,r,a))1===g.crateBonuses.firepower&&(g.crateBonuses.firepower=p)}}else if(i.type===C.PowerupType.Speed){if(1===t.crateBonuses.speed){n=!0;var m,f=Number(i.data);for(m of this.getUnitsInCrateRadius(s,r,a))1===m.crateBonuses.speed&&(m.crateBonuses.speed=f)}}else if(i.type===C.PowerupType.Cloak){if(!t.cloakableTrait){n=!0;for(var y of this.getUnitsInCrateRadius(s,r,a))y.cloakableTrait||(y.cloakableTrait=new O.CloakableTrait(y,s.rules.general.cloakDelay),s.addObjectTrait(y,y.cloakableTrait))}}else if(i.type===C.PowerupType.ICBM){l=[...s.rules.superWeaponRules.values()].find(e=>e.type===E.SuperWeaponType.MultiMissile);if(l&&a.superWeaponsTrait&&!a.superWeaponsTrait.has(l.name)){let e=s.createSuperWeapon(l.name,a,!0);e.isGift=!0,a.superWeaponsTrait.add(e),n=!0}}else if(i.type===C.PowerupType.Invulnerability){var T=[...s.rules.superWeaponRules.values()].find(e=>e.type===E.SuperWeaponType.IronCurtain);T&&(s.traits.get(x.SuperWeaponsTrait).activateEffect(T,a,s,r,void 0,!0),n=!0)}else if(i.type===C.PowerupType.Explosion||i.type===C.PowerupType.Napalm){n=!0;var v=Number(i.data),T=i.type===C.PowerupType.Napalm?s.rules.combatDamage.flameDamage:s.rules.combatDamage.c4Warhead;let e=new A.Warhead(s.rules.getWarhead(T));e.detonate(s,v,t.tile,t.tileElevation,t.position.worldPosition,t.zone,M.CollisionType.None,s.createTarget(t,t.tile),{player:t.owner,weapon:void 0},!1,!1,void 0,0)}else{if(i.type!==C.PowerupType.Tiberium)return void console.warn(`Unhandled powerup type "${C.PowerupType[i.type]}"`);{let e=new R.RandomTileFinder(s.map.tiles,s.map.mapBounds,r,2,s,e=>k.TiberiumTrait.canBePlacedOn(e,s.map)),t,i=0;for(;i++<6&&(t=e.getNextTile());){var b=P.OreSpread.calculateOverlayId(I.OverlayTibType.Ore,t);if(void 0===b)throw new Error("Expected an overlayId");let e=s.createObject(S.ObjectType.Overlay,s.rules.getOverlayName(b));e.overlayId=b,e.value=3,s.spawnObject(e,t),n=!0}}}if(n)return i.type;v=s.rules.powerups.powerups.find(e=>e.type===C.PowerupType.Money&&0<e.probShares);return v?this.grantPowerup(t,v,r,s):void 0}}getUnitsInCrateRadius(e,t,i){let r=e.rules.crateRules.crateRadius,s=new n.RangeHelper(e.map.tileOccupation);return e.map.technosByTile.queryRange((new h.Box2).setFromCenterAndSize(new c.Vector2(t.rx,t.ry),new c.Vector2(r,r))).filter(e=>e.owner===i&&e.isUnit()&&s.tileDistance(e,t)<=r)}},e("CrateGeneratorTrait",u)}}}),System.register("game/rules/PowerupsRules",["game/trait/CrateGeneratorTrait","game/type/PowerupType"],function(e,t){"use strict";var o,l,i;t&&t.id;return{setters:[function(e){o=e},function(e){l=e}],execute:function(){e("PowerupsRules",i=class{constructor(){this.powerups=[]}readIni(e){for(var[s,a]of e.entries){let[e,t,i,r]=a.split(",");var n=Number(e),a=l.PowerupType[s];void 0!==a?o.UNSUPPORTED_POWERUP_TYPES.includes(a)||this.powerups.push({type:a,probShares:n,animName:"<none>"!==t.toLowerCase()?t:void 0,waterAllowed:"yes"===i,data:r}):console.warn(`Unknown powerup "${s}". Skipping.`)}return this}})}}}),System.register("game/rules/mpAllowedColors",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("mpAllowedColors",["Gold","DarkRed","DarkBlue","DarkGreen","Orange","DarkSky","Purple","Magenta"])}}}),System.register("game/rules/Rules",["util/Color","engine/type/ObjectType","game/rules/CountryRules","game/rules/WeaponRules","game/rules/AudioVisualRules","game/rules/GeneralRules","game/rules/MpDialogSettings","game/type/LandType","game/rules/LandRules","game/rules/WarheadRules","game/rules/ProjectileRules","game/rules/ObjectRulesFactory","game/rules/CombatDamageRules","game/rules/TiberiumRules","game/rules/AiRules","game/rules/ElevationModelRules","game/rules/RadiationRules","game/rules/SuperWeaponRules","game/rules/CrateRules","game/rules/PowerupsRules","game/rules/mpAllowedColors","util/typeGuard","game/Weapon"],function(e,t){"use strict";var a,n,s,r,i,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){s=e},function(e){r=e},function(e){i=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e}],execute:function(){e("Rules",x=class{constructor(e,t){this.ini=e,this.logger=t,this.buildingTypes=new Map,this.vehicleTypes=new Map,this.infantryTypes=new Map,this.aircraftTypes=new Map,this.terrainTypes=new Map,this.overlayTypes=new Map,this.overlayIdsByType=new Map,this.animationTypes=new Map,this.animationNames=new Set,this.voxelAnimTypes=new Map,this.smudgeTypes=new Map,this.warheadTypes=new Map,this.tiberiumTypes=new Map,this.superWeaponTypes=new Map,this.countryTypes=new Map,this.weaponTypes=new Map,this.allObjectRules=new Map,this.buildingRules=new Map,this.infantryRules=new Map,this.vehicleRules=new Map,this.aircraftRules=new Map,this.terrainRules=new Map,this.overlayRules=new Map,this.smudgeRules=new Map,this.voxelAnimRules=new Map,this.countryRules=new Map,this.warheadRules=new Map,this.powerups=new S.PowerupsRules,this.colors=new Map,this.general=new o.GeneralRules,this.ai=new f.AiRules,this.crateRules=new b.CrateRules,this.elevationModel=new y.ElevationModelRules,this.mpDialogSettings=new l.MpDialogSettings,this.audioVisual=new i.AudioVisualRules,this.combatDamage=new p.CombatDamageRules,this.radiation=new T.RadiationRules,this.landRules=new Map,this.tiberiumRules=new Map,this.superWeaponRules=new Map,this.cachedWeaponRules=new Map,this.cachedProjectileRules=new Map,this.init()}hasObject(e,t){return this.allObjectRules.get(t)?.has(e)}getObject(e,t){var i=this.allObjectRules.get(t)?.get(e);if(!i)throw new Error(`Missing rules for object "${e}"`);return i}getTechnoByInternalId(e,t){let i;if(t===n.ObjectType.Building)i=this.buildingTypes.get(e);else if(t===n.ObjectType.Infantry)i=this.infantryTypes.get(e);else if(t===n.ObjectType.Vehicle)i=this.vehicleTypes.get(e);else{if(t!==n.ObjectType.Aircraft)throw new Error(`Type ${n.ObjectType[t]} is not a techno type`);i=this.aircraftTypes.get(e)}if(void 0===i)throw new Error(`Object type "${n.ObjectType[t]}" with ID "${e}" not found`);return this.getObject(i,t)}getBuilding(e){var t=this.buildingRules.get(e);if(!t)throw new Error(`Missing rules for building "${e}"`);return t}getWeapon(e){let t=this.cachedWeaponRules.get(e);if(!t){var i=this.ini.getSection(e);if(!i)throw new Error(`Weapon ${e} is missing ini section`);t=new r.WeaponRules(i),this.cachedWeaponRules.set(e,t)}return t}getWeaponByInternalId(e){var t=this.weaponTypes.get(e);if(!t)throw new RangeError(`Weapon with internal ID "${e}" not found`);return this.getWeapon(t)}getWarhead(e){let t=this.warheadRules.get(e.toLowerCase());var i;if(t||(i=this.ini.getSection(e))&&(t=new u.WarheadRules(i),this.warheadRules.set(e.toLowerCase(),t)),!t)throw new Error("Unknown warhead "+e);return t}getProjectile(e){let t=this.cachedProjectileRules.get(e);if(!t){var i=this.ini.getSection(e);if(!i)throw new Error(`Projectile ${e} is missing ini section`);t=new d.ProjectileRules(n.ObjectType.Projectile,i),this.cachedProjectileRules.set(e,t)}return t}getOverlayName(e){var t=this.overlayTypes.get(e);if(!t)throw new Error("Invalid overlay id "+e);return t}hasOverlayId(e){return this.overlayTypes.has(e)}getOverlayId(e){var t=this.overlayIdsByType.get(e);if(void 0===t)throw new Error("Invalid overlay name "+e);return t}getOverlay(e){var t=this.overlayRules.get(e);if(!t)throw new Error(`Missing rules for overlay "${e}"`);return t}getAnimationName(e){return this.animationTypes.get(e)}getCountry(e){if(!this.countryRules.has(e))throw new Error("Unknown country "+e);return this.countryRules.get(e)}getMultiplayerCountries(){return[...this.countryRules.values()].filter(e=>e.multiplay)}getMultiplayerColors(){let t=new Map;return w.mpAllowedColors.forEach(e=>{if(!this.colors.has(e))throw new Error(`Multiplayer color "${e}" does not exist in the rules [Colors] section.`);t.set(e,this.colors.get(e))}),t}getLandRules(e){let t=this.landRules.get(e);var i;return t||(i=e===c.LandType.Cliff?"Rock":c.LandType[e],t=(new h.LandRules).readIni(this.ini.getOrCreateSection(i)),this.landRules.set(e,t)),t}getTiberium(e){var t=this.tiberiumTypes.get(e);if(!t)throw new Error("Unknown tiberium type "+e);return this.tiberiumRules.get(t)}getSuperWeapon(e){if(!this.superWeaponRules.has(e))throw new Error(`Unknown superweapon type "${e}"`);return this.superWeaponRules.get(e)}getIni(){return this.ini}applySpecialFlags(e){e.initialVeteran&&(this.general.veteran.initialVeteran=!0)}init(){this.readAudioVisual(),this.readCombatDamage(),this.readRadiation(),this.readGeneral(),this.readAi(),this.readCrateRules(),this.readElevationModel(),this.readMpDialogSettings(),this.readObjectTypes("BuildingTypes",this.buildingTypes),this.readObjectTypes("InfantryTypes",this.infantryTypes),this.readObjectTypes("VehicleTypes",this.vehicleTypes),this.readObjectTypes("AircraftTypes",this.aircraftTypes),this.readObjectTypes("TerrainTypes",this.terrainTypes),this.readObjectTypes("SmudgeTypes",this.smudgeTypes),this.readObjectTypes("Animations",this.animationTypes),this.animationNames=new Set(this.animationTypes.values()),this.readObjectTypes("VoxelAnims",this.voxelAnimTypes),this.readObjectTypes("OverlayTypes",this.overlayTypes),this.overlayTypes.forEach((e,t)=>this.overlayIdsByType.set(e,t)),this.readColors(),this.readObjectTypes("Countries",this.countryTypes),this.readObjectTypes("Warheads",this.warheadTypes),this.readObjectTypes("Tiberiums",this.tiberiumTypes),this.readObjectTypes("SuperWeaponTypes",this.superWeaponTypes),this.allObjectRules.set(n.ObjectType.Building,this.buildingRules).set(n.ObjectType.Infantry,this.infantryRules).set(n.ObjectType.Vehicle,this.vehicleRules).set(n.ObjectType.Aircraft,this.aircraftRules).set(n.ObjectType.Terrain,this.terrainRules).set(n.ObjectType.Overlay,this.overlayRules).set(n.ObjectType.Smudge,this.smudgeRules).set(n.ObjectType.VoxelAnim,this.voxelAnimRules),this.readObjects(n.ObjectType.Building,this.buildingTypes,this.buildingRules),this.readObjects(n.ObjectType.Infantry,this.infantryTypes,this.infantryRules),this.readObjects(n.ObjectType.Vehicle,this.vehicleTypes,this.vehicleRules),this.readObjects(n.ObjectType.Aircraft,this.aircraftTypes,this.aircraftRules),this.readObjects(n.ObjectType.Terrain,this.terrainTypes,this.terrainRules),this.readObjects(n.ObjectType.Overlay,this.overlayTypes,this.overlayRules),this.readObjects(n.ObjectType.Smudge,this.smudgeTypes,this.smudgeRules),this.readObjects(n.ObjectType.VoxelAnim,this.voxelAnimTypes,this.voxelAnimRules),this.readCountries(),this.readWarheads(),this.readPowerups(),this.readTiberiums(),this.readSuperWeapons(),this.buildWeaponsList()}readAudioVisual(){var e=this.ini.getSection("AudioVisual");if(!e)throw new Error("Missing [AudioVisual] section");this.audioVisual.readIni(e)}readCombatDamage(){var e=this.ini.getSection("CombatDamage");if(!e)throw new Error("Missing [CombatDamage] section");this.combatDamage.readIni(e)}readRadiation(){var e=this.ini.getSection("Radiation");if(!e)throw new Error("Missing [Radiation] section");this.radiation.readIni(e)}readGeneral(){var e=this.ini.getSection("General");if(!e)throw new Error("Missing [General] section");this.general.readIni(e)}readAi(){var e=this.ini.getSection("AI");if(!e)throw new Error("Missing [AI] section");this.ai.readIni(e)}readCrateRules(){var e=this.ini.getSection("CrateRules");if(!e)throw new Error("Missing [CrateRules] section");this.crateRules.readIni(e)}readElevationModel(){var e=this.ini.getSection("ElevationModel");if(!e)throw new Error("Missing [ElevationModel] section");this.elevationModel.readIni(e)}readMpDialogSettings(){var e=this.ini.getSection("MultiplayerDialogSettings");if(!e)throw new Error("Missing [MultiplayerDialogSettings] section");this.mpDialogSettings.readIni(e)}readObjectTypes(i,r){let e=this.ini.getSection(i);if(!e)throw new Error(`Missing [${i}] section`);let s=0,a=new Set;e.entries.forEach((e,t)=>{Number.isNaN(Number(t))?this.logger?.debug(`Non-numeric id "${t}" found in rules section [${i}]. Skipping.`):a.has(e)?this.logger?.debug(`Duplicate type "${e}" in rules section [${i}]. Skipping.`):(r.set(s++,e),a.add(e))})}readColors(){let e=this.ini.getSection("Colors");if(!e)throw new Error("Missing [Colors] section");e.entries.forEach((e,t)=>{var[i,r,s]=e.split(","),s=a.Color.fromHsv(parseInt(i,10),parseInt(r,10),parseInt(s,10));this.colors.set(t,s)})}readObjects(r,e,s){e.forEach((e,t)=>{var i=this.ini.getSection(e);i?(i=(new g.ObjectRulesFactory).create(r,i,t),s.set(e,i)):this.logger?.debug(n.ObjectType[r]+` type "${e}" has no rules section`)})}readCountries(){this.countryTypes.forEach((e,t)=>{var i=this.ini.getSection(e);if(!i)throw new Error("Missing ini section for country "+e);let r=new s.CountryRules(t);r.readIni(i),this.countryRules.set(e,r)})}readWarheads(){this.warheadTypes.forEach(e=>{var t=this.ini.getSection(e);t?(t=new u.WarheadRules(t),this.warheadRules.set(e.toLowerCase(),t)):this.logger?.debug(`Warhead "${e}" has no rules section`)})}readPowerups(){var e=this.ini.getSection("Powerups");if(!e)throw new Error("Missing [Powerups] section");this.powerups.readIni(e)}readTiberiums(){this.tiberiumTypes.forEach(e=>{var t=this.ini.getSection(e);if(!t)throw new Error("Missing rules section for tiberium type "+e);this.tiberiumRules.set(e,(new m.TiberiumRules).readIni(t))})}readSuperWeapons(){this.superWeaponTypes.forEach((e,t)=>{var i=this.ini.getSection(e);if(!i)throw new Error("Missing rules section for superweapon type "+e);this.superWeaponRules.set(e,new v.SuperWeaponRules(t).readIni(i))})}buildWeaponsList(){let e=new Set;e.add(this.general.dropPodWeapon);for(var t of this.superWeaponRules.values())t.weaponType&&e.add(t.weaponType);var i,r;e.add(E.Weapon.NUKE_PAYLOAD_NAME);for(let a of[...this.buildingRules.values(),...this.aircraftRules.values(),...this.vehicleRules.values(),...this.infantryRules.values()])for(i of[a.deathWeapon,a.primary,a.secondary,a.elitePrimary,a.eliteSecondary,a.occupyWeapon,a.eliteOccupyWeapon,...a.weaponCount?new Array(a.weaponCount).fill(0).map((e,t)=>[a.getWeaponAtIndex(t),a.getEliteWeaponAtIndex(t)]).flat():[]].filter(C.isNotNullOrUndefined).filter(e=>""!==e))e.add(i);let s=0;for(r of e)this.weaponTypes.set(s++,r)}})}}}),System.register("game/Country",["engine/type/ObjectType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("Country",i=class{constructor(e){this.rules=e}static factory(e,t){return new this(t.getCountry(e))}get id(){return this.rules.id}get side(){return this.rules.side}get name(){return this.rules.name}isPlayable(){return this.rules.multiplay&&!this.rules.multiplayPassive}hasVeteranUnit(e,t){let i=[];switch(e){case r.ObjectType.Aircraft:i=this.rules.veteranAircraft;break;case r.ObjectType.Infantry:i=this.rules.veteranInfantry;break;case r.ObjectType.Vehicle:i=this.rules.veteranUnits;break;default:throw new Error(`Unsupported object type "${r.ObjectType[e]}"`)}return i.includes(t)}})}}}),System.register("game/rules/TechnoRules",["engine/type/ObjectType","game/SideType","game/type/SpeedType","game/type/PipColor","game/type/LocomotorType","game/type/MovementZone","game/type/ArmorType","game/type/LandTargeting","game/type/NavalTargeting","game/rules/ObjectRules","game/WeaponType","game/gameobject/unit/VeteranAbility","game/type/VhpScan","game/math/Vector3"],function(t,e){"use strict";var s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b;e&&e.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){var e;(e=T=T||{})[e.Combat=0]="Combat",e[e.Tech=1]="Tech",e[e.Resource=2]="Resource",e[e.Power=3]="Power",t("BuildCat",T),(e=v=v||{})[e.None=0]="None",e[e.BuildingType=1]="BuildingType",e[e.InfantryType=2]="InfantryType",e[e.UnitType=3]="UnitType",e[e.NavalUnitType=4]="NavalUnitType",e[e.AircraftType=5]="AircraftType",t("FactoryType",v),b=class b extends g.ObjectRules{parse(){super.parse(),this.owner=this.ini.getArray("Owner");var e=this.ini.getNumber("AIBasePlanningSide");this.aiBasePlanningSide=-1!==e&&void 0!==a.SideType[e]?e:void 0,this.requiredHouses=this.ini.getArray("RequiredHouses"),this.forbiddenHouses=this.ini.getArray("ForbiddenHouses"),this.requiresStolenAlliedTech=this.ini.getBool("RequiresStolenAlliedTech"),this.requiresStolenSovietTech=this.ini.getBool("RequiresStolenSovietTech"),this.techLevel=this.ini.getNumber("TechLevel",-1),this.cost=this.ini.getNumber("Cost"),this.points=this.ini.getNumber("Points"),this.power=this.ini.getNumber("Power"),this.powered=this.ini.getBool("Powered"),this.prerequisite=this.ini.getArray("Prerequisite"),this.soylent=this.ini.getNumber("Soylent"),this.crateGoodie=this.ini.getBool("CrateGoodie"),this.buildCat=this.ini.getEnum("BuildCat",T,T.Combat),this.adjacent=this.ini.getNumber("Adjacent",1),this.baseNormal=this.ini.getBool("BaseNormal",!0),this.buildLimit=this.ini.getNumber("BuildLimit",Number.POSITIVE_INFINITY),this.airRangeBonus=this.ini.getNumber("AirRangeBonus"),this.guardRange=this.ini.getNumber("GuardRange"),this.defaultToGuardArea=this.ini.getBool("DefaultToGuardArea"),this.eligibileForAllyBuilding=this.ini.getBool("EligibileForAllyBuilding"),this.numberImpassableRows=this.ini.getNumber("NumberImpassableRows"),this.bridgeRepairHut=this.ini.getBool("BridgeRepairHut"),this.constructionYard=this.ini.getBool("ConstructionYard"),this.refinery=this.ini.getBool("Refinery"),this.unitRepair=this.ini.getBool("UnitRepair"),this.unitReload=this.ini.getBool("UnitReload"),this.isBaseDefense=this.ini.getBool("IsBaseDefense"),this.superWeapon=this.parseWeaponName(this.ini.getString("SuperWeapon")),this.chargedAnimTime=this.ini.getNumber("ChargedAnimTime");var t=this.ini.getBool("Naval");this.naval=t,this.underwater=this.ini.getBool("Underwater"),this.waterBound=this.ini.getBool("WaterBound"),this.orePurifier=this.ini.getBool("OrePurifier"),this.cloning=this.ini.getBool("Cloning"),this.nukeSilo=this.ini.getBool("NukeSilo"),this.repairable=this.ini.getBool("Repairable",this.type===s.ObjectType.Building),this.clickRepairable=this.ini.getBool("ClickRepairable",this.type===s.ObjectType.Building),this.unsellable=this.ini.getBool("Unsellable"),this.gdiBarracks=this.ini.getBool("GDIBarracks"),this.nodBarracks=this.ini.getBool("NODBarracks"),this.numberOfDocks=this.ini.getNumber("NumberOfDocks"),this.unitRepair&&!this.numberOfDocks&&(this.numberOfDocks=1),this.factory=this.ini.getEnum("Factory",v,v.None),this.factory===v.UnitType&&t&&(this.factory=v.NavalUnitType),this.weaponsFactory=this.ini.getBool("WeaponsFactory"),this.helipad=this.ini.getBool("Helipad"),this.hospital=this.ini.getBool("Hospital"),this.landTargeting=this.ini.getEnumNumeric("LandTargeting",u.LandTargeting,u.LandTargeting.LandOk),this.navalTargeting=this.ini.getEnumNumeric("NavalTargeting",d.NavalTargeting,d.NavalTargeting.UnderwaterNever),this.tooBigToFitUnderBridge=this.ini.getBool("TooBigToFitUnderBridge",this.type===s.ObjectType.Building),this.canBeOccupied=this.ini.getBool("CanBeOccupied"),this.maxNumberOccupants=this.ini.getNumber("MaxNumberOccupants"),this.leaveRubble=this.ini.getBool("LeaveRubble"),this.undeploysInto=this.ini.getString("UndeploysInto"),this.deploysInto=this.ini.getString("DeploysInto"),this.capturable=this.ini.getBool("Capturable"),this.spyable=this.ini.getBool("Spyable"),this.needsEngineer=this.ini.getBool("NeedsEngineer"),this.c4=this.ini.getBool("C4"),this.canC4=this.ini.getBool("CanC4",!0),this.produceCashStartup=this.ini.getNumber("ProduceCashStartup"),this.produceCashAmount=this.ini.getNumber("ProduceCashAmount"),this.produceCashDelay=this.ini.getNumber("ProduceCashDelay"),this.explosion=this.ini.getArray("Explosion"),this.explodes=this.ini.getBool("Explodes"),this.ifvMode=this.ini.getNumber("IFVMode"),this.turretIndexesByIfvMode=this.parseTurretIndexes(),this.turret=this.ini.getBool("Turret"),this.turretCount=this.ini.getNumber("TurretCount",this.turret?1:0),this.turretAnim=this.ini.getString("TurretAnim"),this.turretAnimIsVoxel=this.ini.getBool("TurretAnimIsVoxel"),this.turretAnimX=this.ini.getNumber("TurretAnimX"),this.turretAnimY=this.ini.getNumber("TurretAnimY"),this.turretAnimZAdjust=this.ini.getNumber("TurretAnimZAdjust"),this.isChargeTurret=this.ini.getBool("IsChargeTurret"),this.overpowerable=this.ini.getBool("Overpowerable"),this.freeUnit=this.ini.getString("FreeUnit"),this.primary=this.parseWeaponName(this.ini.getString("Primary")),this.secondary=this.parseWeaponName(this.ini.getString("Secondary")),this.elitePrimary=this.parseWeaponName(this.ini.getString("ElitePrimary")),this.eliteSecondary=this.parseWeaponName(this.ini.getString("EliteSecondary")),this.weaponCount=this.ini.getNumber("WeaponCount"),this.deathWeapon=this.parseWeaponName(this.ini.getString("DeathWeapon")),this.deathWeaponDamageModifier=this.ini.getNumber("DeathWeaponDamageModifier",1),this.occupyWeapon=this.parseWeaponName(this.ini.getString("OccupyWeapon")),this.eliteOccupyWeapon=this.parseWeaponName(this.ini.getString("EliteOccupyWeapon")),this.veteranAbilities=new Set(this.ini.getEnumArray("VeteranAbilities",m.VeteranAbility)),this.eliteAbilities=new Set([...this.veteranAbilities,...this.ini.getEnumArray("EliteAbilities",m.VeteranAbility)]),this.selfHealing=this.ini.getBool("SelfHealing"),this.wall=this.ini.getBool("Wall"),this.gate=this.ini.getBool("Gate"),this.armor=this.ini.getEnum("Armor",h.ArmorType,h.ArmorType.None,!0),this.strength=Math.floor(this.ini.getNumber("Strength")),this.immune=this.ini.getBool("Immune"),this.immuneToRadiation=this.ini.getBool("ImmuneToRadiation"),this.immuneToPsionics=this.ini.getBool("ImmuneToPsionics"),this.typeImmune=this.ini.getBool("TypeImmune"),this.warpable=this.ini.getBool("Warpable",!0),this.isTilter=this.ini.getBool("IsTilter",!0),this.walkRate=this.ini.getNumber("WalkRate",1),this.idleRate=this.ini.getNumber("IdleRate",0),this.noSpawnAlt=this.ini.getBool("NoSpawnAlt"),this.crusher=this.ini.getBool("Crusher"),this.consideredAircraft=this.ini.getBool("ConsideredAircraft"),this.crashable=this.ini.getBool("Crashable");var i=this.ini.getBool("Landable");this.landable=i,this.airportBound=this.ini.getBool("AirportBound"),this.balloonHover=this.ini.getBool("BalloonHover"),this.hoverAttack=this.ini.getBool("HoverAttack"),this.omniFire=this.ini.getBool("OmniFire"),this.fighter=this.ini.getBool("Fighter"),this.flightLevel=this.ini.getNumber("FlightLevel")||void 0;var r=this.ini.getString("Locomotor"),e=this.type===s.ObjectType.Building?l.LocomotorType.Statue:l.LocomotorType.Chrono;if(r?(t=l.locomotorTypesByClsId.get(r))?this.locomotor=t:(console.warn(`Object rules "${this.name}" has invalid Locomotor "${r}"`),this.locomotor=e):this.locomotor=e,this.locomotor!==l.LocomotorType.Statue){let e=l.defaultSpeedsByLocomotor.get(this.locomotor);void 0===e&&(this.type===s.ObjectType.Aircraft||this.consideredAircraft?e=n.SpeedType.Winged:this.type===s.ObjectType.Vehicle?e=this.crusher?n.SpeedType.Track:n.SpeedType.Wheel:this.type===s.ObjectType.Infantry&&(e=n.SpeedType.Foot)),this.speedType=this.ini.getEnum("SpeedType",n.SpeedType,e,!0)}e=[l.LocomotorType.Ship,l.LocomotorType.Vehicle,l.LocomotorType.Chrono].includes(this.locomotor)?65:100;this.speed=g.ObjectRules.iniSpeedToLeptonsPerTick(this.ini.getNumber("Speed"),e),this.movementZone=this.ini.getEnum("MovementZone",c.MovementZone,c.MovementZone.Normal),this.fearless=this.ini.getBool("Fearless"),this.deployer=this.ini.getBool("Deployer"),this.deployFire=this.ini.getBool("DeployFire"),this.deployFireWeapon=this.ini.getNumber("DeployFireWeapon",p.WeaponType.Secondary),this.undeployDelay=this.ini.getNumber("UndeployDelay"),this.fraidycat=this.ini.getBool("Fraidycat",!1),this.isHuman=!this.ini.getBool("NotHuman"),this.organic=this.type===s.ObjectType.Infantry||this.ini.getBool("Organic"),this.occupier=this.ini.getBool("Occupier"),this.engineer=this.ini.getBool("Engineer"),this.ivan=this.ini.getBool("Ivan"),this.civilian=this.ini.getBool("Civilian"),this.agent=this.ini.getBool("Agent"),this.infiltrate=this.ini.getBool("Infiltrate"),this.threatPosed=this.ini.getNumber("ThreatPosed"),this.specialThreatValue=this.ini.getNumber("SpecialThreatValue"),this.canPassiveAquire=this.ini.getBool("CanPassiveAquire",!0),this.canRetaliate=this.ini.getBool("CanRetaliate",!0),this.preventAttackMove=this.ini.getBool("PreventAttackMove"),this.opportunityFire=this.ini.getBool("OpportunityFire"),this.distributedFire=this.ini.getBool("DistributedFire"),this.radialFireSegments=this.ini.getNumber("RadialFireSegments"),this.attackCursorOnFriendlies=this.ini.getBool("AttackCursorOnFriendlies"),this.bombable=this.ini.getBool("Bombable",!0),this.trainable=this.ini.getBool("Trainable",this.type!==s.ObjectType.Building),this.crewed=this.ini.getBool("Crewed"),this.parasiteable=this.ini.getBool("Parasiteable",this.type!==s.ObjectType.Building),this.suppressionThreshold=this.ini.getNumber("SuppressionThreshold"),this.reselectIfLimboed=this.ini.getBool("ReselectIfLimboed"),this.rejoinTeamIfLimboed=this.ini.getBool("RejoinTeamIfLimboed"),this.weight=this.ini.getNumber("Weight"),this.accelerates=this.ini.getBool("Accelerates",!0),this.accelerationFactor=this.ini.getNumber("AccelerationFactor",.03),this.teleporter=this.ini.getBool("Teleporter"),this.canDisguise=this.ini.getBool("CanDisguise"),this.disguiseWhenStill=this.ini.getBool("DisguiseWhenStill"),this.permaDisguise=this.ini.getBool("PermaDisguise"),this.detectDisguise=this.ini.getBool("DetectDisguise"),this.detectDisguiseRange=this.ini.getNumber("DetectDisguiseRange"),this.cloakable=this.ini.getBool("Cloakable"),this.sensors=this.ini.getBool("Sensors"),this.sensorArray=this.ini.getBool("SensorArray"),this.sensorsSight=this.ini.getNumber("SensorsSight"),this.burstDelay=this.parseBurstDelay(),this.vhpScan=this.ini.getEnum("VHPScan",f.VhpScan,f.VhpScan.None,!0),this.pip=this.ini.getEnum("Pip",o.PipColor,o.PipColor.Green,!0),this.passengers=this.ini.getNumber("Passengers"),this.gunner=this.ini.getBool("Gunner"),this.ammo=this.ini.getNumber("Ammo",-1),this.initialAmmo=this.ini.getNumber("InitialAmmo",-1),this.manualReload=this.ini.getBool("ManualReload",this.type===s.ObjectType.Aircraft),this.storage=this.ini.getNumber("Storage"),this.spawned=this.ini.getBool("Spawned"),this.spawns=this.ini.getString("Spawns"),this.spawnsNumber=this.ini.getNumber("SpawnsNumber"),this.spawnRegenRate=this.ini.getNumber("SpawnRegenRate"),this.spawnReloadRate=this.ini.getNumber("SpawnReloadRate"),this.missileSpawn=this.ini.getBool("MissileSpawn"),this.size=this.ini.getNumber("Size",1),this.sizeLimit=this.ini.getNumber("SizeLimit"),this.sight=Math.min(b.MAX_SIGHT,this.ini.getNumber("Sight",1)),this.spySat=this.ini.getBool("SpySat"),this.gapGenerator=this.ini.getBool("GapGenerator"),this.gapRadiusInCells=this.ini.getNumber("GapRadiusInCells"),this.psychicDetectionRadius=this.ini.getNumber("PsychicDetectionRadius"),this.hasRadialIndicator=this.ini.getBool("HasRadialIndicator"),this.harvester=this.ini.getBool("Harvester"),this.unloadingClass=this.ini.getString("UnloadingClass"),this.dock=this.ini.getArray("Dock"),this.radar=this.ini.getBool("Radar"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.revealToAll=this.ini.getBool("RevealToAll"),this.selectable=!(this.type===s.ObjectType.Aircraft&&!i)&&this.ini.getBool("Selectable",!0),this.isSelectableCombatant=this.ini.getBool("IsSelectableCombatant"),this.invisibleInGame=this.ini.getBool("InvisibleInGame"),this.moveToShroud=this.ini.getBool("MoveToShroud",this.type!==s.ObjectType.Aircraft),this.leadershipRating=this.ini.getNumber("LeadershipRating",5),this.allowedToStartInMultiplayer=this.ini.getBool("AllowedToStartInMultiplayer",!0),this.rot=g.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("ROT",0)),this.jumpjetAccel=this.ini.getNumber("JumpJetAccel",2),this.jumpjetClimb=this.ini.getNumber("JumpjetClimb",5),this.jumpjetCrash=this.ini.getNumber("JumpjetCrash",5),this.jumpjetDeviation=this.ini.getNumber("JumpjetDeviation",40),this.jumpjetHeight=this.ini.getNumber("JumpjetHeight",500),this.jumpjetNoWobbles=this.ini.getBool("JumpjetNoWobbles"),this.jumpjetSpeed=this.ini.getNumber("JumpjetSpeed",14),this.jumpjetTurnRate=g.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("JumpJetTurnRate",4)),this.jumpjetWobbles=this.ini.getNumber("JumpjetWobbles",.15),this.pitchSpeed=this.ini.getNumber("PitchSpeed",.25),this.pitchAngle=1<=this.pitchSpeed?0:20,this.damageParticleSystems=this.ini.getArray("DamageParticleSystems");i=this.ini.getNumberArray("DamageSmokeOffset",void 0,[0,0,0]);this.damageSmokeOffset=new y.Vector3(i[0],i[2]/Math.SQRT2,i[1]),this.minDebris=this.ini.getNumber("MinDebris"),this.maxDebris=this.ini.getNumber("MaxDebris"),this.debrisTypes=this.ini.getArray("DebrisTypes"),this.debrisAnims=this.ini.getArray("DebrisAnims"),this.isLightpost="GALITE"===this.imageName,this.lightVisibility=this.ini.getNumber("LightVisibility",5e3),this.lightIntensity=this.ini.getNumber("LightIntensity"),this.lightRedTint=this.ini.getNumber("LightRedTint",1),this.lightGreenTint=this.ini.getNumber("LightGreenTint",1),this.lightBlueTint=this.ini.getNumber("LightBlueTint",1),this.ambientSound=this.ini.getString("AmbientSound")||void 0,this.createSound=this.ini.getString("CreateSound")||void 0,this.deploySound=this.ini.getString("DeploySound")||void 0,this.undeploySound=this.ini.getString("UndeploySound")||void 0,this.voiceSelect=this.ini.getString("VoiceSelect")||void 0,this.voiceMove=this.ini.getString("VoiceMove")||void 0,this.voiceAttack=this.ini.getString("VoiceAttack")||void 0,this.voiceFeedback=this.ini.getString("VoiceFeedback")||void 0,this.voiceSpecialAttack=this.ini.getString("VoiceSpecialAttack")||void 0,this.voiceEnter=this.ini.getString("VoiceEnter")||void 0,this.voiceCapture=this.ini.getString("VoiceCapture")||void 0,this.voiceCrashing=this.ini.getString("VoiceCrashing")||void 0,this.crashingSound=this.ini.getString("CrashingSound")||void 0,this.impactLandSound=this.ini.getString("ImpactLandSound")||void 0,this.auxSound1=this.ini.getString("AuxSound1")||void 0,this.auxSound2=this.ini.getString("AuxSound2")||void 0,this.dieSound=this.ini.getString("DieSound")||void 0,this.moveSound=this.ini.getString("MoveSound")||void 0,this.enterWaterSound=this.ini.getString("EnterWaterSound")||void 0,this.leaveWaterSound=this.ini.getString("LeaveWaterSound")||void 0,this.turretRotateSound=this.ini.getString("TurretRotateSound")||void 0,this.workingSound=this.ini.getString("WorkingSound")||void 0,this.notWorkingSound=this.ini.getString("NotWorkingSound")||void 0,this.chronoInSound=this.ini.getString("ChronoInSound")||void 0,this.chronoOutSound=this.ini.getString("ChronoOutSound")||void 0,this.enterTransportSound=this.ini.getString("EnterTransportSound")||void 0,this.leaveTransportSound=this.ini.getString("LeaveTransportSound")||void 0}parseWeaponName(e){return e&&"none"!==e.toLowerCase()?e:void 0}parseTurretIndexes(){let r=new Map;return this.ini.getBool("Gunner")&&this.ini.entries.forEach((e,t)=>{var i=t.match(/^(.*)TurretWeapon$/i);i&&(i=i[1]+"TurretIndex",this.ini.has(i)&&r.set(Number(e),this.ini.getNumber(i)))}),r}parseBurstDelay(){let e=[];for(let t=0;t<4;++t)e.push(this.ini.has("BurstDelay"+t)?this.ini.getNumber("BurstDelay"+t):void 0);return e}hasOwner(e){return!!this.owner.length&&-1!==this.owner.indexOf(e.name)}isAvailableTo(e){return(!this.requiredHouses.length||-1!==this.requiredHouses.indexOf(e.name))&&-1===this.forbiddenHouses.indexOf(e.name)}get proneWhenAttacked(){return!this.fearless&&this.isHuman}getWeaponAtIndex(e){return this.parseWeaponName(this.ini.getString("Weapon"+(e+1)))}getEliteWeaponAtIndex(e){return this.parseWeaponName(this.ini.getString("EliteWeapon"+(e+1)))}},t("TechnoRules",b),b.MAX_SIGHT=11}}}),System.register("game/art/RotorData",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/art/ObjectArt",["engine/type/PaletteType","engine/type/ObjectType","game/Coords","game/art/SequenceReader","engine/type/LightingType","game/type/LandType","game/rules/OverlayRules","game/rules/TechnoRules","game/rules/TerrainRules","game/rules/ProjectileRules","game/art/FlhCoords","game/math/Vector2","game/math/Vector3"],function(e,t){"use strict";var i,n,r,o,s,a,l,c,h,u,d,g,p,m;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){r=e},function(e){o=e},function(e){s=e},function(e){a=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){e("ObjectArt",m=class m{constructor(e,t,i){this.sequences=new Map,this.dockingOffsets=[],this.type=e,this.rules=t,this.art=i,this.init()}static getDefaultPalette(e){switch(e){case n.ObjectType.Building:case n.ObjectType.Aircraft:case n.ObjectType.Infantry:case n.ObjectType.Vehicle:case n.ObjectType.Projectile:case n.ObjectType.VoxelAnim:return i.PaletteType.Unit;case n.ObjectType.Overlay:return i.PaletteType.Overlay;case n.ObjectType.Smudge:case n.ObjectType.Terrain:return i.PaletteType.Iso;default:n.ObjectType.Animation;return i.PaletteType.Anim}}static getDefaultLighting(e){switch(e){case n.ObjectType.Animation:return s.LightingType.None;case n.ObjectType.Aircraft:case n.ObjectType.Building:case n.ObjectType.Infantry:case n.ObjectType.Vehicle:return s.LightingType.Ambient;case n.ObjectType.Projectile:case n.ObjectType.VoxelAnim:return s.LightingType.Global;case n.ObjectType.Overlay:case n.ObjectType.Smudge:case n.ObjectType.Terrain:default:return s.LightingType.Full}}static getDefaultRemapability(e){switch(e){case n.ObjectType.Aircraft:case n.ObjectType.Building:case n.ObjectType.Infantry:case n.ObjectType.Vehicle:return!0;case n.ObjectType.Overlay:case n.ObjectType.Smudge:case n.ObjectType.Terrain:case n.ObjectType.Animation:case n.ObjectType.Projectile:case n.ObjectType.VoxelAnim:return!1;default:throw new Error("Unknown object type "+e)}}static getDefaultDrawOffset(e){switch(e){case n.ObjectType.Animation:case n.ObjectType.Building:case n.ObjectType.Vehicle:case n.ObjectType.Infantry:case n.ObjectType.Overlay:case n.ObjectType.Smudge:case n.ObjectType.Projectile:case n.ObjectType.VoxelAnim:return new g.Vector2(0,0);case n.ObjectType.Terrain:case n.ObjectType.Aircraft:return new g.Vector2(0,(r.Coords.ISO_TILE_SIZE+1)/2);default:throw new Error("Unknown object type "+e)}}static getDefaultShadow(e){switch(e){case n.ObjectType.Overlay:case n.ObjectType.Building:case n.ObjectType.Infantry:case n.ObjectType.Terrain:case n.ObjectType.Vehicle:case n.ObjectType.Aircraft:return!0;default:case n.ObjectType.Smudge:case n.ObjectType.Animation:case n.ObjectType.Projectile:case n.ObjectType.VoxelAnim:return!1}}static getDefaultHeight(e){switch(e){case n.ObjectType.Building:return 2;case n.ObjectType.Infantry:case n.ObjectType.Vehicle:case n.ObjectType.Aircraft:return 1;default:return 0}}static factory(e,t,i,r){let s=new this(e,t,r);var a;return e===n.ObjectType.Infantry&&(!(a=r.getString("Sequence"))||(a=i.getSection(a))&&(s.sequences=(new o.SequenceReader).readIni(a))),s}init(){this.image=[n.ObjectType.Infantry,n.ObjectType.Vehicle,n.ObjectType.Aircraft].includes(this.type)?"":this.art.getString("Image"),this.report=this.art.getString("Report")||void 0,this.readRotors(),this.noHva=this.art.getBool("NoHVA"),this.startSound=this.art.getString("StartSound")||void 0,this.readMuzzleFlash(),this.readPaletteAndLightingTypes(),this.readRemapability(),this.readFlatness(),this.readDockingOffsets();var e=this.art.getNumberArray("QueueingCell");this.queueingCell=e.length?new g.Vector2(e[0],e[1]):void 0,this.demandLoad=this.art.getBool("DemandLoad");var t=this.art.getBool("UseLineTrail"),i=this.art.getNumberArray("LineTrailColor"),e=this.art.getNumber("LineTrailColorDecrement",m.DEFAULT_LINE_TRAIL_DEC);t&&i.length?(this.useLineTrail=!0,this.lineTrailColor=i,this.lineTrailColorDecrement=e):this.useLineTrail=!1,this.crater=this.art.getBool("Crater"),this.forceBigCraters=this.art.getBool("ForceBigCraters"),this.scorch=this.art.getBool("Scorch"),this.height=this.art.getNumber("Height",m.getDefaultHeight(this.type)),this.isVoxel=this.art.getBool("Voxel"),this.occupyHeight=this.art.getNumber("OccupyHeight",this.height),this.type===n.ObjectType.Building?this.canHideThings=this.art.getBool("CanHideThings",!0):this.canHideThings=!1,this.canBeHidden=this.art.getBool("CanBeHidden",!0),this.addOccupy=this.readAddRemoveOccupy("AddOccupy"),this.removeOccupy=this.readAddRemoveOccupy("RemoveOccupy"),this.rotates=this.art.getBool("Rotates")}get imageName(){return(this.image||this.rules.imageName)+(this.rules.alternateArcticArt?"A":"")}get cameo(){let e=this.art.getString("Cameo")||m.MISSING_CAMEO;return e.toLowerCase()}get altCameo(){let e=this.art.getString("AltCameo")||m.MISSING_CAMEO;return e.toLowerCase()}get useTheaterExtension(){return this.art.getBool("Theater")}readPaletteAndLightingTypes(){this.paletteType=i.PaletteType.Default,this.lightingType=s.LightingType.Default,(this.rules instanceof l.OverlayRules?this.rules.noUseTileLandType:void 0)&&(this.paletteType=i.PaletteType.Iso,this.lightingType=s.LightingType.Full),this.art.getBool("TerrainPalette")||this.art.getBool("ShouldUseCellDrawer")?this.paletteType=i.PaletteType.Iso:this.art.getBool("AnimPalette")?(this.paletteType=i.PaletteType.Anim,this.lightingType=s.LightingType.None):this.art.getString("Palette")&&(this.paletteType=i.PaletteType.Custom,this.customPaletteName=this.art.getString("Palette")),this.art.getBool("AltPalette")&&(this.paletteType=i.PaletteType.Unit),(this.rules instanceof l.OverlayRules||this.rules instanceof c.TechnoRules)&&this.rules.wall&&(this.paletteType=i.PaletteType.Unit,this.lightingType=s.LightingType.Ambient),(this.rules instanceof h.TerrainRules||this.rules instanceof c.TechnoRules)&&this.rules.gate&&(this.paletteType=i.PaletteType.Unit),this.rules instanceof h.TerrainRules&&this.rules.spawnsTiberium&&(this.paletteType=i.PaletteType.Unit,this.lightingType=s.LightingType.None),this.rules instanceof l.OverlayRules&&(this.rules.isVeins&&(this.paletteType=i.PaletteType.Unit,this.lightingType=s.LightingType.None),this.rules.isVeinholeMonster&&(this.paletteType=i.PaletteType.Unit,this.lightingType=s.LightingType.None),this.rules.tiberium&&(this.lightingType=s.LightingType.None),this.rules.land===a.LandType.Railroad&&(this.paletteType=i.PaletteType.Iso,this.lightingType=s.LightingType.Full),this.rules.crate&&(this.paletteType=i.PaletteType.Iso,this.lightingType=s.LightingType.Full)),this.paletteType===i.PaletteType.Default&&(this.paletteType=m.getDefaultPalette(this.type)),this.lightingType===s.LightingType.Default&&(this.lightingType=m.getDefaultLighting(this.type))}readRemapability(){this.remapable=m.getDefaultRemapability(this.type),this.art.getBool("TerrainPalette")||this.art.getBool("AnimPalette")?this.remapable=!1:this.rules instanceof u.ProjectileRules&&this.rules.firersPalette&&(this.remapable=!0)}readFlatness(){let e=!1;this.type===n.ObjectType.Building||this.type===n.ObjectType.Animation?e=this.art.getBool("Flat"):this.type===n.ObjectType.Smudge&&(e=!0),this.rules instanceof l.OverlayRules&&(this.rules.wall||this.rules.crate||this.rules.isARock||(e=!0)),this.flat=e}readRotors(){var i=this.art.getArray("Rotors");if(i.length){let e=[];for(let t=0;t<i.length;++t){var r=this.art.getNumberArray(`Rotor${t+1}Axis`,void 0,[0,1,0]),r=new p.Vector3(-r[2],-r[0],r[1]).normalize();e.push({name:i[t],axis:r,speed:this.art.getNumber(`Rotor${t+1}Rate`)||void 0,idleSpeed:this.art.getNumber(`Rotor${t+1}IdleRate`)||void 0})}e.length&&(this.rotors=e)}}readMuzzleFlash(){let e=0,t="MuzzleFlash"+e,i=[];for(;this.art.has(t);){var[r,s]=this.art.getNumberArray(t);i.push({x:r,y:s}),e++,t="MuzzleFlash"+e}this.muzzleFlash=i.length?i:void 0}readDockingOffsets(){if(this.type===n.ObjectType.Building){var t=this.rules.numberOfDocks;for(let e=0;e<t;e++){var[i,r,s]=this.art.getNumberArray("DockingOffset"+e,/\,\s*/,[0,0,0]);this.dockingOffsets.push(new p.Vector3(i,s,r))}}}readAddRemoveOccupy(e){let t=0,i=[];for(;;){var r=this.art.getNumberArray(e+ ++t);if(!r.length)break;i.push(new g.Vector2(r[0],r[1]))}return i}get bibShape(){return this.art.getString("BibShape")}get foundation(){let e=this.art.getString("Foundation","1x1");var[t,i]=e.split("x");return{width:parseInt(t,10),height:parseInt(i,10)}}get foundationCenter(){return new g.Vector2(Math.floor(this.foundation.width/2-.5),Math.floor(this.foundation.height/2-.5))}getDrawOffset(){if(this.rules instanceof h.TerrainRules&&this.rules.spawnsTiberium)return new g.Vector2(0,0);let e=m.getDefaultDrawOffset(this.type);return this.rules instanceof l.OverlayRules&&this.rules.isARock&&(e.y+=(r.Coords.ISO_TILE_SIZE+1)/2),e}get hasShadow(){return this.art.getBool("Shadow",m.getDefaultShadow(this.type))&&!this.rules.noShadow}get turretOffset(){return this.art.getNumber("TurretOffset")}get walkFrames(){return this.art.getNumber("WalkFrames")}get firingFrames(){return this.art.getNumber("FiringFrames")}get isFlamingGuy(){return this.art.getBool("IsFlamingGuy")}get runningFrames(){return this.art.getNumber("RunningFrames")}get primaryFireFlh(){return new d.FlhCoords(this.art.getNumberArray("PrimaryFireFLH"))}get elitePrimaryFireFlh(){var e=this.art.getNumberArray("ElitePrimaryFireFLH");return e.length?new d.FlhCoords(e):this.primaryFireFlh}get primaryFirePixelOffset(){return this.art.getNumberArray("PrimaryFirePixelOffset")}get secondaryFirePixelOffset(){return this.art.getNumberArray("SecondaryFirePixelOffset")}get secondaryFireFlh(){return new d.FlhCoords(this.art.getNumberArray("SecondaryFireFLH"))}get eliteSecondaryFireFlh(){var e=this.art.getNumberArray("EliteSecondaryFireFLH");return e.length?new d.FlhCoords(e):this.secondaryFireFlh}getSpecialWeaponFlh(e){return new d.FlhCoords(this.art.getNumberArray(`Weapon${e+1}FLH`))}get fireUp(){return this.art.getNumber("FireUp")||this.art.getNumber("DelayedFireDelay")}get isAnimDelayedFire(){return this.art.getBool("IsAnimDelayedFire")}get zShapePointMove(){return this.art.getNumberArray("ZShapePointMove")}get zAdjust(){return this.art.getNumber("ZAdjust")}get trailer(){return this.art.getString("Trailer")}get spawnDelay(){return this.art.getNumber("SpawnDelay",1)}get translucent(){return this.art.getBool("Translucent")}get translucency(){var e=(e=this.art.getNumber("Translucency",0))/25*25;return e/=100}}),m.DEFAULT_LINE_TRAIL_DEC=16,m.MISSING_CAMEO="xxicon"}}}),System.register("game/gameobject/Smudge",["engine/type/ObjectType","game/gameobject/GameObject"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=class extends i.GameObject{constructor(e,t,i){super(r.ObjectType.Smudge,e,t,i)}static factory(e,t,i){return new this(e,t,i)}getFoundation(){return{width:this.rules.width,height:this.rules.height}}},e("Smudge",s)}}}),System.register("game/gameobject/GameObject",["engine/type/ObjectType","game/Traits","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","util/math","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyAttack","game/gameobject/common/DeathType"],function(e,t){"use strict";var i,s,r,a,n,o,l,c,h,u,d;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("GameObject",d=class{constructor(e,t,i,r){this.traits=new s.Traits,this.cachedTraits={tick:[]},this.isCrashing=!1,this.isDestroyed=!1,this.deathType=u.DeathType.Normal,this.isDisposed=!1,this.isSpawned=!1,this.type=e,this.name=t,this.rules=i,this.art=r}get tile(){return this.position.tile}get tileElevation(){return this.position.tileElevation}getFoundation(){return{width:1,height:1}}isSmudge(){return this.type===i.ObjectType.Smudge}isOverlay(){return this.type===i.ObjectType.Overlay}isTerrain(){return this.type===i.ObjectType.Terrain}isProjectile(){return this.type===i.ObjectType.Projectile}isDebris(){return this.type===i.ObjectType.Debris}isBuilding(){return!1}isInfantry(){return!1}isVehicle(){return!1}isAircraft(){return!1}isUnit(){return!1}isTechno(){return!1}update(e){for(var t of this.cachedTraits.tick)t[r.NotifyTick.onTick](this,e)}onSpawn(t){this.isSpawned=!0,this.traits.filter(l.NotifySpawn).forEach(e=>{e[l.NotifySpawn.onSpawn](this,t)})}onUnspawn(t){this.isSpawned=!1,this.traits.filter(c.NotifyUnspawn).forEach(e=>{e[c.NotifyUnspawn.onUnspawn](this,t)})}onDestroy(t,i,r){this.traits.filter(a.NotifyDestroy).forEach(e=>{e[a.NotifyDestroy.onDestroy](this,t,i,r)})}onOwnerChange(t,i){this.traits.filter(o.NotifyOwnerChange).forEach(e=>{e[o.NotifyOwnerChange.onChange](this,t,i)})}onAttack(t,i){this.traits.filter(h.NotifyAttack).forEach(e=>{e[h.NotifyAttack.onAttack](this,i,t)})}addTrait(e){this.traits.add(e),e[r.NotifyTick.onTick]&&this.cachedTraits.tick.push(e)}getUiName(){return this.rules.uiName}getHash(){var e=this.position.worldPosition;return n.fnv32a([this.id,...new Uint8Array(new Float64Array([e.x,e.y,e.z]).buffer),...this.traits.getAll().map(e=>e.getHash?.()??0)])}debugGetState(){return{id:this.id,position:this.position.worldPosition.toArray(),traits:this.traits.getAll().reduce((e,t)=>{var i=t.debugGetState?.();return void 0!==i&&(e[t.constructor.name]=i),e},{})}}dispose(){this.isDisposed=!0,this.traits.dispose(),this.cachedTraits.tick.length=0}})}}}),System.register("game/World",["util/event"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("World",r=class{constructor(){this.allObjects=new Map,this._onObjectSpawned=new i.EventDispatcher,this._onObjectRemoved=new i.EventDispatcher}get onObjectSpawned(){return this._onObjectSpawned.asEvent()}get onObjectRemoved(){return this._onObjectRemoved.asEvent()}spawnObject(e){if(this.allObjects.has(e.id))throw new Error("Trying to add an already existing object");this.allObjects.set(e.id,e),this._onObjectSpawned.dispatch(this,e)}removeObject(e){if(!this.allObjects.has(e.id))throw new Error("Trying to remove non-existent object");this.allObjects.delete(e.id),this._onObjectRemoved.dispatch(this,e)}hasObjectId(e){return this.allObjects.has(e)}getObjectById(e){if(!this.allObjects.has(e))throw new Error(`Object with id ${e} doesn't exist`);return this.allObjects.get(e)}getAllObjects(){return[...this.allObjects.values()]}})}}}),System.register("engine/gfx/RenderableContainer",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RenderableContainer",i=class{constructor(e){this.children=new Set,this.renderQueue=[],e&&this.set3DObject(e)}set3DObject(e){this.container=e}get3DObject(){return this.container}getChildren(){return[...this.children]}add(...e){for(var t of e)this.children.has(t)||(this.children.add(t),this.renderQueue.push(t))}remove(...e){for(var t of e){var i;this.children.has(t)&&(this.children.delete(t),-1===(i=this.renderQueue.indexOf(t))?(t=t.get3DObject())&&t.parent&&this.get3DObject().remove(t):this.renderQueue.splice(i,1))}}removeAll(){this.remove(...this.children)}processRenderQueue(){if(!this.get3DObject())throw new Error("A THREE.Object3D must be passed in the constructor or using the setter.");let e;for(;e=this.renderQueue.shift();){e.create3DObject();var t=e.get3DObject();t&&this.get3DObject().add(t)}}create3DObject(){this.processRenderQueue()}update(e,t){this.renderQueue.length&&this.processRenderQueue();for(var i of this.children)this.renderQueue.length&&this.processRenderQueue(),i.update(e,t)}})}}}),System.register("engine/renderable/CameraPan",["util/math"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("CameraPan",r=class{constructor(e){this.freeCamera=e,this.pan={x:0,y:0}}setPanLimits(e){this.panLimits=e,this.setPan({x:this.pan.x,y:this.pan.y})}getPanLimits(){return{...this.panLimits}}getPan(){return{...this.pan}}setPan(e){this.panLimits&&!this.freeCamera.value&&(e.x=i.clamp(e.x,this.panLimits.x,this.panLimits.x+this.panLimits.width),e.y=i.clamp(e.y,this.panLimits.y,this.panLimits.y+this.panLimits.height)),this.pan={x:e.x,y:e.y}}})}}}),System.register("engine/renderable/CameraZoom",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CameraZoom",i=class{constructor(e){this.freeCamera=e,this.zoom=1}getZoom(){return this.zoom}applyStep(e){this.freeCamera.value&&(this.zoom=Math.max(.1,this.zoom+e))}})}}}),System.register("engine/Lighting",["engine/type/LightingType","data/map/MapLighting","util/event","util/disposable/CompositeDisposable"],function(e,t){"use strict";var l,i,r,s,a,n;t&&t.id;return{setters:[function(e){l=e},function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=new THREE.Vector3,e("Lighting",n=class{constructor(t){if(this.baseAmbient=new i.MapLighting,this.tileLights=new Map,this.disposables=new s.CompositeDisposable,this._onChange=new r.EventDispatcher,t){this.baseAmbient.copy(t.getAmbient());let e=e=>{this.baseAmbient.copy(e),this._onChange.dispatch(this,void 0)};t.onChange.subscribe(e),this.disposables.add(()=>t.onChange.unsubscribe(e))}}get onChange(){return this._onChange.asEvent()}get mapLighting(){return this.ambientOverride??this.baseAmbient}forceUpdate(e){this._onChange.dispatch(this,e)}applyAmbientOverride(e){this.ambientOverride=e,this._onChange.dispatch(this,void 0)}getBaseAmbient(){return(new i.MapLighting).copy(this.baseAmbient)}addTileLight(e,t){this.tileLights.has(e)||this.tileLights.set(e,new Set),this.tileLights.get(e).add(t)}removeTileLight(e,t){let i=this.tileLights.get(e);i&&(i.delete(t),i.size||this.tileLights.delete(e))}compute(e,t,i=0){return e===l.LightingType.None?new THREE.Vector3(1,1,1):this.computeTint(e).add(this.computeTileTint(t,e,a)).multiplyScalar(this.mapLighting.ambient+this.mapLighting.ground+this.computeLevel(e,t.z+i)+this.computeTileLightIntensity(t))}computeNoAmbient(e,t,i=0){return this.computeLevel(e,t.z+i)+this.computeTileLightIntensity(t)}computeLevel(e,t){return e>=l.LightingType.Level?this.mapLighting.level*(t-1):0}computeTint(e){let t=1,i=1,r=1;return(e>=l.LightingType.Full||this.mapLighting.forceTint)&&(t=this.mapLighting.red,i=this.mapLighting.green,r=this.mapLighting.blue),new THREE.Vector3(t,i,r)}computeTileTint(e,t,i=new THREE.Vector3){let r=0,s=0,a=0;if(t>=l.LightingType.Full){var n=this.tileLights.get(e);if(n?.size)for(var o of n)r+=o.red,s+=o.green,a+=o.blue}return i.set(r,s,a)}computeTileLightIntensity(e){let t=0;var i=this.tileLights.get(e);if(i?.size)for(var r of i)t+=r.intensity;return t}getAmbientIntensity(){return this.mapLighting.ambient+this.mapLighting.ground}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/unit/ShadowQuality",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Off=0]="Off",e[e.Low=1]="Low",e[e.Medium=2]="Medium",e[e.High=3]="High",t("ShadowQuality",i)}}}),System.register("engine/gfx/batch/BatchedMesh",[],function(t,e){"use strict";var r,i;e&&e.id;return{setters:[],execute:function(){var e;(e=r=r||{})[e.Instancing=0]="Instancing",e[e.Merging=1]="Merging",t("BatchMode",r),i=class extends THREE.Mesh{constructor(e,t,i=r.Instancing){super(e,t),this.geometry=e,this.material=t,this.batchMode=i,this.isBatchedMesh=!0,this.castShadow=!1,this.opacity=1,this.extraLight=new THREE.Vector3(0,0,0),this.paletteIndex=0,this.clippingPlanes=[],this.clippingPlanesHash="",this.layers.disable(0)}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e}getExtraLight(){return this.extraLight}setExtraLight(e){this.extraLight=e}getPaletteIndex(){return this.paletteIndex}setPaletteIndex(e){this.paletteIndex=e}getClippingPlanes(){return this.clippingPlanes}setClippingPlanes(e){this.clippingPlanes=e,this.updateClippingPlanesHash(e)}updateClippingPlanesHash(e){this.clippingPlanesHash=e.map(e=>[...e.normal.toArray(),e.constant]).flat().join(",")}getClippingPlanesHash(){return this.clippingPlanesHash}},t("BatchedMesh",i)}}}),System.register("engine/gfx/material/paletteShaderLib",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("paletteShaderLib",{uniforms:{palette:{type:"t",value:null},paletteOffsetCount:{value:[0,1]},extraLight:{value:new THREE.Vector3(0,0,0)}},instanceParsVertex:`
#ifdef INSTANCE_TRANSFORM
    attribute float instancePaletteOffset;
    varying float vInstancePaletteOffset;
    attribute vec3 instanceExtraLight;
    varying vec3 vInstanceExtraLight;
#endif
`,instanceVertex:`
  #ifdef INSTANCE_TRANSFORM
    vInstancePaletteOffset = instancePaletteOffset;
    vInstanceExtraLight = instanceExtraLight;
  #endif
`,paletteColorParsVertex:`
#ifdef VERTEX_PALETTE_OFFSET
    attribute float vertexPaletteOffset;
    varying float vVertexPaletteOffset;
#endif
`,paletteColorVertex:`
  #ifdef VERTEX_PALETTE_OFFSET
    vVertexPaletteOffset = vertexPaletteOffset;
  #endif
`,paletteColorParsFrag:`
uniform sampler2D palette;
#ifdef VERTEX_PALETTE_OFFSET
    varying float vVertexPaletteOffset;
#endif
uniform vec2 paletteOffsetCount;
uniform vec3 extraLight;

#ifdef INSTANCE_TRANSFORM
varying float vInstancePaletteOffset;
varying vec3 vInstanceExtraLight;
#endif
`,paletteColorFrag:`
  float paletteColorIndex;

  #ifdef USE_MAP
  paletteColorIndex = texelColor.a;
  #endif

  #ifdef USE_COLOR
  paletteColorIndex = vColor.r;
  #endif

  #ifdef INSTANCE_TRANSFORM
  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vInstancePaletteOffset + 0.5) / paletteOffsetCount.y));
  #elif defined(VERTEX_PALETTE_OFFSET)
  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vVertexPaletteOffset + 0.5) / paletteOffsetCount.y));
  #else
  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (paletteOffsetCount.x + 0.5) / paletteOffsetCount.y));
  #endif

  #ifdef INSTANCE_OPACITY
  diffuseColor.a *= vInstanceOpacity * opacity;
  #else
  diffuseColor.a *= opacity;
  #endif
  diffuseColor = clamp(diffuseColor, 0.0, 1.0);
`,paletteBasicLightFragment:`
  #ifdef INSTANCE_TRANSFORM
  diffuseColor.rgb += vInstanceExtraLight.rgb * diffuseColor.rgb;
  #else
  diffuseColor.rgb += extraLight.rgb * diffuseColor.rgb;
  #endif

  diffuseColor = clamp(diffuseColor, 0.0, 1.0);
`,paletteFullLightFragment:`
  #ifdef INSTANCE_TRANSFORM
  vec3 extraIrradiance = vInstanceExtraLight.rgb;
  #else
  vec3 extraIrradiance = extraLight.rgb;
  #endif

  #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
    #pragma unroll_loop
    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
      directionalLight = directionalLights[ i ];
      getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );

      directLight.color = extraIrradiance;
      RE_Direct( directLight, geometry, material, reflectedLight );
    }
  #endif

  #if defined( RE_IndirectDiffuse )
  RE_IndirectDiffuse( extraIrradiance, geometry, material, reflectedLight );
  #endif
`,vertexColorMultParsVertex:`
#ifdef USE_VERTEX_COLOR_MULT
attribute vec4 vertexColorMult;
varying vec4 vVertexColorMult;
#endif
`,vertexColorMultVertex:`
  #ifdef USE_VERTEX_COLOR_MULT
  vVertexColorMult = vertexColorMult;
  #endif
`,vertexColorMultParsFrag:`
#ifdef USE_VERTEX_COLOR_MULT
varying vec4 vVertexColorMult;
#endif
`,vertexColorMultFrag:`
  #ifdef USE_VERTEX_COLOR_MULT
  diffuseColor.rgba *= vVertexColorMult.rgba;
  #endif
`})}}}),System.register("engine/gfx/material/PalettePhongMaterial",["engine/gfx/material/paletteShaderLib"],function(e,t){"use strict";var i,a,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){a={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,i.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshphong_vert.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+i.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshphong_frag.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+i.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+i.paletteShaderLib.paletteFullLightFragment)},r=class extends THREE.MeshPhongMaterial{constructor({palette:e,paletteCount:t,paletteOffset:i,extraLight:r,...s}={}){super(s),this.uniforms=THREE.UniformsUtils.clone(a.uniforms),e&&(this.palette=e),t&&(this.paletteCount=t),i&&(this.paletteOffset=i),r&&this.extraLight.copy(r),this.vertexShader=a.vertexShader,this.fragmentShader=a.fragmentShader,this.type="PalettePhongMaterial"}get palette(){return this.uniforms.palette.value}set palette(e){this.uniforms.palette.value=e}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(e){this.uniforms.paletteOffsetCount.value[0]=e}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(e){this.uniforms.paletteOffsetCount.value[1]=e}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(e){this.uniforms.extraLight.value=e}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.palette=e.palette,this}},e("PalettePhongMaterial",r)}}}),System.register("engine/gfx/batch/InstancedMesh",[],function(e,t){"use strict";var a,i,r,n,s;t&&t.id;return{setters:[],execute:function(){(a=new THREE.MeshDepthMaterial).depthPacking=THREE.RGBADepthPacking,a.clipping=!0,a.defines={INSTANCE_TRANSFORM:""},s=THREE.ShaderLib.distanceRGBA,i=THREE.UniformsUtils.clone(s.uniforms),r={USE_SHADOWMAP:"",INSTANCE_TRANSFORM:""},n=new THREE.ShaderMaterial({defines:r,uniforms:i,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,clipping:!0}),s=class extends THREE.Mesh{constructor(e,t,i,r,s=!1){super((new THREE.InstancedBufferGeometry).copy(e)),this.maxInstances=i,this.uniformScale=r,this.useInstanceColor=s,this.initAttributes(this.geometry),this.material=this.decorateMaterial(t.clone()),this.frustumCulled=!1,this.customDepthMaterial=a,this.customDistanceMaterial=n}initAttributes(i){let e=[];for(let n=0;n<4;n++)e.push({name:"instanceMatrix"+n,data:new Float32Array(4*this.maxInstances),itemSize:4,normalized:!0});this.useInstanceColor&&e.push({name:"instanceColor",data:new Uint8Array(3*this.maxInstances),itemSize:3,normalized:!0}),e.push({name:"instanceOpacity",data:new Float32Array(this.maxInstances).fill(1),itemSize:1,normalized:!0});for(var{name:t,data:r,itemSize:s,normalized:a}of e){let e=new THREE.InstancedBufferAttribute(r,s,a,1);e.dynamic=!0,i.addAttribute(t,e)}this.instanceMatrixAttributes=new Array(4).fill(0).map((e,t)=>i.getAttribute("instanceMatrix"+t))}decorateMaterial(e){let t=e;return t.defines??(t.defines={}),t.defines.INSTANCE_TRANSFORM="",this.uniformScale?t.defines.INSTANCE_UNIFORM="":delete t.defines.INSTANCE_UNIFORM,this.useInstanceColor?t.defines.INSTANCE_COLOR="":delete t.defines.INSTANCE_COLOR,t.defines.INSTANCE_OPACITY="",e}setRenderCount(e){if(e>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");this.geometry.maxInstancedCount=e}setMatrixAt(e,t){for(let r=0;r<4;r++){var i=4*r;this.instanceMatrixAttributes[r].setXYZW(e,t.elements[i++],t.elements[i++],t.elements[i++],t.elements[+i])}}updateFromMeshes(t){var e,i=!!t[0].material.palette,r=this.geometry.attributes;let s=r.instanceOpacity,a=r.instancePaletteOffset,n=r.instanceExtraLight;for(let h=0,u=t.length;h<u;h++){let e=t[h];this.setMatrixAt(h,e.matrixWorld);var o,l,c=e.getOpacity();s.getX(h)!==c&&(s.setX(h,c),s.needsUpdate=!0),i&&(o=e.getPaletteIndex(),a.getX(h)!==o&&(a.setX(h,o),a.needsUpdate=!0),l=e.getExtraLight(),c=Math.fround(l.x),o=Math.fround(l.y),l=Math.fround(l.z),c===n.getX(h)&&o===n.getY(h)&&l===n.getZ(h)||(n.setXYZ(h,c,o,l),n.needsUpdate=!0))}this.setRenderCount(t.length);for(e of this.instanceMatrixAttributes)e.needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},e("InstancedMesh",s)}}}),System.register("engine/gfx/batch/MeshInstancingBatch",["engine/gfx/batch/InstancedMesh"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("MeshInstancingBatch",r=class{constructor(e){this.maxInstances=e,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e,this.instancedMesh&&(this.instancedMesh.castShadow=e)}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e,this.instancedMesh&&(this.instancedMesh.receiveShadow=e)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(e){this._clippingPlanes=e,this.instancedMesh&&(this.instancedMesh.material.clippingPlanes=e)}get renderOrder(){return this._renderOrder}set renderOrder(e){this._renderOrder=e,this.instancedMesh&&(this.instancedMesh.renderOrder=e)}get3DObject(){return this.target}create3DObject(){if(!this.target){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,this.target=e,this.instancedMesh&&e.add(this.instancedMesh)}}setMeshes(e){if(e.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");var t;e.length?(t=!!e[0].material.palette,this.instancedMesh||(this.instancedMesh=new i.InstancedMesh(e[0].geometry,e[0].material,this.maxInstances,!0),this.instancedMesh.castShadow=this._castShadow,this.instancedMesh.renderOrder=this._renderOrder,this.instancedMesh.material.clippingPlanes=this._clippingPlanes,t&&(this.instancedMesh.geometry.addAttribute("instancePaletteOffset",new THREE.InstancedBufferAttribute(new Float32Array(this.maxInstances),1)),this.instancedMesh.geometry.addAttribute("instanceExtraLight",new THREE.InstancedBufferAttribute(new Float32Array(3*this.maxInstances),3))),this.target?.add(this.instancedMesh)),this.instancedMesh.updateFromMeshes(e)):this.instancedMesh&&(this.target?.remove(this.instancedMesh),this.instancedMesh.dispose(),this.instancedMesh=void 0)}update(){}dispose(){this.instancedMesh?.dispose()}})}}}),System.register("engine/gfx/material/PaletteBasicMaterial",["engine/gfx/material/paletteShaderLib"],function(e,t){"use strict";var i,n,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){n={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,i.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshbasic_vert.replace("#include <common>","#include <common>\n"+[i.paletteShaderLib.instanceParsVertex,i.paletteShaderLib.paletteColorParsVertex,i.paletteShaderLib.vertexColorMultParsVertex].join("\n")).replace("void main() {","void main() {\n"+[i.paletteShaderLib.instanceVertex,i.paletteShaderLib.paletteColorVertex,i.paletteShaderLib.vertexColorMultVertex].join("\n")),fragmentShader:THREE.ShaderChunk.meshbasic_frag.replace("#include <common>","#include <common>\n"+[i.paletteShaderLib.paletteColorParsFrag,i.paletteShaderLib.vertexColorMultParsFrag].join("\n")).replace("#include <color_fragment>","#include <color_fragment>\n"+[i.paletteShaderLib.paletteColorFrag,i.paletteShaderLib.paletteBasicLightFragment,i.paletteShaderLib.vertexColorMultFrag].join("\n"))},r=class extends THREE.MeshBasicMaterial{constructor({palette:e,paletteCount:t,paletteOffset:i,extraLight:r,useVertexColorMult:s,...a}={}){super(a),this.uniforms=THREE.UniformsUtils.clone(n.uniforms),e&&(this.palette=e),t&&(this.paletteCount=t),i&&(this.paletteOffset=i),r&&this.extraLight.copy(r),s&&(this.useVertexColorMult=s),this.vertexShader=n.vertexShader,this.fragmentShader=n.fragmentShader,this.type="PaletteBasicMaterial"}get palette(){return this.uniforms.palette.value}set palette(e){this.uniforms.palette.value=e}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(e){this.uniforms.paletteOffsetCount.value[0]=e}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(e){this.uniforms.paletteOffsetCount.value[1]=e}get extraLight(){return this.uniforms.extraLight.value}set extraLight(e){this.uniforms.extraLight.value=e}set useVertexColorMult(e){e?(this.defines??(this.defines={}),this.defines.USE_VERTEX_COLOR_MULT=""):this.defines&&delete this.defines.USE_VERTEX_COLOR_MULT}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.palette=e.palette,this}},e("PaletteBasicMaterial",r)}}}),System.register("engine/gfx/batch/MergedSpriteMesh",["util/array","engine/gfx/material/PaletteBasicMaterial"],function(e,t){"use strict";var p,l,u,d,r;t&&t.id;return{setters:[function(e){p=e},function(e){l=e}],execute:function(){u=new THREE.Vector3,d=new THREE.Vector4,r=class r extends THREE.Mesh{constructor(e,t,i){super(r.createMergedGeometry(e,i,t)),this.maxInstances=i,this.material=this.decorateMaterial(t.clone()),this.verticesPerItem=e.getAttribute("position").count,this.indicesPerItem=e.index?.count,this.frustumCulled=!1}static createMergedGeometry(i,t,e){let r=new THREE.BufferGeometry;for(var s of Object.keys(i.attributes)){let e=i.getAttribute(s);var a=new e.array.constructor(t*e.array.length);r.addAttribute(s,new THREE.BufferAttribute(a,e.itemSize,e.normalized))}var n,o=i.getAttribute("position").count;e instanceof l.PaletteBasicMaterial&&r.addAttribute("vertexColorMult",new THREE.BufferAttribute(new Float32Array(o*t*4),4)),e.palette&&r.addAttribute("vertexPaletteOffset",new THREE.BufferAttribute(new Float32Array(o*t),1));for(n of Object.values(r.attributes))n.setDynamic(!0);if(i.index){r.setIndex(new THREE.BufferAttribute(new Uint32Array(t*i.index.array.length),1));for(let e=0;e<t;e++){let t=e*o;r.index.array.set(Uint32Array.from(i.index.array,e=>e+t),e*i.index.array.length)}}return r}decorateMaterial(e){let t=e;return t.defines??(t.defines={}),e.palette&&(t.defines.VERTEX_PALETTE_OFFSET=""),e instanceof l.PaletteBasicMaterial&&(t.useVertexColorMult=!0),e}updateFromMeshes(t){var e,i=this.geometry.attributes,r=i.position,s=i.uv,a=i.vertexColorMult,n=i.vertexPaletteOffset,o=t.length;if(o>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");for(let h=0;h<o;h++){var l=h*this.verticesPerItem;let e=t[h];this.setGeometryAt(l,e.geometry,u.setFromMatrixPosition(e.matrixWorld),r,s);var c=e.getExtraLight();a&&this.setColorMultAt(l,d.set(1+c.x,1+c.y,1+c.z,e.getOpacity()),a),n&&this.setPaletteIndexAt(l,e.getPaletteIndex(),n)}this.geometry.setDrawRange(0,o*(this.geometry.index?this.indicesPerItem:this.verticesPerItem));for(e of Object.values(i))e.dynamic&&(e.updateRange.count=o<this.maxInstances?o*this.verticesPerItem*e.itemSize:-1)}setGeometryAt(e,t,i,r,s){var a=t.attributes,n=a.position.array;let o=r.array;for(let g=0;g<this.verticesPerItem;g++){var l=3*(e+g),c=Math.fround(n[3*g]+Math.fround(i.x)),h=Math.fround(n[3*g+1]+Math.fround(i.y)),u=Math.fround(n[3*g+2]+Math.fround(i.z));c===o[l]&&h===o[1+l]&&u===o[2+l]||(o[l]=c,o[1+l]=h,o[2+l]=u,r.needsUpdate=!0)}let d=s.array;a=a.uv.array;p.equals(a,d.subarray(2*e,2*e+a.length))||(d.set(a,2*e),s.needsUpdate=!0)}setColorMultAt(t,i,r){if(r.getX(t)!==i.x||r.getY(t)!==i.y||r.getZ(t)!==i.z||r.getW(t)!==i.w){r.needsUpdate=!0;for(let e=0;e<this.verticesPerItem;e++)r.setXYZW(t+e,i.x,i.y,i.z,i.w)}}setPaletteIndexAt(t,i,r){if(r.getX(t)!==i){r.needsUpdate=!0;for(let e=0;e<this.verticesPerItem;e++)r.setX(t+e,i)}}dispose(){this.geometry.dispose(),this.material.dispose()}},e("MergedSpriteMesh",r)}}}),System.register("engine/gfx/batch/MeshMergingBatch",["engine/gfx/batch/MergedSpriteMesh"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("MeshMergingBatch",r=class{constructor(e){this.maxInstances=e,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e,this.mergedGeoMesh&&(this.mergedGeoMesh.castShadow=e)}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e,this.mergedGeoMesh&&(this.mergedGeoMesh.receiveShadow=e)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(e){this._clippingPlanes=e,this.mergedGeoMesh&&(this.mergedGeoMesh.material.clippingPlanes=e)}get renderOrder(){return this._renderOrder}set renderOrder(e){this._renderOrder=e,this.mergedGeoMesh&&(this.mergedGeoMesh.renderOrder=e)}get3DObject(){return this.target}create3DObject(){if(!this.target){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,this.target=e,this.mergedGeoMesh&&e.add(this.mergedGeoMesh)}}setMeshes(e){if(e.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");e.length?(this.mergedGeoMesh||(this.mergedGeoMesh=new i.MergedSpriteMesh(e[0].geometry,e[0].material,this.maxInstances),this.mergedGeoMesh.castShadow=this._castShadow,this.mergedGeoMesh.receiveShadow=this._receiveShadow,this.mergedGeoMesh.renderOrder=this._renderOrder,this.mergedGeoMesh.material.clippingPlanes=this._clippingPlanes,this.target?.add(this.mergedGeoMesh)),this.mergedGeoMesh.updateFromMeshes(e)):this.mergedGeoMesh&&(this.target?.remove(this.mergedGeoMesh),this.mergedGeoMesh.dispose(),this.mergedGeoMesh=void 0)}update(){}dispose(){this.mergedGeoMesh?.dispose()}})}}}),System.register("engine/gfx/batch/MeshBatchManager",["engine/gfx/batch/BatchedMesh","engine/gfx/batch/MeshInstancingBatch","engine/gfx/RenderableContainer","engine/gfx/batch/MeshMergingBatch"],function(e,t){"use strict";var l,c,i,h,r;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){i=e},function(e){h=e}],execute:function(){r=class extends i.RenderableContainer{constructor(e){super(),this.renderableContainer=e,this.batches=new Map}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="mesh_batch_manager",e.matrixAutoUpdate=!1,this.set3DObject(e)),super.create3DObject()}updateMeshes(){var e=this.renderableContainer.get3DObject();e&&(e=this.collectMeshes(e),e=this.fillBatches(this.groupMeshesByBatchKey(e)),this.cleanUnusedBatches(e))}collectMeshes(e){let t=[];return e.traverseVisible(e=>{e.isBatchedMesh&&t.push(e)}),t}fillBatches(e){let t=new Map([...this.batches.keys()].map(e=>[e,0]));for(var[s,a]of e){let i=this.batches.get(s),r=0;for(;a.length;){var n=a[0].batchMode===l.BatchMode.Instancing,o=n?1024:128;let e=a.splice(0,o),t=i?.[r];t||(i||(i=[],this.batches.set(s,i)),t=new(n?c.MeshInstancingBatch:h.MeshMergingBatch)(o),t.castShadow=e[0].castShadow,t.receiveShadow=e[0].receiveShadow,t.renderOrder=e[0].renderOrder,t.clippingPlanes=e[0].getClippingPlanes(),i.push(t),this.add(t),this.processRenderQueue()),t.setMeshes(e),r++}t.set(s,r)}return t}cleanUnusedBatches(e){for(var[t,i]of e){let e=this.batches.get(t);if(e){var r;for(r of e.splice(i))this.remove(r),r.dispose();e.length||this.batches.delete(t)}}}groupMeshesByBatchKey(t){let i=new Map;for(let a=0,e=t.length;a<e;a++){var r=t[a],s=this.getBatchKey(r);let e=i.get(s);e||(e=[],i.set(s,e)),e.push(r)}return i}getBatchKey(e){return e.batchMode+"_"+(e.batchMode===l.BatchMode.Instancing?e.geometry.uuid:e.geometry.attributes.position.count)+"_"+e.material.uuid+"_"+Number(e.castShadow)+"_"+e.renderOrder+"_"+Number(e.receiveShadow)+"_"+e.getClippingPlanesHash()}dispose(){this.batches.forEach(e=>e.forEach(e=>e.dispose()))}},e("MeshBatchManager",r)}}}),System.register("engine/renderable/WorldScene",["util/geometry","engine/gfx/RenderableContainer","engine/renderable/CameraPan","engine/renderable/CameraZoom","engine/type/LightingType","game/Coords","util/event","engine/renderable/entity/unit/ShadowQuality","engine/gfx/batch/MeshBatchManager"],function(e,t){"use strict";var s,i,o,l,r,a,n,c,h,u,d,g,p;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){o=e},function(e){l=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){c=e},function(e){h=e}],execute:function(){u=.8,d=16e3,g=new Map([[c.ShadowQuality.High,8],[c.ShadowQuality.Medium,4],[c.ShadowQuality.Low,2]]),p=class p extends i.RenderableContainer{constructor(e,t,i,r,s,a){super(e),this.scene=e,this.camera=t,this.viewport=i,this.cameraPan=r,this.cameraZoom=s,this.shadowQuality=a,this.initialized=!1,this.ambientLight=new THREE.AmbientLight(16777215,u),this.directionalLight=new THREE.DirectionalLight(16777215,1),this._onBeforeCameraUpdate=new n.EventDispatcher,this._onCameraUpdate=new n.EventDispatcher}get onBeforeCameraUpdate(){return this._onBeforeCameraUpdate.asEvent()}get onCameraUpdate(){return this._onCameraUpdate.asEvent()}static factory(e,t,i){let r=new THREE.Scene;r.matrixAutoUpdate=!1;var s=p.createCamera(e),a=new o.CameraPan(t),n=new l.CameraZoom(t);return new p(r,s,e,a,n,i)}static getCameraParams(e){var t=a.Coords.ISO_CAMERA_ALPHA,i=a.Coords.ISO_CAMERA_BETA,r=a.Coords.ISO_WORLD_SCALE;return{alpha:t,beta:i,d:e.height/2*a.Coords.COS_ISO_CAMERA_BETA*r,aspect:e.width/e.height,far:d*r}}static createCamera(e){var{alpha:t,beta:i,d:r,aspect:s,far:a}=this.getCameraParams(e);let n=new THREE.OrthographicCamera(-r*s,r*s,r,-r,0,a);return n.rotation.order="YXZ",n.rotation.y=+i,n.rotation.x=-t,n}updateViewport(e){this.viewport=e;var{d:t,aspect:i}=p.getCameraParams(e);let r=this.camera;r.left=-t*i,r.right=t*i,r.top=t,r.bottom=-t,r.updateProjectionMatrix()}updateCamera(e,t){let i=this.camera;i.updateMatrix();var r=i.matrix.elements;let s=new THREE.Vector3;i.position.set(0,0,0),i.translateZ(d*a.Coords.ISO_WORLD_SCALE),s.set(r[0],r[1],r[2]),s.multiplyScalar(e.x*(i.right-i.left)/this.viewport.width/i.zoom),i.position.add(s),s.set(r[4],r[5],r[6]),s.multiplyScalar(-e.y*(i.top-i.bottom)/this.viewport.height/i.zoom),i.position.add(s),i.zoom=t,i.updateProjectionMatrix(),i.updateMatrixWorld(!1)}create3DObject(){if(super.create3DObject(),!this.initialized){this.initialized=!0,this.scene.position.x-=.1*a.Coords.ISO_WORLD_SCALE,this.scene.position.z-=.1*a.Coords.ISO_WORLD_SCALE,this.scene.updateMatrix();var t=new THREE.AxesHelper(a.Coords.LEPTONS_PER_TILE);this.scene.add(t),this.scene.add(this.ambientLight);let e=this.directionalLight;e.position.set(-87.012,204.338,195.409),this.lightFocusPoint&&(e.position.x+=this.lightFocusPoint.x,e.position.z+=this.lightFocusPoint.y,e.target.position.set(this.lightFocusPoint.x,0,this.lightFocusPoint.y),e.target.updateMatrixWorld(void 0)),this.updateShadowQuality(e,this.shadowQuality.value),this.shadowQualityListener=()=>this.updateShadowQuality(e,this.shadowQuality.value),this.shadowQuality.onChange.subscribe(this.shadowQualityListener),this.scene.add(e),this.scene.add(this.camera);t=this.meshBatchManager=new h.MeshBatchManager(this);this.add(t),this.scene.autoUpdate=!1}}updateShadowQuality(t,i){var r=i!==c.ShadowQuality.Off;if(t.castShadow=r){var s=a.Coords.ISO_WORLD_SCALE,r=3500*s;let e=t.shadow.camera;e.right=r,e.left=-r,e.top=r,e.bottom=-r,e.near=-4e3*s,e.far=3e3*s;s=g.get(i);if(!s)throw new Error(`Unsupported shadow quality "${i}"`);t.shadow.mapSize.width=1024*s,t.shadow.mapSize.height=1024*s}}setLightFocusPoint(e,t){this.lightFocusPoint={x:e,y:t}}applyLighting(e){var t=e.computeTint(r.LightingType.Ambient);this.ambientLight.color.setRGB(t.x,t.y,t.z),this.directionalLight.color.setRGB(t.x,t.y,t.z);t=e.getAmbientIntensity();this.ambientLight.intensity=t*u,this.directionalLight.intensity=t}update(e,t){super.update(e,t),this._onBeforeCameraUpdate.dispatch(this,e);var i=this.cameraZoom.getZoom(),r=this.cameraPan.getPan();s.pointEquals(r,this.lastCameraPan)&&this.lastCameraZoom===i||(this.updateCamera(r,i),this.lastCameraZoom=i,this.lastCameraPan=r),this._onCameraUpdate.dispatch(this,e),this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes()}dispose(){this.shadowQualityListener&&(this.shadowQuality.onChange.unsubscribe(this.shadowQualityListener),this.shadowQualityListener=void 0),this.directionalLight.shadow.map?.dispose(),this.meshBatchManager&&(this.meshBatchManager.dispose(),this.remove(this.meshBatchManager),this.meshBatchManager=void 0),this.scene.remove(this.ambientLight),this.scene.remove(this.directionalLight)}},e("WorldScene",p)}}}),System.register("engine/gfx/FrustumCuller",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("FrustumCuller",i=class{cull(e,t){var i=[];return function e(t,i,r,s=0){let a=t.children,n;var o,l=t.visible;if(i.intersectsBox(t.box)){if(t.visible=!0,null!==a)for(n=0,o=a.length;n<o;++n)a[n].isOctree?e(a[n],i,r,s+1):!l&&t.config.skipInvisMatrixUpdate&&a[n].updateMatrixWorld(!1);r.push(t)}else t.visible=!1}(e,t,i),i}})}}}),System.register("engine/gfx/OctreeContainer",["engine/gfx/RenderableContainer","engine/gfx/FrustumCuller","game/Coords"],function(e,t){"use strict";var i,a,r,s,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){a=e},function(e){r=e}],execute:function(){n=3,o=class o extends i.RenderableContainer{constructor(e,t,i){super(e),this.autoCull=!0,this.lastCameraPosition=new THREE.Vector3,this.tree=e,this.frustumCuller=t,this.camera=i}static factory(e){var{near:t,far:i}=e,r=new THREE.Box3(new THREE.Vector3(2*t,2*t,2*t),new THREE.Vector3(2*i,2*i,2*i));let s=new Octree(r,{maxDepth:Math.ceil(Math.log2(2*(i-t)/128)),splitThreshold:10,joinThreshold:5,skipInvisMatrixUpdate:!0});s.name="octree";t=new a.FrustumCuller;return new o(s,t,e)}update(e,t){super.update(e,t),this.autoCull&&this.cullChildren()}cullChildren(){if(!this.camera.position.equals(this.lastCameraPosition)){this.lastCameraPosition.copy(this.camera.position);var t=this.computeProjectionMatrix();this.camera.updateMatrixWorld(!1),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld);t=(new THREE.Matrix4).multiplyMatrices(t,this.camera.matrixWorldInverse);let e=new THREE.Frustum;e.setFromMatrix(t),this.frustumCuller.cull(this.tree,e)}}computeProjectionMatrix(){return s?s.copy(this.camera):s=this.camera.clone(),s.top+=n*r.Coords.LEPTONS_PER_TILE*r.Coords.COS_ISO_CAMERA_BETA,s.bottom-=n*r.Coords.LEPTONS_PER_TILE*r.Coords.COS_ISO_CAMERA_BETA,s.left-=n*(2*r.Coords.LEPTONS_PER_TILE)*r.Coords.COS_ISO_CAMERA_BETA,s.right+=n*(2*r.Coords.LEPTONS_PER_TILE)*r.Coords.COS_ISO_CAMERA_BETA,s.updateProjectionMatrix(),s.projectionMatrix}updateChild(e){var t=e.get3DObject();t&&t.parent&&this.tree.updateObject(t)}},e("OctreeContainer",o)}}}),System.register("engine/renderable/Entity",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gfx/CanvasUtils",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CanvasUtils",i=class{static canvasFromRgbImageData(e,t,i){let r=document.createElement("canvas"),s=r.getContext("2d");if(!s)throw new Error("Couldn't acquire canvas 2d context");let a=s.createImageData(t,i);r.width=t,r.height=i;let n=0;for(let o=0,l=e.length;o<l;o+=3)a.data[n]=e[o],a.data[n+1]=e[o+1],a.data[n+2]=e[o+2],a.data[n+3]=255,n+=4;return s.putImageData(a,0,0),r}static canvasFromRgbaImageData(e,t,i){let r=document.createElement("canvas"),s=r.getContext("2d");if(!s)throw new Error("Couldn't acquire canvas 2d context");let a=s.createImageData(t,i);r.width=t,r.height=i;let n=0;for(let o=0,l=e.length;o<l;o+=4)a.data[n]=e[o],a.data[n+1]=e[o+1],a.data[n+2]=e[o+2],a.data[n+3]=e[o+3],n+=4;return s.putImageData(a,0,0),r}static canvasFromIndexedImageData(e,t,i,s){let r=document.createElement("canvas"),a=r.getContext("2d");if(!a)throw new Error("Couldn't acquire canvas 2d context");let n=a.createImageData(t,i);r.width=t,r.height=i;let o=0;return e.forEach(e=>{var{r:t,g:i,b:r}=s.getColor(e);n.data[o++]=t,n.data[o++]=i,n.data[o++]=r,n.data[o++]=e?255:0}),a.putImageData(n,0,0),r}static async canvasToBlob(r){return await new Promise((t,i)=>{r.toBlob(e=>{if(!e)try{e=this.dataUrlToBlob(r.toDataURL())}catch(e){return void i(new Error("Failed to generate image from canvas using fallback",{cause:e}))}t(e)})})}static dataUrlToBlob(e){var t=e.match(/^data:((.*?)(;charset=.*?)?)(;base64)?,/);if(!t)throw new Error("invalid dataURI");var i=t[2]?t[1]:"text/plain"+(t[3]||";charset=utf-8"),r=!!t[4],t=e.slice(t[0].length);let s=(r?atob:decodeURIComponent)(t),a=[];for(let n=0;n<s.length;n++)a.push(s.charCodeAt(n));return new Blob([new Uint8Array(a)],{type:i})}static drawText(e,t,i=0,r=0,{color:s="white",backgroundColor:a,outlineColor:n,outlineWidth:o,fontSize:l,fontFamily:c="Arial, sans-serif",fontWeight:h="normal",borderColor:u,borderWidth:d=0,paddingTop:g=0,paddingBottom:p=0,paddingLeft:m=0,paddingRight:f=0,textAlign:y="left",width:T,height:v,autoEnlargeCanvas:b=!1}){var S=h+` ${l}px `+c;e.font=S;var w=e.measureText(t),C=e.measureText("A"),E=C.actualBoundingBoxAscent+C.actualBoundingBoxDescent,x=Math.ceil(Math.max(w.width,Math.abs(w.actualBoundingBoxLeft)+Math.abs(w.actualBoundingBoxRight))),O=x+2*d+m+f,O={x:"right"===y&&void 0===T?e.canvas.width-O:i,y:r,width:T??O,height:v??E+2*d+g+p};b&&(O.x+O.width>e.canvas.width||O.y+O.height>e.canvas.height)&&(E=0<e.canvas.width+e.canvas.height?e.getImageData(0,0,e.canvas.width,e.canvas.height):void 0,O.x+O.width>e.canvas.width&&(e.canvas.width=O.x+O.width),O.y+O.height>e.canvas.height&&(e.canvas.height=O.y+O.height),E&&e.putImageData(E,0,0)),a&&(e.fillStyle=a,e.fillRect(O.x,O.y,O.width,O.height)),u&&(e.strokeStyle=u,e.lineWidth=1,e.strokeRect(.5+O.x,.5+O.y,O.width-1,O.height-1)),e.fillStyle=s,e.font=S;let A=d+m;"right"===y?A=O.width-d-f-x:"center"===y&&(A+=Math.floor((O.width-2*d-m-f-x)/2));w=w.actualBoundingBoxAscent+g+(C.actualBoundingBoxAscent-w.actualBoundingBoxAscent);return n&&(e.strokeStyle=n,e.lineWidth=2*(o??1),e.strokeText(t,O.x+A+.5,O.y+w,O.width)),e.fillText(t,O.x+A+.5,O.y+w,O.width),O}})}}}),System.register("engine/gfx/drawable/PalDrawable",["data/Bitmap"],function(e,t){"use strict";var n,i;t&&t.id;return{setters:[function(e){n=e}],execute:function(){e("PalDrawable",i=class{constructor(e){this.pal=e}draw(){var e=this.pal.size;let t=new n.RgbaBitmap(e,1),i=0;for(let s=0,a=e;s<a;++s){var r=this.pal.getColor(s);t.data[i]=r.r,t.data[i+1]=r.g,t.data[i+2]=r.b,t.data[i+3]=s?255:0,i+=4}return t}})}}}),System.register("engine/gfx/TextureUtils",["data/Bitmap","util/math","engine/gfx/CanvasUtils","engine/gfx/drawable/PalDrawable"],function(e,t){"use strict";var n,o,r,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){r=e},function(e){l=e}],execute:function(){e("TextureUtils",c=class c{static textureFromPalette(e){var t=e.hash,i=c.cache.get(t);if(i)return i;i=new l.PalDrawable(e).draw(),i=this.textureFromPalBitmap(i);return c.cache.set(t,i),i}static textureFromPalettes(e){if(!e.length)throw new Error("At least one palette is required");var t=o.fnv32a(e.map(e=>e.hash)),i=c.cache.get(t);if(i)return i;let r;var s,i=e.map(e=>new l.PalDrawable(e).draw());r=new n.RgbaBitmap(i[0].width,i.length);let a=0;for(s of i)r.drawRgbaImage(s,0,a++);i=this.textureFromPalBitmap(r);return c.cache.set(t,i),i}static textureFromPalBitmap(e){var t=r.CanvasUtils.canvasFromRgbaImageData(e.data,e.width,e.height);let i=new THREE.Texture(t);return i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter,i.needsUpdate=!0,i.flipY=!1,i}}),c.cache=new Map}}}),System.register("engine/renderable/builder/ObjectBuilder",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gfx/BufferGeometryUtils",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("BufferGeometryUtils",i=class{static mergeVertices(r,e=1e-4){e=Math.max(e,Number.EPSILON);const s={},a=r.getIndex();var t=r.getAttribute("position"),i=(a||t).count;let n=0;var o=Object.keys(r.attributes);const l={},c={},h=[],u=[(e,t)=>e.getX(t),(e,t)=>e.getY(t),(e,t)=>e.getZ(t),(e,t)=>e.getW(t)];for(let A=0,M=o.length;A<M;A++){var d=o[A];l[d]=[];var g=r.morphAttributes[d];g&&(c[d]=new Array(g.length).fill(void 0).map(()=>[]))}var t=Math.log10(1/e),p=Math.pow(10,t);for(let R=0;R<i;R++){var m=a?a.getX(R):R;let i="";for(let t=0,e=o.length;t<e;t++){var f=o[t],y=r.getAttribute(f),T=y.itemSize;for(let e=0;e<T;e++)i+=~~(u[e](y,m)*p)+","}if(i in s)h.push(s[i]);else{for(let t=0,e=o.length;t<e;t++){var v=o[t],b=r.getAttribute(v),S=r.morphAttributes[v],w=b.itemSize;const P=l[v],I=c[v];for(let e=0;e<w;e++){const k=u[e];if(P.push(k(b,m)),S)for(let e=0,t=S.length;e<t;e++)I[e].push(k(S[e],m))}}s[i]=n,h.push(n),n++}}const C=r.clone();for(let B=0,j=o.length;B<j;B++){var E=o[B];const N=r.getAttribute(E);var x=new N.array.constructor(l[E]),x=new THREE.BufferAttribute(x,N.itemSize,N.normalized);if(C.addAttribute(E,x),E in c)for(let e=0;e<c[E].length;e++){const L=r.morphAttributes[E][e];var O=new L.array.constructor(c[E][e]),O=new THREE.BufferAttribute(O,L.itemSize,L.normalized);C.morphAttributes[E][e]=O}}return C.setIndex(new THREE.BufferAttribute(new Uint32Array(h),1)),C}static mergeBufferGeometries(r,t=!1){var i=null!==r[0].index;const s=new Set(Object.keys(r[0].attributes)),a={},n=new THREE.BufferGeometry;let o=0;for(let c=0;c<r.length;++c){var l=r[c];let e=0;if(i!=(null!==l.index))throw new Error("mergeBufferGeometries() failed with geometry at index "+c+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");if(Object.keys(l.morphAttributes).length)throw new Error("mergeBufferGeometries() failed with geometry at index "+c+". Morph attributes are not supported");for(const h in l.attributes){if(!s.has(h))throw new Error("mergeBufferGeometries() failed with geometry at index "+c+'. All geometries must have compatible attributes; make sure "'+h+'" attribute exists among all geometries, or in none of them.');void 0===a[h]&&(a[h]=[]),a[h].push(l.attributes[h]),e++}if(e!==s.size)throw new Error("mergeBufferGeometries() failed with geometry at index "+c+". Make sure all geometries have the same number of attributes.");if(t){let e;if(i)e=l.index.count;else{if(void 0===l.attributes.position)throw new Error("mergeBufferGeometries() failed with geometry at index "+c+". The geometry must have either an index or a position attribute");e=l.attributes.position.count}n.addGroup(o,e,c),o+=e}}if(i){let t=0;const u=[];for(let i=0;i<r.length;++i){const d=r[i].index;for(let e=0;e<d.count;++e)u.push(d.getX(e)+t);t+=r[i].attributes.position.count}n.setIndex(new THREE.BufferAttribute(new(65535<u.length?Uint32Array:Uint16Array)(u),1))}for(const g in a){var e=this.mergeBufferAttributes(a[g]);if(!e)throw new Error("mergeBufferGeometries() failed while trying to merge the "+g+" attribute.");n.addAttribute(g,e)}return n}static mergeBufferAttributes(e){let t,i,r,s=0;for(let l=0;l<e.length;++l){var a=e[l];if(a.isInterleavedBufferAttribute)throw new Error("mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported.");if(void 0===t&&(t=a.array.constructor),t!==a.array.constructor)throw new Error("mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes.");if(void 0===i&&(i=a.itemSize),i!==a.itemSize)throw new Error("mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes.");if(void 0===r&&(r=a.normalized),r!==a.normalized)throw new Error("mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes.");s+=a.array.length}const n=new t(s);let o=0;for(let c=0;c<e.length;++c)n.set(e[c].array,o),o+=e[c].array.length;return new THREE.BufferAttribute(n,i,r)}})}}}),System.register("engine/gfx/SpriteUtils",["util/math","engine/gfx/BufferGeometryUtils"],function(e,t){"use strict";var d,g,o;t&&t.id;return{setters:[function(e){d=e},function(e){g=e}],execute:function(){(o=class o{constructor(){this.USE_INDEXED_GEOMETRY=!0,this.VERTICES_PER_SPRITE=this.USE_INDEXED_GEOMETRY?8:12,this.TRIANGLES_PER_SPRITE=4}createSpriteGeometry(e){if("object"!=typeof e)throw new Error("Invalid argument");var t=e.camera,i=e.texture;e.textureArea||(e.textureArea={x:0,y:0,width:i.image.width,height:i.image.height}),e.offset||(e.offset={x:0,y:0});var r=e.textureArea.width,s=e.textureArea.height,a={width:e.texture.image.width,height:e.texture.image.height},n=Math.cos(t.rotation.y)*(e.scale??1),o=n/Math.sin(-t.rotation.x),l=r*n,c=s*(e.flat?o:n);let h;i=e.depth&&!e.flat,r=i&&d.isBetween(-e.offset.x,0,l/n)?-e.offset.x:l/n/2,s=this.createRectGeometry(r*n,c);let u=this.createRectGeometry(l-r*n,c);this.addRectUvs(s,{...e.textureArea,width:r},a),this.addRectUvs(u,{...e.textureArea,x:e.textureArea.x+r,width:e.textureArea.width-r},a),u.applyMatrix((new THREE.Matrix4).makeTranslation((l-r*n+r*n)/2,0,0)),h=g.BufferGeometryUtils.mergeBufferGeometries([s,u]),h.applyMatrix((new THREE.Matrix4).makeTranslation(-(l/2-r*n/2),0,0));s=e.align,r=e.offset;h.applyMatrix((new THREE.Matrix4).makeTranslation(s.x*l/2+r.x*n,s.y*c/2-r.y*(e.flat?o:n),0)),i?this.applyDepth(h,t,e.depthOffset??0):e.depth&&e.flat&&e.depthOffset&&this.applyFlatDepth(h,e.depthOffset);i=new THREE.Euler(t.rotation.x,t.rotation.y,0,"YXZ");return h.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(i).multiply(e.flat?(new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(-t.rotation.x-Math.PI/2,0,0)):(new THREE.Matrix4).identity())),h}createRectGeometry(e,t){return this.USE_INDEXED_GEOMETRY?this.createIndexedRectGeometry(e,t):this.createNonIndexedRectGeometry(e,t)}createNonIndexedRectGeometry(e,t){let i=new THREE.BufferGeometry;var r=new Float32Array([-.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0,.5*e,.5*t,0]);return i.addAttribute("position",new THREE.BufferAttribute(r,3)),i}createIndexedRectGeometry(e,t){let i=new THREE.BufferGeometry;var r=new Float32Array([-.5*e,.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0]);i.addAttribute("position",new THREE.BufferAttribute(r,3));r=new Uint16Array([0,2,1,2,3,1]);return i.setIndex(new THREE.BufferAttribute(r,1)),i}addRectUvs(e,t,i){var r=new Float32Array(2*e.getAttribute("position").count);this.USE_INDEXED_GEOMETRY?this.writeIndexedRectUvsIntoBuffer(r,0,t,i):this.writeNonIndexedRectUvsIntoBuffer(r,0,t,i),e.addAttribute("uv",new THREE.BufferAttribute(r,2))}writeNonIndexedRectUvsIntoBuffer(e,t,i,r){var s=i.x/r.width,a=1-(i.y+i.height)/r.height,n=i.width/r.width,o=i.height/r.height;e.set([s,a+o,s,a,s+n,a+o,s,a,s+n,a,s+n,a+o],12*t)}writeIndexedRectUvsIntoBuffer(e,t,i,r){var s=i.x/r.width,a=1-(i.y+i.height)/r.height,n=i.width/r.width,o=i.height/r.height;e.set([s,a+o,s+n,a+o,s,a,s+n,a],8*t)}applyDepth(e,t,i){let r=e.getAttribute("position");for(let a=0,n=r.count;a<n;a++){var s=r.getX(a)*o.MAGIC_DEPTH_SCALE;let e;e=s<0?i-Math.abs(s)/Math.cos(t.rotation.x)*Math.tan(t.rotation.y):i-s/Math.cos(t.rotation.x)/Math.tan(t.rotation.y),r.setZ(a,e)}}applyFlatDepth(e,t){let i=e.getAttribute("position");for(let r=0,s=i.count;r<s;r++)i.setZ(r,t)}}).MAGIC_DEPTH_SCALE=.8,e("SpriteUtils",new o)}}}),System.register("engine/gfx/TextureAtlas",["data/Bitmap"],function(e,t){"use strict";var r,i;t&&t.id;function u(e){let t=e.target;t.isDisposed=!0,t.removeEventListener("dispose",u)}function d(e,t,i,s){let a=new r.IndexedBitmap(t,i);return e.forEach(e=>{if(!e.fit)throw new Error("Couldn't fit all images in a single texture");var t=e.image,i=e.fit.x,r=e.fit.y;s?.set(t,{x:i,y:r,width:e.w,height:e.h}),a.drawIndexedImage(t,i,r)}),a}return{setters:[function(e){r=e}],execute:function(){e("TextureAtlas",i=class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(e){if(!this.imageRects)throw new Error("Texture atlas not initialized");var t=this.imageRects.get(e);if(!t)throw new Error("Image not found in atlas");return t}pack(e){let t=[];e.forEach(e=>{t.push({w:e.width+e.width%2,h:e.height+e.height%2,image:e})}),t.sort((e,t)=>1e4*(t.w-e.w)+t.h-e.h);let i=new GrowingPacker;i.fit(t);var r,s,a,n=i.root.w,o=i.root.h,l=new Map,c=d(t,n,o,l);let h=new THREE.DataTexture(c.data,n,o,THREE.AlphaFormat);h.needsUpdate=!0,h.flipY=!0,h.minFilter=THREE.NearestFilter,h.magFilter=THREE.NearestFilter,h.onUpdate=(r=t,s=n,a=o,e=>{e.image={width:e.image.width,height:e.image.height,get data(){return e.isDisposed?new Uint8Array(this.width*this.height):(console.log("TextureAtlas: Rebuilding texture for upload to GPU..."),d(r,s,a).data)}},e.addEventListener("dispose",u)}),this.width=n,this.height=o,this.imageRects=l,this.texture=h}dispose(){this.texture?.dispose()}})}}}),System.register("engine/renderable/builder/ShpTextureAtlas",["data/Bitmap","engine/gfx/TextureAtlas"],function(e,t){"use strict";var a,n,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){e("ShpTextureAtlas",i=class{fromShpFile(e){let t=[];for(let s=0;s<e.numImages;s++){var i=e.getImage(s);t.push(new a.IndexedBitmap(i.width,i.height,i.imageData))}let r=new n.TextureAtlas;return r.pack(t),this.images=t,this.atlas=r,this}getTextureArea(e){return this.atlas.getImageRect(this.images[e])}getTexture(){return this.atlas.getTexture()}dispose(){this.atlas.dispose()}})}}}),System.register("engine/renderable/builder/SpriteBuilder",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/renderable/builder/ShpBuilder",["engine/gfx/TextureUtils","engine/gfx/SpriteUtils","engine/renderable/builder/ShpTextureAtlas","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh"],function(e,t){"use strict";var o,l,i,c,h,a;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){i=e},function(e){c=e},function(e){h=e}],execute:function(){e("ShpBuilder",a=class a{constructor(e,t,i,r=1,s=!1,a=0){this.scale=r,this.depth=s,this.depthOffset=a,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1,this.forceTransparent=!1,this.offset={x:0,y:0},this.frameOffset=0,this.flat=!1,this.shpFile=e,this.palette=t,this.camera=i,this.shpSize={width:e.width,height:e.height},this.setFrame(0)}static prepareTexture(e){var t;a.textureCache.has(e)||(t=(new i.ShpTextureAtlas).fromShpFile(e),a.textureCache.set(e,t))}static clearCaches(){a.textureCache.forEach(e=>e.dispose()),a.textureCache.clear(),a.geometryCache.forEach(e=>e.forEach(e=>e.dispose())),a.geometryCache.clear()}useMaterial(e,t,i){if(e.format!==THREE.AlphaFormat)throw new Error("Texture must have format THREE.AlphaFormat");this.materialCacheKey=e.uuid+"_"+t.uuid+"_"+Number(i);let r=a.materialCache.get(this.materialCacheKey),s;return r?(s=r.material,r.usages++):(s=new c.PaletteBasicMaterial({map:e,palette:t,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:i}),r={material:s,usages:1},a.materialCache.set(this.materialCacheKey,r)),s}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let e=a.materialCache.get(this.materialCacheKey);e&&(1===e.usages?(a.materialCache.delete(this.materialCacheKey),e.material.dispose()):e.usages--)}setBatched(e){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=e}setOffset(e){if(this.mesh)throw new Error("Offset can only be set before calling build()");this.offset=e}setFrameOffset(e){if(this.mesh)throw new Error("frameOffset can only be set before calling build()");this.frameOffset=e}initTexture(){a.prepareTexture(this.shpFile),this.atlas=a.textureCache.get(this.shpFile)}getSpriteGeometryOptions(e){e+=this.frameOffset;var t=this.shpFile.getImage(e),t={x:t.x-Math.floor(this.shpSize.width/2)+Math.floor(this.offset.x),y:t.y-Math.floor(this.shpSize.height/2)+Math.floor(this.offset.y)};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(e),flat:this.flat,align:{x:1,y:-1},offset:t,camera:this.camera,depth:this.depth,depthOffset:this.depthOffset,scale:this.scale}}getGeometryCacheKey(e){return e+this.frameOffset+"_"+this.shpSize.width+"_"+this.shpSize.height+"_"+this.offset.x+"_"+this.offset.y+"_"+this.flat+"_"+this.depth+"_"+this.depthOffset}setFrame(i){if(this.frameNo!==i&&(this.frameNo=i,this.mesh)){let e=this.getGeometryCache();var r=this.getGeometryCacheKey(i);let t=e.get(r);t||(t=l.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions(i)),e.set(r,t)),this.mesh.geometry=t}}getGeometryCache(){let e=a.geometryCache.get(this.shpFile);return e||(e=new Map,a.geometryCache.set(this.shpFile,e)),e}getFrame(){return this.frameNo}setSize(e){this.shpSize={width:e.width,height:e.height}}getSize(){return this.shpSize}get frameCount(){return this.shpFile.numImages}getBatchPaletteIndex(t){var e=this.batchPalettes.findIndex(e=>e.hash===t.hash);if(-1===e)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return e}setPalette(t){if(this.palette=t,this.mesh)if(this.useMeshBatching){var i=this.getBatchPaletteIndex(t);this.mesh.setPaletteIndex(i)}else{i=o.TextureUtils.textureFromPalette(t);let e=this.mesh.material;e.palette=i}}setBatchPalettes(e){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=e}setExtraLight(t){if(this.extraLight=t,this.mesh)if(this.useMeshBatching)this.mesh.setExtraLight(t);else{let e=this.mesh.material;e.extraLight=t}}setOpacity(e){var t=this.opacity;t!==e&&(this.opacity=e,this.updateOpacity()),Math.floor(t)===Math.floor(e)||this.forceTransparent||this.updateTransparency()}setForceTransparent(e){e!==this.forceTransparent&&(this.forceTransparent=e,this.updateTransparency())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}updateTransparency(){var e,t,i;this.mesh&&(e=this.forceTransparent||this.opacity<1,this.useMeshBatching?(t=this.mesh.material.map,i=this.mesh.material.palette,this.freeMaterial(),this.mesh.material=this.useMaterial(t,i,e)):this.mesh.material.transparent=e)}build(){if(this.mesh)return this.mesh;this.initTexture();var e,t=this.atlas.getTexture(),i=this.getGeometryCacheKey(this.frameNo);let r=this.getGeometryCache(),s=r.get(i);s||(e=this.getSpriteGeometryOptions(this.frameNo),s=l.SpriteUtils.createSpriteGeometry(e),r.set(i,s));let a;var n,i=this.opacity<1||this.forceTransparent;return this.useMeshBatching?(n=o.TextureUtils.textureFromPalettes(this.batchPalettes),n=this.useMaterial(t,n,i),a=new h.BatchedMesh(s,n,h.BatchMode.Merging),a.castShadow=!1):(n=o.TextureUtils.textureFromPalette(this.palette),i=new c.PaletteBasicMaterial({map:t,palette:n,alphaTest:.5,flatShading:!0,transparent:i}),a=new THREE.Mesh(s,i)),a.matrixAutoUpdate=!1,this.mesh=a,this.setPalette(this.palette),this.updateOpacity(),this.extraLight&&this.setExtraLight(this.extraLight),a}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),a.textureCache=new Map,a.geometryCache=new Map,a.materialCache=new Map}}}),System.register("engine/renderable/builder/VxlBuilder",["game/Coords"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("VxlBuilder",i=class{constructor(e){this.camera=e}build(){if(this.object)return this.object;let e=this.object=new THREE.Object3D,i=Math.cos(this.camera.rotation.y)*s.Coords.ISO_WORLD_SCALE;e.scale.set(i,i,i);let r=new THREE.Object3D;r.rotation.x=-Math.PI/2,r.rotation.z=+Math.PI/2,r.matrixAutoUpdate=!1,r.updateMatrix(),e.add(r);let t=this.sections=this.createVxlMeshes();return t.forEach(e=>{var t;e.matrixAutoUpdate=!1,r.add(e),this.localBoundingBox||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),this.localBoundingBox=new THREE.Box3(e.geometry.boundingBox.min.clone().multiplyScalar(i),e.geometry.boundingBox.max.clone().multiplyScalar(i)),t=this.localBoundingBox.min.x,this.localBoundingBox.min.x=this.localBoundingBox.min.y,this.localBoundingBox.min.y=t,t=this.localBoundingBox.max.x,this.localBoundingBox.max.x=this.localBoundingBox.max.y,this.localBoundingBox.max.y=t)}),e.matrixAutoUpdate=!1,e.updateMatrix(),e}getSection(e){if(!this.sections)throw new Error("Vxl object must be built first");return this.sections.get(e)}getLocalBoundingBox(){return this.localBoundingBox}})}}}),System.register("engine/renderable/entity/building/DamageType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NORMAL=0]="NORMAL",e[e.CONDITION_YELLOW=1]="CONDITION_YELLOW",e[e.CONDITION_RED=2]="CONDITION_RED",e[e.DESTROYED=3]="DESTROYED",t("DamageType",i)}}}),System.register("engine/renderable/entity/building/AnimationType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.IDLE=0]="IDLE",e[e.PRODUCTION=1]="PRODUCTION",e[e.ACTIVE=2]="ACTIVE",e[e.SPECIAL=3]="SPECIAL",e[e.SUPER=4]="SUPER",e[e.BUILDUP=5]="BUILDUP",e[e.UNBUILD=6]="UNBUILD",e[e.FACTORY_DEPLOYING=7]="FACTORY_DEPLOYING",e[e.FACTORY_ROOF_DEPLOYING=8]="FACTORY_ROOF_DEPLOYING",e[e.SUPER_IDLE=9]="SUPER_IDLE",e[e.SUPER_CHARGE_START=10]="SUPER_CHARGE_START",e[e.SUPER_CHARGE_LOOP=11]="SUPER_CHARGE_LOOP",e[e.SUPER_CHARGE_END=12]="SUPER_CHARGE_END",e[e.SPECIAL_DOCKING=13]="SPECIAL_DOCKING",e[e.SPECIAL_REPAIR_START=14]="SPECIAL_REPAIR_START",e[e.SPECIAL_REPAIR_LOOP=15]="SPECIAL_REPAIR_LOOP",e[e.SPECIAL_REPAIR_END=16]="SPECIAL_REPAIR_END",e[e.SPECIAL_SHOOT=17]="SPECIAL_SHOOT",e[e.FACTORY_UNDER_DOOR=18]="FACTORY_UNDER_DOOR",e[e.FACTORY_UNDER_ROOF_DOOR=19]="FACTORY_UNDER_ROOF_DOOR",t("AnimationType",i)}}}),System.register("engine/gfx/OverlayUtils",["engine/gfx/CanvasUtils"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("OverlayUtils",i=class{static createGroundCircle(e,t){var i=new THREE.LineBasicMaterial({color:t,transparent:!0,depthTest:!1,depthWrite:!1});let r=new THREE.CircleGeometry(e,64);r.vertices.shift(),r.vertices.push(r.vertices[0]);let s=new THREE.Line(r,i);return s.rotation.x=Math.PI/2,s.renderOrder=1e6,s}static createTextBox(e,t){let i=document.createElement("canvas");i.width=i.height=0;var r=i.getContext("2d",{alpha:!t.backgroundColor||!!t.backgroundColor.match(/^rgba/)});return s.CanvasUtils.drawText(r,e,0,0,{...t,autoEnlargeCanvas:!0}),i}})}}}),System.register("engine/AnimProps",["game/GameSpeed","util/math"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("AnimProps",s=class s{constructor(e,t){this.art=e,this.init(t)}init(e){this.shadow=this.art.getBool("Shadow"),this.reverse=this.art.getBool("Reverse"),this.frameCount="number"==typeof e?e:this.shadow?e.numImages/2:e.numImages,this.end=this.art.getNumber("End",this.frameCount-1);var t=this.art.getNumberArray("RandomRate").sort();2===t.length?this.rate=r.getRandomInt(t[0],t[1])/60:this.rate=this.art.getNumber("Rate",60*s.defaultRate)/60,this.start=this.art.getNumber("Start",0),this.loopStart=this.art.getNumber("LoopStart",0),this.loopEnd=Math.max(this.loopStart,this.art.getNumber("LoopEnd",this.end+1)-1),this.loopCount=this.art.getNumber("LoopCount",1);t=this.art.getNumberArray("RandomLoopDelay").sort();this.randomLoopDelay=2===t.length?[t[0],t[1]]:void 0}getArt(){return this.art}setArt(e){this.art=e,this.init(this.frameCount)}}),s.defaultRate=i.GameSpeed.BASE_TICKS_PER_SECOND}}}),System.register("engine/Animation",["util/math"],function(t,e){"use strict";var r,s,i;e&&e.id;return{setters:[function(e){r=e}],execute:function(){var e;(e=s=s||{})[e.NOT_STARTED=0]="NOT_STARTED",e[e.RUNNING=1]="RUNNING",e[e.STOPPED=2]="STOPPED",e[e.DELAYED=3]="DELAYED",e[e.PAUSED=4]="PAUSED",t("AnimationState",s),t("Animation",i=class{constructor(e,t){this.props=e,this.state=s.NOT_STARTED,this.endLoopFlag=!1,this.playToEndFlag=!1,this.speed=t}getState(){return this.state}start(e,t=0){this.time=e,this.frameNo=this.props.reverse?this.props.end:this.props.start,this.loopNo=0,this.delayFrames=t,this.state=t?s.DELAYED:s.RUNNING}pause(){this.state===s.RUNNING&&(this.state=s.PAUSED)}unpause(){this.state===s.PAUSED&&(this.state=s.RUNNING)}reset(){this.state=s.NOT_STARTED}stop(){this.state=s.STOPPED}update(e){var t=(e-this.time)/1e3,i=this.props.rate*this.speed.value,i=Math.floor(t*i);if(!(i<1)&&(this.time=e,this.state!==s.PAUSED)){if(0<this.delayFrames){if(this.delayFrames=Math.max(0,this.delayFrames-i),0<this.delayFrames)return void(this.state=s.DELAYED);this.state=s.RUNNING}this.computeNextFrame(i)&&(this.state=s.STOPPED)}}endLoop(){this.endLoopFlag=!0}endLoopAndPlayToEnd(){this.endLoopFlag=!0,this.playToEndFlag=!0}rewind(){this.props.reverse?this.frameNo=this.loopNo?this.props.loopEnd:this.props.end:this.frameNo=this.loopNo?this.props.loopStart:this.props.start}getCurrentFrame(){return this.frameNo}computeNextFrame(e){let t=this.frameNo;for(;0<e;){var i=this.endLoopFlag&&this.playToEndFlag?this.props.reverse?this.props.start:this.props.end:this.props.reverse?this.props.loopStart:this.props.loopEnd;if(!this.props.reverse&&t+e<=i||this.props.reverse&&t-e>=i){t+=this.props.reverse?-e:e;break}if(-1!==this.props.loopCount&&this.loopNo>=this.props.loopCount-1)return this.frameNo=i,!0;if(this.endLoopFlag)return!(this.endLoopFlag=!1);e-=1+(this.props.reverse?t-i:i-t),t=this.props.reverse?this.props.loopEnd:this.props.loopStart,this.loopNo++,this.props.randomLoopDelay&&(this.state=s.DELAYED,this.delayFrames=r.getRandomInt(this.props.randomLoopDelay[0],this.props.randomLoopDelay[1]))}return this.frameNo=t,!1}})}}}),System.register("engine/renderable/entity/wallTypes",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("wallTypes",[[0,0,0,0],[1,0,0,0],[0,1,0,0],[1,1,0,0],[0,0,1,0],[1,0,1,0],[0,1,1,0],[1,1,1,0],[0,0,0,1],[1,0,0,1],[0,1,0,1],[1,1,0,1],[0,0,1,1],[1,0,1,1],[0,1,1,1],[1,1,1,1]])}}}),System.register("engine/renderable/WithPosition",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("WithPosition",i=class{constructor(){this.matrixUpdate=!1,this.position=new THREE.Vector3}setPosition(e,t,i){this.position.x=e,this.position.y=t,this.position.z=i,this.updatePosition()}getPosition(){return this.position}updatePosition(){if(this.target){let e=this.target.get3DObject();e&&(e.position.set(this.position.x,this.position.y,this.position.z),this.matrixUpdate&&(e.matrix.setPosition(e.position),e.matrixWorldNeedsUpdate=!0))}}applyTo(e){this.target=e,this.updatePosition()}})}}}),System.register("engine/IsoCoords",["game/Coords"],function(e,t){"use strict";var r,s;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("IsoCoords",s=class s{static init(e){s.worldOrigin=e}static worldToScreen(e,t){if(!s.worldOrigin)throw new Error("Coords not initialized with world origin");return e-=s.worldOrigin.x,t-=s.worldOrigin.y,{x:(e/=r.Coords.ISO_WORLD_SCALE)-(t/=r.Coords.ISO_WORLD_SCALE),y:(e+t)/2}}static screenToWorld(e,t){if(!s.worldOrigin)throw new Error("Coords not initialized with world origin");return{x:(e+2*t)/2*r.Coords.ISO_WORLD_SCALE+s.worldOrigin.x,y:(2*t-e)/2*r.Coords.ISO_WORLD_SCALE+s.worldOrigin.y}}static vecWorldToScreen(e){let t=s.worldToScreen(e.x,e.z);return t.y-=s.tileHeightToScreen(r.Coords.worldToTileHeight(e.y)),t}static tileToScreen(e,t){var i=r.Coords.tileToWorld(e,t);return s.worldToScreen(i.x,i.y)}static tileHeightToScreen(e){return e*(r.Coords.ISO_TILE_SIZE/2)}static tile3dToScreen(e,t,i){let r=s.tileToScreen(e,t);return r.y-=s.tileHeightToScreen(i),r}static screenTileToScreen(e,t){return{x:e*r.Coords.ISO_TILE_SIZE,y:t*r.Coords.ISO_TILE_SIZE/2}}static screenToScreenTile(e,t){return{x:e/r.Coords.ISO_TILE_SIZE,y:t/(r.Coords.ISO_TILE_SIZE/2)}}static screenTileToWorld(e,t){var i=s.screenTileToScreen(e,t);return s.screenToWorld(i.x,i.y)}static getScreenTileSize(){return{width:s.tileToScreen(1,0).x-s.tileToScreen(0,1).x,height:s.tileToScreen(1,1).y-s.tileToScreen(0,0).y}}static screenDistanceToWorld(e,t){return r.Coords.screenDistanceToWorld(e,t)}})}}}),System.register("engine/renderable/entity/map/MapSurface",["game/Coords","game/theater/rampHeights","engine/gfx/BufferGeometryUtils","util/disposable/CompositeDisposable"],function(e,t){"use strict";var a,s,n,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){s=e},function(e){n=e},function(e){i=e}],execute:function(){e("MAGIC_OFFSET",.05),e("MapSurface",r=class{constructor(e,t){this._textureTilesNo=20,this.visible=!0,this.disposables=new i.CompositeDisposable,this.map=e,this.theater=t}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=this.createObject(),e.name="map_surface_shadow",e.matrixAutoUpdate=!1,e.visible=this.visible,this.target=e)}update(){}setVisible(e){this.visible=e,this.target&&(this.target.visible=e)}createObject(){let r=[],e=this.map.tiles;e.forEach(e=>{var t=a.Coords.tile3dToWorld(e.rx,e.ry,e.z);let i=this.createRectGeometry(e.rampType);i.applyMatrix((new THREE.Matrix4).makeTranslation(t.x,t.y+.05,t.z)),r.push(i)});var t=n.BufferGeometryUtils.mergeBufferGeometries(r);let i=new THREE.ShadowMaterial;i.transparent=!0,i.opacity=.5;let s=new THREE.Mesh(t,i);return s.receiveShadow=!0,s.renderOrder=5,s.frustumCulled=!1,this.disposables.add(t,i),s}createRectGeometry(e){var t=a.Coords.getWorldTileSize(),i=s.rampHeights[e];let r=new THREE.BufferGeometry;t=new Float32Array([0,a.Coords.tileHeightToWorld(i[0]),t,t,a.Coords.tileHeightToWorld(i[3]),t,0,a.Coords.tileHeightToWorld(i[1]),0,t,a.Coords.tileHeightToWorld(i[2]),0]),i=new Uint16Array([0,1,2,3,2,1]);return r.addAttribute("position",new THREE.BufferAttribute(t,3)),r.setIndex(new THREE.BufferAttribute(i,1)),r}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/ShadowRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","game/Coords","engine/IsoCoords","engine/renderable/entity/map/MapSurface"],function(e,t){"use strict";var i,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){e("ShadowRenderable",l=class l{constructor(e,t,i,r=0){this.shpFile=e,this.camera=t,this.shadowHeightTileAdjust=r,this.baseFrameNo=0,this.frameOffset=0,this.visible=!0,this.useBatching=!1,this.drawOffset={...i}}static getOrCreateShadowPalette(){let e=l.shadowPalette;return e||(e=new i.Palette(new Array(768).fill(0)),l.shadowPalette=e),e}setVisible(e){var t;this.visible=e,this.object3d&&(t=this.computeShadowFrameNo(this.baseFrameNo),this.object3d.visible=e&&this.frameHasShadowData(t))}setSize(e){this.shpSize=e,this.builder?.setSize(e)}setBatched(e){this.useBatching=e,this.builder?.setBatched(e)}setBaseFrame(e){var t;this.baseFrameNo=e,this.builder&&(t=this.computeShadowFrameNo(e),this.builder.setFrame(t),this.object3d.visible=this.visible&&this.frameHasShadowData(t))}setFrameOffset(e){this.frameOffset=e,this.builder&&this.builder.setFrameOffset(e)}computeShadowFrameNo(e){return e<this.shpFile.numImages?this.shpFile.numImages/2+e:1}create3DObject(){if(!this.object3d){var i=l.getOrCreateShadowPalette();let e=new s.ShpBuilder(this.shpFile,i,this.camera,a.Coords.ISO_WORLD_SCALE);this.shpSize&&e.setSize(this.shpSize),e.setFrameOffset(this.frameOffset),e.setBatched(this.useBatching),this.useBatching&&e.setBatchPalettes([i]),e.flat=!0;var r=this.computeShadowFrameNo(this.baseFrameNo);e.setFrame(r),this.shadowHeightTileAdjust&&(i=n.IsoCoords.tileHeightToScreen(this.shadowHeightTileAdjust),this.drawOffset.y+=-i),e.setOffset(this.drawOffset),e.setOpacity(.5);let t=e.build();this.shadowHeightTileAdjust&&(t.position.y+=a.Coords.tileHeightToWorld(-this.shadowHeightTileAdjust),t.updateMatrix()),t.visible=this.visible&&this.frameHasShadowData(r),t.position.y+=o.MAGIC_OFFSET/5,t.updateMatrix(),this.builder=e,this.object3d=t}}frameHasShadowData(e){return!!this.shpFile.getImage(this.frameOffset+e).imageData.length}get3DObject(){return this.object3d}update(e){}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/ShpRenderable",["engine/renderable/builder/ShpBuilder","engine/renderable/ShadowRenderable","game/Coords"],function(e,t){"use strict";var g,p,m,i;t&&t.id;return{setters:[function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("ShpRenderable",i=class{constructor(e,t,i){this.builder=e,this.shadowRenderable=t,this.zShapeFixBuilder=i}static factory(e,t,i,r,s=!1,a=0,n=!1,o=0,l=!1){var c=s?new p.ShadowRenderable(e,i,r,a):void 0,h=m.Coords.ISO_WORLD_SCALE;let u=new g.ShpBuilder(e,t,i,h,n,o);u.setOffset(r);let d;return l&&(d=new g.ShpBuilder(e,t,i,h,n,o),d.setOffset(r),d.flat=!0),new this(u,c,d)}get3DObject(){return this.target}setBatched(e){this.builder.setBatched(e),this.zShapeFixBuilder?.setBatched(e),this.shadowRenderable?.setBatched(e)}setBatchPalettes(e){this.builder.setBatchPalettes(e),this.zShapeFixBuilder?.setBatchPalettes(e)}setSize(e){this.builder.setSize(e),this.zShapeFixBuilder?.setSize(e),this.shadowRenderable?.setSize(e)}getFlat(){return this.builder.flat}setFlat(e){this.builder.flat=e}setFrame(e){this.builder.getFrame()!==e&&(this.builder.setFrame(e),this.zShapeFixBuilder?.setFrame(e),this.shadowRenderable?.setBaseFrame(e))}setFrameOffset(e){this.builder.setFrameOffset(e),this.zShapeFixBuilder?.setFrameOffset(e),this.shadowRenderable?.setFrameOffset(e)}setPalette(e){this.builder.setPalette(e),this.zShapeFixBuilder?.setPalette(e)}setExtraLight(e){this.builder.setExtraLight(e),this.zShapeFixBuilder?.setExtraLight(e)}setOpacity(e){this.builder.setOpacity(e),this.zShapeFixBuilder?.setOpacity(e)}setForceTransparent(e){this.builder.setForceTransparent(e),this.zShapeFixBuilder?.setForceTransparent(e)}get frameCount(){return this.shadowRenderable?this.builder.frameCount/2:this.builder.frameCount}getShapeMesh(){return this.shapeMesh}getShadowMesh(){return this.shadowMesh}setShadowVisible(e){this.shadowRenderable?.setVisible(e)}create3DObject(){if(!this.target){var t,i=this.shapeMesh=this.builder.build();if(this.shadowRenderable||this.zShapeFixBuilder){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,e.add(i),this.shadowRenderable&&(this.shadowRenderable.create3DObject(),t=this.shadowMesh=this.shadowRenderable.get3DObject(),e.add(t)),this.zShapeFixBuilder&&(t=this.zShapeFixBuilder.build(),e.add(t)),this.target=e}else this.target=i}}update(e){}dispose(){this.builder.dispose(),this.zShapeFixBuilder?.dispose(),this.shadowRenderable?.dispose()}})}}}),System.register("engine/ImageFinder",[],function(e,t){"use strict";var s;t&&t.id;return{setters:[],execute:function(){e("ImageFinder",s=class s{constructor(e,t){this.images=e,this.theater=t}findByObjectArt(e){return this.find(e.imageName,e.useTheaterExtension)}find(e,t){var i=this.getFilename(e,t),r=this.images.get(i);if(!r)throw new s.MissingImageError(`No image file found for artName="${e}" (file=${i})`);return r}tryFind(e,t){let i;try{i=this.find(e,t)}catch(e){if(!(e instanceof s.MissingImageError))throw e}return i}getFilename(e,t){let i=e.toLowerCase();return i+=t?this.theater.settings.Extension:".shp",i=this.applyNewTheaterIfNeeded(e,i),i}applyNewTheaterIfNeeded(e,t){return-1===["G","N","C","Y"].indexOf(e[0])||-1===["A","T","U","D","L","N"].indexOf(e[1])?t:this.applyNewTheater(t)}applyNewTheater(e){let t;var i=e[0],r=e.substr(2),s=this.theater.settings.NewTheaterChar.toLowerCase();return t=i+s+r,this.images.has(t)||(t=i+"g"+r,this.images.has(t)||(t=e)),t}}),function(e){class t extends Error{}e.MissingImageError=t}(s=s||{}),e("ImageFinder",s)}}}),System.register("engine/gfx/DebugUtils",["game/Coords","data/Bitmap","three"],function(e,t){"use strict";var o,a,i,r;t&&t.id;return{setters:[function(e){o=e},function(e){a=e},function(e){i=e}],execute:function(){e("DebugUtils",r=class{static createWireframe(e,t){return new i.Mesh(this.createBoxGeometry(e,t),new THREE.MeshBasicMaterial({wireframe:!0}))}static createBoxGeometry(e,t,i=!1){var r=o.Coords.getWorldTileSize(),s=e.width*r,a=e.height*r,r=o.Coords.tileHeightToWorld(t);let n=new THREE.BoxBufferGeometry(s,r,a);return i?n.translate(0,r/2,0):n.translate(s/2,r/2,a/2),n}static createIndexedCheckerTex(e,t){let i=new a.IndexedBitmap(64,64,new Uint8Array(4096).fill(e));for(let s=0;s<32;s++)for(let e=0;e<32;e++)i.data[s+64*e]=t,i.data[s+32+64*(e+32)]=t;let r=new THREE.DataTexture(i.data,64,64,THREE.AlphaFormat);return r.needsUpdate=!0,r.minFilter=THREE.NearestFilter,r.magFilter=THREE.NearestFilter,r}})}}}),System.register("engine/renderable/MapSpriteTranslation",["game/Coords","engine/IsoCoords"],function(e,t){"use strict";var s,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e}],execute:function(){e("MapSpriteTranslation",i=class{constructor(e,t){this.rx=e,this.ry=t}compute(){let e=s.Coords.tileToWorld(this.rx,this.ry);var t=a.IsoCoords.worldToScreen(e.x,e.y),i=a.IsoCoords.worldToScreen(0,0);let r=new THREE.Vector2(i.x-t.x,i.y-t.y);t=r.y-Math.floor(r.y);return 0!=t&&(r.y-=t,i=new THREE.Vector2(i.x-r.x,i.y-r.y),e=a.IsoCoords.screenToWorld(i.x,i.y)),{spriteOffset:r,anchorPointWorld:e}}})}}}),System.register("engine/renderable/entity/building/BuildingAnimData",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("BuildingAnimData",i=class{})}}}),System.register("engine/renderable/entity/building/BuildingAnimArtProps",["engine/renderable/entity/building/AnimationType","data/IniSection","engine/renderable/entity/building/BuildingAnimData","engine/type/ObjectType"],function(e,t){"use strict";var u,d,g,p,i,r;t&&t.id;return{setters:[function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){i=(new Map).set(u.AnimationType.IDLE,["IdleAnim"]).set(u.AnimationType.PRODUCTION,["ProductionAnim"]).set(u.AnimationType.SUPER,["SuperAnim","SuperAnimTwo","SuperAnimThree","SuperAnimFour"]).set(u.AnimationType.ACTIVE,["ActiveAnim","ActiveAnimTwo","ActiveAnimThree","ActiveAnimFour"]).set(u.AnimationType.SPECIAL,["SpecialAnim","SpecialAnimTwo","SpecialAnimThree","SpecialAnimFour"]).set(u.AnimationType.FACTORY_DEPLOYING,["DeployingAnim","UnderDoorAnim"]).set(u.AnimationType.FACTORY_ROOF_DEPLOYING,["RoofDeployingAnim","UnderRoofDoorAnim"]).set(u.AnimationType.BUILDUP,["Buildup"]).set(u.AnimationType.UNBUILD,["Buildup"]),e("BuildingAnimArtProps",r=class{constructor(){this.animsByType=new Map}read(c,h){i.forEach((e,o)=>{let l=[];e.forEach((s,e)=>{var a=c.getString(s);if(a){let e=new g.BuildingAnimData;e.name=a,e.type=o;let t,i;if(h.hasObject(a,p.ObjectType.Animation)&&(i=h.getObject(a,p.ObjectType.Animation),t=i.art),o===u.AnimationType.BUILDUP||o===u.AnimationType.UNBUILD)t=t?t.clone():new d.IniSection(a),t.has("Shadow")||t.set("Shadow","yes"),o===u.AnimationType.UNBUILD&&t.set("Reverse","yes");else if(!t)throw new Error(`Missing building anim section "${a}"`);e.art=t,e.pauseWhenUnpowered=c.getBool(s+"Powered",!0),e.showWhenUnpowered=!c.getBool(s+"PoweredLight",!1);var n=c.getString(s+"Damaged");n&&h.hasObject(n,p.ObjectType.Animation)&&(e.damagedArt=h.getObject(n,p.ObjectType.Animation).art),e.offset={x:c.getNumber(s+"X"),y:c.getNumber(s+"Y")};let r=t.getString("Image");r=r||a,e.image=r,e.flat="UnderDoorAnim"===s||"UnderRoofDoorAnim"===s||t.getBool("Flat"),i&&(e.translucent=i.translucent,e.translucency=i.translucency),l.push(e)}}),this.animsByType.set(o,l)})}getByType(e){if(!this.animsByType.has(e))throw new Error(`Animation type "${u.AnimationType[e]}" has no data`);return this.animsByType.get(e)}getAll(){return this.animsByType}})}}}),System.register("engine/animation/Runner",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/animation/SimpleRunner",["engine/Animation"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SimpleRunner",r=class{tick(e){let t=this.animation;if(t)switch(t.getState()){case i.AnimationState.STOPPED:return;case i.AnimationState.NOT_STARTED:t.start(e);case i.AnimationState.RUNNING:default:t.update(e)}}getCurrentFrame(){return this.animation.getCurrentFrame()}shouldUpdate(){return this.animation.getState()!==i.AnimationState.STOPPED}})}}}),System.register("engine/sound/ChannelType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Master=0]="Master",e[e.Ui=1]="Ui",e[e.Ambient=2]="Ambient",e[e.Effect=3]="Effect",e[e.Voice=4]="Voice",e[e.Music=5]="Music",e[e.CreditTicks=6]="CreditTicks",t("ChannelType",i)}}}),System.register("engine/sound/Mixer",["util/event"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Mixer",r=class{constructor(){this.volumes=new Map,this.mutes=new Map,this._onVolumeChange=new i.EventDispatcher}get onVolumeChange(){return this._onVolumeChange.asEvent()}setVolume(e,t){this.getVolume(e)!==t&&(this.volumes.set(e,t),this._onVolumeChange.dispatch(this,e))}getVolume(e){return this.volumes.get(e)??1}setMuted(e,t){this.mutes.set(e,t),this._onVolumeChange.dispatch(this,e)}isMuted(e){return!!this.mutes.get(e)}serialize(){return[...this.volumes.entries()].map(([e,t])=>e+","+t).join(";")}unserialize(e){return this.volumes=new Map(e.split(";").map(e=>e.split(",").map(Number))),this}})}}}),System.register("engine/sound/InternalPlaybackHandle",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("InternalPlaybackHandle",i=class{constructor(){this.playing=!0,this.isLoop=!1,this.stopRequested=!1}setNodes(e,t,i){this.sourceNode=e,this.gainNode=t,this.panNode=i,this.stopRequested?this.stop():(this.volumeRequested&&(t.gain.value=this.volumeRequested),this.panRequested&&(i.pan.value=this.panRequested))}isPlaying(){return this.playing}stop(){try{this.sourceNode instanceof AudioBufferSourceNode?this.sourceNode.stop():this.sourceNode instanceof MediaElementAudioSourceNode?this.sourceNode.mediaElement?.pause():this.stopRequested=!0,this.playing=!1}catch(e){console.error(e)}}setVolume(e){this.gainNode?this.gainNode.gain.value=e:this.volumeRequested=e}setPan(e){this.panNode?this.panNode.pan.value=e:this.panRequested=e}})}}}),System.register("engine/sound/AudioLoop",["util/math"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("AudioLoop",i=class{constructor(e,t,i,r,s,a,n,o,l){this.audioContext=e,this.volume=t,this.pan=i,this.rate=r,this.delayMs=s,this.attack=a,this.decay=n,this.playBuffer=l,this.isLoop=!0,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.fill(this.buffers),this.remainingLoops||this.items.length||this.stop())},this.remainingLoops=o}setBuffers(e){this.buffers=e,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(e){if(this.playing)throw new Error("Already playing");this.timePointer=e,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){var e;this.playing&&(this.playing=!1,this.decay&&this.buffers?(this.removeCompleted(),this.items.length&&(e=this.items[0].startTime+this.items[0].duration,this.items.splice(1).forEach(e=>e.handle.stop()),this.queueBuffer(this.buffers[this.buffers.length-1],e))):(this.items.forEach(e=>e.handle.stop()),this.items.length=0))}setVolume(t){this.volume=t,this.items.forEach(e=>e.handle.setVolume(t))}setPan(t){this.pan=t,this.items.forEach(e=>e.handle.setPan(t))}add(e){this.items.push(e)}removeCompleted(){this.items=this.items.filter(e=>e.startTime+e.duration>=this.audioContext.currentTime)}fill(e){let t=this.items.length?this.timePointer-this.items[0].startTime:0;for(;t<.1||this.items.length<3;){if(!this.attack||void 0!==this.bufferPointer){if(this.remainingLoops<=0)break;this.remainingLoops--}this.attack?this.bufferPointer=void 0===this.bufferPointer?0:o.getRandomInt(1,e.length-1-(this.decay?1:0)):this.bufferPointer=o.getRandomInt(0,e.length-1);var i=e[this.bufferPointer],i=this.queueBuffer(i,this.timePointer);this.timePointer+=i,t+=i}}queueBuffer(e,t){var i=this.delayMs?o.getRandomInt(this.delayMs.min,this.delayMs.max)/1e3:0,r=t+i,s=e.duration/this.rate;let{handle:a,source:n}=this.playBuffer(e,r,this.volume,this.pan,this.rate);return n.addEventListener("ended",this.handleSoundEnded),this.add({startTime:r,duration:s,handle:a}),s+i}})}}}),System.register("engine/sound/AudioSequence",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("AudioSequence",i=class{constructor(e,t,i,r,s,a){this.audioContext=e,this.volume=t,this.pan=i,this.rate=r,this.delayMs=s,this.playBuffer=a,this.isLoop=!1,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.items.length||(this.playing=!1))}}setBuffers(e){this.buffers=e,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(e){if(this.playing)throw new Error("Already playing");this.timePointer=e,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){this.playing&&(this.playing=!1,this.items.forEach(e=>e.handle.stop()),this.items.length=0)}setVolume(t){this.volume=t,this.items.forEach(e=>e.handle.setVolume(t))}setPan(t){this.pan=t,this.items.forEach(e=>e.handle.setPan(t))}add(e){this.items.push(e)}removeCompleted(){this.items=this.items.filter(e=>e.startTime+e.duration>=this.audioContext.currentTime)}fill(e){let t=this.delayMs?this.delayMs/1e3:0;for(var i of e){i=this.queueBuffer(i,this.timePointer,t);this.timePointer+=i,t=0}}queueBuffer(e,t,i){var r=t+i,s=e.duration/this.rate;let{handle:a,source:n}=this.playBuffer(e,r,this.volume,this.pan,this.rate);return n.addEventListener("ended",this.handleSoundEnded),this.add({startTime:r,duration:s,handle:a}),s+i}})}}}),System.register("engine/sound/AudioSystem",["engine/sound/ChannelType","util/disposable/CompositeDisposable","engine/sound/InternalPlaybackHandle","engine/sound/AudioLoop","engine/sound/AudioSequence"],function(e,t){"use strict";var a,i,d,u,l,r;t&&t.id;return{setters:[function(e){a=e},function(e){i=e},function(e){d=e},function(e){u=e},function(e){l=e}],execute:function(){e("AudioSystem",r=class{constructor(e){this.mixer=e,this.channels=new Map,this.audioBufferCache=new Map,this.disposables=new i.CompositeDisposable,this.soundsPlaying=new Set,this.handleVolumeChange=(e,t)=>{this.getChannel(e).gain.value=t.isMuted(e)?0:t.getVolume(e)}}isInitialized(){return!!this.audioContext}isSuspended(){return"running"!==this.audioContext?.state}async canAutoPlay(){let e=document.createElement("audio");e.src="data:audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";let t;try{await e.play(),t=!0}catch(e){t=!1}return e.srcObject=null,t}initialize(){this.isInitialized()||(this.audioContext=new AudioContext,this.mixer.onVolumeChange.subscribe(this.handleVolumeChange),this.disposables.add(()=>this.mixer.onVolumeChange.unsubscribe(this.handleVolumeChange)),this.createChannels(this.audioContext,this.mixer))}dispose(){this.disposables.dispose(),this.audioContext&&(this.audioContext.close(),this.soundsPlaying.clear())}createChannels(r,i){let e=Object.keys(a.ChannelType).map(Number).filter(e=>!Number.isNaN(e));e.forEach(e=>{let t=r.createGain();t.gain.value=i.getVolume(e),this.channels.set(e,t)});let s=this.getChannel(a.ChannelType.Master);e.forEach(e=>{let t=this.getChannel(e);var i;e===a.ChannelType.Master?t.connect(r.destination):e===a.ChannelType.Effect?(i=r.createDynamicsCompressor(),t.connect(i).connect(s)):t.connect(s)})}getChannel(e){if(!this.channels.has(e))throw new Error(`Sound channel "${e}" doesn't exist`);return this.channels.get(e)}setMuted(e){this.mixer.setMuted(a.ChannelType.Master,e)}playWavFile(e,t,i=1,r=0,s=0,a=1,n=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");var o=this.audioContext.currentTime+s/1e3;return this.removeSuspendedSounds(),this.playWavFileAtTime(e,t,o,i,r,a,n)}removeSuspendedSounds(){this.isSuspended()&&this.soundsPlaying.forEach(e=>{try{e instanceof AudioBufferSourceNode?e.stop():e.mediaElement?.pause()}catch(e){console.error(e)}})}playWavLoop(e,n,t=1,i=0,r,s=1,a=!1,o=!1,l=Number.POSITIVE_INFINITY){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let c=this.audioContext;this.removeSuspendedSounds();let h=new u.AudioLoop(c,t,i,s,r,a,o,l,(e,t,i,r,s)=>{var a=new d.InternalPlaybackHandle;return{handle:a,source:this.playAudioBuffer(a,e,n,i,r,t,s,!1)}});return Promise.all(e.map(e=>this.decodeFile(e,c))).then(e=>{h.setBuffers(e)}).catch(e=>console.error(e)),h.start(c.currentTime),h}playWavSequence(e,n,t=1,i=0,r=0,s=1){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let a=this.audioContext;this.removeSuspendedSounds();let o=new l.AudioSequence(a,t,i,s,r,(e,t,i,r,s)=>{var a=new d.InternalPlaybackHandle;return{handle:a,source:this.playAudioBuffer(a,e,n,i,r,t,s,!1)}});return Promise.all(e.map(e=>this.decodeFile(e,a))).then(e=>{o.setBuffers(e)}).catch(e=>console.error(e)),o.start(a.currentTime),o}async decodeFile(e,t){let i=this.audioBufferCache.get(e);var r;return i||(r=new Uint8Array(e.getData()).buffer,i=await t.decodeAudioData(r),100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(e,i)),i}playWavFileAtTime(i,r,s,a=1,n=0,o=1,l=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");let c=this.audioContext,h=new d.InternalPlaybackHandle;var e=this.audioBufferCache.get(i);if(e)this.playAudioBuffer(h,e,r,a,n,s,o,l);else{let t;try{var u=i.getData();t=new Uint8Array(u).buffer}catch(e){return console.error("Failed to decode wav file",e),h}(async()=>{var e=await c.decodeAudioData(t);100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(i,e),h.stopRequested||this.playAudioBuffer(h,e,r,a,n,s,o,l)})().catch(e=>console.error(e))}return h}playAudioBuffer(e,t,i,r,s,a,n,o){let l=this.audioContext,c=l.createGain();c.gain.value=r;let h=l.createStereoPanner();h.pan.value=s;let u=l.createBufferSource();return u.buffer=t,u.playbackRate.value=n,u.loop=o,u.connect(h).connect(c).connect(this.getChannel(i)),e.setNodes(u,c,h),u.addEventListener("ended",()=>{this.soundsPlaying.delete(u),e.playing=!1}),this.soundsPlaying.add(u),u.start(a),u}async playMp3File(e,t,i=1,r=0,s=!1,a){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");this.removeSuspendedSounds();var n=new d.InternalPlaybackHandle;let o=document.createElement("audio");o.loop=s;let l=o.src=URL.createObjectURL(e.asFile());return o.onended=o.onpause=()=>{URL.revokeObjectURL(l),o=void 0},a&&o.addEventListener("ended",a,{once:!0}),await this.playMedia(n,o,t,i,r),n}async playMedia(e,t,i,r,s){let a=this.audioContext,n=a.createGain();n.gain.value=r;let o=a.createStereoPanner();o.pan.value=s;let l=a.createMediaElementSource(t);return l.connect(o).connect(n).connect(this.getChannel(i)),e.setNodes(l,n,o),l.addEventListener("ended",()=>{this.soundsPlaying.delete(l),e.playing=!1}),this.soundsPlaying.add(l),await l.mediaElement.play()?.catch(e=>console.error(e)),l}})}}}),System.register("engine/sound/SoundKey",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.CreateInfantrySound=0]="CreateInfantrySound",e[e.CreateUnitSound=1]="CreateUnitSound",e[e.CreateAircraftSound=2]="CreateAircraftSound",e[e.SpySatActivationSound=3]="SpySatActivationSound",e[e.SpySatDeactivationSound=4]="SpySatDeactivationSound",e[e.UpgradeVeteranSound=5]="UpgradeVeteranSound",e[e.UpgradeEliteSound=6]="UpgradeEliteSound",e[e.BaseUnderAttackSound=7]="BaseUnderAttackSound",e[e.BuildingGarrisonedSound=8]="BuildingGarrisonedSound",e[e.BuildingRepairedSound=9]="BuildingRepairedSound",e[e.CheerSound=10]="CheerSound",e[e.PlaceBeaconSound=11]="PlaceBeaconSound",e[e.StartPlanningModeSound=12]="StartPlanningModeSound",e[e.EndPlanningModeSound=13]="EndPlanningModeSound",e[e.AddPlanningModeCommandSound=14]="AddPlanningModeCommandSound",e[e.ExecutePlanSound=15]="ExecutePlanSound",e[e.CratePromoteSound=16]="CratePromoteSound",e[e.CrateMoneySound=17]="CrateMoneySound",e[e.CrateRevealSound=18]="CrateRevealSound",e[e.CrateFireSound=19]="CrateFireSound",e[e.CrateArmourSound=20]="CrateArmourSound",e[e.CrateSpeedSound=21]="CrateSpeedSound",e[e.CrateUnitSound=22]="CrateUnitSound",e[e.GUIMainButtonSound=23]="GUIMainButtonSound",e[e.GUIBuildSound=24]="GUIBuildSound",e[e.GUITabSound=25]="GUITabSound",e[e.GUIOpenSound=26]="GUIOpenSound",e[e.GUICloseSound=27]="GUICloseSound",e[e.GUIMoveOutSound=28]="GUIMoveOutSound",e[e.GUIMoveInSound=29]="GUIMoveInSound",e[e.GUIComboOpenSound=30]="GUIComboOpenSound",e[e.GUIComboCloseSound=31]="GUIComboCloseSound",e[e.GUICheckboxSound=32]="GUICheckboxSound",e[e.ScoreAnimSound=33]="ScoreAnimSound",e[e.SinkingSound=34]="SinkingSound",e[e.ImpactWaterSound=35]="ImpactWaterSound",e[e.ImpactLandSound=36]="ImpactLandSound",e[e.BombTickingSound=37]="BombTickingSound",e[e.ChronoInSound=38]="ChronoInSound",e[e.ChronoOutSound=39]="ChronoOutSound",e[e.BombAttachSound=40]="BombAttachSound",e[e.YuriMindControlSound=41]="YuriMindControlSound",e[e.DigSound=42]="DigSound",e[e.CloakSound=43]="CloakSound",e[e.SellSound=44]="SellSound",e[e.GameClosed=45]="GameClosed",e[e.IncomingMessage=46]="IncomingMessage",e[e.MessageCharTyped=47]="MessageCharTyped",e[e.SystemError=48]="SystemError",e[e.OptionsChanged=49]="OptionsChanged",e[e.GameForming=50]="GameForming",e[e.PlayerLeft=51]="PlayerLeft",e[e.PlayerJoined=52]="PlayerJoined",e[e.Construction=53]="Construction",e[e.BuildingDieSound=54]="BuildingDieSound",e[e.BuildingSlam=55]="BuildingSlam",e[e.RadarOn=56]="RadarOn",e[e.RadarOff=57]="RadarOff",e[e.MovieOn=58]="MovieOn",e[e.MovieOff=59]="MovieOff",e[e.ScoldSound=60]="ScoldSound",e[e.TeslaCharge=61]="TeslaCharge",e[e.TeslaZap=62]="TeslaZap",e[e.BuildingDamageSound=63]="BuildingDamageSound",e[e.ChuteSound=64]="ChuteSound",e[e.GenericClick=65]="GenericClick",e[e.GenericBeep=66]="GenericBeep",e[e.BuildingDrop=67]="BuildingDrop",e[e.StopSound=68]="StopSound",e[e.GuardSound=69]="GuardSound",e[e.ScatterSound=70]="ScatterSound",e[e.DeploySound=71]="DeploySound",e[e.StormSound=72]="StormSound",e[e.LightningSounds=73]="LightningSounds",e[e.ShellButtonSlideSound=74]="ShellButtonSlideSound",e[e.QuickMatchTimer=75]="QuickMatchTimer",t("SoundKey",i)}}}),System.register("engine/sound/SoundSpec",["engine/sound/SoundSpecs"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("SoundSpec",i=class{read(e,t){let i=e.getNumber("Range",t.range);var r;return-2===i&&(i=Number.POSITIVE_INFINITY),this.name=e.name,this.control=new Set(e.getEnumArray("Control",s.SoundControl,/\s+/,[],!0)),this.sounds=e.getArray("Sounds",/\s+/).map(e=>e.replace(/^\$/,"")),this.volume=e.has("Volume")?e.getNumber("Volume",t.volume):e.getNumber("volume",t.volume),this.delay=this.createMinMaxPair(e.getNumberArray("Delay",/\s+/,[])),this.priority=e.getEnum("Priority",s.SoundPriority,t.priority,!0),this.type=e.getEnumArray("Type",s.SoundType,/\s+/,t.type,!0),this.type.some(e=>[s.SoundType.Screen,s.SoundType.Local,s.SoundType.Global].includes(e))||(r=t.type.find(e=>[s.SoundType.Screen,s.SoundType.Local,s.SoundType.Global].includes(e)))&&this.type.push(r),this.fShift=this.createMinMaxPair(e.getNumberArray("FShift",/\s+/,[])),this.limit=e.getNumber("Limit",t.limit),this.loop=e.getNumber("Loop"),this.range=i,this.minVolume=e.getNumber("MinVolume",t.minVolume),this.vShift=this.createMinMaxPair(e.getNumberArray(e.has("Vshift")?"Vshift":"VShift",/\s+/,[])),this.attack=e.getNumber("Attack"),this.decay=e.getNumber("Decay"),this}createMinMaxPair(i){if(i.length){let[e,t]=i;return void 0===t&&(t=e),{min:e,max:t}}}})}}}),System.register("engine/sound/SoundSpecs",["engine/sound/SoundSpec"],function(t,e){"use strict";var s,a,n,i,r;e&&e.id;return{setters:[function(e){s=e}],execute:function(){var e;(e=a=a||{})[e.Global=0]="Global",e[e.Normal=1]="Normal",e[e.Screen=2]="Screen",e[e.Local=3]="Local",e[e.Player=4]="Player",e[e.Unshroud=5]="Unshroud",e[e.Shroud=6]="Shroud",t("SoundType",a),(e=n=n||{})[e.Lowest=0]="Lowest",e[e.Low=1]="Low",e[e.Normal=2]="Normal",e[e.High=3]="High",e[e.Critical=4]="Critical",t("SoundPriority",n),(e=i=i||{})[e.All=0]="All",e[e.Loop=1]="Loop",e[e.Random=2]="Random",e[e.Predelay=3]="Predelay",e[e.Interrupt=4]="Interrupt",e[e.Attack=5]="Attack",e[e.Decay=6]="Decay",e[e.Ambient=7]="Ambient",t("SoundControl",i),t("SoundSpecs",r=class{constructor(e){this.ini=e,this.specs=new Map,this.parse()}parse(){let t=this.ini.getSection("Defaults");if(t){this.defaults={minVolume:t.getNumber("MinVolume"),range:t.getNumber("Range"),volume:t.getNumber("Volume"),limit:t.getNumber("Limit"),type:t.getEnumArray("Type",a,/\s+/,[],!0),priority:t.getEnum("Priority",n,n.Normal,!0)};let e=this.ini.getSection("SoundList");var i,r;if(e)for(i of new Set(e.entries.values()))i&&((r=this.ini.getSection(i))?this.specs.set(i,(new s.SoundSpec).read(r,this.defaults)):console.warn(`Missing sound section [${i}]`));else console.warn("Missing sound [SoundList] section. Sounds will not be played.")}else console.warn("Missing sound [Defaults] section. Sounds will not be played.")}getSpec(e){return this.specs.get(e)}getAll(){return[...this.specs.values()]}})}}}),System.register("engine/sound/Sound",["engine/sound/ChannelType","engine/sound/SoundKey","engine/sound/SoundSpecs","util/math","util/typeGuard"],function(e,t){"use strict";var a,n,g,p,m,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("Sound",i=class{constructor(e,t,i,r,s){this.audioSystem=e,this.audioFiles=t,this.soundSpecs=i,this.audioVisualRules=r,this.document=s,this.playbackHandles=new Map,this.handleClick=e=>{let t=e.target;t.matches("button, .menu-button:not(.disabled)")?this.play(n.SoundKey.GUIMainButtonSound,a.ChannelType.Ui):t.matches(".list-item")?this.play(n.SoundKey.GenericClick,a.ChannelType.Ui):t instanceof HTMLInputElement&&["checkbox","radio","range"].includes(t.type)&&!t.disabled?this.play(n.SoundKey.GUICheckboxSound,a.ChannelType.Ui):(t instanceof HTMLSelectElement&&!t.disabled||t.matches(".select:not(.disabled) *"))&&this.play(n.SoundKey.GUIComboOpenSound,a.ChannelType.Ui)}}initialize(){this.audioSystem.initialize(),this.document.addEventListener("click",this.handleClick)}dispose(){this.audioSystem.dispose(),this.document.removeEventListener("click",this.handleClick)}getSoundKey(e){let t;if("string"==typeof n.SoundKey[e]){if(t=this.audioVisualRules.ini.getString(n.SoundKey[e]),!t)return}else t=e;return t}getSoundSpec(e){var t=this.getSoundKey(e);if(t){var i=this.soundSpecs.getSpec(t);if(i)return i;console.warn(`Sound "${t}" is not defined`)}else console.warn(`No sound is defined for key "${n.SoundKey[e]}"`)}play(e,t){let i=this.getSoundSpec(e);if(i){var r=i.control.has(g.SoundControl.Loop)?i.loop||Number.POSITIVE_INFINITY:0;return this.playWithOptions(i,t,i.volume/100,0,i.limit,r)}}playWithOptions(r,s,a,n,t,o){if(r.sounds.length){this.cleanOldHandles();let e=this.playbackHandles.get(r.name);if(e||(e=[],this.playbackHandles.set(r.name,e)),t&&e.length>=t){if(!r.control.has(g.SoundControl.Interrupt))return;e.shift().stop()}var l=1+(r.fShift?p.getRandomInt(r.fShift.min,r.fShift.max)/100:0);let i;var c=r.control.has(g.SoundControl.Attack),h=r.control.has(g.SoundControl.Decay);if(o&&(1<r.sounds.length||o!==Number.POSITIVE_INFINITY||r.delay)){let e=this.buildAttackDecaySequence(r,c,h,!0);var u=e.map(e=>this.getWavFile(e)).filter(m.isNotNullOrUndefined);i=this.audioSystem.playWavLoop(u,s,a,n,r.delay,l,c,h,o)}else{let t=0;if(r.delay&&(t=p.getRandomInt(r.delay.min,r.delay.max)),c||h){let e=this.buildAttackDecaySequence(r,c,h,!1);var d=e.map(e=>this.getWavFile(e)).filter(m.isNotNullOrUndefined);i=this.audioSystem.playWavSequence(d,s,a,n,t,l)}else{let e;e=r.control.has(g.SoundControl.Random)?r.sounds[p.getRandomInt(0,r.sounds.length-1)]:r.sounds[0];d=this.getWavFile(e);if(!d)return;i=this.audioSystem.playWavFile(d,s,a,n,t,l,0!==o)}}return i&&e.push(i),i}}buildAttackDecaySequence(e,t,i,r){var s=t?e.attack||1:0,a=i?e.decay||1:0,n=e.sounds.slice(s,e.sounds.length-a);let o=[];return 0<s&&(s=e.sounds[p.getRandomInt(0,s-1)],o.push(s)),r?o.push(...n):o.push(n[p.getRandomInt(0,n.length-1)]),0<a&&(a=e.sounds[p.getRandomInt(e.sounds.length-a,e.sounds.length-1)],o.push(a)),o}getWavFile(e){var t=e+".wav",i=this.audioFiles.get(t);if(i)return i;console.error(`Audio file "${t}" not found.`)}cleanOldHandles(){for(var[e,t]of this.playbackHandles)t=t.filter(e=>e.isPlaying()),this.playbackHandles.set(e,t)}})}}}),System.register("engine/util/WorldViewportHelper",["engine/IsoCoords"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("WorldViewportHelper",i=class{constructor(e){this.scene=e}distanceToViewport(e){var t=this.scene.viewport,t=new THREE.Box2(new THREE.Vector2(t.x,t.y),new THREE.Vector2(t.x+t.width-1,t.x+t.height-1));return this.distanceToScreenBox(e,t)}distanceToScreenBox(e,t){var i=a.IsoCoords.vecWorldToScreen(e),r=a.IsoCoords.worldToScreen(0,0),s=this.scene.cameraPan.getPan();return t.distanceToPoint(new THREE.Vector2(i.x-r.x-s.x+this.scene.viewport.width/2,i.y-r.y-s.y+this.scene.viewport.height/2))}distanceToViewportCenter(e){var t=a.IsoCoords.vecWorldToScreen(e),i=a.IsoCoords.worldToScreen(0,0),r=this.scene.cameraPan.getPan(),s=this.scene.viewport;return new THREE.Vector2(t.x-i.x-r.x+this.scene.viewport.width/2,t.y-i.y-r.y+this.scene.viewport.height/2).sub(new THREE.Vector2(s.x+s.width/2,s.y+s.height/2))}intersectsScreenBox(e,t){return 0===this.distanceToScreenBox(e,t)}})}}}),System.register("engine/util/MapTileIntersectHelper",["util/geometry","game/Coords","engine/IsoCoords"],function(e,t){"use strict";var i,f,y,r;t&&t.id;return{setters:[function(e){i=e},function(e){f=e},function(e){y=e}],execute:function(){e("MapTileIntersectHelper",r=class{constructor(e,t){this.map=e,this.scene=t}getTileAtScreenPoint(e){var t=this.scene.viewport;if(i.rectContainsPoint(t,e)){t=this.intersectTilesByScreenPos(e);return t.length?t[0]:void 0}}intersectTilesByScreenPos(e){var t=y.IsoCoords.worldToScreen(0,0),i=this.scene.cameraPan.getPan(),t={x:e.x+t.x+i.x-this.scene.viewport.width/2,y:e.y+t.y+i.y-this.scene.viewport.height/2},i=y.IsoCoords.screenToWorld(t.x,t.y),i=new THREE.Vector2(i.x,i.y).multiplyScalar(1/f.Coords.LEPTONS_PER_TILE).floor(),r=this.map.tiles.getByMapCoords(i.x,i.y);if(!r)return console.warn(`Tile coordinates (${i.x},${i.y}) out of range`),[];let s=[];var a;for(let m=0;m<30;m++)for(a of[{x:r.rx+m,y:r.ry+m},{x:r.rx+m+1,y:r.ry+m},{x:r.rx+m,y:r.ry+m+1}]){var n={x:a.x,y:a.y},n=this.map.tiles.getByMapCoords(n.x,n.y);n&&s.push(n)}let o=[],l=new THREE.Triangle;var c,h=new THREE.Vector3(t.x,0,t.y);for(c of s){var u=y.IsoCoords.tile3dToScreen(c.rx,c.ry,c.z),d=y.IsoCoords.tile3dToScreen(c.rx,c.ry+1.1,c.z),g=y.IsoCoords.tile3dToScreen(c.rx+1.1,c.ry,c.z),p=y.IsoCoords.tile3dToScreen(c.rx+1.1,c.ry+1.1,c.z);l.b.x=d.x,l.b.z=d.y,l.c.x=g.x,l.c.z=g.y,l.a.x=u.x,l.a.z=u.y;u=l.containsPoint(h);l.a.x=p.x,l.a.z=p.y;p=l.containsPoint(h);(u||p)&&o.unshift(c)}for(;!o.length;)o=this.intersectTilesByScreenPos({x:e.x,y:e.y-y.IsoCoords.tileHeightToScreen(1)});return o}})}}}),System.register("engine/sound/WorldSound",["engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/SoundSpecs","util/math","util/geometry","game/map/MapShroud","game/Coords","util/typeGuard"],function(e,t){"use strict";var i,g,p,c,l,h,u,d,m;t&&t.id;return{setters:[function(e){i=e},function(e){g=e},function(e){p=e},function(e){c=e},function(e){l=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("WorldSound",m=class m{constructor(e,t,i,r,s,a,n,o){this.sound=e,this.localPlayer=t,this.shroud=i,this.worldViewportHelper=r,this.mapTileIntersectHelper=s,this.world=a,this.worldScene=n,this.renderer=o,this.soundInstances=[],this.handleObjectRemoved=t=>{this.soundInstances.forEach(e=>{e.gameObject===t&&e.handle.stop()})},this.handleFrame=e=>{let t=!1;this.lastViewport&&l.rectEquals(this.worldScene.viewport,this.lastViewport)||(this.lastViewport=this.worldScene.viewport,t=!0);(!this.lastUpdate||200<=e-this.lastUpdate)&&(t=!0),t&&(this.update(),this.lastUpdate=e)},this.noShroudSpecs=m.noShroudKeys.map(e=>{var t=this.sound.getSoundSpec(e);if(t)return t;console.warn(`Sound key "${e}" doesn't have a corresponding sound.ini entry`)}).filter(d.isNotNullOrUndefined)}init(){this.renderer.onFrame.subscribe(this.handleFrame),this.world.onObjectRemoved.subscribe(this.handleObjectRemoved)}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.world.onObjectRemoved.unsubscribe(this.handleObjectRemoved),this.soundInstances.forEach(e=>e.handle.stop())}update(){var e=this.mapTileIntersectHelper.getTileAtScreenPoint({x:this.worldScene.viewport.x+this.worldScene.viewport.width/2,y:this.worldScene.viewport.y+this.worldScene.viewport.height/2});if(e){this.tileAtViewportCenter=e,this.cleanOldInstances();let i=new Map;for(var r of this.soundInstances){var s=r.gameObject?.position.worldPosition??r.worldPos;let{volume:e,pan:t}=this.computeVolumeAndPan(r.spec,s,r.player,r.gain);0<e&&(s=i.get(r.spec)??0,r.loop&&s>=r.spec.limit?e=0:i.set(r.spec,s+1)),r.handle.setVolume(e),r.handle.setPan(t),r.volume=e}}else console.warn("No tile found at viewport center. Can't update local sound positions.")}cleanOldInstances(){this.soundInstances=this.soundInstances.filter(e=>e.handle.isPlaying())}playEffect(e,a,n,o=1,l){let c=this.sound.getSoundSpec(e);if(c&&(!c.type.includes(p.SoundType.Player)||n===this.localPlayer)){let e,t;a.position?(e=a.position.worldPosition,t=a):e=a;var h=c.control.has(p.SoundControl.Loop)||c.control.has(p.SoundControl.Ambient),u=h?c.loop||Number.POSITIVE_INFINITY:0;h&&void 0!==l&&(o=l);let{volume:i,pan:r}=this.computeVolumeAndPan(c,e,n,o),s=c.limit;if(h&&c.limit&&(s=0,this.cleanOldInstances(),this.soundInstances.filter(e=>e.spec===c&&0<e.volume).length>=c.limit&&(i=0)),h||i||!c.limit){var d=c.control.has(p.SoundControl.Ambient)||c.name.startsWith("_Amb_")?g.ChannelType.Ambient:g.ChannelType.Effect,u=this.sound.playWithOptions(c,d,i,r,s,u);return u&&this.soundInstances.push({spec:c,gameObject:t,worldPos:e,player:n,handle:u,gain:o,volume:i,loop:h}),u}}}computeVolumeAndPan(e,t,i,r=1){let s=e.volume/100,a=0;var n,o,l;return e.type.includes(p.SoundType.Global)&&i!==this.localPlayer&&(s=e.minVolume/100),s*=r,(e.type.includes(p.SoundType.Screen)||e.type.includes(p.SoundType.Global))&&(n=this.worldViewportHelper.distanceToViewportCenter(t),a=c.clamp(n.x/(this.worldScene.viewport.width/2),-1,1)),e.type.includes(p.SoundType.Screen)?(o=this.worldViewportHelper.distanceToViewport(t),l=(this.worldScene.viewport.height+this.worldScene.viewport.width)/2/3,s*=THREE.Math.lerp(1,0,Math.min(1,o/l))):e.type.includes(p.SoundType.Local)&&(this.tileAtViewportCenter?(o=new THREE.Vector2(t.x/u.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.rx,t.z/u.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.ry).length(),(l=e.range*Math.SQRT2)<o?s=0:(e.vShift&&(s*=c.getRandomInt(e.vShift.min,e.vShift.max)/100),s*=1-Math.min(1,(o/l)**2))):s=0),this.noShroudSpecs.includes(e)&&!e.type.includes(p.SoundType.Global)&&this.shroud?.getShroudTypeByTileCoords(Math.floor(t.x/u.Coords.LEPTONS_PER_TILE),Math.floor(t.z/u.Coords.LEPTONS_PER_TILE),Math.floor(u.Coords.worldToTileHeight(t.y)))===h.ShroudType.Unexplored&&(s=0),{volume:s,pan:a}}}),m.noShroudKeys=[i.SoundKey.BuildingSlam,i.SoundKey.SellSound,i.SoundKey.BuildingGarrisonedSound,i.SoundKey.BuildingRepairedSound,i.SoundKey.SpySatActivationSound,i.SoundKey.SpySatDeactivationSound]}}}),System.register("engine/gfx/MathUtils",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MathUtils",i=class{static rotateObjectAboutPoint(e,t,i,r,s=!1){(s=void 0!==s&&s)&&e.parent.localToWorld(e.position),e.position.sub(t),e.position.applyAxisAngle(i,r),e.position.add(t),s&&e.parent.worldToLocal(e.position),e.rotateOnAxis(i,r)}static translateTowardsCamera(e,t,i){var r=(new THREE.Quaternion).setFromEuler(t.rotation);e.setRotationFromQuaternion(r),e.translateZ(i*Math.cos(t.rotation.y)),e.setRotationFromEuler(new THREE.Euler(0,0,0))}})}}}),System.register("engine/renderable/entity/Anim",["engine/renderable/WithPosition","engine/AnimProps","engine/Animation","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/animation/SimpleRunner","engine/gfx/MathUtils","game/Coords"],function(e,t){"use strict";var d,s,a,n,o,l,c,h,u,g,i;t&&t.id;return{setters:[function(e){d=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){g=e}],execute:function(){e("Anim",i=class{constructor(e,t,i,r,s,a,n,o,l,c=new THREE.Vector3(0,0,0),h,u){this.objectArt=t,this.extraOffset=i,this.imageFinder=r,this.theater=s,this.camera=a,this.debugFrame=n,this.gameSpeed=o,this.useSpriteBatching=l,this.extraLight=c,this.worldSound=h,this.renderOrder=0,this.name=e,this.palette=u??this.theater.getPalette(this.objectArt.paletteType,this.objectArt.customPaletteName),this.withPosition=new d.WithPosition}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="anim_"+this.name,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(t){if(this.animationRunner){var i=this.objectArt.startSound??this.objectArt.report;i&&!this.soundHandle&&this.animation?.getState()===a.AnimationState.NOT_STARTED&&(this.soundHandle=this.worldSound?.playEffect(i,this.withPosition.getPosition(),void 0,1,.25)),this.animationRunner.tick(t);let e=this.mainObj.get3DObject();e.visible=this.animation.getState()!==a.AnimationState.DELAYED,this.mainObj.setFrame(this.animationRunner.getCurrentFrame());var r=this.objectArt.translucent,i=this.objectArt.translucency;if(r||0<i){let e;e=r?(r=this.animation.props,1-this.animationRunner.getCurrentFrame()/(r.end-r.start)):1-i,this.mainObj.setOpacity(e)}}}createObjects(e){var t={width:1,height:1};this.debugFrame.value&&(a=l.DebugUtils.createWireframe(t,0),e.add(a));let i=new c.MapSpriteTranslation(t.width,t.height);var{spriteOffset:r,anchorPointWorld:s}=i.compute(),a=this.computeSpriteAnchorOffset(r);let n=new THREE.Object3D;if(n.matrixAutoUpdate=!1,this.mainObj=this.createMainObject(a),this.mainObj){this.mainObj.setExtraLight(this.extraLight);t=this.useSpriteBatching&&!this.renderOrder;this.mainObj.setBatched(t),t&&this.mainObj.setBatchPalettes([this.palette]);r=this.objectArt.translucent,a=this.objectArt.translucency;if((r||0<a)&&this.mainObj.setForceTransparent(!0),this.mainObj.create3DObject(),this.renderOrder){if(t)throw new Error("Render order not supported with batching");this.mainObj.getShapeMesh().renderOrder=this.renderOrder,this.mainObj.getShapeMesh().material.depthTest=!this.renderOrder,this.mainObj.getShapeMesh().material.transparent=!!this.renderOrder}n.add(this.mainObj.get3DObject()),n.position.x=s.x,n.position.z=s.y,this.objectArt.zAdjust&&u.MathUtils.translateTowardsCamera(n,this.camera,-this.objectArt.zAdjust*g.Coords.ISO_WORLD_SCALE),n.updateMatrix(),e.add(n)}}setExtraLight(e){this.extraLight=e,this.mainObj?.setExtraLight(this.extraLight)}setRenderOrder(e){if(this.mainObj)throw new Error("Render order must be set before 3DObject is created");this.renderOrder=e}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x+this.extraOffset.x,y:e.y+t.y+this.extraOffset.y}}createMainObject(e){let t;try{t=this.shpFile=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(e instanceof o.ImageFinder.MissingImageError)return void console.warn(e.message);throw e}let i=n.ShpRenderable.factory(t,this.palette,this.camera,e);i.setFlat(this.objectArt.flat);var r=new s.AnimProps(this.objectArt.art,t);return this.animation=new a.Animation(r,this.gameSpeed),this.animationRunner=new h.SimpleRunner,this.animationRunner.animation=this.animation,i}getAnimProps(){return this.animation?.props}getShpFile(){return this.shpFile}remapColor(e){if(this.mainObj)throw new Error("Palette can only be remapped before creating 3DObject");let t=this.palette.clone();t.remap(e),this.palette=t}isAnimFinished(){return this.animation?.getState()===a.AnimationState.STOPPED}isAnimNotStarted(){return this.animation?.getState()===a.AnimationState.NOT_STARTED}endAnimationLoop(){this.animation?.endLoopAndPlayToEnd()}reset(){this.animation?.reset()}dispose(){this.mainObj?.dispose(),this.soundHandle?.isLoop&&this.soundHandle.stop()}})}}}),System.register("engine/renderable/fx/Effect",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/renderable/fx/RallyPointFx",["three.meshline","game/Coords"],function(e,t){"use strict";var s,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e}],execute:function(){e("RallyPointFx",i=class{constructor(e,t,i,r,s){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.renderOrder=s,this.needsUpdate=!1,this.visible=!0,this.cameraHash=this.camera.top+"_"+this.camera.right}setContainer(e){this.container=e}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.matrixAutoUpdate=!1,this.lineMesh=this.createLineMesh(),this.lineMesh.name="fx_rallypoint",this.lineMesh.matrixAutoUpdate=!1,this.shadowLineMesh=this.createLineShadowMesh(),this.shadowLineMesh.name="fx_rallypoint_shadow",this.shadowLineMesh.matrixAutoUpdate=!1,this.wrapper.add(this.lineMesh),this.wrapper.add(this.shadowLineMesh))}update(e){this.lastUpdateMillis||(this.lastUpdateMillis=e);let i=(e-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=e,this.wrapper.visible=this.visible;var t=this.camera.top+"_"+this.camera.right;if(t!==this.cameraHash&&(this.cameraHash=t,[this.lineMesh,this.shadowLineMesh].forEach(e=>{e.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))})),this.needsUpdate){this.needsUpdate=!1,this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),this.shadowLineMesh.geometry=this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.lineMesh.material.uniforms.color.value=this.color.clone();let i=this.sourcePos.distanceTo(this.targetPos);[this.lineMesh,this.shadowLineMesh].forEach(e=>{let t=e.material;t.uniforms.dashArray.value=this.computeDashArray(i),t.depthTest=void 0===this.renderOrder}),this.lineMesh.renderOrder=this.renderOrder??0,this.shadowLineMesh.renderOrder=void 0!==this.renderOrder?this.renderOrder-1:0}[this.lineMesh,this.shadowLineMesh].forEach(e=>{let t=e.material;t.uniforms.dashOffset.value-=t.uniforms.dashArray.value/50*i})}createLineMesh(){let e=this.sourcePos.clone();var t=this.targetPos.clone();let i=new THREE.Mesh(this.createLineGeometry(e,t),this.createLineMaterial(this.color.clone(),e.distanceTo(t)));return this.renderOrder&&(i.renderOrder=this.renderOrder),i}createLineShadowMesh(){let e=new THREE.Mesh(this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.createLineMaterial(new THREE.Color(0),this.sourcePos.distanceTo(this.targetPos)));return this.renderOrder&&(e.renderOrder=this.renderOrder-1),e}createShadowLineGeometry(e,t){var i=new THREE.Vector3(+a.Coords.ISO_WORLD_SCALE,0,+a.Coords.ISO_WORLD_SCALE);return this.createLineGeometry(e.clone().add(i),t.clone().add(i))}createLineGeometry(e,t){let i=new THREE.Geometry;i.vertices.push(e,t);let r=new s.MeshLine;return r.setGeometry(i),r.geometry}createLineMaterial(e,t){return new s.MeshLineMaterial({color:e,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(t),depthTest:void 0===this.renderOrder})}computeDashArray(e){return Math.min(1,5/e)*a.Coords.ISO_WORLD_SCALE}computeResolution(e){var t=e.top,i=e.right/e.top,r=2*t/Math.cos(e.rotation.y);return new THREE.Vector2(r*i,r).multiplyScalar(t*Math.cos(this.camera.rotation.x)/a.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&[this.lineMesh,this.shadowLineMesh].forEach(e=>{e&&(e.geometry.dispose(),e.material.dispose())})}})}}}),System.register("engine/renderable/entity/unit/FlyerHelperMode",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Always=0]="Always",e[e.Selected=1]="Selected",e[e.Never=2]="Never",t("FlyerHelperMode",i)}}}),System.register("engine/renderable/entity/unit/DebugLabel",["engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/Coords"],function(e,t){"use strict";var s,h,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){h=e},function(e){a=e}],execute:function(){e("DebugLabel",i=class{constructor(e,t,i){this.text=e,this.color=t,this.camera=i}get3DObject(){return this.mesh}create3DObject(){if(!this.mesh){let e=new THREE.Color(this.color);var t=.5<.299*e.r+.587*e.g+.114*e.b?"black":"white",t=this.texture=this.createTexture(this.text,"#"+e.getHexString(),t);this.mesh=this.createMesh(t)}}createMesh(e){var t=s.SpriteUtils.createSpriteGeometry({texture:e,camera:this.camera,align:{x:0,y:-1},offset:{x:0,y:a.Coords.ISO_TILE_SIZE/4},scale:a.Coords.ISO_WORLD_SCALE}),i=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,depthTest:!1,flatShading:!0});let r=new THREE.Mesh(t,i);return r.matrixAutoUpdate=!1,r}createTexture(e,t,i){let r=document.createElement("canvas");r.width=r.height=0;let s=r.getContext("2d"),a=0;for(var n of e.split("\n")){n=h.CanvasUtils.drawText(s,n,0,a,{color:t,outlineColor:i,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:10,fontWeight:"400",paddingTop:3,paddingBottom:3,paddingLeft:3,paddingRight:3,autoEnlargeCanvas:!0});a+=n.height}var o=r.width,l=r.height,l=s.getImageData(0,0,o,l);r.width+=1,r.height+=1,s.putImageData(l,1,1);let c=new THREE.Texture(r);return c.minFilter=THREE.NearestFilter,c.magFilter=THREE.NearestFilter,c.needsUpdate=!0,c.flipY=!0,c}update(){}dispose(){this.texture?.dispose(),this.mesh?.material?.dispose(),this.mesh?.geometry.dispose()}})}}}),System.register("engine/renderable/entity/PipOverlay",["engine/gfx/TextureAtlas","data/Bitmap","engine/gfx/SpriteUtils","game/Coords","engine/gfx/TextureUtils","game/gameobject/selection/SelectionLevel","game/type/PipColor","util/disposable/CompositeDisposable","engine/gfx/OverlayUtils","engine/renderable/fx/RallyPointFx","engine/renderable/entity/unit/FlyerHelperMode","game/gameobject/unit/ZoneType","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh","game/gameobject/unit/HealthLevel","engine/renderable/entity/unit/DebugLabel"],function(e,t){"use strict";var i,d,g,p,m,a,h,f,r,s,n,o,y,T,v,b,l,S,w,c,u,C,E,x;t&&t.id;return{setters:[function(e){i=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){a=e},function(e){h=e},function(e){f=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){o=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){l=e}],execute:function(){S=-1,c={width:8,height:11},u=w=1,C={[0]:a.SelectionLevel.Hover,2:a.SelectionLevel.Selected,1:a.SelectionLevel.Hover,3:a.SelectionLevel.Hover,4:a.SelectionLevel.Selected,5:a.SelectionLevel.Selected},E=(new Map).set(b.HealthLevel.Green,15).set(b.HealthLevel.Yellow,16).set(b.HealthLevel.Red,17),e("PipOverlay",x=class x{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m){this.paradropRules=e,this.audioVisualRules=t,this.gameObject=i,this.viewer=r,this.alliances=s,this.selectionModel=a,this.imageFinder=n,this.palette=o,this.camera=l,this.strings=c,this.flyerHelperOpt=h,this.hiddenObjectsOpt=u,this.debugTextEnabled=d,this.animFactory=g,this.useSpriteBatching=p,this.useMeshInstancing=m,this.lastPrimaryFactory=!1,this.invalidatedElements=[],this.disposables=new f.CompositeDisposable}static clearCaches(){x.atlasCache?.dispose(),x.atlasCache=void 0,x.atlasImageHandles.clear(),[...x.unitHealthTextures.values()].forEach(e=>e.dispose()),x.unitHealthTextures.clear(),x.unitHealthMaterials.forEach(e=>e.dispose()),x.unitHealthMaterials.clear(),[...x.controlGroupTextures.values()].forEach(e=>e.dispose()),x.controlGroupTextures.clear(),x.controlGroupMaterials.forEach(e=>e.dispose()),x.controlGroupMaterials.clear(),[...x.primaryFactoryTextures.values()].forEach(e=>e.dispose()),x.primaryFactoryTextures.clear(),x.primaryFactoryMaterials.forEach(e=>e.dispose()),x.primaryFactoryMaterials.clear()}create3DObject(){let t=this.rootObj;if(!t){var e;if(t=new THREE.Object3D,t.name="pip_overlay",t.matrixAutoUpdate=!1,x.atlasCache||(e=this.initTexture(),x.atlasCache=e,[...x.atlasImageHandles.keys()].forEach(e=>{var t=g.SpriteUtils.createSpriteGeometry(this.buildSpriteGeometry(e));x.geometries.set(e,t)}),x.material=new T.PaletteBasicMaterial({map:x.atlasCache.getTexture(),palette:m.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1})),this.gameObject.isBuilding()){this.healthBar=this.createBuildingHealthBar(this.gameObject),t.add(this.healthBar),1<=this.gameObject.art.height&&(r=this.selectionBox=this.createBuildingSelectionBox(this.gameObject),t.add(r));var i=this.createBuildingOccupationInfo(this.gameObject);i&&(t.add(i),this.pipsSprite=i),this.lastPipsDataKey=this.gameObject.garrisonTrait?.units.length}else{var{healthBarWrapper:r,selectionBox:i}=this.createUnitHealthBar(this.gameObject);if(this.healthBar=r,this.selectionBox=i,t.add(this.healthBar),this.gameObject.art.isVoxel&&(this.gameObject.rules.consideredAircraft||this.gameObject.isAircraft())&&!this.gameObject.rules.missileSpawn){let e=this.animFactory(this.audioVisualRules.flyerHelper);this.flyHelper=e,e.create3DObject(),t.add(e.get3DObject())}if(this.gameObject.isUnit()){let e=this.animFactory(this.audioVisualRules.behind);e.setRenderOrder(999995),this.behindAnim=e}}if(this.gameObject.debugLabel&&this.debugTextEnabled.value){let e=new l.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=e,e.create3DObject(),e.get3DObject().renderOrder=999999,t.add(e.get3DObject())}this.lastHealth=this.gameObject.healthTrait.health,this.lastOwner=this.gameObject.owner,this.rootObj=t}}onCreate(e){this.gameObject.isBuilding()&&this.gameObject.rallyTrait&&(this.rallyLine=new s.RallyPointFx(this.camera,new THREE.Vector3,new THREE.Vector3,new THREE.Color,999999),this.rallyLine.visible=!1,e.addEffect(this.rallyLine),this.disposables.add(()=>this.rallyLine.remove(),this.rallyLine))}initTexture(){x.pipBrdFile=this.imageFinder.find("pipbrd",!1),x.pipsFile=this.imageFinder.find("pips",!1),x.pips2File=this.imageFinder.find("pips2",!1);let e=[x.pipBrdFile,x.pipsFile,x.pips2File],s=[];e.forEach(e=>{for(let r=0;r<e.numImages;r++){var t=e.getImage(r),i=new d.IndexedBitmap(t.width,t.height,t.imageData);s.push(i),x.atlasImageHandles.set(t,{bitmap:i,shpFile:e})}});let t=new i.TextureAtlas;return t.pack(s),t}buildSpriteGeometry(e){if(!x.atlasCache)throw new Error("Must build texture atlas before geometry");let t=x.atlasCache;var{bitmap:i,shpFile:r}=x.atlasImageHandles.get(e);return{texture:t.getTexture(),textureArea:t.getImageRect(i),align:{x:1,y:-1},offset:{x:e.x-Math.floor(r.width/2),y:e.y-Math.floor(r.height/2)},camera:this.camera,scale:p.Coords.ISO_WORLD_SCALE}}createBuildingHealthBar(e){var r=e.art.foundation.height,t=e.healthTrait.health,s=4*p.Coords.ISO_WORLD_SCALE,a=Math.floor(r*p.Coords.getWorldTileSize()/s),n=Math.max(1,Math.floor(t/100*a));let o;o=t>100*this.audioVisualRules.conditionYellow?1:t>100*this.audioVisualRules.conditionRed?2:4;r=o+"_"+r+"_"+n;let l=x.buildingHealthGeoCache.get(r);if(!l){let t=[];var c=x.pipsFile.getImage(0),h=x.pipsFile.getImage(o);for(let i=0;i<a;i++){var u=i<n?h:c;let e=x.geometries.get(u).clone();u=s*i+s/2;e.applyMatrix((new THREE.Matrix4).makeTranslation(s,0,u)),t.push(e)}l=y.BufferGeometryUtils.mergeBufferGeometries(t),x.buildingHealthGeoCache.set(r,l)}let i=this.useMeshInstancing?new v.BatchedMesh(l,x.material,v.BatchMode.Instancing):new THREE.Mesh(l,x.material);i.matrixAutoUpdate=!1,i.renderOrder=999999;r=e.art.height||.5;return i.position.y=p.Coords.tileHeightToWorld(r),i.updateMatrix(),i}createUnitHealthBar(e){var t=!e.isInfantry(),i=e.healthTrait.health,r=e.healthTrait.level;let s=x.unitHealthTextures.get(t);s||(s=this.createUnitHealthTexture(t),x.unitHealthTextures.set(t,s));var a=x.pipBrdFile.getImage(t?0:1),n=E.get(r);if(void 0===n)throw new Error(`Unhandled health level "${r}"`);n=x.pipsFile.getImage(n),n=Math.floor((a.width-2*w)/n.width),i=Math.max(1,Math.floor(i/100*n)),n=(t?1:0)+"_"+i;let o=x.unitHealthGeoCache.get(n);o||(o=g.SpriteUtils.createSpriteGeometry({texture:s,textureArea:{x:0,y:(i-1)*a.height,width:a.width,height:a.height},camera:this.camera,align:{x:0,y:0},scale:p.Coords.ISO_WORLD_SCALE}),x.unitHealthGeoCache.set(n,o));let l=x.unitHealthMaterials.get(t);l||(l=new T.PaletteBasicMaterial({map:s,palette:m.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1}),x.unitHealthMaterials.set(t,l));let c=this.useSpriteBatching?new v.BatchedMesh(o,l,v.BatchMode.Merging):new THREE.Mesh(o,l);c.matrixAutoUpdate=!1,c.renderOrder=999998;t=p.Coords.screenDistanceToWorld(Math.floor(a.width/2)+S,0);c.applyMatrix((new THREE.Matrix4).makeTranslation(t.x,0,t.y)),c.updateMatrix();t=x.geometries.get(a);let h=this.useSpriteBatching?new v.BatchedMesh(t,x.material,v.BatchMode.Merging):new THREE.Mesh(t,x.material);h.matrixAutoUpdate=!1;t=p.Coords.screenDistanceToWorld(Math.floor(x.pipBrdFile.getImage(0).width/2)+S,0);h.applyMatrix((new THREE.Matrix4).makeTranslation(t.x,0,t.y)),h.updateMatrix(),h.renderOrder=999997;let u=new THREE.Object3D;u.matrixAutoUpdate=!1,u.add(h),u.add(c);a=p.Coords.screenDistanceToWorld(-Math.floor(a.width/2),0);return u.applyMatrix((new THREE.Matrix4).makeTranslation(a.x,p.Coords.tileHeightToWorld(2),a.y)),u.updateMatrix(),{healthBarWrapper:u,selectionBox:h}}createUnitHealthTexture(e){var i=x.pipBrdFile.getImage(e?0:1),t=x.pipsFile.getImage(E.values().next().value).width,r=Math.floor((i.width-2*w)/t);let s=new d.IndexedBitmap(i.width,i.height*r);for(let u=1;u<=r;++u){var a=u/r*100;let e;e=a>100*this.audioVisualRules.conditionYellow?b.HealthLevel.Green:a>100*this.audioVisualRules.conditionRed?b.HealthLevel.Yellow:b.HealthLevel.Red;a=E.get(e);if(void 0===a)throw new Error(`Unhandled health level "${e}"`);var n=x.pipsFile.getImage(a),o=new d.IndexedBitmap(n.width,n.height,n.imageData),l=(u-1)*i.height;for(let t=0;t<u;t++){var c=n.width*t;s.drawIndexedImage(o,c+w,l+w)}}let h=new THREE.DataTexture(s.data,s.width,s.height,THREE.AlphaFormat);return h.minFilter=THREE.NearestFilter,h.magFilter=THREE.NearestFilter,h.flipY=!0,h.needsUpdate=!0,h}createBuildingSelectionBox(s){let a=new THREE.Object3D;a.matrixAutoUpdate=!1;let n=s.art.foundation,o=p.Coords.getWorldTileSize();return[[0,0],[0,1],[1,1],[1,0]].forEach(([e,t],i)=>{let r=this.createBuildingSelectionCornerMesh();r.matrixAutoUpdate=!1,r.position.set(e*o*n.width,p.Coords.tileHeightToWorld(s.art.height),t*o*n.height),r.rotation.y=i*Math.PI/2,r.scale.set((i%2==0?n.width:n.height)/4*p.Coords.getWorldTileSize(),p.Coords.tileHeightToWorld(s.art.height/4),(i%2==0?n.height:n.width)/4*p.Coords.getWorldTileSize()),r.updateMatrix(),a.add(r)}),a}createBuildingSelectionCornerMesh(){var e=[0,0,0,1,0,0,0,0,0,0,-1,0,0,0,0,0,0,1],t=new Array(e.length).fill(1);let i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(t),3));t=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});return this.disposables.add(i,t),new THREE.LineSegments(i,t)}createBuildingOccupationInfo(r){if(r.garrisonTrait?.units.length&&!this.objectIsOpaqueToViewer()){var s=r.garrisonTrait.units.length,a=r.rules.maxNumberOccupants;let t=[];var n=4*p.Coords.ISO_WORLD_SCALE,o=x.pipsFile.getImage(6),l=x.pipsFile.getImage(7);for(let i=1;i<=a;i++){var c=i<=s?l:o;let e=x.geometries.get(c).clone();c=n*i+n/2;e.applyMatrix((new THREE.Matrix4).makeTranslation(c,0,r.art.foundation.height*p.Coords.getWorldTileSize())),t.push(e)}var h=y.BufferGeometryUtils.mergeBufferGeometries(t);let e=this.useSpriteBatching?new v.BatchedMesh(h,x.material,v.BatchMode.Merging):new THREE.Mesh(h,x.material);return e.matrixAutoUpdate=!1,e.renderOrder=999999,e}}createPipsSprite(s,t,a=!1){if(!this.objectIsOpaqueToViewer()){let i=[];var n=x.pips2File.getImage(a?12:0).width,o=x.pips2File.getImage(a?13:0);for(let r=0;r<t;r++){let t;if(r<s.length){var l=s[r];let e=a?12:3;l===h.PipColor.Blue?e=5:l===h.PipColor.Red?e=4:l===h.PipColor.Yellow&&(e=2),t=x.pips2File.getImage(e)}else t=o;let e=x.geometries.get(t).clone();l=n*r+n/2,l=p.Coords.screenDistanceToWorld(-Math.floor(x.pipBrdFile.getImage(this.gameObject.isInfantry()?1:0).width/2)+l,Math.floor(o.height/2)+3);e.applyMatrix((new THREE.Matrix4).makeTranslation(l.x,0,l.y)),i.push(e)}var c=y.BufferGeometryUtils.mergeBufferGeometries(i);let e=this.useSpriteBatching?new v.BatchedMesh(c,x.material,v.BatchMode.Merging):new THREE.Mesh(c,x.material);return e.renderOrder=999996,e}}createControlGroupTexture(e){let t=document.createElement("canvas"),i=t.getContext("2d",{alpha:!1});var r=u,s=c;t.width=10*(s.width+2*r),t.height=s.height+2*r,i.fillStyle="#000",i.fillRect(0,0,t.width,t.height),i.strokeStyle=e.asHexString(),i.fillStyle=e.asHexString(),i.font="bold 12px Arial, sans-serif";for(let o=0;o<10;o++){var a=(s.width+2*r)*o;i.strokeRect(.5+a,.5,s.width+2*r-1,t.height-1),i.fillText(String(o),a+r+.5,s.height)}let n=new THREE.Texture(t);return n.minFilter=THREE.NearestFilter,n.magFilter=THREE.NearestFilter,n.needsUpdate=!0,n}createControlGroupSprite(e){let t=this.gameObject.owner.color;x.controlGroupTextures.has(t.asHex())||(r=this.createControlGroupTexture(t),x.controlGroupTextures.set(t.asHex(),r));var i=x.controlGroupTextures.get(t.asHex()),r=g.SpriteUtils.createSpriteGeometry({texture:i,textureArea:{x:e*(c.width+2*u),y:0,width:c.width+2*u,height:c.height+2*u},camera:this.camera,align:{x:1,y:-1},scale:p.Coords.ISO_WORLD_SCALE});let s=x.controlGroupMaterials.get(i);s||(s=new THREE.MeshBasicMaterial({map:i,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),x.controlGroupMaterials.set(i,s));let a=this.useSpriteBatching?new v.BatchedMesh(r,s,v.BatchMode.Merging):new THREE.Mesh(r,s);return a.matrixAutoUpdate=!1,a.renderOrder=999996,a}createPrimaryFactoryTexture(e){var t=r.OverlayUtils.createTextBox(this.strings.get("TXT_PRIMARY"),{color:e.asHexString(),borderColor:e.asHexString(),backgroundColor:"#000",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4});let i=new THREE.Texture(t);return i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter,i.needsUpdate=!0,i}createPrimaryFactorySprite(){if(!this.objectIsOpaqueToViewer()){let e=this.gameObject.owner.color;x.primaryFactoryTextures.has(e.asHex())||(s=this.createPrimaryFactoryTexture(e),x.primaryFactoryTextures.set(e.asHex(),s));var r=x.primaryFactoryTextures.get(e.asHex()),s=g.SpriteUtils.createSpriteGeometry({texture:r,camera:this.camera,align:{x:1,y:-1},offset:{x:-Math.floor(r.image.width/2),y:-Math.floor(r.image.height/2)},scale:p.Coords.ISO_WORLD_SCALE});let t=x.primaryFactoryMaterials.get(r);t||(t=new THREE.MeshBasicMaterial({map:r,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),x.primaryFactoryMaterials.set(r,t));let i=this.useSpriteBatching?new v.BatchedMesh(s,t,v.BatchMode.Merging):new THREE.Mesh(s,t);return i.renderOrder=999999,i}}createVeteranIndicator(t){if(t.veteranLevel){var i=x.pipsFile.getImage(13+t.veteranLevel-1),i=x.geometries.get(i);let e=this.useSpriteBatching?new v.BatchedMesh(i,x.material,v.BatchMode.Merging):new THREE.Mesh(i,x.material);return e.matrixAutoUpdate=!1,e.renderOrder=999996,e.receiveShadow=!1,e}}get3DObject(){return this.rootObj}update(e){let t=this.gameObject;if(t.isDestroyed||t.isCrashing)this.rootObj.visible=!1;else{t.healthTrait.health!==this.lastHealth&&(this.lastHealth=t.healthTrait.health,this.invalidatedElements[0]=!0);let i=this.selectionModel.getSelectionLevel();this.invalidatedElements[0]&&(i>=C[0]||i>=C[3])&&(this.invalidatedElements[0]=void 0,this.updateHealthBarSprite(i));var r=this.computePipsDataKey(t);this.lastPipsDataKey===r&&this.lastOwner===t.owner||(this.lastPipsDataKey=r,this.invalidatedElements[1]=!0),this.invalidatedElements[1]&&i>=C[1]&&(this.invalidatedElements[1]=void 0,this.updatePipsSprite());r=this.selectionModel.getControlGroupNumber();this.lastControlGroup!==r&&(this.lastControlGroup=r,this.invalidatedElements[3]=!0),this.invalidatedElements[3]&&i>=C[3]&&(this.invalidatedElements[3]=void 0,this.updateControlGroupSprite(r));r=t.isBuilding()&&!!t.rules.factory&&t.owner.production?.getPrimaryFactory(t.rules.factory)===t;this.lastPrimaryFactory===r&&this.lastOwner===t.owner||(this.lastPrimaryFactory=r,this.invalidatedElements[4]=!0),this.invalidatedElements[4]&&i>=C[4]&&(this.invalidatedElements[4]=void 0,this.updatePrimaryFactorySprite(r));r=t.isBuilding()&&t.rallyTrait?.getRallyPoint()||void 0;if(this.lastRallyPoint===r&&this.lastOwner===t.owner||(this.lastRallyPoint=r,this.invalidatedElements[5]=!0),this.invalidatedElements[5]&&i>=C[5]&&this.rallyLine&&(this.invalidatedElements[5]=void 0,this.updateRallyPointLine(r,this.rallyLine)),t.isBuilding()?(r=!t.autoRepairTrait.isDisabled(),this.lastRepairState!==r&&(this.lastRepairState=r,this.updateRepairWrenchSprite(r))):this.lastVeteranLevel!==t.veteranLevel&&(this.lastVeteranLevel=t.veteranLevel,this.updateVeteranIndicatorSprite(t)),this.updateFlyerHelper(i,e),this.updateBehindAnim(e),this.updateDebugLabel(),void 0===this.lastSelectionLevel||this.lastSelectionLevel!==i){this.lastSelectionLevel=i;let e=new Map([[0,this.healthBar],[2,this.selectionBox],[1,this.pipsSprite],[3,this.controlGroupSprite],[4,this.primaryFactorySprite],[5,this.rallyLine]]);e.forEach((e,t)=>{e&&(e.visible=i>=C[t])})}this.lastOwner=t.owner,this.lastDebugTextEnabled=this.debugTextEnabled.value,this.repairWrench?.update(e)}}updateFlyerHelper(i,r){if(this.flyHelper&&this.gameObject.isUnit()){let e;switch(this.flyerHelperOpt.value){case n.FlyerHelperMode.Never:e=!1;break;case n.FlyerHelperMode.Always:e=!0;break;case n.FlyerHelperMode.Selected:e=i>=a.SelectionLevel.Selected;break;default:e=!1}e=e&&this.gameObject.zone===o.ZoneType.Air;let t=this.flyHelper.get3DObject();var s;t.visible=e,e&&(this.flyHelper.update(r),(s=-p.Coords.tileHeightToWorld(this.gameObject.tileElevation))!==t.position.y&&(t.position.y=s,t.updateMatrix()))}}updateBehindAnim(e){this.behindAnim&&(this.hiddenObjectsOpt.value&&this.gameObject.isSpawned&&this.gameObject.tile.occluded&&this.gameObject.art.canBeHidden&&this.gameObject.zone!==o.ZoneType.Air?(this.behindAnim?.update(e),this.behindAnim.get3DObject()?.parent||(this.behindAnim.create3DObject(),this.rootObj.add(this.behindAnim.get3DObject()),this.behindAnim.get3DObject().updateMatrix())):this.behindAnim.get3DObject()?.parent&&this.rootObj.remove(this.behindAnim.get3DObject()))}updateDebugLabel(){if((this.gameObject.debugLabel!==this.lastDebugLabel||this.gameObject.owner!==this.lastOwner||this.debugTextEnabled.value!==this.lastDebugTextEnabled)&&(this.lastDebugLabel=this.gameObject.debugLabel,this.debugLabel&&(this.rootObj.remove(this.debugLabel.get3DObject()),this.debugLabel.dispose(),this.debugLabel=void 0),this.gameObject.debugLabel&&this.debugTextEnabled.value)){let e=new l.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=e,e.create3DObject(),e.get3DObject().renderOrder=999999,this.rootObj.add(e.get3DObject())}}updateRepairWrenchSprite(e){this.repairWrench&&this.rootObj.remove(this.repairWrench.get3DObject()),e&&(this.repairWrench=this.createRepairWrench(),this.repairWrench&&(this.repairWrench.create3DObject(),this.rootObj.add(this.repairWrench.get3DObject())))}updateVeteranIndicatorSprite(e){var t;this.veteranIndicator&&this.rootObj.remove(this.veteranIndicator),this.veteranIndicator=this.createVeteranIndicator(e),this.veteranIndicator&&(this.rootObj.add(this.veteranIndicator),t=p.Coords.screenDistanceToWorld(Math.floor(x.pipBrdFile.getImage(e.isInfantry()?1:0).width/2)-Math.floor(x.pipsFile.getImage(13).width/2),0),this.veteranIndicator.position.x=t.x,this.veteranIndicator.position.y=0,this.veteranIndicator.position.z=t.y,this.veteranIndicator.updateMatrix())}updateRallyPointLine(e,t){t.visible=!1,e&&(this.objectIsOpaqueToViewer()||(t.sourcePos=this.gameObject.position.worldPosition,t.targetPos=p.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z),t.color=new THREE.Color(this.gameObject.owner.color.asHex()),t.needsUpdate=!0,t.visible=!0))}updatePrimaryFactorySprite(e){var t;this.primaryFactorySprite&&this.rootObj.remove(this.primaryFactorySprite),!e||(t=this.primaryFactorySprite=this.createPrimaryFactorySprite())&&this.rootObj.add(t)}updateControlGroupSprite(i){if(this.controlGroupSprite&&this.rootObj.remove(this.controlGroupSprite),void 0!==i){let e=this.controlGroupSprite=this.createControlGroupSprite(i),t=this.gameObject;var r;t.isBuilding()?(e.position.x=1,e.position.y=p.Coords.tileHeightToWorld(t.art.height-.5),e.position.z=p.Coords.getWorldTileSize()*t.art.foundation.height):t.isInfantry()?(r=p.Coords.screenDistanceToWorld(-(c.width+2*u+x.pipBrdFile.getImage(1).width/2+1),-x.pipBrdFile.height/2),e.position.x=r.x,e.position.y=this.healthBar.position.y,e.position.z=r.y):(r=p.Coords.screenDistanceToWorld(-x.pipBrdFile.getImage(0).width/2,x.pipBrdFile.height/2),e.position.x=r.x,e.position.y=this.healthBar.position.y,e.position.z=r.y),e.updateMatrix(),this.rootObj.add(e)}}updatePipsSprite(){this.pipsSprite&&(this.rootObj.remove(this.pipsSprite),this.pipsSprite=void 0);let t=this.gameObject,r;if(t.isBuilding())r=this.createBuildingOccupationInfo(t);else if(t.isVehicle()){let i=[],e=void 0;var s,a;t.harvesterTrait&&0<t.rules.storage?(e=5,a=t.rules.storage,s=Math.floor(t.harvesterTrait.gems/a*e),a=Math.floor(t.harvesterTrait.ore/a*e),i.push(...new Array(s).fill(h.PipColor.Blue),...new Array(a).fill(h.PipColor.Yellow))):t.transportTrait&&0<t.rules.passengers?(e=t.rules.passengers,t.transportTrait.units.forEach(e=>{let t=0;e.isVehicle()&&(i.push(h.PipColor.Blue),t++),i.push(...new Array(e.rules.size-t).fill(e.isVehicle()?h.PipColor.Red:e.rules.pip))})):t.airSpawnTrait&&(i=new Array(t.airSpawnTrait.availableSpawns).fill(h.PipColor.Yellow),e=t.rules.spawnsNumber),e&&(r=this.createPipsSprite(i,e))}else t.isAircraft()&&t.ammo&&t.name!==this.paradropRules.paradropPlane&&!t.rules.missileSpawn&&(r=this.createPipsSprite(new Array(t.ammo).fill(h.PipColor.Green),t.ammo,!0));r&&(r.updateMatrix(),this.rootObj.add(r),this.pipsSprite=r)}computePipsDataKey(e){let t=void 0;return e.isBuilding()?t=e.garrisonTrait?.units.length:e.isVehicle()?e.harvesterTrait?t=e.harvesterTrait.ore+"_"+e.harvesterTrait.gems:e.transportTrait?t=e.transportTrait.units.length:e.airSpawnTrait&&(t=e.airSpawnTrait.availableSpawns):e.isAircraft()&&(t=e.ammo),t}updateHealthBarSprite(i){if(this.healthBar){if(this.rootObj.remove(this.healthBar),this.gameObject.isBuilding())this.healthBar=this.createBuildingHealthBar(this.gameObject);else{let{healthBarWrapper:e,selectionBox:t}=this.createUnitHealthBar(this.gameObject);this.healthBar=e,this.selectionBox=t,t.visible=i>=C[2]}this.rootObj.add(this.healthBar)}}createRepairWrench(){let e=this.animFactory("WRENCH");return e.setRenderOrder(999998),e}objectIsOpaqueToViewer(){return!(!this.viewer||this.viewer.isObserver)&&!(this.gameObject.owner===this.viewer||this.alliances.areAllied(this.gameObject.owner,this.viewer))}dispose(){this.disposables.dispose(),this.repairWrench?.dispose(),this.flyHelper?.dispose(),this.behindAnim?.dispose(),this.debugLabel?.dispose(),this.animFactory=void 0}}),x.atlasImageHandles=new Map,x.geometries=new Map,x.buildingHealthGeoCache=new Map,x.unitHealthGeoCache=new Map,x.unitHealthTextures=new Map,x.unitHealthMaterials=new Map,x.controlGroupTextures=new Map,x.controlGroupMaterials=new Map,x.primaryFactoryTextures=new Map,x.primaryFactoryMaterials=new Map}}}),System.register("engine/renderable/entity/HighlightAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],function(e,t){"use strict";var i,a,n,o,l,r;t&&t.id;return{setters:[function(e){i=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){r=class extends i.SimpleRunner{constructor(e,t=.5,i=2,r=5){super(),this.maxAmount=t;let s=new n.AnimProps(new o.IniSection("dummy"),new l.ShpFile);s.rate=r,s.loopEnd=i-1,s.loopCount=2,this.animation=new a.Animation(s,e),this.animation.stop()}animate(e){this.animation.props.loopCount=e,this.animation.reset()}getValue(){return(1-this.getCurrentFrame())*this.maxAmount}},e("HighlightAnimRunner",r)}}}),System.register("engine/renderable/entity/InvulnerableAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],function(e,t){"use strict";var i,n,o,l,c,r;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){r=class extends i.SimpleRunner{constructor(e,t=-.75,i=-.5,r=10,s=10){super(),this.minAmount=t,this.maxAmount=i,this.steps=r;let a=new o.AnimProps(new l.IniSection("dummy"),new c.ShpFile);a.rate=s,a.loopEnd=r,a.loopCount=-1,this.animation=new n.Animation(a,e),this.animation.stop()}animate(){this.animation.reset()}getValue(){return this.minAmount+(1+Math.sin(2*Math.PI*this.getCurrentFrame()/this.steps))/2*(this.maxAmount-this.minAmount)}},e("InvulnerableAnimRunner",r)}}}),System.register("engine/renderable/RenderablePlugin",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gfx/geometry/BufferGeometrySerializer",["data/DataStream"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("BufferGeometrySerializer",i=class{serialize(e){if(Object.keys(e.morphAttributes).length)throw new Error("Morph attributes are not supported");if(1<e.groups.length)throw new Error("Groups are not supported");var t,i=Object.keys(e.attributes),r=e.index,s=1+22*i.length+Object.values(e.attributes).map(e=>this.getTypedArrayByteSize(e.array)).reduce((e,t)=>e+t,0)+1+(r?this.getTypedArrayByteSize(r.array):0);let a=new o.DataStream(new ArrayBuffer(s));a.writeUint8(i.length);for(t of i){var n=e.getAttribute(t);a.writeCString(t,20),a.writeUint8(n.itemSize),a.writeUint8(Number(n.normalized)),this.writeTypedArray(a,n.array)}return a.writeUint8(Number(Boolean(r))),r&&this.writeTypedArray(a,r.array),a.seek(0),a.dynamicSize=!1,a.buffer}unserialize(e){let t=new THREE.BufferGeometry;var i,r=e.readUint8();for(let l=0;l<r;l++){var s=e.readCString(20),a=e.readUint8(),n=Boolean(e.readUint8()),o=this.readTypedArray(e),n=new THREE.BufferAttribute(o,a,n);t.addAttribute(s,n)}return Boolean(e.readUint8())&&(i=this.readTypedArray(e),t.setIndex(new THREE.BufferAttribute(i,1))),t}writeTypedArray(e,t){if(e.writeUint32(t.length),t instanceof Float32Array)e.writeUint8(0),e.writeFloat32Array(t);else if(t instanceof Uint32Array)e.writeUint8(1),e.writeUint32Array(t);else{if(!(t instanceof Uint16Array))throw new Error(`Unsupported array type "${t.constructor.name}"`);e.writeUint8(2),e.writeUint16Array(t)}}readTypedArray(e){var t=e.readUint32(),i=e.readUint8();switch(i){case 0:return e.readFloat32Array(t);case 1:return e.readUint32Array(t);case 2:return e.readUint16Array(t);default:throw new Error(`Unsupported array type "${i}"`)}}getTypedArrayByteSize(e){return 5+e.BYTES_PER_ELEMENT*e.length}})}}}),System.register("engine/gfx/geometry/VxlGeometryCache",["data/DataStream","data/vfs/VirtualFile","engine/gfx/geometry/BufferGeometrySerializer","data/vfs/FileNotFoundError"],function(e,t){"use strict";var r,s,n,o,a;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){n=e},function(e){o=e}],execute:function(){e("VxlGeometryCache",a=class a{constructor(e,t){this.cacheDir=e,this.activeMod=t,this.geometries=new Map}async loadFromStorage(t,i){let r=this.geometries.get(t);if(!r){let e=this.cacheDir;if(e){var s=this.getCacheFileName(i,t.name);try{var a=await e.openFile(s);r=(new n.BufferGeometrySerializer).unserialize(a.stream),this.set(t,r)}catch(e){e instanceof o.FileNotFoundError||console.error(`Failed to load buffer geometry from cache file "${s}"`,e)}}}return r}async persistToStorage(e,t,i){this.geometries.has(e)||this.set(e,(new n.BufferGeometrySerializer).unserialize(new r.DataStream(i))),await this.cacheDir?.writeFile(new s.VirtualFile(new r.DataStream(i),this.getCacheFileName(t,e.name)))}async clearStorage(){await this.clearStorageFiles()}async clearOtherModStorage(){let t=a.cacheFilePrefix+this.getModPrefix();await this.clearStorageFiles(e=>!e.startsWith(t))}async clearStorageFiles(e=()=>!0){let t=this.cacheDir;if(t)for await(var i of t.getEntries())i.startsWith(a.cacheFilePrefix)&&e(i)&&await t.deleteFile(i)}getCacheFileName(e,t){var i=this.getModPrefix();return""+a.cacheFilePrefix+i+e.replace(".vxl","")+"_"+t}getModPrefix(){return this.activeMod?this.activeMod+"#":"#"}clear(){this.geometries.forEach(e=>{e.dispose();for(var t of Object.keys(e.attributes))e.removeAttribute(t)}),this.geometries.clear()}get(e){return this.geometries.get(e)}set(e,t){this.geometries.set(e,t)}}),a.cacheFilePrefix="geocache_"}}}),System.register("engine/renderable/entity/unit/ModelQuality",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Low=0]="Low",e[e.High=1]="High",t("ModelQuality",i)}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder",["engine/gfx/BufferGeometryUtils"],function(e,t){"use strict";var E,i,Z,r;t&&t.id;return{setters:[function(e){E=e}],execute:function(){e("VxlGeometryMonotoneBuilder",i=class{build(e,t=!1){let s=e.getAllVoxels()["voxelField"];var{vertices:i,faces:r}=function(e,t){for(var i=[],r=[],s=0;s<3;++s){var a=(s+1)%3,n=(s+2)%3,o=new Int32Array(3),l=new Int32Array(3),c=new Int32Array(2*(t[a]+1)),h=new Int32Array(t[a]),u=new Int32Array(t[a]),d=new Int32Array(2*t[n]),g=new Int32Array(2*t[n]),p=new Int32Array(24*t[n]),m=[[0,0],[0,0]];for(l[s]=1,o[s]=-1;o[s]<t[s];){var f=[],y=0;for(o[n]=0;o[n]<t[n];++o[n]){var T=0,v=0,b=0;for(o[a]=0;o[a]<t[a];++o[a],v=b){var S=0<=o[s]?e(o[0],o[1],o[2]):0,w=o[s]<t[s]-1?e(o[0]+l[0],o[1]+l[1],o[2]+l[2]):0;!(b=S)==!w?b=0:S||(b=-w),v!==b&&(c[T++]=o[a],c[T++]=b)}c[T++]=t[a];for(var C=c[T++]=0,E=0,x=0;E<y&&x<T-2;){let e=f[h[E]];var O=e.left[e.left.length-1][0],A=e.right[e.right.length-1][0],M=e.color,R=c[x],P=c[x+2],I=c[x+1];O<P&&R<A&&I===M?(e.merge_run(o[n],R,P),u[C++]=h[E],++E,x+=2):(P<=A&&(I&&(k=new Z(I,o[n],R,P),u[C++]=f.length,f.push(k)),x+=2),A<=P&&(e.close_off(o[n]),++E))}for(;E<y;++E)f[h[E]].close_off(o[n]);for(;x<T-2;x+=2){var k,R=c[x],P=c[x+2];(I=c[x+1])&&(k=new Z(I,o[n],R,P),u[C++]=f.length,f.push(k))}var B=u,u=h,h=B,y=C}for(E=0;E<y;++E){let e=f[h[E]];e.close_off(t[n])}o[s]++;for(E=0;E<f.length;++E){var j=f[E],N=!1;(b=j.color)<0&&(N=!0,b=-b);for(x=0;x<j.left.length;++x){d[x]=i.length;var L=[0,0,0],D=j.left[x];L[s]=o[s],L[a]=D[0],L[n]=D[1],i.push({position:L,value:b})}for(x=0;x<j.right.length;++x){g[x]=i.length;L=[0,0,0],D=j.right[x];L[s]=o[s],L[a]=D[0],L[n]=D[1],i.push({position:L,value:b})}var F=0,_=0,U=1,H=1,G=!0;for(p[_++]=d[0],p[_++]=j.left[0][0],p[_++]=j.left[0][1],p[_++]=g[0],p[_++]=j.right[0][0],p[_++]=j.right[0][1];U<j.left.length||H<j.right.length;){var V,W,z=!1;U===j.left.length?z=!0:H!==j.right.length&&(V=j.left[U],W=j.right[H],z=V[1]>W[1]);var K=z?g[H]:d[U],q=z?j.right[H]:j.left[U];if(z!==G)for(;F+3<_;)N===z?r.push([p[F],p[F+3],K]):r.push([p[F+3],p[F],K]),F+=3;else for(;F+3<_;){for(x=0;x<2;++x)for(var $=0;$<2;++$)m[x][$]=p[_-3*(x+1)+$+1]-q[$];var Q=m[0][0]*m[1][1]-m[1][0]*m[0][1];if(z===0<Q)break;0!=Q&&(N===z?r.push([p[_-3],p[_-6],K]):r.push([p[_-6],p[_-3],K])),_-=3}p[_++]=K,p[_++]=q[0],p[_++]=q[1],z?++H:++U,G=z}}}}return{vertices:i,faces:r}}(t?(e,t,i)=>{var r=s.get(e,t,i);return r?r.colorIndex:0}:(e,t,i)=>{var r=s.get(e,t,i);return r?r.normalIndex+256*r.colorIndex:0},[e.sizeX,e.sizeY,e.sizeZ]),a=e.minBounds,n=e.scale,o=e.getNormals();let l=new Float32Array(3*i.length),c=new Float32Array(3*i.length),h=new Float32Array(3*i.length),u=0,d=0,g=0;for(let b=0,S=i.length;b<S;b++){var p=i[b],m=t?p.value:p.value/256|0;l[u++]=a.x+p.position[0]*n.x,l[u++]=a.y+p.position[1]*n.y,l[u++]=a.z+p.position[2]*n.z,h[g++]=m/255,h[g++]=0,h[g++]=0,t||(p=p.value%256,p=o[Math.min(p,o.length-1)],c[d++]=p.x,c[d++]=p.y,c[d++]=p.z)}let f=new Uint32Array(3*r.length),y=0;for(let w=0,C=r.length;w<C;w++){var T=r[w];f[y++]=T[0],f[y++]=T[1],f[y++]=T[2]}let v=new THREE.BufferGeometry;return v.addAttribute("position",new THREE.BufferAttribute(l,3)),t||v.addAttribute("normal",new THREE.BufferAttribute(c,3)),v.addAttribute("color",new THREE.BufferAttribute(h,3)),v.setIndex(new THREE.BufferAttribute(f,1)),v=E.BufferGeometryUtils.mergeVertices(v),v.computeBoundingBox(),t&&v.computeVertexNormals(),v}}),Z=class{constructor(e,t,i,r){this.color=e,this.left=[[i,t]],this.right=[[r,t]]}close_off(e){this.left.push([this.left[this.left.length-1][0],e]),this.right.push([this.right[this.right.length-1][0],e])}merge_run(e,t,i){var r=this.left[this.left.length-1][0],s=this.right[this.right.length-1][0];r!==t&&(this.left.push([r,e]),this.left.push([t,e])),s!==i&&(this.right.push([s,e]),this.right.push([i,e]))}},r=class{}}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryPool",["engine/renderable/entity/unit/ModelQuality","util/typeGuard","engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("VxlGeometryPool",a=class{constructor(e,t=i.ModelQuality.High){this.cache=e,this.modelQuality=t}setModelQuality(e){this.modelQuality=e}getModelQuality(){return this.modelQuality}async loadFromStorage(e,t){let i=await Promise.all(e.sections.map(e=>this.cache.loadFromStorage(e,t)));return i.every(r.isNotNullOrUndefined)}async persistToStorage(e,t,i){for(let s=0;s<e.sections.length;s++){var r=e.sections[s];await this.cache.persistToStorage(r,t,i[s])}}clear(){this.cache.clear()}async clearStorage(){await this.cache.clearStorage()}async clearOtherModStorage(){await this.cache.clearOtherModStorage()}get(e){let t=this.cache.get(e);return t||(t=(new s.VxlGeometryMonotoneBuilder).build(e),this.cache.set(e,t)),t}})}}}),System.register("engine/renderable/builder/VxlBatchedBuilder",["engine/gfx/TextureUtils","engine/gfx/batch/BatchedMesh","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],function(e,t){"use strict";var i,c,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){c=e},function(e){r=e},function(e){s=e}],execute:function(){a=class a extends r.VxlBuilder{constructor(e,t,i,r,s,a){super(a),this.vxlFile=e,this.hvaFile=t,this.palettes=i,this.palette=r,this.vxlGeometryPool=s,this.clippingPlanes=[],this.opacity=1,this.castShadow=!0}createVxlMeshes(){var e=i.TextureUtils.textureFromPalettes(this.palettes);let n=this.useMaterial(e);this.materialCacheKey=e;let o=this.getPaletteIndex(this.palette),t=this.vxlFile.sections,l=new Map;return t.forEach((e,t)=>{var i=this.vxlGeometryPool.get(e);let r=new c.BatchedMesh(i,n),s=e.transfMatrix,a=this.hvaFile?.sections[t];a&&(s=e.scaleHvaMatrix(a.getMatrix(0))),r.applyMatrix(s),l.set(e.name,r),r.castShadow=this.castShadow,r.setPaletteIndex(o),this.extraLight&&r.setExtraLight(this.extraLight),r.setOpacity(this.opacity),r.setClippingPlanes(this.clippingPlanes)}),l}useMaterial(e){let t=a.materialCache.get(e),i;return t?(i=t.material,t.usages++):(i=new s.PalettePhongMaterial({palette:e,paletteCount:this.palettes.length,vertexColors:THREE.VertexColors,transparent:!0}),t={material:i,usages:1},a.materialCache.set(e,t)),i}freeMaterial(){let e=a.materialCache.get(this.materialCacheKey);e&&(1===e.usages?(a.materialCache.delete(this.materialCacheKey),e.material.dispose()):e.usages--)}getPaletteIndex(t){var e=this.palettes.findIndex(e=>e.hash===t.hash);if(-1===e)throw new Error("Provided palette not found in the list of available palettes");return e}setPalette(e){if(this.palette=e,this.object){let t=this.getPaletteIndex(e);this.sections.forEach(e=>e.setPaletteIndex(t))}}setExtraLight(t){this.extraLight=t,this.object&&this.sections.forEach(e=>e.setExtraLight(t))}setShadow(t){this.castShadow=t,this.sections?.forEach(e=>{e.castShadow=t})}setClippingPlanes(t){this.clippingPlanes=t,this.object&&this.sections.forEach(e=>e.setClippingPlanes(t))}setOpacity(t){this.opacity=t,this.object&&this.sections.forEach(e=>e.setOpacity(t))}dispose(){this.object&&(this.freeMaterial(),this.object=void 0)}},e("VxlBatchedBuilder",a),a.materialCache=new Map}}}),System.register("engine/renderable/builder/VxlNonBatchedBuilder",["engine/gfx/TextureUtils","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends r.VxlBuilder{constructor(e,t,i,r,s){super(s),this.vxlFile=e,this.hvaFile=t,this.palette=i,this.vxlGeometryPool=r,this.clippingPlanes=[],this.castShadow=!0}createVxlMeshes(){var e=this.palette,e=i.TextureUtils.textureFromPalette(e);let n=this.material=new s.PalettePhongMaterial({palette:e,vertexColors:THREE.VertexColors});this.extraLight&&(n.extraLight=this.extraLight),n.clippingPlanes=this.clippingPlanes;let t=this.vxlFile.sections,o=new Map;return t.forEach((e,t)=>{var i=this.vxlGeometryPool.get(e);let r=new THREE.Mesh(i,n),s=e.transfMatrix,a=this.hvaFile?.sections[t];a&&(s=e.scaleHvaMatrix(a.getMatrix(0))),r.applyMatrix(s),o.set(e.name,r),r.castShadow=this.castShadow}),o}setPalette(e){var t;this.palette=e,this.object&&(t=i.TextureUtils.textureFromPalette(e),this.material.palette=t)}setExtraLight(e){this.extraLight=e,this.object&&(this.material.extraLight=e)}setShadow(t){this.castShadow=t,this.sections?.forEach(e=>e.castShadow=t)}setClippingPlanes(e){this.clippingPlanes=e,this.object&&(this.material.clippingPlanes=e)}setOpacity(e){this.material.transparent=e<1,this.material.opacity=e}dispose(){this.object&&this.material.dispose()}},e("VxlNonBatchedBuilder",a)}}}),System.register("engine/renderable/builder/VxlBuilderFactory",["engine/renderable/builder/VxlBatchedBuilder","engine/renderable/builder/VxlNonBatchedBuilder"],function(e,t){"use strict";var s,a,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e}],execute:function(){e("VxlBuilderFactory",i=class{constructor(e,t,i){this.vxlGeometryPool=e,this.useBatching=t,this.camera=i}create(e,t,i,r){return this.useBatching?new s.VxlBatchedBuilder(e,t,i,r,this.vxlGeometryPool,this.camera):new a.VxlNonBatchedBuilder(e,t,r,this.vxlGeometryPool,this.camera)}})}}}),System.register("engine/renderable/builder/ShpAggregator",["data/ShpFile","data/ShpImage"],function(e,t){"use strict";var c,h,i;t&&t.id;return{setters:[function(e){c=e},function(e){h=e}],execute:function(){e("ShpAggregator",i=class{static getShpFrameInfo(e,t){return{file:e,hasShadow:t,frameCount:Math.floor(e.numImages*(t?.5:1))}}aggregate(e,t){let i=new c.ShpFile;i.filename=t;let r=[],s=new Map,a=0;for(var{file:n,hasShadow:o,frameCount:l}of e)if(!s.has(n)){s.set(n,a);for(let e=0;e<l;e++)i.addImage(n.getImage(e)),r.push(o?n.getImage(l+e):new h.ShpImage),a++}return r.forEach(e=>i.addImage(e)),{file:i,imageIndexes:s}}})}}}),System.register("engine/renderable/entity/building/BuildingShpHelper",["engine/AnimProps","engine/ImageFinder","engine/renderable/builder/ShpAggregator"],function(e,t){"use strict";var o,a,l,i;t&&t.id;return{setters:[function(e){o=e},function(e){a=e},function(e){l=e}],execute:function(){e("BuildingShpHelper",i=class{constructor(e){this.imageFinder=e}getShpFrameInfos(e,t,i,r){let s=new Map;t&&s.set(t,l.ShpAggregator.getShpFrameInfo(t,e.hasShadow)),i&&s.set(i,l.ShpAggregator.getShpFrameInfo(i,e.hasShadow));for(var[a,n]of r){a=new o.AnimProps(a.art,n),a=l.ShpAggregator.getShpFrameInfo(n,a.shadow);s.set(n,a)}return s}collectAnimShpFiles(e,r){let s=new Map;return e.getAll().forEach((e,t)=>{for(var i of e){let e;try{e=this.imageFinder.find(i.image,r.useTheaterExtension)}catch(e){if(e instanceof a.ImageFinder.MissingImageError){console.warn(e.message);continue}throw e}s.set(i,e)}}),s}})}}}),System.register("engine/renderable/entity/unit/ExtraLightHelper",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ExtraLightHelper",i=class{static multiplyShp(e,t,i){e.copy(t).add(t.clone().addScalar(1).multiplyScalar(i))}static multiplyVxl(e,t,i,r){e.copy(t).addScalar(2*r*i)}})}}}),System.register("engine/renderable/AlphaRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","util/Color","game/Coords"],function(e,t){"use strict";var s,a,n,o,l;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){e("AlphaRenderable",l=class l{constructor(e,t,i){this.shpFile=e,this.camera=t,this.visible=!0,this.drawOffset={...i}}static getOrCreateAlphaPalette(){let i=l.alphaPalette;if(!i){i=new s.Palette(new Array(768).fill(0));let e=[];for(let t=0;t<256;t++){var r=127<t?2*(t-127):0;e.push(new n.Color(r,r,r))}i.setColors(e),l.alphaPalette=i}return i}setVisible(e){this.visible=e,this.object3d&&(this.object3d.visible=e)}setSize(e){this.shpSize=e,this.builder?.setSize(e)}create3DObject(){if(!this.object3d){var r=l.getOrCreateAlphaPalette();let e=new a.ShpBuilder(this.shpFile,r,this.camera,o.Coords.ISO_WORLD_SCALE);this.shpSize&&e.setSize(this.shpSize),e.setFrame(0),e.setOffset(this.drawOffset);let t=e.build();t.visible=this.visible,t.renderOrder=999995;let i=t.material;i.depthTest=!1,i.depthWrite=!0,i.transparent=!0,i.blending=THREE.CustomBlending,i.blendEquation=THREE.AddEquation,i.blendSrc=THREE.DstColorFactor,i.blendDst=THREE.OneFactor,this.builder=e,this.object3d=t}}get3DObject(){return this.object3d}update(e){}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/DebugRenderable",["data/Palette","engine/gfx/DebugUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial","three","engine/gfx/batch/BatchedMesh"],function(e,t){"use strict";var i,n,o,l,c,h,u;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("DebugRenderable",u=class u{constructor(e,t,i,r){this.foundation=e,this.height=t,this.palette=i,this.options=r,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1}static getOrCreateTexture(){let e=u.checkerboardTex;return e||(e=n.DebugUtils.createIndexedCheckerTex(i.Palette.REMAP_START_IDX-1,i.Palette.REMAP_START_IDX),u.checkerboardTex=e),e}static clearCaches(){u.checkerboardTex?.dispose(),u.geometryCache.forEach(e=>e.dispose()),u.geometryCache.clear()}useMaterial(e){this.materialCacheKey=e.uuid;let t=u.materialCache.get(this.materialCacheKey),i;return t?(i=t.material,t.usages++):(i=new l.PaletteBasicMaterial({map:u.getOrCreateTexture(),palette:e,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:!0}),t={material:i,usages:1},u.materialCache.set(this.materialCacheKey,t)),i}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let e=u.materialCache.get(this.materialCacheKey);e&&(1===e.usages?(u.materialCache.delete(this.materialCacheKey),e.material.dispose()):e.usages--)}getGeometryCacheKey(){return this.foundation.width+"_"+this.foundation.height+"_"+this.height}setBatched(e){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=e}getBatchPaletteIndex(t){var e=this.batchPalettes.findIndex(e=>e.hash===t.hash);if(-1===e)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return e}setPalette(t){if(this.palette=t,this.mesh)if(this.useMeshBatching){var i=this.getBatchPaletteIndex(t);this.mesh.setPaletteIndex(i)}else{i=o.TextureUtils.textureFromPalette(t);let e=this.mesh.material;e.palette=i}}setBatchPalettes(e){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=e}setOpacity(e){this.opacity!==e&&(this.opacity=e,this.updateOpacity())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}create3DObject(){if(!this.mesh){var r,s,a=this.getGeometryCacheKey();let e=u.geometryCache,t=e.get(a);t||(t=n.DebugUtils.createBoxGeometry(this.foundation,this.height,this.options?.centerFoundation),e.set(a,t));let i;this.useMeshBatching?(r=o.TextureUtils.textureFromPalettes(this.batchPalettes),s=this.useMaterial(r),i=new h.BatchedMesh(t,s,h.BatchMode.Merging),i.castShadow=!1):(r=o.TextureUtils.textureFromPalette(this.palette),s=u.getOrCreateTexture(),s=new l.PaletteBasicMaterial({palette:r,map:s,alphaTest:.05,transparent:!0}),i=new c.Mesh(t,s)),i.matrixAutoUpdate=!1,this.mesh=i,this.setPalette(this.palette),this.updateOpacity()}}get3DObject(){return this.mesh}update(e){}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),u.geometryCache=new Map,u.materialCache=new Map}}}),System.register("engine/renderable/entity/Building",["engine/renderable/builder/ShpBuilder","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/gfx/OverlayUtils","game/gameobject/Building","engine/Animation","engine/renderable/entity/wallTypes","game/Coords","util/math","engine/AnimProps","engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/entity/building/BuildingAnimArtProps","util/typeGuard","engine/renderable/entity/HighlightAnimRunner","game/rules/TechnoRules","game/gameobject/trait/AttackTrait","game/SideType","game/gameobject/trait/FactoryTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/common/DeathType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/AlphaRenderable","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(e,t){"use strict";var d,p,M,r,m,f,s,g,u,y,R,T,P,v,b,I,i,k,S,w,a,C,E,n,B,j,x,o,O,A,N,l,c;t&&t.id;return{setters:[function(e){d=e},function(e){p=e},function(e){M=e},function(e){r=e},function(e){m=e},function(e){f=e},function(e){s=e},function(e){g=e},function(e){u=e},function(e){y=e},function(e){R=e},function(e){T=e},function(e){P=e},function(e){v=e},function(e){b=e},function(e){I=e},function(e){i=e},function(e){k=e},function(e){S=e},function(e){w=e},function(e){a=e},function(e){C=e},function(e){E=e},function(e){n=e},function(e){B=e},function(e){j=e},function(e){x=e},function(e){o=e},function(e){O=e},function(e){A=e}],execute:function(){N=(new Map).set(M.AnimationType.PRODUCTION,M.AnimationType.IDLE).set(M.AnimationType.BUILDUP,M.AnimationType.IDLE).set(M.AnimationType.SPECIAL_DOCKING,M.AnimationType.IDLE).set(M.AnimationType.SPECIAL_REPAIR_START,M.AnimationType.SPECIAL_REPAIR_LOOP).set(M.AnimationType.SPECIAL_REPAIR_LOOP,M.AnimationType.SPECIAL_REPAIR_END).set(M.AnimationType.SPECIAL_REPAIR_END,M.AnimationType.IDLE).set(M.AnimationType.SUPER_CHARGE_START,M.AnimationType.SUPER_CHARGE_LOOP).set(M.AnimationType.SUPER_CHARGE_LOOP,M.AnimationType.SUPER_CHARGE_END).set(M.AnimationType.SUPER_CHARGE_END,M.AnimationType.IDLE).set(M.AnimationType.FACTORY_DEPLOYING,M.AnimationType.IDLE).set(M.AnimationType.FACTORY_ROOF_DEPLOYING,M.AnimationType.IDLE),l=(new Map).set(M.AnimationType.SUPER_CHARGE_START,[M.AnimationType.SUPER,1]).set(M.AnimationType.SUPER_CHARGE_LOOP,[M.AnimationType.SUPER,2]).set(M.AnimationType.SUPER_CHARGE_END,[M.AnimationType.SUPER,3]).set(M.AnimationType.SPECIAL_REPAIR_START,[M.AnimationType.SPECIAL,0]).set(M.AnimationType.SPECIAL_REPAIR_LOOP,[M.AnimationType.SPECIAL,1]).set(M.AnimationType.SPECIAL_REPAIR_END,[M.AnimationType.SPECIAL,2]).set(M.AnimationType.SPECIAL_DOCKING,[M.AnimationType.SPECIAL,0]).set(M.AnimationType.SPECIAL_SHOOT,[M.AnimationType.SPECIAL,0]).set(M.AnimationType.FACTORY_DEPLOYING,[M.AnimationType.FACTORY_DEPLOYING,0]).set(M.AnimationType.FACTORY_UNDER_DOOR,[M.AnimationType.FACTORY_DEPLOYING,1]).set(M.AnimationType.FACTORY_ROOF_DEPLOYING,[M.AnimationType.FACTORY_ROOF_DEPLOYING,0]).set(M.AnimationType.FACTORY_UNDER_ROOF_DOOR,[M.AnimationType.FACTORY_ROOF_DEPLOYING,1]),e("Building",c=class c{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S=M.AnimationType.IDLE){this.gameObject=e,this.selectionModel=t,this.rules=i,this.art=r,this.imageFinder=s,this.voxels=n,this.voxelAnims=o,this.palette=l,this.animPalette=c,this.isoPalette=h,this.camera=u,this.lighting=d,this.debugFrame=g,this.gameSpeed=p,this.vxlBuilderFactory=m,this.useSpriteBatching=f,this.buildingImageDataCache=T,this.pipOverlay=v,this.worldSound=b,this.initialAnimType=S,this.animObjects=new Map,this.animations=new Map,this.animSounds=new Map,this.powered=!0,this.repairStopRequested=!1,this.repairStartRequested=!1,this.highlightAnimRunner=new k.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new B.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=e.art,this.objectRules=e.rules,this.type=this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map(e=>this.palette.clone().remap(e)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight);var w=this.animArtProps=new I.BuildingAnimArtProps;this.animArtProps.read(this.objectArt.art,this.art);let C;try{C=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(!(e instanceof P.ImageFinder.MissingImageError))throw e;console.warn(e.message)}this.mainShpFile=C;let E;try{E=this.objectArt.bibShape?this.imageFinder.find(this.objectArt.bibShape,this.objectArt.useTheaterExtension):void 0}catch(e){if(!(e instanceof P.ImageFinder.MissingImageError))throw e;console.warn(e.message)}this.bibShpFile=E;let x=new j.BuildingShpHelper(this.imageFinder);w=this.animShpFiles=x.collectAnimShpFiles(w,this.objectArt);let O=this.shpFrameInfos=x.getShpFrameInfos(this.objectArt,C,E,w),A=this.buildingImageDataCache.get(this.gameObject.name);A||(A=y.aggregate(O.values(),`agg_${this.objectRules.name}.shp`),this.buildingImageDataCache.set(this.gameObject.name,A)),this.aggregatedImageData=A,this.withPosition=new R.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile))}updateLighting(){this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.plugins.forEach(e=>e.updateLighting?.())}get3DObject(){return this.target}getIntersectTarget(){return this.intersectTarget}updateIntersectTarget(){this.intersectTarget=[this.placeholderObj?.get3DObject(),this.mainObj?.getShapeMesh(),this.bib?.getShapeMesh(),...[...this.animObjects.values()].flat().map(e=>e.getShapeMesh())].filter(i.isNotNullOrUndefined)}getUiName(){var e=this.plugins.reduce((e,t)=>t.getUiNameOverride?.()??e,void 0);return void 0!==e?e:this.gameObject.getUiName()}create3DObject(){let t=this.get3DObject();if(!t){t=new THREE.Object3D,t.name="building_"+this.type,t.userData.id=this.gameObject.id,this.target=t,t.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this);var e=this.gameObject.rules.alphaImage;if(e){var i=this.imageFinder.tryFind(e,!1);if(i){let e=new o.AlphaRenderable(i,this.camera,new THREE.Vector2(0,(g.Coords.ISO_TILE_SIZE+1)/2));e.create3DObject(),t.add(e.get3DObject())}else console.warn(`<${this.objectRules.name}>: Alpha image "${e}" not found`)}this.objectRules.lightIntensity&&(this.createLamp(t),this.objectRules.isLightpost)||(this.createObjects(t),this.updateIntersectTarget(),this.pipOverlay&&(this.pipOverlay.create3DObject(),t.add(this.pipOverlay.get3DObject())),this.updateImage(this.computeDamageType(this.gameObject.healthTrait.health)),this.mainObj?.setExtraLight(this.shpExtraLight),[...this.animObjects.values()].forEach(e=>{e.forEach(e=>{let t=this.animations.get(e);t.props.getArt().has("UseNormalLight")||e.setExtraLight(this.shpExtraLight)})}),this.bib?.setExtraLight(this.shpExtraLight),this.turretBuilders?.forEach(e=>{e instanceof d.ShpBuilder?e.setExtraLight(this.shpExtraLight):e.setExtraLight(this.vxlExtraLight)}))}}createLamp(e){var t=this.objectRules;let i=(1+t.lightRedTint)*(1+Math.abs(t.lightIntensity))-1,r=(1+t.lightGreenTint)*(1+Math.abs(t.lightIntensity))-1,s=(1+t.lightBlueTint)*(1+Math.abs(t.lightIntensity))-1;var a=Math.max(i,r,s);1<a&&(i/=a,r/=a,s/=a);let n=new THREE.Color(i,r,s).multiplyScalar(.9);a=n.getHexString();let o=c.lampTextures.get(a);o||(o=this.createLampTexture(a),c.lampTextures.set(a,o));a=new THREE.MeshBasicMaterial({map:o,depthTest:!1,depthWrite:!1,transparent:!0,blending:THREE.CustomBlending,blendEquation:0<t.lightIntensity?THREE.AddEquation:THREE.ReverseSubtractEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor}),t=t.lightVisibility,t=new THREE.PlaneBufferGeometry(2*t,2*t);let l=new THREE.Mesh(t,a);l.rotation.x=-Math.PI/2,l.renderOrder=999995,l.matrixAutoUpdate=!1,l.updateMatrix(),e.add(l)}createLampTexture(e){let t=document.createElement("canvas");t.width=t.height=32;let i=t.getContext("2d");i.fillStyle="black",i.fillRect(0,0,32,32);let r=i.createRadialGradient(16,16,0,16,16,16);r.addColorStop(0,"#"+e),r.addColorStop(1,"black"),i.arc(16,16,16,0,2*Math.PI),i.fillStyle=r,i.fill();let s=new THREE.Texture(t);return s.needsUpdate=!0,s}setPosition(e){var t=this.gameObject.getFoundationCenterOffset();this.withPosition.setPosition(e.x-t.x,e.y,e.z-t.y)}getPosition(){return this.withPosition.getPosition()}registerPlugin(e){this.plugins.push(e)}highlight(){this.plugins.some(e=>e.shouldDisableHighlight?.())||this.highlightAnimRunner.animate(2)}update(i){if(!this.objectRules.isLightpost){this.gameObject.isDestroyed||void 0!==this.currentAnimType||this.setAnimation(this.initialAnimType,i),this.plugins.forEach(e=>e.update(i)),this.pipOverlay?.update(i);var t=this.gameObject.c4ChargeTrait?.hasCharge();!this.gameObject.isDestroyed&&this.lastHasC4Charge!==t&&t&&(this.lastHasC4Charge=t,this.highlight());var r=this.highlightAnimRunner.shouldUpdate(),s=this.gameObject.invulnerableTrait.isActive(),t=s!==this.lastInvulnerable;(this.lastInvulnerable=s)&&t&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(i),(r||t||s)&&(r&&this.highlightAnimRunner.tick(i),s=s?this.invulnAnimRunner.getValue():0,n=(r?this.highlightAnimRunner.getValue():0)||s,s=this.lighting.getAmbientIntensity(),x.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,s,n),x.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,n));var a,n=this.gameObject.warpedOutTrait.isActive();if(n!==this.lastWarpedOut){let t=(this.lastWarpedOut=n)?.5:1;for(a of[this.mainObj,this.bib,...[...this.animObjects.values()].flat()])a?.setOpacity(t);this.turretBuilders?.forEach(e=>e.setOpacity(t)),this.placeholderObj?.setOpacity(t)}this.gameObject.isDestroyed||(o=this.gameObject.owner.color,this.lastOwnerColor!==o&&(this.palette.remap(o),this.mainObj?.setPalette(this.palette),[...this.animObjects.values()].forEach(e=>{e.forEach(e=>e.setPalette(this.palette))}),this.bib?.setPalette(this.palette),this.turretBuilders?.forEach(e=>e.setPalette(this.palette)),this.placeholderObj?.setPalette(this.palette),this.lastOwnerColor=o)),!this.gameObject.isDestroyed&&N.has(this.currentAnimType)&&(l=N.get(this.currentAnimType),this.hasObjectWithStoppedAnimation(this.currentAnimType)&&this.setAnimation(l,i)),this.gameObject.isDestroyed||this.gameObject.buildStatus!==m.BuildStatus.BuildDown||this.currentAnimType===M.AnimationType.UNBUILD||this.setAnimation(M.AnimationType.UNBUILD,i);var o=this.gameObject.attackTrait?.attackState;if((void 0===this.lastAttackState||this.lastAttackState!==o&&!this.gameObject.isDestroyed)&&(this.lastAttackState=o,!this.gameObject.isDestroyed&&this.hasAnimation(M.AnimationType.SPECIAL_SHOOT)&&(o===w.AttackState.FireUp?this.setAnimation(M.AnimationType.SPECIAL_SHOOT,i):this.currentAnimType===M.AnimationType.SPECIAL_SHOOT&&this.setAnimation(M.AnimationType.IDLE,i)),o===w.AttackState.JustFired&&this.objectArt.muzzleFlash)){let e=this.createMuzzleFlashAnim(this.spriteOffset,this.renderableManager);e&&(e.create3DObject(),this.spriteWrap.add(e.get3DObject()),this.muzzleAnims=this.muzzleAnims||[],this.muzzleAnims.push(e))}var l=this.gameObject.factoryTrait;if(l){var c=l.status;if(this.lastFactoryStatus!==c&&!this.gameObject.isDestroyed){o=this.lastFactoryStatus;if(this.lastFactoryStatus=c,void 0!==o){let e,t=!1;[S.FactoryType.BuildingType,S.FactoryType.NavalUnitType].includes(l.type)?e=M.AnimationType.PRODUCTION:l.type===S.FactoryType.UnitType?(e=l.deliveringUnit?.rules.consideredAircraft?M.AnimationType.FACTORY_ROOF_DEPLOYING:M.AnimationType.FACTORY_DEPLOYING,t=!0):e=void 0,e&&this.hasAnimation(e)&&(c===C.FactoryStatus.Delivering?this.setAnimation(e,i):t&&this.setAnimation(M.AnimationType.IDLE,i))}}}c=this.gameObject.unitRepairTrait?.status;this.lastRepairStatus===c||this.gameObject.isDestroyed||(d=this.lastRepairStatus,this.lastRepairStatus=c,this.hasAnimation(M.AnimationType.SPECIAL_REPAIR_START)&&(c===E.RepairStatus.Repairing?(this.currentAnimType!==M.AnimationType.SPECIAL_REPAIR_LOOP&&this.currentAnimType!==M.AnimationType.SPECIAL_REPAIR_END||d!==E.RepairStatus.Idle?this.setAnimation(M.AnimationType.SPECIAL_REPAIR_START,i):this.repairStartRequested=!0,this.repairStopRequested=!1):(this.currentAnimType===M.AnimationType.SPECIAL_REPAIR_START?this.repairStopRequested=!0:this.endCurrentAnimation(),this.repairStartRequested=!1)));let e=this.gameObject.superWeaponTrait?.getSuperWeapon(this.gameObject);!e||!this.hasAnimation(M.AnimationType.SUPER_CHARGE_START)||this.gameObject.isDestroyed||(g=e.getTimerSeconds()<=60*this.objectRules.chargedAnimTime)!==this.lastSuperWeaponAlmostCharged&&((this.lastSuperWeaponAlmostCharged=g)?this.setAnimation(M.AnimationType.SUPER_CHARGE_START,i):this.endCurrentAnimation()),this.repairStopRequested&&this.currentAnimType===M.AnimationType.SPECIAL_REPAIR_LOOP&&(this.endCurrentAnimation(),this.repairStopRequested=!1),this.repairStartRequested&&this.currentAnimType===M.AnimationType.IDLE&&(this.setAnimation(M.AnimationType.SPECIAL_REPAIR_START,i),this.repairStartRequested=!1),this.muzzleAnims&&this.updateMuzzleAnims(i),n||(this.animations.forEach((e,t)=>{switch(e.getState()){case f.AnimationState.STOPPED:return;case f.AnimationState.DELAYED:e.update(i),t.get3DObject().visible=e.getState()!==f.AnimationState.DELAYED;break;case f.AnimationState.NOT_STARTED:e.start(i);case f.AnimationState.RUNNING:default:e.update(i)}t.setFrame(e.getCurrentFrame())}),this.animObjects.forEach((e,t)=>{let a=this.animArtProps.getByType(t);e.forEach((t,e)=>{var i=a[e];let r=this.animations.get(t);var s=i.translucent,i=i.translucency;if(s||0<i){let e;e=s?(s=r.props,1-r.getCurrentFrame()/(s.end-s.start)):1-i,t.setOpacity(e)}})})),this.toggleRangeCircleVisibility((this.gameObject.showWeaponRange||this.selectionModel.isSelected()&&-1!==this.gameObject.rules.techLevel)&&!n);var h,u,c=this.needsWallImageRefresh(),d=void 0===this.lastOccupiedState||this.lastOccupiedState!==!!this.gameObject.garrisonTrait?.isOccupied(),g=void 0===this.lastHealth||this.lastHealth!==this.gameObject.healthTrait.health;(c||d||g)&&(h=this.computeDamageType(this.gameObject.healthTrait.health),g=g&&h!==this.computeDamageType(this.lastHealth),this.lastOccupiedState=!!this.gameObject.garrisonTrait?.isOccupied(),this.lastHealth=this.gameObject.healthTrait.health,this.lastWallType=this.gameObject.wallType,(c||d||g)&&this.updateImage(h),g&&h===p.DamageType.DESTROYED&&this.objectRules.explosion.length&&this.createExplosionAnims(this.renderableManager)),this.gameObject.turretTrait&&((h=this.gameObject.turretTrait.facing)!==this.lastTurretFacing&&(this.lastTurretFacing=h,this.turretRot.rotation.y=THREE.Math.degToRad(h),this.turretRot.updateMatrix()),h=this.gameObject.turretTrait.isRotating()&&!n,this.lastTurretRotating!==h&&(this.lastTurretRotating=h,(u=this.objectRules.turretRotateSound)&&(h&&!this.gameObject.isDestroyed?this.turretRotateSound=this.worldSound?.playEffect(u,this.gameObject,this.gameObject.owner):this.turretRotateSound?.stop()))),this.gameObject.poweredTrait&&(this.gameObject.isDestroyed?this.poweredSound&&(this.poweredSound.stop(),this.poweredSound=void 0):(u=this.gameObject.poweredTrait.isPoweredOn()&&!n)!==this.lastPowered&&(this.setPowered(u),this.lastPowered=u,this.poweredSound?.stop(),(u=u?this.gameObject.rules.workingSound:this.gameObject.rules.notWorkingSound)&&!n&&(this.poweredSound=this.worldSound?.playEffect(u,this.gameObject,this.gameObject.owner,.25))))}}createExplosionAnims(e){var i=this.objectArt.foundation,r=this.objectRules.explosion;for(let a=0;a<i.width;a++)for(let t=0;t<i.height;t++){var s=r[u.getRandomInt(0,r.length-1)];e.createTransientAnim(s,e=>{e.setPosition(g.Coords.tile3dToWorld(a,t,0).add(this.withPosition.getPosition()))})}}updateMuzzleAnims(t){let i=this.muzzleAnims,r=[];i.forEach(e=>{e.update(t),e.isAnimFinished()&&(this.spriteWrap.remove(e.get3DObject()),e.dispose(),r.push(e))}),r.forEach(e=>i.splice(i.indexOf(e),1))}getNormalizedAnimType(e){let t=0,i=e;return l.has(e)&&([i,t]=l.get(e)),[i,t]}hasObjectWithStoppedAnimation(t){var[i,r]=this.getNormalizedAnimType(t),i=this.animObjects.get(i);if(i){let e=this.animations.get(i[r]);if(!e)throw new Error(`Missing animation for type '${M.AnimationType[t]}'`);if(e.getState()===f.AnimationState.STOPPED)return!0}return!1}computeDamageType(e){if(!e)return p.DamageType.DESTROYED;let t;return t=e>100*this.rules.audioVisual.conditionYellow?p.DamageType.NORMAL:e>100*this.rules.audioVisual.conditionRed?p.DamageType.CONDITION_YELLOW:p.DamageType.CONDITION_RED,(t&&this.objectRules.canBeOccupied||t===p.DamageType.CONDITION_RED)&&(t-=1),t}updateImage(o){let l=o===p.DamageType.DESTROYED;l?(this.objectRules.leaveRubble&&this.rubbleObj&&(this.rubbleObj.get3DObject().visible=!0),this.mainObj&&(this.mainObj.get3DObject().visible=!1)):this.objectRules.wall?this.updateWallImage(this.gameObject.wallType,o):this.updateMainObjFrame(!!this.gameObject.garrisonTrait?.isOccupied(),o),this.bib&&(l&&(this.bib.get3DObject().visible=!1),this.bib.setFrame(o!==p.DamageType.NORMAL?1:0)),this.turret&&l&&(this.turret.visible=!1),this.animObjects.forEach((a,n)=>{a.forEach((t,i)=>{if(n!==M.AnimationType.BUILDUP&&n!==M.AnimationType.UNBUILD){l&&a.forEach(e=>e.get3DObject().visible=!1);let e=this.animations.get(t);var r=o!==p.DamageType.NORMAL,s=this.animArtProps.getByType(n)[i];!r||s.damagedArt?(e.props.setArt(r?s.damagedArt:s.art),e.rewind()):console.warn(`<${this.gameObject.name}>: Missing damaged anim ${M.AnimationType[n]},`+i)}})});let r=o!==p.DamageType.NORMAL&&!l;this.fireObjects.forEach(e=>{e.get3DObject().visible=r;let t=this.animations.get(e);t.rewind();var i=t.props.getArt().get("StartSound");i&&this.handleSoundChange(i,e,r,.15)})}updateMainObjFrame(e,t){let i=e?2:t;var r;this.mainShpFile&&this.mainObj&&(r=this.shpFrameInfos.get(this.mainShpFile).frameCount,i>=r&&(console.warn(`Building ${this.objectRules.name} has damage frame `+i+` (occupied=${e}, damageType=${p.DamageType[t]}) out of bounds`),i=p.DamageType.NORMAL),this.mainObj.setFrame(i))}needsWallImageRefresh(){var e=this.gameObject.wallType,t=this.lastWallType;return this.objectRules.wall&&(!t||e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3])}updateWallImage(t,i){if(this.objectRules.wall&&this.mainObj&&this.mainShpFile){let e=this.findWallImageIndex(t);-1===e&&(console.warn("Invalid wall type",t),e=0);var r=this.shpFrameInfos.get(this.mainShpFile).frameCount<s.wallTypes.length?1:s.wallTypes.length,r=e+i*r;this.mainObj.setFrame(r)}}findWallImageIndex(e){for(let i=0;i<s.wallTypes.length;++i){var t=s.wallTypes[i];if(t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3])return i}return-1}createObjects(t){var e=this.objectArt.foundation;this.debugFrame.value&&(a=v.DebugUtils.createWireframe(e,this.objectArt.height),t.add(a));let i=new b.MapSpriteTranslation(e.width,e.height);var{spriteOffset:r,anchorPointWorld:s}=i.compute(),a=this.spriteOffset=this.computeSpriteAnchorOffset(r);let n=this.spriteWrap=new THREE.Object3D;n.matrixAutoUpdate=!1;let o=n,l={...a},c=!1;r=this.objectArt.zShapePointMove;if((this.gameObject.rules.refinery||this.gameObject.rules.nukeSilo)&&r.length){o=new THREE.Object3D,o.matrixAutoUpdate=!1,n.add(o),c=!0;r={x:-r[0]/g.Coords.ISO_TILE_SIZE,y:-r[1]/g.Coords.ISO_TILE_SIZE};let e=new b.MapSpriteTranslation(r.x,r.y);var{spriteOffset:h,anchorPointWorld:r}=e.compute();o.position.x=r.x,o.position.z=r.y,o.updateMatrix(),l.x+=h.x,l.y+=h.y}this.mainShpFile?(this.mainObj=this.createMainObject(this.mainShpFile,l,c),this.mainObj.create3DObject(),o.add(this.mainObj.get3DObject()),this.mainObj.getFlat()&&(A.MathUtils.translateTowardsCamera(this.mainObj.get3DObject(),this.camera,+g.Coords.ISO_WORLD_SCALE),this.mainObj.get3DObject().updateMatrix())):(this.placeholderObj=new O.DebugRenderable(e,this.objectArt.height,this.palette),this.placeholderObj.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholderObj.setBatchPalettes(this.paletteRemaps),this.placeholderObj.create3DObject(),t.add(this.placeholderObj.get3DObject())),this.objectRules.leaveRubble&&(this.rubbleObj=this.createRubbleObject(a),this.rubbleObj&&(this.rubbleObj.setExtraLight(this.shpExtraLight),this.rubbleObj.create3DObject(),this.rubbleObj.get3DObject().visible=!1,n.add(this.rubbleObj.get3DObject())));let u=this.createAnimObjects(l,c);if(u.forEach(e=>{o.add(e)}),this.fireObjects=this.createFireObjects(a),this.fireObjects.forEach(e=>{n.add(e.get3DObject())}),this.objectRules.turret&&({turret:h,turretRot:e}=this.createTurretObject(a,s),this.turret=h,this.turretRot=e,n.add(this.turret)),this.bibShpFile){this.bib=this.createBibObject(this.bibShpFile,a),this.bib.create3DObject();let e=this.bib.get3DObject();A.MathUtils.translateTowardsCamera(e,this.camera,-1),e.updateMatrix(),n.add(this.bib.get3DObject())}if(this.gameObject.primaryWeapon||this.gameObject.rules.hasRadialIndicator){a=this.gameObject.psychicDetectorTrait?.radiusTiles??this.gameObject.gapGeneratorTrait?.radiusTiles??this.gameObject.primaryWeapon?.range;if(a){let e=this.rangeCircle=this.createRangeCircle(a);e.matrixAutoUpdate=!1,e.position.x=s.x/2,e.position.z=s.y/2,e.updateMatrix(),e.visible=!1,t.add(e)}}n.position.x=s.x,n.position.z=s.y,n.updateMatrix(),t.add(n)}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x,y:e.y+t.y}}createMainObject(e,t,i=!1){let r=!1;this.objectRules.turret&&"CAOUTP"!==this.objectRules.name&&(r=!0);let s=T.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,t,this.objectArt.hasShadow,0,!r,0,i);return s.setSize(e),s.setFrameOffset(this.aggregatedImageData.imageIndexes.get(e)),s.setBatched(this.useSpriteBatching),this.useSpriteBatching&&s.setBatchPalettes(this.paletteRemaps),s.setFlat(r),s}createRubbleObject(t){var i=this.mainShpFile;if(i){let e=T.ShpRenderable.factory(this.aggregatedImageData.file,this.isoPalette,this.camera,t,this.objectArt.hasShadow);if(e.setSize(i),!(this.shpFrameInfos.get(i).frameCount<4))return e.setFrameOffset(this.aggregatedImageData.imageIndexes.get(i)),e.setBatched(this.useSpriteBatching),this.useSpriteBatching&&e.setBatchPalettes([this.isoPalette]),e.setFlat(!0),e.setFrame(3),e;console.warn(`Building image ${this.objectArt.imageName} has no rubble frame (missing 4th frame)`)}}createAnimObjects(n,o){let l=[];return this.animArtProps.getAll().forEach((e,t)=>{let i=[],r=1;for(var s of e){var a=this.animShpFiles.get(s);if(a){let e=this.createAnimObject(s,a,n,r++,o);e&&(l.push(e.get3DObject()),i.push(e))}}this.animObjects.set(t,i)}),l}createFireObjects(n){let o=[],l=0;for(;;){let e=this.objectArt.art.getString("DamageFireOffset"+l++);if(!e)break;var c=this.rules.audioVisual.fireNames,h=c[u.getRandomInt(0,c.length-1)];let t;try{t=this.imageFinder.find(h,this.objectArt.useTheaterExtension)}catch(e){if(e instanceof P.ImageFinder.MissingImageError){console.warn(e.message);continue}throw e}c=e.split(/\.|,/).filter(e=>""!==e);let i=parseInt(c[0],10),r=parseInt(c[1],10);c=this.animPalette;let s=new d.ShpBuilder(t,c,this.camera,g.Coords.ISO_WORLD_SCALE,!0,3);s.setOffset({x:n.x+i,y:n.y+r});let a=new T.ShpRenderable(s);a.setBatched(this.useSpriteBatching),this.useSpriteBatching&&a.setBatchPalettes([c]),a.create3DObject(),a.get3DObject().visible=!1;h=this.art.getAnimation(h),h=new y.AnimProps(h.art,t);this.animations.set(a,new f.Animation(h,this.gameSpeed)),o.push(a)}return o}createMuzzleFlashAnim(e,i){if(this.objectArt.muzzleFlash?.length){var r=u.getRandomInt(0,this.objectArt.muzzleFlash.length-1),s=this.objectArt.muzzleFlash[r],r=this.gameObject.owner.country?.side===a.SideType.GDI?this.gameObject.primaryWeapon:this.gameObject.secondaryWeapon;if(r){r=r.rules.anim;if(r.length){r=r[u.getRandomInt(0,r.length-1)];let t={x:e.x+s.x,y:e.y+s.y};return i.createAnim(r,e=>{e.extraOffset=t},!0)}}}}createAnimObject(e,t,i,r,s){var a=e.art,n=new y.AnimProps(a,t),a={x:i.x+e.offset.x,y:i.y+e.offset.y};let o=T.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,a,n.shadow,0,!e.flat,r,s&&!e.flat);return o.setSize(t),o.setFrameOffset(this.aggregatedImageData.imageIndexes.get(t)),o.setBatched(this.useSpriteBatching),this.useSpriteBatching&&o.setBatchPalettes(this.paletteRemaps),o.setFlat(e.flat),(e.translucent||0<e.translucency)&&o.setForceTransparent(!0),o.create3DObject(),this.animations.set(o,new f.Animation(n,this.gameSpeed)),o}createBibObject(e,t){let i=T.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,t,this.objectArt.hasShadow);return i.setSize(e),i.setFrameOffset(this.aggregatedImageData.imageIndexes.get(e)),i.setBatched(this.useSpriteBatching),this.useSpriteBatching&&i.setBatchPalettes(this.paletteRemaps),i.setFlat(!0),i}createTurretObject(i,e){this.turretBuilders=[];let r=new THREE.Object3D;r.matrixAutoUpdate=!1;let s=new THREE.Object3D;s.matrixAutoUpdate=!1;let a=this.objectRules.turretAnim;var n={x:this.objectRules.turretAnimX,y:this.objectRules.turretAnimY};let o;if(this.objectRules.turretAnimIsVoxel){var l=!this.objectArt.noHva;let t=a.toLowerCase()+".vxl";var c=this.voxels.get(t);if(c){var h=l?this.voxelAnims.get(t.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(c,h,this.paletteRemaps,this.palette);this.turretBuilders.push(e),o=e.build(),o.children.forEach(e=>e.castShadow=!1)}else console.warn(`Turret missing for building ${this.type}. Vxl file ${t} not found. `);if(a.toLowerCase().includes("tur")){let i=t.replace("tur","barl");h=this.voxels.get(i);if(h){var u=l?this.voxelAnims.get(i.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(h,u,this.paletteRemaps,this.palette);this.turretBuilders.push(e);let t=e.build();t.children.forEach(e=>e.castShadow=!1),s.add(t)}}u=g.Coords.screenDistanceToWorld(n.x,n.y);r.position.x=-e.x+u.x,r.position.z=-e.y+u.y}else{let t;try{t=this.imageFinder.find(a,this.objectArt.useTheaterExtension)}catch(e){if(!(e instanceof P.ImageFinder.MissingImageError))throw e;console.warn(e.message)}if(t){let e=new d.ShpBuilder(t,this.palette,this.camera,g.Coords.ISO_WORLD_SCALE,!0,2);e.setBatched(this.useSpriteBatching),this.useSpriteBatching&&e.setBatchPalettes(this.paletteRemaps),this.turretBuilders.push(e),e.setOffset({x:i.x+n.x,y:i.y+n.y}),o=e.build()}}return o&&s.add(o),r.add(s),A.MathUtils.translateTowardsCamera(r,this.camera,-(this.objectRules.turretAnimZAdjust+this.objectRules.turretAnimY/Math.cos(this.camera.rotation.y))*g.Coords.ISO_WORLD_SCALE),r.updateMatrix(),{turret:r,turretRot:s}}createRangeCircle(e){var t=e*g.Coords.getWorldTileSize();let i=this.gameObject.owner.color;return r.OverlayUtils.createGroundCircle(t,i.asHex())}toggleRangeCircleVisibility(e){this.rangeCircle&&(this.rangeCircle.visible=e)}setAnimationVisibility(e,i,t=-1){let r=this.animObjects.get(e);if(void 0===r)throw new Error(`Missing animObjects for animType "${M.AnimationType[e]}"`);if(-1!==t){if(t>=r.length)throw new RangeError(`Index ${t} exceeds length of animation objects (${r.length}) `+"of type "+M.AnimationType[e]);r=[r[t]]}for(var s of r){s.get3DObject().visible=i;let e=this.animations.get(s).props.getArt(),t=e.get("Report");t=t||e.get("StartSound"),t&&this.handleSoundChange(t,s,i)}}setActiveAnimationVisible(){let e=this.animArtProps.getByType(M.AnimationType.ACTIVE);this.objectRules.refinery&&(e=[e[0]]),e.forEach(({showWhenUnpowered:e},t)=>{try{this.setAnimationVisibility(M.AnimationType.ACTIVE,this.powered||e,t)}catch(e){RangeError}})}setPowered(r){if(this.powered=r,this.currentAnimType===M.AnimationType.IDLE&&this.setActiveAnimationVisible(),this.objectRules.superWeapon&&this.hasAnimation(M.AnimationType.SUPER)){var[t,i]=this.getNormalizedAnimType(M.AnimationType.SUPER_CHARGE_LOOP),s=this.animObjects.get(t);if(void 0===s)throw new Error(`Missing anim object for normalized anim type "${M.AnimationType[t]}"`);i=s[i];let e=this.animations.get(i);r?e.unpause():e.pause()}else this.animObjects.get(M.AnimationType.ACTIVE).forEach((e,t)=>{let i=this.animations.get(e);i&&(!r&&this.animArtProps.getByType(M.AnimationType.ACTIVE)[t].pauseWhenUnpowered?i.pause():i.unpause())})}hasAnimation(e){return e===M.AnimationType.IDLE||([e]=this.getNormalizedAnimType(e),this.animObjects.has(e)&&!!this.animObjects.get(e).length)}setAnimation(e,t){if(!this.gameObject.healthTrait.health)throw new Error("We can't switch building animation for a destroyed building");switch(this.hasAnimation(e)||(e=M.AnimationType.IDLE),this.currentAnimType=e,this.setAnimationVisibility(M.AnimationType.IDLE,!1),this.setAnimationVisibility(M.AnimationType.SPECIAL,!1),this.setAnimationVisibility(M.AnimationType.PRODUCTION,!1),this.setAnimationVisibility(M.AnimationType.SUPER,!1),this.setAnimationVisibility(M.AnimationType.BUILDUP,!1),this.setAnimationVisibility(M.AnimationType.UNBUILD,!1),this.setAnimationVisibility(M.AnimationType.FACTORY_DEPLOYING,!1),this.setAnimationVisibility(M.AnimationType.FACTORY_ROOF_DEPLOYING,!1),this.setActiveAnimationVisible(),e!==M.AnimationType.BUILDUP&&e!==M.AnimationType.UNBUILD?(this.mainObj&&(this.mainObj.get3DObject().visible=!0),this.bib&&(this.bib.get3DObject().visible=!0),this.turret&&(this.turret.visible=!0)):(this.mainObj&&(this.mainObj.get3DObject().visible=!1),this.bib&&(this.bib.get3DObject().visible=!1),this.turret&&(this.turret.visible=!1)),e!==M.AnimationType.FACTORY_DEPLOYING&&e!==M.AnimationType.FACTORY_ROOF_DEPLOYING||this.mainObj&&(this.mainObj.get3DObject().visible=!1),e){case M.AnimationType.PRODUCTION:this.setAnimationVisibility(M.AnimationType.PRODUCTION,!0),this.animObjects.get(M.AnimationType.PRODUCTION).forEach(e=>{this.animations.get(e).start(t)});break;case M.AnimationType.BUILDUP:this.setAnimationVisibility(M.AnimationType.ACTIVE,!1),this.setAnimationVisibility(M.AnimationType.BUILDUP,!0),this.animObjects.get(M.AnimationType.BUILDUP).forEach(e=>{this.animations.get(e).start(t)});break;case M.AnimationType.UNBUILD:this.setAnimationVisibility(M.AnimationType.ACTIVE,!1),this.setAnimationVisibility(M.AnimationType.UNBUILD,!0),this.animObjects.get(M.AnimationType.UNBUILD).forEach(e=>{this.animations.get(e).start(t)});break;case M.AnimationType.FACTORY_DEPLOYING:if(this.hasAnimation(M.AnimationType.FACTORY_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(M.AnimationType.FACTORY_DEPLOYING,!0),this.animObjects.get(M.AnimationType.FACTORY_DEPLOYING).forEach(e=>{this.animations.get(e).start(t)});break}case M.AnimationType.FACTORY_ROOF_DEPLOYING:if(this.hasAnimation(M.AnimationType.FACTORY_ROOF_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(M.AnimationType.FACTORY_ROOF_DEPLOYING,!0),this.animObjects.get(M.AnimationType.FACTORY_ROOF_DEPLOYING).forEach(e=>{this.animations.get(e).start(t)});break}case M.AnimationType.SPECIAL_REPAIR_START:case M.AnimationType.SPECIAL_REPAIR_LOOP:case M.AnimationType.SPECIAL_REPAIR_END:case M.AnimationType.SPECIAL_DOCKING:if(this.hasAnimation(M.AnimationType.SPECIAL)&&(e===M.AnimationType.SPECIAL_DOCKING&&this.objectRules.refinery||e!==M.AnimationType.SPECIAL_DOCKING&&this.objectRules.unitRepair)){var[i,r]=this.getNormalizedAnimType(e);this.setAnimationVisibility(i,!0,r);r=this.animObjects.get(i)[r];this.animations.get(r).start(t);break}case M.AnimationType.SPECIAL_SHOOT:if(this.objectRules.isBaseDefense){this.setAnimationVisibility(M.AnimationType.ACTIVE,!1);var[r,s]=this.getNormalizedAnimType(e);this.setAnimationVisibility(r,!0,s);s=this.animObjects.get(r)[s];this.animations.get(s).start(t);break}case M.AnimationType.SUPER_CHARGE_START:case M.AnimationType.SUPER_CHARGE_LOOP:case M.AnimationType.SUPER_CHARGE_END:if(this.objectRules.superWeapon&&this.hasAnimation(M.AnimationType.SUPER)){var[s,a]=this.getNormalizedAnimType(e);this.setAnimationVisibility(s,!0,a);a=this.animObjects.get(s)[a];this.animations.get(a).start(t);break}case M.AnimationType.IDLE:default:this.currentAnimType=M.AnimationType.IDLE,this.objectRules.superWeapon&&this.hasAnimation(M.AnimationType.SUPER)?(this.setAnimationVisibility(M.AnimationType.SUPER,!0,0),a=this.animObjects.get(M.AnimationType.SUPER)[0],this.animations.get(a).start(t)):(this.setAnimationVisibility(M.AnimationType.IDLE,!0),this.animObjects.get(M.AnimationType.IDLE).forEach(e=>{this.animations.get(e).start(t)}))}}doWithAnimation(e,i){var[t,r]=this.getNormalizedAnimType(e);let s=this.animObjects.get(t);if(void 0===s)throw new Error(`Missing animObjects for anim type "${M.AnimationType[t]}"`);t!==e&&(s=[s[r]]),s.forEach((e,t)=>{i(this.animations.get(e),e)})}doWithCurrentAnimation(e){this.doWithAnimation(this.currentAnimType,e)}endCurrentAnimation(){this.doWithCurrentAnimation(e=>e.endLoop())}handleSoundChange(e,t,i,r=1){if(i){var s;this.animSounds.has(t)&&this.animSounds.get(t).isPlaying()||(s=this.worldSound?.playEffect(e,this.gameObject,this.gameObject.owner,r))&&this.animSounds.set(t,s)}else{let e=this.animSounds.get(t);e&&e.isLoop&&(e.stop(),this.animSounds.delete(t))}}onCreate(t){this.renderableManager=t,this.plugins.forEach(e=>e.onCreate(t)),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject,void 0,.25)),this.pipOverlay?.onCreate(t)}onRemove(t){if(this.renderableManager=void 0,this.plugins.forEach(e=>e.onRemove(t)),this.animSounds.forEach(e=>e.stop()),this.ambientSound?.stop(),this.turretRotateSound?.stop(),this.poweredSound?.stop(),this.gameObject.isDestroyed)return this.gameObject.deathType===n.DeathType.Temporal||this.gameObject.deathType===n.DeathType.None?void 0:void(this.objectRules.explosion.length&&this.createExplosionAnims(t))}dispose(){this.plugins.forEach(e=>e.dispose()),this.pipOverlay?.dispose(),this.placeholderObj?.dispose(),this.mainObj?.dispose(),this.rubbleObj?.dispose(),this.bib?.dispose(),this.fireObjects?.forEach(e=>e.dispose()),this.turretBuilders?.forEach(e=>e.dispose()),[...this.animObjects?.values()].forEach(e=>e.forEach(e=>e.dispose()))}}),c.lampTextures=new Map}}}),System.register("engine/renderable/entity/BoxIntersectObject3D",[],function(e,t){"use strict";var s,a,n,o,i;t&&t.id;return{setters:[],execute:function(){s=new THREE.Ray,a=new THREE.Matrix4,n=new THREE.Box3,o=new THREE.Vector3,i=class extends THREE.Object3D{constructor(e){super(),this.boxSize=e}raycast(t,i){if(this.parent){a.getInverse(this.parent.matrixWorld),s.copy(t.ray).applyMatrix4(a),o.copy(this.position);let e=n.setFromCenterAndSize(o,this.boxSize);if(s.intersectsBox(e)){const r=new THREE.Vector3;e.getCenter(r),r.applyMatrix4(this.parent.matrixWorld),i.push({distance:t.ray.origin.distanceTo(r),point:r,object:this})}}}},e("BoxIntersectObject3D",i)}}}),System.register("engine/renderable/entity/unit/RotorHelper",["game/gameobject/unit/ZoneType","util/math"],function(e,t){"use strict";var l,c,i;t&&t.id;return{setters:[function(e){l=e},function(e){c=e}],execute:function(){e("RotorHelper",i=class{static computeRotationStep(e,t,i){var r=e.zone===l.ZoneType.Air,s=e.rules.idleRate,a=r||!!i.idleSpeed||!!s;let n=i.speed??67;r||(i.idleSpeed?n=i.idleSpeed:s&&(n/=s));var o=Math.sign(n),r=Math.abs(THREE.Math.degToRad(n)),s=Math.abs(t);return o*c.clamp(s+.1*(a?1:s/r*-.5),0,r)}})}}}),System.register("engine/renderable/entity/Vehicle",["liang-barsky","game/gameobject/Vehicle","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","engine/ImageFinder","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","data/IniSection","engine/animation/SimpleRunner","util/math","engine/type/ObjectType","game/type/SpeedType","engine/renderable/entity/HighlightAnimRunner","game/gameobject/unit/VeteranLevel","game/gameobject/trait/HarvesterTrait","game/gameobject/common/DeathType","game/gameobject/unit/FacingUtil","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","game/GameSpeed","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(t,e){"use strict";var o,a,S,y,n,p,m,f,w,C,E,x,h,i,s,T,O,r,l,c,A,v,u,d,g,M,b,R,P,I,k;e&&e.id;return{setters:[function(e){o=e},function(e){a=e},function(e){S=e},function(e){y=e},function(e){n=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){h=e},function(e){i=e},function(e){s=e},function(e){T=e},function(e){O=e},function(e){r=e},function(e){l=e},function(e){c=e},function(e){A=e},function(e){v=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){M=e},function(e){b=e},function(e){R=e}],execute:function(){var e;P=Math.PI/4,(e=I=I||{})[e.Grab=0]="Grab",e[e.Shake1=1]="Shake1",e[e.Shake2=2]="Shake2",t("Vehicle",k=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f){this.gameObject=e,this.rules=t,this.imageFinder=r,this.voxels=a,this.voxelAnims=n,this.palette=o,this.camera=l,this.lighting=c,this.debugFrame=h,this.gameSpeed=u,this.selectionModel=d,this.vxlBuilderFactory=g,this.useSpriteBatching=p,this.pipOverlay=m,this.worldSound=f,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new T.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new v.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=e.rules,this.objectArt=e.art,this.label="vehicle_"+this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map(e=>this.palette.clone().remap(e)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new y.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1).addScalar(this.rules.audioVisual.extraUnitLight),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)+this.rules.audioVisual.extraUnitLight)}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach(e=>e.updateLighting?.()),this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new d.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(S.Coords.LEPTONS_PER_TILE)),e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.vxlBuilders.forEach(e=>e.setExtraLight(this.vxlExtraLight)),this.shpRenderable?.setExtraLight(this.shpExtraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}updateClippingPlanes(e,t=!1){if(t||this.objectRules.naval&&!this.objectRules.underwater){var i=S.Coords.tileHeightToWorld(e);let t=[new THREE.Plane(new THREE.Vector3(0,1,0),-i)];this.vxlBuilders.forEach(e=>e.setClippingPlanes(t))}}getIntersectTarget(){return this.target}getUiName(){var e=this.plugins.reduce((e,t)=>t.getUiNameOverride?.()??e,void 0);return void 0!==e?e:this.gameObject.getUiName()}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some(e=>e.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==w.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(i,r=0){this.plugins.forEach(e=>e.update(i)),this.pipOverlay?.update(i),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===O.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var e=this.gameObject.tile.z+this.gameObject.tileElevation,t=void 0===this.lastElevation||this.lastElevation!==e;t&&(this.lastElevation=e,this.updateBaseLight(),this.updateClippingPlanes(this.gameObject.tile.z));var s=this.gameObject.invulnerableTrait.isActive(),a=s!==this.lastInvulnerable;this.lastInvulnerable=s;var n=this.highlightAnimRunner.shouldUpdate();n&&this.highlightAnimRunner.tick(i),s&&a&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(i);var o=this.gameObject.warpedOutTrait.isActive(),l=o!==this.lastWarpedOut;this.lastWarpedOut=o;var c=this.gameObject.cloakableTrait?.isCloaked(),h=c!==this.lastCloaked;this.lastCloaked=c;let u=this.gameObject.submergibleTrait?.isSubmerged();e=u!==this.lastSubmerged;if(this.lastSubmerged=u,l||h||e){let t=o||c||u?.5:1;this.shpRenderable?.setOpacity(t),this.shpRenderable?.setFlat(!!u),this.vxlBuilders.forEach(e=>{e.setOpacity(t),e.setShadow(!u)}),this.placeholder?.setOpacity(t)}if((t||a||s||n)&&(p=s?this.invulnAnimRunner.getValue():0,y=(n?this.highlightAnimRunner.getValue():0)||p,m=this.lighting.getAmbientIntensity(),M.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,m,y),M.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,y)),this.gameObject.isDestroyed&&this.resolveObjectRemove){if(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),this.destroyStartTime||(this.destroyStartTime=i),this.isSinker()){var d=(i-this.destroyStartTime)/3e3,g=1<=d;g?this.mainObj.visible=!1:(this.objectRules.naval&&(this.mainObj.rotation.x=Math.PI/4*d),this.mainObj.position.y=-16*S.Coords.ISO_WORLD_SCALE*d,this.mainObj.position.z=8*S.Coords.ISO_WORLD_SCALE*d,this.mainObj.updateMatrix());let e=!1;this.sinkWakeAnims.forEach(e=>e.update(i)),this.sinkWakeAnims.filter(e=>!e.isAnimFinished()).length||(this.sinkWakeAnims.forEach(e=>this.get3DObject().remove(e.get3DObject())),this.sinkWakeAnims.length=0,e=!0),g&&e&&this.resolveObjectRemove()}}else if(!this.gameObject.warpedOutTrait.isActive()){let e=(Math.floor(this.gameObject.direction+this.gameObject.spinVelocity*r)+360)%360;var p=e!==this.lastDirection;p&&void 0!==this.lastDirection&&this.objectArt.isVoxel&&this.gameObject.zone===A.ZoneType.Air&&(T=e-this.lastDirection,void 0!==this.lastDirectionDelta&&Math.abs(T)<2&&Math.abs(this.lastDirectionDelta)<2&&Math.sign(T)!==Math.sign(this.lastDirectionDelta)?e=this.lastDirection:this.lastDirectionDelta=T),this.lastDirection=e;var m=this.gameObject.owner.color;this.lastOwnerColor!==m&&(this.palette.remap(m),this.lastOwnerColor=m,this.vxlBuilders.forEach(e=>e.setPalette(this.palette)),this.shpRenderable?.setPalette(this.palette),this.placeholder?.setPalette(this.palette));var f,y=this.gameObject.isMoving||!this.objectArt.isVoxel&&!!this.gameObject.spinVelocity,d=this.gameObject.isFiring,g=void 0===this.lastMoving||this.lastMoving!==y,T=void 0===this.lastFiring||this.lastFiring!==d;if(0<r&&(y||g)){let e=this.gameObject.moveTrait.velocity.clone(),t=e.multiplyScalar(r);m=t.add(this.gameObject.position.worldPosition);this.setPosition(m)}(g||T)&&(this.lastMoving=y,this.lastFiring=d,this.objectArt.isVoxel||this.updateShapeAnimation(y,d));let t;if(this.gameObject.rules.isChargeTurret){if(T&&d){this.chargeTurretRunner=new x.SimpleRunner;let e=new C.AnimProps(new E.IniSection("dummy"),this.gameObject.rules.turretCount);e.reverse=!0,e.rate=5;var v=new w.Animation(e,this.gameSpeed);this.chargeTurretRunner.animation=v}this.chargeTurretRunner?.tick(i);var b=this.chargeTurretRunner?.getCurrentFrame()??0;t=b!==this.currentTurretIdx,this.currentTurretIdx=b,this.chargeTurretRunner?.animation.getState()===w.AnimationState.STOPPED&&(this.chargeTurretRunner=void 0)}else t=this.gameObject.turretNo!==this.currentTurretIdx,this.currentTurretIdx=this.gameObject.turretNo;this.objectArt.isVoxel?(this.updateVxlRotation(e,p),this.updateBodyVxl(),v=(T=this.gameObject.rocking?.facing)!==this.lastRockingFacing,this.lastRockingFacing=T,!v||void 0===T||0<(f=this.gameObject.rocking.factor)&&this.startRocking(T,f,i),f=(b=!(!this.gameObject.parasiteableTrait?.isInfested()||!this.gameObject.parasiteableTrait.getParasite()?.rules.organic))!==this.lastSquidGrabbed,this.lastSquidGrabbed=b,this.updateRocking(i,b),1<this.objectRules.turretCount&&t&&this.updateActiveTurret(this.currentTurretIdx),this.updateSquidGrab(i,b,f,p,e,T,v)):this.shpAnimRunner&&(this.shpAnimRunner.tick(i),this.updateShapeFrame(e,y,d))}}updateVxlRotation(e,t){var i,r=this.gameObject.tilterTrait?.tilt??{yaw:0,pitch:0};this.lastTilt&&(r.pitch===this.lastTilt.pitch&&r.yaw===this.lastTilt.yaw)&&!t||(this.lastTilt=r,this.tiltObj.rotation.y=THREE.Math.degToRad(r.yaw),this.tiltObj.rotation.x=THREE.Math.degToRad(r.pitch),this.tiltObj.updateMatrix(),this.dirWrapObj.rotation.y=THREE.Math.degToRad(e-r.yaw),this.dirWrapObj.updateMatrix()),this.turret&&(r=(i=Math.floor(this.gameObject.turretTrait.facing))!==this.lastTurretFacing,this.lastTurretFacing=i,(r||t)&&(i=THREE.Math.degToRad(i-e),this.turret.rotation.y=i,this.turret.updateMatrix(),this.barrel&&(this.barrel.rotation.y=i,this.barrel.updateMatrix()))),this.rotors&&this.rotors.forEach((e,t)=>{this.rotorSpeeds[t]=g.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[t]??0,this.objectArt.rotors[t]),this.rotorSpeeds[t]&&(e.rotateOnAxis(this.objectArt.rotors[t].axis,this.rotorSpeeds[t]),e.updateMatrix())})}startRocking(i,r,s){if(this.bodyVxlBuilder){this.rockingStartTime=s,this.rockingFactor=r;var a=this.bodyVxlBuilder.getLocalBoundingBox();let e=new THREE.Box2(new THREE.Vector2(a.min.x,a.min.y),new THREE.Vector2(a.max.x,a.max.y));var n=THREE.Math.degToRad(c.FacingUtil.toWorldDeg(i)),a=new THREE.Vector2;let t=new THREE.Vector2(10,0).rotateAround(new THREE.Vector2,n).setLength(e.getSize(a).length()+1);a=t.toArray();o.default([0,0],a,[e.min.x,e.min.y,e.max.x,e.max.y]),this.rockingPoint=new THREE.Vector3(a[0],0,a[1]);a=t.clone().rotateAround(new THREE.Vector2,-Math.PI/2).normalize();this.rockingAxis=new THREE.Vector3(a.x,0,a.y)}}updateRocking(t,i){if(this.rockingStartTime){var r=t-this.rockingStartTime;let e=this.rockingFactor;i||(e*=1-Math.min(1,this.gameObject.rules.weight/5));var s=r||e?Math.min(1,r/(a.ROCKING_TICKS/u.GameSpeed.BASE_TICKS_PER_SECOND*1e3)*this.gameSpeed.value/e):0,r=P*e*(1-Math.pow(2*(s-.5),2));this.rockingTiltObj.position.set(0,0,0),this.rockingTiltObj.rotation.set(0,0,0),this.rockingTiltObj.scale.set(1,1,1),R.MathUtils.rotateObjectAboutPoint(this.rockingTiltObj,this.rockingPoint,this.rockingAxis,r),this.rockingTiltObj.updateMatrix(),1!==s&&0!==e||(this.rockingStartTime=void 0)}}updateSquidGrab(e,t,i,r,s,a,n){var o;if(i&&(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),t&&(this.squidGrabAnim=this.renderableManager.createAnim("SQDG",e=>{e.extraOffset={x:0,y:-S.Coords.ISO_TILE_SIZE/4},e.setExtraLight(this.shpExtraLight)},!0),this.squidGrabAnim.remapColor(this.gameObject.parasiteableTrait.getParasite().owner.color),this.squidGrabAnim.create3DObject(),this.posObj?.add(this.squidGrabAnim.get3DObject()))),t&&(r||i)&&this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),s,I.Grab),t&&n&&a&&(o=0<a?I.Shake1:I.Shake2,this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),s,o),this.squidGrabAnim.reset()),t&&n&&!a){var l=this.rules.combatDamage.splashList;for(let e=0;e<3;e++){var c=l[h.getRandomInt(0,l.length-1)];this.renderableManager.createTransientAnim(c,e=>{let t=this.withPosition.getPosition().clone();var i={x:h.getRandomInt(-S.Coords.ISO_TILE_SIZE/2,S.Coords.ISO_TILE_SIZE/2)*S.Coords.ISO_WORLD_SCALE,y:h.getRandomInt(-S.Coords.ISO_TILE_SIZE/2,S.Coords.ISO_TILE_SIZE/2)*S.Coords.ISO_WORLD_SCALE};e.setPosition(t.add(new THREE.Vector3(i.x,0,i.y)))})}}this.squidGrabAnim?.update(e)}updateShapeAnimation(t,i){if(this.shpAnimRunner){let e=this.shpAnimRunner.animation.props;var r;i?(e.loopEnd=this.objectArt.firingFrames-1,e.rate=C.AnimProps.defaultRate/2):t||this.objectRules.naval?(e.loopEnd=this.objectArt.walkFrames-1,r=this.objectRules.naval&&!t?this.objectRules.idleRate:this.objectRules.walkRate,e.rate=C.AnimProps.defaultRate/r):e.loopEnd=0,this.shpAnimRunner.animation.rewind()}}updateShapeFrame(t,i,r){if(this.shpRenderable&&this.shpAnimRunner){let e;var s,a=Math.round((45-t+360)%360/360*8)%8;e=r?(s=this.shpAnimRunner.animation.getCurrentFrame(),8*this.objectArt.walkFrames+8+this.objectArt.firingFrames*a+s):i||this.objectRules.naval?(s=this.shpAnimRunner.animation.getCurrentFrame(),this.objectArt.walkFrames*a+s):8*this.objectArt.walkFrames+a,this.shpRenderable.setFrame(e)}}updateSquidGrabAnim(e,t,i){var r=Math.round((360-t)%360/360*8)%8;e.start=10*r+80*i,e.end=10*r+9+80*i,e.loopStart=e.start,e.loopEnd=e.end,e.loopCount=0,e.rate=10/(a.ROCKING_TICKS/u.GameSpeed.BASE_TICKS_PER_SECOND/(this.rockingFactor??1))}createObjects(t){if(this.debugFrame.value){let e=n.DebugUtils.createWireframe({width:1,height:1},1);e.translateX(-S.Coords.getWorldTileSize()/2),e.translateZ(-S.Coords.getWorldTileSize()/2),t.add(e)}let e=this.tiltObj=new THREE.Object3D;e.matrixAutoUpdate=!1,e.rotation.order="YXZ";let i=this.dirWrapObj=new THREE.Object3D;i.matrixAutoUpdate=!1;var r=this.mainObj=this.createMainObject();let s=this.rockingTiltObj=new THREE.Object3D;s.matrixAutoUpdate=!1,s.rotation.order="YXZ",s.add(r),i.add(s),e.add(i);let a=this.posObj=new THREE.Object3D;a.matrixAutoUpdate=!1,a.add(e),t.add(a)}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x,y:e.y+t.y}}createMainObject(){let n=new THREE.Object3D;if(n.matrixAutoUpdate=!1,this.objectArt.isVoxel){var o=!this.objectArt.noHva,e=this.objectArt.imageName.toLowerCase(),t=e+".vxl",r=this.voxels.get(t);if(r){var s=o?this.voxelAnims.get(e+".hva"):void 0;let i=this.bodyVxlBuilder=this.vxlBuilderFactory.create(r,s,this.paletteRemaps,this.palette);this.vxlBuilders.push(i);s=this.mainVxl=i.build();n.add(s),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map(e=>{var t=i.getSection(e.name);if(!t)throw new Error(`Vehicle "${this.objectRules.name}" VXL section "${e.name}" not found`);return t}))}else console.warn(`VXL missing for vehicle ${this.objectRules.name}. Vxl file ${t} not found. `),n.add(this.createPlaceholder());if(this.objectRules.spawns&&this.objectRules.noSpawnAlt){let i=e+"wo.vxl";var a=this.voxels.get(i);if(a){var l=o?this.voxelAnims.get(i.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(a,l,this.paletteRemaps,this.palette);this.vxlBuilders.push(e);let t=this.noSpawnAltVxl=e.build();t.visible=!1,n.add(t)}else console.warn(`<${this.gameObject.name}>: Couldn't find noSpawnAlt image "${i}"`)}if(this.gameObject.harvesterTrait&&this.objectRules.unloadingClass){var c=this.rules.getObject(this.objectRules.unloadingClass,i.ObjectType.Vehicle).imageName.toLowerCase(),a=this.voxels.get(c+".vxl");if(a){l=o?this.voxelAnims.get(c+".hva"):void 0;let e=this.vxlBuilderFactory.create(a,l,this.paletteRemaps,this.palette);this.vxlBuilders.push(e);let t=this.harvesterAltVxl=e.build();t.visible=!1,n.add(t)}else console.warn(`<${this.gameObject.name}>: Couldn't find UnloadingClass image "${c}.vxl"`)}if(this.gameObject.turretTrait){c=this.objectArt.turretOffset;let t=n;if(c){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,e.position.z=-c,e.updateMatrix(),n.add(e),t=e}let r=[];for(let a=0;a<this.objectRules.turretCount;++a){let i=e+`tur${a||""}.vxl`;var h=this.voxels.get(i);if(h){var u=o?this.voxelAnims.get(i.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(h,u,this.paletteRemaps,this.palette);this.vxlBuilders.push(e);let t=e.build();t.visible=a===this.gameObject.turretNo,r.push(t)}else console.warn(`<${this.gameObject.name}>: Missing turret file "${i}"`),r.push(void 0)}this.currentTurretIdx=this.gameObject.turretNo,this.allTurrets=r;let i;1<r.length?(i=this.turret=new THREE.Object3D,i.matrixAutoUpdate=!1,r.forEach(e=>e&&i.add(e))):i=this.turret=r[0],i&&t.add(i);let s=e+"barl.vxl";c=this.voxels.get(s);if(c){var d=o?this.voxelAnims.get(s.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(c,d,this.paletteRemaps,this.palette);this.vxlBuilders.push(e);var g=this.barrel=e.build();t.add(g)}}}else{let e=new f.MapSpriteTranslation(1,1);var{spriteOffset:d,anchorPointWorld:g}=e.compute(),d=this.computeSpriteAnchorOffset(d);let i;try{i=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(!(e instanceof m.ImageFinder.MissingImageError))throw e;console.warn(`<${this.gameObject.name}>: `+e.message)}if(i){let e=this.shpRenderable=p.ShpRenderable.factory(i,this.palette,this.camera,d,this.objectArt.hasShadow);e.setBatched(this.useSpriteBatching),this.useSpriteBatching&&e.setBatchPalettes(this.paletteRemaps),e.create3DObject(),n.add(e.get3DObject()),n.position.x=g.x,n.position.z=g.y,n.updateMatrix();let t=new C.AnimProps(new E.IniSection("dummy"),i);t.loopCount=-1;g=new w.Animation(t,this.gameSpeed);this.shpAnimRunner=new x.SimpleRunner,this.shpAnimRunner.animation=g}else n.add(this.createPlaceholder())}return n}createPlaceholder(){return this.placeholder=new b.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject()}updateActiveTurret(i){this.allTurrets.forEach((e,t)=>{e&&(e.visible=t===i)})}updateBodyVxl(){var e=!!this.noSpawnAltVxl&&!this.gameObject.airSpawnTrait.availableSpawns,t=!!this.harvesterAltVxl&&!!this.gameObject.harvesterTrait&&[r.HarvesterStatus.PreparingToUnload,r.HarvesterStatus.Unloading].includes(this.gameObject.harvesterTrait.status);this.noSpawnAltVxl&&(this.noSpawnAltVxl.visible=e),this.harvesterAltVxl&&(this.harvesterAltVxl.visible=t),this.mainVxl&&(this.mainVxl.visible=!e&&!t)}isSinker(){return this.gameObject.zone===A.ZoneType.Water&&this.gameObject.isSinker}onCreate(t){this.renderableManager=t,this.plugins.forEach(e=>e.onCreate(t)),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject))}onRemove(t){if(this.renderableManager=void 0,this.plugins.forEach(e=>e.onRemove(t)),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.isVehicle()&&this.get3DObject()){if(this.gameObject.deathType===l.DeathType.Temporal)return;if(this.gameObject.deathType===l.DeathType.None)return;if(this.gameObject.deathType===l.DeathType.Crush)return;if(!this.isSinker()||this.objectRules.underwater||this.gameObject.deathType!==l.DeathType.Sink&&this.objectRules.speedType===s.SpeedType.Hover){if(this.objectRules.underwater&&this.objectRules.organic)return;if(!this.objectRules.explosion.length)return;if(this.gameObject.explodes&&this.objectRules.deathWeapon)return;var e=this.objectRules.explosion,e=e[h.getRandomInt(0,e.length-1)];return void t.createTransientAnim(e,e=>e.setPosition(this.withPosition.getPosition()))}if(this.isSinker()){var i=this.rules.audioVisual.wake;this.sinkWakeAnims=[];for(let e=0;e<5;e++){let e=t.createAnim(i,void 0,!0);var r={x:h.getRandomInt(-15,15)*S.Coords.ISO_WORLD_SCALE,y:h.getRandomInt(-15,15)*S.Coords.ISO_WORLD_SCALE};e.setPosition(new THREE.Vector3(r.x,0,r.y)),this.sinkWakeAnims.push(e),e.create3DObject(),this.get3DObject().add(e.get3DObject())}this.gameObject.rules.naval||this.updateClippingPlanes(this.gameObject.tile.z,!0)}return new Promise(e=>this.resolveObjectRemove=e)}}dispose(){this.plugins.forEach(e=>e.dispose()),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.vxlBuilders.forEach(e=>e.dispose()),this.sinkWakeAnims?.forEach(e=>e.dispose()),this.squidGrabAnim?.dispose(),this.placeholder?.dispose()}})}}}),System.register("engine/renderable/builder/BatchShpBuilder",["engine/renderable/builder/ShpTextureAtlas","engine/gfx/SpriteUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial"],function(e,t){"use strict";var i,l,c,h,r;t&&t.id;return{setters:[function(e){i=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("BatchShpBuilder",r=class{constructor(e,t,i,r,s=1,a=!1,n=1e4,o=1){this.shpFile=e,this.palette=t,this.camera=i,this.textureCache=r,this.opacity=s,this.transparent=a,this.batchSize=n,this.scale=o,this.specIndexes=new Map}get verticesPerSprite(){return l.SpriteUtils.VERTICES_PER_SPRITE}get trianglesPerSprite(){return l.SpriteUtils.TRIANGLES_PER_SPRITE}initTexture(){var e;this.textureCache.has(this.shpFile)?this.atlas=this.textureCache.get(this.shpFile):(e=(new i.ShpTextureAtlas).fromShpFile(this.shpFile),this.textureCache.set(this.shpFile,e),this.atlas=e)}getSpriteGeometryOptions(e){var t=this.shpFile.getImage(e.frameNo),t={x:t.x-e.shpFile.width/2+e.offset.x,y:t.y-e.shpFile.height/2+e.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(e.frameNo),flat:e.flat,depth:e.depth,align:{x:1,y:-1},offset:t,camera:this.camera,scale:this.scale}}setPalette(t){if(this.palette=t,this.mesh){var i=c.TextureUtils.textureFromPalette(t);let e=this.mesh.material;e.palette=i}}build(){if(this.mesh)return this.mesh;this.initTexture();var e=c.TextureUtils.textureFromPalette(this.palette);let t=new THREE.BufferGeometry;var i,r=this.batchSize*this.verticesPerSprite,s=new THREE.BufferAttribute(new Float32Array(3*r),3);t.addAttribute("position",s),this.positionAttribute=s,t.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(2*r),2)),l.SpriteUtils.USE_INDEXED_GEOMETRY&&(i=this.batchSize*this.trianglesPerSprite*3,t.setIndex(new THREE.BufferAttribute(new Uint32Array(3*i),1)));var a,r=new THREE.BufferAttribute(new Float32Array(4*r),4);t.addAttribute("vertexColorMult",r),this.colorMultAttribute=r;let n=0;for(a of this.specIndexes.keys())this.specIndexes.set(a,n),this.setSpecGeometry(a,t,n),n++;if(this.firstFreeSpriteIdx=n<this.batchSize?n:-1,n<this.batchSize){let e=s.array;for(let t=n;t<this.batchSize-1;t++)e[t*this.verticesPerSprite*3]=t+1;e[(this.batchSize-1)*this.verticesPerSprite*3]=-1}e=new h.PaletteBasicMaterial({map:this.atlas.getTexture(),palette:e,alphaTest:this.transparent?.05:.5,flatShading:!0,transparent:this.transparent,opacity:this.opacity,useVertexColorMult:!0});let o=new THREE.Mesh(t,e);return o.matrixAutoUpdate=!1,o.frustumCulled=!1,this.mesh=o,o}add(e){if(!this.specIndexes.has(e)){if(this.isFull())throw new Error("Batch is full");var t=this.mesh?.geometry;if(t){var i=this.firstFreeSpriteIdx;if(-1===i)throw new Error("No free sprite index found");this.specIndexes.set(e,i);var r=(this.positionAttribute?.array)[i*this.verticesPerSprite*3];this.setSpecGeometry(e,t,i),this.firstFreeSpriteIdx=r}else this.specIndexes.set(e,void 0)}}setSpecGeometry(e,t,i){var r=this.getSpriteGeometryOptions(e);let s=l.SpriteUtils.createSpriteGeometry(r);r=e.position;s.applyMatrix((new THREE.Matrix4).makeTranslation(r.x,r.y,r.z));let a=s;if(a.getAttribute("position").count!==this.verticesPerSprite)throw new Error("Vertex count mismatch");t.merge(a,i*this.verticesPerSprite),a.index&&(t.index.array.set(Uint32Array.from(a.index.array,e=>e+i*this.verticesPerSprite),i*a.index.array.length),t.index.needsUpdate=!0);var n,r=e.lightMult??new THREE.Vector3(1,1,1);this.setLightingAt(i,r,this.colorMultAttribute.array),this.setVisibilityAt(i,!0,this.colorMultAttribute.array);for(n of Object.values(t.attributes))n.needsUpdate=!0}has(e){return this.specIndexes.has(e)}remove(t){if(this.specIndexes.has(t)){if(this.mesh){var i=this.specIndexes.get(t);this.setVisibilityAt(i,!1,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0;let e=this.positionAttribute.array;e[i*this.verticesPerSprite*3]=this.firstFreeSpriteIdx,this.firstFreeSpriteIdx=i}this.specIndexes.delete(t)}}update(e){var t;!this.specIndexes.has(e)||(t=this.mesh?.geometry)&&this.setSpecGeometry(e,t,this.specIndexes.get(e))}isFull(){return this.specIndexes.size===this.batchSize}isEmpty(){return 0===this.specIndexes.size}setLightingAt(e,t,i){for(let r=0;r<this.verticesPerSprite;r++)i[e*this.verticesPerSprite*4+4*r]=t.x,i[e*this.verticesPerSprite*4+4*r+1]=t.y,i[e*this.verticesPerSprite*4+4*r+2]=t.z}setVisibilityAt(e,t,i){for(let r=0;r<this.verticesPerSprite;r++)i[e*this.verticesPerSprite*4+4*r+3]=t?1:0}updateLighting(){if(this.mesh){let r=this.colorMultAttribute.array;this.specIndexes.forEach((e,t)=>{var i=t.lightMult??new THREE.Vector3(1,1,1);this.setLightingAt(e,i,r)}),this.colorMultAttribute.needsUpdate=!0}}dispose(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose())}})}}}),System.register("engine/renderable/entity/map/MapSpriteBatchLayer",["game/Coords","engine/ImageFinder","engine/renderable/builder/BatchShpBuilder","engine/renderable/builder/ShpAggregator","engine/renderable/MapSpriteTranslation","engine/renderable/ShadowRenderable","util/typeGuard"],function(e,t){"use strict";var n,r,o,s,l,c,i,a;t&&t.id;return{setters:[function(e){n=e},function(e){r=e},function(e){o=e},function(e){s=e},function(e){l=e},function(e){c=e},function(e){i=e}],execute:function(){e("MapSpriteBatchLayer",a=class{constructor(e,t,i,r,s,a,n,o,l){this.label=e,this.spriteUseDepth=i,this.theater=r,this.art=s,this.imageFinder=a,this.camera=n,this.lighting=o,this.shpAggregator=l,this.textureCache=new Map,this.batchShpSpecsByObject=new Map,this.batchShpBuilders=new Map,this.shadowBatchShpBuilders=[],this.batchedObjectRules=new Set(t),this.aggregatedImageData=this.createAggregatedShpFile(`agg_${e}.shp`)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,e.matrixAutoUpdate=!1,this.target=e)}createAggregatedShpFile(e){var t=[...this.batchedObjectRules.values()].map(e=>{var t=this.art.getObject(e.name,e.type);let i;try{i=this.imageFinder.findByObjectArt(t)}catch(e){if(e instanceof r.ImageFinder.MissingImageError)return;throw e}return s.ShpAggregator.getShpFrameInfo(i,t.hasShadow)}).filter(i.isNotNullOrUndefined);return this.shpAggregator.aggregate(t,e)}update(e){}updateLighting(){this.batchShpSpecsByObject.forEach((e,t)=>{e.main.lightMult?.copy(this.lighting.compute(t.art.lightingType,t.tile))}),[...this.batchShpBuilders.values()].flat().forEach(e=>e.updateLighting())}shouldBeBatched(e){return this.batchedObjectRules.has(e.rules)}getBatchKey(e){return e.art.paletteType+"_"+e.art.customPaletteName}addObject(t){var e=this.getBatchKey(t);let i=this.batchShpBuilders.get(e);i||(i=[],this.batchShpBuilders.set(e,i));let r=i.find(e=>!e.isFull());if(!r){if(!this.get3DObject())throw new Error("Not implemented");{var s=this.theater.getPalette(t.art.paletteType,t.art.customPaletteName);let e=new o.BatchShpBuilder(this.aggregatedImageData.file,s,this.camera,this.textureCache,void 0,void 0,void 0,n.Coords.ISO_WORLD_SCALE);i.push(e),this.get3DObject().add(e.build()),r=e}}s=this.buildBatchShpSpec(t,this.aggregatedImageData);r.add(s);let a;if(t.art.hasShadow){let t=this.shadowBatchShpBuilders.find(e=>!e.isFull());if(!t){if(!this.get3DObject())throw new Error("Not implemented");{let e=new o.BatchShpBuilder(this.aggregatedImageData.file,c.ShadowRenderable.getOrCreateShadowPalette(),this.camera,this.textureCache,.5,!0,void 0,n.Coords.ISO_WORLD_SCALE);this.shadowBatchShpBuilders.push(e),this.get3DObject().add(e.build()),t=e}}a=this.buildShadowBatchShpSpec(s,this.aggregatedImageData),t.add(a)}this.batchShpSpecsByObject.set(t,{main:s,shadow:a})}buildBatchShpSpec(e,t){var i=e.getFoundation();let r=new l.MapSpriteTranslation(i.width,i.height),s=e.position.worldPosition.clone(),{spriteOffset:a,anchorPointWorld:n}=r.compute();s.x+=n.x,s.z+=n.y;var o=this.imageFinder.findByObjectArt(e.art),i=t.imageIndexes.get(o);if(void 0===i)throw new Error("SHP file not found in aggregated image data");return{shpFile:o,frameNo:i,depth:this.spriteUseDepth(e),flat:e.art.flat,position:s,offset:a.clone().add(e.art.getDrawOffset()),lightMult:this.lighting.compute(e.art.lightingType,e.tile)}}buildShadowBatchShpSpec(e,t){var i=t.imageIndexes.get(e.shpFile);if(void 0===i)throw new Error("SHP file not found in aggregated image data");return{...e,position:e.position.clone().add(new THREE.Vector3(0,.1,0)),flat:!0,frameNo:i+t.file.numImages/2,lightMult:void 0}}removeObject(i){const r=this.batchShpSpecsByObject.get(i);if(r){var s=this.getBatchKey(i);let e=this.batchShpBuilders.get(s),t=e?.find(e=>e.has(r.main));if(t){if(t.remove(r.main),t.isEmpty()&&1<e.length&&(this.get3DObject()?.remove(t.build()),t.dispose(),e?.splice(e.indexOf(t),1)),r.shadow){let e=this.shadowBatchShpBuilders.find(e=>e.has(r.shadow));e?.remove(r.shadow),e?.isEmpty()&&1<this.shadowBatchShpBuilders.length&&(this.get3DObject()?.remove(e.build()),e.dispose(),this.shadowBatchShpBuilders.splice(this.shadowBatchShpBuilders.indexOf(e),1))}this.batchShpSpecsByObject.delete(i)}}}hasObject(e){return this.batchShpSpecsByObject.has(e)}setObjectFrame(t,i){const r=this.batchShpSpecsByObject.get(t);if(!r)throw new Error(`Batch SHP spec for object "${t.name}" not found`);if(!(i>=r.main.shpFile.numImages*(r.shadow?.5:1))){var s=this.aggregatedImageData.imageIndexes.get(r.main.shpFile);r.main.frameNo=s+i,r.shadow&&(r.shadow.frameNo=r.main.frameNo+this.aggregatedImageData.file.numImages/2);s=this.getBatchKey(t);let e=this.batchShpBuilders.get(s)?.find(e=>e.has(r.main));if(e?.update(r.main),r.shadow){let e=this.shadowBatchShpBuilders.find(e=>e.has(r.shadow));e?.update(r.shadow)}}}dispose(){[...this.batchShpBuilders.values(),...this.shadowBatchShpBuilders].flat().forEach(e=>e.dispose()),[...this.textureCache.values()].forEach(e=>e.dispose()),this.textureCache.clear()}})}}}),System.register("engine/renderable/entity/Terrain",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","game/gameobject/trait/TiberiumTreeTrait","engine/animation/SimpleRunner","engine/AnimProps","engine/Animation","data/IniSection","engine/renderable/AlphaRenderable"],function(e,t){"use strict";var i,r,s,l,c,a,h,u,d,g,p,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){l=e},function(e){c=e},function(e){a=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){e("Terrain",n=class{constructor(e,t,i,r,s,a,n,o,l){this.gameObject=e,this.terrainLayer=t,this.imageFinder=i,this.palette=r,this.camera=s,this.lighting=a,this.debugFrame=n,this.gameSpeed=o,this.useSpriteBatching=l,this.objectArt=e.art,this.label="terrain_"+e.rules.name,this.init()}init(){this.tiberiumTreeTrait=this.gameObject.traits.find(a.TiberiumTreeTrait),this.withPosition=new i.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(e){var t;this.tiberiumTreeTrait&&((t=this.tiberiumTreeTrait.status)!==this.lastTiberiumSpawnStatus&&(this.lastTiberiumSpawnStatus=t)===a.SpawnStatus.Spawning&&this.animationRunner?.animation.reset(),this.animationRunner&&(this.animationRunner.tick(e),this.animationRunner.animation.getState()!==d.AnimationState.STOPPED?this.mainObj.setFrame(this.animationRunner.getCurrentFrame()):this.mainObj.setFrame(0)))}createObjects(a){var n={width:1,height:1};this.debugFrame.value&&(t=s.DebugUtils.createWireframe(n,2),a.add(t));let o;try{o=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(e instanceof r.ImageFinder.MissingImageError)return void console.warn(e.message);throw e}var e=this.gameObject.rules.alphaImage;if(e){var t=this.imageFinder.tryFind(e,!1);if(t){let e=new p.AlphaRenderable(t,this.camera,this.objectArt.getDrawOffset());e.create3DObject(),a.add(e.get3DObject())}else console.warn(`<${this.gameObject.name}>: Alpha image "${e}" not found`)}if(this.terrainLayer?.shouldBeBatched(this.gameObject))this.terrainLayer.addObject(this.gameObject);else{let e=new THREE.Object3D;e.matrixAutoUpdate=!1;let t=new l.MapSpriteTranslation(n.width,n.height),{spriteOffset:i,anchorPointWorld:r}=t.compute();e.position.x=r.x,e.position.z=r.y,e.updateMatrix();n=i.clone().add(this.objectArt.getDrawOffset());let s=c.ShpRenderable.factory(o,this.palette,this.camera,n,this.objectArt.hasShadow);if(s.setBatched(this.useSpriteBatching),this.useSpriteBatching&&s.setBatchPalettes([this.palette]),s.setFrame(0),s.setExtraLight(this.extraLight),s.create3DObject(),e.add(s.get3DObject()),this.mainObj=s,this.tiberiumTreeTrait){let e=new g.IniSection("dummy");this.gameObject.rules.animationRate&&(e.set("Rate",""+60*this.gameObject.rules.animationRate),e.set("Shadow","yes"));n=new u.AnimProps(e,o);let t=new d.Animation(n,this.gameSpeed);this.animationRunner=new h.SimpleRunner,this.animationRunner.animation=t,t.stop()}a.add(e)}}onRemove(){this.terrainLayer?.hasObject(this.gameObject)&&this.terrainLayer.removeObject(this.gameObject)}dispose(){this.mainObj?.dispose()}})}}}),System.register("engine/renderable/entity/Overlay",["data/ShpFile","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","util/math","game/map/BridgeOverlayTypes","engine/type/ObjectType","game/gameobject/common/DeathType","engine/renderable/entity/BoxIntersectObject3D","engine/gfx/MathUtils","engine/renderable/entity/map/MapSurface"],function(e,t){"use strict";var n,h,i,s,u,a,o,d,l,c,r,g,p,m;t&&t.id;return{setters:[function(e){n=e},function(e){h=e},function(e){i=e},function(e){s=e},function(e){u=e},function(e){a=e},function(e){o=e},function(e){d=e},function(e){l=e},function(e){c=e},function(e){r=e},function(e){g=e},function(e){p=e}],execute:function(){e("Overlay",m=class{constructor(e,t,i,r,s,a,n,o,l,c,h){this.gameObject=e,this.rules=t,this.art=i,this.imageFinder=r,this.palette=s,this.camera=a,this.lighting=n,this.debugFrame=o,this.bridgeImageCache=l,this.mapOverlayLayer=c,this.useSpriteBatching=h,this.isInvisible=!1,this.objectRules=e.rules,this.objectArt=e.art,this.label="overlay_"+this.objectRules.name,this.init()}init(){this.withPosition=new i.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){var e=this.objectArt.lightingType;this.extraLight.copy(this.lighting.compute(e,this.gameObject.tile,this.gameObject.isHighBridge()?4:0)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}update(e){var t;this.isInvisible||(t=1e4*this.gameObject.overlayId+this.gameObject.value)!==this.lastOverlayHash&&(this.lastOverlayHash=t,t=this.computeFrame(),this.mainRenderable?t<this.mainRenderable.frameCount&&this.mainRenderable.setFrame(t):this.mapOverlayLayer.setObjectFrame(this.gameObject,t))}computeFrame(){let e=this.gameObject,t=e.value;return e.isBridge()&&0===t&&(t=o.getRandomInt(0,3)),t}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}getIntersectTarget(){return this.intersectTarget}getUiName(){return this.gameObject.getUiName()}createObjects(n){var o=this.gameObject.getFoundation();if(this.debugFrame.value&&(c=this.createWireframe(o,1),n.add(c)),this.objectRules.isRubble||this.gameObject.isBridgePlaceholder())this.isInvisible=!0;else{var l=this.gameObject.isBridge()||this.gameObject.isTiberium()||this.gameObject.rules.wall;if(this.mapOverlayLayer?.shouldBeBatched(this.gameObject)){if(this.mapOverlayLayer.addObject(this.gameObject),l){let e=new r.BoxIntersectObject3D(new THREE.Vector3(1,0,1).multiplyScalar(h.Coords.LEPTONS_PER_TILE));e.position.add(new THREE.Vector3(o.width/2,0,o.height/2).multiplyScalar(h.Coords.LEPTONS_PER_TILE)),e.matrixAutoUpdate=!1,e.updateMatrix(),n.add(e),this.intersectTarget=e}}else{let t=new THREE.Object3D;t.matrixAutoUpdate=!1;let e=new u.MapSpriteTranslation(o.width,o.height),{spriteOffset:i,anchorPointWorld:r}=e.compute();var c=i.clone().add(this.objectArt.getDrawOffset());let s;if(this.gameObject.isLowBridge()){o=d.BridgeOverlayTypes.getOverlayBridgeType(this.gameObject.overlayId);let e=this.bridgeImageCache.get(o);e||(e=this.buildVirtualBridgeFile(o),this.bridgeImageCache.set(o,e)),s=e}else s=this.imageFinder.findByObjectArt(this.objectArt);let a=this.mainRenderable=this.createMainObject(s,c);a.create3DObject(),t.add(a.get3DObject()),l&&a&&(this.intersectTarget=a.getShapeMesh());c=h.Coords.getWorldTileSize();t.position.x=r.x,t.position.z=r.y;l=this.gameObject.isXBridge();if(this.gameObject.isBridge()&&(t.position.x+=c/2,t.position.z+=c/2,t.position.x+=l?0:c,t.position.z+=l?c:0),this.gameObject.isHighBridge()){t.position.x-=+h.Coords.ISO_WORLD_SCALE,t.position.z-=+h.Coords.ISO_WORLD_SCALE,t.position.x+=c+(l?.5*c:0),t.position.z+=c+(l?.5*c:0);let e=a.getShadowMesh();e&&(g.MathUtils.translateTowardsCamera(e,this.camera,(p.MAGIC_OFFSET+.05)*h.Coords.ISO_WORLD_SCALE),e.updateMatrix());c=this.createBridgeShadowSurface();n.add(c)}t.updateMatrix(),n.add(t)}}}buildVirtualBridgeFile(e){var t=e===d.OverlayBridgeType.Concrete?d.BridgeOverlayTypes.minLowBridgeConcreteId:d.BridgeOverlayTypes.minLowBridgeWoodId,i=e===d.OverlayBridgeType.Concrete?d.BridgeOverlayTypes.maxLowBridgeConcreteId:d.BridgeOverlayTypes.maxLowBridgeWoodId;let r=new n.ShpFile;r.filename="agg_"+this.gameObject.name+".shp";for(let a=t;a<=i;a++){var s=this.rules.getOverlay(this.rules.getOverlayName(a)),s=this.art.getObject(s.name,l.ObjectType.Overlay);let e=this.imageFinder.findByObjectArt(s);r.width||(r.width=e.width,r.height=e.height),r.addImage(e.getImage(1))}return r}createBridgeShadowSurface(){var e=this.gameObject.getFoundation(),t=e.width*h.Coords.getWorldTileSize(),e=e.height*h.Coords.getWorldTileSize();let i=new THREE.PlaneGeometry(t,e);i.applyMatrix((new THREE.Matrix4).makeTranslation(t/2,p.MAGIC_OFFSET,e/2).multiply((new THREE.Matrix4).makeRotationX(-Math.PI/2)));let r=new THREE.ShadowMaterial;r.transparent=!0,r.opacity=.5;let s=new THREE.Mesh(i,r);return s.receiveShadow=!0,s.renderOrder=5,s}createWireframe(e,t){let i=s.DebugUtils.createWireframe(e,t);var r=this.gameObject.isBridge();return i.position.y+=r?h.Coords.tileHeightToWorld(-1):0,i}createMainObject(e,t){var i=this.objectRules.wall,r=this.gameObject.isHighBridge()?4:0;let s=a.ShpRenderable.factory(e,this.palette,this.camera,t,this.objectArt.hasShadow&&!this.gameObject.isLowBridge(),r,i);return s.setBatched(this.useSpriteBatching),this.useSpriteBatching&&s.setBatchPalettes([this.palette]),s.setFlat(this.objectArt.flat),s.setExtraLight(this.extraLight),s}onRemove(e){if(this.mapOverlayLayer?.hasObject(this.gameObject)&&this.mapOverlayLayer.removeObject(this.gameObject),this.gameObject.isDestroyed&&(this.gameObject.deathType===c.DeathType.Demolish||this.gameObject.isHighBridge())){var r=this.gameObject.getFoundation(),s=this.rules.audioVisual.bridgeExplosions;for(let i=0;i<r.width;i++)for(let t=0;t<r.height;t++){var a=s[o.getRandomInt(0,s.length-1)];e.createTransientAnim(a,e=>{e.setPosition(h.Coords.tile3dToWorld(i,t,0).add(this.withPosition.getPosition()))})}}}dispose(){this.mainRenderable?.dispose()}})}}}),System.register("engine/renderable/entity/Smudge",["engine/renderable/builder/ShpBuilder","engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","game/Coords"],function(e,t){"use strict";var l,i,c,r,h,u,s;t&&t.id;return{setters:[function(e){l=e},function(e){i=e},function(e){c=e},function(e){r=e},function(e){h=e},function(e){u=e}],execute:function(){e("Smudge",s=class{constructor(e,t,i,r,s,a,n){this.gameObject=e,this.imageFinder=t,this.palette=i,this.camera=r,this.lighting=s,this.debugFrame=a,this.mapSmudgeLayer=n,this.objectArt=e.art,this.label="smudge_"+e.name,this.init()}init(){this.withPosition=new i.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}update(e){}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}createObjects(a){var e,n={width:1,height:1};let o=new THREE.Object3D;if(o.matrixAutoUpdate=!1,this.debugFrame.value&&(e=r.DebugUtils.createWireframe(n,0),a.add(e)),this.mapSmudgeLayer?.shouldBeBatched(this.gameObject))this.mapSmudgeLayer.addObject(this.gameObject);else{let e;try{e=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(e instanceof c.ImageFinder.MissingImageError)return void console.warn(e.message);throw e}let t=new h.MapSpriteTranslation(n.width,n.height),{spriteOffset:i,anchorPointWorld:r}=t.compute();n=i.clone().add(this.objectArt.getDrawOffset());let s=this.builder=new l.ShpBuilder(e,this.palette,this.camera,u.Coords.ISO_WORLD_SCALE);s.setOffset(n),s.flat=this.objectArt.flat,s.setExtraLight(this.extraLight);n=s.build();o.add(n),o.position.x=r.x,o.position.z=r.y,o.updateMatrix(),a.add(o)}}onRemove(){this.mapSmudgeLayer?.hasObject(this.gameObject)&&this.mapSmudgeLayer.removeObject(this.gameObject)}dispose(){this.builder?.dispose()}})}}}),System.register("game/gameobject/infantry/sequenceMap",["game/gameobject/unit/ZoneType","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType"],function(e,t){"use strict";var l,n,c,o,h,u,d;t&&t.id;return{setters:[function(e){l=e},function(e){n=e},function(e){c=e},function(e){o=e}],execute:function(){e("getFireSequenceBy",h=(e,t=c.StanceType.None)=>t===c.StanceType.Deployed?n.SequenceType.DeployedFire:e===l.ZoneType.Water?n.SequenceType.WetAttack:e===l.ZoneType.Air?n.SequenceType.FireFly:t===c.StanceType.Prone?n.SequenceType.FireProne:n.SequenceType.FireUp),e("getMoveSequenceBy",u=(e,t,i)=>e===l.ZoneType.Air?n.SequenceType.Fly:e===l.ZoneType.Water?n.SequenceType.Swim:t===c.StanceType.Prone?n.SequenceType.Crawl:i?n.SequenceType.Panic:n.SequenceType.Walk),e("getIdleSequenceBy",(e,t=c.StanceType.None)=>t===c.StanceType.Deployed?[n.SequenceType.DeployedIdle]:e===l.ZoneType.Water?[n.SequenceType.WetIdle1,n.SequenceType.WetIdle2]:e!==l.ZoneType.Air?[n.SequenceType.Idle1,n.SequenceType.Idle2]:void 0),e("getStillSequenceBy",d=(e,t=c.StanceType.None)=>t===c.StanceType.Deployed?n.SequenceType.Deployed:e===l.ZoneType.Water?n.SequenceType.Tread:e===l.ZoneType.Air?n.SequenceType.Hover:t===c.StanceType.Prone?n.SequenceType.Prone:t===c.StanceType.Guard?n.SequenceType.Guard:t===c.StanceType.Paradrop?n.SequenceType.Paradrop:n.SequenceType.Ready),e("getStanceTransitionSequenceBy",(e,t)=>e===c.StanceType.Prone?n.SequenceType.Up:t===c.StanceType.Prone?n.SequenceType.Down:e===c.StanceType.Deployed?n.SequenceType.Undeploy:t===c.StanceType.Deployed?n.SequenceType.Deploy:t===c.StanceType.Cheer?n.SequenceType.Cheer:void 0),e("getCrashingSequences",e=>{let t=[...e.art.sequences.keys()];var i=[n.SequenceType.AirDeathStart,n.SequenceType.AirDeathFalling].filter(e=>t.includes(e));if(i.length)return i}),e("getDeathSequence",(e,t)=>{var i=e.zone,r=e.rules.isHuman;let s=[...e.art.sequences.keys()],a;return e.isCrashing?a=[n.SequenceType.AirDeathFinish]:i===l.ZoneType.Air?a=[n.SequenceType.Tumble]:i===l.ZoneType.Water?![o.InfDeathType.Gunfire,o.InfDeathType.Explode].includes(t)&&r||(a=[n.SequenceType.WetDie1,n.SequenceType.WetDie2]):t!==o.InfDeathType.Gunfire&&r?t===o.InfDeathType.Explode&&(a=[n.SequenceType.Die2]):a=[n.SequenceType.Die1],a&&(a=a.filter(e=>s.includes(e)),a.length||(a=void 0)),a}),e("getDeathAnim",(e,t)=>t===o.InfDeathType.ExplodeAlt?e.audioVisual.infantryExplode:t===o.InfDeathType.Fire?e.audioVisual.flamingInfantry:t===o.InfDeathType.Electro?[...e.animationNames][1]:t===o.InfDeathType.HeadExplode?e.audioVisual.infantryHeadPop:t===o.InfDeathType.Nuke?e.audioVisual.infantryNuked:void 0),e("findSequence",(e,t,i,r,s,a)=>{var n=e=>-1!==a.indexOf(e);let o;return r&&(o=h(e,t),n(o)||(o=h(e),n(o)||(o=void 0))),void 0===o&&i&&(o=u(e,t,s),n(o)||(o=u(e,c.StanceType.None,s),n(o)||(o=void 0))),void 0===o&&(o=d(e,t),n(o)||(o=d(e),n(o)||(o=d(l.ZoneType.Ground)))),o})}}}),System.register("engine/renderable/entity/unit/BlobShadow",["game/Coords","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","engine/gfx/batch/BatchedMesh"],function(e,t){"use strict";var n,o,l,i,r;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){i=e}],execute:function(){e("BlobShadow",r=class r{constructor(e,t,i){this.gameObject=e,this.radius=t,this.useMeshInstancing=i}get3DObject(){return this.obj}create3DObject(){if(!this.obj){let e=r.geometries.get(this.radius);e||(e=new THREE.CircleBufferGeometry(this.radius*n.Coords.ISO_WORLD_SCALE),r.geometries.set(this.radius,e)),this.obj=new(this.useMeshInstancing?i.BatchedMesh:THREE.Mesh)(e,r.mat),this.obj.rotation.x=-Math.PI/2,this.obj.matrixAutoUpdate=!1}}update(e,t){let i=this.obj;var r,s,a=this.gameObject.zone===o.ZoneType.Air||this.gameObject.isInfantry()&&this.gameObject.stance===l.StanceType.Paradrop;(i.visible=a)&&(r=this.gameObject.tile.z,s=this.gameObject.tileElevation,a=!!this.gameObject.tile.onBridgeLandType,r===this.lastTileZ&&s===this.lastTileElevation&&a===this.lastBridgeBelow||(this.lastTileZ=r,this.lastTileElevation=s,this.lastBridgeBelow=a,a=this.gameObject.position.getBridgeBelow(),i.position.y=n.Coords.tileHeightToWorld(-s)+(a?n.Coords.tileHeightToWorld(a.tileElevation)+.01*n.Coords.ISO_WORLD_SCALE:0),i.updateMatrix()))}dispose(){}}),r.geometries=new Map,r.mat=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5,alphaTest:0})}}}),System.register("engine/renderable/entity/Infantry",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","game/Coords","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","game/gameobject/infantry/sequenceMap","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/art/SequenceType","util/math","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","game/gameobject/common/DeathType","game/type/MovementZone","engine/renderable/entity/unit/BlobShadow","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(e,t){"use strict";var m,a,r,n,f,o,y,l,c,T,v,b,S,s,w,C,E,i,h,u,d,x,g,p,O;t&&t.id;return{setters:[function(e){m=e},function(e){a=e},function(e){r=e},function(e){n=e},function(e){f=e},function(e){o=e},function(e){y=e},function(e){l=e},function(e){c=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){s=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){i=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){x=e},function(e){g=e},function(e){p=e}],execute:function(){e("Infantry",O=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p){this.gameObject=e,this.rules=t,this.art=i,this.imageFinder=r,this.palette=a,this.camera=n,this.lighting=o,this.debugFrame=l,this.gameSpeed=c,this.selectionModel=h,this.useSpriteBatching=u,this.useMeshInstancing=d,this.pipOverlay=g,this.worldSound=p,this.crashingSequencePlaying=!1,this.deathAnimSequencePlaying=!1,this.idleActionDue=!1,this.disguiseChanged=!1,this.highlightAnimRunner=new E.HighlightAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=e.art,this.label="infantry_"+e.rules.name,this.paletteRemaps=[...this.rules.colors.values()].map(e=>this.palette.clone().remap(e)),this.palette=this.palette.remap(this.gameObject.owner.color),this.withPosition=new m.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1+this.rules.audioVisual.extraInfantryLight)}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach(e=>e.updateLighting?.()),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var e=this.plugins.reduce((e,t)=>t.getUiNameOverride?.()??e,void 0);return void 0!==e?e:this.gameObject.getUiName()}create3DObject(){let e=this.get3DObject();e||(e=new d.BoxIntersectObject3D(new THREE.Vector3(.5,2/3,.5).multiplyScalar(f.Coords.LEPTONS_PER_TILE)),e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.shpRenderable?.setExtraLight(this.extraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posWrap.add(this.pipOverlay.get3DObject())))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some(e=>e.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==y.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(t){this.plugins.forEach(e=>e.update(t));var{zone:i,stance:r,isCrashing:e,isMoving:s,isFiring:a,isPanicked:n,owner:o,veteranLevel:l}=this.gameObject;this.pipOverlay?.update(t),this.blobShadow?.update(t),l!==this.lastVeteranLevel&&(l===C.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=l);var c=this.gameObject.tile.z+this.gameObject.tileElevation;void 0!==this.lastElevation&&this.lastElevation===c||(this.lastElevation=c,this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)),this.highlightAnimRunner.shouldUpdate()&&(this.highlightAnimRunner.tick(t),x.ExtraLightHelper.multiplyShp(this.extraLight,this.baseExtraLight,this.highlightAnimRunner.getValue()));var h=this.disguise?.owner??o;this.lastOwnerColor!==h.color&&(this.palette.remap(h.color),(this.shpRenderable??this.placeholder)?.setPalette(this.palette),this.lastOwnerColor=h.color);var u=this.gameObject.warpedOutTrait.isActive(),l=u!==this.lastWarpedOut;this.lastWarpedOut=u;c=this.gameObject.cloakableTrait?.isCloaked(),h=c!==this.lastCloaked;if(this.lastCloaked=c,(l||h)&&(this.shpRenderable??this.placeholder)?.setOpacity(u||c?.5:1),e||void 0!==this.lastZone&&this.lastZone===i||(i===v.ZoneType.Water?this.gameObject.rules.enterWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.enterWaterSound,this.gameObject,o):this.lastZone===v.ZoneType.Water&&this.gameObject.rules.leaveWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.leaveWaterSound,this.gameObject,o),this.blobShadow&&this.shpRenderable?.setShadowVisible(!this.blobShadow.get3DObject().visible)),this.gameObject.isDestroyed&&this.deathPromiseResolve)if(this.deadBodyAnimRenderable){if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deadBodyAnimRenderable.update(t),this.deadBodyAnimRenderable.isAnimFinished())return void this.deathPromiseResolve()}else{if(!this.deathAnimRenderable){if(this.deathAnimSequencePlaying)return this.animRunner&&this.animRunner.animation.getState()!==y.AnimationState.STOPPED?(this.animRunner.tick(t),void this.updateShapeFrame(this.computeFacingNumber(this.gameObject.direction))):void([w.InfDeathType.Gunfire,w.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman&&this.gameObject.zone===v.ZoneType.Ground?this.prepareDeadBodyAnim():this.deathPromiseResolve());c=this.sequenceQueue.shift();if(c)return this.deathAnimSequencePlaying=!0,void this.setAnimParams(c,t,!1);throw new Error("We should have a death sequence scheduled right now")}if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deathAnimRenderable.update(t),this.deathAnimRenderable.isAnimFinished())return void([w.InfDeathType.Gunfire,w.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman?this.prepareDeadBodyAnim():this.deathPromiseResolve())}else{if(this.gameObject.warpedOutTrait.isActive())return;e&&(this.crashingSequencePlaying||(this.crashingSequencePlaying=!0,(d=T.getCrashingSequences(this.gameObject))&&(this.sequenceQueue=d)))}void 0!==this.lastDirection&&this.lastDirection===this.gameObject.direction||(this.lastDirection=this.gameObject.direction,this.computedDirection=this.gameObject.direction);var d=this.idleActionDue;this.idleActionDue=this.gameObject.idleActionTrait.actionDueThisTick();let g=this.idleActionDue&&!d;if(void 0===this.lastMoving||this.lastMoving!==s||void 0===this.lastFiring||this.lastFiring!==a||void 0===this.lastZone||this.lastZone!==i||void 0===this.lastPanicked||this.lastPanicked!==n||this.disguiseChanged){var p=this.disguiseChanged,m=this.lastFiring!==a;if(this.lastMoving=s,this.lastFiring=a,this.lastZone=i,this.lastPanicked=n,this.computedDirection=this.gameObject.direction,this.disguiseChanged=!1,!e&&(this.sequenceQueue=[],!m||a||p)){let e=this.findSequenceBy(i,r,s,a,n);void 0!==e&&(this.disguise&&[S.SequenceType.FireUp,S.SequenceType.FireProne].includes(e)&&(e=S.SequenceType.Ready),this.setAnimParams(e,t,!a))}}if(void 0!==this.lastStance&&this.lastStance===r||(this.sequenceQueue=[],g=!1,m=T.getStanceTransitionSequenceBy(this.lastStance,r),this.lastStance=r,m&&this.objectArt.sequences.has(m)&&this.sequenceQueue.push(m),void 0!==(p=this.findSequenceBy(i,r,s,a,n))&&this.sequenceQueue.push(p),void 0!==this.currentSequenceParams?.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),p=this.sequenceQueue.shift(),this.setAnimParams(p,t,!m),p===S.SequenceType.Paradrop?(p=this.rules.audioVisual.parachute,this.paradropAnim=this.renderableManager.createAnim(p,void 0,!0),this.paradropAnim.remapColor(o.color),this.paradropAnim.create3DObject(),this.paradropAnim.get3DObject().position.y=f.Coords.tileHeightToWorld(1),this.paradropAnim.get3DObject().updateMatrix(),this.posWrap.add(this.paradropAnim.get3DObject())):this.paradropAnim&&(this.paradropAnim.endAnimationLoop(),this.blobShadow&&(this.posWrap.remove(this.blobShadow.get3DObject()),this.blobShadow.dispose(),this.blobShadow=void 0,this.shpRenderable?.setShadowVisible(!0)))),this.paradropAnim&&(this.paradropAnim.update(t),this.paradropAnim.isAnimFinished()&&(this.posWrap.remove(this.paradropAnim.get3DObject()),this.paradropAnim=void 0)),this.sequenceQueue.length||s||a||r!==b.StanceType.None&&r!==b.StanceType.Guard||i===v.ZoneType.Air||!g||(.5<=Math.random()?(o=this.findIdleSequence(i,r,this.objectArt))&&this.setAnimParams(o,t,!1):this.computedDirection=Math.floor(360*Math.random())),this.animRunner){if(this.animRunner.animation.getState()===y.AnimationState.STOPPED&&this.currentSequenceParams){[S.SequenceType.Idle1,S.SequenceType.Idle2].includes(this.currentSequenceParams.type)&&void 0!==this.currentSequenceParams.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing));let e;e=this.sequenceQueue.length?this.sequenceQueue.shift():this.findSequenceBy(i,r,s,a,n),void 0!==e&&this.setAnimParams(e,t,!a)}this.animRunner.tick(t);a=this.computeFacingNumber(this.computedDirection);this.updateShapeFrame(a)}}findIdleSequence(e,t,i){let r=T.getIdleSequenceBy(e,t);if(r?.length&&(r=r.filter(e=>i.sequences.has(e)),r.length||e===v.ZoneType.Ground||(r=T.getIdleSequenceBy(v.ZoneType.Ground,t)?.filter(e=>i.sequences.has(e)))),r)return r[s.getRandomInt(0,r.length-1)]}prepareDeadBodyAnim(){var e=this.rules.audioVisual.deadBodies,e=e[s.getRandomInt(0,e.length-1)];this.deadBodyAnimRenderable=this.renderableManager.createAnim(e,void 0,!0),this.deadBodyAnimRenderable.create3DObject(),this.posWrap.add(this.deadBodyAnimRenderable.get3DObject())}findSequenceBy(e,t,i,r,s){var a=T.findSequence(e,t,i,r,s,[...this.objectArt.sequences.keys()]);if(void 0!==a)return a;console.warn(`Couldn't find a sequence for infantry "${this.gameObject.name}" `+`(moving=${i}, firing=${r})`)}setAnimParams(t,i,r=!0){if(this.animRunner){var s=this.objectArt.sequences.get(t);if(s){this.currentSequenceParams=s;let e=this.animRunner.animation.props;e.loopCount=r?-1:1,e.loopEnd=s.frameCount-1,[S.SequenceType.Deploy,S.SequenceType.Undeploy,S.SequenceType.Paradrop].includes(t)?t===S.SequenceType.Paradrop?e.rate=2*l.AnimProps.defaultRate:e.rate=l.AnimProps.defaultRate:e.rate=l.AnimProps.defaultRate/2,[S.SequenceType.Walk].includes(t)&&(e.rate/=1.33),this.animRunner.animation.start(i)}else console.warn(`Infantry "${this.gameObject.name}" is missing sequence "${S.SequenceType[t]}"`)}}updateShapeFrame(e){var t,i;this.currentSequenceParams&&this.shpRenderable&&this.animRunner&&({startFrame:t,facingMult:i}=this.currentSequenceParams,(i=t+i*e+this.animRunner.animation.getCurrentFrame())<this.shpRenderable.frameCount&&this.shpRenderable.setFrame(i))}computeFacingNumber(e){return Math.round((e-45+360)%360/360*8)%8}directionFromFacingNo(e){return 45+360*e/8}createObjects(t){if(this.debugFrame.value){let e=r.DebugUtils.createWireframe({width:.5,height:.5},1);e.translateX(-f.Coords.getWorldTileSize()/4),e.translateZ(-f.Coords.getWorldTileSize()/4),t.add(e)}let e=this.posWrap=new THREE.Object3D;e.matrixAutoUpdate=!1,t.add(e);var i=this.createMainObject(this.objectArt);e.add(i),(this.gameObject.rules.movementZone!==h.MovementZone.Fly||this.objectArt.isVoxel)&&this.gameObject.stance!==b.StanceType.Paradrop||(this.blobShadow=new u.BlobShadow(this.gameObject,3,this.useMeshInstancing),this.blobShadow.create3DObject(),this.posWrap.add(this.blobShadow.get3DObject()))}createMainObject(e){let t;try{t=this.imageFinder.findByObjectArt(e)}catch(e){if(!(e instanceof a.ImageFinder.MissingImageError))throw e;console.warn(`<${this.gameObject.name}>: `+e.message)}if(!t)return this.placeholder=new g.DebugRenderable({width:.25,height:.25},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();var i=e.getDrawOffset();let r=this.shpRenderable=n.ShpRenderable.factory(t,this.palette,this.camera,i,e.hasShadow);r.setBatched(this.useSpriteBatching),this.useSpriteBatching&&r.setBatchPalettes(this.paletteRemaps),r.create3DObject();let s=r.get3DObject();p.MathUtils.translateTowardsCamera(s,this.camera,15*f.Coords.ISO_WORLD_SCALE),s.updateMatrix();i=new l.AnimProps(new c.IniSection("dummy"),t),i=new y.Animation(i,this.gameSpeed);return this.animRunner=new o.SimpleRunner,this.animRunner.animation=i,s}setDisguise(e){this.gameObject.isDestroyed||this.gameObject.isCrashing||(this.objectArt=e?.objectArt??this.gameObject.art,this.updateShpRenderableFromArt(this.objectArt),this.disguiseChanged=!0,this.disguise=e)}updateShpRenderableFromArt(e){var t=(this.shpRenderable??this.placeholder)?.get3DObject();t&&(this.posWrap.remove(t),(this.shpRenderable??this.placeholder)?.dispose()),this.posWrap.add(this.createMainObject(e))}onCreate(t){this.renderableManager=t,this.plugins.forEach(e=>e.onCreate(t)),this.gameObject.rules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.gameObject.rules.ambientSound,this.gameObject))}onRemove(t){if(this.renderableManager=void 0,this.plugins.forEach(e=>e.onRemove(t)),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.deathType!==i.DeathType.Temporal&&this.gameObject.stance!==b.StanceType.Paradrop){var e,r=T.getDeathSequence(this.gameObject,this.gameObject.infDeathType);if(r)1<r.length?(e=r[s.getRandomInt(0,r.length-1)],this.sequenceQueue=[e]):this.sequenceQueue=[r[0]],this.disguise&&(this.objectArt=this.gameObject.art,this.updateShpRenderableFromArt(this.gameObject.art));else{if(!this.gameObject.rules.isHuman)return;r=T.getDeathAnim(this.rules,this.gameObject.infDeathType);if(!r)return;let i=this.art.getAnimation(r);if(this.deathAnimRenderable=t.createAnim(r,void 0,!0),this.deathAnimRenderable.create3DObject(),this.create3DObject(),this.posWrap.add(this.deathAnimRenderable.get3DObject()),i.isFlamingGuy){let e=i.art.clone();e.set("Shadow","yes"),e.set("LoopCount","0"),e.set("Start",String(8*i.runningFrames));let t=this.deathAnimRenderable.getAnimProps();t.setArt(e)}}return this.renderableManager=t,new Promise(e=>{this.deathPromiseResolve=()=>{this.renderableManager=void 0,e()}})}}dispose(){this.plugins.forEach(e=>e.dispose()),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.placeholder?.dispose(),this.deathAnimRenderable?.dispose(),this.deadBodyAnimRenderable?.dispose(),this.paradropAnim?.dispose(),this.blobShadow?.dispose()}})}}}),System.register("engine/renderable/entity/Aircraft",["game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","util/math","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","engine/Animation","game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable"],function(e,t){"use strict";var s,i,a,r,o,g,n,l,c,p,h,u,d,m,f;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){a=e},function(e){r=e},function(e){o=e},function(e){g=e},function(e){n=e},function(e){l=e},function(e){c=e},function(e){p=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){m=e}],execute:function(){e("Aircraft",f=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d){this.gameObject=e,this.rules=t,this.voxels=i,this.voxelAnims=r,this.palette=s,this.lighting=n,this.debugFrame=o,this.gameSpeed=l,this.selectionModel=c,this.vxlBuilderFactory=h,this.useSpriteBatching=u,this.pipOverlay=d,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new g.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new p.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=e.rules,this.objectArt=e.art,this.label="aircraft_"+this.objectRules.name,this.init()}init(){this.paletteRemaps=[...this.rules.colors.values()].map(e=>this.palette.clone().remap(e)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.withPosition=new i.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile)+this.rules.audioVisual.extraAircraftLight)}updateLighting(){this.plugins.forEach(e=>e.updateLighting?.()),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var e=this.plugins.reduce((e,t)=>t.getUiNameOverride?.()??e,void 0);return void 0!==e?e:this.gameObject.getUiName()}create3DObject(){let e=this.get3DObject();e||(e=new h.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(s.Coords.LEPTONS_PER_TILE*(this.gameObject.rules.spawned?.5:1))),e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.vxlBuilders.forEach(e=>e.setExtraLight(this.extraLight)),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}registerPlugin(e){this.plugins.push(e)}highlight(){this.plugins.some(e=>e.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==n.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(t){this.plugins.forEach(e=>e.update(t)),this.pipOverlay?.update(t),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===o.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var e=this.highlightAnimRunner.shouldUpdate(),i=this.gameObject.invulnerableTrait.isActive(),r=i!==this.lastInvulnerable;(this.lastInvulnerable=i)&&r&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(t),(e||r)&&(e&&this.highlightAnimRunner.tick(t),s=i?this.invulnAnimRunner.getValue():0,n=(e?this.highlightAnimRunner.getValue():0)||s,a=this.lighting.getAmbientIntensity(),d.ExtraLightHelper.multiplyVxl(this.extraLight,this.baseExtraLight,a,n));var e=this.gameObject.warpedOutTrait.isActive(),s=e!==this.lastWarpedOut;this.lastWarpedOut=e;var a=this.gameObject.cloakableTrait?.isCloaked(),n=a!==this.lastCloaked;if(this.lastCloaked=a,s||n){let t=e||a?.5:1;this.vxlBuilders.forEach(e=>e.setOpacity(t)),this.placeholder?.setOpacity(t)}a=this.gameObject.owner.color;this.lastOwnerColor!==a&&(this.palette.remap(a),this.lastOwnerColor=a,this.vxlBuilders.forEach(e=>e.setPalette(this.palette)),this.placeholder?.setPalette(this.palette));a=this.gameObject.zone;a!==this.lastZone&&(this.gameObject.rules.missileSpawn&&a===c.ZoneType.Air&&this.lastZone!==c.ZoneType.Air&&this.renderableManager.createTransientAnim("V3TAKOFF",e=>e.setPosition(this.withPosition.getPosition())),this.lastZone=a),this.updateVxlRotation()}updateVxlRotation(){var{pitch:e,yaw:t,roll:i}=this.gameObject;this.tiltObj.rotation.z=THREE.Math.degToRad(i),this.tiltObj.rotation.x=THREE.Math.degToRad(e),this.tiltObj.rotation.y=THREE.Math.degToRad(t),this.rotors&&this.rotors.forEach((e,t)=>{this.rotorSpeeds[t]=u.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[t]??0,this.objectArt.rotors[t]),this.rotorSpeeds[t]&&(e.rotateOnAxis(this.objectArt.rotors[t].axis,this.rotorSpeeds[t]),e.updateMatrix())})}createObjects(t){if(this.debugFrame.value){let e=a.DebugUtils.createWireframe({width:1,height:1},1);e.translateX(-s.Coords.getWorldTileSize()/2),e.translateZ(-s.Coords.getWorldTileSize()/2),t.add(e)}let e=this.tiltObj=new THREE.Object3D;e.rotation.order="YXZ";var i=this.createMainObject();e.add(i);let r=this.posObj=new THREE.Object3D;r.matrixAutoUpdate=!1,r.add(e),t.add(r)}createMainObject(){var e=this.objectArt.imageName.toLowerCase(),t=e+".vxl",i=this.voxels.get(t);if(!i)return console.warn(`VXL missing for aircraft ${this.objectRules.name}. Vxl file ${t} not found. `),this.placeholder=new m.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();t=this.objectArt.noHva?void 0:this.voxelAnims.get(e+".hva"),e=[...this.rules.colors.values()].map(e=>this.palette.clone().remap(e));let r=this.vxlBuilderFactory.create(i,t,e,this.palette);this.vxlBuilders.push(r);e=r.build();return this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map(e=>{var t=r.getSection(e.name);if(!t)throw new Error(`Aircraft "${this.objectRules.name}" VXL section "${e.name}" not found`);return t})),e}onCreate(t){this.renderableManager=t,this.plugins.forEach(e=>e.onCreate(t))}onRemove(t){var e;this.renderableManager=void 0,this.plugins.forEach(e=>e.onRemove(t)),this.gameObject.isDestroyed&&this.objectRules.explosion.length&&this.gameObject.deathType!==l.DeathType.Temporal&&this.gameObject.deathType!==l.DeathType.None&&(e=(e=this.objectRules.explosion)[r.getRandomInt(0,e.length-1)],t.createTransientAnim(e,e=>{let t=this.withPosition.getPosition();this.gameObject.rules.missileSpawn&&(t=t.clone().add(this.gameObject.moveTrait.velocity.clone().setLength(this.rules.general.getMissileRules(this.gameObject.name).bodyLength))),e.setPosition(t)}))}dispose(){this.plugins.forEach(e=>e.dispose()),this.pipOverlay?.dispose(),this.vxlBuilders.forEach(e=>e.dispose()),this.placeholder?.dispose()}})}}}),System.register("engine/renderable/entity/TransientAnim",["engine/renderable/entity/Anim"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.Anim{constructor(e,t,i,r,s,a,n,o,l,c,h){super(e,t,i,r,s,a,n,o,l,void 0,h),this.container=c}update(e){var t;!this.isAnimNotStarted()||(t=this.objectArt.report)&&this.worldSound?.playEffect(t,this.getPosition()),super.update(e),this.isAnimFinished()&&(this.remove(),this.dispose())}remove(){this.container.remove(this)}},e("TransientAnim",r)}}}),System.register("engine/renderable/fx/LaserFx",["three.meshline","game/Coords"],function(e,t){"use strict";var a,n,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){e("LaserFx",i=class{constructor(e,t,i,r,s,a){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.durationSeconds=s,this.width=a}setContainer(e){this.container=e}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_laser")}update(e){this.firstUpdateMillis||(this.firstUpdateMillis=e),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.durationSeconds)),this.lineMesh.material.uniforms.opacity.value=+this.timeLeft,this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var e=this.sourcePos.clone(),t=this.targetPos.clone();let i=new THREE.Geometry;i.vertices.push(e,t);let r=new a.MeshLine;r.setGeometry(i);var s=this.camera.top,e=this.camera.right/this.camera.top,t=2*s/Math.cos(this.camera.rotation.y),e=t*e,s=new a.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(e,t).multiplyScalar(s*Math.cos(this.camera.rotation.x)/n.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0,blending:THREE.AdditiveBlending});return new THREE.Mesh(r.geometry,s)}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/TeslaFx",["game/Coords"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("TeslaFx",i=class{constructor(e,t,i,r,s){this.sourcePos=e,this.targetPos=t,this.primaryColor=i,this.secondaryColor=r,this.durationSeconds=s,this.bolts=[],this.boltMeshes=[]}setContainer(e){this.container=e}get3DObject(){return this.target}create3DObject(){if(!this.target){this.target=new THREE.Object3D,this.target.name="fx_tesla";var t=this.primaryColor.getHex();let e=[t,t,this.secondaryColor.getHex()];e.forEach(e=>{try{var{mesh:t,bolt:i}=this.createBolt(e);this.boltMeshes.push(t),this.bolts.push(i),this.target.add(t)}catch(e){console.warn("Couldn't create lightning FX",[e])}})}}update(e){this.firstUpdateMillis||(this.firstUpdateMillis=e);let t=(e-this.firstUpdateMillis)/1e3;this.timeLeft=Math.max(0,1-t/this.durationSeconds);try{this.bolts.forEach(e=>e.update(t))}catch(e){console.warn("Couldn't update lightning FX",[e])}this.isFinished()&&(this.container.remove(this),this.dispose())}createBolt(e){var t=this.sourcePos.clone(),i=this.targetPos.clone(),t=new THREE.LightningStrike({sourceOffset:t,destOffset:i,radius0:.3*r.Coords.ISO_WORLD_SCALE,radius1:.3*r.Coords.ISO_WORLD_SCALE,isEternal:!0,timeScale:2,propagationTimeFactor:.05,vanishingTimeFactor:.95,ramification:0,roughness:.85,straightness:.7}),i=new THREE.MeshBasicMaterial({color:e});return{mesh:new THREE.Mesh(t,i),bolt:t}}isFinished(){return 0===this.timeLeft}dispose(){this.boltMeshes.forEach(e=>{e.geometry.dispose(),e.material.dispose()})}})}}}),System.register("engine/renderable/fx/LineTrailFx",["game/art/ObjectArt","game/Coords"],function(e,t){"use strict";var l,c,i;t&&t.id;return{setters:[function(e){l=e},function(e){c=e}],execute:function(){e("LineTrailFx",i=class{constructor(e,t,i,r,s){this.lazyTarget=e,this.trailColor=t,this.trailDecrement=i,this.gameSpeed=r,this.camera=s,this.trailInitialized=!1}setContainer(e){this.container=e}get3DObject(){return this.placeholderObj}create3DObject(){this.placeholderObj||(this.placeholderObj=new THREE.Object3D,this.placeholderObj.name="fx_linetrail_placeholder")}update(e){var t;void 0!==this.timeLeft&&(t=this.prevUpdateMillis,this.prevUpdateMillis=e,t&&(this.timeLeft=Math.max(0,this.timeLeft-(e-t)/1e3))),this.trailInitialized||(this.trailInitialized=!0,(t=this.createTrail(this.trailColor,this.trailDecrement))?this.trail=t:this.timeLeft=0),this.trail&&(this.trail.advance(),this.lastTargetMatrix=this.trail.targetObject.matrixWorld),this.isFinished()&&(this.container.remove(this),this.dispose())}createTrail(r,s){var a=this.lazyTarget();if(a){let e=new THREE.TrailRenderer(this.container.get3DObject()),t=THREE.TrailRenderer.createBaseMaterial();t.uniforms.headColor.value.set(r.r,r.g,r.b,1),t.uniforms.tailColor.value.set(r.r,r.g,r.b,0);var n=Math.floor(3/this.gameSpeed.value*50/(s/l.ObjectArt.DEFAULT_LINE_TRAIL_DEC)),o=.8*c.Coords.ISO_WORLD_SCALE;let i=new THREE.PlaneGeometry(o,o);o=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return i.applyMatrix((new THREE.Matrix4).makeRotationFromQuaternion(o)),e.initialize(t,n,!1,0,i.vertices,a),e.activate(),e}}isFinished(){return 0===this.timeLeft}requestFinishAndDispose(){this.timeLeft=.8/this.gameSpeed.value}stopTracking(){if(this.trail&&this.lastTargetMatrix){let e=new THREE.Object3D;e.updateMatrixWorld=()=>{},e.matrixWorld=this.lastTargetMatrix,this.trail.targetObject=e}}dispose(){this.trail?.deactivate(),this.trail?.material.dispose(),this.trail?.geometry.dispose()}})}}}),System.register("engine/renderable/fx/SparkFx",["game/Coords"],function(e,t){"use strict";var i,s,r,a,n;t&&t.id;return{setters:[function(e){i=e}],execute:function(){s=1,a=r=100,e("SparkFx",n=class n{constructor(e,t,i,r){this.pos=e,this.color=t,this.spawnDurationSeconds=i,this.gameSpeed=r,this.totalDurationSeconds=i+s}setContainer(e){this.container=e}create3DObject(){var e;this.particleGroup||(n.sparkTex||(n.sparkTex=new THREE.DataTexture(new Uint8Array(4).fill(255),1,1,THREE.RGBAFormat),n.sparkTex.needsUpdate=!0),this.particleGroup=new SPE.Group({texture:{value:n.sparkTex},maxParticleCount:r}),this.particleGroup.mesh.name="fx_spark",this.particleGroup.mesh.frustumCulled=!1,e=this.particleEmitter=new SPE.Emitter({maxAge:{value:s},position:{value:this.pos,spread:new THREE.Vector3(10,0,10).multiplyScalar(i.Coords.ISO_WORLD_SCALE)},acceleration:{value:new THREE.Vector3(0,-50,0).multiplyScalar(i.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(0,0,0)},velocity:{value:new THREE.Vector3(0,30,0).multiplyScalar(i.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(40,5,40).multiplyScalar(i.Coords.ISO_WORLD_SCALE)},color:{value:[this.color]},opacity:{value:[1,.5]},size:{value:1},particleCount:a}),this.particleGroup.addEmitter(e))}get3DObject(){return this.particleGroup?.mesh}update(e){var t;this.lastUpdateMillis?(t=e-this.lastUpdateMillis,this.particleGroup.tick(t/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=e,this.particleGroup.tick(0)),this.lastUpdateMillis=e,this.particleEmitter.alive&&e-this.firstUpdateMillis>=1e3*this.spawnDurationSeconds/this.gameSpeed.value&&this.particleEmitter.disable(),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.totalDurationSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}})}}}),System.register("engine/renderable/fx/RadBeamFx",["three.meshline","game/Coords","util/math"],function(e,t){"use strict";var h,u,i,r;t&&t.id;return{setters:[function(e){h=e},function(e){u=e},function(e){i=e}],execute:function(){e("RadBeamFx",r=class{constructor(e,t,i,r,s,a){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.durationSeconds=s,this.width=a,this.amplitude=0}setContainer(e){this.container=e}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_radbeam")}update(e){this.firstUpdateMillis||(this.firstUpdateMillis=e),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.durationSeconds));var t=i.truncToDecimals(u.Coords.LEPTONS_PER_TILE/6*(1-this.timeLeft),1);t!==this.amplitude&&(this.amplitude=t,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,t)),this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var e=this.sourcePos.clone(),t=this.targetPos.clone(),i=this.createLineGeometry(e,t,this.amplitude),r=this.camera.top,e=this.camera.right/this.camera.top,t=2*r/Math.cos(this.camera.rotation.y),e=t*e,r=new h.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(e,t).multiplyScalar(r*Math.cos(this.camera.rotation.x)/u.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0});return new THREE.Mesh(i,r)}createLineGeometry(e,t,i){let r=[];var s=t.clone().sub(e).length()/u.Coords.LEPTONS_PER_TILE,a=15*s;let n=new THREE.Vector3;for(let c=0;c<=a;c++){var o=c/a;n.lerpVectors(e,t,o),n.y+=i*Math.sin(o*s*(u.Coords.LEPTONS_PER_TILE/Math.PI)),r.push(n.x,n.y,n.z)}let l=new h.MeshLine;return l.setGeometry(r),l.geometry}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/gfx/lighting/LightingFx",["data/map/MapLighting"],function(t,e){"use strict";var i,r,s;e&&e.id;return{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.Normal=0]="Normal",e[e.High=1]="High",t("LightingFxPriority",r),t("LightingFx",s=class{constructor(){this.priority=r.Normal,this.mapLighting=new i.MapLighting,this.isRunning=!1}update(e,t){return{done:!0}}})}}}),System.register("engine/gfx/lighting/LightingDirector",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("LightingDirector",i=class{constructor(e,t,i){this.lighting=e,this.renderer=t,this.gameSpeed=i,this.effects=[],this.onFrame=s=>{if(this.effects.length){let r=!1;this.effects.slice().forEach((e,t)=>{e.isRunning||(e.isRunning=!0,e.startTime=s,e.mapLighting.copy(this.lighting.getBaseAmbient()));var i=e.update(s,this.gameSpeed.value);i.done&&(this.effects.splice(this.effects.indexOf(e),1),t||(r=!0)),t||i.updated&&this.lighting.applyAmbientOverride(e.mapLighting)}),this.effects.length?r&&this.lighting.applyAmbientOverride(this.effects[0].mapLighting):this.lighting.applyAmbientOverride(void 0)}}}init(){this.renderer.onFrame.subscribe(this.onFrame)}addEffect(e){this.effects.push(e),this.effects.sort((e,t)=>t.priority-e.priority)}dispose(){this.renderer.onFrame.unsubscribe(this.onFrame)}})}}}),System.register("engine/gfx/lighting/NukeLightingFx",["engine/gfx/lighting/LightingFx"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.LightingFx{constructor(){super(),this.priority=i.LightingFxPriority.High}update(e,t){let i=!1,r=!1;this.initialAmbient??(this.initialAmbient=this.mapLighting.ambient);let s,a=(e-this.startTime)/1e3*t;var n;return 3.3<=a?(a-=3.3,n=Math.min(1,a/.5),s=this.initialAmbient+1.5*(1-n),1===n&&(r=!0)):a<.3&&(n=a/.3,s=this.initialAmbient+1.5*n),void 0!==s&&this.mapLighting.ambient!==s&&(i=!0,this.mapLighting.ambient=s),{done:r,updated:i}}},e("NukeLightingFx",r)}}}),System.register("engine/renderable/entity/Projectile",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","game/gameobject/Projectile","game/Coords","engine/renderable/fx/LaserFx","game/WeaponType","engine/renderable/fx/TeslaFx","game/GameSpeed","engine/renderable/fx/LineTrailFx","engine/renderable/fx/SparkFx","engine/renderable/fx/RadBeamFx","engine/renderable/entity/unit/BlobShadow","engine/gfx/lighting/NukeLightingFx","engine/gfx/batch/BatchedMesh","game/rules/ObjectRules","game/math/geometry","engine/type/PaletteType"],function(e,t){"use strict";var y,o,s,u,d,g,p,m,f,T,v,l,a,c,h,n,b,S;t&&t.id;return{setters:[function(e){y=e},function(e){o=e},function(e){s=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){T=e},function(e){v=e},function(e){l=e},function(e){a=e},function(e){c=e},function(e){h=e},function(e){n=e},function(e){b=e}],execute:function(){e("Projectile",S=class S{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p){var m,f;this.gameObject=e,this.rules=t,this.imageFinder=i,this.voxels=r,this.voxelAnims=s,this.theater=a,this.palette=n,this.specialPalette=o,this.camera=l,this.gameSpeed=c,this.lighting=h,this.lightingDirector=u,this.vxlBuilderFactory=d,this.useSpriteBatching=g,this.useMeshInstancing=p,this.plugins=[],this.objectArt=e.art,this.label="projectile_"+e.rules.name,this.withPosition=new y.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting(),this.gameObject.rules.firersPalette&&(m=(f=this.gameObject.fromObject)?.art.paletteType??b.PaletteType.Unit,f=f?.art.customPaletteName,this.palette=this.theater.getPalette(m,f),this.gameObject.art.remapable&&(this.palette=this.palette.clone(),this.palette.remap(this.gameObject.fromPlayer.color))),this.gameObject.rules.firersPalette&&this.objectArt.remapable?this.paletteRemaps=[...this.rules.colors.values()].map(e=>this.palette.clone().remap(e)):this.paletteRemaps=[this.palette]}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach(e=>e.updateLighting?.()),this.objectArt.isVoxel?this.extraLight.setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)):this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)).addScalar(-1)}getIntersectTarget(){}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(t,i){if(this.plugins.forEach(e=>e.update(t)),0<i&&!this.gameObject.isDestroyed){let e=this.gameObject.velocity.clone(),t=e.multiplyScalar(i);var r=t.add(this.gameObject.position.worldPosition);this.setPosition(r)}this.blobShadow?.update(t,i);var e=this.gameObject.direction;!this.vxlRotWrapper&&void 0!==this.lastDirection&&this.lastDirection===e||(this.shpRenderable&&2<this.shpRenderable.frameCount?(this.lastDirection=e,this.updateShapeFrame(e)):this.vxlRotWrapper?(r=n.quaternionFromVec3(this.gameObject.velocity.clone().negate()),this.vxlRotWrapper.rotation.setFromQuaternion(r,"YXZ"),this.gameObject.rules.vertical&&(this.vxlRotWrapper.rotation.y=THREE.Math.degToRad(180+e)),this.vxlRotWrapper.updateMatrix()):this.sonicWaveMesh&&(this.sonicWaveMesh.rotation.y=THREE.Math.degToRad(e),this.sonicWaveMesh.updateMatrix())),this.gameObject.state!==this.lastState&&(this.lastState=this.gameObject.state,this.gameObject.state===s.ProjectileState.Impact&&(this.target.visible=!1,this.renderableManager.createTransientAnim(this.gameObject.impactAnim,e=>{e.setPosition(this.withPosition.getPosition())}),this.gameObject.isNuke&&this.lightingDirector.addEffect(new a.NukeLightingFx)))}updateShapeFrame(e){let t=0;this.objectArt.rotates&&(t=Math.round((e-45+360)%360/360*32)%32),this.shpRenderable.setFrame(t)}createObjects(i){if(this.gameObject.fromWeapon.rules.isSonic){S.sonicWaveGeometry??(S.sonicWaveGeometry=this.createSonicWaveGeometry()),S.sonicWaveMaterial??(S.sonicWaveMaterial=new THREE.MeshBasicMaterial({color:48340,blending:THREE.CustomBlending,blendEquation:THREE.AddEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor,transparent:!0,opacity:.25,alphaTest:.01,depthTest:!1,depthWrite:!1}));let e=new(this.useMeshInstancing?c.BatchedMesh:THREE.Mesh)(S.sonicWaveGeometry,S.sonicWaveMaterial);return e.rotation.order="YXZ",e.rotation.x=-Math.PI/2,e.rotation.y=THREE.Math.degToRad(this.gameObject.direction),e.updateMatrix(),e.matrixAutoUpdate=!1,i.add(e),void(this.sonicWaveMesh=e)}if(!this.gameObject.rules.inviso&&this.gameObject.rules.imageName!==h.ObjectRules.IMAGE_NONE){if(this.gameObject.art.isVoxel){var r=this.objectArt.imageName.toLowerCase(),s=r+".vxl",a=this.voxels.get(s);if(!a)throw new Error(`VXL missing for projectile ${this.gameObject.rules.name}. Vxl file ${s} not found. `);var n=this.objectArt.noHva?void 0:this.voxelAnims.get(r+".hva");let e=this.vxlBuilder=this.vxlBuilderFactory.create(a,n,this.paletteRemaps,this.palette);e.setExtraLight(this.extraLight);s=e.build();let t=this.vxlRotWrapper=new THREE.Object3D;t.rotation.order="YXZ",t.matrixAutoUpdate=!1,t.add(s),i.add(t)}else{r=this.imageFinder.findByObjectArt(this.objectArt),a=this.objectArt.getDrawOffset(),n=this.gameObject.rules.arcing,s=this.gameObject.rules.shadow&&!n&&1<r.numImages;let e=o.ShpRenderable.factory(r,this.palette,this.camera,a,s);e.setBatched(this.useSpriteBatching),this.useSpriteBatching&&e.setBatchPalettes(this.paletteRemaps),e.setExtraLight(this.extraLight),e.create3DObject(),this.shpRenderable=e,i.add(e.get3DObject()),n&&(this.blobShadow=new l.BlobShadow(this.gameObject,1.5,this.useMeshInstancing),this.blobShadow.create3DObject(),i.add(this.blobShadow.get3DObject()))}this.gameObject.fromWeapon.type===g.WeaponType.DeathWeapon&&(i.visible=!1)}}createSonicWaveGeometry(){let e=new THREE.PlaneBufferGeometry(u.Coords.LEPTONS_PER_TILE,u.Coords.LEPTONS_PER_TILE/3,10,10),t=e.getAttribute("position");for(let i=0;i<t.count;i++)t.setY(i,t.getY(i)+Math.cos(t.getX(i)*Math.PI/u.Coords.LEPTONS_PER_TILE)*u.Coords.ISO_WORLD_SCALE);return e}onCreate(r){this.renderableManager=r,this.plugins.forEach(e=>e.onCreate(r));var s=this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===g.WeaponType.Secondary;let a;a=this.gameObject.fromObject?this.gameObject.fromWeapon.type===g.WeaponType.Primary||this.gameObject.fromWeapon.type===g.WeaponType.DeathWeapon||s?this.gameObject.fromObject.art.primaryFirePixelOffset:this.gameObject.fromObject.art.secondaryFirePixelOffset:[];var e,t,s=this.gameObject.fromWeapon.rules;if(this.gameObject.fromWeapon.type!==g.WeaponType.DeathWeapon&&!s.limboLaunch){var n=this.gameObject.fromWeapon.rules.anim;let e;n.length?e=1===n.length?n[0]:(o=this.gameObject.direction,n[Math.round((45-o+360)%360/360*8)%8]):this.gameObject.fromWeapon.warhead.rules.nukeMaker&&(e=this.rules.audioVisual.nukeTakeOff),e&&r.createTransientAnim(e,e=>{e.setPosition(this.gameObject.position.worldPosition),a.length&&(e.extraOffset={x:a[0],y:-a[1]/2})})}if(s.isLaser){let e=this.gameObject.position.worldPosition.clone(),t=new THREE.Vector3;a.length&&(l=u.Coords.screenDistanceToWorld(a[0],0),t.x=4*l.x,t.z=4*l.y,t.y=4*u.Coords.tileHeightToWorld(-a[1]/(u.Coords.ISO_TILE_SIZE/2)));let i=this.gameObject.target.getWorldCoords().clone();this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===g.WeaponType.Secondary&&(t.y+=this.gameObject.fromObject.art.primaryFireFlh.vertical,i.add(t)),e.add(t);var n=new THREE.Color(s.isHouseColor?this.gameObject.fromPlayer.color.asHex():16711680),o=s.laserDuration/m.GameSpeed.BASE_TICKS_PER_SECOND/this.gameSpeed.value,l=2*(1<this.gameObject.baseDamageMultiplier?2:1),l=new d.LaserFx(this.camera,e,i,n,o,l);r.addEffect(l)}if(s.isElectricBolt){let e=this.gameObject.position.worldPosition.clone();this.gameObject.fromObject?.isBuilding()&&(e.y+=u.Coords.tileHeightToWorld(1));l=this.gameObject.target.getWorldCoords();let t=this.specialPalette;var i=new THREE.Color(t.getColorAsHex(s.isAlternateColor?5:10)),c=new THREE.Color(t.getColorAsHex(15)),h=1/this.gameSpeed.value,i=new p.TeslaFx(e,l,i,c,h);r.addEffect(i)}s.isRadBeam&&(c=this.gameObject.position.worldPosition.clone(),h=this.gameObject.target.getWorldCoords().clone(),i=this.gameObject.fromWeapon.warhead.rules.temporal?new THREE.Color(...this.rules.audioVisual.chronoBeamColor.map(e=>e/255)):new THREE.Color(...this.rules.radiation.radColor.map(e=>e/255)),e=1/this.gameSpeed.value,e=new v.RadBeamFx(this.camera,c,h,i,e,1),r.addEffect(e)),this.objectArt.useLineTrail&&(e=(new THREE.Color).fromArray(this.objectArt.lineTrailColor.map(e=>e/255)),t=this.objectArt.lineTrailColorDecrement,t=new f.LineTrailFx(()=>this.target,e,t,this.gameSpeed,this.camera),r.addEffect(t),this.lineTrailFx=t),s.useSparkParticles&&(t=this.gameObject.position.worldPosition.clone(),s=20/m.GameSpeed.BASE_TICKS_PER_SECOND,s=new T.SparkFx(t,new THREE.Color(1,1,1),s,this.gameSpeed),r.addEffect(s))}onRemove(t){this.renderableManager=void 0,this.plugins.forEach(e=>e.onRemove(t)),this.gameObject.overshootTiles&&this.lineTrailFx?.stopTracking(),this.lineTrailFx?.requestFinishAndDispose()}dispose(){this.plugins.forEach(e=>e.dispose()),this.shpRenderable?.dispose(),this.vxlBuilder?.dispose(),this.blobShadow?.dispose()}})}}}),System.register("engine/gfx/drawable/TmpDrawable",["data/Bitmap"],function(e,t){"use strict";var l,i;t&&t.id;return{setters:[function(e){l=e}],execute:function(){e("TmpDrawable",i=class{drawTileBlock(t,i,e,r,s,a){let n=i.data;var o=r/2;let l=e/2-2+i.width*a+s;var c=i.width*i.height;let h=0,u=0,d=0;for(;u<o;u++){d+=4;for(let e=0;e<d;e++){var g=t.tileData[h];0!==g&&0<=l&&l<c&&(n[l]=g),l++,h++}l+=i.width-(d+2)}for(l+=4;u<r;u++){d-=4;for(let e=0;e<d;e++){var p=t.tileData[h];0<=l&&l<c&&(n[l]=p),l+=1,h++}l+=i.width-(d-2)}}draw(e,t,i){let r=t,s=i,a=0,n=0;e.hasExtraData&&(a+=Math.max(0,e.x-e.extraX),n+=Math.max(0,e.y-e.extraY),r+=Math.max(0,e.x-e.extraX),s+=Math.max(0,e.y-e.extraY));var o=new l.IndexedBitmap(r,s);return this.drawTileBlock(e,o,t,i,a,n),e.hasExtraData&&this.drawExtraData(e,o),o}drawExtraData(s,a){if(s.hasExtraData){let t=a.data;var n=a.width,o=a.height,l=Math.max(0,s.extraX-s.x),c=n,h=n*o;let i=0+c*Math.max(0,s.extraY-s.y)+l,r=0;for(let e=0;e<s.extraHeight;e++){for(let e=0;e<s.extraWidth;e++){var u=s.extraData[r];0!==u&&0<=i&&i<h&&(t[i]=u),i+=1,r++}i+=c-s.extraWidth}}}})}}}),System.register("engine/renderable/entity/map/MapTileLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/drawable/TmpDrawable","engine/gfx/TextureAtlas","engine/gfx/SpriteUtils","engine/renderable/entity/Anim","engine/type/LightingType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","util/math"],function(e,t){"use strict";var A,M,R,P,I,k,B,h,j,N,L,i;t&&t.id;return{setters:[function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){h=e},function(e){j=e},function(e){N=e},function(e){L=e}],execute:function(){e("MapTileLayer",i=class{constructor(e,t,i,r,s,a,n,o,l,c){this.theater=t,this.art=i,this.imageFinder=r,this.camera=s,this.debugFrame=a,this.gameSpeed=n,this.worldSound=o,this.lighting=l,this.useSpriteBatching=c,this.tileIndexes=new Map,this.tileAnimLightMultsByTile=new Map,this.disposables=new h.CompositeDisposable,this.theater=t,this.camera=s,this.allTiles=e.tiles.getAll()}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="map_tile_layer",e.matrixAutoUpdate=!1,this.target=e,this.createTileObjects(e))}createTileObjects(t){let r=new Map,s=new Map;var i,a=this.theater.isoPalette,e=M.TextureUtils.textureFromPalette(a);let n=this.theater.tileSets;for(i of this.allTiles){var o=i.tileNum;let e=n.getTile(o);if(!e)return;var l=e.getTmpFile(i.subTile,L.getRandomInt);if(!l||i.subTile>=l.images.length)return;var c=l.images[i.subTile];s.set(i,c),(o=r.get(c))||(o=(new R.TmpDrawable).draw(c,l.blockWidth,l.blockHeight),r.set(c,o))}let h=new P.TextureAtlas,u=[];r.forEach(e=>{u.push(e)}),h.pack(u),this.disposables.add(h);let d=[],g=[];for(let x=0,O=this.allTiles.length;x<O;x++){var p=this.allTiles[x],m=s.get(p);if(!m)throw new Error(`Missing tmp image for tile rx,ry=${p.rx},`+p.ry);let e=0,t=0;m.hasExtraData&&(e+=Math.max(0,m.x-m.extraX),t+=Math.max(0,m.y-m.extraY));var f=A.Coords.tile3dToWorld(p.rx,p.ry,p.z),y=r.get(m);let i=I.SpriteUtils.createSpriteGeometry({texture:h.getTexture(),textureArea:h.getImageRect(y),align:{x:0,y:-1},offset:{x:-e,y:-t},camera:this.camera,scale:A.Coords.ISO_WORLD_SCALE});i.applyMatrix((new THREE.Matrix4).makeTranslation(f.x,f.y,f.z)),d.push(i);var{x:m,y,z:f}=this.lighting.compute(B.LightingType.Full,p);g.push(m,y,f),this.tileIndexes.set(p,x)}var T=new N.PaletteBasicMaterial({map:h.getTexture(),palette:e,alphaTest:.5,flatShading:!0,useVertexColorMult:!0});let v=j.BufferGeometryUtils.mergeBufferGeometries(d);e=v.getAttribute("position").count;if(e!==I.SpriteUtils.VERTICES_PER_SPRITE*g.length/3)throw new Error("Vertex count mismatch");e=new Float32Array(4*e);this.updateColorMultBuffer(g,e);var b,e=new THREE.BufferAttribute(e,4);v.addAttribute("vertexColorMult",e),this.colorMultAttribute=e,d.forEach(e=>e.dispose());let S=new THREE.Mesh(v,T);S.matrixAutoUpdate=!1,S.frustumCulled=!1,t.add(S),this.disposables.add(v,T);let w=[];for(b of this.allTiles){var C=b.tileNum;let e=n.getTile(C);if(!e)return;var E=e.getAnimation();if(E&&b.subTile===E.subTile){C=this.lighting.compute(B.LightingType.Full,b).addScalar(-1);this.tileAnimLightMultsByTile.set(b,C);let e=new k.Anim(E.name,this.art.getAnimation(E.name),{x:E.offsetX,y:E.offsetY+(A.Coords.ISO_TILE_SIZE+1)/2},this.imageFinder,this.theater,this.camera,this.debugFrame,this.gameSpeed,this.useSpriteBatching,C,this.worldSound,a);C=A.Coords.tile3dToWorld(b.rx,b.ry,b.z);e.setPosition(C),e.create3DObject(),w.push(e),t.add(e.get3DObject()),this.disposables.add(e)}}this.anims=w}update(e){for(var t of this.anims)t.update(e)}updateLighting(e){if(e){for(var t of e){var i,r,s,a=this.tileIndexes.get(t);void 0!==a&&({x:i,y:r,z:s}=this.lighting.compute(B.LightingType.Full,t),this.updateColorMultBufferAtIndex(a,i,r,s,this.colorMultAttribute.array)),this.tileAnimLightMultsByTile.get(t)?.copy(this.lighting.compute(B.LightingType.Full,t))}this.colorMultAttribute.needsUpdate=!0}else{let e=[];for(var n of this.allTiles){var{x:o,y:l,z:n}=this.lighting.compute(B.LightingType.Full,n);e.push(o,l,n)}this.updateColorMultBuffer(e,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.tileAnimLightMultsByTile.forEach((e,t)=>{e.copy(this.lighting.compute(B.LightingType.Full,t))})}}updateColorMultBuffer(t,i){var r=I.SpriteUtils.VERTICES_PER_SPRITE,e=t.length/3;let s=0;for(let l=0;l<e;l++){var a=t[3*l],n=t[3*l+1],o=t[3*l+2];for(let e=0;e<r;e++)i[s++]=a,i[s++]=n,i[s++]=o,i[s++]=1}}updateColorMultBufferAtIndex(e,t,i,r,s){var a=I.SpriteUtils.VERTICES_PER_SPRITE;let n=e*a*4;for(let o=0;o<a;o++)s[n++]=t,s[n++]=i,s[n++]=r,s[n++]=1}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapTileLayerDebug",["game/Coords","game/theater/rampHeights","engine/gfx/SpriteUtils","game/type/SpeedType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/IsoCoords"],function(e,t){"use strict";var g,p,a,i,r,n,m,f;t&&t.id;return{setters:[function(e){g=e},function(e){p=e},function(e){a=e},function(e){i=e},function(e){r=e},function(e){n=e},function(e){m=e}],execute:function(){e("MapTileLayerDebug",f=class f{constructor(e,t,i){this._textureTilesNo=20,this.visible=!0,this.needsLinesUpdate=!1,this.disposables=new r.CompositeDisposable,this.handleTileOccupationChanged=()=>this.needsLinesUpdate=!0,this.map=e,this.theater=t,this.camera=i}get3DObject(){return this.target}create3DObject(){let t=this.get3DObject();if(!t){if(t=new THREE.Object3D,t.name="map_tile_layer_debug",t.visible=this.visible,t.matrixAutoUpdate=!1,this.visible){if(!this.tileOverlay){let e=this.tileOverlay=this.createTileOverlay();e.matrixAutoUpdate=!1,e.frustumCulled=!1,t.add(e)}this.setupLines(t)}this.target=t}}update(){this.needsLinesUpdate&&this.visible&&(this.needsLinesUpdate=!1,this.destroyLines(),this.setupLines(this.target))}setVisible(e){if(e!==this.visible&&(this.visible=e,this.target))if(this.target.visible=e,this.visible){if(!this.tileOverlay){let e=this.tileOverlay=this.createTileOverlay();e.matrixAutoUpdate=!1,this.target.add(e)}this.setupLines(this.target)}else this.destroyLines()}setupLines(e){this.lines=new THREE.Object3D,this.lines.matrixAutoUpdate=!1,this.lines.add(this.createConnectivityLines(i.SpeedType.Foot,65280));let t=this.createConnectivityLines(i.SpeedType.Float,255);t.position.y=1,t.updateMatrix(),this.lines.add(t),e.add(this.lines),this.map.tileOccupation.onChange.subscribe(this.handleTileOccupationChanged)}destroyLines(){this.lines&&(this.target.remove(this.lines),this.lines=void 0,this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationChanged))}createTileOverlay(){let s=[],e=this.map.tiles;e.forEach(e=>{var t=g.Coords.tile3dToWorld(e.rx,e.ry,e.z+1),i=m.IsoCoords.getScreenTileSize();let r=a.SpriteUtils.createSpriteGeometry({texture:this.getTileTexture(),textureArea:{x:e.z*i.width,y:2*e.rampType*i.height,width:i.width,height:2*i.height},align:{x:0,y:-1},camera:this.camera,scale:g.Coords.ISO_WORLD_SCALE});r.applyMatrix((new THREE.Matrix4).makeTranslation(t.x,t.y,t.z)),s.push(r)});var t=n.BufferGeometryUtils.mergeBufferGeometries(s),i=new THREE.MeshBasicMaterial({map:this.getTileTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0});return this.disposables.add(t,i),new THREE.Mesh(t,i)}getTileTexture(){let t=f.textureCache;if(!t){var n=m.IsoCoords.getScreenTileSize(),o=this._textureTilesNo;let e=document.createElement("canvas"),r=e.getContext("2d");if(!r)throw new Error("Could not acquire canvas 2d context");e.width=n.width*o,e.height=2*n.height*p.rampHeights.length;let s=m.IsoCoords.tileToScreen(0,0);s.x+=-n.width/2;var l=g.Coords.ISO_TILE_SIZE/2;for(let a=0;a<o;++a)for(let i=0;i<p.rampHeights.length;++i){var c=p.rampHeights[i],h=[[0,1],[0,0],[1,0],[1,1]];let e=16711680-(a<<11)-(a<<7);r.beginPath();var u=m.IsoCoords.tileToScreen.apply(this,h[0]);r.moveTo(-s.x+u.x+a*n.width,-s.y+u.y+(1-c[0])*l+2*i*n.height);for(let t=1;t<h.length;++t){var d=m.IsoCoords.tileToScreen.apply(this,h[t]);r.lineTo(-s.x+d.x+a*n.width,-s.y+d.y+(1-c[t])*l+2*i*n.height)}r.closePath(),r.lineWidth=1,r.fillStyle="#"+e.toString(16),r.fill(),r.strokeStyle="#"+(16777215-e).toString(16),r.stroke()}t=new THREE.Texture(e),t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t.needsUpdate=!0,f.textureCache=t}return t}createConnectivityLines(e,t){let r=this.map.terrain.computePassabilityGraph(e),s=new THREE.Geometry;r.forEachLink(e=>{var t=r.getNode(e.fromId),i=r.getNode(e.toId);s.vertices.push(g.Coords.tile3dToWorld(t.data.tile.rx+.5,t.data.tile.ry+.5,t.data.tile.z+(t.data.onBridge?.tileElevation??0)),g.Coords.tile3dToWorld(i.data.tile.rx+.5,i.data.tile.ry+.5,i.data.tile.z+(i.data.onBridge?.tileElevation??0)))});var i=new THREE.LineBasicMaterial({color:t,transparent:!0,depthTest:!1,depthWrite:!1});let a=new THREE.LineSegments(s,i);return a.matrixAutoUpdate=!1,this.disposables.add(s,i),a}onRemove(){this.lines&&this.destroyLines()}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/WithVisibility",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("WithVisibility",i=class{constructor(){this.visible=!0}setVisible(e){this.visible=e,this.updateVisibility()}isVisible(){return this.visible}updateVisibility(){if(this.target){let e=this.target.get3DObject();e&&(e.visible=this.visible)}}applyTo(e){this.target=e,this.updateVisibility()}})}}}),System.register("engine/renderable/entity/map/MapBounds",["engine/IsoCoords","engine/renderable/WithVisibility","util/disposable/CompositeDisposable"],function(e,t){"use strict";var h,i,r,s;t&&t.id;return{setters:[function(e){h=e},function(e){i=e},function(e){r=e}],execute:function(){e("MapBounds",s=class{constructor(e){this.map=e,this.withVisibility=new i.WithVisibility,this.disposables=new r.CompositeDisposable;let t=()=>{this.target&&this.wrapperObj&&(this.target.remove(this.wrapperObj),this.wrapperObj=this.build(),this.target.add(this.wrapperObj))};e.mapBounds.onLocalResize.subscribe(t),this.disposables.add(()=>e.mapBounds.onLocalResize.unsubscribe(t))}build(){var e=this.map.mapBounds.getClampedFullSize(),t=this.map.mapBounds.getLocalSize();let i=this.createBoundRect({x:e.x,y:e.y},{x:e.x+e.width,y:e.y+e.height},16711680);i.matrixAutoUpdate=!1;let r=this.createBoundRect({x:t.x,y:t.y},{x:t.x+t.width,y:t.y+t.height-1},255);r.matrixAutoUpdate=!1;let s=new THREE.Object3D;return s.matrixAutoUpdate=!1,s.add(i),s.add(r),s}createBoundRect(e,t,i){var r=h.IsoCoords.screenTileToWorld(e.x,e.y),s=h.IsoCoords.screenTileToWorld(t.x,t.y),a=h.IsoCoords.screenTileToWorld(t.x,e.y),n=h.IsoCoords.screenTileToWorld(e.x,t.y),o=new THREE.LineBasicMaterial({color:i,transparent:!0,depthTest:!1,depthWrite:!1});let l=new THREE.Geometry;l.vertices.push(new THREE.Vector3(r.x,0,r.y),new THREE.Vector3(n.x,0,n.y),new THREE.Vector3(s.x,0,s.y),new THREE.Vector3(a.x,0,a.y),new THREE.Vector3(r.x,0,r.y)),this.disposables.add(l,o);let c=new THREE.Line(l,o);return c.renderOrder=1e6,c}get3DObject(){return this.target}create3DObject(){if(!this.target){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,e.name="map_bounds",e.visible=this.withVisibility.isVisible(),this.target=e,!this.wrapperObj&&e.visible&&(this.wrapperObj=this.build(),this.target.add(this.wrapperObj))}}update(){}setVisible(e){e!==this.withVisibility.isVisible()&&(this.withVisibility.setVisible(e),this.target&&((this.target.visible=e)?(this.wrapperObj||(this.wrapperObj=this.build()),this.target.add(this.wrapperObj)):this.wrapperObj&&this.target.remove(this.wrapperObj)))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapShroudLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/SpriteUtils","util/disposable/CompositeDisposable","engine/renderable/builder/ShpTextureAtlas","data/Palette","util/Color","game/map/MapShroud","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial"],function(e,t){"use strict";var n,f,y,r,T,v,b,o,S,w,l,c,h,i;t&&t.id;return{setters:[function(e){n=e},function(e){f=e},function(e){y=e},function(e){r=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){o=e},function(e){S=e},function(e){w=e}],execute:function(){l=[[1,32],[4,33],[8,34],[2,35],[5,36],[12,37],[10,38],[3,39],[13,40],[14,41],[11,42],[7,43],[9,44],[6,45],[15,46]].reduce((e,t)=>(e[t[0]]=t[1],e),new Array(16).fill(void 0)),c=[[24,16],[34,17],[50,18],[65,19],[97,20],[132,21],[152,22],[196,23],[18,24],[33,25],[68,26],[136,27],[26,28],[35,29],[69,30],[140,31]].reduce((e,t)=>(e[t[0]]=t[1],e),new Array(256).fill(void 0)),h=[0,5,12,13,10,15,14,15,3,7,15,15,11,15,15,15],e("MapShroudLayer",i=class{constructor(e,t,i){this.shroud=e,this.imageFinder=t,this.camera=i,this.disposables=new r.CompositeDisposable,this.needsIncrementalUpdate=[],this.needsFullUpdate=!1,this.onShroudChange=e=>{"incremental"===e.type?this.needsIncrementalUpdate.push(...e.coords):this.needsFullUpdate=e.type},this.camera=i}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="map_shroud_layer",e.matrixAutoUpdate=!1,this.target=e,this.createTileObjects(e),this.shroud.onChange.subscribe(this.onShroudChange),this.disposables.add(()=>this.shroud.onChange.unsubscribe(this.onShroudChange)))}createTileObjects(e){var t=this.imageFinder.find("shroud",!1);let i=(new T.ShpTextureAtlas).fromShpFile(t);this.disposables.add(i);let r=new v.Palette,s=[new b.Color(0,0,0),new b.Color(0,0,0)];for(let g=0;g<254;g++){var a=Math.min(255,Math.floor(g/125*255));s.push(new b.Color(a,a,a))}r.setColors(s);t=f.TextureUtils.textureFromPalette(r);let n=[],o=0;var l=this.shroud.getSize();for(let p=0;p<l.height;p++)for(let e=0;e<l.width;e++){var c={sx:e,sy:p},h=this.getFrameNo(c),h=this.createTileGeometry(c,i,h);n.push(h),o++}t=new w.PaletteBasicMaterial({map:i.getTexture(),palette:t,alphaTest:.01,flatShading:!0,transparent:!0,depthTest:!1,blending:THREE.MultiplyBlending});let u=S.BufferGeometryUtils.mergeBufferGeometries(n);if(u.getAttribute("position").count!==y.SpriteUtils.VERTICES_PER_SPRITE*o)throw new Error("Vertex count mismatch");this.uvAttribute=u.getAttribute("uv");this.uvElemsPerPiece=this.uvAttribute.count*this.uvAttribute.itemSize/o,this.uvLookup=new Float32Array(47*this.uvElemsPerPiece);for(let m=0;m<47;m++){let e=y.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(i,m));this.uvLookup.set(e.getAttribute("uv").array,m*this.uvElemsPerPiece)}n.forEach(e=>e.dispose());let d=new THREE.Mesh(u,t);d.renderOrder=999999,d.matrixAutoUpdate=!1,d.frustumCulled=!1,e.add(d),this.disposables.add(u,t)}createTileGeometry(e,t,i){var{rx:r,ry:s}=this.shroud.shroudCoordsToWorld(e),s=n.Coords.tile3dToWorld(r,s,0);let a=y.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(t,i));return a.applyMatrix((new THREE.Matrix4).makeTranslation(s.x,s.y,s.z)),a}getTileGeometryOptions(e,t){return{texture:e.getTexture(),textureArea:e.getTextureArea(t),flat:!0,align:{x:0,y:-1},camera:this.camera,scale:n.Coords.ISO_WORLD_SCALE}}update(e){var t;this.needsFullUpdate&&("cover"===this.needsFullUpdate||"clear"===this.needsFullUpdate?this.toggleAllTiles("cover"===this.needsFullUpdate?o.ShroudType.Unexplored:o.ShroudType.Explored):(this.updateAllTiles(),this.needsIncrementalUpdate=[]),this.uvAttribute.needsUpdate=!0,this.needsFullUpdate=!1),this.needsIncrementalUpdate.length&&(t=this.extendToAdjacentTiles(this.needsIncrementalUpdate),this.updateTiles(t),this.uvAttribute.needsUpdate=!0,this.needsIncrementalUpdate.length=0)}extendToAdjacentTiles(e){let i=new Map;var r,s=this.shroud.getSize();for(r of e)for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++){var a=r.sx+t,n=r.sy+e;0<=a&&0<=n&&a<s.width&&n<s.height&&i.set(a+"_"+n,{sx:a,sy:n})}return[...i.values()]}updateTiles(e){var t,i=this.shroud.getSize();for(t of e){var r=t.sx+t.sy*i.width;this.updateTilePiece(r,this.getFrameNo(t))}}updateAllTiles(){var t=this.shroud.getSize();for(let s=0;s<t.height;s++)for(let e=0;e<t.width;e++){var i={sx:e,sy:s},r=i.sx+i.sy*t.width;this.updateTilePiece(r,this.getFrameNo(i))}}toggleAllTiles(e){var t=e===o.ShroudType.Unexplored?15:0,i=this.uvLookup.subarray(t*this.uvElemsPerPiece,(1+t)*this.uvElemsPerPiece);let r=this.uvAttribute.array;t=this.shroud.getSize();for(let s=0,a=t.width*t.height;s<a;s++)r.set(i,s*this.uvElemsPerPiece)}updateTilePiece(e,t){this.uvAttribute.array.set(this.uvLookup.subarray(t*this.uvElemsPerPiece,(t+1)*this.uvElemsPerPiece),e*this.uvElemsPerPiece)}getFrameNo(t){var i;if(this.shroud.getShroudTypeByShroudCoords(t)===o.ShroudType.Unexplored)return 15;let e=0;this.hasShroudedNeighbour(t,0,-1)&&(e+=1),this.hasShroudedNeighbour(t,1,0)&&(e+=2),this.hasShroudedNeighbour(t,0,1)&&(e+=4),this.hasShroudedNeighbour(t,-1,0)&&(e+=8);let r=0;for(let a=-1;a<=1;a+=2)for(let e=-1;e<=1;e+=2)this.hasShroudedNeighbour(t,a,e)&&(i=a+1+(e+1>>1),r+=1<<i);if(0<r)if(0===e)e=l[r];else{var s=r&~h[e];if(0<s){s=c[s+(e<<4)];if(void 0===s)throw new Error(`Missing mapped corner frame number for cornerValue "${r}",`+"edgeFrameNo="+e);e=s}}return e}hasShroudedNeighbour({sx:e,sy:t},i,r){return this.shroud.getShroudTypeByShroudCoords({sx:e+i,sy:t+r})===o.ShroudType.Unexplored}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapRenderable",["engine/renderable/entity/map/MapTileLayer","engine/renderable/entity/map/MapTileLayerDebug","engine/renderable/entity/map/MapSurface","engine/renderable/entity/map/MapBounds","engine/renderable/entity/map/MapShroudLayer","engine/renderable/builder/ShpAggregator","engine/renderable/entity/map/MapSpriteBatchLayer","game/map/BridgeOverlayTypes"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("MapRenderable",h=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d){this.gameObj=e,this.mapShroud=t,this.mapRadiation=i,this.lighting=r,this.theater=s,this.rules=a,this.art=n,this.imageFinder=o,this.camera=l,this.debugWireframe=c,this.gameSpeed=h,this.worldSound=u,this.useSpriteBatching=d,this.lastDebugValue=!1,this.invalidatedRadTiles=new Set,this.radTileLights=new Map,this.handleRadChange=e=>{for(var t of e)this.invalidatedRadTiles.add(t)},this._objects=[],this.init()}get3DObject(){return this.target}getGameObject(){return this.gameObj}init(){var e=this.getGameObject();this.tileLayer=new i.MapTileLayer(e,this.theater,this.art,this.imageFinder,this.camera,this.debugWireframe,this.gameSpeed,this.worldSound,this.lighting,this.useSpriteBatching),this.addObject(this.tileLayer),this.debugLayer=new r.MapTileLayerDebug(e,this.theater,this.camera),this.debugLayer.setVisible(!1),this.addObject(this.debugLayer),this.mapSurface=new s.MapSurface(e,this.theater),this.addObject(this.mapSurface),this.mapBounds=new a.MapBounds(e),this.mapBounds.setVisible(!1),this.mapShroud&&(this.shroudLayer=new n.MapShroudLayer(this.mapShroud,this.imageFinder,this.camera),this.addObject(this.shroudLayer)),this.addObject(this.mapBounds);e=new o.ShpAggregator;this.terrainLayer=new l.MapSpriteBatchLayer("map_terrain_layer",[...this.rules.terrainRules.values()].filter(e=>!e.isAnimated&&this.art.hasObject(e.name,e.type)),()=>!1,this.theater,this.art,this.imageFinder,this.camera,this.lighting,e),this.addObject(this.terrainLayer),this.overlayLayer=new l.MapSpriteBatchLayer("map_overlay_layer",[...this.rules.overlayRules.values()].filter(e=>this.art.hasObject(e.name,e.type)&&!c.BridgeOverlayTypes.isBridge(this.rules.getOverlayId(e.name))),e=>e.rules.wall,this.theater,this.art,this.imageFinder,this.camera,this.lighting,e),this.addObject(this.overlayLayer),this.smudgeLayer=new l.MapSpriteBatchLayer("map_smudge_layer",[...this.rules.smudgeRules.values()].filter(e=>this.art.hasObject(e.name,e.type)),()=>!1,this.theater,this.art,this.imageFinder,this.camera,this.lighting,e),this.addObject(this.smudgeLayer),this.mapRadiation.onChange.subscribe(this.handleRadChange)}addObject(e){this._objects.push(e)}create3DObject(){let i=this.get3DObject();if(!i){i=new THREE.Object3D,i.name="map",i.matrixAutoUpdate=!1,this.target=i;for(let e=0,t=this._objects.length;e<t;++e)this._objects[e].create3DObject(),i.add(this._objects[e].get3DObject())}}update(t,i){if(this.create3DObject(),this.debugWireframe.value!==this.lastDebugValue&&(this.lastDebugValue=this.debugWireframe.value,this.debugLayer.setVisible(this.debugWireframe.value),this.mapBounds.setVisible(this.debugWireframe.value)),this._objects.forEach(e=>e.update(t,i)),this.invalidatedRadTiles.size){for(var e of this.invalidatedRadTiles){var r,s=this.mapRadiation.getRadLevel(e);s?(r=Math.min(1,s/this.rules.radiation.radLevelMax),this.radTileLights.has(e)&&this.lighting.removeTileLight(e,this.radTileLights.get(e)),s=this.rules.radiation.radColor,r={intensity:this.rules.radiation.radLightFactor*r,red:s[0]/255*r,green:s[1]/255*r,blue:s[2]/255*r},this.lighting.addTileLight(e,r),this.radTileLights.set(e,r)):(this.lighting.removeTileLight(e,this.radTileLights.get(e)),this.radTileLights.delete(e))}this.lighting.forceUpdate([...this.invalidatedRadTiles]),this.invalidatedRadTiles.clear()}}updateLighting(e){this.tileLayer.updateLighting(e),this.terrainLayer.updateLighting(),this.overlayLayer.updateLighting(),this.smudgeLayer.updateLighting()}dispose(){this.mapRadiation.onChange.unsubscribe(this.handleRadChange),this.tileLayer.dispose(),this.debugLayer.dispose(),this.terrainLayer.dispose(),this.overlayLayer.dispose(),this.smudgeLayer.dispose(),this.shroudLayer?.dispose(),this.mapBounds.dispose(),this.mapSurface.dispose()}})}}}),System.register("engine/renderable/entity/plugin/HarvesterPlugin",["game/gameobject/trait/HarvesterTrait","game/Coords"],function(e,t){"use strict";var i,s,r;t&&t.id;return{setters:[function(e){i=e},function(e){s=e}],execute:function(){e("HarvesterPlugin",r=class{constructor(e,t){this.gameObject=e,this.harvesterTrait=t}onCreate(e){this.renderableManager=e}update(e){if(this.gameObject.warpedOutTrait.isActive())return this.disposeHarvAnim(),void(this.lastHarvesterStatus=void 0);var t;!this.renderableManager||(t=this.harvesterTrait.status)!==this.lastHarvesterStatus&&(this.lastHarvesterStatus=t,this.disposeHarvAnim(),t===i.HarvesterStatus.Harvesting&&(this.harvestAnim=this.renderableManager.createTransientAnim("OREGATH",e=>{var t=this.gameObject.tile;e.setPosition(s.Coords.tile3dToWorld(t.rx+.5,t.ry+.5,t.z)),e.create3DObject();let i=e.getAnimProps();var r=Math.floor(e.getShpFile().numImages/8),t=(this.gameObject.direction-45+360)%360,t=Math.round(t/360*8)%8*r;i.loopStart=i.start=t,i.loopEnd=t+r-1,i.loopCount=-1})))}disposeHarvAnim(){this.harvestAnim?.remove(),this.harvestAnim?.dispose(),this.harvestAnim=void 0}onRemove(){this.disposeHarvAnim()}dispose(){this.disposeHarvAnim()}})}}}),System.register("engine/renderable/entity/plugin/MoveSoundFxPlugin",["game/gameobject/unit/ZoneType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("MoveSoundFxPlugin",r=class{constructor(e,t,i){this.gameObject=e,this.moveSound=t,this.worldSound=i,this.lastMovingOrRotating=!1}onCreate(){}update(){var e;this.gameObject.isDestroyed||this.gameObject.isCrashing||(e=!this.gameObject.warpedOutTrait.isActive()&&!!(!this.gameObject.rules.balloonHover&&this.gameObject.rules.hoverAttack&&this.gameObject.zone===i.ZoneType.Air||this.gameObject.spinVelocity||!this.gameObject.moveTrait.isIdle()&&!this.gameObject.moveTrait.isWaiting()))!==this.lastMovingOrRotating&&((this.lastMovingOrRotating=e)?this.soundHandle&&this.soundHandle.isPlaying()||(this.soundHandle=this.worldSound.playEffect(this.moveSound,this.gameObject,this.gameObject.owner,.35)):this.soundHandle?.isLoop&&(this.soundHandle.stop(),this.soundHandle=void 0))}onRemove(){this.soundHandle?.stop()}dispose(){this.soundHandle?.stop()}})}}}),System.register("engine/renderable/entity/plugin/VehicleDisguisePlugin",["engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","engine/type/ObjectType"],function(e,t){"use strict";var c,h,r,i;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){r=e}],execute:function(){e("VehicleDisguisePlugin",i=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u){this.gameObject=e,this.disguiseTrait=t,this.localPlayer=i,this.alliances=r,this.renderable=s,this.art=a,this.imageFinder=n,this.theater=o,this.camera=l,this.lighting=c,this.gameSpeed=h,this.useSpriteBatching=u,this.lastRenderDisguised=!1,this.canSeeThroughDisguise=!1}onCreate(){}update(t){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let e=this.disguiseTrait.isDisguised();var i=e!==this.lastDisguised;if(i&&(this.lastDisguised=e,this.disguisedAt=e?t:void 0),e&&(this.canSeeThroughDisguise=!this.localPlayer||this.alliances.haveSharedIntel(this.localPlayer,this.gameObject.owner)||!!this.localPlayer.sharedDetectDisguiseTrait?.has(this.gameObject)),e&&this.canSeeThroughDisguise&&(e=!this.localPlayer?.sharedDetectDisguiseTrait?.has(this.gameObject)&&Math.floor((t-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3),this.lastRenderDisguised!==e&&(this.lastRenderDisguised=e,this.renderable.mainObj.visible=!e,this.renderable.posObj.visible=!e||this.canSeeThroughDisguise,this.disguiseObj&&(this.disguiseObj.visible=!1),e)){i=this.disguiseTrait.getDisguise();if(i.rules.type!==r.ObjectType.Terrain)throw new Error("Unsupported disguise type "+r.ObjectType[i.rules.type]);i=this.art.getObject(i.rules.name,r.ObjectType.Terrain);this.disguiseObj||(this.disguiseObj=this.createDisguiseObj(i),this.renderable.get3DObject().add(this.disguiseObj)),this.disguiseObj.visible=!0;i=this.lighting.compute(i.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1);this.disguiseRenderable.setExtraLight(i)}}}createDisguiseObj(e){let t=new THREE.Object3D;t.matrixAutoUpdate=!1;let i=1,r=1,s=new c.MapSpriteTranslation(i,r);var{spriteOffset:a,anchorPointWorld:n}=s.compute();t.position.x=n.x,t.position.z=n.y,t.updateMatrix();var o=this.imageFinder.findByObjectArt(e),n=this.theater.getPalette(e.paletteType,e.customPaletteName);let l=h.ShpRenderable.factory(o,n,this.camera,a,e.hasShadow);return l.setBatched(this.useSpriteBatching),this.useSpriteBatching&&l.setBatchPalettes([n]),l.setFrame(0),l.create3DObject(),t.add(l.get3DObject()),this.disguiseRenderable=l,t}updateLighting(){if(this.disguiseObj?.visible&&this.disguiseRenderable){var e=this.disguiseTrait.getDisguise();if(e){if(e.rules.type!==r.ObjectType.Terrain)throw new Error("Unsupported disguise type "+r.ObjectType[e.rules.type]);e=this.art.getObject(e.rules.name,r.ObjectType.Terrain);this.disguiseRenderable.setExtraLight(this.lighting.compute(e.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1))}}}onRemove(){this.disguiseObj&&(this.renderable.get3DObject().remove(this.disguiseObj),this.disguiseObj=void 0)}getUiNameOverride(){if(this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise)return""}shouldDisableHighlight(){return!!this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise}dispose(){this.disguiseRenderable?.dispose()}})}}}),System.register("engine/renderable/entity/plugin/ChronoSparkleFxPlugin",["game/Coords"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("ChronoSparkleFxPlugin",i=class{constructor(e,t){this.gameObject=e,this.sparkleAnimName=t,this.objMoveTrait=e.isUnit()?e.moveTrait:void 0}onCreate(e){this.renderableManager=e}update(){if(!this.gameObject.isDestroyed&&!this.gameObject.isCrashing&&this.renderableManager){var e=this.objMoveTrait?.lastTeleportTick,i=e!==this.lastTeleport;let t=this.gameObject.warpedOutTrait.isActive();(t!==this.lastWarpedOut||i)&&(this.lastTeleport=e,(this.lastWarpedOut=t)||i?(this.chronoSparkleAnim?.endAnimationLoop(),this.chronoSparkleAnim=this.renderableManager.createTransientAnim(this.sparkleAnimName,e=>{e.extraOffset={x:0,y:r.Coords.ISO_TILE_SIZE/2},e.setPosition(this.gameObject.position.worldPosition.clone()),e.create3DObject(),e.getAnimProps().loopCount=t?-1:1})):t||this.chronoSparkleAnim?.endAnimationLoop())}}onRemove(){this.renderableManager=void 0,this.chronoSparkleAnim?.endAnimationLoop()}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/TntFxPlugin",["engine/type/ObjectType","engine/sound/SoundKey"],function(e,t){"use strict";var i,a,r;t&&t.id;return{setters:[function(e){i=e},function(e){a=e}],execute:function(){e("TntFxPlugin",r=class{constructor(e,t,i,r,s,a,n,o,l,c){this.gameObject=e,this.tntChargeTrait=t,this.frameDurationTicks=i,this.renderable=r,this.imageFinder=s,this.art=a,this.alliances=n,this.viewer=o,this.worldSound=l,this.animFactory=c,this.lastHasCharge=!1}onCreate(){this.animStepCount=Math.floor(this.imageFinder.findByObjectArt(this.art.getObject("BOMBCURS",i.ObjectType.Animation)).numImages/2)}update(e){if(this.gameObject.isDestroyed||this.gameObject.isCrashing)this.gameObject.rules.leaveRubble&&(this.disposeBombAnim(),this.soundHandle?.stop());else{var t=this.tntChargeTrait.hasCharge(),r=t!==this.lastHasCharge;let i;i=t?(s=1-this.tntChargeTrait.getTicksLeft()/this.tntChargeTrait.getInitialTicks(),Math.floor(2*s*(this.animStepCount-1))):0;var s=i!==this.lastStartFrame;if(this.bombAnim?.update(e),r||s)if(this.lastHasCharge=t,this.lastStartFrame=i,t){r&&(this.soundHandle?.stop(),this.soundHandle=this.worldSound?.playEffect(a.SoundKey.BombTickingSound,this.gameObject)),this.disposeBombAnim();r=this.gameObject.tntChargeTrait.getChargeOwner();if(!this.viewer||this.alliances.haveSharedIntel(r,this.viewer)){let e=this.bombAnim=this.animFactory("BOMBCURS");e.setRenderOrder(999995),e.create3DObject();let t=e.getAnimProps();t.loopCount=-1,t.start=t.loopStart=i,t.end=i+2-1,t.loopEnd=t.end,t.rate/=this.frameDurationTicks,this.renderable.get3DObject()?.add(e.get3DObject())}}else this.disposeBombAnim(),this.soundHandle?.stop()}}disposeBombAnim(){this.bombAnim?.get3DObject()&&this.renderable.get3DObject()?.remove(this.bombAnim.get3DObject()),this.bombAnim?.dispose()}onRemove(){this.disposeBombAnim(),this.soundHandle?.stop()}dispose(){this.disposeBombAnim(),this.soundHandle?.stop()}})}}}),System.register("engine/renderable/fx/MindControlLinkFx",["game/Coords"],function(e,t){"use strict";var m,i;t&&t.id;return{setters:[function(e){m=e}],execute:function(){e("MindControlLinkFx",i=class{constructor(e,t,i,r){this.sourcePos=e,this.targetPos=t,this.color=i,this.heightTiles=r,this.colorAnimProgress=0}setContainer(e){this.container=e}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_mclink")}updateEndpoints(e,t){var i=!e.equals(this.sourcePos)||!t.equals(this.targetPos);this.sourcePos=e,this.targetPos=t,i&&this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress))}update(e){this.lastUpdate??(this.lastUpdate=e),this.colorAnimProgress+=(e-this.lastUpdate)/1e3,this.colorAnimProgress-=Math.floor(this.colorAnimProgress),this.lastUpdate=e,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress)}createObject(){var e=this.sourcePos,t=this.targetPos,e=this.createLineGeometry(e,t,this.heightTiles,this.color,this.colorAnimProgress),t=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0});let i=new THREE.Line(e,t);return i.renderOrder=1e6,i}createLineGeometry(t,i,r,s,e){var a=new THREE.Color(16777215),n=1.5*e,o=i.clone().sub(t).length()/m.Coords.LEPTONS_PER_TILE,l=Math.floor(15*o);let c=new Float32Array(3*l),h=new Float32Array(3*l),u=new THREE.Vector3;for(let p=0;p<=l;p++){var d=p/l;u.lerpVectors(t,i,d),u.y+=m.Coords.LEPTONS_PER_TILE/4+r*m.Coords.LEPTONS_PER_TILE*Math.sin(d*Math.PI),c[3*p]=u.x,c[3*p+1]=u.y,c[3*p+2]=u.z;let e=s;d<n&&n-.5<=d&&(e=s.clone().lerp(a,(d-(n-.5))/.5)),h[3*p]=e.r,h[3*p+1]=e.g,h[3*p+2]=e.b}let g=new THREE.BufferGeometry;return g.addAttribute("position",new THREE.BufferAttribute(c,3)),g.addAttribute("color",new THREE.BufferAttribute(h,3)),g}removeAndDispose(){this.container.remove(this),this.dispose()}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/entity/plugin/MindControlLinkPlugin",["engine/renderable/fx/MindControlLinkFx"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("MindControlLinkPlugin",i=class{constructor(e,t,i,r){this.source=e,this.selectionModel=t,this.alliances=i,this.viewer=r,this.links=new Map}onCreate(e){this.renderableManager=e}update(){if(!this.source.isDestroyed&&!this.source.isCrashing&&this.source.mindControllerTrait)if(!this.selectionModel.isSelected()||this.viewer&&!this.alliances.haveSharedIntel(this.source.owner,this.viewer))this.disposeLinks();else{let e=this.source.mindControllerTrait.getTargets();for(var[t,i]of this.links.entries())e.includes(t)||(i.removeAndDispose(),this.links.delete(t));var r,s=new THREE.Color(this.source.owner.color.asHex()),a=this.source.position.worldPosition.clone();for(r of e){var n=r.position.worldPosition.clone();let e=this.links.get(r);e||(e=new o.MindControlLinkFx(a,n,s,2),this.links.set(r,e),this.renderableManager?.addEffect(e)),e.updateEndpoints(a,n)}}}onRemove(){this.renderableManager=void 0,this.disposeLinks()}dispose(){this.disposeLinks()}disposeLinks(){this.links.forEach(e=>e.removeAndDispose()),this.links.clear()}})}}}),System.register("engine/renderable/entity/plugin/InfantryDisguisePlugin",["engine/type/ObjectType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("InfantryDisguisePlugin",i=class{constructor(e,t,i,r,s,a,n){this.gameObject=e,this.disguiseTrait=t,this.localPlayer=i,this.alliances=r,this.renderable=s,this.art=a,this.gameSpeed=n,this.canSeeThroughDisguise=!1}onCreate(){}update(t){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let e=this.disguiseTrait.getDisguise();var i;e!==this.lastDisguise&&(this.lastDisguise=e,this.disguisedAt=e?t:void 0),e&&(this.canSeeThroughDisguise=!this.localPlayer||this.alliances.haveSharedIntel(this.localPlayer,this.gameObject.owner)||!!this.localPlayer.sharedDetectDisguiseTrait?.has(this.gameObject)),e&&this.canSeeThroughDisguise&&(e=this.localPlayer?.sharedDetectDisguiseTrait?.has(this.gameObject)?void 0:Math.floor((t-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3?e:void 0),this.lastRenderDisguise!==e&&(this.lastRenderDisguise=e,e?(i=this.art.getObject(e.rules.name,r.ObjectType.Infantry),this.renderable.setDisguise({objectArt:i,owner:e.owner})):this.renderable.setDisguise(void 0))}}onRemove(){}getUiNameOverride(){var e=this.gameObject.disguiseTrait?.getDisguise();if(e&&!this.canSeeThroughDisguise)return e.rules.uiName}dispose(){}})}}}),System.register("engine/renderable/fx/DetectionLineFx",["three.meshline","game/Coords"],function(e,t){"use strict";var s,a,n,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e}],execute:function(){n=new THREE.Color(16777215),e("DetectionLineFx",i=class i{constructor(e,t,i,r,s){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.renderOrder=s,this.needsUpdate=!1,this.cameraHash=this.camera.top+"_"+this.camera.right,this.computedColor=r,this.lineHeadMaterial=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1})}setContainer(e){this.container=e}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.name="fx_detectionline",this.lineMesh=this.createLineMesh(),this.srcLineHead=this.createLineHead(),this.destLineHead=this.createLineHead(),this.wrapper.add(this.srcLineHead),this.wrapper.add(this.destLineHead),this.wrapper.add(this.lineMesh),this.needsUpdate=!0)}update(e){this.lastUpdateMillis||(this.lastUpdateMillis=e);var t=(e-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=e;var i=this.camera.top+"_"+this.camera.right;i!==this.cameraHash&&(this.cameraHash=i,this.lineMesh.material.uniforms.resolution.value.copy(this.computeResolution(this.camera)));let r=this.lineMesh.material;this.needsUpdate&&(this.needsUpdate=!1,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),i=this.sourcePos.distanceTo(this.targetPos),r.uniforms.dashArray.value=this.computeDashArray(i),this.srcLineHead.position.copy(this.sourcePos),this.destLineHead.position.copy(this.targetPos)),r.uniforms.dashOffset.value-=r.uniforms.dashArray.value/50*t;t=Math.sin(e%1e3/1e3*Math.PI);let s=this.computedColor.copy(this.color).lerp(n,t);this.lineMesh.material.uniforms.color.value=s.clone(),this.lineHeadMaterial.color.set(s)}createLineMesh(){let e=this.sourcePos.clone();var t=this.targetPos.clone();let i=new THREE.Mesh(this.createLineGeometry(e,t),this.createLineMaterial(this.color.clone(),e.distanceTo(t)));return i.renderOrder=this.renderOrder,i}createLineGeometry(e,t){let i=new THREE.Geometry;i.vertices.push(e,t);let r=new s.MeshLine;return r.setGeometry(i),r.geometry}createLineMaterial(e,t){return new s.MeshLineMaterial({color:e,lineWidth:1,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(t),depthTest:!1})}createLineHead(){let e=new THREE.Mesh(i.lineHeadGeometry,this.lineHeadMaterial);var t=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return e.setRotationFromQuaternion(t),e.renderOrder=this.renderOrder,e}computeDashArray(e){return Math.min(1,5/e)*a.Coords.ISO_WORLD_SCALE}computeResolution(e){var t=e.top,i=e.right/e.top,r=2*t/Math.cos(e.rotation.y);return new THREE.Vector2(r*i,r).multiplyScalar(t*Math.cos(this.camera.rotation.x)/a.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose(),this.lineHeadMaterial.dispose())}}),i.lineHeadGeometry=new THREE.PlaneGeometry(3*a.Coords.ISO_WORLD_SCALE,3*a.Coords.ISO_WORLD_SCALE)}}}),System.register("engine/renderable/entity/building/PsychicDetectPlugin",["engine/renderable/fx/DetectionLineFx"],function(e,t){"use strict";var d,i;t&&t.id;return{setters:[function(e){d=e}],execute:function(){e("PsychicDetectPlugin",i=class{constructor(e,t,i,r){this.gameObject=e,this.psychicDetectorTrait=t,this.localPlayer=i,this.camera=r,this.lineEffects=new Map}onCreate(e){this.renderableManager=e}update(e){if(this.localPlayer===this.gameObject.owner){let e=this.psychicDetectorTrait.detectionLines;var r,s,t,a,n=e!==this.lastDetectionLines;this.lastDetectionLines=e;let i=e.map(e=>({hash:e.source.id+"_"+(e.target.obj?.id??e.target.tile.id),line:e}));if(n){for(let t of this.lineEffects.keys())i.find(({hash:e})=>e===t)||(this.disposeLine(this.lineEffects.get(t)),this.lineEffects.delete(t));for(var{line:o,hash:l}of i)this.lineEffects.has(l)||(r=o.source.position.worldPosition.clone(),s=o.target.getWorldCoords().clone(),o=new THREE.Color(o.source.owner.color.asHex()),o=new d.DetectionLineFx(this.camera,r,s,o,1e6),this.lineEffects.set(l,o),this.renderableManager.addEffect(o))}for({line:t,hash:a}of i){let e=this.lineEffects.get(a);if(!e)throw new Error("Line hash should have been found");var c=t.source.position.worldPosition.clone(),h=t.target.getWorldCoords().clone(),u=new THREE.Color(t.source.owner.color.asHex());e.color.equals(u)||(e.color.copy(u),e.needsUpdate=!0),e.sourcePos.equals(c)||(e.sourcePos.copy(c),e.needsUpdate=!0),e.targetPos.equals(h)||(e.targetPos.copy(h),e.needsUpdate=!0)}}else this.lineEffects.forEach(e=>this.disposeLine(e))}onRemove(){this.renderableManager=void 0,this.dispose()}dispose(){this.lineEffects.forEach(e=>this.disposeLine(e))}disposeLine(e){e.remove(),e.dispose()}})}}}),System.register("engine/gfx/ImageUtils",["data/Bitmap","engine/gfx/CanvasUtils"],function(e,t){"use strict";var u,s,r;t&&t.id;return{setters:[function(e){u=e},function(e){s=e}],execute:function(){e("ImageUtils",r=class r{static async convertShpToPng(e,t){var i=r.convertShpToCanvas(e,t);return await s.CanvasUtils.canvasToBlob(i)}static convertShpToBitmap(e,t,i=!1){let r=0,s=0,a=e.width,n=e.height;a!==n&&i&&(r=a>n?0:Math.floor((n-a)/2),s=a>n?Math.floor((a-n)/2):0,a=n=Math.max(a,n));let o=new u.IndexedBitmap(e.numImages*a,n);for(let h=0;h<e.numImages;h++){var l=e.getImage(h),c=new u.IndexedBitmap(l.width,l.height,l.imageData);o.drawIndexedImage(c,h*a+l.x+r,l.y+s)}return o}static convertShpToCanvas(e,t,i=!1){var r=this.convertShpToBitmap(e,t,i);return s.CanvasUtils.canvasFromIndexedImageData(r.data,r.width,r.height,t)}})}}}),System.register("engine/renderable/fx/TrailerSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],function(e,t){"use strict";var r,s,a,n,o;t&&t.id;return{setters:[function(e){r=e},function(e){s=e}],execute:function(){n=a=1e3,e("TrailerSmokeFx",o=class o{constructor(e,t,i,r,s,a){this.pos=e,this.spawnDelayFrames=t,this.smokeArt=i,this.shpFile=r,this.palette=s,this.gameSpeed=a,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1,this.finishProcessed=!1}static clearTextureCache(){this.textureCache.forEach(e=>e.dispose()),this.textureCache.clear()}setContainer(e){this.container=e}create3DObject(){if(!this.particleGroup){let e=o.textureCache.get(this.shpFile);e||(i=s.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),e=new THREE.Texture(i),e.minFilter=THREE.NearestFilter,e.magFilter=THREE.NearestFilter,e.needsUpdate=!0,e.flipY=!0,o.textureCache.set(this.shpFile,e)),this.particleGroup=new SPE.Group({texture:{value:e,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:a,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_trailer_smoke",this.particleGroup.mesh.frustumCulled=!1;var t=new r.AnimProps(this.smokeArt.art,this.shpFile),i=(this.smokeArt.art.getBool("Normalized")?2:1)*t.rate/this.spawnDelayFrames,t=this.particleMaxAge=this.shpFile.numImages/t.rate,t=this.particleEmitter=new SPE.Emitter({particleCount:n,maxAge:{value:t},activeMultiplier:i/(n/t),position:{value:this.pos},acceleration:{value:new THREE.Vector3},velocity:{value:new THREE.Vector3},opacity:{value:this.smokeArt.translucent?[1,0]:1-this.smokeArt.translucency},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}});this.particleGroup.addEmitter(t)}}get3DObject(){return this.particleGroup?.mesh}update(e){var t;this.particleEmitter.position.value=this.pos,this.lastUpdateMillis?(t=e-this.lastUpdateMillis,this.particleGroup.tick(t/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=e,this.particleGroup.tick(0)),this.lastUpdateMillis=e,this.finishRequested&&(this.finishRequested=!1,this.finishProcessed||(this.finishProcessed=!0,t=(e-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=t+this.particleMaxAge),this.particleEmitter.alive&&this.particleEmitter.disable()),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}disable(){this.particleEmitter.disable()}enable(){this.particleEmitter.enable()}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),o.textureCache=new Map}}}),System.register("engine/renderable/entity/plugin/TrailerSmokePlugin",["engine/renderable/fx/TrailerSmokeFx"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("TrailerSmokePlugin",i=class{constructor(e,t,i,r,s){this.gameObject=e,this.art=t,this.theater=i,this.imageFinder=r,this.gameSpeed=s}onCreate(e){this.initialPosition=this.gameObject.position.worldPosition.clone(),this.renderableManager=e}update(e){if(this.renderableManager&&!this.trailerFx&&!this.gameObject.position.worldPosition.equals(this.initialPosition)){if(this.gameObject.isAircraft()){let e;this.gameObject.rules.missileSpawn?e=this.art.getAnimation("V3TRAIL"):this.gameObject.isCrashing&&(e=this.art.getAnimation("SGRYSMK1")),e&&(i=this.imageFinder.findByObjectArt(e),r=this.theater.getPalette(e.paletteType),t=this.gameObject.art.spawnDelay,this.trailerFx=new a.TrailerSmokeFx(this.gameObject.position.worldPosition,t,e,i,r,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}var t,i,r,s;!this.gameObject.isProjectile()&&!this.gameObject.isDebris()||(s=this.gameObject.isProjectile()?this.gameObject.art.trailer:this.gameObject.rules.trailerAnim)&&(t=this.art.getAnimation(s),i=this.imageFinder.findByObjectArt(t),r=this.theater.getPalette(t.paletteType),s=this.gameObject.isProjectile()?this.gameObject.art.spawnDelay:this.gameObject.rules.trailerSeparation,this.trailerFx=new a.TrailerSmokeFx(this.gameObject.position.worldPosition,s,t,i,r,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}}onRemove(e){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}}),System.register("engine/renderable/fx/DamageSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],function(e,t){"use strict";var a,n,o,l,c;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){l=o=1e3,e("DamageSmokeFx",c=class c{constructor(e,t,i,r,s){this.gameObject=e,this.smokeArt=t,this.shpFile=i,this.palette=r,this.gameSpeed=s,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1}static clearTextureCache(){this.textureCache.forEach(e=>e.dispose()),this.textureCache.clear()}setContainer(e){this.container=e}create3DObject(){if(!this.particleGroup){let e=c.textureCache.get(this.shpFile);e||(s=n.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),e=new THREE.Texture(s),e.minFilter=THREE.NearestFilter,e.magFilter=THREE.NearestFilter,e.needsUpdate=!0,e.flipY=!1,c.textureCache.set(this.shpFile,e)),this.particleGroup=new SPE.Group({texture:{value:e,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:o,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_damage_smoke";this.particleGroup.mesh.frustumCulled=!1;var t=new a.AnimProps(this.smokeArt.art,this.shpFile),i=(this.smokeArt.art.getBool("Normalized")?2:1)*t.rate,r=i/10,s=this.particleMaxAge=2*this.shpFile.numImages/t.rate,t=9*i,i=.05*i,t=this.particleEmitter=new SPE.Emitter({particleCount:l,maxAge:{value:s},activeMultiplier:r/(l/s),position:{value:this.computeEmitterPosition()},acceleration:{value:new THREE.Vector3(0,-i,0),spread:new THREE.Vector3(2,0,2)},velocity:{value:new THREE.Vector3(0,t,0),spread:new THREE.Vector3(.1*t,0,.1*t)},opacity:{value:.5},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}});this.particleGroup.addEmitter(t)}}computeEmitterPosition(){return this.gameObject.position.worldPosition.clone().add(this.gameObject.rules.damageSmokeOffset)}get3DObject(){return this.particleGroup?.mesh}update(e){var t;this.particleEmitter.position.value=this.computeEmitterPosition(),this.lastUpdateMillis?(t=e-this.lastUpdateMillis,this.particleGroup.tick(t/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=e,this.particleGroup.tick(0)),this.lastUpdateMillis=e,this.finishRequested&&(this.finishRequested=!1,this.particleEmitter.alive&&(t=(e-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=t+this.particleMaxAge,this.particleEmitter.disable())),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),c.textureCache=new Map}}}),System.register("engine/renderable/entity/plugin/DamageSmokePlugin",["engine/renderable/fx/DamageSmokeFx"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("DamageSmokePlugin",i=class{constructor(e,t,i,r,s){this.gameObject=e,this.art=t,this.theater=i,this.imageFinder=r,this.gameSpeed=s}onCreate(e){this.renderableManager=e}update(e){var t,i,r;this.renderableManager&&((r=this.gameObject.healthTrait.health<50)===this.lastDamaged||this.gameObject.isDestroyed||((this.lastDamaged=r)?this.smokeFx||(this.smokeStartTime=e,(t=this.art.getAnimation("SGRYSMK1"))&&(i=this.imageFinder.findByObjectArt(t),r=this.theater.getPalette(t.paletteType),this.smokeFx=new s.DamageSmokeFx(this.gameObject,t,i,r,this.gameSpeed),this.renderableManager.addEffect(this.smokeFx))):this.disposeSmokeFx()),this.smokeFx&&this.smokeStartTime&&e-this.smokeStartTime>=8e4/this.gameSpeed.value&&this.disposeSmokeFx())}disposeSmokeFx(){this.smokeFx&&(this.smokeFx.finishAndRemove(),this.smokeFx=void 0)}onRemove(e){this.renderableManager=void 0,this.disposeSmokeFx()}dispose(){this.disposeSmokeFx()}})}}}),System.register("engine/renderable/entity/plugin/ShipWakeTrailPlugin",["game/Coords","engine/renderable/fx/TrailerSmokeFx","game/gameobject/unit/ZoneType","game/type/LandType","game/type/LocomotorType"],function(e,t){"use strict";var o,l,c,h,u,i;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("ShipWakeTrailPlugin",i=class{constructor(e,t,i,r,s,a){this.gameObject=e,this.rules=t,this.art=i,this.theater=r,this.imageFinder=s,this.gameSpeed=a,this.trailPos=new THREE.Vector3}onCreate(e){this.renderableManager=e}update(e){var t,i,r,s,a,n;this.renderableManager&&(this.trailPos.copy(this.gameObject.position.worldPosition),this.trailPos.y=o.Coords.tileHeightToWorld(this.gameObject.tile.z),this.gameObject.rules.locomotor===u.LocomotorType.Hover&&(r=this.rules.general.hover.height,this.trailPos.x-=r,this.trailPos.z-=r),t=(s=this.gameObject.moveTrait.isMoving())!==this.lastMoving,i=(a=this.gameObject.submergibleTrait?.isSubmerged())!==this.lastSubmerged,r=(n=this.gameObject.zone===c.ZoneType.Water&&this.gameObject.tile.landType===h.LandType.Water)!==this.lastInWater,(t||i||r)&&(this.lastMoving=s,this.lastSubmerged=a,this.lastInWater=n,s&&!a&&n?this.trailerFx?this.trailerFx.enable():(r=this.art.getAnimation(this.rules.audioVisual.wake))&&(s=this.imageFinder.findByObjectArt(r),a=this.theater.getPalette(r.paletteType),n=this.gameObject.art.spawnDelay,this.trailerFx=new l.TrailerSmokeFx(this.trailPos,n,r,s,a,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx)):this.trailerFx?.disable()))}onRemove(e){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}}),System.register("engine/renderable/entity/plugin/ObjectCloakPlugin",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ObjectCloakPlugin",i=class{constructor(e,t,i,r){this.gameObject=e,this.localPlayer=t,this.alliances=i,this.renderable=r,this.lastCanSeeThroughCloak=!1}onCreate(){}update(e){var t=!!this.gameObject.cloakableTrait?.isCloaked()&&!this.gameObject.isDestroyed,i=t!==this.lastCloaked,r=t&&(!this.localPlayer||this.alliances.haveSharedIntel(this.localPlayer,this.gameObject.owner)),s=r!==this.lastCanSeeThroughCloak;(i||s)&&(this.lastCloaked=t,this.lastCanSeeThroughCloak=r,this.renderable.get3DObject().visible=!t||r)}onRemove(){}dispose(){}})}}}),System.register("engine/renderable/entity/Debris",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","engine/animation/SimpleRunner","game/Coords","engine/renderable/ShadowRenderable"],function(e,t){"use strict";var i,c,h,u,d,g,s,p,r;t&&t.id;return{setters:[function(e){i=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){s=e},function(e){p=e}],execute:function(){e("Debris",r=class{constructor(e,t,i,r,s,a,n,o,l,c,h){this.gameObject=e,this.rules=t,this.imageFinder=i,this.voxels=r,this.palette=a,this.camera=n,this.lighting=o,this.gameSpeed=l,this.vxlBuilderFactory=c,this.useSpriteBatching=h,this.plugins=[],this.objectRules=e.rules,this.objectArt=e.art,this.label="debris_"+this.objectRules.name,this.init()}init(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new i.WithPosition}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach(e=>e.updateLighting?.()),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.vxlBuilder?.setExtraLight(this.vxlExtraLight),this.shpRenderable?.setExtraLight(this.shpExtraLight))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(t,i=0){this.plugins.forEach(e=>e.update(t));var e=this.gameObject.tile.z+this.gameObject.tileElevation;if((void 0===this.lastElevation||this.lastElevation!==e)&&(this.lastElevation=e,this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.shadowWrap&&(this.shadowWrap.position.y=-s.Coords.tileHeightToWorld(this.gameObject.tileElevation),this.shadowWrap.updateMatrix())),0<i){let e=this.gameObject.velocity.clone(),t=e.multiplyScalar(i);var r=t.add(this.gameObject.position.worldPosition);this.setPosition(r)}this.vxlBuilder?({rotationAxis:e,angularVelocity:r}=this.gameObject,this.vxlRotObj.rotateOnAxis(e,THREE.Math.degToRad(r)),this.vxlRotObj.updateMatrix()):(this.shpAnimRunner.tick(t),this.shpRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()),this.shpShadowRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()))}createObjects(e){let t=this.vxlRotObj=new THREE.Object3D;t.matrixAutoUpdate=!1,t.rotation.order="YXZ";var i=this.createMainObject();t.add(i),e.add(t)}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x,y:e.y+t.y}}createMainObject(){let s=new THREE.Object3D;if(s.matrixAutoUpdate=!1,this.rules.voxelAnimRules.has(this.gameObject.name)){var a=this.getVxlFileName(this.objectRules,this.objectArt),n=this.voxels.get(a);if(!n)throw new Error(`VXL missing for anim ${this.objectRules.name}. Vxl file ${a} not found. `);let e=this.vxlBuilderFactory.create(n,void 0,[this.palette],this.palette);this.vxlBuilder=e;var o=e.build();s.add(o)}else{let e=new h.MapSpriteTranslation(1,1);var{spriteOffset:l,anchorPointWorld:a}=e.compute(),n=this.computeSpriteAnchorOffset(l),o=this.imageFinder.findByObjectArt(this.objectArt);let t=this.shpRenderable=c.ShpRenderable.factory(o,this.palette,this.camera,n,!1);t.setBatched(this.useSpriteBatching),this.useSpriteBatching&&t.setBatchPalettes([this.palette]),t.create3DObject(),s.add(t.get3DObject());l=p.ShadowRenderable.getOrCreateShadowPalette();let i=this.shpShadowRenderable=c.ShpRenderable.factory(o,l,this.camera,n,!1);i.setBatched(this.useSpriteBatching),this.useSpriteBatching&&i.setBatchPalettes([l]),i.setOpacity(.5),i.create3DObject();let r=this.shadowWrap=new THREE.Object3D;r.matrixAutoUpdate=!1,r.add(i.get3DObject()),s.add(r),s.position.x=a.x,s.position.z=a.y,s.updateMatrix(),t.setFlat(this.objectArt.flat);o=new d.AnimProps(this.objectArt.art,o),o=new u.Animation(o,this.gameSpeed);this.shpAnimRunner=new g.SimpleRunner,this.shpAnimRunner.animation=o}return s}getVxlFileName(e,t){let i=t.imageName;return e.shareSource&&(i=e.shareSource,e.shareTurretData?i+="tur":e.shareBarrelData&&(i+="barl")),i.toLowerCase()+".vxl"}onCreate(t){this.plugins.forEach(e=>e.onCreate(t))}onRemove(t){var e;this.plugins.forEach(e=>e.onRemove(t)),this.gameObject.isDestroyed&&this.get3DObject()&&((e=this.gameObject.explodeAnim)&&t.createTransientAnim(e,e=>e.setPosition(this.withPosition.getPosition())))}dispose(){this.plugins.forEach(e=>e.dispose()),this.shpRenderable?.dispose(),this.shpShadowRenderable?.dispose(),this.vxlBuilder?.dispose()}})}}}),System.register("engine/renderable/entity/RenderableFactory",["engine/renderable/entity/Building","engine/renderable/entity/Vehicle","engine/renderable/entity/Terrain","engine/renderable/entity/Overlay","engine/renderable/entity/Smudge","engine/renderable/entity/building/AnimationType","engine/renderable/entity/Infantry","engine/renderable/entity/PipOverlay","engine/renderable/entity/Aircraft","engine/renderable/entity/TransientAnim","engine/renderable/entity/Projectile","engine/type/ObjectType","engine/renderable/entity/plugin/HarvesterPlugin","engine/renderable/entity/Anim","engine/renderable/entity/plugin/MoveSoundFxPlugin","engine/renderable/entity/plugin/VehicleDisguisePlugin","engine/renderable/entity/plugin/ChronoSparkleFxPlugin","engine/renderable/entity/plugin/TntFxPlugin","engine/renderable/entity/plugin/MindControlLinkPlugin","engine/renderable/entity/plugin/InfantryDisguisePlugin","engine/renderable/entity/building/PsychicDetectPlugin","engine/renderable/entity/plugin/TrailerSmokePlugin","engine/renderable/entity/plugin/DamageSmokePlugin","game/type/LocomotorType","engine/renderable/entity/plugin/ShipWakeTrailPlugin","engine/renderable/entity/plugin/ObjectCloakPlugin","engine/renderable/entity/Debris","engine/renderable/builder/ShpAggregator"],function(e,t){"use strict";var l,c,h,u,d,g,p,m,f,r,y,s,T,i,v,b,S,w,C,E,x,O,A,M,R,P,I,k,a;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){r=e},function(e){y=e},function(e){s=e},function(e){T=e},function(e){i=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e}],execute:function(){e("RenderableFactory",a=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C=!1,E=!1){this.localPlayer=e,this.unitSelection=t,this.alliances=i,this.rules=r,this.art=s,this.mapRenderable=a,this.imageFinder=n,this.palettes=o,this.voxels=l,this.voxelAnims=c,this.theater=h,this.camera=u,this.lighting=d,this.lightingDirector=g,this.debugWireframes=p,this.debugText=m,this.gameSpeed=f,this.worldSound=y,this.strings=T,this.flyerHelperOpt=v,this.hiddenObjectsOpt=b,this.vxlBuilderFactory=S,this.buildingImageDataCache=w,this.useSpriteBatching=C,this.useMeshInstancing=E,this.bridgeImageCache=new Map}createTransientAnim(e,t){var i=this.art.getObject(e,s.ObjectType.Animation);return new r.TransientAnim(e,i,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,t,this.worldSound)}createAnim(e){var t=this.art.getObject(e,s.ObjectType.Animation);return new i.Anim(e,t,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,void 0,this.worldSound)}create(e){let i=this.theater.getPalette(e.art.paletteType,e.art.customPaletteName),r=[];if((e.isAircraft()||e.isProjectile()||e.isDebris())&&r.push(new O.TrailerSmokePlugin(e,this.art,this.theater,this.imageFinder,this.gameSpeed)),e.isTechno()){i=i.clone();var s=this.unitSelection.getOrCreateSelectionModel(e),a=new m.PipOverlay(this.rules.general.paradrop,this.rules.audioVisual,e,this.localPlayer,this.alliances,s,this.imageFinder,this.palettes.get("palette.pal"),this.camera,this.strings,this.flyerHelperOpt,this.hiddenObjectsOpt,this.debugText,e=>this.createAnim(e),this.useSpriteBatching,this.useMeshInstancing);!e.isUnit()||(o=e.rules.moveSound)&&this.worldSound&&r.push(new v.MoveSoundFxPlugin(e,o,this.worldSound)),r.push(new S.ChronoSparkleFxPlugin(e,this.rules.audioVisual.chronoSparkle1)),e.mindControllerTrait&&r.push(new C.MindControlLinkPlugin(e,s,this.alliances,this.localPlayer));let t;if(e.isBuilding()){var n=this.theater.animPalette,o=this.theater.isoPalette;t=new l.Building(e,s,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,i,n,o,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching,new k.ShpAggregator,this.buildingImageDataCache,a,this.worldSound,g.AnimationType.BUILDUP),e.psychicDetectorTrait&&r.push(new x.PsychicDetectPlugin(e,e.psychicDetectorTrait,this.localPlayer,this.camera))}else if(e.isVehicle())t=new c.Vehicle(e,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,i,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,s,this.vxlBuilderFactory,this.useSpriteBatching,a,this.worldSound),e.rules.damageParticleSystems.length&&r.push(new A.DamageSmokePlugin(e,this.art,this.theater,this.imageFinder,this.gameSpeed)),e.rules.locomotor!==M.LocomotorType.Ship&&e.rules.locomotor!==M.LocomotorType.Hover||r.push(new R.ShipWakeTrailPlugin(e,this.rules,this.art,this.theater,this.imageFinder,this.gameSpeed)),e.harvesterTrait&&this.mapRenderable&&r.push(new T.HarvesterPlugin(e,e.harvesterTrait)),e.disguiseTrait&&r.push(new b.VehicleDisguisePlugin(e,e.disguiseTrait,this.localPlayer,this.alliances,t,this.art,this.imageFinder,this.theater,this.camera,this.lighting,this.gameSpeed,this.useSpriteBatching));else if(e.isInfantry())t=new p.Infantry(e,this.rules,this.art,this.imageFinder,this.theater,i,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,s,this.useSpriteBatching,this.useMeshInstancing,a,this.worldSound),e.disguiseTrait&&r.push(new E.InfantryDisguisePlugin(e,e.disguiseTrait,this.localPlayer,this.alliances,t,this.art,this.gameSpeed));else{if(!e.isAircraft())throw new Error("Unhandled game object type "+e.type);t=new f.Aircraft(e,this.rules,this.voxels,this.voxelAnims,i,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,s,this.vxlBuilderFactory,this.useSpriteBatching,a)}return e.tntChargeTrait&&r.push(new w.TntFxPlugin(e,e.tntChargeTrait,this.rules.combatDamage.ivanIconFlickerRate,t,this.imageFinder,this.art,this.alliances,this.localPlayer,this.worldSound,e=>this.createAnim(e))),r.push(new P.ObjectCloakPlugin(e,this.localPlayer,this.alliances,t)),r.forEach(e=>t.registerPlugin(e)),t}if(e.isTerrain())return new h.Terrain(e,this.mapRenderable?.terrainLayer,this.imageFinder,i,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.useSpriteBatching);if(e.isOverlay())return new u.Overlay(e,this.rules,this.art,this.imageFinder,i,this.camera,this.lighting,this.debugWireframes,this.bridgeImageCache,this.mapRenderable?.overlayLayer,this.useSpriteBatching);if(e.isProjectile()){let t=new y.Projectile(e,this.rules,this.imageFinder,this.voxels,this.voxelAnims,this.theater,i,this.palettes.get("palette.pal"),this.camera,this.gameSpeed,this.lighting,this.lightingDirector,this.vxlBuilderFactory,this.useSpriteBatching,this.useMeshInstancing);return r.forEach(e=>t.registerPlugin(e)),t}if(e.isSmudge())return new d.Smudge(e,this.imageFinder,i,this.camera,this.lighting,this.debugWireframes,this.mapRenderable?.smudgeLayer);if(e.isDebris()){let t=new I.Debris(e,this.rules,this.imageFinder,this.voxels,this.voxelAnims,i,this.camera,this.lighting,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching);return r.forEach(e=>t.registerPlugin(e)),t}throw new Error("Not implemented")}})}}}),System.register("engine/RenderableManager",["engine/gfx/OctreeContainer"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("RenderableManager",r=class{constructor(e,t,i,r){this.world=e,this.worldScene=t,this.camera=i,this.renderableFactory=r,this.renderablesByGameObject=new Map,this.renderablesById=new Map,this.positionListeners=new Map,this.onCameraUpdate=()=>{this.container.cullChildren()},this.onWorldObjectSpawned=t=>{var e=t.isTechno()&&t.rules.isLightpost;let i=this.createRenderable(t,e?this.worldScene:this.container);i.onCreate&&i.onCreate(this);e=({tileChanged:e})=>this.onObjectPositionChanged(t,e);this.positionListeners.set(t,e),t.position.onPositionChange.subscribe(e)},this.onWorldObjectRemoved=t=>{t.position.onPositionChange.unsubscribe(this.positionListeners.get(t)),this.positionListeners.delete(t);let i=this.renderablesByGameObject.get(t);if(i.onRemove){let e=i.onRemove(this);e?e.then(()=>this.removeAndDisposeRenderable(i,t)).catch(e=>console.error(e)):this.removeAndDisposeRenderable(i,t)}else this.removeAndDisposeRenderable(i,t)}}init(){let e=this.container=i.OctreeContainer.factory(this.camera);e.autoCull=!1,this.worldScene.add(e),this.worldScene.onCameraUpdate.subscribe(this.onCameraUpdate),this.world.getAllObjects().forEach(e=>this.onWorldObjectSpawned(e)),this.world.onObjectSpawned.subscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.subscribe(this.onWorldObjectRemoved)}getRenderableById(e){return this.renderablesById.get(e)}getRenderableByGameObject(e){return this.renderablesByGameObject.get(e)}getRenderableContainer(){return this.container}onObjectPositionChanged(e,t){let i=this.renderablesByGameObject.get(e);i.setPosition(e.position.worldPosition),e.isTechno()&&e.rules.isLightpost||this.container.updateChild(i)}removeAndDisposeRenderable(e,t){let i=t.isTechno()&&t.rules.isLightpost?this.worldScene:this.container;i.remove(e),e.dispose?.(),this.renderablesByGameObject.delete(t),this.renderablesById.delete(t.id)}createTransientAnim(e,t){var i=this.renderableFactory.createTransientAnim(e,this.container);return t?.(i),this.container.add(i),i}createAnim(e,t,i=!1){var r=this.renderableFactory.createAnim(e);return t?.(r),i||this.container.add(r),r}addEffect(e){e.setContainer(this.worldScene),this.worldScene.add(e)}dispose(){this.worldScene.remove(this.container),this.container=void 0,this.worldScene.onCameraUpdate.unsubscribe(this.onCameraUpdate),this.world.onObjectSpawned.unsubscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.unsubscribe(this.onWorldObjectRemoved),this.onWorldObjectRemoved=void 0,this.onWorldObjectSpawned=void 0,this.positionListeners.forEach((e,t)=>t.position.onPositionChange.unsubscribe(e)),this.positionListeners.clear(),this.renderablesById.forEach(e=>e.dispose?.())}createRenderable(e,t){let i=this.renderableFactory.create(e);return i.setPosition(e.position.worldPosition),t.add(i),this.renderablesByGameObject.set(e,i),this.renderablesById.set(e.id,i),i}updateLighting(){for(var e of this.renderablesById.values())e.updateLighting()}})}}}),System.register("engine/gfx/Renderable",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gfx/Scene",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gfx/RendererError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("RendererError",i)}}}),System.register("engine/gfx/Renderer",["stats.js","util/event","engine/gfx/RendererError"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("Renderer",a=class{constructor(e,t){this.isContextLost=!1,this._onFrame=new r.EventDispatcher,this.handleContextLost=e=>{e.preventDefault(),this.isContextLost=!0},this.handleContextRestored=()=>{var e=this.renderer.domElement;this.renderer.dispose(),this.renderer=this.createGlRenderer(e),this.isContextLost=!1},this.width=e,this.height=t,this.scenes=new Set}get onFrame(){return this._onFrame.asEvent()}getCanvas(){return this.renderer.domElement}getStats(){return this.stats}supportsInstancing(){if(!this.renderer)throw new Error("Renderer not yet initialized");return!!this.renderer.extensions.get("ANGLE_instanced_arrays")}initStats(e){this.stats||(this.stats=new i.default,this.stats.showPanel(0),this.stats.dom.style.top="auto",this.stats.dom.style.bottom="0px",this.stats.dom.classList.add("stats-layer"),e.appendChild(this.stats.dom))}destroyStats(){this.stats&&(this.stats.dom.parentNode.removeChild(this.stats.dom),this.stats=void 0)}init(e){let t=this.createGlRenderer();e.appendChild(t.domElement),t.domElement.addEventListener("contextmenu",e=>{e.preventDefault()}),t.domElement.addEventListener("mousedown",e=>{e.preventDefault()}),t.domElement.addEventListener("wheel",e=>{e.stopPropagation()},{passive:!0}),t.domElement.addEventListener("webglcontextlost",this.handleContextLost),t.domElement.addEventListener("webglcontextrestored",this.handleContextRestored),this.renderer=t}createGlRenderer(e){let t;try{t=new THREE.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance"})}catch(e){throw new s.RendererError("Failed to initialize WebGL renderer",{cause:e})}return t.setSize(this.width,this.height),t.autoClear=!1,t.autoClearDepth=!1,t.shadowMap.enabled=!0,t.localClippingEnabled=!0,t.toneMapping=THREE.NoToneMapping,t}setViewportSize(e,t){this.width=e,this.height=t,this.renderer&&this.renderer.setSize(e,t)}addScene(e){this.scenes.add(e),e.create3DObject()}removeScene(e){this.scenes.delete(e)}getScenes(){return[...this.scenes]}update(t,i){this.scenes.forEach(e=>{e.update(t,i)}),this._onFrame.dispatch(this,t)}render(){this.isContextLost||(this.renderer.clear(),this.scenes.forEach(e=>{this.renderer.clearDepth(),this.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height),this.renderer.render(e.scene,e.camera)}))}flush(){this.renderer.renderLists.dispose()}destroy(){this.renderer.domElement.remove(),this.renderer.domElement.removeEventListener("webglcontextlost",this.handleContextLost),this.renderer.domElement.removeEventListener("webglcontextrestored",this.handleContextRestored),this.renderer.dispose(),this.destroyStats()}})}}}),System.register("gui/LazyHtmlElement",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("LazyHtmlElement",i=class{constructor(e){this.children=new Set,this.rendered=!1,e&&this.setElement(e)}setElement(e){this.element=e}getElement(){return this.element}getChildren(){return[...this.children]}isRendered(){return this.rendered}add(...e){for(var t of e)this.children.has(t)||(this.children.add(t),this.rendered&&this.renderChild(t))}remove(...e){for(var t of e)this.children.has(t)&&(this.children.delete(t),this.rendered&&this.unrenderChild(t))}removeAll(){this.remove(...this.children)}render(){if(!this.element)throw new Error("An HTML element must be passed in the constructor or using the setter.");this.children.forEach(e=>this.renderChild(e)),this.rendered=!0}renderChild(e){e.render();var t=e.getElement();t&&this.getElement().appendChild(t)}unrenderChild(e){var t=e.getElement();t&&(e.unrender(),t.parentElement===this.getElement()&&this.getElement().removeChild(t))}unrender(){this.isRendered()&&(this.children.forEach(e=>this.unrenderChild(e)),this.rendered=!1)}})}}}),System.register("gui/HtmlContainer",["gui/LazyHtmlElement"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.LazyHtmlElement{constructor(){super(...arguments),this.visible=!0,this.left=0,this.top=0,this.width=0,this.height=0,this.relativeMode=!1,this.translateMode=!1}render(){var e;this.isRendered()||((e=this.getElement())||(e=document.createElement("div"),this.setElement(e)),this.updateMode(),this.updatePosition(),this.updateVisibility(),this.updateSize()),super.render()}setRelativeMode(e){this.relativeMode=e,this.updateMode()}setTranslateMode(e){this.translateMode=e,this.updatePosition()}setPosition(e,t){this.left=e,this.top=t,this.updatePosition()}setSize(e,t){this.width=e,this.height=t,this.updateSize()}getSize(){return{width:this.width,height:this.height}}setVisible(e){e!==this.visible&&(this.visible=e,this.updateVisibility())}updateMode(){let e=this.getElement();e&&(this.relativeMode?e.style.position="relative":(e.style.overflow="visible",e.style.position="absolute"))}updatePosition(){let e=this.getElement();e&&(this.translateMode?(e.style.top=e.style.left="0",e.style.transform=`translate(${this.left}px, ${this.top}px)`):(e.style.left=this.left+"px",e.style.top=this.top+"px",e.style.transform=""))}updateSize(){let e=this.getElement();e&&(e.style.width="number"==typeof this.width?this.width+"px":this.width,e.style.height="number"==typeof this.height?this.height+"px":this.height)}hide(){this.setVisible(!1)}show(){this.setVisible(!0)}updateVisibility(){let e=this.getElement();e&&(e.style.display=this.visible?"block":"none")}},e("HtmlContainer",r)}}}),System.register("util/mouse",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("util/dom",[],function(e,t){"use strict";t&&t.id;return e("getOffset",function(e){let t=0,i=0;for(;t+=e.offsetTop||0,i+=e.offsetLeft||0,e=e.offsetParent;);return{top:t,left:i}}),e("contains",function(e,t){do{if(t===e)return!0}while(t=t.parentElement);return!1}),{setters:[],execute:function(){}}}),System.register("gui/CanvasMetrics",["util/disposable/CompositeDisposable","util/dom"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("CanvasMetrics",s=class{constructor(e,t){this.canvas=e,this.window=t,this.x=0,this.y=0,this.width=0,this.height=0,this.disposables=new i.CompositeDisposable,this.updateCanvasBoxMetrics=()=>{var e=r.getOffset(this.canvas);this.x=e.left,this.y=e.top,this.width=this.canvas.width,this.height=this.canvas.height}}init(){this.updateCanvasBoxMetrics(),this.window.addEventListener("resize",this.updateCanvasBoxMetrics),this.disposables.add(()=>this.window.removeEventListener("resize",this.updateCanvasBoxMetrics))}notifyViewportChange(){this.updateCanvasBoxMetrics()}dispose(){this.disposables.dispose()}})}}}),System.register("gui/PointerEvents",["util/disposable/CompositeDisposable","util/array","util/math"],function(e,t){"use strict";var a,l,i,o,r;t&&t.id;return{setters:[function(e){a=e},function(e){l=e},function(e){i=e}],execute:function(){o=(e,t)=>!!e.visible&&(e===t||!!e.parent&&o(e.parent,t)),e("PointerEvents",r=class{constructor(e,t,i,r){this.renderer=e,this.lockModePointer=t,this.document=i,this.canvasMetrics=r,this.disposables=new a.CompositeDisposable,this.canvasContext={handlers:new Map},this.objectContexts=new Map,this.intersectionsEnabled=!0,this.clickPaths=new Map,this.touchFingers=0,this.onDblClick=e=>{0===e.button&&this.onMouseEvent("dblclick",e)},this.onMouseMove=i=>{let r=this.getPointerPosition(i);if(this.intersectionsEnabled){let e=this.currentHoverPath?[...this.currentHoverPath]:void 0;var s=e?.[0],a=this.findObjectUnderPointer(r);let t=a?.object;if(this.currentHoverPath=void 0,t&&(this.currentHoverPath=[t],t.traverseAncestors(e=>{this.currentHoverPath.push(e)})),!l.equals(this.currentHoverPath??[],e??[])){if(e)for(var n of e)this.currentHoverPath&&this.currentHoverPath.includes(n)||this.notify("mouseleave",n,r,i,void 0,!1);if(this.currentHoverPath)for(var o of this.currentHoverPath)e&&e.includes(o)||this.notify("mouseenter",o,r,i,a,!1);s&&this.notify("mouseout",s,r,i),t&&this.notify("mouseover",t,r,i,a)}t?this.notify("mousemove",t,r,i,a):this.renderer.getScenes().forEach(e=>this.notify("mousemove",e.get3DObject(),r,i))}this.notify("mousemove","canvas",r,i)},this.onMouseDown=e=>{this.onMouseEvent("mousedown",e)},this.onMouseUp=e=>{this.onMouseEvent("mouseup",e)},this.onMouseWheel=e=>{this.onMouseEvent("wheel",e)},this.onTouchMove=e=>{if(e.preventDefault(),this.initialTouchEvent?.touches){let t=this.initialTouchEvent.touches[0];var i=[...e.changedTouches].find(e=>t.identifier===e.identifier);i&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0),i=this.fakeMouseEventFromTouch(i,e),this.onMouseMove(i))}},this.onTouchStart=t=>{t.preventDefault();let i=t.touches;var e,r;1<i.length?0<this.touchFingers||2===i.length&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.touchFingers=2,this.initialTouchEvent||(this.initialTouchEvent=t),e=this.initialTouchEvent.touches[0],r=this.fakeMouseEventFromTouch(e,t,2),this.onMouseEvent("mousedown",r)):(e=()=>{this.touchFingers=1;var e=this.fakeMouseEventFromTouch(i[0],t);this.onMouseEvent("mousedown",e)},r=setTimeout(e,50),this.touchStartBuffer={cb:e,timeoutId:r},this.initialTouchEvent=t)},this.onTouchEnd=i=>{if(i.preventDefault(),this.initialTouchEvent?.touches){let t=this.initialTouchEvent.touches[0];var r=[...i.changedTouches].find(e=>t.identifier===e.identifier);if(r){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0);var s=2===this.touchFingers?2:0;let e=this.fakeMouseEventFromTouch(r,i,s);e.touchDuration=i.timeStamp-this.initialTouchEvent.timeStamp,this.touchFingers=0,this.initialTouchEvent=void 0,this.onMouseEvent("mouseup",e)}}};let s=e.getCanvas();s.addEventListener("dblclick",this.onDblClick,!1),s.addEventListener("mousemove",this.onMouseMove,!1),s.addEventListener("mousedown",this.onMouseDown,!1),s.addEventListener("mouseup",this.onMouseUp,!1),s.addEventListener("touchmove",this.onTouchMove,!1),s.addEventListener("touchstart",this.onTouchStart,!1),s.addEventListener("touchend",this.onTouchEnd,!1),s.addEventListener("wheel",this.onMouseWheel,{passive:!0}),this.disposables.add(()=>{s.removeEventListener("dblclick",this.onDblClick,!1),s.removeEventListener("mousemove",this.onMouseMove,!1),s.removeEventListener("mousedown",this.onMouseDown,!1),s.removeEventListener("mouseup",this.onMouseUp,!1),s.removeEventListener("touchmove",this.onTouchMove,!1),s.removeEventListener("touchstart",this.onTouchStart,!1),s.removeEventListener("touchend",this.onTouchEnd,!1),s.removeEventListener("wheel",this.onMouseWheel,!1)})}addEventListener(e,t,i,r=!1){let s="canvas"===e?this.canvasContext:this.getOrCreateObjectContext(e),a=s.handlers.get(t);return a||(a=[],s.handlers.set(t,a)),a.push({callback:i,useCapture:r}),()=>this.removeEventListener(e,t,i,r)}removeEventListener(t,i,r,s=!1){let a="canvas"===t?this.canvasContext:this.objectContexts.get(t);if(a&&a.handlers.has(i)){let e=a.handlers.get(i);e=e.filter(e=>!(e.callback===r&&e.useCapture===s)),e.length?a.handlers.set(i,e):a.handlers.delete(i),a.handlers.size||"canvas"===t||this.objectContexts.delete(t)}}getOrCreateObjectContext(e){if(!e)throw new Error("Undefined Object3D instance.");let t=this.objectContexts.get(e);return t||(t={handlers:new Map},this.objectContexts.set(e,t)),t}fakeMouseEventFromTouch(e,t,i=0){var r=this.computeTouchPosition(e);return{offsetX:r.x,offsetY:r.y,button:i,isTouch:!0,detail:1,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp}}computeTouchPosition(e){let t={x:e.pageX-this.canvasMetrics.x,y:e.pageY-this.canvasMetrics.y};return t.x=i.clamp(t.x,0,this.canvasMetrics.width-1),t.y=i.clamp(t.y,0,this.canvasMetrics.height-1),t}onMouseEvent(t,r){let s=this.getPointerPosition(r);var a=this.findObjectUnderPointer(s);if(a?this.notify(t,a.object,s,r,a):this.renderer.getScenes().forEach(e=>this.notify(t,e.get3DObject(),s,r)),this.notify(t,"canvas",s,r),"mousedown"===t||"mouseup"===t){let e=a?.object,i=[];if(e&&(i=[e],e.traverseAncestors(e=>{i.push(e)})),"mousedown"===t)this.clickPaths.set(r.button,i);else{let e=this.clickPaths.get(r.button);this.clickPaths.delete(r.button);let t=!1;for(var n of i)if(e?.includes(n)){this.notify("click",n,s,r,a),t=!0;break}t||this.renderer.getScenes().forEach(e=>this.notify("click",e.get3DObject(),s,r)),this.notify("click","canvas",s,r)}}}getPointerPosition(e){return this.document.pointerLockElement?this.lockModePointer:{x:e.offsetX,y:e.offsetY}}findObjectUnderPointer(t){let r=this.renderer.getScenes(),s=this.groupObjectsByScene();for(let n=r.length-1;0<=n;n--){let e=new THREE.Raycaster;var a=this.normalizePointer(t,r[n].viewport);e.setFromCamera(a,r[n].camera);a=s.get(r[n].scene).filter(e=>o(e,r[n].get3DObject()));let i=e.intersectObjects(a,!0);if(i.length){if(1===i.length)return i[0];let t=new Set(i.map(e=>e.object));return i.forEach(e=>{t.has(e.object)&&e.object.traverseAncestors(e=>{t.has(e)&&t.delete(e)})}),i.filter(e=>t.has(e.object))[0]}}}normalizePointer(e,t){return{x:(e.x-t.x)/t.width*2-1,y:2*-((e.y-t.y)/t.height)+1}}groupObjectsByScene(){let i=new Map;return this.renderer.getScenes().forEach(e=>i.set(e.get3DObject(),[])),[...this.objectContexts.keys()].forEach(t=>{if("Scene"!==t.type){let e=t;for(;e.parent;)e=e.parent;"Scene"===e.type&&i.get(e).push(t)}}),i}notify(i,r,s,a,n,o=!0){let e="canvas"===r?this.canvasContext:this.objectContexts.get(r),t=e?.handlers.get(i);t&&t.length||"canvas"!==r&&r.parent&&o&&this.notify(i,r.parent,s,a,n),t?.forEach(e=>{let t=!0;e.callback({type:i,target:"canvas"!==r?r:void 0,pointer:{...s},intersection:n,button:a.button,isTouch:!!a.isTouch,touchDuration:a.touchDuration,clicks:a.detail,altKey:a.altKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey,shiftKey:a.shiftKey,timeStamp:a.timeStamp,wheelDeltaY:a.deltaY??0,stopPropagation:()=>{t=!1}}),t&&"canvas"!==r&&!e.useCapture&&r.parent&&o&&this.notify(i,r.parent,s,a,n)})}dispose(){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.disposables.dispose()}})}}}),System.register("gui/UiObject",["engine/renderable/WithPosition","engine/gfx/RenderableContainer","util/event","engine/renderable/WithVisibility"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("UiObject",n=class n{constructor(e,t){this.rendered=!1,this.eventHandlers=[],this._onFrame=new s.EventDispatcher,this._onDispose=new s.EventDispatcher,e&&this.set3DObject(e),t&&this.setHtmlContainer(t),this.withPosition=new i.WithPosition,this.withVisibility=new a.WithVisibility,this.container=new r.RenderableContainer}get onFrame(){return this._onFrame.asEvent()}get onDispose(){return this._onDispose.asEvent()}static zIndexToWorld(e){return-e}get3DObject(){return this.target}set3DObject(e){(this.target=e).matrixAutoUpdate=!1}getRenderableContainer(){return this.container}getHtmlContainer(){return this.htmlContainer}setHtmlContainer(e){this.htmlContainer=e}setPosition(e,t){var i=this.withPosition.getPosition().z||0;this.withPosition.setPosition(e,t,i),this.htmlContainer?.setPosition(e,t)}getPosition(){var{x:e,y:t}=this.withPosition.getPosition();return{x:e,y:t}}setZIndex(e){var t=this.withPosition.getPosition();this.withPosition.setPosition(t.x,t.y,n.zIndexToWorld(e))}setVisible(e){this.withVisibility.setVisible(e),this.htmlContainer?.setVisible(e)}isVisible(){return this.withVisibility.isVisible()}setTooltip(e){this.tooltip=e,this.updateTooltip()}updateTooltip(){let e=this.get3DObject();e&&(e.userData.tooltip=this.tooltip)}setPointerEvents(e){if(this.pointerEvents)throw new Error("A PointerEvents instance is already set");this.pointerEvents=e}addEventListener(e,t){return this.eventHandlers.push({eventName:e,handler:t}),this.rendered&&this.setupEventListener(e,t),()=>this.removeEventListener(e,t)}removeEventListener(t,i){var e=this.eventHandlers.findIndex(e=>t===e.eventName&&i===e.handler);-1!==e&&(this.eventHandlers[e].disposer?.(),this.eventHandlers.splice(e,1))}setupEventListener(t,i){if(!this.pointerEvents)throw new Error("A PointerEvents object must be provided prior to setting up an event listener");var e=this.pointerEvents.addEventListener(this.get3DObject(),t,i);let r=this.eventHandlers.find(e=>t===e.eventName&&i===e.handler);r&&(r.disposer=e)}create3DObject(){if(!this.get3DObject())throw new Error("Expecting a THREE.Object3D to have been set by now");this.rendered||(this.rendered=!0,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.withVisibility.applyTo(this),this.htmlContainer?.render(),this.htmlContainer?.setPosition(this.withPosition.getPosition().x,this.withPosition.getPosition().y),this.htmlContainer?.setVisible(this.withVisibility.isVisible()),this.container.set3DObject(this.get3DObject()),this.container.create3DObject(),this.updateTooltip(),this.eventHandlers.forEach(e=>this.setupEventListener(e.eventName,e.handler)))}update(e){this.container.update(e),this._onFrame.dispatch(this,e)}add(...e){this.container.add(...e),e.map(e=>e.getHtmlContainer()).forEach(e=>{if(e){if(!this.htmlContainer)throw new Error("Can't add an UiObject that defines an HTMLContainer to a parent that doesn't provide an HTML container.");this.htmlContainer.add(e)}})}remove(...e){e.map(e=>e.getHtmlContainer()).forEach(e=>e&&this.htmlContainer?.remove(e)),this.container.remove(...e)}removeAll(){this.container.removeAll()}destroy(){this.container.getChildren().forEach(e=>e.destroy?.()),this.htmlContainer?.unrender(),this.eventHandlers.forEach(e=>e.disposer?.()),this.eventHandlers.length=0,this._onFrame=new s.EventDispatcher,this._onDispose.dispatch(),this._onDispose=new s.EventDispatcher}})}}}),System.register("gui/UiScene",["gui/UiObject","gui/HtmlContainer","engine/gfx/batch/MeshBatchManager"],function(e,t){"use strict";var i,s,r,a;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e}],execute:function(){a=class a extends i.UiObject{constructor(e,t,i,r){super(e,r),this.scene=e,this.camera=t,this.viewport=i}static factory(e){let t=new THREE.Scene;t.matrixAutoUpdate=!1;var i=a.createCamera(e),r=new s.HtmlContainer;return new a(t,i,e,r)}static createCamera(e){var t=e.height/2,i=e.width/e.height;let r=new THREE.OrthographicCamera(-t*i,t*i,t,-t,-1e3,1e3);return r.rotation.x=Math.PI,r.position.x=-e.x+e.width/2,r.position.y=-e.y+e.height/2,r.position.z=-1e3,r}setCamera(e){this.camera=e}setViewport(e){this.viewport=e}create3DObject(){var e;super.create3DObject(),this.meshBatchManager||(e=this.meshBatchManager=new r.MeshBatchManager(this.getRenderableContainer()),this.getRenderableContainer().add(e),this.scene.autoUpdate=!1)}update(e){super.update(e),this.meshBatchManager&&(this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes())}get menuViewport(){let e=800,t=600;return{x:Math.max(0,(this.viewport.width-e)/2),y:Math.max(0,(this.viewport.height-t)/2),width:e,height:t}}destroy(){super.destroy(),this.meshBatchManager?.dispose()}},e("UiScene",a)}}}),System.register("network/PlayerRankType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.None=0]="None",e[e.Private=1]="Private",e[e.Corporal=2]="Corporal",e[e.Sergeant=3]="Sergeant",e[e.Lieutenant=4]="Lieutenant",e[e.Major=5]="Major",e[e.Colonel=6]="Colonel",e[e.BrigGeneral=7]="BrigGeneral",e[e.General=8]="General",e[e.FiveStarGeneral=9]="FiveStarGeneral",e[e.CommanderInChief=10]="CommanderInChief",t("PlayerRankType",i)}}}),System.register("network/PlayerProfile",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/chat/SystemMessage",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gservConfig",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("API_VERSION",1),e("RECIPIENT_ALL","#all"),e("RECIPIENT_TEAM","#team"),e("TURN_TIMEOUT_MILLIS",3e4),e("LAG_STATE_THRESH_MILLIS",1e3),e("CON_INFO_THRESH_MILLIS",2e3),e("MAX_MAP_TRANSFER_BYTES",2097152)}}}),System.register("gui/chat/ChatMessageFormat",["react","network/chat/ChatMessage","network/gservConfig"],function(e,t){"use strict";var l,c,h,i;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("ChatMessageFormat",i=class{constructor(e,t,i){this.strings=e,this.localUsername=t,this.userColors=i}formatPrefixPlain(e){let t;if(e.to.type===c.ChatRecipientType.Channel)t=e.to.name===h.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",e.from):this.strings.get("TS:ChatFrom",e.from);else if(e.to.type===c.ChatRecipientType.Page)t=this.strings.get("TS:PageFrom",e.from);else{if(e.to.type!==c.ChatRecipientType.Whisper)throw new Error("Unknown message type "+e.to.type);t=e.from===this.localUsername?this.strings.get("TS:To",e.to.name):this.strings.get("TXT_FROM",e.from)}return t}formatPrefixHtml(e,t){let i=e.to.type===c.ChatRecipientType.Whisper&&e.from===this.localUsername?e.to.name:e.from,r=i;var s,a="{user}";e.to.type!==c.ChatRecipientType.Page&&(void 0!==(s=this.userColors?.get(e.from))&&(r=l.default.createElement("span",{style:{color:s}},r)),t&&(o=this.strings.get("TS:ChatUserLink",a).split(a),r=l.default.createElement("span",{className:"user-link",onClick:()=>t(i)},o[0],r,o[1])));let n;if(e.to.type===c.ChatRecipientType.Channel)n=e.to.name===h.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",a):this.strings.get("TS:ChatFrom",a);else if(e.to.type===c.ChatRecipientType.Page)n=this.strings.get("TS:PageFrom",a);else{if(e.to.type!==c.ChatRecipientType.Whisper)throw new Error("Unknown message type "+e.to.type);n=e.from===this.localUsername?this.strings.get("TS:To",a):this.strings.get("TXT_FROM",a)}var[o,a]=n.split(a);return l.default.createElement(l.default.Fragment,null,o,r,a)}})}}}),System.register("gui/chat/ChatHistory",["network/chat/ChatMessage","network/gservConfig","util/BoxedVar","util/event"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("ChatHistory",n=class{constructor(){this.lastWhisperFrom=new s.BoxedVar(void 0),this.lastWhisperTo=new s.BoxedVar(void 0),this.lastComposeTarget=new s.BoxedVar({type:i.ChatRecipientType.Channel,name:r.RECIPIENT_ALL}),this.messages=[],this._onNewMessage=new a.EventDispatcher}get onNewMessage(){return this._onNewMessage.asEvent()}addChatMessage(e){this.messages.push(e),this._onNewMessage.dispatch(this,e)}getAll(){return this.messages}})}}}),System.register("gui/component/ChatInput",["react","network/chat/ChatMessage","network/gservConfig"],function(e,t){"use strict";var k,B,j,N,i;t&&t.id;return{setters:[function(e){k=e},function(e){B=e},function(e){j=e}],execute:function(){N="",i=({chatHistory:s,channels:r,strings:t,className:e,tooltip:i,forceColor:a,noCycleHint:n,submitEmpty:o,onKeyDown:l,onKeyUp:c,onBlur:h,onCancel:u,onSubmit:d},g)=>{const p=k.useRef(null),[m,f]=k.useState(()=>A()),[y,T]=k.useState(()=>{var e=s?.lastComposeTarget.value;return M(e)?e:{type:B.ChatRecipientType.Channel,name:r[0]??N}}),[v,b]=k.useState(),[S,w]=k.useState(),[C,E]=k.useState(!1),[x,O]=k.useState(!1);function A(){const e=(r.length?r:[N]).map(e=>({type:B.ChatRecipientType.Channel,name:e}));var t,i;return s&&(t=s.lastWhisperFrom.value,i=s.lastWhisperTo.value,t&&e.push({type:B.ChatRecipientType.Whisper,name:t}),i&&i!==t&&e.push({type:B.ChatRecipientType.Whisper,name:i})),e}function M(e){return e&&(e.type!==B.ChatRecipientType.Channel||r.includes(e.name))}function R(e){s&&(s.lastComposeTarget.value=e),T(e)}k.useEffect(()=>{p.current?.focus()},[]),k.useEffect(()=>{if(s){let e=e=>{y!==e&&M(e)&&(T(e),p.current?.focus())},t=()=>{f(A())};return s.lastComposeTarget.onChange.subscribe(e),s.lastWhisperFrom.onChange.subscribe(t),s.lastWhisperTo.onChange.subscribe(t),()=>{s.lastComposeTarget.onChange.unsubscribe(e),s.lastWhisperFrom.onChange.unsubscribe(t),s.lastWhisperTo.onChange.unsubscribe(t)}}},[y,s,r]),k.useImperativeHandle(g,()=>({send(){let e=p.current;var t;!e||(t=e.value).length&&(d({recipient:y,value:t}),e.value="",e.focus(),w(t))}}),[y]);var P=function(e){if(e.type===B.ChatRecipientType.Channel)return e.name===j.RECIPIENT_TEAM?t.get("TS:ToAllies"):e.name===j.RECIPIENT_ALL?t.get("TS:ToAll"):"";if(e.type===B.ChatRecipientType.Whisper)return t.get("TS:To",e.name);throw new Error(`Recipient type ${e.type} not implemented`)}(y);let I=!n&&C&&!x&&(1<m.length||y.type===B.ChatRecipientType.Whisper)?t.get("TS:ChatCycleHint","Tab"):void 0;return k.default.createElement("div",{className:e},P&&k.default.createElement("label",{style:{color:a}},P),k.default.createElement("input",{type:"text",autoComplete:"off",spellCheck:!1,ref:p,maxLength:128,"data-r-tooltip":i,placeholder:I,style:{color:a},onKeyDown:e=>{"Tab"===e.key&&e.preventDefault(),e.repeat||b(e.key),l?.(e)},onKeyUp:e=>{let t=e.target;var i;"Enter"===e.key?"Enter"===v&&(((i=t.value).length||o)&&d({recipient:y,value:i}),i.length&&(t.value="",w(i))):"Tab"===e.key?"Tab"===v&&function(t){if(1!==m.length||m[0].name!==t.name){let e=m.findIndex(e=>e.type===t.type&&e.name===t.name);e=-1===e?0:(e+1)%m.length;var i=m[e];O(!0),R(i)}}(y):"ArrowUp"===e.key&&S?t.value=S:"Escape"===e.key&&"Process"!==v&&(u?.(0===t.value.length),t.value=""),c?.(e)},onChange:e=>{let t=e.target.value;var i=t.match(/^\/(?:page|whisper|w|msg|m) ([A-Za-z0-9-_']+) /i);i&&(R({type:B.ChatRecipientType.Whisper,name:i[1]}),e.target.value="");var r=t.match(/^\/r(eply)? /i);r&&(void 0!==s?.lastWhisperFrom.value&&R({type:B.ChatRecipientType.Whisper,name:s.lastWhisperFrom.value}),e.target.value=""),i||r||void 0===I||O(!0)},onFocus:()=>{E(!0)},onBlur:()=>{E(!1),h?.()}}))},e("ChatInput",k.forwardRef(i))}}}),System.register("gui/component/Chat",["react","classnames","network/chat/ChatMessage","gui/chat/ChatMessageFormat","gui/component/ChatInput"],function(e,t){"use strict";var a,s,n,o,l,c,i;t&&t.id;return{setters:[function(e){a=e},function(e){s=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=(new Map).set(n.ChatRecipientType.Channel,"type-channel").set(n.ChatRecipientType.Page,"type-page").set(n.ChatRecipientType.Whisper,"type-whisper"),i=class extends a.default.Component{constructor(){super(...arguments),this.prevMessageCount=0}render(){let{messages:e,tooltips:t,strings:i,chatHistory:r,channels:s}=this.props;return a.default.createElement("div",{className:"chat-wrapper"},a.default.createElement("div",{className:"messages",ref:e=>this.messageList=e,"data-r-tooltip":t?.output},e.map((e,t)=>this.renderMessage(e,t))),a.default.createElement("div",{className:"new-message-wrapper"},a.default.createElement(l.ChatInput,{ref:e=>this.textBox=e,chatHistory:r,channels:s,className:"new-message",tooltip:t?.input,strings:i,onSubmit:this.props.onSendMessage,onCancel:this.props.onCancelMessage}),a.default.createElement("button",{className:"icon-button send-message-button","data-r-tooltip":t?.button,onClick:()=>this.textBox.send()})))}componentDidUpdate(e,t){var i,r;this.props.messages[0]===this.prevOldestMessage&&this.props.messages.length===this.prevMessageCount||(this.prevMessageCount=this.props.messages.length,this.prevOldestMessage=this.props.messages[0],i=this.messageList.scrollHeight,r=this.messageList.clientHeight,i!==this.prevScrollHeight&&(!this.prevScrollHeight||Math.abs(this.messageList.scrollTop-(this.prevScrollHeight-r))<=1)&&(this.messageList.scrollTop=i-r),this.prevScrollHeight=i)}renderMessage(t,e){let i=["message"],r;return void 0!==t.from&&(r=new o.ChatMessageFormat(this.props.strings,this.props.localUsername,this.props.userColors).formatPrefixHtml(t,e=>{this.props.chatHistory&&t.to&&t.to.type!==n.ChatRecipientType.Page&&(this.props.chatHistory.lastComposeTarget.value={type:n.ChatRecipientType.Whisper,name:e})}),i.push(c.get(t.to.type),{"operator-message":t.operator})),a.default.createElement("div",{key:e,className:s.default(i)},r?a.default.createElement(a.default.Fragment,null,a.default.createElement("span",null,r)," ",t.text):t.text)}},e("Chat",i)}}});System.register("gui/screen/mainMenu/lobby/component/viewmodel/lobby",[],function(i,e){"use strict";var r,s,a,n;e&&e.id;return{setters:[],execute:function(){var e,t;(e=r=r||{})[e.Singleplayer=0]="Singleplayer",e[e.MultiplayerHost=1]="MultiplayerHost",e[e.MultiplayerGuest=2]="MultiplayerGuest",i("LobbyType",r),(t=s=s||{})[t.Player=1]="Player",t[t.Ai=2]="Ai",t[t.Observer=3]="Observer",i("SlotType",s),(t=a=a||{})[t.Open=1]="Open",t[t.Closed=2]="Closed",t[t.Occupied=3]="Occupied",i("SlotOccupation",a),(t=n=n||{})[t.NotReady=1]="NotReady",t[t.Ready=2]="Ready",t[t.Host=3]="Host",i("PlayerStatus",n)}}}),System.register("gui/UiObjectSprite",["engine/renderable/builder/ShpBuilder","gui/UiObject"],function(e,t){"use strict";var s,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){r=class extends i.UiObject{constructor(e){super(),this.builder=e}static fromShpFile(e,t,i){let r=new s.ShpBuilder(e,t,i);return r.setBatched(!0),r.setBatchPalettes([t]),r.setOffset({x:Math.floor(e.width/2),y:Math.floor(e.height/2)}),new this(r)}setAnimationRunner(e){this.animationRunner=e}getAnimationRunner(){return this.animationRunner}update(e){super.update(e),this.animationRunner&&(this.animationRunner.tick(e),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.builder.getSize()}setFrame(e){this.builder.setFrame(e)}getFrame(){return this.builder.getFrame()}getFrameCount(){return this.builder.frameCount}setTransparent(e){this.get3DObject()?this.builder.setForceTransparent(e):this.initialTransparency=e}setOpacity(e){this.get3DObject()?this.builder.setOpacity(e):this.initialOpacity=e}setLightMult(e){this.get3DObject()?this.builder.setExtraLight((new THREE.Vector3).addScalar(-1+e)):this.initialLightMult=e}create3DObject(){this.set3DObject(this.builder.build()),super.create3DObject(),void 0!==this.initialTransparency&&this.builder.setForceTransparent(this.initialTransparency),void 0!==this.initialOpacity&&this.builder.setOpacity(this.initialOpacity),void 0!==this.initialLightMult&&this.builder.setExtraLight((new THREE.Vector3).addScalar(this.initialLightMult))}destroy(){super.destroy(),this.builder.dispose()}},e("UiObjectSprite",r)}}}),System.register("gui/jsx/UiComponent",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("UiComponent",i=class{constructor(e){this.props=e,this.uiObject=this.createUiObject(e)}getUiObject(){return this.uiObject}})}}}),System.register("gui/ShpSpriteBatch",["gui/UiObject","gui/HtmlContainer","data/ShpFile","engine/renderable/builder/BatchShpBuilder"],function(e,t){"use strict";var c,s,a,h,i;t&&t.id;return{setters:[function(e){c=e},function(e){s=e},function(e){a=e},function(e){h=e}],execute:function(){i=class extends c.UiObject{constructor(e,t,i,r){super(new THREE.Object3D,new s.HtmlContainer),this.spriteProps=e,this.getShpFile=t,this.getPalette=i,this.camera=r,this.textureCache=new Map,this.batchShpBuilders=[]}create3DObject(){super.create3DObject();var e=this.createAggregatedShpFile();this.createObjects(this.get3DObject(),e)}createAggregatedShpFile(){let t=new a.ShpFile;t.filename="agg_unnamed_spritebatch.shp";let i=new Map,r=0;for(var s of this.spriteProps){let e="string"==typeof s.image?this.getShpFile(s.image):s.image;s=e.getImage(s.frame??0);i.has(s)||(t.addImage(s),i.set(s,r),r++)}return{file:t,imageIndexes:i}}createObjects(e,r){let t=new Map;for(var i of this.spriteProps){var s=("string"==typeof i.palette?this.getPalette(i.palette):i.palette).hash;t.set(s,(t.get(s)??[]).concat(i))}for(var a of t.values()){var n,o="string"==typeof a[0].palette?this.getPalette(a[0].palette):a[0].palette;let i=[];for(n of a){let e="string"==typeof n.image?this.getShpFile(n.image):n.image;var l=r.imageIndexes.get(e.getImage(n.frame??0));if(void 0===l)throw new Error("Missing frame in aggregated sprite shp file");l={position:new THREE.Vector3(n.x??0,n.y??0,c.UiObject.zIndexToWorld(n.zIndex??0)),shpFile:e,depth:!1,flat:!1,frameNo:l,offset:{x:e.width/2,y:e.height/2}};i.push(l)}if(i.length){let t=new h.BatchShpBuilder(r.file,o,this.camera,this.textureCache,void 0,void 0,i.length);i.forEach(e=>t.add(e)),this.batchShpBuilders.push(t),e.add(t.build())}}}destroy(){super.destroy(),this.batchShpBuilders.forEach(e=>e.dispose()),[...this.textureCache.values()].forEach(e=>e.dispose()),this.textureCache.clear()}},e("ShpSpriteBatch",i)}}}),System.register("gui/jsx/jsx",[],function(e,t){"use strict";t&&t.id;return e("createRef",function(){return{current:void 0}}),e("jsx",function(e,t,...i){let{ref:r,...s}=t=t||{};return{isJsxElement:!0,type:e,props:{...s,children:1<i.length?i:i[0]},ref:r}}),e("renderJsx",function r(e,s){let a,n,o;return(e=Array.isArray(e)?e:[e]).map(i=>{if(null==i||!i.isJsxElement)return[];if("string"==typeof i.type)if(n=i.props.children,"fragment"===i.type)a=void 0;else{let e=s[i.type];if(!e)throw new Error(`No renderer defined for intrinsic JSX element "${i.type}"`);var t=e({ref:i.ref,...i.props});a=t.obj,a&&(o=a),t.children&&(n=t.children)}else{let t=new i.type(i.props);a=t.getUiObject(),n=t.defineChildren?.()||i.props.children,t.onRender&&a.onFrame.subscribeOnce(e=>t.onRender(e)),t.onFrame&&a.onFrame.subscribe(e=>t.onFrame(e)),t.onDispose&&a.onDispose.subscribe(()=>t.onDispose()),o=t}return t=n?(Array.isArray(n)?n:[n]).map(e=>r(e,s)).reduce((e,t)=>[...e,...t],[]):[],a&&a.add(...t),o&&i.ref&&("function"==typeof i.ref?i.ref?.(o):i.ref.current=o),a?[a]:null!==a?t:[]}).reduce((e,t)=>[...e,...t],[])}),{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/component/viewmodel/MenuButtonConfig",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/component/MenuVideo",["react","util/disposable/CompositeDisposable"],function(e,t){"use strict";var r,i,s,a;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){s=new Map([["mp4","video/mp4"],["webm","video/webm"]]),a=class extends r.default.Component{constructor(){super(...arguments),this.el=null,this.disposables=new i.CompositeDisposable,this.disposed=!1}render(){const e=this.props["src"];let t,i;return"string"==typeof e?(i=e,t=s.get(e.split("?")[0].split(".").pop())??"video/webm"):(i=URL.createObjectURL(e),t=e.type,this.disposables.add(()=>{URL.revokeObjectURL(i)})),r.default.createElement("div",{className:"video-wrapper",ref:e=>this.el=e,dangerouslySetInnerHTML:{__html:`
            <video style="outline: none;" loop playsinline muted autoplay>
                <source src="${i}" type="${t}" />
            </video>
            <div class="logo" style="opacity: 0;" />
        `}})}componentDidMount(){const t=this.props["src"];let i=this.el.querySelector("video"),e=this.el.querySelector("div");if(t instanceof File&&window.MediaSource){let e=async()=>{this.applyMediaSourceFallback(i,await t.arrayBuffer())};i.querySelector("source").addEventListener("error",e,{once:!0}),i.addEventListener("loadeddata",()=>{i.querySelector("source").removeEventListener("error",e)})}i.addEventListener("loadeddata",()=>{e.style.opacity=""})}async applyMediaSourceFallback(i,r){if(!this.disposed){let t=new MediaSource;t.addEventListener("sourceopen",()=>{try{let e=t.addSourceBuffer('video/webm; codecs="vp8"');e.mode="sequence",e.appendBuffer(r),this.timeoutId=setTimeout(()=>this.processNextSegment(e,i,r),1e3),this.disposables.add(()=>clearTimeout(this.timeoutId))}catch(e){return void("NotSupportedError"!==e.name&&console.error(e))}});let e=i.src=URL.createObjectURL(t);this.disposables.add(()=>{URL.revokeObjectURL(e),e=void 0})}}processNextSegment(e,t,i){try{!e.updating&&0<e.buffered.length&&(e.buffered.end(e.buffered.length-1)-t.currentTime<10&&e.appendBuffer(i),t.paused&&t.play()?.catch(e=>console.error(e)))}catch(e){return void console.error(e)}this.timeoutId=setTimeout(()=>this.processNextSegment(e,t,i),1e3)}componentWillUnmount(){this.disposables.dispose(),this.disposed=!0}},e("MenuVideo",a)}}}),System.register("gui/component/MenuButton",["react"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.default.Component{render(){var e=this.props["buttonConfig"];return e?i.default.createElement("div",{className:this.getClassName(e),style:this.getStyle(),onMouseDown:e=>this.onMouseDown(e),onMouseUp:e=>this.onMouseUp(e),onClick:e=>this.onClick(e),"data-r-tooltip":e.tooltip},e.label):null}getClassName(e){let t=["menu-button"];return e.disabled&&t.push("disabled"),t.join(" ")}getStyle(){var e=this.props.box;return{position:"absolute",left:e.x,top:e.y,width:e.width,height:e.height,lineHeight:e.height+1+"px"}}onMouseDown(e){!this.props.buttonConfig.disabled&&this.props.onMouseDown&&this.props.onMouseDown(e)}onMouseUp(e){!this.props.buttonConfig.disabled&&this.props.onMouseUp&&this.props.onMouseUp(e)}onClick(e){!this.props.buttonConfig.disabled&&this.props.onClick&&this.props.onClick(e)}},e("MenuButton",r)}}}),System.register("gui/screen/mainMenu/component/MenuSlotAnimationRunner",["data/IniSection","data/ShpFile","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],function(t,e){"use strict";var i,r,s,a,n,o,l,c,h;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){var e;(e=l=l||{})[e.None=0]="None",e[e.SlideIn=1]="SlideIn",e[e.SlideOut=2]="SlideOut",t("AnimationType",l),(e=c=c||{})[e.Hidden=0]="Hidden",e[e.Unlit=1]="Unlit",e[e.Normal=2]="Normal",e[e.Active=3]="Active",t("MenuButtonState",c),t("MenuSlotAnimationRunner",h=class{constructor(e=0){this.delayFrames=e,this.buttonState=c.Hidden,this.collapsed=!0,this.currentAnimationType=l.None}slideIn(){this.currentAnimationType=l.SlideIn,this.initAnimation()}slideOut(){this.currentAnimationType=l.SlideOut,this.initAnimation()}initAnimation(){var e=new i.IniSection("");let t=new a.AnimProps(e,new r.ShpFile);t.loopEnd=5;e=new s.Animation(t,new o.BoxedVar(n.Engine.UI_ANIM_SPEED));this.animation=e}tick(e){let t=this.animation;var i=this.currentAnimationType;if(t&&i!==l.None){switch(t.getState()){case s.AnimationState.STOPPED:break;case s.AnimationState.NOT_STARTED:t.start(e,this.delayFrames);case s.AnimationState.RUNNING:default:t.update(e)}t.getState()===s.AnimationState.STOPPED&&(this.collapsed=i===l.SlideOut,this.currentAnimationType=l.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===l.None}getCurrentFrame(){if(this.currentAnimationType!==l.None&&this.animation.getState()!==s.AnimationState.DELAYED){var t=this.currentAnimationType===l.SlideIn?-1:1;let e=this.buttonState!==c.Hidden?5:11;return-1==t&&(e+=5),e+t*this.animation.getCurrentFrame()}let e;if(this.collapsed)e=this.buttonState===c.Hidden?16:10;else if(this.buttonState===c.Hidden)e=0;else if(this.buttonState===c.Unlit)e=1;else if(this.buttonState===c.Normal)e=2;else{if(this.buttonState!==c.Active)throw new Error(`Unknown buttonState "${this.buttonState}"`);e=4}return e}})}}}),System.register("engine/renderable/builder/CanvasTextureAtlas",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CanvasTextureAtlas",i=class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(e){if(!this.imageRects)throw new Error("Texture atlas not initialized");var t=this.imageRects.get(e);if(!t)throw new Error("Image not found in atlas");return t}pack(e){let t=[];e.forEach(e=>{t.push({w:e.width,h:e.height,image:e})}),t.sort((e,t)=>1e3*(t.w-e.w)+t.h-e.h);let i=new GrowingPacker;i.fit(t);var r=i.root.w,s=i.root.h;let a=document.createElement("canvas"),n=a.getContext("2d",{alpha:!0});a.width=r,a.height=s;let o=new Map;t.forEach(e=>{if(!e.fit)throw new Error("Couldn't fit all images in a single texture");var t=e.image,i=e.fit.x,r=e.fit.y;o.set(t,{x:i,y:r,width:e.w,height:e.h}),n.drawImage(t,i,r)});let l=new THREE.Texture(a);l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,this.texture=l,this.imageRects=o}})}}}),System.register("engine/renderable/builder/CanvasSpriteBuilder",["engine/gfx/SpriteUtils","engine/renderable/builder/CanvasTextureAtlas"],function(e,t){"use strict";var r,i,s;t&&t.id;return{setters:[function(e){r=e},function(e){i=e}],execute:function(){e("CanvasSpriteBuilder",s=class s{constructor(e,t){this.images=e,this.camera=t,this.offset={x:0,y:0},this.align={x:0,y:0},this.opacity=1,this.forceTransparent=!1,this.frustumCulled=!1,this.frameGeometries=new Map,this.setFrame(0)}static clearCaches(){s.textureCache.clear()}setOffset(e){this.offset=e}setAlign(e,t){var i;this.align={x:e,y:t},this.mesh&&(this.frameGeometries.get(this.frameNo)?.dispose(),i=r.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(this.frameNo,i),this.mesh.geometry=i)}initTexture(){if(s.textureCache.has(this.images))this.atlas=s.textureCache.get(this.images);else{let e=new i.CanvasTextureAtlas;e.pack(this.images),s.textureCache.set(this.images,e),this.atlas=e}}getSpriteGeometryOptions(){var e=this.images[this.frameNo],t={x:-e.width/2-this.align.x*(e.width/2)+this.offset.x,y:-e.height/2-this.align.y*(e.height/2)+this.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getImageRect(e),align:{x:1,y:-1},offset:t,camera:this.camera}}setFrame(t){if(this.frameNo!==t&&(this.frameNo=t,this.mesh)){let e=this.frameGeometries.get(t);e||(e=r.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(t,e)),this.mesh.geometry=e}}getFrame(){return this.frameNo}getSize(){return{width:this.images[this.frameNo].width,height:this.images[this.frameNo].height}}get frameCount(){return this.images.length}setOpacity(e){var t=this.opacity;t!==e&&(this.opacity=e,this.mesh&&(this.mesh.material.opacity=e),Math.floor(t)===Math.floor(e)||this.forceTransparent||this.updateTransparency())}setForceTransparent(e){this.forceTransparent!==e&&(this.forceTransparent=e,this.updateTransparency())}updateTransparency(){this.mesh&&(this.mesh.material.transparent=this.forceTransparent||this.opacity<1)}setExtraLight(e){throw new Error("Not implemented")}setFrustumCulled(e){this.frustumCulled=e,this.mesh&&(this.mesh.frustumCulled=e)}build(){if(this.mesh)return this.mesh;this.initTexture();var e=r.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions());this.frameGeometries.set(this.frameNo,e);var t=new THREE.MeshBasicMaterial({map:this.atlas.getTexture(),flatShading:!0,opacity:this.opacity,transparent:this.opacity<1||this.forceTransparent});let i=new THREE.Mesh(e,t);return i.matrixAutoUpdate=!1,i.frustumCulled=this.frustumCulled,this.mesh=i,i}dispose(){this.frameGeometries.forEach(e=>e.dispose()),this.mesh?.material?.dispose()}}),s.textureCache=new Map}}}),System.register("gui/jsx/JsxRenderer",["gui/jsx/jsx","gui/UiObjectSprite","gui/UiObject","gui/HtmlContainer","engine/renderable/builder/CanvasSpriteBuilder","gui/ShpSpriteBatch"],function(e,t){"use strict";var i,a,r,n,o,l,c,s;t&&t.id;return{setters:[function(e){i=e},function(e){a=e},function(e){r=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=e=>!!e.images,e("JsxRenderer",s=class{constructor(e,t,i,s){this.images=e,this.palettes=t,this.camera=i,this.jsxIntrinsicRenderers={sprite:t=>{let i;if(c(t)){let e=new o.CanvasSpriteBuilder(t.images,this.camera);e.setAlign(t.alignX??0,t.alignY??0),i=new a.UiObjectSprite(e)}else{var e="string"==typeof t.image?this.getImage(t.image):t.image,r="string"==typeof t.palette?this.getPalette(t.palette):t.palette;i=a.UiObjectSprite.fromShpFile(e,r,this.camera)}return s&&i.setPointerEvents(s),this.setupListeners(i,t),t.onFrame&&i.onFrame.subscribe(t.onFrame),i.setPosition(t.x||0,t.y||0),void 0!==t.frame&&i.setFrame(t.frame),t.animationRunner&&i.setAnimationRunner(t.animationRunner),t.hidden&&i.setVisible(!1),t.zIndex&&i.setZIndex(t.zIndex),void 0!==t.opacity&&i.setOpacity(t.opacity),void 0!==t.transparent&&i.setTransparent(t.transparent),void 0!==t.tooltip&&i.setTooltip(t.tooltip),{obj:i}},"sprite-batch":e=>{let t=[];t=e.children?Array.isArray(e.children)?e.children.flat():[e.children]:[];let i=[],r=[];for(var s of t)"sprite"===s.type&&s.props.static&&!c(s.props)?r.push(s.props):i.push(s);return{obj:new l.ShpSpriteBatch(r,e=>this.getImage(e),e=>this.getPalette(e),this.camera),children:[...i]}},container:e=>{let t=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);return s&&t.setPointerEvents(s),this.setupListeners(t,e),e.onFrame&&t.onFrame.subscribe(e.onFrame),e.hidden&&t.setVisible(!1),e.zIndex&&t.setZIndex(e.zIndex),t.setPosition(e.x||0,e.y||0),t.getHtmlContainer()?.setSize(e.width||0,e.height||0),{obj:t}},mesh:e=>{let t=new r.UiObject(e.children);return s&&t.setPointerEvents(s),this.setupListeners(t,e),t.setPosition(e.x||0,e.y||0),e.zIndex&&t.setZIndex(e.zIndex),e.hidden&&t.setVisible(!1),{obj:t}}}}setupListeners(i,r){const s={click:"onClick",dblclick:"onDoubleClick",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",mouseover:"onMouseOver",mouseup:"onMouseUp",mousemove:"onMouseMove",wheel:"onWheel"};Object.keys(s).forEach(e=>{var t=r[s[e]];t&&i.addEventListener(e,t)})}setCamera(e){this.camera=e}getImage(e){var t=this.images.get(e);if(!t)throw new Error(`Missing image "${e}"`);return t}getPalette(e){var t=this.palettes.get(e);if(!t)throw new Error(`Missing palette "${e}"`);return t}render(e){return i.renderJsx(e,this.jsxIntrinsicRenderers)}})}}}),System.register("gui/HtmlReactElement",["react","react-dom","gui/HtmlContainer"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends s.HtmlContainer{constructor(e,t){super(),this.options=e,this.Component=t}static factory(e,t){return new this(t,e)}render(){var e;this.isRendered()||(e=document.createElement("div"),this.setElement(e),this.renderReactElement()),super.render()}renderReactElement(){r.default.render(i.default.createElement(this.Component,this.options),this.getElement())}applyOptions(e){e(this.options),this.refresh()}refresh(){this.isRendered()&&this.renderReactElement()}unrender(){var e=this.getElement();e&&this.isRendered()&&r.default.unmountComponentAtNode(e),super.unrender()}},e("HtmlReactElement",a)}}}),System.register("gui/jsx/HtmlView",["gui/jsx/UiComponent","gui/UiObject","gui/HtmlReactElement"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends i.UiComponent{createUiObject(e){let t=s.HtmlReactElement.factory(this.props.component,this.props.props);t.setSize(e.width||0,e.height||0);let i=new r.UiObject(new THREE.Object3D,t);return i.setPosition(e.x||0,e.y||0),e.hidden&&i.setVisible(!1),this.props.innerRef?.(t),i}getElement(){return this.getUiObject().getHtmlContainer()}},e("HtmlView",a)}}}),System.register("gui/screen/mainMenu/component/MenuMpSlotAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===i.AnimationType.None||this.animation.getState()===r.AnimationState.DELAYED)return this.collapsed?6:0;{var t=this.currentAnimationType===i.AnimationType.SlideIn?-1:1;let e=1;return-1==t&&(e+=5),e+t*this.animation.getCurrentFrame()}}},e("MenuMpSlotAnimRunner",s)}}}),System.register("gui/screen/mainMenu/component/MenuMpSlotText",["react"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("MenuMpSlotText",({text:e})=>i.default.createElement("pre",{className:"menu-mp-slot-text"},e))}}}),System.register("gui/screen/mainMenu/component/MenuSdTopAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===i.AnimationType.None||this.animation.getState()===r.AnimationState.DELAYED)return this.collapsed?5:0;{var t=this.currentAnimationType===i.AnimationType.SlideIn?-1:1;let e=0;return-1==t&&(e+=5),e+t*this.animation.getCurrentFrame()}}},e("MenuSdTopAnimRunner",s)}}}),System.register("gui/screen/mainMenu/component/SidebarTitle",["react"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SidebarTitle",({title:e})=>i.default.createElement("div",{className:"sidebar-title"},e))}}}),System.register("gui/screen/mainMenu/component/SidebarPreview",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuSdTopAnimRunner","data/IniSection","engine/AnimProps","engine/Animation","engine/animation/SimpleRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/SidebarTitle","engine/Engine","util/BoxedVar"],function(e,t){"use strict";var l,i,r,s,c,h,u,d,g,p,m,f,y,a;t&&t.id;return{setters:[function(e){l=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){a=class extends i.UiComponent{constructor(){super(...arguments),this.sidebarPreviewNeedsRefresh=!1,this.closed=this.props.closed,this.preview=this.props.preview,this.title=this.props.title}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new s.HtmlContainer);return e.onFrame.subscribe(e=>this.handleFrame(e)),e}defineChildren(){var{sdtpImg:e,sdtpAnimImg:t}=this.props,i=this.closed;let r=this.preview;var s=this.title||"",a=new h.IniSection("");let n=new u.AnimProps(a,t);n.loopCount=-1;a=new d.Animation(n,new y.BoxedVar(f.Engine.UI_ANIM_SPEED));let o=new g.SimpleRunner;o.animation=a;a=this.getPreviewSize();return l.jsx("fragment",null,l.jsx("sprite",{image:e,palette:"shell.pal",frame:i?0:1,ref:e=>this.sidebarTop=e}),l.jsx(p.HtmlView,{component:m.SidebarTitle,props:{title:s},innerRef:e=>this.titleView=e,x:25,y:3,width:118,height:this.closed?32:18}),l.jsx("sprite",{image:"sdwrntmp.shp",palette:"shell.pal",hidden:!0,ref:e=>this.sidebarTopPreviewAnim=e,animationRunner:new c.MenuSdTopAnimRunner}),l.jsx("sprite",{image:t,palette:"shell2.pal",x:38,y:48,hidden:!i,ref:e=>this.sidebarTopClosedAnim=e,animationRunner:o}),l.jsx("container",{hidden:!r||i,ref:e=>{this.previewContainer=e,r&&this.previewContainer.add(r)},x:12,y:40,width:a.width,height:a.height}))}getPreviewSize(){return{width:146,height:112}}toggleSidebarPreview(t){if(this.closed!==!t){let e=this.sidebarTopPreviewAnim.getAnimationRunner();t?e.slideIn():e.slideOut(),this.closed=!t,this.sidebarPreviewNeedsRefresh=!0,this.sidebarTopPreviewAnim.setVisible(!0),(t?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!1),this.titleView.setVisible(!1),this.updateTitleSize()}}setPreview(e){this.preview&&this.previewContainer.remove(this.preview),e&&this.previewContainer.add(e),this.preview=e}setTitle(t){this.title=t,this.titleView.applyOptions(e=>e.title=t),this.updateTitleSize()}updateTitleSize(){this.titleView.setSize(this.titleView.getSize().width,this.closed?32:18)}handleFrame(e){if(this.sidebarPreviewNeedsRefresh){let e=this.sidebarTopPreviewAnim.getAnimationRunner();e.isStopped()&&((this.closed?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!0),this.sidebarTopPreviewAnim.setVisible(!1),this.sidebarTop.setFrame(this.closed?0:1),this.titleView.setVisible(!0),this.sidebarPreviewNeedsRefresh=!1)}}},e("SidebarPreview",a)}}}),System.register("gui/screen/mainMenu/component/MenuTooltip",["react","classnames"],function(e,t){"use strict";var a,n;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){e("MenuTooltip",({monitorContainer:t})=>{const[e,s]=a.useState(""),[i,r]=a.useState(!1);return a.useEffect(()=>{let i=t.getElement(),r;const e=e=>{let t=e.target;if(t!==r){r=t;let e=t.getAttribute("data-r-tooltip");for(;t&&t!==i&&!e;)t=t.parentElement,e=t.getAttribute("data-r-tooltip");s(e||"")}};return i.addEventListener("mousemove",e),i.addEventListener("mouseleave",e),()=>{i.removeEventListener("mousemove",e),i.removeEventListener("mouseleave",e)}},[]),a.useEffect(()=>{r(!1);const e=setTimeout(()=>r(!0),10);return()=>clearTimeout(e)},[e]),a.default.createElement("div",{className:n.default("menu-tooltip",{anim:i})},e)})}}}),System.register("gui/screen/mainMenu/component/VersionString",["react"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("VersionString",({value:e})=>i.default.createElement("div",{className:"menu-version-string"},"v",e))}}}),System.register("gui/screen/mainMenu/component/MainMenu",["gui/jsx/jsx","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuVideo","gui/component/MenuButton","util/event","gui/screen/mainMenu/component/MenuSlotAnimationRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/MenuMpSlotAnimRunner","gui/screen/mainMenu/component/MenuMpSlotText","gui/screen/mainMenu/component/SidebarPreview","gui/screen/mainMenu/component/MenuTooltip","gui/screen/mainMenu/component/VersionString"],function(e,t){"use strict";var n,i,s,a,o,l,c,h,u,d,g,p,m,r;t&&t.id;return{setters:[function(e){n=e},function(e){i=e},function(e){s=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){r=class extends i.UiObject{constructor(e,t,i,r){super(new THREE.Object3D,new s.HtmlContainer),this.viewport=e,this.images=t,this.jsxRenderer=i,this.videoSrc=r,this.rootObjects=[],this.sidebarObjects=[],this.sidebarSlots=[],this.sidebarMpSlotEnabled=!1,this.sidebarButtons=[],this.sidebarButtonConfigs=[],this.sidebarCollapsed=!0,this._onSidebarToggle=new l.EventDispatcher,this.create3DObject()}get onSidebarToggle(){return this._onSidebarToggle}setViewport(e){this.viewport=e,this.setPosition(this.viewport.x,this.viewport.y);var t=this.getImage("lwscrnl.shp");this.statusBar.setPosition(0,this.viewport.height-t.height);var i=this.getImage("sdtp.shp"),t=this.computeSidebarViewport(i);this.sidebarContainer.setPosition(t.x,t.y),this.sidebarContainer.remove(...this.sidebarObjects),this.sidebarObjects.forEach(e=>e.destroy()),this.createSidebarButtons(this.computeSidebarButtonsViewport(i)),this.updateButtons(this.sidebarButtonsRawConfigs??[]),this.sidebarCollapsed||this.showButtons()}setContentComponent(e){let t=this.mainContainer;this.contentComponent&&(t.remove(this.contentComponent),this.contentComponent.destroy(),this.contentComponent=void 0),e&&(t.add(e),this.contentComponent=e)}setSlots(r,s,a=!1){let n=this.sidebarSlots.length;if(!n)throw new Error("Cannot call setButtons prior to render");this.sidebarMpSlotContainer.setVisible(a),this.sidebarSlots[0].setVisible(!a),this.sidebarSlots.forEach((e,t)=>{let i=e.getAnimationRunner();t<r+(a?1:0)?i.buttonState=c.MenuButtonState.Unlit:t===n-1?i.buttonState=s?c.MenuButtonState.Unlit:c.MenuButtonState.Hidden:i.buttonState=c.MenuButtonState.Hidden})}setButtons(e,t=!1){this.sidebarButtonsRawConfigs=e,this.sidebarMpSlotEnabled=t,this.updateButtons(e)}updateButtons(e){let r=this.sidebarMpSlotEnabled;var t=!!e.find(e=>!!e.isBottom);this.setSlots(e.length-(t?1:0),t,r),this.updateSidebarMpText(),this.sidebarButtons.forEach(e=>e.applyOptions(e=>e.buttonConfig=void 0)),e.forEach((t,e)=>{var i=t.isBottom?this.sidebarButtons.length-1:r?e+1:e;this.sidebarButtonConfigs[i]=t,this.sidebarButtons[i]?.applyOptions(e=>e.buttonConfig={label:t.label,tooltip:t.tooltip,disabled:!!t.disabled})}),this.sidebarNeedsRefresh=!0}isSidebarCollapsed(){return this.sidebarCollapsed}showButtons(){this.sidebarCollapsed=!1,this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideIn(),this.sidebarSlots.forEach(e=>{let t=e.getAnimationRunner();t.slideIn()})}hideButtons(){this.sidebarCollapsed=!0,this.updateSidebarButtons(),this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideOut(),this.sidebarSlots.forEach(e=>{let t=e.getAnimationRunner();t.slideOut()})}setSidebarTitle(e){this.sidebarPreview.setTitle(e)}toggleSidebarPreview(e){this.sidebarPreview.toggleSidebarPreview(e)}setSidebarPreview(e){this.sidebarPreviewInner&&this.sidebarPreviewInner.destroy(),this.sidebarPreview.setPreview(e),this.sidebarPreviewInner=e}getSidebarPreviewSize(){return this.sidebarPreview.getPreviewSize()}toggleVideo(e){if(!this.menuVideo)throw new Error("Cannot call toggleVideo prior to render");this.menuVideo.getUiObject().setVisible(e)}showVersion(t){this.version.getUiObject().setVisible(!0),this.version.getElement().applyOptions(e=>e.value=t)}hideVersion(){this.version.getUiObject().setVisible(!1)}setSidebarMpText(e){this.sidebarMpSlotText=e,this.updateSidebarMpText()}updateSidebarMpText(){this.sidebarMpSlotTextEl.applyOptions(e=>e.text=this.sidebarMpSlotText)}getImage(e){var t=this.images.get(e);if(!t)throw new Error(`Missing image "${e}"`);return t}create3DObject(){var e,t,i,r,s;super.create3DObject(),this.rootObjects.length||(this.setPosition(this.viewport.x,this.viewport.y),e=this.getImage("mnscrnl.shp"),t=this.getImage("lwscrnl.shp"),i=this.getImage("sdtp.shp"),r=this.getImage("sdwrnanm.shp"),s=this.computeSidebarViewport(i),this.rootObjects=this.jsxRenderer.render(n.jsx("fragment",null,n.jsx("container",{width:e.width,height:e.height,ref:e=>this.mainContainer=e},n.jsx("sprite",{image:e,palette:"shell.pal"}),n.jsx(h.HtmlView,{component:a.MenuVideo,props:{src:this.videoSrc},hidden:!0,ref:e=>this.menuVideo=e})),n.jsx("container",{x:0,y:this.viewport.height-t.height,ref:e=>this.statusBar=e},n.jsx("sprite",{image:t,palette:"shell.pal"}),n.jsx(h.HtmlView,{component:p.MenuTooltip,props:{monitorContainer:this.getHtmlContainer()},width:t.width,height:t.height})),n.jsx("container",{x:s.x,y:s.y,ref:e=>this.sidebarContainer=e},n.jsx(g.SidebarPreview,{sdtpImg:i,sdtpAnimImg:r,closed:!0,ref:e=>this.sidebarPreview=e}),n.jsx(h.HtmlView,{component:m.VersionString,props:{value:""},width:s.width,y:s.height-20,ref:e=>this.version=e,hidden:!0})))),this.add(...this.rootObjects),this.createSidebarButtons(this.computeSidebarButtonsViewport(i)))}createSidebarButtons(r){let s=this.getImage("sdbtnbkgd.shp"),a=this.getImage("sdbtnanm.shp");var e=Math.floor(r.height/s.height);let t=this.getImage("sdbtm.shp");var i=r.height-s.height*e,i=t.clip(t.width,i);this.sidebarSlots=[],this.sidebarButtons=[],this.sidebarObjects=this.jsxRenderer.render(n.jsx("fragment",null,new Array(e).fill(0).map((e,t)=>{let i=new c.MenuSlotAnimationRunner(t);return n.jsx("fragment",null,n.jsx("container",{x:r.x,y:r.y+s.height*t},n.jsx("sprite",{image:s,palette:"shell2.pal"}),t?[]:n.jsx("container",{zIndex:1,hidden:!0,ref:e=>this.sidebarMpSlotContainer=e,x:12,y:-s.height},n.jsx("sprite",{image:"sdmpbtn.shp",palette:"shell.pal",ref:e=>this.sidebarMpSlot=e,animationRunner:new u.MenuMpSlotAnimRunner}),n.jsx(h.HtmlView,{component:d.MenuMpSlotText,props:{text:""},width:146,height:2*s.height,innerRef:e=>this.sidebarMpSlotTextEl=e})),n.jsx("sprite",{image:a,palette:"sdbtnanm.pal",ref:e=>this.sidebarSlots.push(e),x:12,animationRunner:i}),n.jsx(h.HtmlView,{x:12,hidden:!0,innerRef:e=>this.sidebarButtons.push(e),component:o.MenuButton,props:{box:{x:0,y:0,width:146,height:a.height},onMouseDown:()=>{i.buttonState=c.MenuButtonState.Active;let e=()=>{i.buttonState=c.MenuButtonState.Normal,document.removeEventListener("mouseup",e)};document.addEventListener("mouseup",e)},onClick:()=>{this.onSidebarButtonClick(t)}}})))}),n.jsx("sprite",{image:i,palette:"shell.pal",x:r.x,y:r.y+s.height*e}))),this.sidebarContainer.add(...this.sidebarObjects)}computeSidebarViewport(e){return{x:this.viewport.width-e.width,y:0,width:e.width,height:this.viewport.height}}computeSidebarButtonsViewport(e){return{x:0,y:e.height,width:e.width,height:this.viewport.height-e.height}}update(e){if(super.update(e),this.sidebarNeedsRefresh){let e=this.sidebarSlots[this.sidebarSlots.length-1],t=e.getAnimationRunner();t.isStopped()&&(this.updateSidebarButtons(),this._onSidebarToggle.dispatch(this,!this.sidebarCollapsed))}}updateSidebarButtons(){this.sidebarCollapsed?(this.sidebarButtons.forEach(e=>e.hide()),this.sidebarMpSlotTextEl.hide(),this.sidebarSlots.forEach(e=>{let t=e.getAnimationRunner();t.buttonState===c.MenuButtonState.Normal&&(t.buttonState=c.MenuButtonState.Unlit)})):(this.sidebarButtons.forEach(e=>e.show()),this.sidebarMpSlotTextEl.show(),this.sidebarSlots.forEach(e=>{let t=e.getAnimationRunner();t.buttonState===c.MenuButtonState.Unlit&&(t.buttonState=c.MenuButtonState.Normal)})),this.sidebarNeedsRefresh=!1}onSidebarButtonClick(e){const t=this.sidebarButtonConfigs[e].onClick;t&&t()}destroy(){this.sidebarButtons.length=0,this.remove(...this.rootObjects),this.rootObjects.forEach(e=>e.destroy()),this.rootObjects.length=0,super.destroy()}},e("MainMenu",r)}}}),System.register("gui/component/Slider",["react"],function(e,t){"use strict";var s;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("Slider",({getLabel:e,...t})=>{let[i,r]=s.useState(()=>t.value);s.useEffect(()=>{i!==t.value&&r(t.value)},[t.value]);return s.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"}},s.default.createElement("input",{type:"range",...t,value:i,onChange:e=>{r(e.target.value),t.onChange?.(e)}}),s.default.createElement("input",{type:"text",disabled:!0,readOnly:!0,value:e?.(i)??i}))})}}}),System.register("data/PcxFile",["pcx-js","engine/gfx/CanvasUtils"],function(e,t){"use strict";var s,i,r;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){e("PcxFile",r=class{constructor(e){this.file=e;var t=this.file.stream;let i=new s.default(new Uint8Array(t.buffer,t.byteOffset,t.byteLength));var r=i.decode(),t=r.pixelArray;this.fixAlpha(t),this.width=r.width,this.height=r.height,this.data=t}async toPngBlob(){var e=this.toCanvas();return await i.CanvasUtils.canvasToBlob(e)}toDataUrl(){return this.toCanvas().toDataURL()}toCanvas(){return i.CanvasUtils.canvasFromRgbaImageData(this.data,this.width,this.height)}fixAlpha(e){for(let t=0,i=e.length;t<i;t+=4)255===e[t]&&0===e[t+1]&&255===e[t+2]&&(e[t+3]=0)}})}}}),System.register("gui/component/ImageContext",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ImageContext",i=class{}),i.imageUrlCache=new Map}}}),System.register("gui/component/Image",["data/Palette","data/PcxFile","data/ShpFile","engine/gfx/ImageUtils","react","gui/component/ImageContext"],function(e,t){"use strict";var c,h,u,d,i,r;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){i=e},function(e){r=e}],execute:function(){e("Image",n=>{const o=r.ImageContext,[e,l]=i.useState("");return i.useEffect(()=>{let t,e;if(o.imageUrlCache.has(n.src))t=o.imageUrlCache.get(n.src);else if(o.vfs?.fileExists(n.src)){var i=n.src.split(".").pop();if("shp"===i){var r,s,a=n.palette;t=o.vfs.fileExists(a)?(r=new u.ShpFile(o.vfs.openFile(n.src)),s=new c.Palette(o.vfs.openFile(a)),d.ImageUtils.convertShpToCanvas(r,s).toDataURL()):(console.warn(`Palette "${a}" not found in VFS"`),"")}else if("pcx"===i){let e=new h.PcxFile(o.vfs.openFile(n.src));t=e.toDataUrl()}else"png"===i?(a=o.vfs.openFile(n.src).stream,a=new Blob([new Uint8Array(a.buffer,a.byteOffset,a.byteLength)],{type:"image/png"}),t=URL.createObjectURL(a),e=()=>{URL.revokeObjectURL(t),o.imageUrlCache.delete(n.src)}):(console.warn(`Unknown image format "${i}"`),t="");o.imageUrlCache.set(n.src,t)}else t=o.cdnBaseUrl?o.cdnBaseUrl+n.src.substring(0,n.src.lastIndexOf("."))+".png":(console.warn(`Image "${n.src}" not found in VFS`),"");return l(t),e},[n.src]),e?i.default.createElement("img",{src:e}):null})}}}),System.register("gui/component/CountryIcon",["react","game/gameopts/constants","gui/component/Image"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=(new Map).set("Americans","usai.pcx").set("French","frai.pcx").set("Germans","geri.pcx").set("British","gbri.pcx").set("Russians","rusi.pcx").set("Confederation","lati.pcx").set("Africans","djbi.pcx").set("Arabs","arbi.pcx").set("Alliance","japi.pcx").set(r.RANDOM_COUNTRY_NAME,"rani.pcx").set(r.OBS_COUNTRY_NAME,"obsi.pcx"),n=class extends i.default.Component{render(){var e=a.get(this.props.country);return i.default.createElement("div",{className:"player-country-icon"},e&&i.default.createElement(s.Image,{src:e}))}},e("CountryIcon",n)}}}),System.register("gui/component/Option",["classnames","react"],function(e,t){"use strict";var l,c;t&&t.id;return{setters:[function(e){l=e},function(e){c=e}],execute:function(){e("Option",({selected:e,disabled:t,label:i,style:r,labelStyle:s,className:a,tooltip:n,onClick:o})=>c.createElement("div",{className:l.default("option",{selected:e,disabled:t},a),style:r,onClick:t?void 0:o,"data-r-tooltip":n},c.createElement("div",{style:s},i)))}}}),System.register("gui/component/Select",["react","classnames","util/dom"],function(e,t){"use strict";var f,y,T;t&&t.id;return{setters:[function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){e("Select",({initialValue:e,disabled:t,tooltip:i,className:r,onSelect:s,labelStyle:a,children:n})=>{let[o,l]=f.useState(()=>e),[c,h]=f.useState(()=>e),[u,d]=f.useState(!1),g=f.useRef(null);f.useEffect(()=>{o!==e&&(l(e),h(o))},[e]);f.useEffect(()=>{if(u){h(o);const e=e=>{T.contains(g.current,e.target)||d(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}}},[u]);var p,m;return f.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"},className:r},f.default.createElement("div",{className:y.default("select",{disabled:t}),"data-r-tooltip":i,ref:g},f.default.createElement("div",{className:"select-value",onClick:()=>!t&&d(!u)},f.default.createElement("div",{style:a?.(o)},(p=o,(m=f.default.Children.toArray(n).find(e=>e.props.value===p))?m.props.label:""))),u&&f.default.createElement("div",{className:"select-layer"},f.default.Children.map(n,e=>{if(!e)return null;const t=e.props.value,i=e.props.disabled;return f.default.createElement("div",{onMouseEnter:()=>!i&&h(t)},f.default.cloneElement(e,{selected:t===c,labelStyle:a?.(t),onClick:()=>{var e;e=t,l(e),h(e),s(e),d(!1)}}))}))))})}}}),System.register("gui/component/CountrySelect",["react","gui/component/CountryIcon","gui/component/Select","gui/component/Option"],function(e,t){"use strict";var h,u,d,g;t&&t.id;return{setters:[function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){e("CountrySelect",({country:e,availableCountries:t,onlyIcon:i,disabled:r,strings:s,countryUiNames:a,countryUiTooltips:n,onSelect:o})=>{let[l,c]=h.useState(()=>e);h.useEffect(()=>{l!==e&&c(e)},[e]);return h.default.createElement("div",{className:"country-select"},h.default.createElement("div",{className:"player-country-icon","data-r-tooltip":s.get("STT:HostPictureFlag")},h.default.createElement(u.CountryIcon,{country:l})),i?null:h.default.createElement(d.Select,{className:"player-country-select",tooltip:s.get("STT:HostComboCountry"),initialValue:l,disabled:r,onSelect:e=>{c(e),o(e)}},(r?[l]:t).map(e=>{var t=s.get(a.get(e)||e),i=n.has(e)?s.get(n.get(e)):void 0;return h.default.createElement(g.Option,{key:e,value:e,label:t,tooltip:i})})))})}}}),System.register("gui/component/ColorSelect",["react","classnames","gui/component/Select","gui/component/Option"],function(e,t){"use strict";var o,l,c,h;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("ColorSelect",({color:e,disabled:t,availableColors:i,onSelect:r,strings:s})=>{let[a,n]=o.useState(()=>e);o.useEffect(()=>{a!==e&&n(e)},[e]);return o.default.createElement(c.Select,{className:l.default("player-color-select",{"bg-color":!!a}),tooltip:s.get("STT:HostComboColor"),initialValue:a||"random",disabled:t,labelStyle:e=>{return{backgroundColor:"random"!==e?e:"transparent"}},onSelect:e=>{"random"===e&&(e=""),n(e),r?.(e)}},(t?[a]:i).map(e=>o.default.createElement(h.Option,{key:e,value:e||"random",label:e?"":s.get("GUI:RandomAsSymbols"),className:l.default({"bg-color":!!e})})))})}}}),System.register("gui/component/PingIndicator",["react","gui/component/Image"],function(t,e){"use strict";var r,s,i,a,n;e&&e.id;return{setters:[function(e){r=e},function(e){s=e}],execute:function(){var e;(e=i=i||{})[e.Good=1]="Good",e[e.Average=2]="Average",e[e.Bad=3]="Bad",a=e=>e<=100?i.Good:e<=250?i.Average:i.Bad,n=(new Map).set(i.Bad,"pingr").set(i.Average,"pingy").set(i.Good,"pingg"),t("PingIndicator",({ping:e,strings:t})=>{var i=void 0!==e?t.get("Msg:PingInfo",e):void 0;return r.default.createElement("div",{className:"ping-indicator","data-r-tooltip":i,title:i},void 0!==e?r.default.createElement(s.Image,{src:n.get(a(e))+".pcx"}):null)})}}}),System.register("gui/component/StartPosSelect",["react","gui/component/Select","game/gameopts/constants","gui/component/Option"],function(e,t){"use strict";var n,o,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("StartPosSelect",({startPos:e,disabled:t,availableStartPositions:i,onSelect:r,strings:s})=>{let a=[...new Set([e,...i]).values()].sort();return n.default.createElement(o.Select,{className:"player-start-pos-select",initialValue:""+e,disabled:t,tooltip:s.get("STT:HostComboStart"),onSelect:e=>{r?.(Number(e))}},a.map(e=>n.default.createElement(c.Option,{key:e,value:""+e,label:e===l.RANDOM_START_POS?s.get("GUI:RandomAsSymbols"):""+(e+1)})))})}}}),System.register("gui/component/TeamSelect",["react","gui/component/Select","gui/component/Option","game/gameopts/constants"],function(e,t){"use strict";var o,l,c,h,u;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){u=e=>String.fromCharCode("A".charCodeAt(0)+e),e("TeamSelect",({teamId:e,required:t,disabled:i,maxTeams:r,onSelect:s,strings:a})=>{let n=new Array(r).fill(0).map((e,t)=>t);return o.default.createElement(l.Select,{className:"player-team-select",initialValue:""+e,disabled:i,tooltip:a.get("STT:HostComboTeam"),onSelect:e=>{s?.(Number(e))}},!t&&o.default.createElement(c.Option,{value:""+h.NO_TEAM_ID,label:a.get("GUI:NoneAsSymbols")}),n.map(e=>o.default.createElement(c.Option,{key:e,value:""+e,label:u(e)})))})}}}),System.register("gui/screen/mainMenu/lobby/component/RankIndicator",["react","gui/component/Image","network/PlayerRankType"],function(e,t){"use strict";var s,a,i,n,o;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){i=e}],execute:function(){n=(new Map).set(i.PlayerRankType.Private,"private").set(i.PlayerRankType.Corporal,"corporal").set(i.PlayerRankType.Sergeant,"sergeant").set(i.PlayerRankType.Lieutenant,"lieutena").set(i.PlayerRankType.Major,"major").set(i.PlayerRankType.Colonel,"colonel").set(i.PlayerRankType.BrigGeneral,"briggenr").set(i.PlayerRankType.General,"general").set(i.PlayerRankType.FiveStarGeneral,"stargen").set(i.PlayerRankType.CommanderInChief,"comchief"),o=(new Map).set(i.PlayerRankType.Private,"GUI:RankPrivate").set(i.PlayerRankType.Corporal,"GUI:RankCorporal").set(i.PlayerRankType.Sergeant,"GUI:RankSergeant").set(i.PlayerRankType.Lieutenant,"GUI:RankLieutenant").set(i.PlayerRankType.Major,"GUI:RankMajor").set(i.PlayerRankType.Colonel,"GUI:RankColonel").set(i.PlayerRankType.BrigGeneral,"GUI:RankBrigGeneral").set(i.PlayerRankType.General,"GUI:RankGeneral").set(i.PlayerRankType.FiveStarGeneral,"GUI:RankFiveStar").set(i.PlayerRankType.CommanderInChief,"GUI:RankCmdInChief"),e("RankIndicator",({playerProfile:e,strings:t})=>{var i=e?.rankType,r=e?void 0!==e.rankType?`${e.name} : ${t.get("GUI:Rank")} ${e.rank} `+`(${t.get(o.get(e.rankType))})`:e.name+" : "+t.get("TXT_UNRANKED"):void 0;return s.default.createElement("div",{className:"rank-indicator","data-r-tooltip":r},void 0!==i?s.default.createElement(a.Image,{src:n.get(i)+".pcx"}):null)})}}}),System.register("gui/screen/mainMenu/lobby/component/LobbyForm",["react","classnames","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/component/Slider","gui/component/Chat","gui/component/CountrySelect","gui/component/ColorSelect","gui/component/PingIndicator","game/gameopts/GameOpts","gui/component/Image","gui/component/StartPosSelect","gui/component/TeamSelect","game/gameopts/constants","gui/component/Select","gui/component/Option","util/typeGuard","gui/screen/mainMenu/lobby/component/RankIndicator"],function(e,t){"use strict";var l,n,c,o,h,a,u,d,g,i,p,m,f,y,T,v,b,r;t&&t.id;return{setters:[function(e){l=e},function(e){n=e},function(e){c=e},function(e){o=e},function(e){h=e},function(e){a=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){i=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e}],execute:function(){r=class extends l.default.Component{constructor(){super(...arguments),this.onPlayerSelect=(e,t)=>{let i,r;e.match(/^\d+$/)?i=Number(e):(i=c.SlotOccupation.Occupied,r=g.AiDifficulty[e]),this.props.onSlotChange(i,t,r)}}render(){let{strings:e,lobbyType:t,mpDialogSettings:i}=this.props;var r=t===c.LobbyType.Singleplayer||t===c.LobbyType.MultiplayerHost,s=t===c.LobbyType.Singleplayer;let a=this.props;return l.default.createElement("div",{className:n.default("lobby-form",{"lobby-form-sp":s})},l.default.createElement("div",{className:"player-slots"},l.default.createElement("div",{className:"player-slot player-slot-header"},l.default.createElement("div",{className:"player-header-players"},e.get("GUI:Players")),l.default.createElement("div",{className:"player-header-side"},e.get("GUI:Side")),l.default.createElement("div",{className:"player-header-color"},e.get("GUI:Color")),l.default.createElement("div",{className:"player-header-position"},e.get("GUI:StartPosition")),l.default.createElement("div",{className:"player-header-team"},e.get("GUI:Team"))),a.playerSlots.map((e,t)=>this.renderPlayerSlot(a,e,t))),l.default.createElement("div",{className:"game-options"},l.default.createElement("div",{className:"game-options-left"},l.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxShortGame")},l.default.createElement("label",null,l.default.createElement("input",{type:"checkbox",name:"shortGame",checked:a.shortGame,onChange:e=>this.props.onToggleShortGame(e.target.checked),disabled:!r})," ",l.default.createElement("span",null,e.get("GUI:ShortGame")))),l.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxRedeploys")},l.default.createElement("label",null,l.default.createElement("input",{type:"checkbox",name:"mcvRepacks",checked:a.mcvRepacks,onChange:e=>this.props.onToggleMcvRepacks(e.target.checked),disabled:!r})," ",l.default.createElement("span",null,e.get("GUI:MCVRepacks")))),l.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxCrates")},l.default.createElement("label",null,l.default.createElement("input",{type:"checkbox",name:"cratesAppear",checked:a.cratesAppear,onChange:e=>this.props.onToggleCratesAppear(e.target.checked),disabled:!r})," ",l.default.createElement("span",null,e.get("GUI:CratesAppear")))),l.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxSWAllowed")},l.default.createElement("label",null,l.default.createElement("input",{type:"checkbox",name:"superWeapons",checked:a.superWeapons,onChange:e=>this.props.onToggleSuperWeapons(e.target.checked),disabled:!r})," ",l.default.createElement("span",null,e.get("GUI:SuperWeaponsAllowed")))),void 0!==a.hostTeams&&l.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxHostTeams")},l.default.createElement("label",null,l.default.createElement("input",{type:"checkbox",name:"hostTeams",checked:a.hostTeams,onChange:e=>this.props.onToggleHostTeams?.(e.target.checked),disabled:!r})," ",l.default.createElement("span",null,e.get("GUI:HostTeams"))))),l.default.createElement("div",{className:"game-options-right"+(r?"":" all-disabled")},l.default.createElement("div",{className:"slider-item"},l.default.createElement("span",{className:"label"},e.get("GUI:GameSpeed")),l.default.createElement(o.Slider,{name:"gameSpeed",min:0,max:6,value:""+a.gameSpeed,disabled:!r,"data-r-tooltip":e.get("STT:HostSliderSpeed"),onChange:e=>this.props.onChangeGameSpeed(Number(e.target.value))})),l.default.createElement("div",{className:"slider-item"},l.default.createElement("span",{className:"label"},e.get("GUI:Credits")),l.default.createElement(o.Slider,{name:"credits",min:i.minMoney,max:i.maxMoney,step:i.moneyIncrement,value:""+a.credits,"data-r-tooltip":e.get("STT:HostSliderCredits"),onChange:e=>this.props.onChangeCredits(Number(e.target.value)),disabled:!r})),l.default.createElement("div",{className:"slider-item"},l.default.createElement("span",{className:"label"},e.get("GUI:UnitCount")),l.default.createElement(o.Slider,{name:"unitCount",min:i.minUnitCount,max:i.maxUnitCount,value:""+a.unitCount,"data-r-tooltip":e.get("STT:HostSliderUnit"),onChange:e=>this.props.onChangeUnitCount(Number(e.target.value)),disabled:!r})),l.default.createElement("div",{className:"checkbox-item","data-r-tooltip":e.get("STT:HostCBoxBuildOffAlly")},l.default.createElement("label",null,l.default.createElement("input",{type:"checkbox",name:"buildOffAlly",checked:a.buildOffAlly,disabled:!r,onChange:e=>this.props.onToggleBuildOffAlly(e.target.checked)})," ",l.default.createElement("span",null,e.get("GUI:BuildOffAlly")))))),void 0!==this.props.messages&&void 0!==this.props.localUsername&&this.props.onSendMessage&&l.default.createElement(h.Chat,{messages:this.props.messages,localUsername:this.props.localUsername,channels:this.props.channels??[],chatHistory:this.props.chatHistory,onSendMessage:this.props.onSendMessage,tooltips:{button:e.get("STT:EmoteButton"),input:r?e.get("STT:HostEditInput"):e.get("STT:GuestEditInput"),output:r?e.get("STT:HostEditOutput"):e.get("STT:GuestEditOutput")},strings:e}))}renderPlayerSlot(e,t,i){const r=e.strings;var s=e.lobbyType===c.LobbyType.Singleplayer||e.lobbyType===c.LobbyType.MultiplayerHost;return t?l.default.createElement("div",{className:"player-slot",key:"playerslot"+i},t.type===c.SlotType.Player?l.default.createElement(b.RankIndicator,{playerProfile:t.playerProfile,strings:r}):l.default.createElement(b.RankIndicator,{playerProfile:void 0,strings:r}),l.default.createElement(d.PingIndicator,{ping:t.type===c.SlotType.Player?t.ping:void 0,strings:r}),l.default.createElement("div",{className:"player-status","data-r-tooltip":r.get("STT:HostPictureAcceptance")},this.renderPlayerStatus(t.status)),this.renderPlayerSelect(t,i,e.lobbyType),l.default.createElement(a.CountrySelect,{countryUiNames:e.countryUiNames,countryUiTooltips:e.countryUiTooltips,country:t.country,availableCountries:e.availablePlayerCountries,disabled:i!==e.activeSlotIndex&&(!s||t.type!==c.SlotType.Ai)||t.type===c.SlotType.Observer||t.status===c.PlayerStatus.Ready&&t.type!==c.SlotType.Ai,strings:e.strings,onSelect:e=>this.props.onCountrySelect(e,i)}),t.type!==c.SlotType.Observer?l.default.createElement(l.default.Fragment,null,l.default.createElement(u.ColorSelect,{color:t.color,availableColors:e.availablePlayerColors,disabled:i!==e.activeSlotIndex&&(!s||t.type!==c.SlotType.Ai)||t.status===c.PlayerStatus.Ready&&t.type!==c.SlotType.Ai,strings:e.strings,onSelect:e=>this.props.onColorSelect(e,i)}),l.default.createElement(p.StartPosSelect,{disabled:e.hostTeams?!s||t.occupation!==c.SlotOccupation.Occupied:i!==e.activeSlotIndex&&(!s||t.type!==c.SlotType.Ai)||t.status===c.PlayerStatus.Ready&&t.type!==c.SlotType.Ai,startPos:t.startPos,availableStartPositions:e.availableStartPositions,onSelect:e=>this.props.onStartPosSelect(e,i),strings:e.strings}),l.default.createElement(m.TeamSelect,{disabled:!e.teamsAllowed||(e.hostTeams?!s||t.occupation!==c.SlotOccupation.Occupied:i!==e.activeSlotIndex&&(!s||t.type!==c.SlotType.Ai)||t.status===c.PlayerStatus.Ready&&t.type!==c.SlotType.Ai),teamId:e.teamsAllowed?t.team:f.NO_TEAM_ID,required:e.teamsRequired,maxTeams:4,onSelect:e=>this.props.onTeamSelect(e,i),strings:e.strings})):null):l.default.createElement("div",{className:"player-slot",key:"playerslot"+i})}renderPlayerStatus(e){return e===c.PlayerStatus.Host?l.default.createElement(i.Image,{src:"wolhost.pcx"}):e===c.PlayerStatus.Ready?l.default.createElement(i.Image,{src:"wolacpt.pcx"}):null}renderPlayerSelect(i,t,e){let r=e===c.LobbyType.Singleplayer;var s=r||e===c.LobbyType.MultiplayerHost;if(t===this.props.activeSlotIndex||s&&0===t)return l.default.createElement("input",{type:"text",className:"player-name",value:i.name,readOnly:!0});let a=this.props.strings,n=(new Map).set(c.SlotOccupation.Occupied,i.name||"").set(c.SlotOccupation.Open,a.get(i.type===c.SlotType.Observer?"GUI:OpenObserver":"GUI:Open")).set(c.SlotOccupation.Closed,r?a.get("GUI:None"):a.get("GUI:Closed")),o=i.occupation;return i.occupation===c.SlotOccupation.Occupied&&i.type===c.SlotType.Ai&&(n.delete(c.SlotOccupation.Occupied),o=g.AiDifficulty[i.aiDifficulty]),i.type!==c.SlotType.Observer&&this.props.availableAiNames.forEach((e,t)=>{n.set(g.AiDifficulty[t],a.get(e))}),l.default.createElement(y.Select,{initialValue:""+o,disabled:!s,onSelect:e=>this.onPlayerSelect(e,t),className:"player-name",tooltip:r?a.get("STT:SkirmishComboAiPlayer"):a.get("STT:HostComboPlayer")},[...n].map(([t,e])=>t===c.SlotOccupation.Occupied&&i.occupation!==c.SlotOccupation.Occupied||t===c.SlotOccupation.Open&&r?null:l.default.createElement(T.Option,{key:t,value:""+t,label:e,tooltip:r?(()=>{let e;return e=t===c.SlotOccupation.Closed?"STT:PlayerNone":f.aiUiTooltips.get(g.AiDifficulty[t]),e?a.get(e):void 0})():void 0})).filter(v.isNotNullOrUndefined))}},e("LobbyForm",r)}}}),System.register("engine/UiAnimationLoop",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("UiAnimationLoop",i=class{constructor(e){this.renderer=e,this.isStarted=!1,this.doBackgroundFrame=e=>{this.isStarted&&this.paused&&this.renderer.update(e)},this.doFrame=t=>{if(this.isStarted&&!this.paused){let e=this.renderer.getStats();e&&e.begin(),this.renderer.update(t),this.renderer.render(),e&&e.end(),this.rafId=requestAnimationFrame(this.doFrame)}},this.handleVisibilityChange=()=>{var e=document.hidden;this.paused!==e&&(this.paused=e,this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval(()=>{var e=performance.now();this.doBackgroundFrame(e)},1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)))}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}}),System.register("tools/LobbyFormTester",["engine/gfx/Renderer","engine/Engine","gui/UiScene","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/component/MainMenu","game/rules/Rules","gui/screen/mainMenu/lobby/component/LobbyForm","engine/UiAnimationLoop","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","game/gameopts/constants"],function(e,t){"use strict";var u,d,g,p,m,f,y,T,v,i,b,S,w,r;t&&t.id;return{setters:[function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){i=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){e("LobbyFormTester",r=class{static main(e,t){let i=new u.Renderer(800,600);i.init(e),i.initStats(document.body),this.disposables.add(i);let r=g.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(r);let s=800,a=600;var n={x:Math.max(0,(r.viewport.width-s)/2),y:Math.max(0,(r.viewport.height-a)/2),width:s,height:a};let o=new v.JsxRenderer(d.Engine.getImages(),d.Engine.getPalettes(),r.camera,void 0),l=new m.MainMenu(n,d.Engine.getImages(),o,"dummy.webm");r.add(l);let c=new f.Rules(d.Engine.getRules());var[n]=o.render(b.jsx(S.HtmlView,{x:n.x,y:n.y,component:y.LobbyForm,props:{strings:t,countryUiNames:new Map([["Random","GUI:RandomEx"],["Observer","GUI:Observer"]].concat(c.getMultiplayerCountries().map(e=>[e.name,e.uiName]))),countryUiTooltips:new Map,availablePlayerCountries:["Random"].concat(c.getMultiplayerCountries().map(e=>e.name)),availablePlayerColors:[""].concat([...c.getMultiplayerColors().values()].map(e=>e.asHexString())),availableAiNames:w.aiUiNames,availableStartPositions:new Array(8).fill(0).map((e,t)=>t),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,lobbyType:p.LobbyType.MultiplayerHost,playerSlots:[{name:"Player 1",type:p.SlotType.Player,occupation:p.SlotOccupation.Occupied,country:"French",color:"#2269d4",startPos:w.RANDOM_START_POS,team:w.NO_TEAM_ID,status:p.PlayerStatus.Host,ping:50,playerProfile:{name:"Player 1",rank:2,points:100}},{name:"Player 2",type:p.SlotType.Player,occupation:p.SlotOccupation.Occupied,country:"Russians",color:"#ff1818",startPos:1,team:0,status:p.PlayerStatus.Ready,ping:300},{name:"Open",type:p.SlotType.Player,occupation:p.SlotOccupation.Open,country:"Random",color:"",startPos:w.RANDOM_START_POS,team:w.NO_TEAM_ID,status:p.PlayerStatus.NotReady},{type:p.SlotType.Observer,occupation:p.SlotOccupation.Open,country:"Observer",color:"",startPos:w.RANDOM_START_POS,team:w.NO_TEAM_ID,status:p.PlayerStatus.NotReady}],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,gameSpeed:6,credits:1e4,unitCount:10,messages:[],mpDialogSettings:c.mpDialogSettings,onSendMessage:()=>{},onCountrySelect:e=>{console.log("selected country",e)},onColorSelect:e=>{console.log("selected color",e)},onStartPosSelect:e=>{console.log("selected start pos",e)},onTeamSelect:e=>{console.log("selected team",e)},onSlotChange:(e,t)=>{console.log("changed slot",e,t)},onToggleShortGame:e=>console.log(e),onToggleMcvRepacks:e=>console.log(e),onToggleCratesAppear:e=>console.log(e),onToggleSuperWeapons:e=>console.log(e),onToggleBuildOffAlly:e=>console.log(e),onChangeGameSpeed:e=>console.log(e),onChangeCredits:e=>console.log(e),onChangeUnitCount:e=>console.log(e)}}));l.add(n),i.addScene(r);let h=new T.UiAnimationLoop(i);h.start(),this.disposables.add(h),e.appendChild(r.getHtmlContainer().getElement()),this.disposables.add(()=>e.removeChild(r.getHtmlContainer().getElement()))}static destroy(){this.disposables.dispose()}}),r.disposables=new i.CompositeDisposable}}}),System.register("ConsoleVars",["util/BoxedVar"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ConsoleVars",r=class{constructor(){this.debugWireframes=new i.BoxedVar(!1),this.debugPaths=new i.BoxedVar(!1),this.debugText=new i.BoxedVar(!1),this.debugBotIndex=new i.BoxedVar(0),this.debugLogging=new i.BoxedVar(!1),this.forceResolution=new i.BoxedVar(void 0),this.freeCamera=new i.BoxedVar(!1),this.fps=new i.BoxedVar(!1),this.cheatsEnabled=new i.BoxedVar(!1)}})}}}),System.register("tools/CameraZoomControls",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CameraZoomControls",i=class{constructor(e,t){this.pointerEvents=e,this.cameraZoom=t,this.handleWheel=e=>{this.cameraZoom.applyStep(0<e.wheelDeltaY?-.1:.1)}}init(){this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel)}destroy(){this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel)}})}}}),System.register("tools/VxlTester",["data/Palette","data/VxlFile","engine/gfx/Renderer","engine/renderable/WorldScene","engine/renderable/builder/VxlNonBatchedBuilder","engine/UiAnimationLoop","gui/PointerEvents","util/disposable/CompositeDisposable","tools/CameraZoomControls","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics"],function(e,t){"use strict";var l,s,c,h,a,u,d,i,g,p,m,f,y,T,r,n,o;t&&t.id;return{setters:[function(e){l=e},function(e){s=e},function(e){c=e},function(e){h=e},function(e){a=e},function(e){u=e},function(e){d=e},function(e){i=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){r=["1tnk.vxl","1tnkbarl.vxl","1tnktur.vxl","2tnk.vxl","2tnkbarl.vxl","2tnktur.vxl","3tnk.vxl","3tnkbarl.vxl","3tnktur.vxl","4tnk.vxl","4tnkbarl.vxl","4tnktur.vxl","aegis.vxl","apache.vxl","apc.vxl","apcw.vxl","art2.vxl","art2barl.vxl","art2tur.vxl","arty.vxl","artybarl.vxl","asw.vxl","axle.vxl","bana.vxl","beag.vxl","bggy.vxl","bike.vxl","bus.vxl","car.vxl","cargocar.vxl","carrier.vxl","cdest.vxl","cdestwo.vxl","cmin.vxl","cmon.vxl","cona.vxl","cop.vxl","cplane.vxl","cruise.vxl","dest.vxl","destwo.vxl","dmisl.vxl","dpod.vxl","dred.vxl","dredwo.vxl","dshp.vxl","euroc.vxl","falc.vxl","flak.vxl","flaktur.vxl","flata.vxl","fortress.vxl","ftnk.vxl","fv.vxl","fvtur.vxl","fvtur1.vxl","fvtur10.vxl","fvtur11.vxl","fvtur12.vxl","fvtur13.vxl","fvtur14.vxl","fvtur2.vxl","fvtur3.vxl","fvtur4.vxl","fvtur5.vxl","fvtur6.vxl","fvtur7.vxl","fvtur8.vxl","fvtur9.vxl","gastank.vxl","gtgcanbarl.vxl","gtgcantur.vxl","gtnk.vxl","gtnkbarl.vxl","gtnktur.vxl","harv.vxl","harvtur.vxl","heli.vxl","hind.vxl","hmec.vxl","hornet.vxl","horv.vxl","htk.vxl","htkbarl.vxl","htktur.vxl","htnk.vxl","htnkbarl.vxl","htnktur.vxl","hvr.vxl","hvrtur.vxl","hwtz.vxl","hyd.vxl","icbm.vxl","jeep.vxl","jeeptur.vxl","laser.vxl","lcrf.vxl","limo.vxl","lpst.vxl","ltnk.vxl","ltnkbarl.vxl","ltnktur.vxl","m113.vxl","m113tur.vxl","mcv.vxl","misl.vxl","mislchem.vxl","mislmlti.vxl","mislorca.vxl","mislsam.vxl","mlrs.vxl","mlrstur.vxl","mmchbarl.vxl","mnly.vxl","monocar.vxl","monoeng.vxl","mrj.vxl","mrjtur.vxl","mtnk.vxl","mtnkbarl.vxl","mtnktur.vxl","mtrb.vxl","mtrs.vxl","mtrt.vxl","orca.vxl","orcab.vxl","orcatran.vxl","outp.vxl","pdplane.vxl","phal.vxl","pick.vxl","piece.vxl","probe.vxl","propa.vxl","ptruck.vxl","pulscan.vxl","repair.vxl","rtnk.vxl","rtnkbarl.vxl","rtnktur.vxl","sam.vxl","sapc.vxl","scrin.vxl","shad.vxl","smcv.vxl","sonic.vxl","sonictur.vxl","sref.vxl","sreftur.vxl","sreftur1.vxl","sreftur2.vxl","sreftur3.vxl","stang.vxl","stnk.vxl","sub.vxl","subt.vxl","subtank.vxl","suvb.vxl","suvw.vxl","taxi.vxl","tire.vxl","tnkd.vxl","tractor.vxl","tran.vxl","trnsport.vxl","trs.vxl","truck2.vxl","trucka.vxl","truckb.vxl","truk.vxl","ttnk.vxl","ttnktur.vxl","tug.vxl","utnk.vxl","v3.vxl","v3rocket.vxl","v3wo.vxl","vlad.vxl","vladwo.vxl","weed.vxl","wini.vxl","wrmn.vxl","zbomb.vxl","zep.vxl"],n=class{constructor(e,t,i,r,s){this.builder=new a.VxlNonBatchedBuilder(e,t,i,r,s),this.wrapper=new THREE.Object3D}get3DObject(){return this.wrapper}create3DObject(){var e=this.builder.build();this.wrapper.add(e)}update(){this.wrapper.rotation.y-=.01}dispose(){this.builder.dispose()}},e("VxlTester",o=class o{static async main(e,t){let i=this.renderer=new c.Renderer(800,600);i.init(document.body),i.initStats(document.body),this.vfs=e,this.vxlGeometryPool=new m.VxlGeometryPool(new f.VxlGeometryCache),this.palette=new l.Palette(e.openFile("unittem.pal"));let r=this.worldScene=h.WorldScene.factory({x:0,y:0,width:800,height:600},new p.BoxedVar(!0),new p.BoxedVar(y.ShadowQuality.High));this.disposables.add(r),r.scene.background=new THREE.Color(14737632),r.camera.far+=1e3,r.camera.updateProjectionMatrix();let s=new T.CanvasMetrics(i.getCanvas(),window);s.init(),this.disposables.add(s);var a=new d.PointerEvents(i,{x:0,y:0},document,s);let n=new g.CameraZoomControls(a,r.cameraZoom);this.disposables.add(n,a),n.init(),this.createFloor(),this.buildBrowser(),i.addScene(r);let o=this.uiAnimationLoop=new u.UiAnimationLoop(i);o.start()}static createFloor(){var e=new THREE.PlaneGeometry(1e4,1e4);let t=new THREE.ShadowMaterial;t.opacity=.5;let i=new THREE.Mesh(e,t);i.rotation.x=-Math.PI/2,i.position.y=-100,i.receiveShadow=!0,this.worldScene.scene.add(i)}static async selectVxl(e){o.currentVxl&&(o.worldScene.remove(o.currentVxl),o.currentVxl.dispose());var t=this.vfs.openFile(e),i=(new Date).getTime(),r=new s.VxlFile(t),t=(new Date).getTime();console.log("Parsing took "+(t-i)+"ms");r=this.currentVxl=new n(r,void 0,this.palette,this.vxlGeometryPool,o.worldScene.camera);o.worldScene.add(r)}static buildBrowser(){let i=this.listEl=document.createElement("div");i.style.position="absolute",i.style.right="0",i.style.top="0",i.style.height="600px",i.style.width="200px",i.style.overflowY="auto",i.appendChild(document.createTextNode("Vxl files:")),r.forEach(e=>{let t=document.createElement("a");t.style.display="block",t.textContent=e,t.setAttribute("href","javascript:;"),t.addEventListener("click",()=>{console.log("Selected vxl",e),o.selectVxl(e)}),i.appendChild(t)}),document.body.appendChild(i),setTimeout(()=>{o.selectVxl("zep.vxl")},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.disposables.dispose()}}),o.disposables=new i.CompositeDisposable}}}),System.register("gui/screen/game/component/hud/viewmodel/SidebarTab",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SidebarTab",i=class{constructor(e){this.items=[],this.needsUpdate=!0,this.flashing=!1,this.id=e}get disabled(){return!this.items.length}})}}}),System.register("network/gamestate/PlayerConnectionStatus",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NotConnected=0]="NotConnected",e[e.Connected=1]="Connected",t("PlayerConnectionStatus",i)}}}),System.register("network/gamestate/PlayerConnectionInfo",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gameopt/Serializer",["data/DataStream","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/MapNameLegacyEncoder","network/gameopt/FileNameEncoder","util/Base64","util/string"],function(e,t){"use strict";var s,i,r,n,o,l,c,a;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("Serializer",a=class a{serializeOptions(e,t=!1){let i=e.gameMode,r=t?(new n.MapNameLegacyEncoder).encode(e.mapTitle):l.Base64.encode(c.utf16ToBinaryString(e.mapTitle)),s=(new o.FileNameEncoder).encode(e.mapName);var a=["0","0",6-e.gameSpeed,e.credits,e.unitCount,Number(e.shortGame),Number(e.superWeapons),Number(e.buildOffAlly),Number(e.mcvRepacks),Number(e.cratesAppear),i,Number(e.hostTeams??!1),r,e.maxSlots,Number(e.mapOfficial),e.mapSizeBytes,s,e.mapDigest].join(",");return a+`:${e.humanPlayers.map(e=>""+e.name+`,${e.countryId},${e.colorId},${e.startPos},${e.teamId},0,0,0`).join(",")}:@:${e.aiPlayers.map(e=>e?`${e.difficulty},${e.countryId},${e.colorId},${e.startPos},`+e.teamId:"0,-1,-1,-1,-1").join(",")},`}serializePingData(e){return e.length+","+e.map(e=>e.playerName+","+e.ping).join(",")}serializeSlotData(e){return e.map(e=>{if(e.type===i.SlotType.Closed)return"@Closed@";if(e.type===i.SlotType.Open)return"@Open@";if(e.type===i.SlotType.OpenObserver)return"@OpenObserver@";if(e.type===i.SlotType.Ai){if(e.difficulty===r.AiDifficulty.Easy)return"@EasyAI@";if(e.difficulty===r.AiDifficulty.Medium)return"@MediumAI@";if(e.difficulty===r.AiDifficulty.Brutal)return"@HardAI@"}else if(e.type===i.SlotType.Player)return e.name;throw new Error("Unexpected slot info with type "+i.SlotType[e.type])}).join(",")+","}serializeLoadInfo(e){return e.map(e=>[e.name,e.status,e.loadPercent,e.ping].join(",")).join(",")}serializePlayerActions(e){let t=new s.DataStream;t.writeUint8(e.length);for(var{id:i,params:r}of e)if(t.writeUint8(i),t.writeUint16(r.byteLength),0<r.byteLength){if(r.byteLength>a.MAX_ACTION_PAYLOAD_SIZE-t.position)throw console.error(`Action #${i} payload exceeds max data size`,r),new RangeError("Maximum payload data size exceeded");t.writeUint8Array(r)}return t.toUint8Array()}serializeAllPlayerActions(e,t){e.writeUint8(t.size);for(var[i,r]of t){e.writeUint8(i);var s=this.serializePlayerActions(r);if(e.writeUint16(s.byteLength),0<s.byteLength){if(s.byteLength>a.MAX_ACTION_PAYLOAD_SIZE)throw console.error(`Player #${i} actions payload exceeds max data size`,r),new RangeError("Maximum payload data size exceeded");e.writeUint8Array(s)}}}serializeMapData(e){return c.binaryStringToUint8Array(e)}}),a.MAX_ACTION_PAYLOAD_SIZE=65536}}}),System.register("network/gamestate/replay/ReplayEventType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.TurnActions=0]="TurnActions",e[e.ChatMessage=1]="ChatMessage",e[e.Taunt=2]="Taunt",t("ReplayEventType",i)}}}),System.register("network/gamestate/replay/ReplayEvent",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ReplayEvent",i=class{constructor(e,t){this.type=e,this.tickNo=t}})}}}),System.register("network/gamestate/replay/ChatMessageReplayEvent",["util/Base64","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(e,t){"use strict";var r,s,i,a,n;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e},function(e){a=e}],execute:function(){n=class extends i.ReplayEvent{constructor(e){super(a.ReplayEventType.ChatMessage,e)}serialize(){return this.payload.playerId+":"+r.Base64.encode(s.utf16ToBinaryString(this.payload.message))}unserialize(e){var[t,i]=e.split(":"),t=Number(t),i=s.binaryStringToUtf16(r.Base64.decode(i));this.payload={playerId:t,message:i}}},e("ChatMessageReplayEvent",n)}}}),System.register("network/gamestate/replay/TauntReplayEvent",["network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.ReplayEvent{constructor(e){super(r.ReplayEventType.Taunt,e)}serialize(){return this.payload.playerId+":"+this.payload.tauntNo}unserialize(e){var[t,i]=e.split(":"),t=Number(t),i=Number(i);this.payload={playerId:t,tauntNo:i}}},e("TauntReplayEvent",s)}}}),System.register("network/gamestate/replay/TurnActionsReplayEvent",["data/DataStream","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends s.ReplayEvent{constructor(e,t,i){super(a.ReplayEventType.TurnActions,i),this.gameOptsParser=e,this.gameOptsSerializer=t}serialize(){let e=new i.DataStream;return this.gameOptsSerializer.serializeAllPlayerActions(e,new Map(this.payload)),r.uint8ArrayToBase64String(e.toUint8Array())}unserialize(e){var t=new i.DataStream(r.base64StringToUint8Array(e)),t=this.gameOptsParser.parseAllPlayerActions(t);this.payload=[...t]}},e("TurnActionsReplayEvent",n)}}}),System.register("network/gamestate/replay/ReplayEventFactory",["network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/ReplayEventType","network/gamestate/replay/TauntReplayEvent","network/gamestate/replay/TurnActionsReplayEvent"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("ReplayEventFactory",n=class{constructor(e,t){this.gameOptsParser=e,this.gameOptsSerializer=t}create(e,t){switch(e){case r.ReplayEventType.TurnActions:return new a.TurnActionsReplayEvent(this.gameOptsParser,this.gameOptsSerializer,t);case r.ReplayEventType.ChatMessage:return new i.ChatMessageReplayEvent(t);case r.ReplayEventType.Taunt:return new s.TauntReplayEvent(t);default:throw new Error(`Unsupported replay event type "${e}" at game tick "${t}"`)}}})}}}),System.register("util/stream",[],function(e,t){"use strict";t&&t.id;return e("makeTextFileLineIterator",async function*(e){const t=new TextDecoder("utf-8");let i=e.stream().getReader(),{value:r,done:s}=await i.read();r=r?t.decode(r,{stream:!0}):"";let a=/\r\n|\n|\r/gm,n=0;for(;;){var o=a.exec(r);if(o)yield r.substring(n,o.index),n=a.lastIndex;else{if(s)break;o=r.substr(n);({value:r,done:s}=await i.read()),r=o+(r?t.decode(r,{stream:!0}):""),n=a.lastIndex=0}}n<r.length&&(yield r.substr(n))}),{setters:[],execute:function(){}}}),System.register("network/gamestate/Replay",["network/gameopt/Serializer","network/gameopt/Parser","util/Base64","network/gamestate/replay/ReplayEventFactory","util/stream","util/string"],function(e,t){"use strict";var T,v,b,S,d,w,i,C,E;t&&t.id;return{setters:[function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){d=e},function(e){w=e}],execute:function(){C=[5,i=6],e("Replay",E=class E{constructor(){this.name="",this.events=[]}static sanitizeFileName(e,t="_"){return e.replace(/[\/\?<>\\:\*\|"]/g,t).replace(/[\x00-\x1f\x7f\x80-\x9f]/g,t).slice(0,this.maxNameLength)}init(e,t,i,r,s){this.gameId=e,this.gameTimestamp=t,this.gameOpts=i,this.engineVersion=r,this.modHash=s,this.name=E.sanitizeFileName(this.gameOpts.mapTitle+" "+(new Date).toISOString().replace(/(\.|,)\d+Z$/,"Z")),this.timestamp=Date.now()}writeEvent(...e){this.events.push(...e)}finish(e){this.endTick=e}getEvents(){return this.events}*flush(){if(!this.gameOpts)throw new Error("Game options must be set first");if(!this.engineVersion)throw new Error("Engine version is not set");if(void 0===this.modHash)throw new Error("Mod hash is not set");let e=new T.Serializer,t=this.getHeaderTag()+"\n";for(t+=`ENGINE ${this.engineVersion} ${this.modHash}
`,t+=[this.gameId,this.gameTimestamp,e.serializeOptions(this.gameOpts)].join(" ")+"\n",yield t,t="";void 0===this.endTick||this.events.length;){for(var i of this.events)t+=i.tickNo+"="+i.type+"|"+i.serialize()+"\n";this.events.length=0,yield t,t=""}t+=this.getEndTag()+" "+this.endTick+"\n",this.debugInfo&&(t+=b.Base64.encode(w.utf16ToBinaryString(this.debugInfo))+"\n"),yield t}serialize(){if(void 0===this.endTick)throw new Error("Replay is not finished");let e="";var t,i=this.events.slice();for(t of this.flush())e+=t;return this.events=i,e}async parseHeader(e){let t=0,i,r,s,a,n,o;var l;for await(l of"string"==typeof e?e.split("\n"):d.makeTextFileLineIterator(e)){if(0===t)i=this.readReplayVersion(l);else if(1===t){if(!l.match(E.engineLineRegex))throw new Error("Missing or invalid game engine version line");var c=l.split(" ");r=c[1],s=Number(i<4?"0":c[2])}else{if(2!==t)break;if(!l.match(/^\d+ \d+ .*$/))throw new Error("Missing or invalid game id/time/opts line");var[h,u,c]=l.split(" ");a=Number(h),n=Number(u),o=i<6?b.Base64.decode(c):c}t++}if(t<3)throw new Error("Bad replay header");return{replayVersion:i,engineVersion:r,modHash:s,gameId:a,gameTimestamp:n,gameOptsSerialized:o}}unserialize(e,t){let i=e.split("\n");var r=this.readReplayVersion(i.shift()||"");if(!C.includes(r))throw new Error("Unsupported replay version "+r);let s=new v.Parser,a=i.shift();if(!a||!a.match(E.engineLineRegex))throw new Error("Missing or invalid game engine version line");var[,n,o]=a.split(" ");let l=i.shift();if(!l)throw new Error("Missing game id/time/opts line");var c=l.match(/^(\d+) (\d+) (.*)$/);if(!c)throw new Error("Invalid game id/time/opts line");let[,h,u,d]=c;r<6&&(d=b.Base64.decode(d));r=s.parseOptions(d);this.init(Number(h),Number(u),r,n,Number(o)),this.name=t.name,this.timestamp=t.timestamp;let g,p=!1;for(;g=i.shift();){if(g.startsWith(this.getEndTag())){p=!0;break}var m=g.match(/^(\d+)=(\d+)\|(.+)$/);if(!m)throw new Error(`Invalid event line "${g}"`);var[,f,y,m]=m,f=Number(f),y=Number(y);let e=new S.ReplayEventFactory(s,new T.Serializer).create(y,f);e.unserialize(m),this.writeEvent(e)}if(!p)throw new Error("Incomplete replay data");o=g.match(new RegExp(`^${this.getEndTag()} (\\d+)$`));if(!o)throw new Error("Invalid end tag");this.endTick=Number(o[1]),1<=i.length&&(this.debugInfo=w.binaryStringToUtf16(b.Base64.decode(i[0])))}getHeaderTag(){return"RA2TSREPL_v"+i}readReplayVersion(e){var t=e.match(/^RA2TSREPL_v(\d+)$/);if(!t||t.length<2)throw new Error("Unknown replay format");return Number(t[1])}getEndTag(){return"END"}}),E.extension=".rpl",E.maxNameLength=128,E.engineLineRegex=/^ENGINE \d+\.\d+( \d+)?$/}}}),System.register("gui/screen/game/component/hud/viewmodel/SidebarModel",["gui/screen/game/component/hud/viewmodel/SidebarTab","game/GameSpeed"],function(t,e){"use strict";var i,r,s,a,n,o;e&&e.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){var e;(e=s=s||{})[e.Techno=0]="Techno",e[e.Special=1]="Special",t("SidebarItemTargetType",s),(e=a=a||{})[e.Idle=0]="Idle",e[e.InQueue=1]="InQueue",e[e.Started=2]="Started",e[e.OnHold=3]="OnHold",e[e.Ready=4]="Ready",t("SidebarItemStatus",a),(e=n=n||{})[e.Structures=0]="Structures",e[e.Armory=1]="Armory",e[e.Infantry=2]="Infantry",e[e.Vehicles=3]="Vehicles",t("SidebarCategory",n),t("SidebarModel",o=class{constructor(e,t){this.game=e,this.replay=t,this.powerDrained=0,this.powerGenerated=0,this.sellMode=!1,this.repairMode=!1,this.topTextLeftAlign=!1,this.tabs=[new i.SidebarTab(n.Structures),new i.SidebarTab(n.Armory),new i.SidebarTab(n.Infantry),new i.SidebarTab(n.Vehicles)],this.activeTabId=n.Structures}get activeTab(){return this.tabs[this.activeTabId]}get currentGameTime(){return Math.floor(this.game.currentTime/1e3)}get replayTime(){return this.replay?Math.floor(this.replay.endTick/r.GameSpeed.BASE_TICKS_PER_SECOND):void 0}selectTab(e){this.tabs[e].disabled||(this.activeTabId=e)}})}}}),System.register("gui/screen/game/component/hud/viewmodel/CombatantSidebarModel",["game/rules/TechnoRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/gameobject/trait/DockTrait","gui/screen/game/component/hud/viewmodel/SidebarModel","game/SuperWeapon"],function(e,t){"use strict";var c,i,h,u,d,r,s,a;t&&t.id;return{setters:[function(e){c=e},function(e){i=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){r=e}],execute:function(){s=(new Map).set(r.SuperWeaponStatus.Charging,d.SidebarItemStatus.Started).set(r.SuperWeaponStatus.Paused,d.SidebarItemStatus.OnHold).set(r.SuperWeaponStatus.Ready,d.SidebarItemStatus.Ready),a=class extends d.SidebarModel{constructor(e,t){super(t),this.player=e,this.rules=t.rules}get credits(){return Math.floor(this.player.credits)}get radarEnabled(){return!(!this.player.radarTrait||this.player.radarTrait.isDisabled())}computePurchaseCost(e){return this.game.sellTrait.computePurchaseValue(e,this.player)}updateAvailableObjects(t){if(!this.player.production)throw new Error("Player is not a combatant");var e,i,r,s=this.sortAvailableObjects(this.player.production.getAvailableObjects());for(e of this.tabs)e.items.length=0,e.needsUpdate=!0;this.updateSuperWeaponItems();for(i of s){var a=t.getObject(i.name,i.type);let e=this.tabs[this.getSidebarCategoryForQueueType(this.player.production.getQueueTypeForObject(i))];var n=this.player.production.getQueueForObject(i),o=this.player.production.getFactoryTypeForQueueType(n.type),a={target:{type:d.SidebarItemTargetType.Techno,rules:i},cameo:this.player.production.hasVeteranType(o)&&i.trainable?a.altCameo:a.cameo,disabled:!1,progress:0,quantity:0,status:d.SidebarItemStatus.Idle};e.items.push(a),this.updateSidebarTechnoItem(a,n,this.player.production)}for(r of this.tabs)this.updateTabFlashing(r);this.updateActiveTab()}updateActiveTab(){var e;0!==this.activeTab.items.length||void 0!==(e=this.tabs.find(e=>0<e.items.length)?.id)&&this.selectTab(e)}updateFromQueue(e){if(!this.player.production)throw new Error("Player is not a combatant");let t=this.tabs[this.getSidebarCategoryForQueueType(e.type)];t.needsUpdate=!0;for(var i of t.items)i.target.type===d.SidebarItemTargetType.Techno&&this.player.production.getQueueForObject(i.target.rules)===e&&this.updateSidebarTechnoItem(i,e,this.player.production);this.updateTabFlashing(t)}updateSuperWeapons(){this.updateSuperWeaponItems(),this.updateActiveTab()}updateSuperWeaponItems(){let e=this.player.superWeaponsTrait?.getAll().slice().sort((e,t)=>1e3*(e.rules.rechargeTime-t.rules.rechargeTime)+e.name.charCodeAt(0)-t.name.charCodeAt(0)),t=this.tabs[d.SidebarCategory.Armory];t.needsUpdate=!0;var i=t.items.findIndex(e=>e.target.type===d.SidebarItemTargetType.Techno);-1!==i?t.items.splice(0,i):t.items.length=0;i=e?.map(e=>{var t=s.get(e.status);if(void 0===t)throw new Error(`Unhandled super weapon status "${e.status}"`);return{target:{type:d.SidebarItemTargetType.Special,rules:e.rules},cameo:e.rules.sidebarImage,disabled:!1,progress:e.getChargeProgress(),quantity:1,status:t}});i&&t.items.unshift(...i),this.updateTabFlashing(t)}updateTabFlashing(e){e.flashing=e.items.some(e=>e.status===d.SidebarItemStatus.Ready)}updateSidebarTechnoItem(e,t,i){if(e.target.type===d.SidebarItemTargetType.Special)throw new Error("Sidebar item must be of type Techno");let r=e.target.rules,s=[...this.player.buildings],a=Number.isFinite(r.buildLimit)&&(r.type===h.ObjectType.Building?s:this.player.getOwnedObjectsByType(r.type,!0)).filter(e=>e.name===r.name).length>=r.buildLimit;this.rules.general.padAircraft.includes(r.name)&&(o=s.filter(e=>e.factoryTrait?.type===c.FactoryType.AircraftType&&e.helipadTrait).reduce((e,t)=>e+(t.traits.find(u.DockTrait)?.numberOfDocks??0),0),a=a||[...this.player.getOwnedObjectsByType(h.ObjectType.Aircraft,!0)].filter(e=>this.rules.general.padAircraft.includes(e.name)).length>=o);let n=i.getFactoryTypeForQueueType(t.type);var o=s.filter(e=>e.factoryTrait?.type===n&&!e.warpedOutTrait.isActive());let l=t.find(r);e.progress=l.length?l[0].progress:0,e.quantity=l.reduce((e,t)=>e+t.quantity,0),e.status=this.computeStatus(t,l[0]),e.disabled=1===t.maxSize&&l[0]!==t.getFirst()||a||!o.length&&(!t.currentSize||l[0]!==t.getFirst())}getTabForQueueType(e){return this.tabs[this.getSidebarCategoryForQueueType(e)]}getSidebarCategoryForQueueType(e){switch(e){case i.QueueType.Structures:return d.SidebarCategory.Structures;case i.QueueType.Armory:return d.SidebarCategory.Armory;case i.QueueType.Infantry:return d.SidebarCategory.Infantry;case i.QueueType.Vehicles:case i.QueueType.Ships:case i.QueueType.Aircrafts:return d.SidebarCategory.Vehicles;default:throw new Error("Unhandled queueType "+i.QueueType[e])}}computeStatus(e,t){return t?e.getFirst()===t?e.status===i.QueueStatus.Ready?d.SidebarItemStatus.Ready:e.status===i.QueueStatus.OnHold?d.SidebarItemStatus.OnHold:d.SidebarItemStatus.Started:d.SidebarItemStatus.InQueue:d.SidebarItemStatus.Idle}sortAvailableObjects(e){return[...e].sort((e,t)=>{var i=this.getObjectTypeSortValue(e),r=this.getObjectTypeSortValue(t);return i===r?e.aiBasePlanningSide===t.aiBasePlanningSide?e.techLevel===t.techLevel?e.prerequisite.length<t.prerequisite.length?-1:1:e.techLevel<t.techLevel?-1:1:(e.aiBasePlanningSide??-1)<(t.aiBasePlanningSide??-1)?-1:1:i-r})}getObjectTypeSortValue(e){return e.type===h.ObjectType.Aircraft?1:e.type===h.ObjectType.Vehicle?e.naval?2:e.consideredAircraft?1:0:0}},e("CombatantSidebarModel",a)}}}),System.register("gui/screen/game/component/hud/SidebarCard",["gui/jsx/jsx","gui/screen/game/component/hud/viewmodel/SidebarModel","gui/UiObject","gui/jsx/UiComponent","engine/gfx/OverlayUtils","gui/HtmlContainer","util/math","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/art/ObjectArt"],function(t,e){"use strict";var d,s,r,i,a,n,o,l,c,h,u;e&&e.id;return{setters:[function(e){d=e},function(e){s=e},function(e){r=e},function(e){i=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){var e;(e=h=h||{})[e.Ready=0]="Ready",e[e.OnHold=1]="OnHold",u=class u extends i.UiComponent{constructor(){super(...arguments),this.slotContainers=[],this.slotObjects=[],this.progressOverlays=[],this.visible=!0,this.labelObjects=[],this.quantityObjects=[],this.justCreated=!0,this.lastItemCount=0,this.pagingOffset=0,this.handleWheel=e=>{this.scrollToOffset(this.pagingOffset+(0<e.wheelDeltaY?2:-2))}}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0),e.onFrame.subscribe(()=>this.handleFrame()),this.slotOutline=new r.UiObject(this.createSlotOutline()),this.slotOutline.setVisible(!1),this.slotOutline.setZIndex((this.props.zIndex??0)+1),e.add(this.slotOutline);let t=u.labelImageCache.get(this.props.textColor);t||(t=this.createLabelImages(this.props.textColor),u.labelImageCache.set(this.props.textColor,t)),this.labelImages=t;let i=u.quantityImageCache.get(this.props.textColor);return i||(i=this.createQuantityImages(this.props.textColor),u.quantityImageCache.set(this.props.textColor,i)),this.quantityImages=i,e}defineChildren(){let{slots:e,cameoImages:i,cameoPalette:r,sidebarModel:s,onSlotClick:a,zIndex:n}=this.props;var o=this.getCameoSize();let l=3,c=2,h=[];for(let u=0;u<e;u++){let t={x:(l+o.width)*(u%2),y:(c+o.height)*Math.floor(u/2)};h.push(d.jsx("container",{x:t.x,y:t.y,zIndex:n,ref:e=>this.slotContainers.push(e),onWheel:this.handleWheel,onClick:e=>{var t=s.activeTab.items[this.getItemIndexAtSlot(u)];t&&!t.disabled&&a?.(this.createSlotClickEvent(t,e))},onMouseEnter:()=>{var e=s.activeTab.items[this.getItemIndexAtSlot(u)];e&&(e.disabled||this.slotOutline.setPosition(t.x,t.y),this.slotOutline.setVisible(!e.disabled),this.hoverSlotIndex=u)},onMouseLeave:()=>{this.hoverSlotIndex===u&&(this.slotOutline.setVisible(!1),this.hoverSlotIndex=void 0)}},d.jsx("sprite",{image:"gclock2.shp",palette:"sidebar.pal",zIndex:1,frame:0,opacity:.5,transparent:!0,ref:e=>this.progressOverlays.push(e)}),d.jsx("sprite",{images:this.labelImages,zIndex:2,x:o.width/2,transparent:!0,ref:e=>this.labelObjects.push(e)}),d.jsx("sprite",{images:this.quantityImages,zIndex:2,x:o.width,alignX:1,alignY:-1,transparent:!0,ref:e=>this.quantityObjects.push(e)}),d.jsx("sprite",{image:i,palette:r,ref:e=>this.slotObjects.push(e)})))}return h}createSlotClickEvent(e,t){return{target:e.target,button:t.button,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,isTouch:t.isTouch,touchDuration:t.touchDuration}}handleFrame(){let{sidebarModel:e,slots:t}=this.props,i=this.getUiObject().get3DObject();var r;i.visible=this.visible,(this.justCreated||e.activeTab.needsUpdate||this.lastActiveTab!==e.activeTab)&&(this.justCreated=!1,r=e.activeTab.items.length,this.lastActiveTab===e.activeTab&&this.lastItemCount===r||(this.lastItemCount>r&&(this.pagingOffset=0),this.lastItemCount=r),this.lastActiveTab=e.activeTab,e.activeTab.needsUpdate=!1,this.updateSlots(e.activeTab.items,t))}updateSlots(s,e){for(let n=0;n<e;n++){var a=s[this.getItemIndexAtSlot(n)];let e=this.slotObjects[n],t=this.progressOverlays[n],i=this.labelObjects[n],r=this.quantityObjects[n];s.length-this.pagingOffset<=n?(e.get3DObject().visible=!1,t.get3DObject().visible=!1,i.get3DObject().visible=!1,r.get3DObject().visible=!1):(this.updateCameo(a,e),this.updateProgressOverlay(a,t),this.updateStatusText(a,i),this.updateQuantities(a,r),this.updateTooltip(a,this.slotContainers[n]))}}updateCameo(e,t){let i=this.props["cameoNameToIdMap"];var r;let s=e.cameo+".shp";if(void 0===(r=i.get(s))&&(s=c.ObjectArt.MISSING_CAMEO+".shp"),void 0===(r=i.get(s)))throw new Error(`Missing cameo placeholder image "${c.ObjectArt.MISSING_CAMEO}.shp"`);t.setFrame(r),t.get3DObject().visible=!0,t.setLightMult(e.disabled?.5:1)}updateProgressOverlay(e,t){let i=0;var r;[s.SidebarItemStatus.Started,s.SidebarItemStatus.OnHold].includes(e.status)&&(r=t.getFrameCount(),i=Math.max(1,Math.ceil(e.progress*(r-1)))%r),t.setFrame(i),t.get3DObject().visible=0<i}updateStatusText(e,t){t.get3DObject().visible=[s.SidebarItemStatus.Ready,s.SidebarItemStatus.OnHold].includes(e.status),e.status===s.SidebarItemStatus.Ready?(t.setFrame(h.Ready),t.setPosition(this.getCameoSize().width/2,t.getPosition().y),t.builder.setAlign(0,-1)):e.status===s.SidebarItemStatus.OnHold&&(t.setFrame(h.OnHold),t.setPosition(1<e.quantity?0:this.getCameoSize().width/2,t.getPosition().y),t.builder.setAlign(1<e.quantity?-1:0,-1))}updateQuantities(e,t){e.quantity>(e.status===s.SidebarItemStatus.InQueue?0:1)?(t.setFrame(e.quantity>u.MAX_QUANTITY?u.MAX_QUANTITY:e.quantity-1),t.setVisible(!0)):t.setVisible(!1)}updateTooltip(t,e){let i;if(t.target.type===s.SidebarItemTargetType.Techno){let e=t.target.rules.cost;this.props.sidebarModel instanceof l.CombatantSidebarModel&&(e=this.props.sidebarModel.computePurchaseCost(t.target.rules)),i=this.props.strings.get(t.target.rules.uiName)+"\n$"+e}else{if(t.target.type!==s.SidebarItemTargetType.Special)throw new Error(`Type "${t.target.type}" not implemented`);i=this.props.strings.get(t.target.rules.uiName)}e.setTooltip(i)}getItemIndexAtSlot(e){return e+this.pagingOffset}getCameoSize(){return{width:this.props.cameoImages.width,height:this.props.cameoImages.height}}createSlotOutline(){var e=this.getCameoSize(),t=e.width,e=e.height;let i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,e,0),new THREE.Vector3(t,e,0),new THREE.Vector3(t,0,0),new THREE.Vector3(0,0,0));t=new THREE.LineBasicMaterial({color:this.props.textColor,transparent:!0,side:THREE.DoubleSide});return new THREE.Line(i,t)}hide(){this.visible=!1}show(){this.visible=!0}scrollToOffset(e){var t=this.pagingOffset,i=Math.max(0,this.props.sidebarModel.activeTab.items.length-this.props.slots);return this.pagingOffset=o.clamp(e,0,i),this.pagingOffset%2&&this.pagingOffset++,this.updateSlots(this.props.sidebarModel.activeTab.items,this.props.slots),t!==this.pagingOffset}pageDown(){return this.scrollToOffset(this.pagingOffset+this.props.slots)}pageUp(){return this.scrollToOffset(this.pagingOffset-this.props.slots)}createLabelImages(t){let e=[{text:this.props.strings.get("TXT_READY"),type:h.Ready},{text:this.props.strings.get("TXT_HOLD"),type:h.OnHold}];return e.map(e=>this.createTextBox(e.text,t))}createQuantityImages(i){let r={paddingRight:2},e=new Array(u.MAX_QUANTITY).fill(0).map((e,t)=>this.createTextBox(""+(t+1),i,r));return e.push(this.createTextBox("",i,r)),e}createTextBox(e,t,i){return a.OverlayUtils.createTextBox(e,{color:t,backgroundColor:"rgba(0, 0, 0, .5)",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,...i})}},t("SidebarCard",u),u.MAX_QUANTITY=99,u.labelImageCache=new Map,u.quantityImageCache=new Map}}}),System.register("gui/screen/game/component/hud/SidebarTabs",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent"],function(e,t){"use strict";var u,i,r,s;t&&t.id;return{setters:[function(e){u=e},function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.UiComponent{constructor(){super(...arguments),this.tabObjects=[],this.flashing=!1}createUiObject(){let e=new i.UiObject(new THREE.Object3D);return e.setPosition(this.props.x||0,this.props.y||0),e}defineChildren(){let{aggregatedImageData:e,images:t,palette:i,tabSpacing:r,onTabClick:s,sidebarModel:a,strings:n}=this.props,o=[];for(let c=0;c<4;c++){var l=t[c];const h=this.props.aggregatedImageData.imageIndexes.get(l);if(void 0===h)throw new Error(`Tab ${c} image not found in aggregated file`);o.push(u.jsx("sprite",{image:e.file,palette:i,x:(r+l.width)*c,tooltip:n.get("Tip:Tab"+(c+1)),onClick:e=>{var t;0===e.button&&((t=a.tabs[c]).disabled||s?.(t))},onFrame:(e,t)=>this.handleFrame(e,t,a.tabs[c],h)}))}return o}handleFrame(e,t,i,r){(!this.lastFlashUpdate||250<=e-this.lastFlashUpdate)&&(this.lastFlashUpdate=e,this.flashing=!this.flashing);let s;s=i.disabled?2:this.props.sidebarModel.activeTab===i?1:0,i.flashing&&this.flashing&&(s=3),t.setFrame(r+s)}},e("SidebarTabs",s)}}}),System.register("gui/screen/game/component/hud/SidebarIconButton",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject"],function(e,t){"use strict";var o,i,r,s;t&&t.id;return{setters:[function(e){o=e},function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.UiComponent{constructor(){super(...arguments),this.toggle=this.props.toggle,this.disabled=!!this.props.disabled,this.handleMouseDown=()=>{this.disabled||(void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+1),document.addEventListener("mouseup",this.onDocumentMouseUp),document.addEventListener("touchend",this.onDocumentMouseUp),document.addEventListener("touchcancel",this.onDocumentMouseUp))},this.onDocumentMouseUp=()=>{void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+0),document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}}createUiObject(){return new r.UiObject(new THREE.Object3D)}defineChildren(){let{image:e,imageFrameOffset:t,palette:i,x:r,y:s,onClick:a,tooltip:n}=this.props;return o.jsx("sprite",{image:e,palette:i,x:r,y:s,frame:this.getBaseFrameNo(t??0),onClick:e=>0===e.button&&!this.disabled&&a?.(),onMouseDown:this.handleMouseDown,tooltip:n,ref:e=>this.sprite=e})}getBaseFrameNo(e){return e+(this.disabled?2:this.toggle?1:0)}setToggleState(e){this.toggle!==e&&(this.toggle=e,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}setDisabled(e){e!==this.disabled&&(this.disabled=e,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}onDispose(){document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}},e("SidebarIconButton",s)}}}),System.register("gui/screen/game/component/hud/SidebarMenu",["gui/jsx/jsx","gui/component/MenuButton","gui/UiObject","gui/HtmlContainer","gui/jsx/HtmlView","gui/jsx/UiComponent"],function(e,t){"use strict";var n,o,i,r,l,s,a;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){i=e},function(e){r=e},function(e){l=e},function(e){s=e}],execute:function(){a=class extends s.UiComponent{createUiObject(){return new i.UiObject(new THREE.Object3D,new r.HtmlContainer)}defineChildren(){return this.props.buttons.map((e,t)=>this.createButton(e,t))}createButton(t,e){var i=this.props.buttonImg;let r={x:0,y:e*i.height};t.isBottom&&(r.y=this.props.menuHeight-i.height);var s={x:r.x,y:r.y,width:i.width,height:i.height};let a=n.createRef();return n.jsx("fragment",null,n.jsx("sprite",{image:i,palette:this.props.buttonPal,x:r.x,y:r.y,ref:a}),n.jsx(l.HtmlView,{component:o.MenuButton,props:{buttonConfig:{label:t.label,disabled:!!t.disabled},box:{x:s.x,y:s.y,width:s.width,height:s.height},onMouseDown:e=>{a.current.setFrame(1);let t=()=>{a.current.setFrame(0),document.removeEventListener("mouseup",t)};document.addEventListener("mouseup",t)},onClick:e=>{t.onClick&&t.onClick()}}}))}},e("SidebarMenu",a)}}}),System.register("gui/screen/game/component/hud/GameMenuContentArea",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","engine/gfx/SpriteUtils"],function(e,t){"use strict";var h,i,r,s,a,n;t&&t.id;return{setters:[function(e){h=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends i.UiComponent{createUiObject({viewport:e,hidden:t}){let i=new r.UiObject(new THREE.Object3D,new s.HtmlContainer);return i.setPosition(e.x,e.y),i.getHtmlContainer().setSize(e.width,e.height),i.setVisible(!t),i}defineChildren(){let{viewport:e,screenSize:t,images:i,innerRef:r}=this.props,s="lg";(t.width<1024||t.height<768)&&(s="md"),(t.width<800||t.height<600)&&(s="sm");var a=i.get(`bkgd${s}.shp`),n=a?(e.width-a.width)/2:0,o=a?(e.height-a.height)/2:0,l=(a||e).width,c=(a||e).height;return h.jsx("fragment",null,h.jsx("mesh",null,this.createMask(e)),h.jsx("container",{zIndex:1,x:n,y:o,width:l,height:c,ref:r},a&&h.jsx("sprite",{image:a,palette:"uibkgd.pal"})))}createMask(e){let t=a.SpriteUtils.createRectGeometry(e.width,e.height);t.translate(e.width/2,e.height/2,0);var i=new THREE.MeshBasicMaterial({color:0,opacity:.75,transparent:!0,side:THREE.DoubleSide});let r=new THREE.Mesh(t,i);return r.frustumCulled=!1,r}},e("GameMenuContentArea",n)}}}),System.register("gui/screen/game/component/hud/SidebarPower",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","data/Bitmap","engine/gfx/SpriteUtils","util/math","engine/gfx/TextureUtils","engine/renderable/entity/HighlightAnimRunner","util/BoxedVar","util/array","engine/gfx/material/PaletteBasicMaterial"],function(t,e){"use strict";var i,r,s,a,n,o,h,l,c,u,d,g,p,m,f;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){h=e},function(e){l=e},function(e){c=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){var e;p=(e,t)=>e.green===t.green&&e.yellow===t.yellow&&e.red===t.red,(e=m=m||{})[e.None=0]="None",e[e.Green=1]="Green",e[e.Yellow=2]="Yellow",e[e.Red=3]="Red",e[e.Highlight=4]="Highlight",f=class extends s.UiComponent{constructor(){super(...arguments),this.visible=!0,this.pipHighlightAnimRunner=new c.HighlightAnimRunner(new u.BoxedVar(1),1,2,15)}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new a.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0),this.pips=this.createPips(this.props.powerImg);var t=this.props.powerImg.width,i=this.props.height;return this.textureBitmap=new n.IndexedBitmap(t,i),this.texture=this.createDataTexture(this.textureBitmap.data,t,i),this.mesh=this.createMesh(t,i),e}createPips(e){let t=[];for(let r=0;r<e.numImages;r++){var i=e.getImage(r);t.push(new n.IndexedBitmap(i.width,i.height,i.imageData))}return t}createDataTexture(e,t,i){let r=new THREE.DataTexture(e,t,i,THREE.AlphaFormat);return r.needsUpdate=!0,r.minFilter=THREE.NearestFilter,r.magFilter=THREE.NearestFilter,r}createMesh(e,t){let i=o.SpriteUtils.createRectGeometry(e,t);o.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new g.PaletteBasicMaterial({map:this.texture,palette:l.TextureUtils.textureFromPalette(this.props.palette),side:THREE.DoubleSide});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex,ref:e=>this.meshEvtTarget=e,onClick:()=>{}},this.mesh)}onFrame(e){let t=this.getUiObject().get3DObject();t.visible=this.visible;var i=this.props["sidebarModel"],r=i.powerDrained,i=i.powerGenerated;let s=!1;this.lastPowerDrained===r&&this.lastPowerGenerated===i||(this.lastPowerDrained=r,this.lastPowerGenerated=i,this.meshEvtTarget.setTooltip(this.props.strings.get("TXT_POWER_DRAIN",i,r)),a=(c=Math.max(i,r))?Math.min(1,r/c):1,l=c?Math.min(1,h.clamp(i-r,0,100)/c):0,o=this.pips[0].height+1,n=c?this.computeHeightFromPowerLevel(Math.max(100,c)):1,this.targetPipCount={green:Math.floor((1-a-l)*n/o),yellow:Math.floor(l*n/o),red:c?Math.floor(a*n/o):1},this.pipHighlightAnimRunner.animation.stop(),s=!0);var a,n,o,l=this.targetPipCount,c=this.pipCount&&p(this.pipCount,l);this.lastPipUpdate&&!(50<=e-this.lastPipUpdate)||c||(this.lastPipUpdate=e,this.pipCount?(a=Math.sign(l.red-this.pipCount.red),n=Math.sign(l.yellow-this.pipCount.yellow),o=Math.sign(l.green-this.pipCount.green),a?0<a&&(this.pipCount.yellow>a?this.pipCount.yellow=Math.max(0,this.pipCount.yellow-a):this.pipCount.green=Math.max(0,this.pipCount.green-a)):(n?0<n&&(this.pipCount.green=Math.max(0,this.pipCount.green-n)):this.pipCount.green+=o,this.pipCount.yellow+=n),this.pipCount.red+=a):this.pipCount={red:1,yellow:0,green:0},this.updateTexture(this.pipCount,!0),p(this.pipCount,l)&&this.pipHighlightAnimRunner.animate(10)),c&&(s&&this.pipHighlightAnimRunner.animate(10),this.pipHighlightAnimRunner.shouldUpdate()&&(l=!!this.pipHighlightAnimRunner.getValue(),this.pipHighlightAnimRunner.tick(e),(c=!!this.pipHighlightAnimRunner.getValue())!=l&&this.updateTexture(this.pipCount,c)))}computeHeightFromPowerLevel(e){return h.clamp((Math.log10((e/100+5)/5e7)/(e/100+3)+2)/2,0,1)*this.props.height}updateTexture(e,t){var i,r=this.pips[0].height,s=this.props.height,a=r+1;let n=[[[m.None,Math.floor(s/r),r]],[[m.Red,e.red,a],[m.Yellow,e.yellow,a],[m.Green,e.green,a]]];if(t){let e=d.findReverse(n[1],([,e])=>0<e);e&&e[1]--,n[1].push([m.Highlight,1,a])}for(i of n){let t=s-r;for(var[o,l,c]of i){var h=this.pips[o];for(let e=0;e<l;e++)this.textureBitmap.drawIndexedImage(h,0,t),t-=c}}this.texture.needsUpdate=!0}hide(){this.visible=!1}show(){this.visible=!0}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},t("SidebarPower",f)}}}),System.register("gui/component/UiText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(e,t){"use strict";var i,s,r,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends r.UiComponent{constructor(){super(...arguments),this.value=this.props.value,this.textAlign=this.props.textAlign}createUiObject(){let e=new s.UiObject(new THREE.Object3D,new a.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let r=document.createElement("canvas");return r.width=t,r.height=i,this.ctx=r.getContext("2d",{alpha:!0}),this.texture=this.createTexture(r),this.updateTexture(this.value,this.textAlign,this.props.textColor),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=n.SpriteUtils.createRectGeometry(e,t);n.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex,onClick:this.props.onClick},this.mesh)}updateTexture(e,t,i){this.ctx.clearRect(0,0,this.props.width,this.props.height),o.CanvasUtils.drawText(this.ctx,e,0,0,{color:i,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,textAlign:t??"center",width:this.props.width,height:this.props.height}),this.texture.needsUpdate=!0}setValue(e){this.value!==e&&(this.value=e,this.updateTexture(e,this.textAlign,this.props.textColor))}setTextAlign(e){e!==this.textAlign&&(this.textAlign=e,this.updateTexture(this.value,e,this.props.textColor))}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("UiText",l)}}}),System.register("gui/screen/game/component/hud/SidebarCredits",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText"],function(e,t){"use strict";var s,i,r,a,n,o;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends r.UiComponent{createUiObject(){return new i.UiObject(new THREE.Object3D,new a.HtmlContainer)}defineChildren(){var{textColor:e,width:t,height:i,zIndex:r}=this.props;return s.jsx(n.UiText,{ref:e=>this.text=e,value:"",textColor:e,width:t,height:i,zIndex:r})}onFrame(e){var{sidebarModel:{credits:t,topTextLeftAlign:i}}=this.props;this.targetCredits!==t&&(this.targetCredits=t,s=Math.abs(t-(this.renderedCredits??0)),r=THREE.Math.lerp(300,2e3,Math.min(1,s/5e3)),this.tickSpeed=s/r);var r,s=this.tickSpeed;(!this.lastUpdate||50<=e-this.lastUpdate)&&(r=this.lastUpdate?e-this.lastUpdate:0,this.lastUpdate=e,this.renderedCredits!==t&&(void 0===this.renderedCredits?this.renderedCredits=0:(t=t-this.renderedCredits,r=s*r,this.renderedCredits+=Math.abs(t)>=r?Math.sign(t)*r:t,this.props.onTick(1===Math.sign(t)?"up":"down")),this.text.setValue(""+Math.floor(this.renderedCredits))),i!==this.lastLeftAligned&&(i?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=i))}},e("SidebarCredits",o)}}}),System.register("gui/screen/game/component/hud/SidebarRadarAnimRunner",["data/IniSection","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],function(t,e){"use strict";var i,r,s,a,n,o,l;e&&e.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){var e;(e=o=o||{})[e.None=0]="None",e[e.RadarOff=1]="RadarOff",e[e.RadarOn=2]="RadarOn",t("AnimationType",o),t("SidebarRadarAnimationRunner",l=class{constructor(e){this.shpFile=e,this.closed=!0,this.currentAnimationType=o.None}radarOff(){this.currentAnimationType=o.RadarOff,this.initAnimation()}radarOn(){this.currentAnimationType=o.RadarOn,this.initAnimation()}initAnimation(){var e=new i.IniSection(""),e=new s.AnimProps(e,this.shpFile),e=new r.Animation(e,new n.BoxedVar(a.Engine.UI_ANIM_SPEED));this.animation=e}tick(e){let t=this.animation;var i=this.currentAnimationType;if(t&&i!==o.None){switch(t.getState()){case r.AnimationState.STOPPED:break;case r.AnimationState.NOT_STARTED:t.start(e);case r.AnimationState.RUNNING:default:t.update(e)}t.getState()===r.AnimationState.STOPPED&&(this.closed=i===o.RadarOff,this.currentAnimationType=o.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===o.None}getCurrentFrame(){if(!this.animation)return 0;let e=this.currentAnimationType===o.RadarOff?-1:1;this.currentAnimationType===o.None&&this.closed&&(e*=-1);let t=0;return-1===e&&(t=this.animation.props.end),t+e*this.animation.getCurrentFrame()}})}}}),System.register("engine/renderable/entity/map/MinimapModel",["game/map/MapShroud"],function(e,t){"use strict";var r,n,o,l,c,h,u,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){n=new THREE.Color("rgb(173, 170, 132)"),o=new Map([["CAKRMW",new THREE.Color("rgb(107, 69, 49)")],["CAFNCW",new THREE.Color(16777215)],["CAFNCB",new THREE.Color(0)],["GASAND",new THREE.Color("rgb(82, 77, 57)")]]),l=new THREE.Color("rgb(90, 89, 82)"),c=new THREE.Color(0),h=new THREE.Color("rgb(173, 170, 132)"),u=new THREE.Color(0),e("MinimapModel",i=class{constructor(e,t,i,r,s,a){this.tiles=e,this.tileOccupation=t,this.shroud=i,this.localPlayer=r,this.alliances=s,this.paradropRules=a;var n=this.tiles.getMapSize();this.stride=n.width,this.tileColors=new Uint32Array(n.width*n.height),this.aboveShroudTiles=new Uint8Array(n.width*n.height),this.tileWithTechnos=new Uint8Array(n.width*n.height)}computeAllColors(){this.updateColors(this.tiles.getAll())}updateColors(e){for(var r of e){let e=-1,t;for(var s of this.tileOccupation.getObjectsOnTile(r)){var a;!((s.isTechno()||s.isOverlay()||s.isTerrain())&&!s.radarInvisible||s.isOverlay()&&s.isBridge()||s.isBuilding()&&!s.rules.invisibleInGame&&(!s.radarInvisible||s.rules.canBeOccupied&&s.owner.isCombatant()))||(a=4*Number(s.isTechno())+2*Number(s.isAircraft())+Number(s.name!==this.paradropRules.paradropPlane))>e&&(e=a,t=s)}let i;if(t)if((t.isTechno()||t.isOverlay())&&t.rules.wall)i=o.get(t.name)??l;else if(t.isBuilding()&&t.isDestroyed&&t.rules.leaveRubble)i=c;else if(t.isTechno())if(t.cloakableTrait?.isCloaked()&&this.localPlayer&&!this.alliances.haveSharedIntel(this.localPlayer,t.owner))i=void 0;else{let e=(t.isInfantry()||t.isVehicle())&&t.disguiseTrait?.getDisguise();i=this.localPlayer&&e&&!this.alliances.haveSharedIntel(this.localPlayer,t.owner)&&!this.localPlayer.sharedDetectDisguiseTrait?.has(t)?e.owner?new THREE.Color(e.owner.color.asHex()):n:new THREE.Color(t.owner.color.asHex())}else if(t.isTerrain())i=n;else{if(!t.isOverlay())return;i=t.isTiberium()?h:u}i=i||this.tiles.getTileRadarColor(r);r=r.rx+r.ry*this.stride;this.tileColors[r]=i.getHex(),this.aboveShroudTiles[r]=t?.name===this.paradropRules.paradropPlane?1:0,this.tileWithTechnos[r]=t?.isTechno()?1:0}}getTileColor(e){var t=e.rx+e.ry*this.stride;if(this.shroud?.getShroudType(e)===r.ShroudType.Unexplored&&!this.aboveShroudTiles[t])return"#000000";let i=new THREE.Color(this.tileColors[t]);return this.shroud?.isFlagged(e,r.ShroudFlag.Darken)&&!this.tileWithTechnos[t]&&i.multiplyScalar(.35),"#"+i.getHexString()}})}}}),System.register("engine/renderable/entity/map/MinimapRenderer",["game/Coords"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("MinimapRenderer",i=class{constructor(e,t,i,r,s){this.map=e,this.minimapModel=t,this.borderColor=r,this.canvasRenderScale=s;var a=this.map.mapBounds.getRawLocalSize();this.dxySize={x:2*a.x,y:2*a.y+4,width:2*a.width,height:2*a.height+8};a=this.dxySize.height/this.dxySize.width;this.canvasSize=this.computeCanvasSize(i,a)}computeCanvasSize(e,t){var i=e.width,r=e.height;let s;return s=r/i<=t?{width:Math.floor(r/t),height:r}:{width:i,height:Math.floor(i*t)},s}renderFull(){if(this.canvas)this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvasRenderScale*this.canvasSize.width,this.canvasRenderScale*this.canvasSize.height);else{let e=this.canvas=document.createElement("canvas");e.width=this.canvasRenderScale*this.canvasSize.width,e.height=this.canvasRenderScale*this.canvasSize.height;let t=this.ctx=e.getContext("2d",{alpha:!1});t.translate(.5,.5)}return this.renderTiles(this.map.tiles.getAll(),!0),this.canvas}renderIncremental(e){let t=new Set(e);for(var i of e){let e=this.map.tiles.getAllNeighbourTiles(i);e.forEach(e=>t.add(e))}this.renderTiles(t)}renderTiles(e,t=!1){var i,r=this.canvasSize.width/this.dxySize.width/o.Coords.COS_ISO_CAMERA_BETA;const s=this.ctx;if(!s)throw new Error("Must do a full render before re-rendering any individual tiles.");s.imageSmoothingEnabled=!1,s.save(),s.rotate(o.Coords.ISO_CAMERA_BETA),s.scale(r,r);for(i of e){var a,n=this.minimapModel.getTileColor(i);!n||t&&"#000000"===n||(s.fillStyle=n,{x:a,y:n}=this.tileToLocalRxyOrigin(i),s.fillRect(this.canvasRenderScale*a,this.canvasRenderScale*n,this.canvasRenderScale+.5,this.canvasRenderScale+.5))}s.restore(),s.strokeStyle=this.borderColor,s.lineWidth=this.canvasRenderScale,s.strokeRect(0,0,s.canvas.width-this.canvasRenderScale,s.canvas.height-this.canvasRenderScale)}tileToLocalRxyOrigin(e){var t=this.dxyToLocalRxy(this.dxySize.x,this.dxySize.y);return{x:e.rx-t.x,y:e.ry-this.map.mapBounds.getFullSize().width/2-t.y}}dxyToLocalRxy(e,t){return{x:(e+t)/2,y:(t-e)/2}}dxyToCanvas(e,t){var i=this.canvasSize.width/this.dxySize.width;return{x:(e-this.dxySize.x)*i,y:(t-this.dxySize.y)*i}}canvasToDxy(e,t){var i=this.canvasSize.width/this.dxySize.width;return{x:e/i+this.dxySize.x,y:t/i+this.dxySize.y}}})}}}),System.register("gui/screen/game/component/MinimapPing",["gui/UiObject"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.UiObject{constructor(e,t,i){super(),this.radarRules=e,this.colorLerpFactor=0,this.hiColor=new THREE.Color(t),this.lowColor=new THREE.Color(i),this.matHiColor=this.hiColor.clone(),this.matLowColor=this.lowColor.clone();var r=e.eventMinRadius;let s=this.createPingRectLine(r,r,this.matHiColor,this.matLowColor);s.name="minimap_ping",s.scale.x=15,s.scale.y=15,this.set3DObject(s),this.get3DObject().matrixAutoUpdate=!0}createPingRectLine(e,t,i,r){let s=new THREE.Geometry,a=[new THREE.Vector3(-.5*e,-.5*t,0),new THREE.Vector3(-.5*e,.5*t,0),new THREE.Vector3(.5*e,.5*t,0),new THREE.Vector3(.5*e,-.5*t,0)],n=[i,r];a.forEach((e,t)=>{s.vertices.push(e,a[(t+1)%a.length]),s.colors.push(n[t%2],n[(t+1)%2])});var o=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,side:THREE.DoubleSide});return new THREE.LineSegments(s,o)}get3DObject(){return super.get3DObject()}update(e){super.update(e),this.lastUpdate||(this.lastUpdate=e);var t=(e-this.lastUpdate)/1e3*60;this.lastUpdate=e;let i=this.get3DObject();var r=this.radarRules.eventSpeed/this.radarRules.eventMinRadius;i.scale.x=Math.max(1,i.scale.x-r*t),i.scale.y=Math.max(1,i.scale.y-r*t),i.rotation.z=i.rotation.z+this.radarRules.eventRotationSpeed*t,1===i.scale.x&&(i.rotation.z=Math.min(i.rotation.z,Math.floor(i.rotation.z/(Math.PI/2))*Math.PI/2)),this.colorLerpFactor=(this.colorLerpFactor+this.radarRules.eventColorSpeed*t)%2;t=Math.min(1,this.colorLerpFactor)-Math.max(0,this.colorLerpFactor-1);this.matHiColor.copy(this.hiColor).lerp(this.lowColor,t),this.matLowColor.copy(this.lowColor).lerp(this.hiColor,t),i.geometry.colorsNeedUpdate=!0}destroy(){super.destroy(),this.get3DObject().material.dispose(),this.get3DObject().geometry.dispose()}},e("MinimapPing",r)}}}),System.register("gui/screen/game/component/Minimap",["gui/UiObject","engine/gfx/SpriteUtils","util/geometry","engine/renderable/entity/map/MinimapRenderer","engine/util/MapTileIntersectHelper","engine/IsoCoords","util/disposable/CompositeDisposable","util/event","game/event/EventType","gui/screen/game/component/MinimapPing","game/rules/general/RadarRules","engine/renderable/entity/map/MinimapModel","game/GameSpeed"],function(e,t){"use strict";var i,n,a,o,r,l,s,c,h,u,d,g,p,m,f;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){r=e},function(e){l=e},function(e){s=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=new Map([[d.RadarEventType.EnemyObjectSensed,{high:16776960,low:8684544}],[d.RadarEventType.GenericNonCombat,{high:65535,low:33924}]]),f=class extends i.UiObject{constructor(e,t,i,r){super(new THREE.Object3D),this.game=e,this.localPlayer=t,this.borderColor=i,this.radarRules=r,this.disposables=new s.CompositeDisposable,this.tilesForRecalc=new Set,this.tilesForRedraw=new Set,this.needsFullRedraw=!1,this.pings=[],this._onClick=new c.EventDispatcher,this._onRightClick=new c.EventDispatcher,this._onMouseOver=new c.EventDispatcher,this._onMouseMove=new c.EventDispatcher,this._onMouseOut=new c.EventDispatcher,this.handleTileUpdate=({tiles:e})=>{e.forEach(e=>{this.tilesForRecalc.add(e),this.tilesForRedraw.add(e)})},this.handleShroudUpdate=(e,i)=>{"incremental"===e.type?e.coords.forEach(e=>{var t;for(t of i.findTilesAtShroudCoords(e,this.map.tiles))this.tilesForRedraw.add(t)}):this.needsFullRedraw=!0},this.handleObjectChange=e=>{e.target.isSpawned&&this.map.tileOccupation.calculateTilesForGameObject(e.target.tile,e.target).forEach(e=>{this.tilesForRecalc.add(e),this.tilesForRedraw.add(e)})},this.handleRadarEvent=t=>{if(t.target===this.localPlayer){var i=this.minimapRenderer.dxyToCanvas(t.tile.dx,t.tile.dy),r=m.get(t.radarEventType);let e=new u.MinimapPing(this.radarRules,r?.high??16711935,r?.low??8650884);e.setPosition(this.wrapperObj.position.x+i.x,this.wrapperObj.position.y+i.y),this.pings.push({obj:e,startTime:void 0,duration:this.radarRules.getEventVisibilityDuration(t.radarEventType)})}},this.minimapModel=new g.MinimapModel(e.map.tiles,e.map.tileOccupation,this.localPlayer&&e.mapShroudTrait.getPlayerShroud(this.localPlayer),this.localPlayer,this.game.alliances,this.game.rules.general.paradrop)}get onClick(){return this._onClick.asEvent()}get onRightClick(){return this._onRightClick.asEvent()}get onMouseOver(){return this._onMouseOver.asEvent()}get onMouseMove(){return this._onMouseMove.asEvent()}get onMouseOut(){return this._onMouseOut.asEvent()}get map(){return this.game.map}setFitSize(e){var t=this.fitSize;(this.fitSize=e).width===t?.width&&e.height===t?.height||this.forceRerender()}forceRerender(){var e,t,i,r;this.wrapperObj&&this.fitSize&&(this.get3DObject().remove(this.wrapperObj),this.destroyMesh(),{mesh:e,texture:t,wrapperObj:i,canvasLayoutSize:r}=this.renderMinimap(this.fitSize),this.mesh=e,this.texture=t,this.wrapperObj=i,this.size=r,this.get3DObject().add(i),this.setupListeners(this.mesh),this.lastViewport=void 0)}initWorld(e){this.worldScene=e,this.mapTileIntersectHelper=new r.MapTileIntersectHelper(this.map,e)}create3DObject(){if(super.create3DObject(),!this.mesh){var e=this.fitSize;if(!e)throw new Error("setFitSize must be called before first render");var{mesh:t,texture:i,wrapperObj:r,canvasLayoutSize:e}=this.renderMinimap(e);if(this.mesh=t,this.texture=i,this.wrapperObj=r,this.size=e,this.get3DObject().add(r),this.setupListeners(this.mesh),this.map.tileOccupation.onChange.subscribe(this.handleTileUpdate),this.disposables.add(()=>this.map.tileOccupation.onChange.unsubscribe(this.handleTileUpdate)),this.localPlayer){let e=this.game.mapShroudTrait.getPlayerShroud(this.localPlayer);e&&(e.onChange.subscribe(this.handleShroudUpdate),this.disposables.add(()=>e?.onChange.unsubscribe(this.handleShroudUpdate)))}this.disposables.add(this.game.events.subscribe(h.EventType.ObjectOwnerChange,this.handleObjectChange),this.game.events.subscribe(h.EventType.ObjectDisguiseChange,this.handleObjectChange),this.game.events.subscribe(h.EventType.ObjectDestroy,e=>{var t;!e.target.isBuilding()||(t=e.target).rules.leaveRubble&&this.map.tileOccupation.calculateTilesForGameObject(t.tile,t).forEach(e=>{this.tilesForRecalc.add(e),this.tilesForRedraw.add(e)})}),this.game.events.subscribe(h.EventType.RadarEvent,this.handleRadarEvent))}}renderMinimap(e){this.minimapRenderer=new o.MinimapRenderer(this.map,this.minimapModel,e,this.borderColor,2),this.minimapModel.computeAllColors();var t=this.minimapRenderer.renderFull(),i={width:.5*t.width,height:.5*t.height},r=this.computeMinimapPosition(e,i),s=this.createTexture(t),t=this.createMesh(s,i.width,i.height);let a=new THREE.Object3D;return a.matrixAutoUpdate=!1,a.position.x=r.x,a.position.y=r.y,a.updateMatrix(),a.add(t),{mesh:t,texture:s,wrapperObj:a,canvasLayoutSize:i}}computeMinimapPosition(e,t){return{x:Math.floor((e.width-t.width)/2),y:Math.floor((e.height-t.height)/2)}}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t,i){let r=n.SpriteUtils.createRectGeometry(t,i);n.SpriteUtils.addRectUvs(r,{x:0,y:0,width:t,height:i},{width:t,height:i}),r.translate(t/2,i/2,0);var s=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});let a=new THREE.Mesh(r,s);return a.matrixAutoUpdate=!1,a.frustumCulled=!1,a}setupListeners(e){if(!this.pointerEvents)throw new Error("Must call setPointerEvents before rendering");this.disposables.add(this.pointerEvents.addEventListener(e,"click",e=>{var t=this.computeIntersectionTile(e.intersection.uv);t&&(2===e.button||e.isTouch?this._onRightClick.dispatch(this,t):0===e.button&&this._onClick.dispatch(this,t))}),this.pointerEvents.addEventListener(e,"mouseover",()=>this._onMouseOver.dispatch(this)),this.pointerEvents.addEventListener(e,"mousemove",e=>this.queuedHoverUv=e.intersection.uv),this.pointerEvents.addEventListener(e,"mouseout",()=>this._onMouseOut.dispatch(this)))}computeIntersectionTile(e){return this.canvasCoordsToTile(e.x*this.size.width,e.y*this.size.height)}canvasCoordsToTile(e,t){let i=this.minimapRenderer.canvasToDxy(e,t);return i.x=Math.round(i.x),i.y=Math.round(i.y),this.map.tiles.getByDisplayCoords(i.x,i.y+(i.x%2-i.y%2))}update(t){if(super.update(t),!this.lastCanvasUpdate||t-this.lastCanvasUpdate>=1e3/30){if(this.tilesForRecalc.size&&(this.minimapModel.updateColors(this.tilesForRecalc),this.tilesForRecalc.clear()),this.needsFullRedraw&&(this.minimapRenderer.renderFull(),this.texture.needsUpdate=!0,this.needsFullRedraw=!1,this.tilesForRedraw.clear()),this.tilesForRedraw.size&&(this.lastCanvasUpdate=t,this.minimapRenderer.renderIncremental(this.tilesForRedraw),this.texture.needsUpdate=!0,this.tilesForRedraw.clear()),this.worldScene){var e=this.worldScene.cameraPan.getPan(),i=this.worldScene.viewport,r=!this.lastViewport||!a.rectEquals(i,this.lastViewport);if(!a.pointEquals(e,this.lastPan)||r){this.lastPan=e,this.lastViewport=i;var s=this.mapTileIntersectHelper.getTileAtScreenPoint({x:i.x+i.width/2,y:i.y+i.height/2});if(!s)return void console.warn("Current pan intersects no map tile");i=l.IsoCoords.screenToScreenTile(i.width/2,i.height/2),s={x:s.dx-i.x,y:s.dy-i.y,width:2*i.x,height:2*i.y};this.viewportOutline&&!r||(i=this.minimapRenderer.dxyToCanvas(s.x,s.y),i={width:(r=this.minimapRenderer.dxyToCanvas(s.x+s.width,s.y+s.height)).x-i.x,height:r.y-i.y},this.viewportOutline?this.updateOutlineSize(this.viewportOutline,i.width,i.height):(this.viewportOutline=this.createViewportOutline(i.width,i.height),this.viewportOutline.matrixAutoUpdate=!1,this.wrapperObj.add(this.viewportOutline)));s=this.minimapRenderer.dxyToCanvas(s.x,s.y);this.viewportOutline.position.x=Math.max(2,Math.floor(s.x)),this.viewportOutline.position.y=Math.max(1,Math.floor(s.y)),this.viewportOutline.updateMatrix()}}this.queuedHoverUv&&((s=this.computeIntersectionTile(this.queuedHoverUv))&&this._onMouseMove.dispatch(this,s),this.queuedHoverUv=void 0),this.pings.forEach(e=>{e.startTime?t-e.startTime>e.duration/(p.GameSpeed.BASE_TICKS_PER_SECOND/1e3*this.game.speed.value)&&(this.remove(e.obj),e.obj.destroy(),this.pings.splice(this.pings.indexOf(e),1)):(e.startTime=t,this.add(e.obj))})}}createViewportOutline(e,t){let i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,t,0),new THREE.Vector3(e,t,0),new THREE.Vector3(e,0,0),new THREE.Vector3(0,0,0));var r=new THREE.LineBasicMaterial({color:this.borderColor,transparent:!0,side:THREE.DoubleSide});return new THREE.Line(i,r)}updateOutlineSize(e,t,i){let r=e.geometry;r.vertices[1].set(0,i,0),r.vertices[2].set(t,i,0),r.vertices[3].set(t,0,0),r.verticesNeedUpdate=!0}destroy(){super.destroy(),this.destroyMesh(),this.disposables.dispose()}destroyMesh(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.texture?.dispose(),this.destroyViewportOutline()}destroyViewportOutline(){this.viewportOutline&&(this.wrapperObj?.remove(this.viewportOutline),this.viewportOutline.geometry.dispose(),this.viewportOutline.material.dispose(),this.viewportOutline=void 0)}},e("Minimap",f)}}}),System.register("gui/screen/game/component/hud/SidebarRadar",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/screen/game/component/hud/SidebarRadarAnimRunner"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends s.UiComponent{constructor(){super(...arguments),this.visible=!0,this.coverOpen=!1}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new a.HtmlContainer);return e.setPosition(this.props.x||0,this.props.y||0),e}defineChildren(){return i.jsx("fragment",null,i.jsx("sprite",{image:this.props.image,palette:this.props.palette,zIndex:this.props.zIndex,ref:e=>this.cover=e,animationRunner:new n.SidebarRadarAnimationRunner(this.props.image)}),i.jsx("container",{ref:e=>this.minimapContainer=e,hidden:!0,x:13}))}onFrame(e){let t=this.getUiObject().get3DObject();t.visible=this.visible;var i=this.props["sidebarModel"],i=i?.radarEnabled??!0;i!==this.coverOpen&&(this.toggleCover(i),this.coverOpen=i);let r=this.cover.getAnimationRunner();r.isStopped()&&this.minimapContainer.setVisible(this.coverOpen)}toggleCover(e){let t=this.cover.getAnimationRunner();e?t.radarOn():t.radarOff(),this.minimapContainer.setVisible(!1)}setMinimap(e){this.minimap&&this.minimapContainer.remove(this.minimap),(this.minimap=e)&&(e.setFitSize(this.getMinimapAvailSpace()),this.minimapContainer.add(e),e.setZIndex(this.props.zIndex+1))}getMinimapAvailSpace(){return{width:this.props.image.width-13-15,height:this.props.image.height}}hide(){this.visible=!1}show(){this.visible=!0}},e("SidebarRadar",o)}}}),System.register("gui/screen/game/component/hud/SidebarGameTime",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText","util/format"],function(e,t){"use strict";var s,i,r,a,n,o,l;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends r.UiComponent{createUiObject(){return new i.UiObject(new THREE.Object3D,new a.HtmlContainer)}defineChildren(){var{textColor:e,width:t,height:i,zIndex:r}=this.props;return s.jsx(n.UiText,{ref:e=>this.text=e,value:"",textColor:e,width:t,height:i,zIndex:r})}onFrame(e){var{sidebarModel:{currentGameTime:t,replayTime:i,topTextLeftAlign:r}}=this.props;(!this.lastUpdate||50<=e-this.lastUpdate)&&(this.lastUpdate=e,this.lastGameTime!==t&&(this.text.setValue(o.formatTimeDuration(t)+(i?" / "+o.formatTimeDuration(i):"")),this.lastGameTime=t),r!==this.lastLeftAligned&&(r?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=r))}},e("SidebarGameTime",l)}}}),System.register("gui/screen/game/component/hud/viewmodel/MessageList",["util/event"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("MessageList",i=class{constructor(e,t,i){this.messageDurationSeconds=e,this.maxMessages=t,this.localPlayer=i,this.isComposing=!1,this.messages=[],this._onNewMessage=new r.EventDispatcher}get onNewMessage(){return this._onNewMessage.asEvent()}addUiFeedbackMessage(e){var t={text:e,color:this.localPlayer?.color.asHexString()??"grey",time:Date.now(),animate:!1};this.messages.push(t),this._onNewMessage.dispatch(this,t)}addSystemMessage(e,t,i){var r={text:e,color:"string"==typeof t?t:t.color.asHexString(),time:Date.now(),animate:!0,durationSeconds:i};this.messages.push(r),this._onNewMessage.dispatch(this,r)}addChatMessage(e,t){var i={text:e,color:t,time:Date.now(),animate:!0};this.messages.push(i),this._onNewMessage.dispatch(this,i)}prune(){let t=Date.now();this.messages=this.messages.filter(e=>e.time>=t-1e3*(e.durationSeconds??this.messageDurationSeconds)),this.messages.splice(0,this.messages.length-this.maxMessages)}getAll(){return this.messages}})}}}),System.register("gui/screen/game/component/hud/HudChat",["gui/component/ChatInput","network/gservConfig","react"],function(e,t){"use strict";var n,o,l;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){e("HudChat",({messageList:e,chatHistory:t,strings:i,onSubmit:r,onCancel:s})=>{if(!e.isComposing)return null;var a=e.localPlayer?.color.asHexString()??"white";return l.default.createElement(n.ChatInput,{chatHistory:t,channels:[o.RECIPIENT_ALL,o.RECIPIENT_TEAM],className:"game-chat-input",forceColor:a,noCycleHint:!0,submitEmpty:!0,strings:i,onKeyDown:e=>{"Escape"===e.key&&e.preventDefault(),e.stopPropagation(),e.nativeEvent.stopImmediatePropagation()},onKeyUp:e=>{e.stopPropagation(),e.nativeEvent.stopImmediatePropagation()},onSubmit:e=>{e.value.length?r(e):s()},onCancel:s,onBlur:s})})}}}),System.register("gui/screen/game/component/hud/Messages",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","gui/jsx/HtmlView","gui/screen/game/component/hud/HudChat","network/chat/ChatMessage","network/gservConfig"],function(e,t){"use strict";var i,s,r,a,n,o,l,c,h,u,d;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends r.UiComponent{createUiObject(){let e=new s.UiObject(new THREE.Object3D,new a.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let r=document.createElement("canvas");return r.width=t,r.height=i,this.ctx=r.getContext("2d",{alpha:!0}),this.texture=this.createTexture(r),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=n.SpriteUtils.createRectGeometry(e,t);n.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("fragment",null,i.jsx("container",{hidden:!0,ref:e=>this.inputContainer=e},i.jsx(l.HtmlView,{component:c.HudChat,props:{strings:this.props.strings,messageList:this.props.messages,chatHistory:this.props.chatHistory,onSubmit:this.props.onMessageSubmit,onCancel:this.props.onMessageCancel},innerRef:e=>this.inputComponent=e})),i.jsx("mesh",{zIndex:this.props.zIndex},this.mesh))}onFrame(e){var t,i,r,s,a;(!this.lastUpdate||e-this.lastUpdate>=1e3/30)&&(this.lastUpdate=e,this.props.messages.prune(),t=this.props.messages.getAll(),i=Date.now(),r=t[t.length-1]?.time,s=t.length,a=this.props.messages.isComposing,(this.lastComposing!==a||this.lastMessageTime!==r||s!==this.lastMessageCount||r&&i-r<=2e3)&&(this.lastMessageTime=r,this.lastMessageCount=s,this.lastComposing=a,this.drawMessages(a,t,i),this.inputContainer.setVisible(a),this.inputComponent.refresh()))}drawMessages(e,t,i){this.ctx.clearRect(0,0,this.props.width,this.props.height);var r=Math.floor(110*this.props.width/600);let s=!1;var a,n;let o=0;e&&(o=20,(a=this.props.chatHistory.lastComposeTarget.value).type===h.ChatRecipientType.Channel&&a.name===u.RECIPIENT_ALL||(t=[{color:"gray",text:this.props.strings.get("TS:ChatCycleHint","Tab"),animate:!1,time:Date.now()},...t]));for(n of t){var l,c=Math.min(1e3,10*n.text.length),c=n.animate?Math.min(1,(i-n.time)/c):1;let e=Math.round(c*n.text.length);c<1&&(s=!0);for(l of this.wrapText(n.text,r))l.length>e?(l=l.slice(0,e),e=0):e-=l.length,o+=this.drawLine(l,n.color,o)}this.texture.needsUpdate=!0,s&&this.props.onMessageTick?.()}drawLine(e,t,i){return o.CanvasUtils.drawText(this.ctx,e,0,i,{color:t,...{fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:13,fontWeight:"500",paddingTop:5,height:20,backgroundColor:"rgba(0, 0, 0, .75)"},paddingLeft:4,paddingRight:4}).height}wrapText(t,i){let r=[];for(;t.length>i;){let e=t.slice(0,i).search(/\s[^\s]*$/);-1!==e&&0!==e||(e=Math.min(t.length,i)),r.push(t.substr(0,e)),t=t.slice(e)}return t.length&&r.push(t),r}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("Messages",d)}}}),System.register("gui/screen/game/component/hud/SuperWeaponTimers",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/GameSpeed","util/format"],function(e,t){"use strict";var i,s,r,a,n,o,y,T,l;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){y=e},function(e){T=e}],execute:function(){l=class extends r.UiComponent{createUiObject(){let e=new s.UiObject(new THREE.Object3D,new a.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let r=document.createElement("canvas");return r.width=t,r.height=i,this.ctx=r.getContext("2d",{alpha:!0}),this.texture=this.createTexture(r),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=n.SpriteUtils.createRectGeometry(e,t);n.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(i){if(!this.lastUpdate||100<=i-this.lastUpdate){this.lastUpdate=i;let t=[];var r,s;this.props.stalemateDetectTrait?.isStale()&&(r=Math.floor(this.props.stalemateDetectTrait.getCountdownTicks()/y.GameSpeed.BASE_TICKS_PER_SECOND),r=this.props.strings.get("TS:StalemateTimer")+"   "+T.formatTimeDuration(r,!0),t.push({text:r,color:"red",flash:!0}));let e=this.props.countdownTimer;e.isRunning()&&(g=e.getSeconds(),g=(void 0!==e.text?this.props.strings.get(e.text)+"   ":"")+T.formatTimeDuration(g,!0),t.push({text:g,color:this.props.localPlayer?.color.asHexString()??"white",flash:!1}));for(s of this.props.players)if(!s.defeated){var a=s.superWeaponsTrait?.getAll(),n=(s.powerTrait?.getBlackoutDuration()??0)/y.GameSpeed.BASE_TICKS_PER_SECOND;if(a?.length||n){var o,l,c=s.color.asHexString();let e=[];if(a)for(var h of a)h.rules.showTimer&&e.push({seconds:h.getTimerSeconds(),label:this.props.strings.get(h.rules.uiName)});n&&e.push({seconds:n,label:this.props.strings.get("MSG:BlackoutTimer")});for({seconds:o,label:l}of e){var u=Math.floor(o),d=l+"   "+T.formatTimeDuration(u,!0);t.push({text:d,color:c,flash:0===u})}}}var g=!!t.length;if(g!==this.lastHasTimers||g){this.lastHasTimers=g,this.ctx.clearRect(0,0,this.props.width,this.props.height);let e=this.props.height-20;for(var{text:p,color:m,flash:f}of t)f&&(m=Math.floor(i/1e3)%2?m:"orange"),e-=this.drawLine(p,m,e);this.texture.needsUpdate=!0}}}drawLine(e,t,i){return o.CanvasUtils.drawText(this.ctx,e,0,i,{color:t,...{fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,height:20,backgroundColor:"rgba(0, 0, 0, .75)",textAlign:"right"},paddingLeft:4,paddingRight:4}).height}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("SuperWeaponTimers",l)}}}),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Separator=0]="Separator",e[e.BugReport=1]="BugReport",e[e.Beacon=2]="Beacon",e[e.Cheer=3]="Cheer",e[e.Deploy=4]="Deploy",e[e.Guard=5]="Guard",e[e.PlanningMode=6]="PlanningMode",e[e.Stop=7]="Stop",e[e.Team01=8]="Team01",e[e.Team02=9]="Team02",e[e.Team03=10]="Team03",e[e.TypeSelect=11]="TypeSelect",e[e.ReplayRewind=12]="ReplayRewind",e[e.ReplayPlay=13]="ReplayPlay",e[e.ReplayPause=14]="ReplayPause",e[e.ReplaySpeed=15]="ReplaySpeed",t("CommandBarButtonType",i)}}}),System.register("gui/screen/game/component/hud/commandBar/CommandButtonConfig",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/game/component/hud/commandBar/commandButtonConfigs",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("commandButtonConfigs",[{type:i.CommandBarButtonType.BugReport,icon:"reportbug.shp",tooltip:e=>e.get("ts:reportbug")},{type:i.CommandBarButtonType.Team01,icon:"button00.shp",tooltip:e=>e.get("tip:team01")},{type:i.CommandBarButtonType.Team02,icon:"button01.shp",tooltip:e=>e.get("tip:team02")},{type:i.CommandBarButtonType.Team03,icon:"button02.shp",tooltip:e=>e.get("tip:team03")},{type:i.CommandBarButtonType.TypeSelect,icon:"button03.shp",tooltip:e=>e.get("tip:typeselect")},{type:i.CommandBarButtonType.Deploy,icon:"button04.shp",tooltip:e=>e.get("tip:deploy")},{type:i.CommandBarButtonType.Guard,icon:"button06.shp",tooltip:e=>e.get("tip:guard")},{type:i.CommandBarButtonType.Beacon,icon:"button07.shp",tooltip:e=>e.get("tip:beacon")},{type:i.CommandBarButtonType.Stop,icon:"button08.shp",tooltip:e=>e.get("tip:stop")},{type:i.CommandBarButtonType.PlanningMode,icon:"button09.shp",tooltip:e=>e.get("tip:planningmode")},{type:i.CommandBarButtonType.Cheer,icon:"button10.shp",tooltip:e=>e.get("tip:cheer")},{type:i.CommandBarButtonType.ReplayRewind,icon:"rewind.shp",tooltip:e=>e.get("tip:replayrewind")},{type:i.CommandBarButtonType.ReplayPlay,icon:"play.shp",tooltip:e=>e.get("tip:play")},{type:i.CommandBarButtonType.ReplayPause,icon:"pause.shp",tooltip:e=>e.get("tip:pause")},{type:i.CommandBarButtonType.ReplaySpeed,icon:"ffwd.shp",tooltip:e=>e.get("tip:replayspeed")}])}}}),System.register("gui/screen/game/component/hud/DebugText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(e,t){"use strict";var i,s,r,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends r.UiComponent{createUiObject(){let e=new s.UiObject(new THREE.Object3D,new a.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let r=document.createElement("canvas");return r.width=t,r.height=i,this.ctx=r.getContext("2d",{alpha:!0}),this.texture=this.createTexture(r),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=n.SpriteUtils.createRectGeometry(e,t);n.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(t){if(!this.lastUpdate||t-this.lastUpdate>=1e3/30){this.lastUpdate=t;let e=this.props.text.value;var i;this.props.visible.value!==this.getUiObject().isVisible()&&this.getUiObject().setVisible(this.props.visible.value),this.lastText!==e&&(this.lastText=e,i=e.split(/\r?\n/g),this.drawLines(i))}}drawLines(e){this.ctx.clearRect(0,0,this.props.width,this.props.height);var t,i,r=Math.floor(110*this.props.width/600);let s=0;for(t of e)for(i of this.wrapText(t,r))s+=this.drawLine(i,this.props.color,s);this.texture.needsUpdate=!0}drawLine(e,t,i){var r={fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"400",paddingTop:6,height:20},s=.5<.299*t.r+.587*t.g+.114*t.b?"black":"white";return o.CanvasUtils.drawText(this.ctx,e,0,i,{color:"#"+t.getHexString(),outlineColor:s,outlineWidth:2,...r,paddingLeft:4,paddingRight:4}).height}wrapText(t,i){let r=[];for(;t.length>i;){let e=t.slice(0,i).search(/\s[^\s]*$/);-1!==e&&0!==e||(e=Math.min(t.length,i)),r.push(t.substr(0,e)),t=t.slice(e)}return t.length&&r.push(t),r}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("DebugText",l)}}}),System.register("gui/screen/game/component/Hud",["gui/jsx/jsx","data/ShpFile","game/SideType","gui/screen/game/component/hud/SidebarCard","gui/screen/game/component/hud/SidebarTabs","gui/screen/game/component/hud/SidebarIconButton","gui/screen/game/component/hud/SidebarMenu","gui/UiObject","gui/HtmlContainer","util/event","gui/screen/game/component/hud/GameMenuContentArea","gui/screen/game/component/hud/SidebarPower","gui/screen/game/component/hud/SidebarCredits","gui/screen/game/component/hud/SidebarRadar","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/SidebarGameTime","gui/screen/game/component/hud/Messages","gui/screen/game/component/hud/SuperWeaponTimers","engine/renderable/builder/ShpAggregator","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/component/hud/commandBar/commandButtonConfigs","util/typeGuard","gui/screen/game/component/hud/DebugText"],function(e,t){"use strict";var $,r,Q,Z,Y,X,i,s,y,T,J,ee,te,ie,re,se,ae,ne,oe,c,le,ce,he,a;t&&t.id;return{setters:[function(e){$=e},function(e){r=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){i=e},function(e){s=e},function(e){y=e},function(e){T=e},function(e){J=e},function(e){ee=e},function(e){te=e},function(e){ie=e},function(e){re=e},function(e){se=e},function(e){ae=e},function(e){ne=e},function(e){oe=e},function(e){c=e},function(e){le=e},function(e){ce=e},function(e){he=e}],execute:function(){a=class extends s.UiObject{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f){super(new THREE.Object3D,new y.HtmlContainer),this.sideType=e,this.viewport=t,this.images=i,this.palettes=r,this.cameoFilenames=s,this.sidebarModel=a,this.messageList=n,this.chatHistory=o,this.debugTextValue=l,this.debugTextEnabled=c,this.localPlayer=h,this.players=u,this.stalemateDetectTrait=d,this.countdownTimer=g,this.jsxRenderer=p,this.strings=m,this.commandBarButtonTypes=f,this._onDiploButtonClick=new T.EventDispatcher,this._onOptButtonClick=new T.EventDispatcher,this._onRepairButtonClick=new T.EventDispatcher,this._onSellButtonClick=new T.EventDispatcher,this._onSidebarSlotClick=new T.EventDispatcher,this._onSidebarTabClick=new T.EventDispatcher,this._onCreditsTick=new T.EventDispatcher,this._onMessagesTick=new T.EventDispatcher,this._onMessageSubmit=new T.EventDispatcher,this._onMessageCancel=new T.EventDispatcher,this._onScrollButtonClick=new T.EventDispatcher,this._onCommandBarButtonClick=new T.EventDispatcher,this.commandBarButtons=[],this.init()}get onDiploButtonClick(){return this._onDiploButtonClick.asEvent()}get onOptButtonClick(){return this._onOptButtonClick.asEvent()}get onRepairButtonClick(){return this._onRepairButtonClick.asEvent()}get onSellButtonClick(){return this._onSellButtonClick.asEvent()}get onSidebarSlotClick(){return this._onSidebarSlotClick.asEvent()}get onSidebarTabClick(){return this._onSidebarTabClick.asEvent()}get onCreditsTick(){return this._onCreditsTick.asEvent()}get onMessagesTick(){return this._onMessagesTick.asEvent()}get onMessageSubmit(){return this._onMessageSubmit.asEvent()}get onMessageCancel(){return this._onMessageCancel.asEvent()}get onScrollButtonClick(){return this._onScrollButtonClick.asEvent()}get onCommandBarButtonClick(){return this._onCommandBarButtonClick.asEvent()}getImage(e){var t=this.images.get(e);if(!t)throw new Error(`Missing image "${e}"`);return t}init(){const i=this.palettes.get("sidebar.pal");if(!i)throw new Error('Missing palette "sidebar.pal"');var e=this.getImage("credits.shp"),t=this.getImage("top.shp"),r=this.getImage("radar.shp"),s=this.getImage("side1.shp");let a=this.getImage("side2.shp"),n=this.getImage("side2b.shp");var o=this.getImage("side3.shp"),l=this.getImage("addon.shp");let c=this.getImage("tab00.shp"),h=this.getImage("tab01.shp"),u=this.getImage("tab02.shp"),d=this.getImage("tab03.shp"),g=this.getImage("diplobtn.shp"),p=this.getImage("optbtn.shp"),m=this.getImage("repair.shp"),f=this.getImage("sell.shp"),y=this.getImage("r-up.shp"),T=this.getImage("r-dn.shp");var v=[...new Set(this.commandBarButtonTypes.map(t=>le.commandButtonConfigs.find(e=>e.type===t)?.icon))].map(e=>e?this.images.get(e):void 0).filter(ce.isNotNullOrUndefined);let b=new oe.ShpAggregator,S=b.aggregate([g,p,m,f,c,h,u,d,T,y,...v].map(e=>oe.ShpAggregator.getShpFrameInfo(e,!1)),"agg_hud.shp");var w=this.sidebarWidth=e.width,C={x:this.viewport.width-w,y:0,width:w,height:this.viewport.height},E=e.height+t.height,x=E+r.height;let O=E+r.height+s.height;var A=this.repeaterCount=Math.floor((C.height-O-o.height)/a.height);let M=this.repeaterHeight=a.height;var R=E+r.height+s.height+M*A;let P=this.getImage("lendcap.shp");var I=this.actionBarHeight=P.height,k=this.viewport.y+this.viewport.height-I;let B=this.getImage("bttnbkgd.shp");var j=this.getImage("rendcap.shp"),N=C.x-P.width-j.width,L=Math.floor(N/B.width),D=N%B.width;let F;D&&(F=B.clip(D,B.height));let _={x:12,y:4};this.sideType===Q.SideType.Nod&&(_={x:14,y:5});let U={x:20,y:8};this.sideType===Q.SideType.Nod&&(U={x:34,y:7});let H=1,G={x:26,y:-3};this.sideType===Q.SideType.Nod&&(H=0,G={x:20,y:-2});var V=this.palettes.get("cameo.pal");if(!V)throw new Error('Missing palette "cameo.pal"');v=this.buildCameoFile(),w=this.createCameoNameToIdMap();let W=22,z=1;I=this.sideType===Q.SideType.GDI?{x:5,y:2}:{x:0,y:0};let K=38,q=7;N=this.getImage("powerp.shp"),D=this.getTextColor();this.add(...this.jsxRenderer.render($.jsx("fragment",null,$.jsx("container",{x:C.x,y:C.y},$.jsx("sprite-batch",null,$.jsx("sprite",{static:!0,image:e,palette:i}),$.jsx("container",{ref:e=>this.sidebarTop=e,zIndex:1},this.sidebarModel instanceof re.CombatantSidebarModel?$.jsx(te.SidebarCredits,{sidebarModel:this.sidebarModel,height:e.height,width:e.width,textColor:D,onTick:e=>this._onCreditsTick.dispatch(this,e)}):$.jsx(se.SidebarGameTime,{sidebarModel:this.sidebarModel,height:e.height,width:e.width,textColor:D})),$.jsx("sprite",{static:!0,image:t,palette:i,y:e.height}),$.jsx("sprite",{static:!0,image:r,palette:i,y:E}),$.jsx(ie.SidebarRadar,{image:r,palette:i,y:E,sidebarModel:this.sidebarModel instanceof re.CombatantSidebarModel?this.sidebarModel:void 0,zIndex:1,ref:e=>this.sidebarRadar=e}),$.jsx("sprite",{static:!0,image:s,palette:i,y:x}),new Array(A).fill(0).map((e,t)=>$.jsx("sprite",{static:!0,image:n,palette:i,y:O+M*t})),$.jsx("sprite-batch",{ref:e=>this.sideCameoRepeaters=e},new Array(A).fill(0).map((e,t)=>$.jsx("sprite",{static:!0,image:a,palette:i,y:O+M*t,zIndex:1}))),$.jsx(ee.SidebarPower,{sidebarModel:this.sidebarModel,powerImg:N,palette:i,x:I.x,y:O,height:M*A+I.y,ref:e=>this.sidebarPower=e,zIndex:2,strings:this.strings}),$.jsx(Z.SidebarCard,{cameoImages:v,cameoPalette:V,cameoNameToIdMap:w,sidebarModel:this.sidebarModel,slots:2*A,onSlotClick:e=>this._onSidebarSlotClick.dispatch(this,e),x:W,y:O+z,strings:this.strings,textColor:D,ref:e=>this.sidebarCard=e,zIndex:2}),$.jsx("container",{ref:e=>this.sidebarMenuContainer=e,x:W-1,y:O+z,zIndex:2}),$.jsx("sprite",{static:!0,image:o,palette:i,y:R}),$.jsx("sprite",{static:!0,image:l,palette:i,y:R+o.height}))),$.jsx("container",{x:C.x,y:C.y,ref:e=>this.sidebarButtonsContainer=e,zIndex:2},$.jsx(X.SidebarIconButton,{image:S.file,palette:i,imageFrameOffset:S.imageIndexes.get(g),x:_.x,y:e.height+_.y,onClick:()=>this._onDiploButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:DiplomacyButton")}),$.jsx(X.SidebarIconButton,{image:S.file,palette:i,imageFrameOffset:S.imageIndexes.get(p),x:_.x+g.width,y:e.height+_.y,onClick:()=>this._onOptButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:OptionsButton")}),$.jsx(X.SidebarIconButton,{image:S.file,palette:i,imageFrameOffset:S.imageIndexes.get(m),x:U.x,y:x+U.y,toggle:this.sidebarModel.repairMode,ref:e=>this.repairButton=e,onClick:()=>this._onRepairButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_REPAIR_MODE")}),$.jsx(X.SidebarIconButton,{image:S.file,palette:i,imageFrameOffset:S.imageIndexes.get(f),x:U.x+m.width,y:x+U.y,toggle:this.sidebarModel.sellMode,ref:e=>this.sellButton=e,onClick:()=>this._onSellButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_SELL_MODE")}),$.jsx(Y.SidebarTabs,{aggregatedImageData:S,images:[c,h,u,d],palette:i,sidebarModel:this.sidebarModel,tabSpacing:H,onTabClick:e=>{this.sidebarModel.selectTab(e.id),this._onSidebarTabClick.dispatch(this,e.id)},strings:this.strings,x:G.x,y:O-c.height+G.y}),$.jsx(X.SidebarIconButton,{image:S.file,palette:i,disabled:!0,imageFrameOffset:S.imageIndexes.get(T),x:K,y:R+q,ref:e=>this.pgDnButton=e,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageDown())}),$.jsx(X.SidebarIconButton,{image:S.file,palette:i,disabled:!0,imageFrameOffset:S.imageIndexes.get(y),x:K+T.width,y:R+q,ref:e=>this.pgUpButton=e,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageUp())})),$.jsx("container",{x:this.viewport.x,y:k},$.jsx("container",{x:P.width,zIndex:1},this.renderCommandBarButtons(S,this.commandBarButtonTypes,B.width,L)),$.jsx("sprite-batch",null,$.jsx("sprite",{static:!0,image:P,palette:i}),new Array(L).fill(0).map((e,t)=>$.jsx("sprite",{static:!0,image:B,palette:i,x:P.width+B.width*t})),F?$.jsx("sprite",{static:!0,image:F,palette:i,x:P.width+L*B.width}):[],$.jsx("sprite",{static:!0,image:j,palette:i,x:C.x-j.width}))),$.jsx(ae.Messages,{messages:this.messageList,chatHistory:this.chatHistory,width:C.x-10,height:200,ref:e=>this.messages=e,strings:this.strings,onMessageTick:()=>this._onMessagesTick.dispatch(this),onMessageSubmit:e=>this._onMessageSubmit.dispatch(this,e),onMessageCancel:()=>this._onMessageCancel.dispatch(this)}),$.jsx(he.DebugText,{text:this.debugTextValue,visible:this.debugTextEnabled,color:new THREE.Color(16777215),x:20,y:200,width:Math.floor(C.x/2),height:200,ref:e=>this.debugText=e}),$.jsx(ne.SuperWeaponTimers,{localPlayer:this.localPlayer,players:this.players,stalemateDetectTrait:this.stalemateDetectTrait,countdownTimer:this.countdownTimer,strings:this.strings,width:200,height:500,x:C.x-200,y:k-500,ref:e=>this.superWeaponTimers=e}),$.jsx(J.GameMenuContentArea,{hidden:!0,screenSize:this.viewport,viewport:{x:this.viewport.x,y:this.viewport.y,width:C.x,height:k},images:this.images,ref:e=>this.menuContentContainer=e.getUiObject(),innerRef:e=>this.menuContentContainerInner=e}))))}getTextColor(){return this.sideType===Q.SideType.GDI?"rgb(165,211,255)":"yellow"}createSidebarMenu(e){return this.jsxRenderer.render($.jsx(i.SidebarMenu,{buttonImg:this.getImage("sidebttn.shp"),buttonPal:"sidebar.pal",menuHeight:this.repeaterHeight*this.repeaterCount-2,buttons:e}))[0]}showSidebarMenu(e){this.destroySidebarMenu(),this.sidebarMenu=this.createSidebarMenu(e),this.sidebarMenuContainer.add(this.sidebarMenu),this.sideCameoRepeaters.setVisible(!1),this.remove(this.sidebarButtonsContainer),this.sidebarCard.hide(),this.sidebarPower.hide(),this.sidebarTop?.setVisible(!1),this.sidebarRadar?.hide(),this.commandBarButtons?.forEach(e=>e.getUiObject().setVisible(!1)),this.messages.getUiObject().setVisible(!1),this.debugText.getUiObject().setVisible(!1),this.superWeaponTimers.getUiObject().setVisible(!1)}hideSidebarMenu(){this.sideCameoRepeaters.setVisible(!0),this.destroySidebarMenu(),this.add(this.sidebarButtonsContainer),this.sidebarCard.show(),this.sidebarPower.show(),this.sidebarTop?.setVisible(!0),this.sidebarRadar?.show(),this.commandBarButtons?.forEach(e=>e.getUiObject().setVisible(!0)),this.messages.getUiObject().setVisible(!0),this.debugText.getUiObject().setVisible(!0),this.superWeaponTimers.getUiObject().setVisible(!0)}setMenuContentComponent(e){let t=this.menuContentContainerInner;this.menuContent&&(t.remove(this.menuContent),this.menuContent.destroy(),this.menuContent=void 0),e&&(t.add(e),this.menuContent=e)}setMinimap(e){this.sidebarRadar.setMinimap(e)}toggleMenuContentVisibility(e){this.menuContentContainer.setVisible(e)}renderCommandBarButtons(t,e,i,r){let s=0,a=[];for(let l of e.slice(0,r))if(l!==c.CommandBarButtonType.Separator){let e=le.commandButtonConfigs.find(e=>e.type===l);var n,o;e?(n=this.images.get(e.icon))?(o=t.imageIndexes.get(n),a.push($.jsx(X.SidebarIconButton,{image:void 0!==o?t.file:n,imageFrameOffset:o,palette:"sidebar.pal",tooltip:e.tooltip(this.strings),x:s,onClick:()=>{this._onCommandBarButtonClick.dispatch(this,l)},ref:e=>this.commandBarButtons.push(e)})),s+=n.width):console.warn(`Missing image for command bar button "${c.CommandBarButtonType[l]}"`):console.warn(`Unknown command bar button type "${l}"`)}else s+=i;return a}buildCameoFile(){let i=new r.ShpFile;return i.filename="agg_cameos.shp",this.cameoFilenames.forEach(e=>{let t=this.getImage(e);i.width||(i.width=t.width),i.height||(i.height=t.height),i.addImage(t.getImage(0))}),i}createCameoNameToIdMap(){let e=new Map;for(let t=0;t<this.cameoFilenames.length;++t)e.set(this.cameoFilenames[t],t);return e}destroySidebarMenu(){this.sidebarMenu&&(this.sidebarMenuContainer.remove(this.sidebarMenu),this.sidebarMenu.destroy())}update(e){super.update(e),this.repairButton?.setToggleState(this.sidebarModel.repairMode),this.sellButton?.setToggleState(this.sidebarModel.sellMode);var t=0<this.sidebarModel.activeTab.items.length-2*this.repeaterCount;this.pgUpButton?.setDisabled(!t),this.pgDnButton?.setDisabled(!t)}destroy(){this.sidebarButtonsContainer.destroy(),this.destroySidebarMenu(),this.sidebarRadar.setMinimap(void 0),super.destroy()}},e("Hud",a)}}}),System.register("util/PointerLock",["util/event","util/disposable/CompositeDisposable"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("PointerLock",s=class{constructor(e,t){this.element=e,this.document=t,this._onChange=new i.EventDispatcher,this.disposables=new r.CompositeDisposable,this.listening=!1}get onChange(){return this._onChange.asEvent()}async request(e){if(e?.unadjustedMovement)try{await this.requestInternal({unadjustedMovement:!0})}catch(e){if("NotSupportedError"!==e.name)throw e;await this.requestInternal()}else await this.requestInternal()}async requestInternal(s){if(!this.isActive()){if(!this.listening){this.listening=!0;const t=()=>{this._onChange.dispatch(this,this.isActive())};this.document.addEventListener("pointerlockchange",t,!1),this.disposables.add(()=>this.document.removeEventListener("pointerlockchange",t,!1));let e=()=>{this.exit().catch(e=>console.error(e))};this.document.addEventListener("touchstart",e,!1),this.disposables.add(()=>this.document.removeEventListener("touchstart",e,!1))}return new Promise((e,t)=>{const i=()=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),e()},r=e=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),t(e)};this.document.addEventListener("pointerlockerror",r,!1),this.document.addEventListener("pointerlockchange",i,!1),this.element.requestPointerLock(s)?.catch?.(t)})}}async exit(){if(this.isActive())return new Promise((e,t)=>{const i=()=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),e()},r=e=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),t(e)};this.document.addEventListener("pointerlockerror",r,!1),this.document.addEventListener("pointerlockchange",i,!1),this.document.exitPointerLock()})}isActive(){return this.element===this.document.pointerLockElement}dispose(){this.disposables.dispose()}})}}}),System.register("gui/PointerSprite",["gui/UiObject","engine/gfx/ImageUtils","gui/HtmlContainer"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class a extends i.UiObject{constructor(e,t,i){super(new THREE.Object3D,new s.HtmlContainer),this.images=e,this.size=t,this.frameCount=i,this.currentFrame=0}static fromShpFile(e,t){return new this(r.ImageUtils.convertShpToCanvas(e,t),{width:e.width,height:e.height},e.numImages)}setAnimationRunner(e){this.animationRunner=e}getAnimationRunner(){return this.animationRunner}update(e){super.update(e),this.animationRunner&&(this.animationRunner.tick(e),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.size}setFrame(e){if(e!==this.currentFrame){if(e<0||this.frameCount<=e)throw new RangeError(`Pointer frame index out of bounds (index=${e}, length=${this.frameCount})`);this.currentFrame=e,this.drawFrame(e)}}drawFrame(e){this.targetContext&&(this.targetContext.clearRect(0,0,this.size.width,this.size.height),this.targetContext.drawImage(this.images,e*this.size.width,0,this.size.width,this.size.height,0,0,this.size.width,this.size.height))}getFrame(){return this.currentFrame}getFrameCount(){return this.frameCount}create3DObject(){if(super.create3DObject(),!this.targetContext){let e=document.createElement("canvas"),t=this.getHtmlContainer();t.setTranslateMode(!0);let i=t.getElement();i.appendChild(e),i.style.zIndex=""+a.HTML_ZINDEX;var r=e.getContext("2d",{alpha:!0});if(!r)throw new Error("Couldn't create pointer canvas context");this.targetContext=r,this.drawFrame(this.currentFrame)}}destroy(){super.destroy()}},e("PointerSprite",a),a.HTML_ZINDEX=100}}}),System.register("gui/Pointer",["util/PointerLock","util/math","util/disposable/CompositeDisposable","gui/PointerSprite","gui/PointerEvents","gui/PointerType","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","util/BoxedVar"],function(e,t){"use strict";var h,n,o,u,d,l,s,a,c,g,p,m;t&&t.id;return{setters:[function(e){h=e},function(e){n=e},function(e){o=e},function(e){u=e},function(e){d=e},function(e){l=e},function(e){s=e},function(e){a=e},function(e){c=e},function(e){g=e},function(e){p=e}],execute:function(){e("Pointer",m=class m{constructor(e,t,i,r,s,a){this.pointerLock=e,this.sprite=t,this.document=i,this.canvas=r,this.canvasMetrics=s,this.mouseAcceleration=a,this.userLockMode=!1,this.userPointerVisible=!0,this.userPermissionGranted=!1,this.position={x:0,y:0},this.disposables=new o.CompositeDisposable,this.pointerType=l.PointerType.Default,this.pointerSubFrame=0,this.onMouseMove=e=>{let t=this.position;this.pointerLock.isActive()?(t.x=t.x+e.movementX,t.y=t.y+e.movementY):(t.x=e.pageX-this.canvasMetrics.x,t.y=e.pageY-this.canvasMetrics.y),t.x=n.clamp(t.x,0,this.canvasMetrics.width-1),t.y=n.clamp(t.y,0,this.canvasMetrics.height-1),this.updateSpritePosition()}}static factory(e,t,i,r,s,a){let n=u.PointerSprite.fromShpFile(e,t);n.setVisible(!1);var o=i.getCanvas(),l=new h.PointerLock(o,r);let c=new m(l,n,r,o,s,a);return c.pointerEvents=new d.PointerEvents(i,c.getPosition(),r,s),c.disposables.add(c.pointerEvents),c}getPosition(){return this.position}getPointerLock(){return this.pointerLock}init(){this.listenForFirstCanvasClick(),this.pointerLock.onChange.subscribe(e=>{this.sprite.setVisible(this.userPointerVisible&&e);const t=()=>{this.userLockMode&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch(e=>{console.warn("Couldn't acquire pointer lock.",e),this.canvas.addEventListener("click",t,{once:!0})})};e||(this.canvas.addEventListener("click",t,{once:!0}),this.disposables.add(()=>this.canvas.removeEventListener("click",t)))}),this.document.addEventListener("mousemove",this.onMouseMove,!0),this.disposables.add(()=>this.document.removeEventListener("mousemove",this.onMouseMove,!0))}listenForFirstCanvasClick(){const t=async()=>{if(!this.userPermissionGranted)try{await this.pointerLock.request(),this.userLockMode||await this.pointerLock.exit(),this.userPermissionGranted=!0}catch(e){console.warn("Couldn't acquire initial pointer lock",e),this.canvas.addEventListener("click",t,{once:!0})}};this.canvas.addEventListener("click",t,{once:!0}),this.disposables.add(()=>this.canvas.removeEventListener("click",t))}lock(){this.userLockMode=!0,this.userPermissionGranted&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch(e=>{console.warn("Couldn't reacquire pointer lock. Will attempt to require lock on next click",e),this.userPermissionGranted=!1,this.listenForFirstCanvasClick()})}unlock(){this.userLockMode=!1,this.pointerLock.exit().catch(e=>console.error("Couldn't release pointer lock. This should never happen",e))}setVisible(e){this.userPointerVisible=e,this.sprite.setVisible(e&&this.pointerLock.isActive())}getUserLockMode(){return this.userLockMode}getSprite(){return this.sprite}setPointerType(t,e=0){if(this.pointerType!==t||this.pointerSubFrame!==e){if(this.pointerType=t,this.pointerSubFrame=e,this.sprite.setAnimationRunner(void 0),[l.PointerType.Scroll,l.PointerType.NoScroll,l.PointerType.Pan].includes(t))this.sprite.setFrame(t+e);else{var i=t,r=(Object.keys(l.PointerType).map(Number).find(e=>!Number.isNaN(e)&&t<e)??this.sprite.getFrameCount())-1;if(this.sprite.setFrame(i),i<r){let e=new s.SimpleRunner,t=new c.AnimProps(new g.IniSection("dummy"),this.sprite.getFrameCount());t.loopCount=-1,t.start=i,t.loopStart=i,t.loopEnd=r;r=new a.Animation(t,new p.BoxedVar(1.5));e.animation=r,this.sprite.setAnimationRunner(e)}}this.updateSpritePosition()}}updateSpritePosition(){let e={...this.position};var t=this.sprite.getSize(),i=Math.floor(t.width/2),r=Math.floor(t.height/2);this.pointerType>l.PointerType.Mini&&(e.x-=i,e.y-=r),[l.PointerType.Scroll,l.PointerType.NoScroll,l.PointerType.Pan].includes(this.pointerType)&&(e.x=n.clamp(e.x,0,this.canvasMetrics.width-1-t.width),e.y=n.clamp(e.y,0,this.canvasMetrics.height-1-t.height)),this.sprite.setPosition(e.x,e.y)}dispose(){this.disposables.dispose()}})}}}),System.register("tools/ShpTester",["engine/gfx/Renderer","gui/UiScene","gui/screen/game/component/Hud","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","game/rules/Rules","game/art/Art","game/Country","game/Player","game/World","game/gameobject/ObjectFactory","game/art/ObjectArt","engine/type/ObjectType","engine/UiAnimationLoop","game/Game","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","game/Alliances","game/PlayerList","gui/Pointer","util/BoxedVar","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","game/gameobject/selection/UnitSelection","game/ini/GameModeType","util/math","engine/TheaterType","game/GameMap","game/player/trait/RadarTrait","gui/screen/game/component/Minimap","game/player/production/Production","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/viewmodel/MessageList","game/trait/MapShroudTrait","game/trait/SellTrait","game/map/MapBounds","engine/mixDatabase","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/CanvasMetrics","game/trait/StalemateDetectTrait","game/CountdownTimer","data/IniSection","gui/chat/ChatHistory"],function(e,t){"use strict";var F,_,U,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,i,ee,te,ie,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ce,Ee,xe,Oe,r;t&&t.id;return{setters:[function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e},function(e){i=e},function(e){ee=e},function(e){te=e},function(e){ie=e},function(e){re=e},function(e){se=e},function(e){ae=e},function(e){ne=e},function(e){oe=e},function(e){le=e},function(e){ce=e},function(e){he=e},function(e){ue=e},function(e){de=e},function(e){ge=e},function(e){pe=e},function(e){me=e},function(e){fe=e},function(e){ye=e},function(e){Te=e},function(e){ve=e},function(e){be=e},function(e){Se=e},function(e){we=e},function(e){Ce=e},function(e){Ee=e},function(e){xe=e},function(e){Oe=e}],execute:function(){e("ShpTester",r=class{static async main(e,t,i,r){let s=new F.Renderer(800,600);s.init(i),s.initStats(document.body),this.disposables.add(s);let a=_.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(a),await e.addMixFile("sidec01.mix");var n=be.mixDatabase.get("cameo.mix");if(!n)throw new Error("Missing file list database for cameos");let o=new V.Rules(H.Engine.getRules()),l=new W.Art(o,H.Engine.getArt());var c=await H.Engine.loadTheater(he.TheaterType.Temperate),h=new ue.GameMap(t,c.tileSets,o,ce.getRandomInt),u={superWeapons:!1,gameSpeed:5},d=z.Country.factory("Americans",o);let g=new K.Player("Player",d);g.radarTrait=new de.RadarTrait,g.production=new pe.Production(g,10,u,o,[...o.buildingRules.values(),...o.infantryRules.values()]),this.disposables.add(g);var p=new q.World,m=new te.PlayerList,f=new ee.Alliances(m),y=new oe.UnitSelection,T=new se.TileCollection([],null,o.general,ce.getRandomInt),v=new ae.TileOccupation(T),d=new ve.MapBounds,c=new ne.Bridges(c.tileSets,T,v,d,o),d=new re.BoxedVar(1);let b=new $.ObjectFactory(T,v,c,d),S=new X.Game(p,h,o,l,null,0,0,u,le.GameModeType.Battle,m,y,f,d,b,null);S.addPlayer(g),S.mapShroudTrait=new ye.MapShroudTrait(h,f),S.traits.add(S.mapShroudTrait),S.sellTrait=new Te.SellTrait(S,S.rules.general),S.traits.add(S.sellTrait);var w;["GACNST","GAPOWR","GAREFN","GAPILE","GAAIRC","GAWEAP","GATECH","NACNST","NAPOWR"].forEach(e=>g.addOwnedObject(b.create(Z.ObjectType.Building,e,o,l)));let C=new me.CombatantSidebarModel(g,S);C.powerDrained=150,C.powerGenerated=300,g.radarTrait.setDisabled(!1);let E=setInterval(()=>{C.powerDrained=ce.getRandomInt(0,300),C.powerGenerated=ce.getRandomInt(200,1e3),console.log(`Set power = ${C.powerGenerated}, drain = `+C.powerDrained)},5e3);this.disposables.add(()=>clearInterval(E)),g.credits=5e3;let x=setInterval(()=>{g.credits=ce.clamp(g.credits+ce.getRandomInt(-1e3,1e3),0,1e6),console.log("Set credits",g.credits)},5e3);this.disposables.add(()=>clearInterval(x));for(w of g.production.getAvailableObjects()){var O=Q.ObjectArt.factory(w.type,w,H.Engine.getArt(),H.Engine.getArt().getSection(w.imageName)??new xe.IniSection(w.imageName));let e=C.getTabForQueueType(g.production.getQueueTypeForObject(w));e.items.push({target:{type:G.SidebarItemTargetType.Techno,rules:w},cameo:O.cameo,disabled:e.id===G.SidebarCategory.Structures,progress:0,quantity:0,status:G.SidebarItemStatus.Idle})}let A=C.activeTab.items[1];A.disabled=!1,A.progress=.75,A.quantity=2,A.status=G.SidebarItemStatus.OnHold;let M=C.tabs[G.SidebarCategory.Infantry].items[0];M.quantity=5,M.progress=1,M.status=G.SidebarItemStatus.Ready;let R=new we.CanvasMetrics(s.getCanvas(),window);R.init(),this.disposables.add(R);let P=ie.Pointer.factory(H.Engine.getImages().get("mouse.shp"),H.Engine.getPalettes().get("mousepal.pal"),s,document,R,new re.BoxedVar(!1));P.init(),P.lock(),this.disposables.add(P),a.add(P.getSprite());f=new J.JsxRenderer(H.Engine.getImages(),H.Engine.getPalettes(),a.camera,P.pointerEvents);let I=new fe.MessageList(S.rules.audioVisual.messageDuration,6,g),k,B=["txt_low_power","txt_space_cant_save","txt_receiving_scenario","txt_bad_chankey"],j=()=>{var e=r.get(B[ce.getRandomInt(0,B.length-1)]);console.log("Add system message:",e),I.addSystemMessage(e,"#"+new THREE.Color(Math.random(),Math.random(),Math.random()).getHexString()),k=setTimeout(j,5e3*Math.random())};k=setTimeout(j,5e3*Math.random()),this.disposables.add(()=>clearTimeout(k));let N=new U.Hud(g.country.side,a.viewport,H.Engine.getImages(),H.Engine.getPalettes(),n,C,I,new Oe.ChatHistory,new re.BoxedVar(""),new re.BoxedVar(!1),void 0,[],new Ce.StalemateDetectTrait,new Ee.CountdownTimer,f,r,Object.values(Se.CommandBarButtonType).filter(e=>"number"==typeof e)),L=new ge.Minimap(S,g,N.getTextColor(),o.general.radar);L.setPointerEvents(P.pointerEvents),N.setMinimap(L),this.disposables.add(L),a.add(N),N.onSidebarSlotClick.subscribe(e=>{console.log("clicked",e)}),N.onOptButtonClick.subscribe(()=>{P.unlock(),N.showSidebarMenu([{label:"Button 1",onClick(){console.log("button 1 clicked")}},{label:"Button 2",disabled:!0,onClick(){console.error("button 2 should not trigger onClick")}},{label:"Exit",isBottom:!0,onClick(){P.lock(),N.hideSidebarMenu()}}])}),N.onRepairButtonClick.subscribe(()=>{g.radarTrait.setDisabled(!g.radarTrait.isDisabled())}),N.onCommandBarButtonClick.subscribe(e=>{console.log("Clicked command bar -> "+Se.CommandBarButtonType[e])});n=(new Date).getTime();s.addScene(a);let D=new Y.UiAnimationLoop(s);this.disposables.add(D),D.start();f=(new Date).getTime();console.log("Rendering took "+(f-n)+"ms"),i.appendChild(a.getHtmlContainer().getElement()),this.disposables.add(()=>{i.removeChild(a.getHtmlContainer().getElement())})}static destroy(){this.disposables.dispose()}}),r.disposables=new i.CompositeDisposable}}}),System.register("engine/renderable/entity/map/MapGrid",["game/Coords","engine/IsoCoords"],function(e,t){"use strict";var o,l,i;t&&t.id;return{setters:[function(e){o=e},function(e){l=e}],execute:function(){e("MapGrid",i=class{constructor(e){this.size=e,this._build()}_build(){var e=this.size,t=o.Coords.getWorldTileSize(),i=l.IsoCoords.screenTileToWorld(0,0),r=l.IsoCoords.screenTileToWorld(e.width,e.height),s=l.IsoCoords.screenTileToWorld(0,e.height),e=l.IsoCoords.screenTileToWorld(e.width,0),i=r.x-i.x,s=s.y-e.y,e=new THREE.PlaneGeometry(i,s,i/t,s/t),t=new THREE.MeshBasicMaterial({color:9474192,wireframe:!0,side:THREE.DoubleSide});let a=new THREE.Mesh(e,t);a.matrixAutoUpdate=!1,a.rotation.x=Math.PI/2,a.updateMatrix();let n=new THREE.Object3D;n.matrixAutoUpdate=!1,n.add(a),n.position.x=i/2,n.position.z=s/2,n.position.y=-1*o.Coords.ISO_WORLD_SCALE,n.updateMatrix(),this.target=n}get3DObject(){return this.target}create3DObject(){}update(){}})}}}),System.register("tools/BuildingTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","engine/TheaterType","game/Player","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","util/Color","game/gameobject/selection/SelectionLevel","game/Alliances","game/PlayerList","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","game/gameobject/Infantry","engine/Lighting","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","data/Strings","game/gameobject/trait/AutoRepairTrait","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],function(e,t){"use strict";var o,u,l,c,d,p,s,h,g,r,m,f,y,T,v,b,S,w,C,E,x,O,i,A,M,a,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,n;t&&t.id;return{setters:[function(e){o=e},function(e){u=e},function(e){l=e},function(e){c=e},function(e){d=e},function(e){p=e},function(e){s=e},function(e){h=e},function(e){g=e},function(e){r=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){i=e},function(e){A=e},function(e){M=e},function(e){a=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e}],execute:function(){e("BuildingTester",n=class n{static async main(e){let t=this.renderer=new o.Renderer(800,600);t.init(document.body),t.initStats(document.body);let i=h.WorldScene.factory({x:0,y:0,width:800,height:600},new m.BoxedVar(!0),new m.BoxedVar(V.ShadowQuality.High));this.disposables.add(i),i.scene.background=new THREE.Color(12632256),l.IsoCoords.init({x:0,y:0}),this.theater=await u.Engine.loadTheater(c.TheaterType.Snow);var r=new g.Rules(u.Engine.getRules());this.buildBrowser(r.buildingRules),this.rules=r,this.art=new T.Art(r,u.Engine.getArt()),this.images=u.Engine.getImages(),this.voxels=u.Engine.getVoxels(),this.voxelAnims=u.Engine.getVoxelAnims();let s=new W.CanvasMetrics(t.getCanvas(),window);s.init(),this.disposables.add(s);r=new O.PointerEvents(t,{x:0,y:0},document,s);let a=new M.CameraZoomControls(r,i.cameraZoom);this.disposables.add(a,r),a.init(),t.addScene(i);let n=this.uiAnimationLoop=new f.UiAnimationLoop(t);n.start(),this.worldScene=i,this.vxlGeometryPool=new H.VxlGeometryPool(new G.VxlGeometryCache),this.addGrid()}static addGrid(){let e=new r.MapGrid({width:10,height:10});var t=e.get3DObject();let i=new THREE.Object3D;i.add(t),this.worldScene.scene.add(i)}static selectBuilding(e){this.currentRenderable&&!this.currentBuilding.isDisposed&&(this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose());var t=this.rules.getBuilding(e);let i=new d.Player("Player");this.disposables.add(i),i.color=-1!==t.techLevel||t.constructionYard?this.rules.getMultiplayerColors().get("DarkRed"):new b.Color(255,255,255);let r=new C.PlayerList;r.addPlayer(i);var s=new w.Alliances(r),a=new A.UnitSelection,n=new R.Lighting;this.disposables.add(n);t=new v.RenderableFactory(i,a,s,this.rules,this.art,void 0,new y.ImageFinder(this.images,this.theater),u.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,n,new D.LightingDirector(n,this.renderer,new m.BoxedVar(1)),new m.BoxedVar(!1),new m.BoxedVar(!1),new m.BoxedVar(2),void 0,new B.Strings({TXT_PRIMARY:"Primary"}),new m.BoxedVar(L.FlyerHelperMode.Selected),new m.BoxedVar(!1),new U.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map),a=new P.TileCollection([],null,this.rules.general,z.getRandomInt),s=new I.TileOccupation(a),n=new N.MapBounds,n=new k.Bridges(this.theater.tileSets,a,s,n,this.rules);let o=this.currentBuilding=new E.ObjectFactory(a,s,n,new m.BoxedVar(1)).create(x.ObjectType.Building,e,this.rules,this.art);o.owner=i,o.position.tile={rx:1,ry:1,z:0,rampType:0},o.position.setCenterOffset(o.getFoundationCenterOffset());let l=this.world=new F.World,c=new _.RenderableManager(l,this.worldScene,this.worldScene.camera,t);c.init(),this.disposables.add(c),l.spawnObject(o);let h=this.currentRenderable=c.getRenderableByGameObject(o);h.selectionModel.setSelectionLevel(S.SelectionLevel.Selected),this.currentRenderable.selectionModel.setControlGroupNumber(3),setTimeout(()=>{this.buildBuildingControls(),this.createAnimButtons(),this.createOccupiedButtons()},50)}static selectAnimation(e){this.currentRenderable&&this.currentRenderable.setAnimation(e,performance.now())}static stopCurrentAnimation(){this.currentRenderable&&this.currentRenderable.endCurrentAnimation()}static setDamageType(e){this.currentBuilding.healthTrait.health=e?100*(e===p.DamageType.CONDITION_YELLOW?n.rules.audioVisual.conditionYellow:n.rules.audioVisual.conditionRed):100}static setActiveState(e){this.currentRenderable&&this.currentRenderable.setPowered(e)}static createAnimButtons(){let t=this.animButtonsWrap;t.innerHTML="";for(let r of[s.AnimationType.IDLE,s.AnimationType.PRODUCTION,s.AnimationType.BUILDUP,s.AnimationType.UNBUILD,s.AnimationType.SUPER_CHARGE_START,s.AnimationType.SPECIAL_REPAIR_START,s.AnimationType.SPECIAL_SHOOT,s.AnimationType.SPECIAL_DOCKING,s.AnimationType.FACTORY_DEPLOYING,s.AnimationType.FACTORY_ROOF_DEPLOYING]){let e=document.createElement("button");if(e.innerHTML=s.AnimationType[r],e.style.display="block",e.addEventListener("click",()=>this.selectAnimation(r)),!this.currentRenderable)throw new Error("Must build anim buttons after a building is selected");var i=!this.currentRenderable.hasAnimation(r);e.disabled=i,e.style.opacity=i?".5":"1",t.appendChild(e)}}static createOccupiedButtons(){let e=this.occupiedButtonsWrap;e.innerHTML="";let t=document.createElement("select");t.disabled=!this.currentBuilding.garrisonTrait,t.style.display="block",t.addEventListener("change",()=>{this.currentBuilding.garrisonTrait.units=new Array(Number(t.value)).fill(0).map(()=>new a.Infantry("dummy",this.rules.getObject("E1",x.ObjectType.Infantry),null))});for(let i=0;i<this.currentBuilding.rules.maxNumberOccupants+1;i++){let e=document.createElement("option");e.innerHTML=String(i),e.value=String(i),e.selected=0===i,t.appendChild(e)}e.appendChild(t)}static buildBuildingControls(){this.controlsElement&&document.body.removeChild(this.controlsElement);let e=this.controlsElement=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="220px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=new Map(this.rules.getMultiplayerColors());t.set("None",new b.Color(255,255,255));let r=document.createElement("select");r.style.display="block",r.addEventListener("change",()=>{this.currentBuilding.owner.color=t.get(r.value)}),e.appendChild(r),t.forEach((e,t)=>{let i=document.createElement("option");i.innerHTML=t,i.value=t,i.selected=e.asHex()===this.currentBuilding.owner.color.asHex(),r.appendChild(i)}),e.appendChild(document.createTextNode("Selection level:"));let i=document.createElement("div");e.appendChild(i),[S.SelectionLevel.None,S.SelectionLevel.Hover,S.SelectionLevel.Selected].forEach(e=>{let t=document.createElement("button");t.innerHTML=S.SelectionLevel[e],t.disabled=e===S.SelectionLevel.Selected&&!this.currentBuilding.rules.selectable,t.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(e)),i.appendChild(t)}),e.appendChild(document.createTextNode("Animation type:"));var s=this.animButtonsWrap=document.createElement("div");e.appendChild(s);let a=document.createElement("button");a.innerHTML="Stop current",a.style.display="block",a.addEventListener("click",()=>this.stopCurrentAnimation()),e.appendChild(a),e.appendChild(document.createTextNode("Occupants:"));s=this.occupiedButtonsWrap=document.createElement("div");e.appendChild(s),e.appendChild(document.createTextNode("Damage type:"));let n=document.createElement("button");n.innerHTML="NORMAL",n.style.display="block",n.addEventListener("click",()=>this.setDamageType(p.DamageType.NORMAL)),e.appendChild(n);let o=document.createElement("button");o.innerHTML="YELLOW",o.style.display="block",o.addEventListener("click",()=>this.setDamageType(p.DamageType.CONDITION_YELLOW)),e.appendChild(o);let l=document.createElement("button");l.innerHTML="RED",l.style.display="block",l.addEventListener("click",()=>this.setDamageType(p.DamageType.CONDITION_RED)),e.appendChild(l);let c=document.createElement("button");c.innerHTML="DESTROYED",c.style.display="block",c.addEventListener("click",async()=>{this.currentBuilding.isDestroyed=!0,this.currentBuilding.healthTrait.health=0,this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose(),document.body.removeChild(this.controlsElement),this.controlsElement=void 0}),e.appendChild(c);let h=document.createElement("button");h.innerHTML="Toggle repair",h.style.display="block",h.addEventListener("click",()=>{let e=this.currentBuilding.traits.get(j.AutoRepairTrait);e.setDisabled(!e.isDisabled())}),e.appendChild(h),e.appendChild(document.createTextNode("Powered state:"));let u=document.createElement("button");u.innerHTML="INACTIVE",u.style.display="block",u.addEventListener("click",()=>this.setActiveState(!1)),e.appendChild(u);let d=document.createElement("button");d.innerHTML="ACTIVE",d.style.display="block",d.addEventListener("click",()=>this.setActiveState(!0)),e.appendChild(d),e.appendChild(document.createTextNode("Warped out:"));let g=document.createElement("input");g.type="checkbox",g.style.display="block",g.addEventListener("change",e=>{this.currentBuilding.warpedOutTrait.debugSetActive(e.target.checked)}),e.appendChild(g),document.body.appendChild(e)}static buildBrowser(e){let i=this.listEl=document.createElement("div");i.style.position="absolute",i.style.right="0",i.style.top="0",i.style.height="600px",i.style.width="200px",i.style.overflowY="auto",i.style.padding="5px",i.style.background="rgba(255, 255, 255, 0.5)",i.style.border="1px black solid",i.appendChild(document.createTextNode("Building types:"));let r=[];e.forEach((e,t)=>{-1!==["AMMOCRAT","GADUMY","GAGREEN","CAARMR"].indexOf(t)||/^CASIN/.exec(t)||/^CITY/.exec(t)||r.push(t)}),r.sort(),r.forEach(e=>{let t=document.createElement("a");t.style.display="block",t.textContent=e,t.setAttribute("href","javascript:;"),t.addEventListener("click",()=>{console.log("Selected building",e),this.selectBuilding(e)}),i.appendChild(t)}),document.body.appendChild(i),setTimeout(()=>{this.selectBuilding(r[0])},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsElement&&(this.controlsElement.remove(),this.controlsElement=void 0),this.disposables.dispose()}}),n.disposables=new i.CompositeDisposable}}}),System.register("network/HttpRequest",["@puzzl/core/lib/async/cancellation"],function(e,t){"use strict";var g,i,p;t&&t.id;return{setters:[function(e){g=e}],execute:function(){e("HttpRequest",i=class{async fetchText(e,t,i){return await this.fetchAndParse({url:e,type:"text"},t,i)}async fetchBinary(e,t,i){return await this.fetchAndParse({url:e,type:"binary"},t,i)}async fetchJson(e,t,i){return await this.fetchAndParse({url:e,type:"json"},t,i)}async fetchHtml(e,t,i){return await this.fetchAndParse({url:e,type:"text"},t,{...i,allowHtmlMimeType:!0})}async fetchAndParse(e,t,i){var r=await this.fetchRaw(e.url,t,i);return this.parseResult(e.type,r)}async fetchRaw(e,t,i){let r=new AbortController;t?.register(()=>{try{r.abort()}catch(e){}});let s;try{s=await fetch(e,{signal:r.signal,body:i?.body,method:i?.method})}catch(e){if("AbortError"===e.name)throw new g.OperationCanceledError(t);throw console.error(e),new p(`Fetch failed with error: ${e.name}:`+e.message)}if(!s.ok)throw new p(`Fetch failed with status ${s.status}:`+s.statusText);if("text/html"===s.headers.get("Content-Type")&&!i?.allowHtmlMimeType)throw new p(`Fetch failed with invalid mime type "text/html" (HTTP status ${s.status})`);let a=s.body.getReader(),n=0,o=[];for(;;)try{var{done:l,value:c}=await a.read();if(l)break;o.push(c),n+=c.length,i?.onProgress?.(c.length)}catch(e){if("AbortError"===e.name)throw new g.OperationCanceledError(t);throw console.error(e),new p(e.message)}let h=new Uint8Array(n),u=0;for(var d of o)h.set(d,u),u+=d.length;return h}parseResult(e,t){if("binary"===e)return t;var i=new TextDecoder("utf-8").decode(t);return"json"===e?JSON.parse(i):i}}),p=class extends Error{},e("DownloadError",p)}}}),System.register("engine/resourceConfigs",["engine/TheaterType"],function(t,e){"use strict";var i,r;e&&e.id;return{setters:[function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.IsoSnow=0]="IsoSnow",e[e.IsoTemp=1]="IsoTemp",e[e.IsoUrb=2]="IsoUrb",e[e.BuildGen=3]="BuildGen",e[e.TheaterSnow=4]="TheaterSnow",e[e.TheaterTemp=5]="TheaterTemp",e[e.TheaterUrb=6]="TheaterUrb",e[e.TheaterSnow2=7]="TheaterSnow2",e[e.TheaterTemp2=8]="TheaterTemp2",e[e.TheaterUrb2=9]="TheaterUrb2",e[e.Ui=10]="Ui",e[e.UiAlly=11]="UiAlly",e[e.UiSov=12]="UiSov",e[e.Anims=13]="Anims",e[e.Vxl=14]="Vxl",e[e.Cameo=15]="Cameo",e[e.Ini=16]="Ini",e[e.Strings=17]="Strings",e[e.EvaAlly=18]="EvaAlly",e[e.EvaSov=19]="EvaSov",e[e.Sounds=20]="Sounds",e[e.HalloweenMix=21]="HalloweenMix",e[e.XmasMix=22]="XmasMix",t("ResourceType",r),t("resourceConfigs",(new Map).set(r.IsoSnow,{id:"isoSnow",src:"isosnow.mix",type:"binary",sizeHint:28758698}).set(r.IsoTemp,{id:"isoTemp",src:"isotemp.mix",type:"binary",sizeHint:29171410}).set(r.IsoUrb,{id:"isoUrb",src:"isourb.mix",type:"binary",sizeHint:31811402}).set(r.BuildGen,{id:"buildGen",src:"build-gen.mix",type:"binary",sizeHint:27801690}).set(r.TheaterSnow,{id:"theater.snow",src:"snow.mix",type:"binary",sizeHint:18421274}).set(r.TheaterTemp,{id:"theater.temp",src:"temperat.mix",type:"binary",sizeHint:2728266}).set(r.TheaterUrb,{id:"theater.urb",src:"urban.mix",type:"binary",sizeHint:2726218}).set(r.TheaterSnow2,{id:"theater.snow2",src:"sno.mix",type:"binary",sizeHint:10898}).set(r.TheaterTemp2,{id:"theater.temp2",src:"tem.mix",type:"binary",sizeHint:10850}).set(r.TheaterUrb2,{id:"theater.urb2",src:"urb.mix",type:"binary",sizeHint:10850}).set(r.UiAlly,{id:"uially",src:"sidec01.mix",type:"binary",sizeHint:2099412}).set(r.UiSov,{id:"uisov",src:"sidec02.mix",type:"binary",sizeHint:2102564}).set(r.Anims,{id:"anims",src:"anims.mix",type:"binary",sizeHint:15867898}).set(r.Vxl,{id:"vxl",src:"vxl.mix",type:"binary",sizeHint:5271701}).set(r.Cameo,{id:"cameo",src:"cameo.mix",type:"binary",sizeHint:608120}).set(r.Ini,{id:"ini",src:"ini.mix",type:"binary",sizeHint:1000842}).set(r.Ui,{id:"ui",src:"ui.mix",type:"binary",sizeHint:4424093}).set(r.Strings,{id:"strings",src:"strings.mix",type:"binary",sizeHint:485818}).set(r.EvaAlly,{id:"evaally",src:"eva-ally.mix",type:"binary",sizeHint:1835436}).set(r.EvaSov,{id:"evasov",src:"eva-sov.mix",type:"binary",sizeHint:2021760}).set(r.Sounds,{id:"sounds",src:"sounds.mix",type:"binary",sizeHint:17684750}).set(r.HalloweenMix,{id:"halloweenmix",src:"expandspawn09.mix",type:"binary",sizeHint:20312}).set(r.XmasMix,{id:"xmasmix",src:"expandspawn10.mix",type:"binary",sizeHint:10318})),t("resourcesForPrefetch",[r.BuildGen,r.Sounds,r.Anims,r.Vxl,r.IsoUrb,r.TheaterUrb,r.TheaterUrb2,r.IsoTemp,r.TheaterTemp,r.TheaterTemp2,r.IsoSnow,r.TheaterSnow,r.TheaterSnow2]),t("theaterSpecificResources",new Map([[i.TheaterType.Snow,[r.TheaterSnow,r.TheaterSnow2,r.IsoSnow]],[i.TheaterType.Temperate,[r.TheaterTemp,r.TheaterTemp2,r.IsoTemp]],[i.TheaterType.Urban,[r.TheaterUrb,r.TheaterUrb2,r.IsoUrb]]]))}}}),System.register("engine/ResourceLoader",["@puzzl/core/lib/async/cancellation","network/HttpRequest","engine/resourceConfigs"],function(t,e){"use strict";var a,i,r,s,u;e&&e.id;return{setters:[function(e){a=e},function(e){t({DownloadError:(i=e).DownloadError})},function(e){r=e}],execute:function(){t("ResourceLoader",s=class{constructor(e){this.resourceBaseUrl=e,this.httpRequest=new i.HttpRequest}async prefetchResource(e,i){let r=this.getResourceUrl(e);const s=document.createElement("link");s.rel="prefetch",s.as="fetch",s.href=r,s.crossOrigin="anonymous",await new Promise((e,t)=>{i?.register(()=>{s.parentNode&&(document.head.removeChild(s),t(new a.OperationCanceledError(i)))}),"onload"in s&&(s.onload=()=>{document.head.removeChild(s),e()}),"onerror"in s&&(s.onerror=()=>{document.head.removeChild(s),t(new Error(`Couldn't prefetch URL "${r}"`))}),document.head.appendChild(s),"onload"in s||(document.head.removeChild(s),e())})}getResourceUrl(e){var t="object"==typeof e?e:r.resourceConfigs.get(e);if(!t)throw new Error("Missing resourceConfig for resType "+r.ResourceType[e]);return this.resourceBaseUrl+t.src}getResourceFileName(e){let t=this.getResourceUrl(e);return t.split("?")[0].split("/").pop()}buildResourceManifest(e){return e.map(e=>{if("object"==typeof e)return e;if(!r.resourceConfigs.has(e))throw new Error("Missing resourceConfig for resType "+r.ResourceType[e]);return r.resourceConfigs.get(e)}).map(e=>({id:e.id,src:e.src.match(/^https?:\/\//)?e.src:this.resourceBaseUrl+e.src,type:e.type,sizeHint:e.sizeHint}))}async loadText(e,t,i){return await this.loadResource({src:e,type:"text"},t,i)}async loadBinary(e,t,i){return await this.loadResource({src:e,type:"binary"},t,i)}async loadJson(e,t,i){return await this.loadResource({src:e,type:"json"},t,i)}async loadResource(e,t,i){var r=await this.fetchResource(this.resourceBaseUrl+e.src,t,i);return this.httpRequest.parseResult(e.type,r)}async loadResources(e,t,i){let r=this.buildResourceManifest(e),s=new Map;var a,n=r.length;let o=0,l=r.reduce((e,{sizeHint:t})=>e+(t??0),0),c=0;for(a of r){var h=await this.fetchResource(a.src,t,{onProgress:e=>{c+=e,l&&i?.(Math.floor(100*Math.min(1,c/l)))}});s.set(a.id,h),o++,l||i?.(Math.floor(o/n*100))}return new u(s)}async fetchResource(e,t,i){return await this.httpRequest.fetchRaw(e,t,i)}}),t("LoaderResult",u=class{constructor(e){this.items=e}pop(e){let t;if("string"==typeof e)t=e;else{if(!r.resourceConfigs.has(e))throw new Error(`Missing resourceConfig for resource type "${r.ResourceType[e]}"`);if(t=r.resourceConfigs.get(e).id,!t)throw new Error("Undefined resourceId for resourceType "+e)}var i=this.items.get(t);if(!i)throw new Error(`Resource type "${e}" not found in result.`);return this.items.delete(t),i}})}}}),System.register("tools/DevToolsApi",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("DevToolsApi",i=class{static getPublicNamespace(){return window.r=window.r||Object.create(null)}static registerCommand(e,t){var i=this.getPublicNamespace();i[e]?console.error(`Command ${e} is already registered`):(this.cmdHandlers.set(e,t),Object.defineProperty(i,e,{configurable:!0,get:()=>this.cmdHandlers.get(e)()}))}static unregisterCommand(t){if(this.cmdHandlers.has(t)){this.cmdHandlers.delete(t);let e=this.getPublicNamespace();delete e[t]}else console.error(`Command ${t} is not registered`)}static registerVar(t,e){var i=this.getPublicNamespace();i[t]?console.error(`Runtime variable ${t} is already registered`):(this.runtimeVars.set(t,e),Object.defineProperty(i,t,{configurable:!0,get:()=>this.runtimeVars.get(t).value,set:e=>{this.runtimeVars.get(t).value=e}}))}static unregisterVar(t){if(this.runtimeVars.has(t)){this.runtimeVars.delete(t);let e=this.getPublicNamespace();delete e[t]}else console.error(`Runtime variable ${t} is not registered`)}static listVars(){return this.runtimeVars.keys()}static listCommands(){return this.cmdHandlers.keys()}}),i.cmdHandlers=new Map,i.runtimeVars=new Map}}}),System.register("tools/VehicleTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/theater/rampHeights","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/map/TileCollection","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math","game/gameobject/trait/interface/NotifyTileChange"],function(e,t){"use strict";var o,u,l,d,c,h,r,g,p,m,f,y,T,v,b,S,w,C,E,x,O,i,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,s;t&&t.id;return{setters:[function(e){o=e},function(e){u=e},function(e){l=e},function(e){d=e},function(e){c=e},function(e){h=e},function(e){r=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){i=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e}],execute:function(){e("VehicleTester",s=class{static async main(e){let t=this.renderer=new o.Renderer(800,600);t.init(document.body),t.initStats(document.body);let i=c.WorldScene.factory({x:0,y:0,width:800,height:600},new g.BoxedVar(!0),new g.BoxedVar(V.ShadowQuality.High));this.disposables.add(i),i.scene.background=new THREE.Color(12632256),l.IsoCoords.init({x:0,y:0}),this.theater=await u.Engine.loadTheater(T.TheaterType.Temperate);var r=new h.Rules(u.Engine.getRules());this.rules=r,this.art=new f.Art(r,u.Engine.getArt()),this.images=u.Engine.getImages(),this.voxels=u.Engine.getVoxels(),this.voxelAnims=u.Engine.getVoxelAnims(),this.buildBrowser(r.vehicleRules);let s=new W.CanvasMetrics(t.getCanvas(),window);s.init(),this.disposables.add(s);r=new O.PointerEvents(t,{x:0,y:0},document,s);let a=new M.CameraZoomControls(r,i.cameraZoom);this.disposables.add(a,r),a.init(),t.addScene(i);let n=this.uiAnimationLoop=new p.UiAnimationLoop(t);n.start(),this.worldScene=i,this.vxlGeometryPool=new H.VxlGeometryPool(new G.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){let e=new r.MapGrid({width:10,height:10});var t=e.get3DObject();let i=new THREE.Object3D;i.add(t),this.worldScene.scene.add(i)}static createFloor(){var e=new THREE.PlaneGeometry(1e4,1e4);let t=new THREE.ShadowMaterial;t.opacity=.5;let i=new THREE.Mesh(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.renderOrder=2e5,i.position.y=1,this.worldScene.scene.add(i)}static selectVehicle(e){this.currentVehicle&&!this.currentVehicle.isDisposed&&(this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose());let t=new d.Player("Player");this.disposables.add(t),t.color=this.rules.getMultiplayerColors().get("DarkRed");var i=new b.Alliances(new S.PlayerList),r=new A.UnitSelection,s=new R.Lighting;this.disposables.add(s);var a=new y.RenderableFactory(t,r,i,this.rules,this.art,void 0,new m.ImageFinder(this.images,this.theater),u.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,s,new D.LightingDirector(s,this.renderer,new g.BoxedVar(1)),new g.BoxedVar(!1),new g.BoxedVar(!1),new g.BoxedVar(2),void 0,new j.Strings,new g.BoxedVar(L.FlyerHelperMode.Selected),new g.BoxedVar(!1),new U.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map),r=new P.TileCollection([],null,this.rules.general,K.getRandomInt),i=new k.TileOccupation(r),s=new N.MapBounds,s=new B.Bridges(this.theater.tileSets,r,i,s,this.rules);let n=new E.ObjectFactory(r,i,s,new g.BoxedVar(1)),o=this.currentVehicle=n.create(x.ObjectType.Vehicle,e,this.rules,this.art);o.owner=t,o.position.tile=this.tile,o.harvesterTrait?(o.harvesterTrait.ore=5,o.harvesterTrait.gems=10):o.transportTrait&&o.transportTrait.units.push(n.create(x.ObjectType.Vehicle,"FV",this.rules,this.art),n.create(x.ObjectType.Infantry,"E1",this.rules,this.art),n.create(x.ObjectType.Infantry,"CLEG",this.rules,this.art)),o.tilterTrait?.[q.NotifyTileChange.onTileChange](o);let l=this.world=new F.World,c=new _.RenderableManager(l,this.worldScene,this.worldScene.camera,a);c.init(),this.disposables.add(c),l.spawnObject(o);let h=this.currentRenderable=c.getRenderableByGameObject(o);h.selectionModel.setSelectionLevel(w.SelectionLevel.Selected),h.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let t=this.controlsEl=document.createElement("div");t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.width="200px",t.style.padding="5px",t.style.background="rgba(255, 255, 255, 0.5)",t.style.border="1px black solid",t.appendChild(document.createTextNode("Remap color:"));let e=this.rules.getMultiplayerColors(),r=document.createElement("select");r.style.display="block",r.addEventListener("change",()=>{this.currentVehicle.owner.color=e.get(r.value)}),t.appendChild(r),e.forEach((e,t)=>{let i=document.createElement("option");i.innerHTML=t,i.value=t,i.selected=e.asHex()===this.currentVehicle.owner.color.asHex(),r.appendChild(i)}),t.appendChild(document.createTextNode("Selection level:"));let i=document.createElement("div");t.appendChild(i),[w.SelectionLevel.None,w.SelectionLevel.Hover,w.SelectionLevel.Selected].forEach(e=>{let t=document.createElement("button");t.innerHTML=w.SelectionLevel[e],t.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(e)),i.appendChild(t)}),t.appendChild(document.createTextNode("Veteran level:"));let s=document.createElement("div");t.appendChild(s),this.currentVehicle.veteranTrait&&[C.VeteranLevel.None,C.VeteranLevel.Veteran,C.VeteranLevel.Elite].forEach(e=>{let t=document.createElement("button");t.innerHTML=C.VeteranLevel[e],t.addEventListener("click",()=>this.currentVehicle.veteranTrait.veteranLevel=e),s.appendChild(t)}),t.appendChild(document.createTextNode("Ramp type:"));let a=document.createElement("select");a.style.display="block",a.addEventListener("change",()=>{this.tile.rampType=Number(a.value),this.currentVehicle.tilterTrait?.[q.NotifyTileChange.onTileChange](this.currentVehicle)}),t.appendChild(a);for(let y=0;y<v.rampHeights.length;++y){let e=document.createElement("option");e.innerHTML=""+y,e.value=""+y,a.appendChild(e)}t.appendChild(document.createTextNode("Turret #:"));let n=document.createElement("select");n.style.display="block",n.disabled=!this.currentVehicle.rules.turret,n.addEventListener("change",()=>{this.currentVehicle.turretNo=Number(n.value)}),t.appendChild(n);for(let T=0;T<this.currentVehicle.rules.turretCount;++T){let e=document.createElement("option");e.innerHTML=""+T,e.value=""+T,n.appendChild(e)}t.appendChild(document.createTextNode("isMoving:"));let o=document.createElement("input");o.type="checkbox",o.style.display="block",o.addEventListener("change",e=>{var t=e.target.checked;this.currentVehicle.moveTrait.moveState=t?I.MoveState.Moving:I.MoveState.Idle,this.currentVehicle.rules.consideredAircraft&&t?this.currentVehicle.zone=z.ZoneType.Air:this.currentVehicle.zone=this.currentVehicle.rules.naval?z.ZoneType.Water:z.ZoneType.Ground}),t.appendChild(o),t.appendChild(document.createTextNode("isFiring:"));let l=document.createElement("input");l.type="checkbox",l.style.display="block",l.addEventListener("change",e=>{this.currentVehicle.isFiring=e.target.checked}),t.appendChild(l),t.appendChild(document.createTextNode("isRocking:"));let c=document.createElement("input");if(c.type="checkbox",c.style.display="block",c.addEventListener("change",e=>{e.target.checked?this.currentVehicle.applyRocking(360*Math.random(),1):this.currentVehicle.rocking=void 0}),t.appendChild(c),this.currentVehicle.airSpawnTrait){t.appendChild(document.createTextNode("hasSpawns:"));let e=document.createElement("input");e.type="checkbox",e.style.display="block",e.checked=!!this.currentVehicle.airSpawnTrait.availableSpawns,e.addEventListener("change",e=>{var t=e.target.checked?1:0;this.currentVehicle.airSpawnTrait.debugSetStorage(null,t)}),t.appendChild(e)}t.appendChild(document.createTextNode("Warped out:"));let h=document.createElement("input");h.type="checkbox",h.style.display="block",h.addEventListener("change",e=>{this.currentVehicle.warpedOutTrait.debugSetActive(e.target.checked)}),t.appendChild(h),t.appendChild(document.createTextNode("Direction:"));let u=document.createElement("div");t.appendChild(u);let d=document.createElement("input");d.type="range",d.min="-180",d.max="180",d.value="0",d.disabled=void 0===this.fixedDirection,d.style.verticalAlign="middle",d.addEventListener("input",()=>{this.fixedDirection=Number(d.value)}),u.appendChild(d);let g=document.createElement("button");g.innerHTML="Reset",g.disabled=void 0===this.fixedDirection,g.style.verticalAlign="middle",g.addEventListener("click",()=>{void 0!==this.fixedDirection&&(this.fixedDirection=0,d.value="0")}),u.appendChild(g);let p=document.createElement("input");p.type="checkbox",p.checked=void 0===this.fixedDirection,p.addEventListener("change",e=>{this.fixedDirection=e.target.checked?void 0:0,d.disabled=g.disabled=void 0===this.fixedDirection,d.value="0"}),t.appendChild(p);let m=document.createElement("label");m.innerHTML="Auto rotate",t.appendChild(m);let f=document.createElement("button");f.style.display="block",f.style.color="red",f.innerHTML="DESTROY",f.addEventListener("click",async()=>{this.currentVehicle.isDestroyed=!0,this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),t.appendChild(f),document.body.appendChild(t)}static buildBrowser(e){let i=this.listEl=document.createElement("div");i.style.position="absolute",i.style.right="0",i.style.top="0",i.style.height="600px",i.style.width="200px",i.style.overflowY="auto",i.style.padding="5px",i.style.background="rgba(255, 255, 255, 0.5)",i.style.border="1px black solid",i.appendChild(document.createTextNode("Vehicle types:"));let t=[...e.keys()].filter(e=>this.art.hasObject(e,x.ObjectType.Vehicle)).sort();t.forEach(e=>{let t=document.createElement("a");t.style.display="block",t.textContent=e,t.setAttribute("href","javascript:;"),t.addEventListener("click",()=>{console.log("Selected vehicle",e),this.selectVehicle(e)}),i.appendChild(t)}),document.body.appendChild(i),setTimeout(()=>{this.selectVehicle(t[0]),this.animateVehicle()},50)}static animateVehicle(){this.currentVehicle.direction=this.fixedDirection??(this.currentVehicle.direction+1)%360,this.currentVehicle.turretTrait&&(this.currentVehicle.turretTrait.facing=this.fixedDirection??(this.currentVehicle.turretTrait.facing+2)%360),setTimeout(()=>this.animateVehicle(),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),s.tile={rx:1,ry:1,rampType:0,z:0},s.disposables=new i.CompositeDisposable}}}),System.register("tools/InfantryTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/gameobject/unit/ZoneType","game/type/SpeedType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],function(e,t){"use strict";var o,h,l,u,c,d,r,g,p,m,f,y,T,s,a,n,v,b,S,w,C,E,i,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K;t&&t.id;return{setters:[function(e){o=e},function(e){h=e},function(e){l=e},function(e){u=e},function(e){c=e},function(e){d=e},function(e){r=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){i=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e}],execute:function(){e("InfantryTester",K=class{static async main(e){let t=this.renderer=new o.Renderer(800,600);t.init(document.body),t.initStats(document.body);let i=c.WorldScene.factory({x:0,y:0,width:800,height:600},new g.BoxedVar(!0),new g.BoxedVar(V.ShadowQuality.High));this.disposables.add(i),i.scene.background=new THREE.Color(12632256),l.IsoCoords.init({x:0,y:0}),this.theater=await h.Engine.loadTheater(T.TheaterType.Snow);var r=new d.Rules(h.Engine.getRules());this.rules=r,this.art=new f.Art(r,h.Engine.getArt()),this.images=h.Engine.getImages(),this.buildBrowser(r.infantryRules);let s=new W.CanvasMetrics(t.getCanvas(),window);s.init(),this.disposables.add(s);r=new E.PointerEvents(t,{x:0,y:0},document,s);let a=new O.CameraZoomControls(r,i.cameraZoom);this.disposables.add(a,r),a.init(),t.addScene(i);let n=this.uiAnimationLoop=new p.UiAnimationLoop(t);n.start(),this.worldScene=i,this.addGrid()}static addGrid(){let e=new r.MapGrid({width:10,height:10});var t=e.get3DObject();let i=new THREE.Object3D;i.add(t),this.worldScene.scene.add(i)}static selectInfantry(e){this.currentInfantry&&!this.currentInfantry.isDisposed&&(this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose());let t=new u.Player("Player");this.disposables.add(t),t.color=this.rules.getMultiplayerColors().get("DarkRed");var i=new b.Alliances(new S.PlayerList),r=new x.UnitSelection,s=new A.Lighting;this.disposables.add(s);var a=new y.RenderableFactory(t,r,i,this.rules,this.art,void 0,new m.ImageFinder(this.images,this.theater),h.Engine.getPalettes(),null,null,this.theater,this.worldScene.camera,s,new D.LightingDirector(s,this.renderer,new g.BoxedVar(1)),new g.BoxedVar(!1),new g.BoxedVar(!1),new g.BoxedVar(2),void 0,new j.Strings,new g.BoxedVar(L.FlyerHelperMode.Selected),new g.BoxedVar(!1),new U.VxlBuilderFactory(new H.VxlGeometryPool(new G.VxlGeometryCache),!1,this.worldScene.camera),new Map),r=new R.TileCollection([],null,this.rules.general,z.getRandomInt),i=new k.TileOccupation(r),s=new N.MapBounds,s=new B.Bridges(this.theater.tileSets,r,i,s,this.rules);let n=this.currentInfantry=new M.ObjectFactory(r,i,s,new g.BoxedVar(1)).create(P.ObjectType.Infantry,e,this.rules,this.art);n.owner=t,n.position.tile={rx:1,ry:1,z:0,rampType:0};let o=this.world=new F.World,l=new _.RenderableManager(o,this.worldScene,this.worldScene.camera,a);l.init(),this.disposables.add(l),o.spawnObject(n);let c=this.currentRenderable=l.getRenderableByGameObject(n);c.selectionModel.setSelectionLevel(w.SelectionLevel.Selected),c.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let e=this.controlsEl=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="200px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=new Map(this.rules.getMultiplayerColors()),r=document.createElement("select");r.style.display="block",r.addEventListener("change",()=>{this.currentInfantry.owner.color=t.get(r.value)}),e.appendChild(r),t.forEach((e,t)=>{let i=document.createElement("option");i.innerHTML=t,i.value=t,i.selected=e.asHex()===this.currentInfantry.owner.color.asHex(),r.appendChild(i)}),e.appendChild(document.createTextNode("Selection level:"));let i=document.createElement("div");e.appendChild(i),[w.SelectionLevel.None,w.SelectionLevel.Hover,w.SelectionLevel.Selected].forEach(e=>{let t=document.createElement("button");t.innerHTML=w.SelectionLevel[e],t.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(e)),i.appendChild(t)}),e.appendChild(document.createTextNode("Veteran level:"));let s=document.createElement("div");e.appendChild(s),this.currentInfantry.veteranTrait&&[C.VeteranLevel.None,C.VeteranLevel.Veteran,C.VeteranLevel.Elite].forEach(e=>{let t=document.createElement("button");t.innerHTML=C.VeteranLevel[e],t.addEventListener("click",()=>this.currentInfantry.veteranTrait.veteranLevel=e),s.appendChild(t)}),e.appendChild(document.createTextNode("SubCell:"));let a=document.createElement("select");a.style.display="block",a.addEventListener("change",()=>{this.currentInfantry.position.subCell=Number(a.value)}),e.appendChild(a);for(let h=0;h<5;++h){let e=document.createElement("option");e.innerHTML=""+h,e.value=""+h,a.appendChild(e)}e.appendChild(document.createTextNode("Zone:")),this.createZoneSelect(e),e.appendChild(document.createTextNode("Stance:")),this.createStanceSelect(e),e.appendChild(document.createTextNode("isMoving:"));let n=document.createElement("input");n.type="checkbox",n.style.display="block",n.addEventListener("change",e=>{this.currentInfantry.moveTrait.moveState=e.target.checked?I.MoveState.Moving:I.MoveState.Idle}),e.appendChild(n),e.appendChild(document.createTextNode("isFiring:"));let o=document.createElement("input");o.type="checkbox",o.disabled=!this.currentInfantry.rules.primary,o.style.display="block",o.addEventListener("change",e=>{this.currentInfantry.isFiring=e.target.checked}),e.appendChild(o),e.appendChild(document.createTextNode("isPanicked:"));let l=document.createElement("input");l.type="checkbox",l.disabled=!this.currentInfantry.rules.fraidycat,l.style.display="block",l.addEventListener("change",e=>{this.currentInfantry.isPanicked=e.target.checked}),e.appendChild(l),e.appendChild(document.createTextNode("Warped out:"));let c=document.createElement("input");c.type="checkbox",c.style.display="block",c.addEventListener("change",e=>{this.currentInfantry.warpedOutTrait.debugSetActive(e.target.checked)}),e.appendChild(c),this.createDeathSelect(e),document.body.appendChild(e)}static createZoneSelect(e){let t=document.createElement("select");t.style.display="block",t.addEventListener("change",()=>{this.currentInfantry.zone=Number(t.value)}),e.appendChild(t);let i=document.createElement("option");if(i.value=""+s.ZoneType.Ground,i.innerHTML=s.ZoneType[s.ZoneType.Ground],t.appendChild(i),this.currentInfantry.rules.consideredAircraft){let e=document.createElement("option");e.value=""+s.ZoneType.Air,e.innerHTML=s.ZoneType[s.ZoneType.Air],t.appendChild(e)}if(this.currentInfantry.rules.speedType===a.SpeedType.Amphibious){let e=document.createElement("option");e.value=""+s.ZoneType.Water,e.innerHTML=s.ZoneType[s.ZoneType.Water],t.appendChild(e)}}static createStanceSelect(e){let t=document.createElement("select");t.style.display="block",t.addEventListener("change",()=>{this.currentInfantry.stance=Number(t.value)}),e.appendChild(t);let i=document.createElement("option");i.value=""+n.StanceType.None,i.innerHTML=n.StanceType[n.StanceType.None],t.appendChild(i);let r=document.createElement("option");r.value=""+n.StanceType.Guard,r.innerHTML=n.StanceType[n.StanceType.Guard],t.appendChild(r);let s=document.createElement("option");s.value=""+n.StanceType.Paradrop,s.innerHTML=n.StanceType[n.StanceType.Paradrop],t.appendChild(s);let a=document.createElement("option");if(a.value=""+n.StanceType.Cheer,a.innerHTML=n.StanceType[n.StanceType.Cheer],t.appendChild(a),this.currentInfantry.rules.proneWhenAttacked){let e=document.createElement("option");e.value=""+n.StanceType.Prone,e.innerHTML=n.StanceType[n.StanceType.Prone],t.appendChild(e)}if(this.currentInfantry.rules.deployer){let e=document.createElement("option");e.value=""+n.StanceType.Deployed,e.innerHTML=n.StanceType[n.StanceType.Deployed],t.appendChild(e)}}static createDeathSelect(e){e.appendChild(document.createTextNode("Death"));let t=document.createElement("select"),i=1,r=v.InfDeathType[i];for(;void 0!==r;){let e=document.createElement("option");e.innerHTML=r,e.value=""+i,e.disabled=!this.currentInfantry.rules.isHuman&&![v.InfDeathType.Gunfire,v.InfDeathType.Explode].includes(i),t.appendChild(e),r=v.InfDeathType[++i]}e.appendChild(t);let s=document.createElement("button");s.style.display="block",s.style.color="red",s.innerHTML="KILL",s.addEventListener("click",async()=>{this.currentInfantry.isDestroyed=!0,this.currentInfantry.infDeathType=Number(t.value),this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),e.appendChild(s)}static buildBrowser(e){let i=this.listEl=document.createElement("div");i.style.position="absolute",i.style.right="0",i.style.top="0",i.style.height="600px",i.style.width="200px",i.style.overflowY="auto",i.style.padding="5px",i.style.width="200px",i.style.background="rgba(255, 255, 255, 0.5)",i.style.border="1px black solid",i.appendChild(document.createTextNode("Infantry types:"));let t=[...e.keys()].filter(e=>this.art.hasObject(e,P.ObjectType.Infantry)).sort();t.forEach(e=>{let t=document.createElement("a");t.style.display="block",t.textContent=e,t.setAttribute("href","javascript:;"),t.addEventListener("click",()=>{console.log("Selected infantry",e),this.selectInfantry(e)}),i.appendChild(t)}),document.body.appendChild(i),setTimeout(()=>{this.selectInfantry(t[0]),this.animateInfantry()},50)}static animateInfantry(){this.currentInfantry.isDisposed||(this.currentInfantry.direction=(this.currentInfantry.direction+1)%360),setTimeout(()=>this.animateInfantry(),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),K.disposables=new i.CompositeDisposable}}}),System.register("tools/AircraftTester",["engine/gfx/Renderer","engine/Engine","game/Coords","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","engine/RenderableManager","game/World","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math"],function(e,t){"use strict";var o,h,d,l,u,c,g,r,p,m,f,y,T,v,b,S,w,C,E,i,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,s;t&&t.id;return{setters:[function(e){o=e},function(e){h=e},function(e){d=e},function(e){l=e},function(e){u=e},function(e){c=e},function(e){g=e},function(e){r=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){i=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e}],execute:function(){e("AircraftTester",s=class{static async main(e){let t=this.renderer=new o.Renderer(800,600);t.init(document.body),t.initStats(document.body);let i=c.WorldScene.factory({x:0,y:0,width:800,height:600},new p.BoxedVar(!0),new p.BoxedVar(V.ShadowQuality.High));this.disposables.add(i),i.scene.background=new THREE.Color(12632256),l.IsoCoords.init({x:0,y:0}),this.theater=await h.Engine.loadTheater(v.TheaterType.Temperate);var r=new g.Rules(h.Engine.getRules());this.rules=r,this.art=new y.Art(r,h.Engine.getArt()),this.images=h.Engine.getImages(),this.voxels=h.Engine.getVoxels(),this.voxelAnims=h.Engine.getVoxelAnims(),this.buildBrowser(r.aircraftRules);let s=new W.CanvasMetrics(t.getCanvas(),window);s.init(),this.disposables.add(s);r=new E.PointerEvents(t,{x:0,y:0},document,s);let a=new O.CameraZoomControls(r,i.cameraZoom);a.init(),this.disposables.add(r,a),t.addScene(i);let n=this.uiAnimationLoop=new m.UiAnimationLoop(t);n.start(),this.worldScene=i,this.vxlGeometryPool=new H.VxlGeometryPool(new G.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){let e=new r.MapGrid({width:10,height:10});var t=e.get3DObject();let i=new THREE.Object3D;i.add(t),this.worldScene.scene.add(i)}static createFloor(){var e=new THREE.PlaneGeometry(1e4,1e4);let t=new THREE.ShadowMaterial;t.opacity=.5;let i=new THREE.Mesh(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.renderOrder=2e5,this.worldScene.scene.add(i)}static selectAircraft(e){this.currentAircraft&&(this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose());let t=new u.Player("Player");this.disposables.add(t),t.color=this.rules.getMultiplayerColors().get("DarkRed");var i=new b.Alliances(new S.PlayerList),r=new x.UnitSelection,s=new A.Lighting;this.disposables.add(s);var a=new T.RenderableFactory(t,r,i,this.rules,this.art,void 0,new f.ImageFinder(this.images,this.theater),h.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,s,new _.LightingDirector(s,this.renderer,new p.BoxedVar(1)),new p.BoxedVar(!1),new p.BoxedVar(!1),new p.BoxedVar(2),void 0,new L.Strings,new p.BoxedVar(F.FlyerHelperMode.Selected),new p.BoxedVar(!1),new U.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map),r=new R.TileCollection([],null,this.rules.general,K.getRandomInt),i=new k.TileOccupation(r),s=new D.MapBounds,s=new B.Bridges(this.theater.tileSets,r,i,s,this.rules);let n=this.currentAircraft=new M.ObjectFactory(r,i,s,new p.BoxedVar(0)).create(P.ObjectType.Aircraft,e,this.rules,this.art);n.owner=t,n.position.tile={rx:1,ry:1,z:0,rampType:0};let o=this.world=new N.World,l=new j.RenderableManager(o,this.worldScene,this.worldScene.camera,a);l.init(),this.disposables.add(l),o.spawnObject(n);let c=this.currentRenderable=l.getRenderableByGameObject(n);c.selectionModel.setSelectionLevel(w.SelectionLevel.None),c.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let e=this.controlsEl=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="200px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=this.rules.getMultiplayerColors(),r=document.createElement("select");r.style.display="block",r.addEventListener("change",()=>{this.currentAircraft.owner.color=t.get(r.value)}),e.appendChild(r),t.forEach((e,t)=>{let i=document.createElement("option");i.innerHTML=t,i.value=t,i.selected=e.asHex()===this.currentAircraft.owner.color.asHex(),r.appendChild(i)}),e.appendChild(document.createTextNode("Selection level:"));let i=document.createElement("div");e.appendChild(i),[w.SelectionLevel.None,w.SelectionLevel.Hover,w.SelectionLevel.Selected].forEach(e=>{let t=document.createElement("button");t.innerHTML=w.SelectionLevel[e],t.disabled=!this.currentAircraft.rules.selectable,t.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(e)),i.appendChild(t)}),e.appendChild(document.createTextNode("Veteran level:"));let s=document.createElement("div");e.appendChild(s),this.currentAircraft.veteranTrait&&[C.VeteranLevel.None,C.VeteranLevel.Veteran,C.VeteranLevel.Elite].forEach(e=>{let t=document.createElement("button");t.innerHTML=C.VeteranLevel[e],t.addEventListener("click",()=>this.currentAircraft.veteranTrait.veteranLevel=e),s.appendChild(t)}),e.appendChild(document.createTextNode("Rudder:"));let a=document.createElement("input");a.style.display="block",a.type="range",a.min="-180",a.max="180",a.value="0",a.addEventListener("input",()=>{this.currentAircraft.yaw=Number(a.value)}),e.appendChild(a);let n=document.createElement("input");n.style.display="block",n.type="range",n.min="-180",n.max="180",n.value="0",n.addEventListener("input",()=>{this.currentAircraft.pitch=Number(n.value)}),e.appendChild(n);let o=document.createElement("input");o.style.display="block",o.type="range",o.min="-180",o.max="180",o.value="0",o.addEventListener("input",()=>{this.currentAircraft.roll=Number(o.value)}),e.appendChild(o),e.appendChild(document.createTextNode("Height:"));let l=document.createElement("input");l.type="range",l.min="0",l.max="2560",l.value="0",l.style.display="block",l.addEventListener("input",()=>{this.currentAircraft.position.tileElevation=d.Coords.worldToTileHeight(Number(l.value))}),e.appendChild(l),e.appendChild(document.createTextNode("isMoving:"));let c=document.createElement("input");c.type="checkbox",c.style.display="block",c.addEventListener("change",e=>{var t=e.target.checked;this.currentAircraft.moveTrait.moveState=t?I.MoveState.Moving:I.MoveState.Idle,this.currentAircraft.zone=t?z.ZoneType.Air:z.ZoneType.Ground}),e.appendChild(c),e.appendChild(document.createTextNode("Warped out:"));let h=document.createElement("input");h.type="checkbox",h.style.display="block",h.addEventListener("change",e=>{this.currentAircraft.warpedOutTrait.debugSetActive(e.target.checked)}),e.appendChild(h);let u=document.createElement("button");u.style.display="block",u.style.color="red",u.innerHTML="DESTROY",u.addEventListener("click",async()=>{this.currentAircraft.isDestroyed=!0,this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose(),this.currentAircraft=void 0,document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),e.appendChild(u),document.body.appendChild(e)}static buildBrowser(e){let i=this.listEl=document.createElement("div");i.style.position="absolute",i.style.right="0",i.style.top="0",i.style.height="600px",i.style.width="200px",i.style.overflowY="auto",i.style.padding="5px",i.style.background="rgba(255, 255, 255, 0.5)",i.style.border="1px black solid",i.appendChild(document.createTextNode("Aircraft types:"));let t=[...e.keys()].filter(e=>this.art.hasObject(e,P.ObjectType.Aircraft)).sort();t.forEach(e=>{let t=document.createElement("a");t.style.display="block",t.textContent=e,t.setAttribute("href","javascript:;"),t.addEventListener("click",()=>{console.log("Selected aircraft",e),this.selectAircraft(e)}),i.appendChild(t)}),document.body.appendChild(i),setTimeout(()=>{this.selectAircraft(t[0])},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),s.disposables=new i.CompositeDisposable}}}),System.register("tools/SoundTester",["util/disposable/CompositeDisposable","data/AudioBagFile","data/IdxFile","engine/Engine"],function(e,t){"use strict";var i,s,a,n,r;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){e("SoundTester",r=class r{static async main(e,t){this.sounds=n.Engine.getSounds(),this.audioBag=new s.AudioBagFile;var i=e.openFile("audio.bag"),r=e.openFile("audio.idx");this.audioBag.fromVirtualFile(i,new a.IdxFile(r.stream)),e.addArchive(this.audioBag,"audio.bag"),this.buildBrowser()}static selectSound(e){let i=new AudioContext,r=i.createGain();r.gain.value=.5;var t=new Uint8Array(this.sounds.get(e).getData()).buffer;i.decodeAudioData(t,e=>{let t=i.createBufferSource();t.buffer=e,t.connect(r).connect(i.destination),t.start(0)},e=>console.log(e))}static buildBrowser(){let i=this.listEl=document.createElement("div");i.style.position="absolute",i.style.right="0",i.style.top="0",i.style.height="600px",i.style.width="200px",i.style.overflowY="auto",i.style.padding="5px",i.style.background="rgba(255, 255, 255, 0.5)",i.style.border="1px black solid",i.appendChild(document.createTextNode("Sound files:"));let e=this.audioBag.getFileList();e.forEach(e=>{let t=document.createElement("a");t.style.display="block",t.textContent=e,t.setAttribute("href","javascript:;"),t.addEventListener("click",()=>{r.selectSound(e)}),i.appendChild(t)}),document.body.appendChild(i)}static destroy(){this.listEl.remove(),this.disposables.dispose()}}),r.disposables=new i.CompositeDisposable}}}),System.register("LocalPrefs",[],function(t,e){"use strict";var i,r;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{}).GameRes="_r_gameRes",e.Options="_r_opts_v3",e.Mixer="_r_mixer_v3",e.MusicOpts="_r_opts_music",e.LastGpuTier="_r_last_gpu",e.LastMap="_r_lastMap",e.LastMode="_r_lastMode",e.LastSortMap="_r_lastSortMap",e.LastPlayerCountry="_r_lastCountry",e.LastPlayerColor="_r_lastColor",e.PreferredGameOpts="_r_hostOpts",e.LastConnection="_r_lastCon",e.PreferredServerRegion="_r_region",e.TauntsEnabled="_r_taunts",e.DonateBoxState="_r_donateBoxState",t("StorageKey",i),t("LocalPrefs",r=class{constructor(e){this.storage=e}getItem(t){try{return this.storage?.getItem(t)??void 0}catch(e){return void console.warn(`Unable to read key ${t} from localStorage.`,e)}}setItem(t,e){try{return this.storage?.setItem(t,e),!0}catch(e){return console.warn(`Unable to write key ${t} to localStorage.`,e),!1}}removeItem(t){try{this.storage?.removeItem(t)}catch(e){console.warn(`Unable to remove key ${t} from localStorage.`,e)}}listItems(){return this.storage?Object.keys(this.storage):[]}})}}}),System.register("util/fullScreen",[],function(e,t){"use strict";t&&t.id;return e("setupFullScreenChangeListener",function(i,r){if(i.fullscreenEnabled){let t=!0;const e=()=>{var e=!!i.fullscreenElement;e?t=!1:setTimeout(()=>t=!0,100),r(e)},s=async e=>{if(122===e.keyCode&&t&&!i.fullscreenElement)try{await i.documentElement.requestFullscreen()}catch(e){console.warn("Full screen permission denied by user.")}};return i.addEventListener("fullscreenchange",e),i.addEventListener("keyup",s),()=>{i.removeEventListener("fullscreenchange",e),i.removeEventListener("keyup",s)}}console.warn("Browser fullscreen API not available.")}),{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommandType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{}).CenterView="CenterView",e.Options="Options",e.CenterOnRadarEvent="CenterOnRadarEvent",e.RightSidebarUp="RightSidebarUp",e.RightSidebarDown="RightSidebarDown",e.LeftSidebarDown="LeftSidebarDown",e.LeftSidebarUp="LeftSidebarUp",e.Delete="Delete",e.TeamSelect_10="TeamSelect_10",e.TeamSelect_1="TeamSelect_1",e.TeamSelect_2="TeamSelect_2",e.TeamSelect_3="TeamSelect_3",e.TeamSelect_4="TeamSelect_4",e.TeamSelect_5="TeamSelect_5",e.TeamSelect_6="TeamSelect_6",e.TeamSelect_7="TeamSelect_7",e.TeamSelect_8="TeamSelect_8",e.TeamSelect_9="TeamSelect_9",e.ToggleAlliance="ToggleAlliance",e.PlaceBeacon="PlaceBeacon",e.AllToCheer="AllToCheer",e.DeployObject="DeployObject",e.InfantryTab="InfantryTab",e.Follow="Follow",e.GuardObject="GuardObject",e.CenterBase="CenterBase",e.ToggleRepair="ToggleRepair",e.ToggleSell="ToggleSell",e.PreviousObject="PreviousObject",e.NextObject="NextObject",e.CombatantSelect="CombatantSelect",e.StructureTab="StructureTab",e.UnitTab="UnitTab",e.StopObject="StopObject",e.TypeSelect="TypeSelect",e.PageUser="PageUser",e.DefenseTab="DefenseTab",e.ScatterObject="ScatterObject",e.HealthNav="HealthNav",e.VeterancyNav="VeterancyNav",e.PlanningMode="PlanningMode",e.View1="View1",e.View2="View2",e.View3="View3",e.View4="View4",e.Taunt_1="Taunt_1",e.Taunt_2="Taunt_2",e.Taunt_3="Taunt_3",e.Taunt_4="Taunt_4",e.Taunt_5="Taunt_5",e.Taunt_6="Taunt_6",e.Taunt_7="Taunt_7",e.Taunt_8="Taunt_8",e.RaiseCell="RaiseCell",e.LowerCell="LowerCell",e.DeleteObject="DeleteObject",e.TeamAddSelect_10="TeamAddSelect_10",e.TeamAddSelect_1="TeamAddSelect_1",e.TeamAddSelect_2="TeamAddSelect_2",e.TeamAddSelect_3="TeamAddSelect_3",e.TeamAddSelect_4="TeamAddSelect_4",e.TeamAddSelect_5="TeamAddSelect_5",e.TeamAddSelect_6="TeamAddSelect_6",e.TeamAddSelect_7="TeamAddSelect_7",e.TeamAddSelect_8="TeamAddSelect_8",e.TeamAddSelect_9="TeamAddSelect_9",e.IonStorm="IonStorm",e.TeamCreate_10="TeamCreate_10",e.TeamCreate_1="TeamCreate_1",e.TeamCreate_2="TeamCreate_2",e.TeamCreate_3="TeamCreate_3",e.TeamCreate_4="TeamCreate_4",e.TeamCreate_5="TeamCreate_5",e.TeamCreate_6="TeamCreate_6",e.TeamCreate_7="TeamCreate_7",e.TeamCreate_8="TeamCreate_8",e.TeamCreate_9="TeamCreate_9",e.ScreenCapture="ScreenCapture",e.ToggleElite="ToggleElite",e.FreeMoney="FreeMoney",e.IonBlast="IonBlast",e.LightningBolt="LightningBolt",e.ToggleMono="ToggleMono",e.NukeExplosion="NukeExplosion",e.BuildCheat="BuildCheat",e.ToggleShroud="ToggleShroud",e.ToggleThreatPrint="ToggleThreatPrint",e.SpecialWeapons="SpecialWeapons",e.ToggleAttackFriendlies="ToggleAttackFriendlies",e.SetView1="SetView1",e.SetView2="SetView2",e.SetView3="SetView3",e.SetView4="SetView4",e.Explosion="Explosion",e.PrevMonoPage="PrevMonoPage",e.NextMonoPage="NextMonoPage",e.TeamCenter_10="TeamCenter_10",e.TeamCenter_1="TeamCenter_1",e.TeamCenter_2="TeamCenter_2",e.TeamCenter_3="TeamCenter_3",e.TeamCenter_4="TeamCenter_4",e.TeamCenter_5="TeamCenter_5",e.TeamCenter_6="TeamCenter_6",e.TeamCenter_7="TeamCenter_7",e.TeamCenter_8="TeamCenter_8",e.TeamCenter_9="TeamCenter_9",e.ToggleMarbleMadness="ToggleMarbleMadness",e.ForceWin="ForceWin",e.BailOut="BailOut",e.SuperExplosion="SuperExplosion",e.SidebarPageUp="SidebarPageUp",e.SidebarUp="SidebarUp",e.SidebarPageDown="SidebarPageDown",e.SidebarDown="SidebarDown",e.ToggleFps="ToggleFps",e.Scoreboard="Scoreboard",t("KeyCommandType",i)}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyBinds",["data/DataStream","data/IniFile","data/vfs/VirtualFile","gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(e,t){"use strict";var i,s,r,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e},function(e){a=e}],execute:function(){n=new Map([[98,40],[100,37],[102,39],[104,38]]),e("KeyBinds",o=class o{constructor(e,t,i){this.configDir=e,this.persistFileName=t,this.defaultIni=i,this.hotKeys=new Map}async load(){this.hotKeys.clear();let e=!0,t;try{this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&(t=new s.IniFile(await this.configDir.openFile(this.persistFileName)),this.loadHotKeys(t),e=!1)}catch(e){console.log(`Failed to load hotkeys from local file "${this.persistFileName}"`,e)}if(e){var i,r;t=this.defaultIni;for([i,r]of new Map([[a.KeyCommandType.PreviousObject,"M".charCodeAt(0)],[a.KeyCommandType.VeterancyNav,"Y".charCodeAt(0)],[a.KeyCommandType.HealthNav,"U".charCodeAt(0)],[a.KeyCommandType.FreeMoney,582],[a.KeyCommandType.BuildCheat,593],[a.KeyCommandType.ToggleFps,512+"R".charCodeAt(0)],[a.KeyCommandType.ToggleShroud,1024+"S".charCodeAt(0)]]))this.addHotKey(i,r);this.loadHotKeys(t)}this.addHotKey(a.KeyCommandType.Scoreboard,9)}async saveIni(e){await this.configDir?.writeFile(new r.VirtualFile((new i.DataStream).writeString(e.toString()),this.persistFileName))}async resetAndReload(){this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&await this.configDir.deleteFile(this.persistFileName),await this.load()}loadHotKeys(e){let t=e.getSection(o.iniSection);if(!t)throw new Error(`Missing [${o.iniSection}] ini section`);let i=Object.keys(a.KeyCommandType);for(var r of t.entries.keys()){var s;i.includes(r)?(s=t.getNumber(r),this.changeHotKey(r,s)):console.warn("Unknown keyboard command "+r)}return this}async save(){let e=new s.IniFile,t=e.getOrCreateSection(o.iniSection);for(var[i,r]of this.hotKeys)t.set(r,""+i);await this.saveIni(e)}addHotKey(e,t){this.hotKeys.set("number"==typeof t?t:this.getHotKeyCode(t),e)}changeHotKey(t,e){var i;for(i of[...this.hotKeys.entries()].filter(([,e])=>e===t).map(([e])=>e))this.hotKeys.delete(i);e&&this.addHotKey(t,e)}getCommandType(e){if(!(255<e.keyCode)){var t=this.getHotKeyCode(e);return this.hotKeys.get(t)}}getHotKeyCode(e){let t=(Number(e.metaKey)<<12)+(Number(e.altKey)<<10)+(Number(e.ctrlKey)<<9)+(Number(e.shiftKey)<<8)+e.keyCode;var i=n.get(e.keyCode);return i&&(t+=2048-e.keyCode+i),t}getHotKey(t){var e,i=[...this.hotKeys.entries()].find(([,e])=>e===t)?.[0];if(void 0!==i){let t=255&i;return 2048&i&&((e=[...n].find(([,e])=>e===t)?.[0])?t=e:console.error(`Expected an numpad arrow key code but got ${t} (${i}) instead`)),{keyCode:t,shiftKey:Boolean(256&i),ctrlKey:Boolean(512&i),altKey:Boolean(1024&i),metaKey:Boolean(4096&i)}}}}),o.iniSection="Hotkey"}}}),System.register("gui/FullScreen",["util/disposable/CompositeDisposable","util/fullScreen","util/event"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("FullScreen",a=class a{constructor(e){this.document=e,this.disposables=new i.CompositeDisposable,this._onChange=new s.EventDispatcher,this.handleFullScreenChange=e=>{this._onChange.dispatch(this,e)}}static isFullScreenHotKey(e){return e.keyCode===this.hotKey.keyCode&&e.altKey===this.hotKey.altKey&&e.shiftKey===this.hotKey.shiftKey&&e.ctrlKey===this.hotKey.ctrlKey&&e.metaKey===this.hotKey.metaKey}get onChange(){return this._onChange.asEvent()}init(){const e=e=>{a.isFullScreenHotKey(e)&&(e.preventDefault(),e.stopPropagation(),this.toggle())};this.document.addEventListener("keydown",e),this.disposables.add(()=>this.document.removeEventListener("keydown",e));var t=r.setupFullScreenChangeListener(this.document,this.handleFullScreenChange);t&&this.disposables.add(t)}toggle(){this.toggleAsync().catch(e=>console.error(e))}isFullScreen(){return!!this.document.fullscreenElement}async toggleAsync(){this.document.fullscreenElement?await this.document.exitFullscreen():await this.document.documentElement.requestFullscreen()}dispose(){this.disposables.dispose()}}),a.hotKey={altKey:!0,shiftKey:!1,ctrlKey:!1,metaKey:!1,keyCode:"F".charCodeAt(0)}}}}),System.register("network/ServerRegions",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ServerRegions",i=class{constructor(){this.regions=new Map}load(e){this.regions.clear();for(var t of e.getOrderedSections())this.regions.set(t.name,{id:t.name,label:t.getString("label"),available:t.getBool("available",!0),gameVersion:this.normalizeVersion(t.getString("gameVersion")||void 0),gservUrl:t.getString("gservUrl"),wolUrl:t.getString("wolUrl"),wladderUrl:t.getString("wladderUrl")||void 0,wgameresUrl:t.getString("wgameresUrl")||void 0,wolv2Ascii:t.getBool("wolv2Ascii"),wolKeepAliveInGame:t.getBool("wolKeepAliveInGame")})}normalizeVersion(e){return void 0!==e&&e.match(/^\d+\.\d+$/)&&(e+=".0"),e}get(e){if(!this.regions.has(e))throw new Error("Unknown region id "+e);return this.regions.get(e)}has(e){return this.regions.has(e)}isAvailable(e){return this.regions.has(e)&&this.regions.get(e).available}getAll(){return[...this.regions.values()]}getFirstAvailable(){return this.getAll().filter(e=>e.available)[0]}getSize(){return this.regions.size}setSelectedRegion(e){this.selectedRegion=this.get(e)}getSelectedRegion(){if(!this.selectedRegion)throw new Error("No server region selected");return this.selectedRegion}})}}}),System.register("gui/screen/options/GraphicsOptions",["engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","util/BoxedVar"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("GraphicsOptions",a=class{constructor(){this.resolution=new s.BoxedVar(void 0),this.models=new s.BoxedVar(i.ModelQuality.High),this.shadows=new s.BoxedVar(r.ShadowQuality.High)}unserialize(e){let[t,i,r]=e.split(",");var s;return this.models.value=Number(t),this.shadows.value=Number(i),void 0!==r&&(s=r.length?r.split("x").map(e=>Number(e)):void 0,this.resolution.value=s?{width:s[0],height:s[1]}:void 0),this}serialize(){return[this.models.value,this.shadows.value,this.resolution.value?[this.resolution.value.width,this.resolution.value.height].join("x"):""].join(",")}applyLowPreset(){this.models.value=i.ModelQuality.Low,this.shadows.value=r.ShadowQuality.Low}applyHighPreset(){this.models.value=i.ModelQuality.High,this.shadows.value=r.ShadowQuality.High}})}}}),System.register("gui/screen/options/GeneralOptions",["engine/renderable/entity/unit/FlyerHelperMode","util/Base64","util/BoxedVar","gui/screen/options/GraphicsOptions"],function(e,t){"use strict";var i,c,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){c=e},function(e){r=e},function(e){s=e}],execute:function(){e("SCROLL_BASE_FACTOR",3),e("GeneralOptions",a=class{constructor(){this.scrollRate=new r.BoxedVar(12),this.flyerHelper=new r.BoxedVar(i.FlyerHelperMode.Selected),this.hiddenObjects=new r.BoxedVar(!0),this.targetLines=new r.BoxedVar(!0),this.rightClickMove=new r.BoxedVar(!1),this.rightClickScroll=new r.BoxedVar(!0),this.mouseAcceleration=new r.BoxedVar(!0),this.graphics=new s.GraphicsOptions}unserialize(e){var[t,i,r,s,a,n,o,l]=e.split(",");return this.scrollRate.value=Number(t),void 0!==i&&(this.flyerHelper.value=Number(i)),void 0!==r&&this.graphics.unserialize(c.Base64.decode(r)),void 0!==s&&(this.hiddenObjects.value=Boolean(Number(s))),void 0!==a&&(this.rightClickMove.value=Boolean(Number(a))),void 0!==n&&(this.rightClickScroll.value=Boolean(Number(n))),void 0!==o&&(this.targetLines.value=Boolean(Number(o))),void 0!==l&&(this.mouseAcceleration.value=Boolean(Number(l))),this}serialize(){return[this.scrollRate.value,this.flyerHelper.value,c.Base64.encode(this.graphics.serialize()),Number(this.hiddenObjects.value),Number(this.rightClickMove.value),Number(this.rightClickScroll.value),Number(this.targetLines.value),Number(this.mouseAcceleration.value)].join(",")}})}}}),System.register("engine/gameRes/GameResConfig",["engine/gameRes/GameResSource"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("GameResConfig",i=class{constructor(e){this.defaultCdnBaseUrl=e}unserialize(e){var[t,i]=e.split(","),t=Number(t);if(!r.GameResSource[t])throw new Error(`Unknown game res source "${t}"`);this.source=t,this.cdnUrl=i?decodeURI(i):void 0}serialize(){return this.source+(this.cdnUrl?","+encodeURI(this.cdnUrl):"")}isCdn(){return this.source===r.GameResSource.Cdn}getCdnBaseUrl(){return this.cdnUrl??this.defaultCdnBaseUrl}})}}}),System.register("gui/component/Dialog",["react"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.default.Component{render(){return this.props.hidden?null:i.default.createElement("div",{style:this.getWrapperStyle()},i.default.createElement("div",{className:"message-box "+this.props.className},i.default.createElement("div",{className:"message-box-content"},this.props.children),i.default.createElement("div",{className:"message-box-footer"},this.props.buttons.map((e,t)=>this.renderButton(e,t)))))}renderButton(e,t){return i.default.createElement("button",{key:t,className:"dialog-button",onClick:e.onClick},e.label)}getWrapperStyle(){var e=this.props.viewport;return{position:"absolute",top:e.x,left:e.y,width:e.width,height:e.height,zIndex:this.props.zIndex}}},e("Dialog",r)}}}),System.register("gui/component/BasicErrorBoxApi",["gui/HtmlReactElement","util/disposable/CompositeDisposable","gui/component/Dialog","react"],function(e,t){"use strict";var a,r,n,o,i;t&&t.id;return{setters:[function(e){a=e},function(e){r=e},function(e){n=e},function(e){o=e}],execute:function(){e("BasicErrorBoxApi",i=class{constructor(e,t,i){this.viewport=e,this.strings=t,this.rootEl=i,this.disposables=new r.CompositeDisposable}async show(r,s=!1){return new Promise(e=>{let t=this.component=a.HtmlReactElement.factory(n.Dialog,{children:r.split(/\n/g).map((e,t)=>t?o.default.createElement(o.default.Fragment,{key:t},o.default.createElement("br",null),e):e),className:"basic-error-box",viewport:this.viewport.value,buttons:s?[]:[{label:this.strings.get("GUI:Ok"),onClick:()=>{this.destroy(),e()}}]}),i=t=>{this.component.setSize(t.width,t.height),this.component.applyOptions(e=>e.viewport=t)};this.viewport.onChange.subscribe(i),t.setSize(this.viewport.value.width,this.viewport.value.height),t.render(),this.rootEl.appendChild(t.getElement()),this.disposables.add(()=>this.viewport.onChange.unsubscribe(i),()=>this.rootEl.removeChild(this.component.getElement()),()=>this.component.unrender(),()=>this.component=void 0)})}destroy(){this.disposables.dispose()}})}}}),System.register("engine/gameRes/importError/ChecksumError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{constructor(e,t){super(e),this.file=t}},e("ChecksumError",i)}}}),System.register("engine/gameRes/importError/FileNotFoundError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{constructor(e){super(`File "${e}" not found.`),this.file=e}},e("FileNotFoundError",i)}}}),System.register("engine/gameRes/importError/NoStorageError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("NoStorageError",i)}}}),System.register("gui/component/GameResForm",["react","classnames"],function(e,t){"use strict";var h,u;t&&t.id;return{setters:[function(e){h=e},function(e){u=e}],execute:function(){e("GameResForm",({closable:e,strings:t,archiveUrl:i,onBrowseFolder:r,onBrowseArchive:s,onDrop:a,onClose:n})=>{let[o,l]=h.default.useState();var c=h.default.useCallback(e=>{e.target===o&&l(void 0)},[o]);return h.default.useEffect(()=>{let e=e=>e.preventDefault();return globalThis.addEventListener("drop",e),globalThis.addEventListener("dragover",e),()=>{globalThis.removeEventListener("drop",e),globalThis.removeEventListener("dragover",e)}},[]),h.default.createElement("div",null,e&&h.default.createElement("div",{className:"close-button",onClick:n}),h.default.createElement("div",{className:"title"},t.get("ts:gameres_locate_title")),h.default.createElement("div",{className:"browse-container"},h.default.createElement("p",null,t.get("ts:gameres_import_desc"),i&&" "+t.get("ts:gameres_download_desc")),i&&h.default.createElement(h.default.Fragment,null,h.default.createElement("div",{className:"link-container"},h.default.createElement("p",null,h.default.createElement("a",{rel:"nofollow noopener noreferrer",target:"_blank",href:i},i)),h.default.createElement("p",null,h.default.createElement("em",null,t.get("ts:gameres_download_hint"),h.default.createElement("br",null),t.get("ts:gameres_download_size",200))))),h.default.createElement("div",{className:u.default("drop-container",{"dropzone-active":!!o}),onDragOver:e=>e.preventDefault(),onDragLeave:c,onDragEnter:e=>{[...e.dataTransfer.items].every(e=>"file"===e.kind)&&l(e.target)},onDrop:e=>{e.preventDefault(),[...e.dataTransfer.items].every(e=>"file"===e.kind)&&a(e.dataTransfer)}},h.default.createElement("p",{className:"drop-figures"},h.default.createElement("img",{src:"res/img/drag-archive.png",width:"98",height:"133",alt:"Red-Alert-2-Multiplayer.exe"}),t.get("ts:gameres_or"),h.default.createElement("img",{src:"res/img/drag-folder.png",width:"99",height:"153",alt:"Command and Conquer Red Alert II"})),h.default.createElement("p",{className:"desc"},t.get("ts:gameres_drop_desc"),h.default.createElement("br",null),t.get("ts:gameres_or")),h.default.createElement("p",{className:"browse-buttons"},h.default.createElement("button",{className:"dialog-button",onClick:r},t.get("ts:gameres_browse_folder")),h.default.createElement("button",{className:"dialog-button",onClick:s},t.get("ts:gameres_browse_archive"))),h.default.createElement("p",{className:"archive-formats"},h.default.createElement("em",null,t.get("ts:gameres_supported_archive_formats"))))))})}}}),System.register("engine/gameRes/FileSystemAccessLib",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gameRes/FileSystemUtil",["data/vfs/FileNotFoundError","data/vfs/IOError"],function(e,t){"use strict";var r,s,i;t&&t.id;return{setters:[function(e){r=e},function(e){s=e}],execute:function(){e("FileSystemUtil",i=class{static async getDirContents(t){let e=[];try{for await(var i of t.values())e.push(i)}catch(e){if("NotFoundError"===e.name)throw new r.FileNotFoundError(`Directory "${t.name}" not found`,{cause:e});if(e instanceof DOMException)throw new s.IOError(`Directory "${t.name}" could not be read (${e.name})`,{cause:e});throw e}return e}static async listDir(t){let e=[];try{for await(var i of t.keys())e.push(i)}catch(e){if("NotFoundError"===e.name)throw new r.FileNotFoundError(`Directory "${t.name}" not found`,{cause:e});if(e instanceof DOMException)throw new s.IOError(`Directory "${t.name}" could not be read (${e.name})`,{cause:e});throw e}return e}static async showArchivePicker(e){var t=await e.showOpenFilePicker({types:[{description:"Archive",accept:{"application/vnd.rar":[".rar"],"application/zip":[".zip"],"application/x-tar":[".tar"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"],"application/x-xz":[".xz"],"application/x-7z-compressed":[".7z"],"application/octet-stream":[".exe"]}}]});return Array.isArray(t)?t[0]:t}static polyfillGetFile(){const e=FileSystemFileHandle.prototype.getFile;FileSystemFileHandle.prototype.getFile=function(){return e.call(this).then(e=>new File([e],this.name,{type:e.type,lastModified:e.lastModified}))}}})}}}),System.register("gui/component/GameResBoxApi",["react","classnames","gui/HtmlReactElement","gui/component/Dialog","gui/component/GameResForm","engine/gameRes/FileSystemUtil"],function(e,t){"use strict";var n,o,l,c,h,u,i;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("GameResBoxApi",i=class{constructor(e,t,i,r){this.viewport=e,this.strings=t,this.rootEl=i,this.fsAccessLib=r}async promptForGameRes(s,a){return await this.fsAccessLib.polyfillDataTransferItem(),await new Promise(i=>{let e=l.HtmlReactElement.factory(c.Dialog,{className:o.default("game-res-box",{"game-res-box-no-dl":!s}),buttons:[],children:n.default.createElement(h.GameResForm,{archiveUrl:s,closable:a,strings:this.strings,onDrop:async e=>{if(e.items.length)try{var t=await e.items[0].getAsFileSystemHandle();if(!t)return;r(),i(t)}catch(e){console.error(e)}},onBrowseFolder:async()=>{try{var e=await this.fsAccessLib.showDirectoryPicker({_preferPolyfill:!0});r(),i(e)}catch(e){console.error(e)}},onBrowseArchive:async()=>{try{var e=await u.FileSystemUtil.showArchivePicker(this.fsAccessLib);r(),i(e)}catch(e){console.error(e)}},onClose:()=>{r(),i(void 0)}}),viewport:this.viewport.value}),t=t=>{e.setSize(t.width,t.height),e.applyOptions(e=>e.viewport=t)};this.viewport.onChange.subscribe(t);const r=()=>{this.viewport.onChange.unsubscribe(t),t=void 0,this.rootEl.removeChild(e.getElement()),e.unrender(),e=void 0};e.setSize(this.viewport.value.width,this.viewport.value.height),e.render(),this.rootEl.appendChild(e.getElement())})}})}}}),System.register("engine/gameRes/CdnManifest",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("engine/gameRes/CdnResourceLoader",["data/DataStream","data/Crc32","data/vfs/VirtualFile","engine/ResourceLoader"],function(e,t){"use strict";var o,l,c,h,u;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){u=class u extends h.ResourceLoader{constructor(e,t,i){super(e),this.cdnManifest=t,this.cacheDir=i}static async clearCache(e){for await(var t of e.getEntries())t.startsWith(u.cachePrefix)&&await e.deleteFile(t)}getFileNameFromUrl(e){return e.split("?")[0].split("/").pop()}async fetchResource(e,t,i){let r=this.getFileNameFromUrl(e);var s=u.cachePrefix+r,a=this.cdnManifest.checksums[r];try{if(r.endsWith(".mix")&&void 0!==a&&this.cacheDir&&await this.cacheDir.containsEntry(s)){let e=await this.cacheDir.getRawFile(s);var n=new Uint8Array(await e.arrayBuffer());if(l.Crc32.calculateCrc(n)===a)return i?.onProgress?.(n.length),n;try{await this.cacheDir.deleteFile(s)}catch(e){console.error("Couldn't delete file from local CDN cache",e)}}}catch(e){console.error(`Couldn't read file "${s}" from local CDN cache`,e)}void 0!==a&&(e+=(e.includes("?")?"&":"?")+"h="+a);n=await super.fetchResource(e,t,i);if(l.Crc32.calculateCrc(n)!==a)throw new h.DownloadError(`Checksum mismatch for URL "${e}"`);try{await this.cacheDir?.writeFile(c.VirtualFile.factory(new o.DataStream(n),s))}catch(e){console.error("Couldn't write file to local CDN cache",e)}return n}},e("CdnResourceLoader",u),u.cachePrefix="cdncache_"}}}),System.register("engine/gameRes/importError/ArchiveExtractionError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("ArchiveExtractionError",i)}}}),System.register("engine/gameRes/VideoConverter",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("VideoConverter",i=class{async convertBinkVideo(e,t,i="webm"){var r=t.filename,s=t.filename.replace(/\.\w+$/,"")+"."+i;e.FS("writeFile",r,new Uint8Array(t.stream.buffer,t.stream.byteOffset,t.stream.byteLength)),"webm"===i?await e.run("-i",r,"-vcodec","libvpx","-crf","10","-b:v","2M","-deadline","realtime","-speed","2","-an",s):await e.run(...["-i",r,"-vcodec","libx264","-crf","25","-b:v","2M","-an"],s);var a=e.FS("readFile",s);return e.FS("unlink",r),e.FS("unlink",s),a}})}}}),System.register("engine/gameRes/importError/InvalidArchiveError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("InvalidArchiveError",i)}}}),System.register("engine/gameRes/importError/NoWebAssemblyError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("NoWebAssemblyError",i)}}}),System.register("engine/gameRes/GameResImporter",["data/MixFile","engine/Engine","util/time","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/ArchiveExtractionError","data/vfs/VirtualFile","engine/mixDatabase","data/Palette","data/ShpFile","engine/gfx/ImageUtils","util/string","engine/gameRes/VideoConverter","engine/gameRes/importError/InvalidArchiveError","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/RealFileSystemDir","engine/gameRes/importError/NoWebAssemblyError"],function(e,t){"use strict";var c,v,b,o,S,w,h,u,n,l,d,C,g,E,x,O,A,M,i;t&&t.id;return{setters:[function(e){c=e},function(e){v=e},function(e){b=e},function(e){o=e},function(e){S=e},function(e){w=e},function(e){h=e},function(e){u=e},function(e){n=e},function(e){l=e},function(e){d=e},function(e){C=e},function(e){g=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e}],execute:function(){e("GameResImporter",i=class{constructor(e){this.strings=e}async import(o,l,c){var h=["ra2.mix","language.mix","multi.mix","theme.mix"];let u=new Set(["theme.mix"]),d=v.Engine.rfsSettings.tauntsDir,g=this.strings;if(c(g.get("ts:import_preparing_for_import")),"file"===o.kind){if(!window.WebAssembly)throw new M.NoWebAssemblyError("WebAssembly is not available");let e=await SystemJS.import("7z-wasm"),i,r,s=await e({quit:(e,t)=>{i=e,r=t}});c(g.get("ts:import_loading_archive")),s.FS.chdir("/tmp");var p=o.name;try{let e=await o.getFile();var m=await e.arrayBuffer(),f=s.FS.open(p,"w+");s.FS.write(f,new Uint8Array(m),0,m.byteLength,0,!0),s.FS.close(f)}catch(e){if(e instanceof DOMException)throw new O.IOError(`File "${p}" could not be read (${e.name})`,{cause:e});throw e}c(g.get("ts:import_extracting_archive")),await b.sleep(100);f=[...h,d];if(s.callMain(["x","-ssc-",p,...f]),i)throw 1===i?new w.ArchiveExtractionError("Archive extraction failed with code "+i,{cause:r}):new E.InvalidArchiveError("7-Zip exited with code "+i,{cause:r});s.FS.unlink(p);var p=s.FS.lookupPath(s.FS.cwd())["node"];let t=Object.keys(p.contents);for(let n of h){var y=t.find(e=>C.equalsIgnoreCase(e,n))??n;c(g.get("ts:import_importing",n));let e;try{e=this.readFileFromEmFs(s.FS,y)}catch(e){if("ENOENT"!==e.code)throw e;if(u.has(n)){console.warn(`Mix file "${n}" not found. Skipping.`);continue}throw new S.FileNotFoundError(n)}await this.importMixArchive(e,l,c,g),s.FS.unlink(y)}let a=t.find(e=>C.equalsIgnoreCase(e,d));if(a){var p=s.FS.lookupPath(a)["node"],p=Object.keys(p.contents).map(e=>a+"/"+e);try{let t=await l.getOrCreateDirectory(d);for(var T of p){c(g.get("ts:import_importing",T));let e=this.readFileFromEmFs(s.FS,T);await t.writeFile(e,e.name.toLowerCase()),s.FS.unlink(T)}}catch(e){if(!(e instanceof DOMException||e instanceof O.IOError))throw e;console.warn("Failed to copy taunts folder. Skipping.",[e])}}else console.warn("Taunts folder not found in archive. Skipping.")}else{let t=new A.RealFileSystemDir(o,!0),i=await t.listEntries();for(let s of h){c(g.get("ts:import_importing",s));var a=i.find(e=>C.equalsIgnoreCase(e,s))??s;let e;try{e=await t.getRawFile(a)}catch(e){if(e instanceof x.FileNotFoundError){if(u.has(s)){console.warn(`Mix file "${s}" not found. Skipping.`);continue}throw new S.FileNotFoundError(s)}throw e}await this.importMixArchive(e,l,c,g)}h=i.find(e=>C.equalsIgnoreCase(e,d))??d;let r;try{r=await t.getDirectory(h)}catch(e){if(!(e instanceof x.FileNotFoundError||e instanceof O.IOError))throw e;console.warn(`Directory "${h}" not found (${e.name}). Skipping.`,e)}if(r)try{let e=await l.getOrCreateDirectory(d,!0);for await(var n of r.getRawFiles())c(g.get("ts:import_importing",e.name+"/"+n.name)),await e.writeFile(n,n.name.toLowerCase())}catch(e){if(!(e instanceof O.IOError))throw e;console.warn("Failed to copy taunts folder. Skipping.",[e])}}}readFileFromEmFs(e,t){try{e.chmod(t,448)}catch(e){if(44!==e.errno)throw e}var i=e.readFile(t);let r=e.stat(t);i=new Blob([i],{type:"application/octet-stream"});return new File([i],t.slice(t.lastIndexOf("/")+1),{lastModified:r.mtime.getTime()})}async importMixArchive(e,t,i,r){let s=e.name.toLowerCase();var a,n=s.match(/^theme[^.]*\.mix$/);if(!e.size){if(n)return void console.warn(`Mix file ${e.name} is empty. Skipping.`);throw new o.ChecksumError(`Mix file "${s}" is empty`,s)}n||await t.writeFile(e,s),n?(a=v.Engine.rfsSettings.musicDir,a=await t.getOrCreateDirectory(a,!0),await this.importMusic(e,a,e=>i(r.get("ts:import_importing_pg",s,e)))):s.match(/language\.mix/)?(i(r.get("ts:import_importing_long",s)),await this.importVideo(e,t)):s.match(/ra2\.mix/)&&(a=await this.importSplashImage(e,t),i(void 0,a))}async importMusic(e,i,t){var r=await h.VirtualFile.fromRealFile(e);let s=new c.MixFile(r.stream);r=u.mixDatabase.get(e.name.toLowerCase());if(r){var a,n=r.length;let e=n;for(a of r){if(t(Math.floor((n-e)/n*100)),e--,!a.match(/\.wav$/))throw new Error(`Music file "${a}" is not a WAV file`);var o=a.replace(".wav",".mp3");if(s.containsFile(a)){var l=s.openFile(a);if(l.stream.byteLength){let t;try{let e=await this.createFFMpeg();e.FS("writeFile",a,new Uint8Array(l.stream.buffer,l.stream.byteOffset,l.stream.byteLength)),await e.run("-i",a,"-vn","-ar","22050","-b:a","96k",o),t=e.FS("readFile",o),e.FS("unlink",a),e.FS("unlink",o)}catch(e){console.warn(`Failed to convert music file "${a}". Skipping.`),console.error(e);continue}l=new Blob([t],{type:"application/octet-stream"});try{await i.writeFile(new File([l],o))}catch(e){console.warn(`Failed to write music file "${o}". Skipping.`),console.error(e);continue}}else console.warn(`Music file "${a}" is empty in the mix archive. Skipping.`)}else console.warn(`Music file "${a} was not found in mix archive. Skipping.`)}}else console.warn(`File "${e.name} not found in mix database. Skipping music import.`)}async importVideo(e,t){var i=await this.createFFMpeg();let r=new c.MixFile((await h.VirtualFile.fromRealFile(e)).stream);var s="ra2ts_l.bik",a=v.Engine.rfsSettings.menuVideoFileName;if(!r.containsFile(s))throw new S.FileNotFoundError(s);s=r.openFile(s),s=await(new g.VideoConverter).convertBinkVideo(i,s),s=new Blob([s],{type:"video/webm"});await t.writeFile(new File([s],a,{type:"video/webm"}))}async createFFMpeg(){const e=(await SystemJS.import("@ffmpeg/ffmpeg"))["createFFmpeg"];let t=e({corePath:"lib/ffmpeg-core.js",log:!0});var i=window.define;return window.define=void 0,await t.load(),window.define=i,t}async importSplashImage(e,t){let i=new c.MixFile((await h.VirtualFile.fromRealFile(e)).stream);if(!i.containsFile("local.mix"))throw new S.FileNotFoundError("local.mix");let r=new c.MixFile(i.openFile("local.mix").stream);if(!r.containsFile("glsl.shp"))throw new S.FileNotFoundError("glsl.shp");var s=new l.ShpFile(r.openFile("glsl.shp"));if(!r.containsFile("gls.pal"))throw new S.FileNotFoundError("gls.pal");var a=new n.Palette(r.openFile("gls.pal")),s=await d.ImageUtils.convertShpToPng(s,a),a=v.Engine.rfsSettings.splashImgFileName;return await t.writeFile(new File([s],a,{type:s.type})),s}})}}}),System.register("util/ScriptLoader",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ScriptLoader",i=class{constructor(e){this.document=e}load(n,o={}){return new Promise((e,t)=>{let i=this.document.head,r=this.document.createElement("script");r.type=o.type||"text/javascript",r.charset=o.charset||"utf8",r.async=void 0===o.async||o.async,r.src=n;const s=o.attrs;s&&Object.keys(s).forEach(e=>r.setAttribute(e,s[e])),o.text&&(r.text=o.text),r.onload=()=>{e()};let a=new Error(`Failed to load script "${n}"`);r.onerror=()=>{t(a)},i.appendChild(r)})}})}}}),System.register("util/Sentry",["util/ScriptLoader"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("Sentry",i=class{async init(e,t){await new s.ScriptLoader(document).load(`https://js.sentry-cdn.com/${e.dsn}.min.js`);let i=this.sdk=window.Sentry,r=new Date;i.init({environment:e.env,release:t,denyUrls:[/^file:/],ignoreErrors:[/init message from worker/,/The object can not be found here/,/itemsclipboard/],initialScope:e=>e.setTags({locale:navigator.language}).setExtra("initTime",r),...e.defaultIntegrations?{}:{defaultIntegrations:!1}}),i.onLoad(()=>{this.sdk=window.Sentry}),e.lazyLoad||i.forceLoad()}captureException(e,t){this.sdk?.captureException(e,t)}configureScope(e){this.sdk?.configureScope(e)}addBreadcrumb(e){this.sdk?.addBreadcrumb(e)}})}}}),System.register("engine/gameRes/GameRes",["data/DataStream","data/MixFile","engine/Engine","engine/ResourceLoader","util/Logger","engine/gameRes/GameResConfig","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/NoStorageError","data/Crc32","data/Palette","data/ShpFile","data/PcxFile","engine/gfx/ImageUtils","data/Bitmap","engine/gfx/CanvasUtils","gui/component/GameResBoxApi","engine/gameRes/GameResSource","data/vfs/RealFileSystem","engine/resourceConfigs","engine/gameRes/CdnResourceLoader","LocalPrefs","engine/gameRes/FileSystemUtil","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","data/vfs/IOError","engine/gameRes/GameResImporter"],function(e,t){"use strict";var c,h,f,l,u,y,n,o,T,d,g,p,m,v,b,S,w,C,E,x,O,A,M,R,P,I,k,i;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){f=e},function(e){l=e},function(e){u=e},function(e){y=e},function(e){n=e},function(e){o=e},function(e){T=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e}],execute:function(){e("GameRes",i=class{constructor(e,t,i,r,s,a,n,o,l,c,h){this.appVersion=e,this.modName=t,this.fsAccessLib=i,this.localPrefs=r,this.strings=s,this.rootEl=a,this.splashScreen=n,this.viewport=o,this.appConfig=l,this.appResPath=c,this.sentry=h}async init(t,i,r){let s=!1,a=!1,n,o=(e,t)=>{if(e&&this.splashScreen.setLoadingText(e),t){let e;e="string"==typeof t?t:n=URL.createObjectURL(t),this.splashScreen.setBackgroundImage(e)}},e;try{e=await this.getBrowserFsHandle("native")}catch(e){if(!(e instanceof T.NoStorageError))throw e}let l;try{l=!!e&&await this.migrateStorageToNative(e,o)}catch(e){console.warn("Storage migration to native failed",e),this.sentry?.captureException(new Error("Failed to migrate files to native file system",{cause:e})),l=!1}finally{o(this.strings.get("GUI:LoadingEx"))}let c;try{var h=l?e:await this.getBrowserFsHandle("fallback");h&&(c=await f.Engine.initRfs(h))}catch(e){if(!(e instanceof T.NoStorageError))throw e;console.warn("No storage adapters available.")}!t&&c&&await this.lookForGameFiles(c.getRootDirectory())&&((t=new y.GameResConfig("")).source=C.GameResSource.Local,a=!0);let u;c&&(g=await f.Engine.getModDir(),u=await this.loadMod(c,g)),c&&c.addDirectory(await f.Engine.getMapDir());let d;if(t){var g=await this.loadSplashScreenBackground(c?.getRootDirectory(),u,t);"string"==typeof g?this.splashScreen.setBackgroundImage(g):g&&(n=URL.createObjectURL(g),this.splashScreen.setBackgroundImage(n));try{d=await this.loadResources(c,t,o),s=!0}catch(e){console.error("Failed to load initial game resources"),console.error(e),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await i(e,this.strings)}}let p=new w.GameResBoxApi(this.viewport,this.strings,this.rootEl,this.fsAccessLib);for(;!s;){this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),n&&(URL.revokeObjectURL(n),n=void 0);var m=await p.promptForGameRes(this.appConfig.gameResArchiveUrl,!!this.appConfig.gameresBaseUrl&&!this.modName);t=new y.GameResConfig(this.appConfig.gameresBaseUrl??""),a=!0;let e;if(m)if("file"===m.kind)e=C.GameResSource.Archive;else{if("directory"!==m.kind)throw new Error("Unexpected FileSystemHandle type "+m.kind);e=C.GameResSource.Local}else e=C.GameResSource.Cdn;if(t.source=e,e!==C.GameResSource.Cdn)try{if(!c)throw new T.NoStorageError("No storage adapters available");await new k.GameResImporter(this.strings).import(m,c.getRootDirectory(),(e,t)=>{o(e,t),e&&console.info(e)}),console.info("Game assets successfully imported.")}catch(e){console.error("Failed to import game assets"),console.error(e),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await r(e,this.strings);continue}finally{this.splashScreen.setLoadingText("")}try{this.splashScreen.setLoadingText(this.strings.get("GUI:LoadingEx")),d=await this.loadResources(c,t,o),s=!0}catch(e){console.error("Failed to load game assets"),console.error(e),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await i(e,this.strings)}}return n&&URL.revokeObjectURL(n),{configToPersist:a?t:void 0,cdnResLoader:d}}async loadMod(e,t){let i=this.modName,r;return i&&(await t.containsEntry(i)?(console.info(`Loading mod "${i}"...`),r=await t.getDirectory(i),e.addDirectory(r),f.Engine.setActiveMod(i)):(console.info(`Mod "${i}" not found. Ignoring.`),i=this.modName=void 0)),r}async lookForGameFiles(e){let t=await e.listEntries();return["language.mix","multi.mix","ra2.mix"].every(e=>t.includes(e))}async migrateStorageToNative(t,e){var i="_storage_migration_pending";if(this.localPrefs.getItem(i)){for await(var r of t.keys())await t.removeEntry(r,{recursive:!0});this.localPrefs.removeItem(i)}else if(!!(await t.keys().next()).value)return!0;if(void 0===this.localPrefs.getItem(A.StorageKey.LastGpuTier))return!0;console.info("Migrating to new storage...");let s;try{s=await this.getBrowserFsHandle("fallback")}catch(e){if(e instanceof T.NoStorageError)return console.info("No existing storage found. Migration skipped."),!1;throw e}if(navigator.storage?.estimate){var a=await navigator.storage.estimate();if(void 0===a.usage||void 0===a.quota)return!1;if(a.usage>(a.quota-5242880)/2)return console.info("Migration to native storage skipped because of insufficient space."),!1}let n=await M.FileSystemUtil.listDir(s);n.includes(f.Engine.rfsSettings.cacheDir)&&await s.removeEntry(f.Engine.rfsSettings.cacheDir,{recursive:!0}),this.localPrefs.setItem(i,"1");try{await this.migrateDir(s,t,e)}catch(e){for await(var o of t.keys())await t.removeEntry(o,{recursive:!0});throw e}finally{this.localPrefs.removeItem(i)}try{indexedDB.deleteDatabase("fileSystem"),this.fsAccessLib.support.adapter.cache&&await globalThis.caches?.delete("sandboxed-fs")}catch(e){console.warn(e)}return console.info("Migration done."),!0}async migrateDir(e,i,r){var s;for(s of await M.FileSystemUtil.getDirContents(e))try{if("directory"===s.kind){var t=await i.getDirectoryHandle(s.name,{create:!0});await this.migrateDir(s,t,r)}else{var a=s.name.replace(/\u200f/g,"");r(this.strings.get("TS:storage_migrating_file",i.name+"/"+s.name));let e=await i.getFileHandle(a,{create:!0});var n=await e.createWritable();let t=await s.getFile();await t.stream().pipeTo(n)}}catch(e){if("QuotaExceededError"===e.name)throw new R.StorageQuotaError({cause:e});throw new Error(`Failed migrating "${s.name}"`,{cause:e})}}async loadResources(t,i,e){f.Engine.initGameResSource(i.source);let r;if(i.isCdn()){var s=i.getCdnBaseUrl();let e=new l.ResourceLoader(s);var a=await e.loadJson("manifest.json");if(2!==a.version)throw new Error("Unknown manifest version "+a.version);if("mix"!==a.format)throw new Error("Unsupported CDN resource format "+a.format);t=t||new E.RealFileSystem,r=new O.CdnResourceLoader(s,a,await f.Engine.getCacheDir())}else{if(!t)throw new T.NoStorageError("No available storage adapters");console.info("Checking integrity of mix files..."),await this.checkMixesIntegrity(t.getRootDirectory()),console.info("Mixes are valid.")}const n=u.AppLogger.get("vfs");n.info("Initializing virtual filesystem...");let o=await f.Engine.initVfs(t,n);return await o.loadStandaloneFiles({exclude:["keyboard.ini","theme.ini"].map(e=>f.Engine.getFileNameVariant(e))}),await o.loadExtraMixFiles(f.Engine.getActiveEngine()),await this.loadCustomMix(o),await this.loadMixes(i,r,o,e),await f.Engine.loadMapList(),await this.initUiCssVariables(this.rootEl),r}async checkMixesIntegrity(r){let e=new Map([["ra2.mix",["E7BA3BE","5DC70844"]],["multi.mix",["984EFDB6","3CDB648F"]]]);for(var[s,a]of e.entries()){let e,t;try{e=await r.getRawFile(s,!0),t=await e.arrayBuffer()}catch(e){if(e instanceof P.FileNotFoundError)throw new o.FileNotFoundError(s);if(e instanceof DOMException)throw new I.IOError(`Failed to read file (${e.name})`,{cause:e});throw e}let i=d.Crc32.calculateCrc(new Uint8Array(t));if(!a.includes(i.toString(16).toUpperCase()))throw new n.ChecksumError(`Checksum mismatch for "${s}" (size: ${e.size}). `+`Checksum "${i}" doesn't match known values`,s)}}async loadCustomMix(e){let t=new l.ResourceLoader(this.appResPath);var i=await t.loadBinary("ra2cd.mix?v="+this.appVersion),i=new h.MixFile(new c.DataStream(i));e.addArchive(i,"ra2cd.mix")}async loadMixes(t,i,r,s){if(t.isCdn()){var a=t.getCdnBaseUrl();s(this.strings.get("TS:Downloading"),a+f.Engine.rfsSettings.splashImgFileName);var n,a=[x.ResourceType.Ini,x.ResourceType.Ui,x.ResourceType.Strings];let e=await i.loadResources(a,void 0,e=>{s(this.strings.get("TS:DownloadingPg",e))});s(this.strings.get("GUI:LoadingEx"));for(n of a){var o=i.getResourceFileName(n),l=new h.MixFile(new c.DataStream(e.pop(n)));r.addArchive(l,o)}}else{await r.loadImplicitMixFiles(f.Engine.getActiveEngine());a=await f.Engine.getCacheDir();if(a)try{await O.CdnResourceLoader.clearCache(a)}catch(e){if(!(e instanceof R.StorageQuotaError))throw e}}}async initUiCssVariables(t){let i;let e=await this.convertImagesToPng(f.Engine.vfs,[["pudlgbgn.shp","dialog.pal"],["mnbttn.shp","mainbttn.pal"],["cue_i.pcx"],["cce_i.pcx"],["cce_il.pcx"],["cce_ir.pcx"]]);e.set("menulogo.png",f.Engine.vfs.openFile("menulogo.png").asFile("image/png")),e.set("icons24.pcx",await this.generateIconSprite(f.Engine.vfs));var r,s={"--res-menu-logo":"menulogo.png","--res-icons-24":"icons24.pcx","--res-dlg-bgn":"pudlgbgn.shp","--res-mnbttn":"mnbttn.shp","--res-cue-i":"cue_i.pcx","--res-cce-i":"cce_i.pcx","--res-cce-il":"cce_il.pcx","--res-cce-ir":"cce_ir.pcx"};i={};for(r of Object.keys(s)){var a=e.get(s[r]);a?(a=URL.createObjectURL(a),i[r]=`url("${a}")`):console.warn(`Image "${s[r]}" not found in browser FS`)}Object.keys(i).forEach(e=>{t.style.setProperty(e,i[e])})}async loadSplashScreenBackground(t,i,e){var r=f.Engine.rfsSettings.splashImgFileName;if(e.isCdn())return e.getCdnBaseUrl()+r;{let e;if(i)try{e=await i.getRawFile(r,!1,"image/png")}catch(e){e instanceof P.FileNotFoundError||console.warn("Failed to load splash image",e)}if(t&&!e)try{e=await t.getRawFile(r,!1,"image/png")}catch(e){console.warn("Failed to load splash image",e)}return e}}async getBrowserFsHandle(e){let t=[];var i;for("fallback"!==e&&this.fsAccessLib.support.adapter.native&&t.push({name:"native",module:void 0}),"native"!==e&&(t.push({name:"indexeddb",module:this.fsAccessLib.adapters.indexeddb}),this.fsAccessLib.support.adapter.cache&&t.push({name:"cache",module:this.fsAccessLib.adapters.cache}));i=t.shift();)try{console.info(`Loading storage adapter "${i.name}"...`);let t=await this.fsAccessLib.getOriginPrivateDirectory(i.module);try{let e=await t.getFileHandle("browsercheck",{create:!0});if(!("function"==typeof e.createWritable))throw new Error("createWritable not supported");(await e.getFile()).name!==e.name&&M.FileSystemUtil.polyfillGetFile()}catch(e){if("NotFoundError"===e.name&&"indexeddb"===i.name&&await new Promise(()=>{indexedDB.deleteDatabase("fileSystem"),this.localPrefs.removeItem(A.StorageKey.GameRes),location.reload()}),"QuotaExceededError"!==e.name)throw e}finally{try{await t.removeEntry("browsercheck")}catch(e){}}return console.info(`Storage adapter "${i.name}" loaded successfully.`),t}catch(e){console.warn("Couldn't load FS adapter "+i.name,[e])}throw new T.NoStorageError("No available FS adapters.")}async convertImagesToPng(i,e){let r=new Map;for(var[s,a]of e){let t;if(s.endsWith(".shp")){var n=new p.ShpFile(i.openFile(s));if(!a)throw new Error(`No palette specified for image "${s}"`);a=new g.Palette(i.openFile(a));t=await v.ImageUtils.convertShpToPng(n,a)}else{if(!s.endsWith(".pcx")){console.warn(`Unknown image type "${s}"`);continue}{let e=new m.PcxFile(i.openFile(s));t=await e.toPngBlob()}}r.set(s,t)}return r}async generateIconSprite(t){let e=["wouref.pcx","wodref.pcx","wouact.pcx","wodact.pcx","dnarrowr.pcx","dnarrowp.pcx","uparrowr.pcx","uparrowp.pcx","sbgript.pcx","sbgripm.pcx","sbgripb.pcx","trakgrip.pcx"];var i=e.map(e=>new m.PcxFile(t.openFile(e)));let r=new b.RgbaBitmap(24*e.length,24);for(let n=0;n<i.length;n++){var s=new b.RgbaBitmap(i[n].width,i[n].height,i[n].data);r.drawRgbaImage(s,24*n,0)}var a=S.CanvasUtils.canvasFromRgbaImageData(r.data,r.width,r.height);return await S.CanvasUtils.canvasToBlob(a)}})}}}),System.register("gui/replay/ReplayMeta",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayStorage",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayStorageError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("ReplayStorageError",i)}}}),System.register("gui/replay/ReplayStorageFileSystem",["data/vfs/VirtualFile","data/DataStream","data/vfs/StorageQuotaError","network/gamestate/Replay","gui/replay/ReplayStorageError"],function(e,t){"use strict";var a,n,h,u,o,d;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){h=e},function(e){u=e},function(e){o=e}],execute:function(){e("ReplayStorageFileSystem",d=class d{constructor(e,t){this.dir=e,this.sentry=t}async getManifest(e=!1){if(e)return await this.rebuildManifest();if(!await this.dir.containsEntry(d.manifestFileName))return[];let t=(await this.dir.openFile(d.manifestFileName)).readAsString("utf-8");if(!t.length)return[];try{return JSON.parse(t)}catch(e){return console.error("Replay manifest is corrupt",e),this.sentry?.captureException(e,e=>(e.addAttachment({filename:d.manifestFileName,data:t}),e)),await this.deleteManifest(),await this.rebuildManifest()}}async saveManifest(e){let t=new n.DataStream;t.writeString(JSON.stringify(e),"utf-8");var i=new a.VirtualFile(t,d.manifestFileName);try{await this.dir.writeFile(i)}catch(e){if(e instanceof h.StorageQuotaError)throw e;throw new o.ReplayStorageError(`Failed to save manifest (${e.message})`,{cause:e})}}async deleteManifest(){await this.dir.deleteFile(d.manifestFileName)}async rebuildManifest(){var e,t,i,r=await this.getManifest();let s=0;for await(e of this.dir.getEntries())e.endsWith(u.Replay.extension)&&s++;if(s===r.length)return r;console.info("Rebuilding replay index...");let a=new Map;for await(t of this.dir.getRawFiles())t.name.endsWith(u.Replay.extension)&&a.set(t.name,t);let n=[];for(i of r){var o=this.getReplayFileName(i);a.has(o)&&(n.push(i),a.delete(o))}if(0<r.length-n.length&&console.info(`Removed ${r.length-n.length} orphaned entries from index`),a.size){for(var l of a.values()){var c=l.lastModified;n.unshift({id:THREE.Math.generateUUID(),name:l.name.replace(d.unsavedReplayPrefix,"").replace(u.Replay.extension,""),keep:!l.name.startsWith(d.unsavedReplayPrefix),timestamp:c})}n.sort((e,t)=>e.timestamp===t.timestamp?e.name.localeCompare(t.name):t.timestamp-e.timestamp),console.info(`Added ${a.size} new entries to replay index`)}try{await this.saveManifest(n)}catch(e){if(!(e instanceof h.StorageQuotaError))throw e;console.error("Failed to save rebuilt manifest because storage is full",e)}return console.info("Rebuild finished."),n}async deleteAllReplays(){for await(var e of this.dir.getEntries())e.endsWith(u.Replay.extension)&&await this.dir.deleteFile(e);await this.deleteManifest()}async getReplayData(e){var t=this.getReplayFileName(e);if(!await this.dir.containsEntry(t))throw new Error(`Replay file "${t}" not found.`);return await this.dir.getRawFile(t)}async hasReplayData(e){var t=this.getReplayFileName(e);return await this.dir.containsEntry(t)}async saveReplayData(e,t){let i=new n.DataStream;i.writeString(t,"utf-8");var r=this.getReplayFileName(e),s=new a.VirtualFile(i,r);try{await this.dir.writeFile(s)}catch(e){if(e instanceof h.StorageQuotaError)throw e;if(e instanceof TypeError)throw new o.ReplayStorageError(`Failed to save replay file "${r}" (${e.message})`,{cause:e});throw new o.ReplayStorageError(`Failed to save replay file (${e.message})`,{cause:e})}}async deleteReplayData(e){await this.dir.deleteFile(this.getReplayFileName(e))}getReplayFileName(e){return(e.keep?"":d.unsavedReplayPrefix)+e.name+u.Replay.extension}}),d.manifestFileName="_index.json",d.unsavedReplayPrefix="Unsaved_"}}}),System.register("gui/replay/ReplayStorageMigration",["network/gamestate/Replay","gui/replay/ReplayStorageFileSystem"],function(e,t){"use strict";var g,s,i;t&&t.id;return{setters:[function(e){g=e},function(e){s=e}],execute:function(){e("ReplayStorageMigration",i=class i{constructor(e,t,i,r,s){this.splashScreen=e,this.strings=t,this.replayDir=i,this.localPrefs=r,this.storageFileSystem=s}async migrate(){4!==Number(this.localPrefs.getItem(i.migratedMarker)||0)&&(console.info("Running replay storage migrations..."),await this.runMigrationTo4(),this.localPrefs.setItem(i.migratedMarker,"4"),console.info("Migrations finished."))}async runMigrationTo4(){this.localPrefs.removeItem("_r_replayList");for(var e of this.localPrefs.listItems())e.startsWith("_r_replay_")&&this.localPrefs.removeItem(e);let i=this.replayDir;var n="replays.json";if(await i.containsEntry(n))if(await i.containsEntry(s.ReplayStorageFileSystem.manifestFileName))await i.deleteFile(n);else{var r=(await i.openFile(n)).readAsString("utf-8");let t=[];try{t=JSON.parse(r)}catch(e){}if(t.length){this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",0));let r=[],e=new Set;for await(var o of i.getEntries())o.endsWith(g.Replay.extension)&&e.add(o);let s=new Map,a=new Set;for(var l of t){var c="replay_"+l.id+g.Replay.extension;if(e.has(c)){let e={id:THREE.Math.generateUUID(),name:g.Replay.sanitizeFileName(l.name),keep:l.keep,timestamp:l.timestamp};r.push(e);let t=this.storageFileSystem.getReplayFileName(e),i=1;for(;a.has(t.toLowerCase());)t=t.replace(g.Replay.extension,""),1<i&&(t=t.replace(/ \(\d+\)$/,"")),t+=` (${++i})`+g.Replay.extension;1<i&&(e.name+=` (${i})`),s.set(c,t),a.add(t.toLowerCase())}}await i.deleteFile(n);try{let t=0;var h,u,d=s.size;for([h,u]of s){let e=await i.openFile(h);e.filename=u,await i.writeFile(e),await i.deleteFile(h),this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",Math.floor(++t/d*100)))}await this.storageFileSystem.saveManifest(r)}catch(e){console.error(e)}}else await i.deleteFile(n)}}}),i.migratedMarker="_r_replays_migrated"}}}),System.register("engine/sound/MusicSpecs",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MusicSpecs",i=class{constructor(e){this.ini=e,this.specs=new Map,this.parse()}parse(){let e=this.ini.getSection("Themes");if(e){for(var t of e.entries.values())if(t){let e=this.ini.getSection(t);var i;e?(i={name:e.getString("Name"),sound:e.getString("Sound"),normal:e.getBool("Normal",!0),repeat:e.getBool("Repeat")},this.specs.set(t,i)):console.warn(`Music section [${t}] not found. Skipping.`)}}else console.warn("[Themes] section missing. Music will not be played.")}getSpec(e){return this.specs.get(e)}getAll(){return[...this.specs.values()]}})}}}),System.register("engine/sound/Music",["engine/sound/ChannelType","util/math"],function(t,e){"use strict";var s,i,r,a;e&&e.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){var e;(e=r=r||{})[e.Normal=0]="Normal",e[e.NormalShuffle=1]="NormalShuffle",e.Intro="INTRO",e.Score="SCORE",e.Loading="LOADING",e.Credits="CREDITS",e.Options="RA2Options",t("MusicType",r),t("Music",a=class{constructor(e,t,i){this.audioSystem=e,this.audioFiles=t,this.musicSpecs=i,this.playlist=[],this.currentPlaylistIdx=-1,this.shuffle=!1,this.repeat=!1}unserializeOptions(e){var[t,i,r]=e.split(",");this.shuffle=Boolean(Number(t)),this.repeat=Boolean(Number(i)),this.initialRepeatName=r}serializeOptions(){return[Number(this.shuffle),Number(this.repeat),this.repeat&&-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx].name:void 0].join(",")}getShuffleMode(){return this.shuffle}getRepeatMode(){return this.repeat}getPlaylist(){return this.buildPlaylist(!1)}getCurrentPlaylistItem(){if(-1!==this.currentPlaylistIdx)return this.playlist[this.currentPlaylistIdx]}dispose(){this.stopPlaying()}getMusicSpec(e){var t=this.musicSpecs.getSpec(e);if(t)return t;console.warn(`Music "${e}" is not defined`)}async play(e){var t,i;this.currentMusicType!==e&&(e===r.Normal||e===r.NormalShuffle?(t=this.shuffle||e===r.NormalShuffle,this.playlist=this.buildPlaylist(t),this.currentPlaylistIdx=0,!this.initialRepeatName||-1!==(i=this.playlist.findIndex(e=>e.name===this.initialRepeatName))&&(this.currentPlaylistIdx=i),await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist())&&(this.currentMusicType=e)):(i=this.getMusicSpec(e))?await this.playSpec(i)&&(this.currentMusicType=e):console.warn(`No music spec found for type "${e}"`))}stopPlaying(){this.playbackHandle&&(this.playbackHandle.stop(),this.playbackHandle=void 0),this.currentMusicType=void 0}setShuffleMode(e){if(e!==this.shuffle){this.shuffle=e;let t=-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx]:void 0;this.playlist=this.buildPlaylist(this.shuffle),this.currentPlaylistIdx=t?this.playlist.findIndex(e=>e===t):-1}}setRepeatMode(e){this.repeat=e}async playSpec(e,t){var i=s.ChannelType.Music;this.playbackHandle&&(this.playbackHandle.stop(),this.playbackHandle=void 0);var r=await this.getMp3File(e.sound);if(r)return this.playbackHandle=await this.audioSystem.playMp3File(r,i,1,0,e.repeat,t),this.playbackHandle}async getMp3File(e){var t=e.toLowerCase()+".mp3";let i;try{i=await this.audioFiles.get(t)}catch(e){return void console.error("Failed to fetch audio file",e)}if(i)return i;console.warn(`Audio file "${t}" not found.`)}buildPlaylist(e){let t=this.musicSpecs.getAll().filter(e=>e.normal);return e&&(t=this.shufflePlaylist(t)),t}shufflePlaylist(e){let t=[];for(e=[...e];e.length;)t.push(...e.splice(i.getRandomInt(0,e.length-1),1));return t}async advancePlaylist(){this.currentPlaylistIdx=this.repeat?this.currentPlaylistIdx:(this.currentPlaylistIdx+1)%this.playlist.length,await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist())}async selectPlaylistItem(t){var e=this.playlist?.findIndex(e=>e===t);-1!==e&&(this.currentPlaylistIdx=e,this.stopPlaying(),await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist()))}})}}}),System.register("gui/screen/Screen",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/Controller",["util/event"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Controller",r=class{constructor(){this.screens=new Map,this.screenStack=[],this._onScreenChange=new i.EventDispatcher}get onScreenChange(){return this._onScreenChange.asEvent()}addScreen(e,t){this.screens.set(e,t),t.setController(this)}hasScreen(e){return this.screens.has(e)}async leaveCurrentScreen(){await this.popScreen()}async goToScreenBlocking(e,t){for(;this.screenStack.length;)await this.leaveCurrentScreen();await this.pushScreen(e,t)}goToScreen(e,t){this.goToScreenBlocking(e,t)}async pushScreen(e,t){let i=this.screens.get(e);if(!i)throw new Error("Invalid screen type "+e);this.screenStack.length&&await this.screenStack[this.screenStack.length-1].onStack?.(),this.screenStack.push(i),this._onScreenChange.dispatch(this,e),i.onEnter(t)}async popScreen(e){this.screenStack.length&&(await this.screenStack.pop().onLeave(),this._onScreenChange.dispatch(this,void 0)),this.screenStack.length&&this.screenStack[this.screenStack.length-1].onUnstack?.(e)}rerenderCurrentScreen(){this.screenStack.length&&this.screenStack[this.screenStack.length-1].onViewportChange?.()}getCurrentScreen(){return this.screenStack.length?this.screenStack[this.screenStack.length-1]:void 0}destroy(){for(var e of this.screens.values())e.setController(void 0);this.screens.clear(),this.screenStack.length=0}})}}}),System.register("gui/screen/ScreenType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.MainMenuRoot=0]="MainMenuRoot",e[e.Game=1]="Game",e[e.Replay=2]="Replay",t("ScreenType",i)}}}),System.register("data/zip/ZipUtils",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ZipUtils",i=class{static createByteArray(e){var t=e.reduce((e,t)=>e+(t.size||t.data.length),0);const i=new Uint8Array(t),r=new DataView(i.buffer);let s=0;return e.forEach(e=>{if(void 0!==e.data.length)i.set(e.data,s),s+=e.data.length;else{switch(e.size){case 1:r.setInt8(s,parseInt(e.data));break;case 2:r.setInt16(s,parseInt(e.data),!0);break;case 4:r.setInt32(s,parseInt(e.data),!0);break;case 8:r.setBigInt64(s,BigInt(e.data),!0);break;default:throw new Error("createByteArray: No handler defined for data size "+e.size+" of entry data "+JSON.stringify(e.data))}s+=e.size}}),i}static getTimeStruct(e){return(e.getHours()<<6|e.getMinutes())<<5|e.getSeconds()/2}static getDateStruct(e){return(e.getFullYear()-1980<<4|e.getMonth()+1)<<5|e.getDate()}})}}}),System.register("data/zip/Zip",["data/Crc32","data/zip/ZipUtils"],function(e,t){"use strict";var s,l,i;t&&t.id;return{setters:[function(e){s=e},function(e){l=e}],execute:function(){e("Zip",i=class{constructor(e=!1){this.zip64=e,console.info("Started zip with zip64: "+this.zip64),this.fileRecord=[],this.finished=!1,this.byteCounterBig=BigInt(0),this.outputStream=new ReadableStream({start:e=>{console.info("OutputStream has started!"),this.outputController=e},cancel:()=>{console.info("OutputStream has been canceled!")}})}enqueue(e){this.outputController.enqueue(e)}close(){this.outputController.close()}getZip64ExtraField(e,t){return l.ZipUtils.createByteArray([{data:1,size:2},{data:28,size:2},{data:e,size:8},{data:e,size:8},{data:t,size:8},{data:0,size:4}])}isWritingFile(){return 0<this.fileRecord.length&&!1===this.fileRecord[this.fileRecord.length-1].done}startFile(e,t){if(this.isWritingFile()||this.finished)throw new Error("Tried adding file while adding other file or while zip has finished");console.info("Start file: "+e);var i=new Date(t);this.fileRecord=[...this.fileRecord,{name:e,sizeBig:BigInt(0),crc:new s.Crc32,done:!1,date:i,headerOffsetBig:this.byteCounterBig}];var r=(new TextEncoder).encode(e),r=l.ZipUtils.createByteArray([{data:67324752,size:4},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:l.ZipUtils.getTimeStruct(i),size:2},{data:l.ZipUtils.getDateStruct(i),size:2},{data:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:r.length,size:2},{data:this.zip64?32:0,size:2},{data:r},{data:this.zip64?this.getZip64ExtraField(BigInt(0),this.byteCounterBig):[]}]);this.enqueue(r),this.byteCounterBig+=BigInt(r.length)}appendData(e){if(!this.isWritingFile()||this.finished)throw new Error("Tried to append file data, but there is no open file!");this.enqueue(e),this.byteCounterBig+=BigInt(e.length),this.fileRecord[this.fileRecord.length-1].crc.append(e),this.fileRecord[this.fileRecord.length-1].sizeBig+=BigInt(e.length)}endFile(){if(!this.isWritingFile()||this.finished)throw new Error("Tried to end file, but there is no open file!");{const t=this.fileRecord[this.fileRecord.length-1];console.info("End file: "+t.name);var e=l.ZipUtils.createByteArray([{data:t.crc.get(),size:4},{data:t.sizeBig,size:this.zip64?8:4},{data:t.sizeBig,size:this.zip64?8:4}]);this.enqueue(e),this.byteCounterBig+=BigInt(e.length),this.fileRecord[this.fileRecord.length-1].done=!0}}finish(){if(this.isWritingFile()||this.finished)throw new Error("Empty zip, or there is still a file open");{console.info("Finishing zip");let o=BigInt(0);var e,t,i=this.byteCounterBig;this.fileRecord.forEach(e=>{const{date:t,crc:i,sizeBig:r,name:s,headerOffsetBig:a}=e;var n=(new TextEncoder).encode(s),n=l.ZipUtils.createByteArray([{data:33639248,size:4},{data:45,size:2},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:l.ZipUtils.getTimeStruct(t),size:2},{data:l.ZipUtils.getDateStruct(t),size:2},{data:i.get(),size:4},{data:this.zip64?4294967295:r,size:4},{data:this.zip64?4294967295:r,size:4},{data:n.length,size:2},{data:this.zip64?32:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:4},{data:this.zip64?4294967295:a,size:4},{data:n},{data:this.zip64?this.getZip64ExtraField(r,a):[]}]);this.enqueue(n),this.byteCounterBig+=BigInt(n.length),o+=BigInt(n.length)}),this.zip64&&(t=this.byteCounterBig,e=l.ZipUtils.createByteArray([{data:101075792,size:4},{data:44,size:8},{data:45,size:2},{data:45,size:2},{data:0,size:4},{data:0,size:4},{data:this.fileRecord.length,size:8},{data:this.fileRecord.length,size:8},{data:o,size:8},{data:i,size:8}]),this.enqueue(e),this.byteCounterBig+=BigInt(e.length),t=l.ZipUtils.createByteArray([{data:117853008,size:4},{data:0,size:4},{data:t,size:8},{data:1,size:4}]),this.enqueue(t),this.byteCounterBig+=BigInt(t.length));i=l.ZipUtils.createByteArray([{data:101010256,size:4},{data:0,size:2},{data:0,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?4294967295:o,size:4},{data:this.zip64?4294967295:i,size:4},{data:0,size:2}]);this.enqueue(i),this.close(),this.byteCounterBig+=BigInt(i.length),this.finished=!0,console.info("Done writing zip file. "+`Wrote ${this.fileRecord.length} files and a total of ${this.byteCounterBig} bytes.`)}}})}}}),System.register("gui/component/PromptDialog",["react","gui/component/Dialog"],function(e,t){"use strict";var u,d;t&&t.id;return{setters:[function(e){u=e},function(e){d=e}],execute:function(){e("PromptDialog",({viewport:e,promptText:t,submitLabel:i,cancelLabel:r,inputProps:s,onSubmit:a,onDismiss:n})=>{let o=u.useRef(null),[l,c]=u.useState(!1);u.useEffect(()=>{setTimeout(()=>{o.current?.focus()},50)},[]);var h=e=>{e&&e.preventDefault(),c(!0),a(o.current.value)};return u.default.createElement(d.Dialog,{className:"prompt-box",hidden:l,viewport:e,zIndex:100,buttons:[{label:i,onClick:h},{label:r,onClick:()=>{c(!0),n?.()}}]},u.default.createElement("form",{onSubmit:h,autoComplete:"off"},u.default.createElement("div",{className:"field"},u.default.createElement("label",null,t.split(/\r?\n/).map((e,t)=>u.default.createElement(u.default.Fragment,{key:t},t?u.default.createElement("br",null):null,e))),u.default.createElement("input",{name:"promptvalue",type:"text",autoComplete:"off","data-lpignore":"true",ref:o,...s})),u.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/component/MessageBoxApi",["react","gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Dialog","gui/component/PromptDialog"],function(e,t){"use strict";var i,n,o,r,s,l,a;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){o=e},function(e){r=e},function(e){s=e},function(e){l=e}],execute:function(){e("MessageBoxApi",a=class{constructor(e,t,i){this.viewport=e,this.uiScene=t,this.jsxRenderer=i,this.disposables=new r.CompositeDisposable}show(e,t,i){this.destroy();let[r]=this.jsxRenderer.render(n.jsx(o.HtmlView,{innerRef:e=>this.component=e,component:s.Dialog,props:{children:"string"!=typeof e?e:this.splitNewLines(e),viewport:this.viewport,zIndex:101,buttons:"string"==typeof t?[{label:t,onClick:()=>{this.disposables.dispose(),i?.()}}]:(t??[]).map(e=>({label:e.label,onClick:()=>{this.disposables.dispose(),e.onClick?.()}}))}}));this.uiScene.add(r),this.disposables.add(r,()=>this.uiScene.remove(r),()=>this.component=void 0)}splitNewLines(e){return e.split(/\n/g).map((e,t)=>t?i.createElement(i.Fragment,{key:t},i.createElement("br",null),e):e)}async confirm(t,i,r){return await new Promise(e=>{this.show(t,[{label:i,onClick:()=>e(!0)},{label:r,onClick:()=>e(!1)}])})}async alert(t,i){await new Promise(e=>this.show(t,i,e))}async prompt(e,r,s,a){return this.destroy(),await new Promise(t=>{let[i]=this.jsxRenderer.render(n.jsx(o.HtmlView,{innerRef:e=>this.component=e,component:l.PromptDialog,props:{promptText:e,submitLabel:r,cancelLabel:s,inputProps:a,onSubmit:e=>{t(e),i.destroy()},onDismiss:()=>{t(void 0),i.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(i),this.disposables.add(i,()=>this.uiScene.remove(i),()=>this.component=void 0)})}updateViewport(t){this.viewport=t,this.component&&this.component.applyOptions(e=>e.viewport=t)}updateText(t){this.component&&this.component.applyOptions(e=>{e.promptText?e.promptText=t:e.children="string"!=typeof t?t:this.splitNewLines(t)})}destroy(){this.disposables.dispose()}})}}}),System.register("RouteHelper",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RouteHelper",i=class{}),i.modQueryStringName="mod"}}}),System.register("gui/screen/mainMenu/modSel/ModMeta",["gui/screen/mainMenu/modSel/ModManager"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("ModMeta",i=class i{constructor(){this.supported=!1,this.manualDownload=!1}fromIniFile(e){var t=e.getSection("General");if(!t)throw new Error("Mod meta missing [General] section");return this.fromIniSection(t),this}fromIniSection(e){let t=e.getString("ID");var i=e.getString("Name");if(!t)throw new Error("Mod meta missing ID");if(!t.match(s.ModManager.modIdRegex))throw new Error(`Mod meta has invalid ID "${t}". `+"ID must contain only alphanumeric characters, dash (-) or underscore (_)");if(!i)throw new Error("Mod meta missing Name");this.id=t,this.name=i,this.supported=!0,this.description=e.getString("Description")||void 0;i=e.get("Author");i&&(this.authors=Array.isArray(i)?i:[i]);let r=e.getString("Website");return r&&(r.match(/^https?:\/\//)?this.website=r:console.warn(`Invalid mod meta website "${r}"`)),this.version=e.getString("Version")||void 0,this.download=e.getString("Download")||void 0,this.downloadSize=e.getNumber("DownloadSize")||void 0,this.manualDownload=e.getBool("ManualDownload"),this}clone(){let e=new i;return e.id=this.id,e.name=this.name,e.supported=this.supported,e.description=this.description,e.authors=this.authors?.slice(),e.website=this.website,e.version=this.version,e.download=this.download,e.downloadSize=this.downloadSize,e.manualDownload=this.manualDownload,e}})}}}),System.register("gui/screen/mainMenu/modSel/ModStatus",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.NotInstalled=0]="NotInstalled",e[e.Installed=1]="Installed",e[e.UpdateAvailable=2]="UpdateAvailable",t("ModStatus",i)}}}),System.register("gui/screen/mainMenu/modSel/Mod",["gui/screen/mainMenu/modSel/ModStatus"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Mod",r=class{constructor(e,t){if(e)t&&t.version!==e.version?(this.status=i.ModStatus.UpdateAvailable,this.meta=e.clone(),this.meta.download=t.download,this.meta.downloadSize=t.downloadSize,this.meta.manualDownload=t.manualDownload,this.latestVersion=t.version):(this.status=i.ModStatus.Installed,this.meta=e,this.latestVersion=e.version);else{if(this.status=i.ModStatus.NotInstalled,!t)throw new Error("At least a local or remote meta must be specified");this.meta=t,this.latestVersion=t.version}}get id(){return this.meta.id}get name(){return this.meta.name}get supported(){return this.meta.supported}isInstalled(){return this.status!==i.ModStatus.NotInstalled}})}}}),System.register("gui/screen/mainMenu/modSel/ModManager",["data/IniFile","RouteHelper","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModMeta"],function(e,t){"use strict";var n,i,o,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){i=e},function(e){o=e},function(e){l=e}],execute:function(){e("ModManager",c=class c{constructor(e,t,i){this.location=e,this.modDir=t,this.appResourceLoader=i}getModDir(){return this.modDir}async buildModList(e,t){let i=[];t=[...t??[]];for(let a of e){var r=t.findIndex(e=>e.id===a.id),r=-1!==r?t.splice(r,1)[0]:void 0;i.push(new o.Mod(a,r))}for(var s of t)i.push(new o.Mod(void 0,s));return i}async listRemote(){var e,t=await this.appResourceLoader.loadText(c.remoteListFileName);let i=new n.IniFile(t),r=i.getSection("General");if(!r)throw new Error(c.remoteListFileName+" is missing the [General] section");let s=[];for(e of r.entries.values()){var a=i.getSection(e);a?(a=(new l.ModMeta).fromIniSection(a),s.push(a)):console.warn(`Mod "${e}" has no INI section`)}return s}async listLocal(){let e=[];if(this.modDir)for await(var t of this.modDir.getEntries()){t=await this.loadModMeta(t);e.push(t)}return e.sort((e,t)=>e.name.localeCompare(t.name)),e}async loadModMeta(i){let r=new l.ModMeta;r.id=i,r.name=i;try{let e=await this.modDir.getDirectory(i,!0),t=await e.containsEntry(c.modMetaFileName)?await e.getRawFile(c.modMetaFileName):void 0;if(t){try{r.fromIniFile(new n.IniFile(await t.text()))}catch(e){console.warn(`Couldn't parse meta file in mod folder "${i}"`),r.name=i}r.id=i}}catch(e){console.warn(e)}return r}async deleteModFiles(e){await this.modDir?.containsEntry(e)&&await this.modDir.deleteDirectory(e,!0)}loadMod(e){let t=new URL(this.location.href);e?t.searchParams.set(i.RouteHelper.modQueryStringName,e):t.searchParams.delete(i.RouteHelper.modQueryStringName),this.location.href=t.href}}),c.remoteListFileName="mods.ini",c.modMetaFileName="modcd.ini",c.modIdRegex=/^[a-z0-9-_]+$/i}}}),System.register("util/CssLoader",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CssLoader",i=class{constructor(e){this.document=e}async load(r){return new Promise((e,t)=>{let i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=r,"onload"in i&&(i.onload=()=>e()),"onerror"in i&&(i.onerror=()=>t(new Error(`Couldn't load CSS at "${r}"`))),this.document.head.appendChild(i),"onload"in i||e()})}})}}}),System.register("gui/screen/options/component/StorageExplorer",["@puzzl/core/lib/regexp","data/vfs/RealFileSystemDir","data/zip/Zip","engine/Engine","gui/replay/ReplayStorageFileSystem","gui/screen/mainMenu/modSel/ModManager","network/gamestate/Replay","react","util/CssLoader","util/ScriptLoader","util/time"],function(t,e){"use strict";var i,S,w,r,s,C,a,n,E,x,O,A,M,R,P,I,k,o,B,j;e&&e.id;return{setters:[function(e){i=e},function(e){S=e},function(e){w=e},function(e){r=e},function(e){s=e},function(e){C=e},function(e){a=e},function(e){n=e},function(e){E=e},function(e){x=e},function(e){O=e}],execute:function(){var e;A=t=>o.some(e=>"string"==typeof e?t.toLowerCase()===e.toLowerCase():e.test(t)),M=async(e,t)=>{let i=[];for await(var[r,s]of e.entries())i.push({id:r,name:r,type:"directory"===s.kind?"folder":"file",hash:r,attrs:"directory"!==s.kind||A(("/"!==t?t:"")+"/"+r)?void 0:{canmodify:!1},..."file"===s.kind?{size:(await s.getFile()).size}:{}});return i},R=async(e,t,i=!1)=>{let r=t;for(var s of e.slice(1))r=await r.getDirectoryHandle(s,{create:i});return r},P=["/keyboard.ini",/^\/(language|multi|ra2)\.mix$/i,"/"+r.Engine.rfsSettings.menuVideoFileName,"/"+r.Engine.rfsSettings.splashImgFileName,new RegExp(`^/${r.Engine.rfsSettings.musicDir}/([^/]+).mp3$`,"i"),new RegExp(`^/${r.Engine.rfsSettings.replayDir}/`+`(([^/]+)${i.escape(a.Replay.extension)})|(${i.escape(s.ReplayStorageFileSystem.manifestFileName)})$`,"i"),new RegExp(`^/${r.Engine.rfsSettings.tauntsDir}/tau([^/]+).wav$`,"i"),new RegExp(`^/${r.Engine.rfsSettings.modDir}/[^/]+/`,"i"),new RegExp(`^/${r.Engine.rfsSettings.mapDir}/[^/]+.(${r.Engine.supportedMapTypes.join("|")})$`,"i")],I=["/keyboard.ini",/^\/[^/]+\.mix$/i,new RegExp(`^/${r.Engine.rfsSettings.musicDir}/`,"i"),new RegExp(`^/${r.Engine.rfsSettings.tauntsDir}/`,"i")],k=[/^\/([^/]+)\.mix$/i,"/"+r.Engine.rfsSettings.menuVideoFileName,"/"+r.Engine.rfsSettings.splashImgFileName,"/"+r.Engine.rfsSettings.musicDir,"/"+r.Engine.rfsSettings.tauntsDir,"/"+r.Engine.rfsSettings.replayDir+"/"+s.ReplayStorageFileSystem.manifestFileName],o=["/","/"+r.Engine.rfsSettings.replayDir,new RegExp(`^/${r.Engine.rfsSettings.modDir}(/.*)?`),new RegExp(`^/${r.Engine.rfsSettings.mapDir}(/.*)?`)],B=[r.Engine.rfsSettings.modDir],(e=j=j||{})[e.None=0]="None",e[e.OverwriteAll=1]="OverwriteAll",e[e.SkipAll=2]="SkipAll",t("StorageExplorer",({messageBoxApi:f,storageDirHandle:y,startIn:c,strings:T,onFileSystemChange:v})=>{const b=n.useRef(null);return n.useEffect(()=>{let u,e=!1,h,d=j.None,g=0,p=!1;const m=async()=>{var e,t,i;u&&navigator.storage?.estimate&&({usage:e,quota:t}=await navigator.storage.estimate(),e&&t&&(i=T.get("GUI:StorageUsed",u.GetDisplayFilesize(e),u.GetDisplayFilesize(t)),u.SetNamedStatusBarText("quota",t<=e?"<font color='red'>"+i+"</font>":i)))},r=async(i,r)=>{if(B.includes(r.GetPathIDs().pop())){let t=prompt(T.get("GUI:NewFolderPrompt"));if(t?.match(C.ModManager.modIdRegex)){try{let e=await R(r.GetPathIDs(),y);if(await new S.RealFileSystemDir(e).containsEntry(t))return void i(T.get("GUI:NewFolderExists"));var s=await e.getDirectoryHandle(t,{create:!0});t=s.name}catch(e){return console.error(e),void i(!1)}i({type:"folder",name:t,id:t,hash:t})}else i(T.get("GUI:NewFolderInvalidName"))}else i(T.get("GUI:NewFolderNotAllowed"))},s=async(e,i,t)=>{let r=[],s=[];var a,n=t.length;for(a of t){let t=[...i.GetPathIDs(),a].join("/");(k.some(e=>"string"==typeof e?t.toLowerCase()===e.toLowerCase():e.test(t))?r:s).push(t)}if(!s.length||await f.confirm(1===n?T.get("GUI:ConfirmDeleteFile"):T.get("GUI:ConfirmDeleteFiles",n),T.get("GUI:Yes"),T.get("GUI:No"))){if(r.length)for(var o of r)await f.confirm(T.get("GUI:ConfirmDeleteSystemFile",o),T.get("GUI:Yes"),T.get("GUI:No"))&&s.push(o);if(s.length){let t;try{for(var l of s){console.log(`Deleting "${l}"...`);var c=l.substring(0,l.lastIndexOf("/")).split("/");let e=await R(c,y);await e.removeEntry(l.split("/").pop(),{recursive:!0}),console.log(`Deleted "${l}".`)}}catch(e){console.error(e),t=e}e(!!t&&t.message),u?.RefreshFolders(!0),p||(p=!0,v())}else e(!1)}else e(!1)},a=async(e,t)=>{let i=t.folder.GetPathIDs().join("/")+t.fullPath,r=i.substring(0,i.lastIndexOf("/")).split("/"),s=!1;h&&(clearTimeout(h),h=void 0),g++;let a=!1,n;try{if(P.some(e=>"string"==typeof e?i.toLowerCase()===e.toLowerCase():e.test(i))){n=await R(r,y,!0);for await(var o of n.keys())if(o.toLowerCase()===t.file.name.toLowerCase()){var l;d===j.None?(2===(l=await new Promise(e=>{f.show(T.get("GUI:ConfirmOverwriteFile",r.join("/")||"/",t.file.name),[{label:T.get("GUI:Yes"),onClick:()=>e(1)},{label:T.get("GUI:YesToAll"),onClick:()=>e(2)},{label:T.get("GUI:No"),onClick:()=>e(0)},{label:T.get("GUI:Cancel"),onClick:()=>e(-1)}])}))?d=j.OverwriteAll:-1===l&&(d=j.SkipAll),l<=0&&(a=!0)):d===j.SkipAll&&(a=!0);break}}else a=!0;if(a)console.log("File skipped: "+i);else{console.log("Uploading file: "+i),u?.SetNamedStatusBarText("message",T.get("GUI:Uploading",i));let e=t.file.name;I.some(e=>"string"==typeof e?i.toLowerCase()===e.toLowerCase():e.test(i))&&(e=e.toLowerCase()),await new S.RealFileSystemDir(n).writeFile(t.file,e),s=!0,console.log("File uploaded: "+i)}}catch(e){console.error(e);var c="QuotaExceededError"===e.name?T.get("GUI:UploadFailedQuota"):T.get("GUI:UploadFailed");u?.SetNamedStatusBarText("message","<font color='red'>"+c+"</font>",1e4)}g--,g||(h=setTimeout(()=>{d=j.None,u?.SetNamedStatusBarText("message",T.get("GUI:UploadFinished"),2e3)},1e3)),e(!1),u&&s&&(u.RefreshFolders(!0),await m(),p||(p=!0,v()))},n=(e,c,t,h)=>{1!==h.length||"file"!==h[0].type?(async()=>{let e=await SystemJS.import("file-system-access"),t=await e.showSaveFilePicker({suggestedName:"cdexport.zip"}),r=await R(c.GetPathIDs(),y),a=new w.Zip;const s=async(e,t,i)=>{for await(var r of e.values())"directory"===r.kind?await s(r,t+"/"+r.name,i):await i(await r.getFile(),t+"/"+r.name)};let i=new AbortController,n=u.CreateProgressTracker(()=>{try{i.abort()}catch(e){}});n.queueditems=h.length,n.showbyterate=!0;const o=async(e,t)=>{a.startFile(t,e.lastModified);const i=e.stream().getReader();for(;;){var{done:r,value:s}=await i.read();if(r)break;a.appendData(s),await O.sleep(0)}a.endFile(),n.totalbytes+=e.size};var l=setTimeout(()=>{f.show(T.get("GUI:CreatingArchive"),T.get("GUI:Cancel"),()=>{try{n.cancelcallback()}catch(e){console.error(e)}})},1e3);try{await Promise.all([(async()=>{for(var{id:t,type:e}of h){if("folder"===e){var i=await r.getDirectoryHandle(t);await s(i,t,async(e,t)=>{await o(e,t)})}else{let e=await r.getFileHandle(t);i=await e.getFile();await o(i,t)}n.itemsdone++}a.finish()})(),(async()=>{var e=await t.createWritable();await a.outputStream.pipeTo(e,{signal:i.signal})})()]),console.log("ZIP file saved successfully."),u?.RemoveProgressTracker(n,T.get("GUI:DownloadFinished"))}catch(e){clearTimeout(l),"AbortError"!==e.name?(console.error(e),u?.RemoveProgressTracker(n,T.get("GUI:DownloadFailed")),await f.alert(T.get("GUI:DownloadFailed"),T.get("GUI:OK"))):u?.RemoveProgressTracker(n,T.get("GUI:DownloadAborted"))}finally{clearTimeout(l),f.destroy()}})().catch(e=>{"AbortError"!==e.name&&console.error(e)}):u.OpenSelectedItems()},o=(n,o)=>{(async()=>{let e=await R(n.GetPathIDs(),y),t=await e.getFileHandle(o.id);var i=await t.getFile();let r=await SystemJS.import("file-system-access"),s=await r.showSaveFilePicker({suggestedName:i.name}),a=await s.createWritable();try{await a.write(i),await a.close()}catch(e){throw await a.abort(),e}})().catch(e=>{"AbortError"!==e.name&&console.error(e)})},l=(t,e)=>{(async()=>{var e=await R(t.GetPathIDs(),y),e=await M(e,t.GetPathIDs().join("/"));u?.IsDestroyed()||t.SetEntries(e)})().catch(e=>{console.error(e)})};return(async()=>{f.show(T.get("GUI:LoadingEx"));try{if(await Promise.all([new x.ScriptLoader(document).load("lib/file-explorer/file-explorer.js"),new E.CssLoader(document).load("lib/file-explorer/file-explorer.css")]),e)return;let t=[["","/",{canmodify:A("/")}]];if(c){let e="";for(var i of c.split("/"))e+="/"+i,t.push([i,i,{canmodify:A(e)}])}u=new window.FileExplorer(b.current,{initpath:t,onrefresh:l,onopenfile:o,concurrentuploads:1,oninitupload:a,oninitdownload:n,onnewfolder:r,ondelete:s}),await m()}finally{f.destroy()}})().catch(e=>console.error(e)),()=>{e=!0,u?.Destroy(),u=void 0,h&&clearTimeout(h)}},[]),n.default.createElement("div",{ref:b,className:"storage-explorer"})})}}}),System.register("gui/screen/mainMenu/ScreenType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Home=0]="Home",e[e.Skirmish=1]="Skirmish",e[e.QuickGame=2]="QuickGame",e[e.CustomGame=3]="CustomGame",e[e.Login=4]="Login",e[e.NewAccount=5]="NewAccount",e[e.Lobby=6]="Lobby",e[e.MapSelection=7]="MapSelection",e[e.Ladder=8]="Ladder",e[e.LadderRules=9]="LadderRules",e[e.ReplaySelection=10]="ReplaySelection",e[e.ModSelection=11]="ModSelection",e[e.Score=12]="Score",e[e.InfoAndCredits=13]="InfoAndCredits",e[e.PatchNotes=14]="PatchNotes",e[e.Credits=15]="Credits",e[e.Options=16]="Options",e[e.OptionsSound=17]="OptionsSound",e[e.OptionsKeyboard=18]="OptionsKeyboard",e[e.OptionsStorage=19]="OptionsStorage",t("ScreenType",i)}}}),System.register("gui/screen/mainMenu/MainMenuController",["gui/screen/Controller","engine/sound/SoundKey","engine/sound/ChannelType"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends i.Controller{constructor(e,t,i){super(),this.mainMenu=e,this.sound=t,this.music=i}async goToScreenBlocking(...e){var[t,i]=e;return super.goToScreenBlocking(t,i)}goToScreen(...e){var[t,i]=e;return super.goToScreen(t,i)}async pushScreen(...e){var[t,i]=e;this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.pushScreen(t,i);t=this.screens.get(t);t.title&&this.mainMenu.setSidebarTitle(t.title),void 0!==t.musicType&&await this.music?.play(t.musicType)}async popScreen(e){this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.popScreen(e);var t=this.getCurrentScreen();t?.title&&this.mainMenu.setSidebarTitle(t.title)}setSidebarButtons(e,t=!1){this.mainMenu.setButtons(e,t)}showSidebarButtons(){this.mainMenu.isSidebarCollapsed()&&(this.sound.play(r.SoundKey.GUIMoveInSound,s.ChannelType.Ui),this.mainMenu.showButtons())}setSidebarMpText(e){this.mainMenu.setSidebarMpText(e)}hideSidebarButtons(){if(!this.mainMenu.isSidebarCollapsed())return this.sound.play(r.SoundKey.GUIMoveOutSound,s.ChannelType.Ui),new Promise(e=>{let t=()=>{this.mainMenu.onSidebarToggle.unsubscribe(t),e()};this.mainMenu.onSidebarToggle.subscribe(t),this.mainMenu.hideButtons()})}toggleSidebarPreview(e){this.mainMenu.toggleSidebarPreview(e)}setSidebarPreview(e){this.mainMenu.setSidebarPreview(e)}getSidebarPreviewSize(){return this.mainMenu.getSidebarPreviewSize()}toggleMainVideo(e){this.mainMenu.toggleVideo(e)}showVersion(e){this.mainMenu.showVersion(e)}hideVersion(){this.mainMenu.hideVersion()}setMainComponent(e){this.mainMenu.setContentComponent(e)}destroy(){this.setMainComponent(void 0),super.destroy()}},e("MainMenuController",a)}}}),System.register("gui/screen/mainMenu/MainMenuScreen",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MainMenuScreen",i=class{setController(e){this.controller=e}})}}}),System.register("gui/screen/options/StorageScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/StorageExplorer","gui/screen/mainMenu/MainMenuScreen"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends a.MainMenuScreen{constructor(e,t,i,r){super(),this.strings=e,this.jsxRenderer=t,this.messageBoxApi=i,this.rfs=r,this.title=this.strings.get("GUI:Storage")}onEnter(e){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[t]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.StorageExplorer,props:{strings:this.strings,messageBoxApi:this.messageBoxApi,storageDirHandle:this.rfs.getRootDirectoryHandle(),startIn:e?.startIn,onFileSystemChange:()=>{this.controller?.setSidebarButtons([{label:this.strings.get("GUI:ExitAndReload"),isBottom:!0,onClick:()=>{location.reload()}}])}}}));this.controller.setMainComponent(t)}async onLeave(){await this.controller.hideSidebarButtons()}},e("StorageScreen",n)}}}),System.register("gui/screen/mainMenu/customGame/component/viewmodel/gameBrowser",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/component/List",["react","classnames"],function(e,t){"use strict";var o,l;t&&t.id;return{setters:[function(e){o=e},function(e){l=e}],execute:function(){e("List",({children:e,className:t,title:i,innerRef:r,tooltip:s})=>o.default.createElement(o.default.Fragment,null,i&&o.default.createElement("div",{className:"list-title"},i),o.default.createElement("div",{ref:r,className:l.default("list",t),"data-r-tooltip":s},e))),e("ListItem",({children:e,selected:t,disabled:i,tooltip:r,className:s,innerRef:a,...n})=>o.default.createElement("div",{ref:a,className:l.default("list-item",{selected:t,disabled:i},s),"data-r-tooltip":r,...n},e)),e("ListHeader",({children:e,tooltip:t,className:i,innerRef:r,...s})=>o.default.createElement("div",{ref:r,className:l.default("list-header",i),"data-r-tooltip":t,...s},e))}}}),System.register("gui/component/ChannelOpIndicator",["react","gui/component/Image"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ChannelOpIndicator",({operator:e})=>i.default.createElement("div",{className:"channel-op-indicator"},e?i.default.createElement(r.Image,{src:"woloper.pcx"}):null))}}}),System.register("gui/component/ChannelUser",["classnames","gui/screen/mainMenu/lobby/component/RankIndicator","react","gui/component/ChannelOpIndicator"],function(e,t){"use strict";var n,o,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("ChannelUser",({user:e,playerProfile:t,strings:i,onClick:r})=>{var s=t?.rank;let a=e.name;return e.operator&&(a+=" : "+i.get("TXT_OPER")),a+=void 0!==s?` : ${i.get("GUI:Rank")} `+s:" : "+i.get("TXT_UNRANKED"),l.default.createElement("div",{className:n.default("player",{operator:e.operator}),"data-r-tooltip":a,onClick:r},l.default.createElement(c.ChannelOpIndicator,{operator:e.operator}),l.default.createElement(o.RankIndicator,{playerProfile:t,strings:i}),e.name)})}}}),System.register("gui/screen/mainMenu/customGame/component/GameBrowser",["react","gui/component/Chat","gui/component/List","gui/component/Image","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/ChannelUser","network/chat/ChatMessage"],function(e,t){"use strict";var p,n,m,h,u,o,l,c,f;t&&t.id;return{setters:[function(e){p=e},function(e){n=e},function(e){m=e},function(e){h=e},function(e){u=e},function(e){o=e},function(e){l=e}],execute:function(){e("GameBrowser",i=>{const[t,r]=p.useState(void 0);p.useEffect(()=>{t&&!i.games.find(e=>e.name===t.name)&&s(void 0)},[i.games]);const s=e=>{r(e),i.onSelectGame(e)};let a=i.strings;return p.default.createElement("div",{className:"gamebrowser-wrapper"},p.default.createElement("div",{className:"gamebrowser-top"},p.default.createElement("div",{className:"games"},p.default.createElement("div",{className:"games-header"},p.default.createElement("button",{className:"icon-button refresh-button",onClick:i.onRefreshClick,"data-r-tooltip":a.get("STT:WOLLobbyRefreshChannels")}),p.default.createElement("span",{className:"games-label"},a.get("GUI:OpenGames"))),p.default.createElement(c,{games:i.games,selectedGame:t,mapList:i.mapList,onClickGame:s,onDoubleClickGame:e=>{s(e),i.onDoubleClickGame(e)},tooltip:a.get("STT:LobbyListGames"),strings:a,pings:i.pings,playerProfiles:i.playerProfiles}))),p.default.createElement("div",{className:"gamebrowser-bottom"},p.default.createElement(n.Chat,{strings:a,messages:i.messages,channels:i.channels??[],chatHistory:i.chatHistory,localUsername:i.localUsername,onSendMessage:i.onSendMessage,tooltips:{input:a.get("STT:LobbyEditInput"),output:a.get("STT:LobbyEditOutput"),button:a.get("STT:EmoteButton")}}),p.default.createElement(m.List,{className:"players-list",tooltip:a.get("STT:LobbyListUsers")},i.users.map(e=>{var t=i.playerProfiles.get(e.name);return p.default.createElement(o.ChannelUser,{key:e.name,user:e,playerProfile:t,strings:a,onClick:()=>{i.chatHistory.lastComposeTarget.value={type:l.ChatRecipientType.Whisper,name:e.name}}})}))))}),c=({games:e,selectedGame:o,onClickGame:l,onDoubleClickGame:c,tooltip:t,strings:h,pings:u,playerProfiles:d,mapList:g})=>p.default.createElement(p.default.Fragment,null,p.default.createElement(m.ListHeader,{className:"game game-list-header"},p.default.createElement("span",{className:"game-flags"},p.default.createElement("span",{className:"game-type"}),p.default.createElement("span",{className:"game-pass-locked"}),p.default.createElement("span",{className:"game-obs"})),p.default.createElement("span",{className:"game-map"},h.get("GUI:Map")),p.default.createElement("span",{className:"game-name"},h.get("GUI:RoomDesc")),p.default.createElement("span",{className:"game-players"},""),p.default.createElement("span",{className:"game-host"},h.get("GUI:HostName")),p.default.createElement("span",{className:"game-ping"},h.get("GUI:Ping"))),p.default.createElement(m.List,{className:"games-list",tooltip:t},e.map((e,t)=>{var i=e.hostPing??u.get(e.hostName)??void 0,r=d.get(e.hostName),s=r?.rank;let a=g.getByName(e.mapName);var n=!a?.official&&e.hostMuted?h.get("GUI:CustomMap"):a?.getFullMapTitle(h)||e.mapName;return p.default.createElement(f,{key:e.name,game:e,uiMapName:n,customMap:!a?.official,ping:i,hostProfile:r,tooltip:[...e.modName?[""+h.get("GUI:GameMod",e.modName)]:[],h.get("TXT_MAP",n),i?h.get("WOL:GamePing",i):h.get("TXT_UNKNOWN_PING"),...void 0!==s?[h.get("TXT_HOST_RANK")+" "+s]:[]].join(", "),selected:e.name===o?.name,strings:h,onClick:l,onDoubleClick:c})}))),f=({game:e,uiMapName:t,customMap:i,selected:r,tooltip:s,ping:a,hostProfile:n,strings:o,onClick:l,onDoubleClick:c})=>p.default.createElement(m.ListItem,{key:e.name,className:"game",selected:r,tooltip:s,onClick:()=>l(e),onDoubleClick:()=>c(e)},p.default.createElement("span",{className:"game-flags"},p.default.createElement("span",{className:"game-type",title:e.modName||!i?""+o.get("GUI:GameMod",e.modName||o.get("GUI:Official")):""+o.get("GUI:CustomMap")},e.modName||i?p.default.createElement(h.Image,{src:"settings.png"}):p.default.createElement(h.Image,{src:e.tournament?"woltrny.pcx":"gt18.pcx"})),p.default.createElement("span",{className:"game-pass-locked"},e.passLocked?p.default.createElement(h.Image,{src:"wolpriv.pcx"}):null),p.default.createElement("span",{className:"game-obs"},e.observable?p.default.createElement(h.Image,{src:"wolob.pcx"}):null)),p.default.createElement("span",{className:"game-map",title:t},t),p.default.createElement("span",{className:"game-name",title:e.hostMuted?void 0:e.description},e.hostMuted?void 0:e.description),p.default.createElement("span",{className:"game-players"},e.maxPlayers?e.humanPlayers+e.aiPlayers+"/"+(e.maxPlayers-(e.observable?1:0)):"?/?"),p.default.createElement("span",{className:"game-host"},e.hostName,void 0!==n&&p.default.createElement(u.RankIndicator,{playerProfile:n,strings:o})),p.default.createElement("span",{className:"game-ping"},a?p.default.createElement("meter",{value:a,max:300,low:100,high:250,optimum:0,title:a+"ms"}):null))}}}),System.register("gui/screen/mainMenu/lobby/component/PasswordBox",["react","gui/component/Dialog"],function(e,t){"use strict";var l,c;t&&t.id;return{setters:[function(e){l=e},function(e){c=e}],execute:function(){e("PasswordBox",({strings:e,viewport:t,onSubmit:i,onDismiss:r})=>{let s=l.useRef(null),[a,n]=l.useState(!1);l.useEffect(()=>{setTimeout(()=>{s.current?.focus()},50)},[]);var o=e=>{e&&e.preventDefault(),n(!0),i(s.current.value)};return l.default.createElement(c.Dialog,{className:"login-box password-box",hidden:a,viewport:t,zIndex:100,buttons:[{label:e.get("GUI:Ok"),onClick:o},{label:e.get("GUI:Cancel"),onClick:()=>{n(!0),r?.()}}]},l.default.createElement("form",{onSubmit:o,autoComplete:"off"},l.default.createElement("div",{className:"field"},l.default.createElement("label",null,e.get("GUI:Password")),l.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:s})),l.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/mainMenu/lobby/component/CreateGameBox",["react","gui/component/Dialog","network/WolConnection"],function(e,t){"use strict";var g,p,m;t&&t.id;return{setters:[function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("CreateGameBox",({strings:e,viewport:t,onSubmit:i,onDismiss:r})=>{let[s,a]=g.useState(!1),[n,o]=g.useState(""),l=g.useRef(null),c=g.useRef(null),[h,u]=g.useState(!1),d=g.useRef(null);return g.default.createElement(p.Dialog,{className:"login-box create-game-box",hidden:s,viewport:t,buttons:[{label:e.get("GUI:Ok"),onClick:()=>c.current?.click()},{label:e.get("GUI:Cancel"),onClick:()=>{a(!0),r?.()}}],zIndex:100},g.default.createElement("form",{onSubmit:e=>{e.preventDefault(),a(!0),i(n,h?l.current.value:"",d.current.checked)},autoComplete:"off"},g.default.createElement("div",{className:"field"},g.default.createElement("label",null,e.get("GUI:RoomDesc")),g.default.createElement("input",{name:"roomname",type:"text",value:n,maxLength:m.WolConnection.MAX_ROOM_DESC_LEN,onChange:e=>{o(e.target.value)}})),g.default.createElement("div",{className:"field"},g.default.createElement("label",null,e.get("GUI:Password")),g.default.createElement("input",{name:"enablepass",type:"checkbox",checked:h,onChange:()=>{u(!h)}}),g.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:l,disabled:!h,required:h})),g.default.createElement("div",{className:"field"},g.default.createElement("label",null,e.get("GUI:Observe")),g.default.createElement("input",{type:"checkbox",name:"test",ref:d})),g.default.createElement("button",{type:"submit",ref:c,style:{visibility:"hidden"}})))})}}}),System.register("ErrorHandler",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ErrorHandler",i=class{constructor(e,t){this.messageBoxApi=e,this.strings=t}handle(e,t,i){this.isErrorState||this.messageBoxApi.show(t,this.strings.get("GUI:Ok"),()=>{this.isErrorState=!1,i()}),console.error("Handled error:",e),this.isErrorState=!0}})}}}),System.register("gui/screen/mainMenu/lobby/MapPreviewRenderer",["engine/gfx/CanvasUtils","gui/HtmlContainer","gui/UiObject","gui/screen/mainMenu/lobby/component/viewmodel/lobby","game/Coords","engine/IsoCoords"],function(e,t){"use strict";var d,g,p,i,m,f,y,r;t&&t.id;return{setters:[function(e){d=e},function(e){g=e},function(e){p=e},function(e){i=e},function(e){m=e},function(e){f=e}],execute:function(){y=new Map([[i.LobbyType.Singleplayer,"STT:SkirmishMapThumbnail"],[i.LobbyType.MultiplayerHost,"STT:HostMapThumbnail"],[i.LobbyType.MultiplayerGuest,"STT:GuestMapThumbnail"]]),e("MapPreviewRenderer",r=class{constructor(e){this.strings=e}render(a,n,o){let l;try{l=a.decodePreviewImage()}catch(e){console.error("Failed to decode map preview data",e)}if(l){var{data:c,width:h,height:u}=l;let e=d.CanvasUtils.canvasFromRgbImageData(c,h,u),t=1;u=e.width<o.width/2||e.height<o.height/2?4:2;let i=document.createElement("canvas");i.width=u*e.width,i.height=u*e.height;let r=i.getContext("2d");r&&(t=u,r.scale(t,t),r.drawImage(e,0,0),e=i),this.drawStartLocations(e,a,o,t);let s=new g.HtmlContainer;u=new p.UiObject(new THREE.Object3D,s);return s.setSize("100%","100%"),s.render(),e.style.objectFit="contain",e.style.width="100%",e.style.height="100%",e.setAttribute("data-r-tooltip",this.strings.get(y.get(n))),s.getElement().appendChild(e),u}}drawStartLocations(i,r,e,s){var a=i.getContext("2d");if(a){f.IsoCoords.init({x:0,y:r.fullSize.width*m.Coords.getWorldTileSize()/2});var n,o,t=f.IsoCoords.worldToScreen(0,0),l=f.IsoCoords.screenToScreenTile(t.x,t.y),t=i.width>i.height?i.width/e.width/s:i.height/e.height/s,c=13*t,h=2*t;for([n,o]of r.startingLocations.entries()){var u=o,u=f.IsoCoords.tileToScreen(u.x,u.y);let e=f.IsoCoords.screenToScreenTile(u.x,u.y);e.x+=l.x,e.y+=l.y;let t=this.dxyToCanvas(e.x,e.y,i,r.localSize);t.x/=s,t.y/=s,d.CanvasUtils.drawText(a,String(n+1),t.x-c/4,t.y-c/2,{fontSize:c,color:"yellow",outlineColor:"black",outlineWidth:h})}}}dxyToCanvas(e,t,i,r){var s=i.width/(2*r.width),a=i.height/r.height/2;return{x:(e-2*r.x)*s,y:(t-2*r.y)*a}}})}}}),System.register("gui/screen/mainMenu/lobby/PreferredHostOpts",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("PreferredHostOpts",i=class{constructor(){this.gameSpeed=6,this.credits=1e4,this.unitCount=10,this.shortGame=!0,this.superWeapons=!1,this.buildOffAlly=!0,this.mcvRepacks=!0,this.cratesAppear=!1,this.hostTeams=!1,this.slotsClosed=new Set}serialize(){return[this.gameSpeed,this.credits,this.unitCount,Number(this.shortGame),Number(this.superWeapons),Number(this.buildOffAlly),Number(this.mcvRepacks),Number(this.cratesAppear),[...this.slotsClosed].join(","),Number(this.hostTeams)].join(";")}unserialize(e){let[t,i,r,s,a,n,o,l,c,h]=e.split(";");return this.gameSpeed=Number(t),this.credits=Number(i),this.unitCount=Number(r),this.shortGame=Boolean(Number(s)),this.superWeapons=Boolean(Number(a)),this.buildOffAlly=Boolean(Number(n)),this.mcvRepacks=Boolean(Number(o)),this.cratesAppear=Boolean(Number(l)),this.hostTeams=Boolean(Number(h)),this.slotsClosed=new Set(c?c.split(",").map(e=>Number(e)):[]),this}applyGameOpts(e){return this.gameSpeed=e.gameSpeed,this.credits=e.credits,this.unitCount=e.unitCount,this.shortGame=e.shortGame,this.superWeapons=e.superWeapons,this.buildOffAlly=e.buildOffAlly,this.mcvRepacks=e.mcvRepacks,this.cratesAppear=e.cratesAppear,this.hostTeams=!!e.hostTeams,this}applyMpDialogSettings(e){return this.gameSpeed=6-e.gameSpeed,this.credits=e.money,this.unitCount=e.unitCount,this.shortGame=e.shortGame,this.mcvRepacks=e.mcvRedeploys,this.cratesAppear=e.crates,this.superWeapons=e.superWeapons,this}})}}}),System.register("gui/screen/mainMenu/lobby/SelectMapParams",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("game/gameopts/GameOptSanitizer",["util/math"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("GameOptSanitizer",i=class{static sanitize(e,t){var i=t.mpDialogSettings;e.credits=Math.floor(r.clamp(e.credits,i.minMoney,i.maxMoney)),e.gameSpeed=Math.floor(r.clamp(e.gameSpeed,0,6)),e.unitCount=Math.floor(r.clamp(e.unitCount,i.minUnitCount,i.maxUnitCount))}})}}}),System.register("gui/screen/game/MapFileLoader",["data/vfs/FileNotFoundError","data/vfs/VirtualFile"],function(e,t){"use strict";var r,s,i;t&&t.id;return{setters:[function(e){r=e},function(e){s=e}],execute:function(){e("MapFileLoader",i=class{constructor(e,t){this.resourceLoader=e,this.vfs=t}async load(e,t){let i;if(this.vfs)try{i=await this.vfs.openFileWithRfs(e)}catch(e){e instanceof r.FileNotFoundError||console.error(e)}return i=i||s.VirtualFile.fromBytes(await this.resourceLoader.loadBinary(e,t),e),i}})}}}),System.register("engine/MapDigest",["data/Crc32"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("MapDigest",r=class{static compute(e){return i.Crc32.calculateCrc(e.getBytes()).toString(16)}})}}}),System.register("network/WolConfig",[],function(t,e){"use strict";var i,r,s,a;e&&e.id;return{setters:[],execute:function(){var e;i="zotclot9",r="matchbot",(e=s=s||{})[e.Cdral2=0]="Cdral2",e[e.Yuri=1]="Yuri",t("ClientType",s),t("WolConfig",a=class a{constructor(e,t){this.clientType=e,this.clientSettings=t}static factory(e){return new this(e,a.allClientSettings.get(e))}getWolV2Compat(){return this.clientSettings.wolV2Compat}getClientSku(){return this.clientSettings.sku}getClientChannelType(){return this.clientSettings.channelType}getGlobalChannelPass(){return i}getQuickMatchBotName(){return r}getQuickMatchChannelId(e){var t=e?this.clientSettings.rankedSoloChanId:this.clientSettings.unrankedSoloChanId;if(void 0===t)throw new Error(`Client type ${this.clientType} doesn't have a configured channel for ladder=`+e);return t}hasUnrankedQuickMatch(){return void 0!==this.clientSettings.unrankedSoloChanId}}),a.allClientSettings=(new Map).set(s.Cdral2,{sku:16640,wolV2Compat:!1,channelType:45,rankedSoloChanId:50,unrankedSoloChanId:51}).set(s.Yuri,{sku:10496,wolV2Compat:!0,channelType:41,rankedSoloChanId:40})}}}),System.register("network/wladderConfig",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("CURRENT_SEASON","current"),e("PREV_SEASON","prev")}}}),System.register("network/PlayerRankHelper",["network/PlayerRankType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=[{type:i.PlayerRankType.Private,minPoints:0},{type:i.PlayerRankType.Corporal,minPoints:32},{type:i.PlayerRankType.Sergeant,minPoints:61},{type:i.PlayerRankType.Lieutenant,minPoints:81},{type:i.PlayerRankType.Major,minPoints:151},{type:i.PlayerRankType.Colonel,minPoints:251},{type:i.PlayerRankType.BrigGeneral,minPoints:501},{type:i.PlayerRankType.General,minPoints:1001},{type:i.PlayerRankType.FiveStarGeneral,minPoints:1501},{type:i.PlayerRankType.CommanderInChief,minPoints:2001}],e("PlayerRankHelper",s=class{static getRankType(e){let t=-1;for(var{minPoints:i}of r){if(e<i)break;t++}return r[t].type}})}}}),System.register("network/WLadderTransport",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/WLadderConnection",["network/PlayerRankHelper"],function(e,t){"use strict";var h,s;t&&t.id;return{setters:[function(e){h=e}],execute:function(){e("WLadderConnection",s=class s{constructor(e){this.transport=e}async listSearch(e,c){c=c.slice(0,s.MAX_LIST_SEARCH_COUNT);let t=await this.transport.sendCommand(`listsearch ${e} -1 0 0 0 :${c.join(":")}:`);return t.map((e,t)=>{if("NOTFOUND"===e)return{name:c[t]};let i=e.split(/\s+/);var[r,,s,a,n,o,l]=i.map(Number);return{name:i[1],wins:a,losses:n,disconnects:l,rank:r,rankType:h.PlayerRankHelper.getRankType(s),...o?{prevRank:o}:void 0,points:s}})}async rungSearch(e,t,i){i=Math.min(i,s.MAX_LIST_SEARCH_COUNT);let r=await this.transport.sendCommand(`rungsearch ${t} ${i} 0 `+e);return r.map(e=>{let t=e.split(/\s+/);var[i,,r,s,a,n,o]=t.map(Number);return{name:t[1],wins:s,losses:a,disconnects:o,rank:i,rankType:h.PlayerRankHelper.getRankType(r),...n?{prevRank:n}:void 0,points:r}})}}),s.MAX_LIST_SEARCH_COUNT=50}}}),System.register("network/WLadderTransportWebSocket",["network/IrcConnection"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("WLadderTransportWebSocket",r=class{constructor(e,t){this.con=e,this.serverUrl=t}static factory(e,t){return new this(new i.IrcConnection({mode:"binary"},t),e)}async sendCommand(t){try{await this.con.connect(this.serverUrl);let e=await this.con.sendCommand(t,{replyRawText:!0});return e.map(e=>e.raw.trim()).filter(e=>0<e.length)}finally{this.con.close()}}})}}}),System.register("network/WLadderService",["network/wladderConfig","network/WLadderConnection","network/HttpRequest","network/WLadderTransportWebSocket"],function(e,t){"use strict";var i,r,l,s,c;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){l=e},function(e){s=e}],execute:function(){e("WLadderService",c=class c{constructor(e,t){this.wolConfig=e,this.logger=t}setUrl(e){this.url=e}getUrl(){return this.url}async getSeasons(e="1v1",t){if(!this.url)throw new Error("No ladder URL is set");var i=this.url.match(/^wss?:\/\//i),r=this.wolConfig.getClientSku();return i?[c.CURRENT_SEASON]:await(new l.HttpRequest).fetchJson(this.url+`/${r}/`+e,t)}async listSearch(e,t,i="1v1",r=c.CURRENT_SEASON){if(!this.url)throw new Error("No ladder URL is set");var s=this.url.match(/^wss?:\/\//i),a=this.wolConfig.getClientSku();if(!s)return await(new l.HttpRequest).fetchJson(this.url+`/${a}/${i}/${r}/listsearch`,t,{method:"POST",body:JSON.stringify({players:e})});if(r!==c.CURRENT_SEASON)throw new Error("Legacy wladder doesn't support season parameter");if("1v1"!==i)throw new Error("Legacy wladder only supports 1v1");let n=this.createWebSocketConnection(this.url);return await n.listSearch(a,e)}async rungSearch(e,t,i,r="1v1",s=c.CURRENT_SEASON){if(!this.url)throw new Error("No ladder URL is set");var a=this.url.match(/^wss?:\/\//i),n=this.wolConfig.getClientSku();if(!a)return await(new l.HttpRequest).fetchJson(this.url+`/${n}/${r}/${s}/rungsearch`,i,{method:"POST",body:JSON.stringify({start:e,count:t})});if(s!==c.CURRENT_SEASON)throw new Error("Legacy wladder doesn't support season parameter");if("1v1"!==r)throw new Error("Legacy wladder only supports 1v1");let o=this.createWebSocketConnection(this.url);return await o.rungSearch(n,e,t)}createWebSocketConnection(e){return new r.WLadderConnection(s.WLadderTransportWebSocket.factory(e,this.logger))}}),c.CURRENT_SEASON=i.CURRENT_SEASON,c.PREV_SEASON=i.PREV_SEASON}}}),System.register("network/WolConnectOptions",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/chat/Message",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/WolService",["util/event","engine/ResourceLoader","data/IniFile","network/WolError"],function(e,t){"use strict";var r,s,a,i,n;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e},function(e){i=e}],execute:function(){e("WolService",n=class n{constructor(e,t,i){this.wolConfig=e,this.wolCon=t,this.clientVersion=i,this.ignoreLastWolClose=!1,this._onWolConnectionLost=new r.EventDispatcher,this.autoReconnect=!1,this.pendingReconnect=!1,this.onWolClose=e=>{this.connectOpts&&!this.ignoreLastWolClose&&(this.autoReconnect&&(this.reconnectTimeout=setTimeout(()=>this.tryReconnect(n.MIN_RECONNECT_MILLIS),0)),this._onWolConnectionLost.dispatch(this,e)),this.ignoreLastWolClose=!1}}get onWolConnectionLost(){return this._onWolConnectionLost.asEvent()}init(){this.wolCon.onClose.subscribe(this.onWolClose)}getConfig(){return this.wolConfig}getConnection(){return this.wolCon}isConnected(){return this.wolCon.isOpen()}shouldKeepAliveInGame(){return this.connectOpts?.keepAliveInGame}getCredentials(){return this.connectOpts?{user:this.connectOpts.user,pass:this.connectOpts.pass}:void 0}async connectAndLogin(e){var{url:t,wolv2Ascii:i,user:r,pass:s}=e;this.cancelReconnect(),this.wolCon.isOpen()&&JSON.stringify(this.connectOpts)!==JSON.stringify(e)&&this.closeWolConnection(),this.connectOpts=e,this.ignoreLastWolClose=!0;try{await this.wolCon.connect(t,this.wolConfig.getWolV2Compat(),i),this.wolCon.cvers(this.wolConfig.getClientSku());let e=await this.wolCon.login(r,s);return e.map(e=>({text:e}))}finally{this.ignoreLastWolClose=!1}}async loadServerList(e,t){let i=new s.ResourceLoader("");var r=await i.loadText(e,t);return(new a.IniFile).fromString(r)}async validateGameVersion(e){if(e.gameVersion&&!this.matchVersions(this.clientVersion,e.gameVersion))throw new i.WolError(`Game version mismatch: client version is ${this.clientVersion}, but expected `+e.gameVersion,i.WolError.Code.OutdatedClient)}matchVersions(e,t){let[i,r,s]=e.split(".");var[a,n,o]=t.split(".");return i===a&&r===n&&Number(s.split("-")[0])>=Number(o)}async tryReconnect(t){if(this.connectOpts)try{this.pendingReconnect=!0,await this.connectAndLogin(this.connectOpts),await this.wolCon.rejoinLastChannel()}catch(e){if(e instanceof i.WolError)console.error("Failed to reconnect to WoL service",e);else{let e=Math.min(n.MAX_RECONNECT_MILLIS,2*t);this.reconnectTimeout=setTimeout(()=>this.tryReconnect(e),t)}}finally{this.pendingReconnect=!1}}setAutoReconnect(e){e!==this.autoReconnect&&((this.autoReconnect=e)||this.cancelReconnect())}async forceReconnect(){var e;this.cancelReconnect(),this.wolCon.isOpen()&&(e=this.connectOpts,this.closeWolConnection(),e&&await this.connectAndLogin(e))}closeWolConnection(){this.cancelReconnect(),this.wolCon.isOpen()&&(this.connectOpts=void 0,this.ignoreLastWolClose=!0,this.wolCon.leaveAllChannels(),this.wolCon.close())}dispose(){this.cancelReconnect(),this.wolCon.onClose.unsubscribe(this.onWolClose)}cancelReconnect(){this.pendingReconnect&&this.wolCon.close(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}}),n.MIN_RECONNECT_MILLIS=5e3,n.MAX_RECONNECT_MILLIS=6e4}}}),System.register("gui/screen/mainMenu/lobby/LobbyScreen",["@puzzl/core/lib/async/Task","network/WolConnection","network/WolError","network/gameopt/SlotInfo","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/lobby/component/PasswordBox","gui/screen/mainMenu/lobby/component/CreateGameBox","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","engine/sound/SoundKey","engine/sound/ChannelType","LocalPrefs","gui/screen/mainMenu/lobby/PreferredHostOpts","util/typeGuard","game/gameopts/GameOptSanitizer","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","network/gservConfig","gui/screen/mainMenu/MainMenuRoute","@puzzl/core/lib/async/sleep","network/chat/ChatMessage","gui/chat/ChatHistory"],function(e,t){"use strict";var v,b,l,S,g,i,o,r,a,w,C,n,c,h,E,s,d,x,O,p,m,A,u,f,y,T,M,R,P,I,k,B;t&&t.id;return{setters:[function(e){v=e},function(e){b=e},function(e){l=e},function(e){S=e},function(e){g=e},function(e){i=e},function(e){o=e},function(e){r=e},function(e){a=e},function(e){w=e},function(e){C=e},function(e){n=e},function(e){c=e},function(e){h=e},function(e){E=e},function(e){s=e},function(e){d=e},function(e){x=e},function(e){O=e},function(e){p=e},function(e){m=e},function(e){A=e},function(e){u=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e}],execute:function(){0,B=class extends f.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T){super(),this.engineModHash=e,this.activeModMeta=t,this.rootController=i,this.errorHandler=r,this.messageBoxApi=s,this.strings=a,this.uiScene=n,this.wolCon=o,this.wolService=l,this.wladderService=c,this.rules=h,this.gameOptParser=u,this.gameOptSerializer=d,this.jsxRenderer=g,this.mapFileLoader=p,this.mapList=m,this.gameModes=f,this.sound=y,this.localPrefs=T,this.messages=[],this.playerReadyStatus=new Map,this.playerHasMapStatus=new Map,this.playerProfiles=new Map,this.disposables=new C.CompositeDisposable,this.updatePings=()=>{if(this.wolCon.isOpen()){if(this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName))if(this.wolv2Compat)this.requestedInternalPing=!0,this.wolCon.privmsg([this.gameChannelName],"/ping");else{this.pingsUpdateTask?.cancel();let e=this.pingsUpdateTask=new v.Task(async e=>{var t=await this.wolCon.listUsers(this.gameChannelName);if(!e.isCancelled()){for(var i of t)this.updatePlayerPing(i.name,i.ping);this.sendPingData()}});e.start().catch(e=>{e instanceof E.OperationCanceledError||console.error(e)})}}else this.onWolClose()},this.updateRanks=()=>{if(this.wladderService.getUrl()&&this.slotsInfo){this.ranksUpdateTask?.cancel();let e=this.ranksUpdateTask=new v.Task(async e=>{await P.sleep(5e3,e);var t=this.slotsInfo.map(e=>e.type===S.SlotType.Player?e.name:void 0).filter(A.isNotNullOrUndefined),t=await this.wladderService.listSearch(t,e);if(!e.isCancelled()){for(var i of t)this.playerProfiles.set(i.name,i);this.updateFormModel()}});e.start().catch(e=>{e instanceof E.OperationCanceledError||console.error(e)})}},this.onChannelLeave=e=>{e.channel===this.gameChannelName&&(this.hostMode?e.user.name!==this.wolCon.getCurrentUser()&&this.handlePlayerJoinLeave(e):e.user.name!==this.hostPlayerName&&e.user.name!==this.wolCon.getCurrentUser()||(e.user.name===this.hostPlayerName&&this.wolCon.isOpen()&&this.wolCon.leaveChannel(e.channel),this.controller?.goToScreen(w.ScreenType.CustomGame,{})))},this.onChannelJoin=e=>{e.user.name!==this.wolCon.getCurrentUser()&&(this.sound.play("join"===e.type?x.SoundKey.PlayerJoined:x.SoundKey.PlayerLeft,O.ChannelType.Ui),this.hostMode?this.handlePlayerJoinLeave(e):this.wolCon.sendPlayerReady(!1),this.wolv2Compat||"join"===e.type&&(this.updatePlayerPing(e.user.name,e.user.ping),this.hostMode&&this.sendPingData()),this.playerProfiles.has(e.user.name)||this.updateRanks())},this.onChannelMessage=e=>{if(this.lobbyForm){if(this.wolv2Compat&&this.requestedInternalPing){if(e.to.type===I.ChatRecipientType.Page&&e.from===this.wolCon.getServerName()&&e.text.match(/^[^ ]+ [^:]+:\s+\d+/))return void this.handlePlayerPing(e.text);if("/ping"===e.text)return}e.to.type!==I.ChatRecipientType.Page&&e.to.type!==I.ChatRecipientType.Whisper||this.sound.play(x.SoundKey.IncomingMessage,O.ChannelType.Ui),this.messages.push(e),this.lobbyForm.refresh()}e.to.type===I.ChatRecipientType.Whisper&&e.to.name!==this.wolCon.getServerName()&&e.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=e.from)},this.handleGameStart=e=>{var t,i=this.wolCon.getCurrentUser(),r=new R.MainMenuRoute(w.ScreenType.Login,{afterLogin:e=>new R.MainMenuRoute(w.ScreenType.CustomGame,{messages:e})});this.hostMode?(t=[...this.playerHasMapStatus.values()].includes(b.WolHasMapStatus.MapTransfer),this.rootController.createGame(e.gameId,e.timestamp,i,this.gameOpts,!1,this.isTournament,t,r)):(t=this.playerHasMapStatus.get(i)===b.WolHasMapStatus.MapTransfer,this.rootController.joinGame(e.gameId,e.timestamp,i,this.isTournament,t,r))},this.handleGameOpt=e=>{let t=e.opt,i=t[0];if(this.hostMode){if(e.user!==this.hostPlayerName)if("A"===i)this.handleGameOptReady(e.user,t[1]);else if("R"===i)this.handlePlayerOptsChange(e.user,t);else{if("K"!==i)throw new Error("Unknown GAMEOPT string "+t);this.handleGameOptHasMap(e.user,t[1])}}else if("L"===i)this.handleGameOptSlots(t),this.slotsInfo.some(e=>e.type===S.SlotType.Player&&!this.playerProfiles.has(e.name))&&this.updateRanks();else if("P"===i)this.handleGameOptPing(t.slice(1));else if("O"===i)this.handleGameOptObserver(t[1]);else if("A"===i)this.handleGameOptReady(e.user,t[1]);else if("K"===i)this.handleGameOptHasMap(e.user,t[1]);else{if("R"===i)return;if("G"===i)return void(this.playerReadyStatus.get(this.wolCon.getCurrentUser())||this.addSystemMessage(this.strings.get("GUI:HostGameStartJoiner")));if(!i.match(/^-|\d+/))throw new Error("Unknown GAMEOPT string "+t);this.handleGameOptOptions(t)}this.updateFormModel()},this.onWolClose=()=>{this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId)},this.onWolConLost=e=>{this.errorHandler.handle(e,this.strings.get("TXT_YOURE_DISCON"),()=>{this.controller?.goToScreen(w.ScreenType.Home)})},this.wolv2Compat=this.wolService.getConfig().getWolV2Compat()}async onEnter(e){var t,i;this.wolCon.getCurrentUser()?(this.gameChannelName=void 0,this.lobbyForm=void 0,this.chatHistory=new k.ChatHistory,this.initFormModel(),this.wolCon.onGameOpt.subscribe(this.handleGameOpt),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.wolCon.onLeaveChannel.subscribe(this.onChannelLeave),this.wolCon.onJoinChannel.subscribe(this.onChannelJoin),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.hostMode=e.create,this.hostMode?(this.title=this.strings.get("GUI:HostScreen"),this.createGame()):(this.title=this.strings.get("GUI:JoinScreen"),{game:t,observe:i}=e,this.joinGame(t,i))):this.messageBoxApi.show(this.strings.get("TXT_YOURE_DISCON"),this.strings.get("GUI:Ok"),()=>{this.controller?.goToScreen(w.ScreenType.Home)})}async joinGame(t,i,e){if(e||!t.passLocked){var r,s,a,n=t.name;try{this.hostPlayerName=await this.wolCon.joinGame(n,e),this.gameChannelName=n,this.isTournament=t.tournament,this.formModel.channels=[this.gameChannelName],i?this.sendPlayerInfo(g.OBS_COUNTRY_ID,g.RANDOM_COLOR_ID,g.RANDOM_START_POS,g.NO_TEAM_ID):(r=this.localPrefs.getItem(p.StorageKey.LastPlayerCountry),s=this.localPrefs.getItem(p.StorageKey.LastPlayerColor),a=void 0!==r&&Number(r)<this.getAvailablePlayerCountries().length?Number(r):g.RANDOM_COUNTRY_ID,o=void 0!==s&&Number(s)<this.getAvailablePlayerColors().length&&this.getSelectablePlayerColors().includes(this.getColorNameById(Number(s)))?Number(s):g.RANDOM_COLOR_ID,a===g.RANDOM_COUNTRY_ID&&o===g.RANDOM_COLOR_ID||this.sendPlayerInfo(a,o,g.RANDOM_START_POS,g.NO_TEAM_ID)),this.observerSlotIndex=8}catch(t){if(t instanceof l.WolError){let e=(new Map).set(l.WolError.Code.BadGamePass,"TXT_BADPASS").set(l.WolError.Code.GameHasClosed,"TXT_GAME_CLOSED").set(l.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(l.WolError.Code.BannedFromChannel,"TXT_JOINBAN");var o=e.get(t.code);if(o)return void this.messageBoxApi.show(this.strings.get(o),this.strings.get("GUI:Ok"),()=>{this.controller?.goToScreen(w.ScreenType.CustomGame,{})})}return void this.handleError(t,this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showPasswordBox(e=>{this.joinGame(t,i,e)},()=>{this.controller?.goToScreen(w.ScreenType.CustomGame,{})})}async createGame(e){if(e){try{var{roomDesc:t,tournament:i,observe:r,pass:s}=e;this.gameChannelName=await this.wolCon.createGame(1,9,this.wolService.getConfig().getClientChannelType(),i,s),this.hostPlayerName=this.wolCon.getCurrentUser(),this.hostRoomDesc=t,this.isTournament=i,this.observerSlotIndex=r?0:8,this.formModel.lobbyType=o.LobbyType.MultiplayerHost,this.formModel.activeSlotIndex=r?-1:0,this.formModel.channels=[this.gameChannelName],await this.initHostOptions(r),this.updateMapPreview(this.currentMapFile),this.updateFormModel(),this.updatePings(),this.updateRanks(),this.sendGameOpts(),this.sendModeMaxSlots(),this.hostOptsIntervalId=setInterval(()=>{this.wolCon.isOpen()&&(this.sendGameOpts(),this.updatePings())},5e3)}catch(e){return void this.handleError(e,e instanceof h.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showCreateGameBox((e,t,i)=>{this.createGame({roomDesc:e,observe:i,pass:t,tournament:!1})},()=>{this.controller?.goToScreen(w.ScreenType.CustomGame,{})})}onViewportChange(){this.createGameBox&&this.createGameBox.applyOptions(e=>e.viewport=this.uiScene.viewport),this.passBox&&this.passBox.applyOptions(e=>e.viewport=this.uiScene.viewport)}onUnstack(n){if(this.wolCon.isOpen()){if(n){let t=n.gameMode.id!==this.gameOpts.gameMode;var o=n.mapName!==this.gameOpts.mapName;this.gameOpts.gameMode=n.gameMode.id;let i=this.mapList.getByName(n.mapName),r=n.changedMapFile??this.currentMapFile;this.currentMapFile=r;var l=d.findIndexReverse(this.slotsInfo,(e,t)=>e.type===S.SlotType.Ai||e.type===S.SlotType.Player&&(this.observerSlotIndex!==t||0===t)||e.type===S.SlotType.Open),c=Math.min(9,i.maxSlots+(0===this.observerSlotIndex?1:0)),h=Math.max(0,l+1-c);for(let a=0;a<h;a++){let e=this.slotsInfo[l-a];e.type===S.SlotType.Player?this.kickPlayer(e.name,"Bye"):e.type===S.SlotType.Ai&&(this.gameOpts.aiPlayers[l-a]=void 0),e.type=S.SlotType.Closed}for(let e=l+1;e<c;e++)this.slotsInfo[e].type=this.preferredHostOpts.slotsClosed.has(e)?S.SlotType.Closed:this.observerSlotIndex===e?S.SlotType.OpenObserver:S.SlotType.Open;let s=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;if([...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach(e=>{e&&(e.startPos>i.maxSlots-1&&(e.startPos=g.RANDOM_START_POS),t&&(e.teamId=s.alliesAllowed&&s.mustAlly?0:g.NO_TEAM_ID))}),o){for(var u of this.playerReadyStatus.keys())this.playerReadyStatus.set(u,!1);this.playerHasMapStatus.clear()}this.sendGameSlotInfo(),this.sendModeMaxSlots(),this.applyGameOption(e=>{e.mapName=i.fileName,e.mapDigest=T.MapDigest.compute(r),e.mapSizeBytes=r.getSize(),e.mapTitle=i.getFullMapTitle(this.strings),e.maxSlots=i.maxSlots,e.mapOfficial=i.official}),this.localPrefs.setItem(p.StorageKey.LastMap,i.fileName),this.localPrefs.setItem(p.StorageKey.LastMode,String(n.gameMode.id))}this.updateMapPreview(this.currentMapFile),this.initView()}else this.onWolClose()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons()}async initHostOptions(e){var t=this.localPrefs.getItem(p.StorageKey.PreferredGameOpts),i=this.localPrefs.getItem(p.StorageKey.LastPlayerCountry),r=this.localPrefs.getItem(p.StorageKey.LastPlayerColor),s=this.localPrefs.getItem(p.StorageKey.LastMap),a=this.localPrefs.getItem(p.StorageKey.LastMode);let n=s?this.mapList.getByName(s):void 0,o=n&&a&&this.gameModes.hasId(Number(a))?Number(a):1,l=this.gameModes.getById(o),c;c=n?.gameModes.find(e=>e.mapFilter===l.mapFilter)?n:(o=1,l=this.gameModes.getById(o),this.mapList.getAll().find(e=>e.gameModes.find(e=>l.mapFilter===e.mapFilter)));let h=this.currentMapFile=await this.mapFileLoader.load(c.fileName),u=this.preferredHostOpts=new m.PreferredHostOpts;t?u.unserialize(t):u.applyMpDialogSettings(this.rules.mpDialogSettings);t=this.gameModes.getById(o).mpDialogSettings;this.gameOpts={gameMode:o,shortGame:u.shortGame,mcvRepacks:u.mcvRepacks,cratesAppear:u.cratesAppear,superWeapons:u.superWeapons,gameSpeed:u.gameSpeed,credits:u.credits,unitCount:u.unitCount,buildOffAlly:u.buildOffAlly,hostTeams:u.hostTeams,humanPlayers:[{name:this.hostPlayerName,countryId:e?g.OBS_COUNTRY_ID:void 0!==i&&Number(i)<this.getAvailablePlayerCountries().length?Number(i):g.RANDOM_COUNTRY_ID,colorId:!e&&void 0!==r&&Number(r)<this.getAvailablePlayerColors().length?Number(r):g.RANDOM_COLOR_ID,startPos:g.RANDOM_START_POS,teamId:t.mustAlly?0:g.NO_TEAM_ID}],aiPlayers:new Array(8).fill(void 0),mapName:c.fileName,mapDigest:T.MapDigest.compute(h),mapSizeBytes:h.getSize(),mapTitle:c.getFullMapTitle(this.strings),maxSlots:c.maxSlots,mapOfficial:c.official},this.slotsInfo=[{type:S.SlotType.Player,name:this.hostPlayerName}];for(let d=1;d<9;++d)this.slotsInfo.push({type:u.slotsClosed.has(d)?S.SlotType.Closed:this.observerSlotIndex===d?S.SlotType.OpenObserver:d<c.maxSlots+(e?1:0)?S.SlotType.Open:S.SlotType.Closed});this.playerPings=[],this.playerProfiles.clear(),this.requestedInternalPing=!1}handleError(e,t){this.errorHandler.handle(e,t,()=>{this.controller?.goToScreen(w.ScreenType.CustomGame,{})}),this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId)}showPasswordBox(t,e){let[i]=this.jsxRenderer.render(n.jsx(c.HtmlView,{innerRef:e=>this.passBox=e,component:r.PasswordBox,props:{strings:this.strings,onSubmit:e=>{t(e),i.destroy()},onDismiss:()=>{e(),i.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(i),this.disposables.add(i,()=>this.uiScene.remove(i),()=>this.passBox=void 0)}showCreateGameBox(r,e){let[s]=this.jsxRenderer.render(n.jsx(c.HtmlView,{component:a.CreateGameBox,innerRef:e=>this.createGameBox=e,props:{strings:this.strings,onSubmit:(e,t,i)=>{s.destroy(),r(e,t,i)},onDismiss:()=>{s.destroy(),e()},viewport:this.uiScene.viewport}}));this.uiScene.add(s),this.disposables.add(s,()=>this.uiScene.remove(s),()=>this.createGameBox=void 0)}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(e=>e.name)}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(e=>e.asHexString())}getAvailableStartPositions(){return new Array(this.gameOpts?.maxSlots??8).fill(0).map((e,t)=>t)}getSelectablePlayerColors(){let t=[];this.formModel&&this.formModel.playerSlots.forEach(e=>{e&&t.push(e.color)});let e=this.getAvailablePlayerColors();return[g.RANDOM_COLOR_NAME].concat(e.filter(e=>e&&-1===t.indexOf(e)))}getSelectableStartPositions(){let t=[];this.formModel&&this.formModel.playerSlots.forEach(e=>{e&&t.push(e.startPos)});let e=this.getAvailableStartPositions();return[g.RANDOM_START_POS].concat(e.filter(e=>!t.includes(e)))}initFormModel(){var e=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[g.RANDOM_COUNTRY_NAME,g.RANDOM_COUNTRY_UI_NAME],[g.OBS_COUNTRY_NAME,g.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(e=>[e.name,e.uiName]))),countryUiTooltips:new Map([[g.RANDOM_COUNTRY_NAME,g.RANDOM_COUNTRY_UI_TOOLTIP],[g.OBS_COUNTRY_NAME,g.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(e=>e.uiTooltip).map(e=>[e.name,e.uiTooltip]))),availablePlayerCountries:[g.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:this.getSelectablePlayerColors(),availableAiNames:new Map,availableStartPositions:this.getSelectableStartPositions(),lobbyType:o.LobbyType.MultiplayerGuest,messages:this.messages,chatHistory:this.chatHistory,channels:[],localUsername:this.wolCon.getCurrentUser(),mpDialogSettings:e,onSendMessage:e=>{e.value.length?(this.wolv2Compat&&"/ping"===e.value&&(this.requestedInternalPing=!1),this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(e.value,e.recipient),e.recipient.type===I.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=e.recipient.name))):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onCountrySelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(e),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel())},onColorSelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(e),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel())},onStartPosSelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),e,this.formModel.playerSlots[t].team,t),this.updateFormModel())},onTeamSelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,e,t),this.updateFormModel())},onSlotChange:(e,t,i)=>{this.wolCon.isOpen()&&this.changeSlotType(e,t,i)},onToggleShortGame:t=>this.applyGameOption(e=>e.shortGame=t),onToggleMcvRepacks:t=>this.applyGameOption(e=>e.mcvRepacks=t),onToggleCratesAppear:t=>this.applyGameOption(e=>e.cratesAppear=t),onToggleSuperWeapons:t=>this.applyGameOption(e=>e.superWeapons=t),onToggleBuildOffAlly:t=>this.applyGameOption(e=>e.buildOffAlly=t),onToggleHostTeams:t=>this.applyGameOption(e=>e.hostTeams=t),onChangeGameSpeed:t=>this.applyGameOption(e=>e.gameSpeed=t),onChangeCredits:t=>this.applyGameOption(e=>e.credits=t),onChangeUnitCount:t=>this.applyGameOption(e=>e.unitCount=t),activeSlotIndex:-1,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,hostTeams:!1,gameSpeed:6,credits:e.money,unitCount:e.unitCount},this.playerReadyStatus.clear(),this.playerHasMapStatus.clear(),this.messages.length=0}applyGameOption(e){if(!this.hostMode)throw new Error("Can't change options when not a host");this.wolCon.isOpen()?(e(this.gameOpts),u.GameOptSanitizer.sanitize(this.gameOpts,this.rules),this.updateFormModel(),this.sendGameOpts(),this.localPrefs.setItem(p.StorageKey.PreferredGameOpts,this.preferredHostOpts.applyGameOpts(this.gameOpts).serialize())):this.onWolClose()}changeSlotType(e,t,i){if(!this.hostMode)throw new Error("Only host can change slot type");if(0===t)throw new Error("Change slot type of host");var r=this.formModel.playerSlots[t];let s=this.slotsInfo[t];r.occupation===e&&s.type===S.SlotType.Player||(r.occupation===o.SlotOccupation.Occupied&&(s.type===S.SlotType.Player?this.kickPlayer(s.name,"Bye"):this.gameOpts.aiPlayers[t]=void 0),r=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings,e===o.SlotOccupation.Closed?(s.type=S.SlotType.Closed,this.preferredHostOpts.slotsClosed.add(t)):e===o.SlotOccupation.Open?(s.type=t===this.observerSlotIndex?S.SlotType.OpenObserver:S.SlotType.Open,this.preferredHostOpts.slotsClosed.delete(t)):e===o.SlotOccupation.Occupied&&void 0!==i&&(s.type=S.SlotType.Ai,s.difficulty=i,this.gameOpts.aiPlayers[t]={difficulty:i,countryId:g.RANDOM_COUNTRY_ID,colorId:g.RANDOM_COLOR_ID,startPos:g.RANDOM_START_POS,teamId:r.mustAlly?0:g.NO_TEAM_ID},this.preferredHostOpts.slotsClosed.delete(t)),this.updateFormModel(),this.sendGameSlotInfo(),this.sendGameOpts(),this.sendModeMaxSlots(),this.localPrefs.setItem(p.StorageKey.PreferredGameOpts,this.preferredHostOpts.serialize()))}getCountryNameById(e){let t;return t=e===g.RANDOM_COUNTRY_ID?g.RANDOM_COUNTRY_NAME:e===g.OBS_COUNTRY_ID?g.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[e],t}getCountryIdByName(t){let i;if(t===g.RANDOM_COUNTRY_NAME)i=g.RANDOM_COUNTRY_ID;else if(t===g.OBS_COUNTRY_NAME)i=g.OBS_COUNTRY_ID;else{let e=this.getAvailablePlayerCountries();i=e.indexOf(t)}return i}getColorNameById(e){let t;return t=e===g.RANDOM_COLOR_ID?g.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[e],t}getColorIdByName(t){let i;if(t===g.RANDOM_COLOR_NAME)i=g.RANDOM_COLOR_ID;else{let e=this.getAvailablePlayerColors();if(i=e.indexOf(t),-1===i)throw new Error(`Color ${t} not found in available player colors`)}return i}sendPlayerInfo(t,i,r,s,a){if(!this.hostPlayerName)throw new Error("Host player name not yet set.");if(this.hostMode){if(void 0!==a&&a!==this.formModel.activeSlotIndex){const n=this.slotsInfo[a];if(n.type!==S.SlotType.Ai&&!this.gameOpts.hostTeams)throw new Error("Can't change country and color for a non-AI slot");let e=this.gameOpts.aiPlayers[a];if(!e){if(!this.gameOpts.hostTeams)throw new Error("No AI found in slot "+a);if(n.type!==S.SlotType.Player)return void console.warn(`Can't change player info for ${S.SlotType[n.type]} slot at `+a);e=this.gameOpts.humanPlayers.find(e=>e.name===n.name)}if(!e)throw new Error("No human player found in slot "+a);e.countryId=t,e.colorId=i,e.startPos=r,e.teamId=s}else this.updatePlayerInfo(this.hostPlayerName,t,i,r,s);this.updateFormModel(),this.sendGameOpts()}else this.wolCon.sendPlayerOpts(this.hostPlayerName,t,i,r,s);void 0!==a&&a!==this.formModel.activeSlotIndex||t!==g.OBS_COUNTRY_ID&&(t!==g.RANDOM_COUNTRY_ID?this.localPrefs.setItem(p.StorageKey.LastPlayerCountry,String(t)):this.localPrefs.removeItem(p.StorageKey.LastPlayerCountry),i!==g.RANDOM_COLOR_ID?this.localPrefs.setItem(p.StorageKey.LastPlayerColor,String(i)):this.localPrefs.removeItem(p.StorageKey.LastPlayerColor))}updatePlayerInfo(t,e,i,r,s,a=!1){if(!this.hostMode)throw new Error("Method should only be used in host mode");let n=this.gameOpts.humanPlayers.find(e=>e.name===t);n?(n.countryId=e,n.colorId=i,a||(n.startPos=r,n.teamId=s)):console.error("Can't set country/color for non-existent player "+t)}updateFormModel(){var e=this.gameOpts;if(e&&(this.formModel.gameSpeed=e.gameSpeed,this.formModel.credits=e.credits,this.formModel.unitCount=e.unitCount,this.formModel.shortGame=e.shortGame,this.formModel.superWeapons=e.superWeapons,this.formModel.buildOffAlly=e.buildOffAlly,this.formModel.hostTeams=e.hostTeams,this.formModel.mcvRepacks=e.mcvRepacks,this.formModel.cratesAppear=e.cratesAppear),this.gameOpts&&this.slotsInfo){let i=e.maxSlots;this.slotsInfo.forEach((e,t)=>{t!==this.observerSlotIndex?i?(i--,this.formModel.playerSlots[t]={country:g.RANDOM_COUNTRY_NAME,color:g.RANDOM_COLOR_NAME,startPos:g.RANDOM_START_POS,team:g.NO_TEAM_ID}):this.formModel.playerSlots[t]=void 0:this.formModel.playerSlots[t]={country:g.RANDOM_COUNTRY_NAME,color:g.RANDOM_COLOR_NAME,startPos:g.RANDOM_START_POS,team:g.NO_TEAM_ID}}),this.slotsInfo.forEach((t,i)=>{if(this.formModel.playerSlots[i]){let e=this.formModel.playerSlots[i];t.type===S.SlotType.Closed?e.occupation=o.SlotOccupation.Closed:t.type===S.SlotType.Open||t.type===S.SlotType.OpenObserver?e.occupation=o.SlotOccupation.Open:e.occupation=o.SlotOccupation.Occupied,t.type===S.SlotType.OpenObserver||i===this.observerSlotIndex?e.type=o.SlotType.Observer:t.type===S.SlotType.Ai?e.type=o.SlotType.Ai:e.type=o.SlotType.Player,t.type===S.SlotType.Ai?(e.aiDifficulty=t.difficulty,e.status=o.PlayerStatus.Ready):t.type===S.SlotType.Player&&(e.name=t.name,t.name===this.hostPlayerName?e.status=o.PlayerStatus.Host:e.status=this.playerReadyStatus.get(t.name)?o.PlayerStatus.Ready:o.PlayerStatus.NotReady)}})}let s=this.gameOpts?this.gameOpts.humanPlayers:[],a=this.gameOpts?this.gameOpts.aiPlayers:[],n=this.gameOpts?this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings:void 0;this.formModel.playerSlots.forEach((t,e)=>{var i,r;t&&s.length&&(t.occupation===o.SlotOccupation.Occupied?((i=s.find(e=>e.name===t.name))?(t.country=this.getCountryNameById(i.countryId),t.color=this.getColorNameById(i.colorId),t.startPos=i.startPos,t.team=i.teamId):(r=a[e])&&(t.country=this.getCountryNameById(r.countryId),t.color=this.getColorNameById(r.colorId),t.startPos=r.startPos,t.team=r.teamId),!this.playerPings||(r=this.playerPings.find(e=>!!t.name&&e.playerName.toLowerCase()===t.name.toLowerCase()))&&(t.ping=0<r.ping?r.ping:void 0),this.playerProfiles&&t.type===o.SlotType.Player&&(t.playerProfile=this.playerProfiles.get(t.name))):e===this.observerSlotIndex?t.country=g.OBS_COUNTRY_NAME:(t.country=g.RANDOM_COUNTRY_NAME,n&&(t.team=n.mustAlly?0:g.NO_TEAM_ID)))}),this.hostMode||(this.formModel.activeSlotIndex=this.slotsInfo?this.slotsInfo.findIndex(e=>e.type===S.SlotType.Player&&e.name===this.wolCon.getCurrentUser()):-1),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(),this.formModel.availableStartPositions=this.getSelectableStartPositions(),this.gameOpts&&(this.formModel.teamsAllowed=this.gameModes.getById(e.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(e.gameMode).mpDialogSettings.mustAlly),this.lobbyForm&&s.length&&this.lobbyForm.refresh()}addSystemMessage(e){this.lobbyForm&&(this.messages.push({text:e}),this.lobbyForm.refresh())}sendGameOpts(){if(!this.hostMode)throw new Error("Should only be used in host mode");var e,t,i;this.gameOpts&&this.wolCon.isOpen()&&(this.gameOpts.humanPlayers.forEach(e=>{-1===e.colorId&&(e.colorId=g.RANDOM_COLOR_ID)}),i=this.gameOptSerializer.serializeOptions(this.gameOpts),this.wolCon.sendGameOpts(i),e=this.slotsInfo.filter(e=>e.type===S.SlotType.Ai||e.type===S.SlotType.Player||e.type===S.SlotType.Open||e.type===S.SlotType.OpenObserver).length,t=this.slotsInfo.filter(e=>e.type===S.SlotType.Player).length,i=this.activeModMeta?this.activeModMeta.name+(void 0!==this.activeModMeta.version?` (${this.activeModMeta.version})`:""):void 0,this.wolCon.sendGameTopic(t,e,this.gameOpts.aiPlayers.filter(e=>!!e).length,Number(this.slotsInfo[this.observerSlotIndex].type===S.SlotType.Player),this.slotsInfo[this.observerSlotIndex].type===S.SlotType.OpenObserver,this.gameOpts.mapName,this.engineModHash,this.hostRoomDesc,i),this.sendPingData())}handlePlayerJoinLeave(i){if(!this.hostMode)throw new Error("Should only be used in host mode");if(this.slotsInfo){if("join"===i.type){let e=this.slotsInfo.findIndex(e=>e.type===S.SlotType.Open),t=!1;if(-1===e&&(e=this.slotsInfo.findIndex(e=>e.type===S.SlotType.OpenObserver),t=!0,-1===e))return void this.kickPlayer(i.user.name,"Bye");this.slotsInfo[e]={type:S.SlotType.Player,name:i.user.name};var r,s=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;this.gameOpts.humanPlayers.push({name:i.user.name,countryId:t?g.OBS_COUNTRY_ID:g.RANDOM_COUNTRY_ID,colorId:t?g.OBS_COLOR_ID:g.RANDOM_COLOR_ID,startPos:g.RANDOM_START_POS,teamId:s.mustAlly?0:g.NO_TEAM_ID}),this.playerReadyStatus.set(i.user.name,!1);for(r of this.playerReadyStatus.keys())this.playerReadyStatus.set(r,!1)}else this.removeHumanPlayer(i.user.name);this.sendGameSlotInfo(),this.sendObserverSlotInfo(),this.sendGameOpts()}}removeHumanPlayer(t){var i=this.slotsInfo.findIndex(e=>e.type===S.SlotType.Player&&e.name===t);if(-1!==i){let e=this.slotsInfo[i];i===this.observerSlotIndex?e.type=S.SlotType.OpenObserver:e.type=S.SlotType.Open}i=this.gameOpts.humanPlayers.findIndex(e=>e.name===t);-1!==i&&this.gameOpts.humanPlayers.splice(i,1),this.playerReadyStatus.delete(t),this.playerHasMapStatus.delete(t);i=this.playerPings.findIndex(e=>e.playerName===t);-1!==i&&this.playerPings.splice(i,1)}kickPlayer(e,t){this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(this.wolCon.kick([e],this.gameChannelName,t),this.removeHumanPlayer(e))}sendObserverSlotInfo(){this.wolCon.sendObserverSlot(this.observerSlotIndex)}sendGameSlotInfo(){var e=this.gameOptSerializer.serializeSlotData(this.slotsInfo);this.wolCon.sendGameSlotsInfo(e)}sendPingData(){var e;this.playerPings.length&&(e=this.gameOptSerializer.serializePingData(this.playerPings),this.wolCon.sendPingData(e))}sendModeMaxSlots(){if(!this.hostMode)throw new Error("Must be in host mode");if(!this.slotsInfo)throw new Error("Slots info should be set by now");var e=this.gameChannelName;if(!e||!this.wolCon.isInChannel(e))throw new Error("Must be in a game channel");var t=this.slotsInfo.filter(e=>e.type!==S.SlotType.Closed&&e.type!==S.SlotType.Ai).length;this.wolCon.sendModeChannelMax(e,t)}handlePlayerPing(e){var t,i=e.match(/^([A-Za-z0-9-_]+) [^:]+:\s+(\d+)/);i?([,t,i]=i,this.updatePlayerPing(t,Number(i)),this.sendPingData()):console.error("Unexpected ping response "+e)}updatePlayerPing(t,e){let i=this.playerPings.find(e=>e.playerName===t);i?i.ping=e:this.playerPings.push({ping:e,playerName:t})}handlePlayerOptsChange(t,e){var i=this.slotsInfo.findIndex(e=>e.type===S.SlotType.Player&&e.name===t);if(-1===i)throw new Error("Missing slot info for player "+t);let[r,s,a,n]=e.slice(1).split(",").map(Number);s=this.getSelectablePlayerColors().includes(this.getColorNameById(s))?s:this.gameOpts.humanPlayers.find(e=>e.name===t).colorId,a=this.getSelectableStartPositions().includes(a)?a:this.gameOpts.humanPlayers.find(e=>e.name===t).startPos;var o=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;n=!o.alliesAllowed||n===g.NO_TEAM_ID&&o.mustAlly?o.mustAlly?0:g.NO_TEAM_ID:n,r===g.OBS_COUNTRY_ID||i!==this.observerSlotIndex?(this.updatePlayerInfo(t,r,s,a,n,this.gameOpts.hostTeams),this.sendGameOpts(),r===g.OBS_COUNTRY_ID&&((o=this.slotsInfo[this.observerSlotIndex]).type!==S.SlotType.OpenObserver?o.type===S.SlotType.Player&&o.name===t||(console.warn(`Player ${t} tried to move to an unavailable observer slot`),this.kickPlayer(t,"Bye")):(this.slotsInfo[this.observerSlotIndex]=this.slotsInfo[i],this.slotsInfo[i]={type:S.SlotType.Open},this.sendGameSlotInfo()))):this.kickPlayer(t,"Bye")}handleGameOptReady(t,e){if(this.slotsInfo&&-1===this.slotsInfo.findIndex(e=>e.type===S.SlotType.Player&&e.name===t))throw new Error("Missing slot info for player "+t);this.playerReadyStatus.set(t,Boolean(Number(e))),this.hostMode||t!==this.wolCon.getCurrentUser()||this.refreshSidebarButtons(),this.hostMode&&![...this.playerReadyStatus.values()].filter(e=>!1===e).length&&this.sound.play(x.SoundKey.OptionsChanged,O.ChannelType.Ui)}handleGameOptHasMap(t,e){if(this.slotsInfo&&-1===this.slotsInfo.findIndex(e=>e.type===S.SlotType.Player&&e.name===t))throw new Error("Missing slot info for player "+t);let i=Number(e);Object.values(b.WolHasMapStatus).includes(i)||(i=b.WolHasMapStatus.NoMap),this.playerHasMapStatus.set(t,i),this.hostMode||t!==this.wolCon.getCurrentUser()?i!==b.WolHasMapStatus.HasMap&&this.gameOpts&&this.messages.push({text:i===b.WolHasMapStatus.MapTransfer?this.strings.get("GUI:HostMapTransfer",t,`"${this.gameOpts.mapTitle}"`):this.strings.get("GUI:HostNoMap",t,`"${this.gameOpts.mapTitle}"`)}):this.refreshSidebarButtons()}handleGameOptObserver(e){this.observerSlotIndex=Number(e)}handleGameOptSlots(e){this.slotsInfo=this.gameOptParser.parseSlotData(e)}handleGameOptPing(e){this.playerPings=this.gameOptParser.parsePingData(e)}handleGameOptOptions(e){var t,i;this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(i=(t=this.gameOptParser.parseOptions(e)).mapName!==this.gameOpts?.mapName||t.mapDigest!==this.gameOpts?.mapDigest,u.GameOptSanitizer.sanitize(t,this.rules),this.gameOpts=t,this.refreshSidebarMpText(),i&&this.wolCon.isOpen()&&(i=this.wolCon.getCurrentUser(),this.playerReadyStatus.set(i,!1),this.playerHasMapStatus.set(i,b.WolHasMapStatus.NoMap),this.refreshSidebarButtons(),this.wolCon.sendPlayerReady(!1),this.guestUpdateMapDeferred(t)))}guestUpdateMapDeferred(s){this.mapLoadTask?.cancel(),this.mapLoadTask=new v.Task(async e=>{this.controller.setSidebarPreview(),this.currentMapFile=void 0;var t,i,r=this.currentMapFile=await this.loadAndCheckMap(s);!e.isCancelled()&&this.wolCon.isOpen()&&(t=!r&&!s.mapOfficial&&s.mapSizeBytes<=M.MAX_MAP_TRANSFER_BYTES,i=r?b.WolHasMapStatus.HasMap:t?b.WolHasMapStatus.MapTransfer:b.WolHasMapStatus.NoMap,this.wolCon.sendPlayerHasMap(i),r?this.updateMapPreview(r):this.addSystemMessage(t?this.strings.get("GUI:JoinerMapTransfer",`"${s.mapTitle}"`):this.strings.get("GUI:JoinerNoMap",`"${s.mapTitle}"`)))}),this.mapLoadTask.start().catch(e=>{e instanceof E.OperationCanceledError||this.handleError(e,this.strings.get("TXT_DOWNLOAD_FAILED"))})}updateMapPreview(e){try{var t=new s.MapPreviewRenderer(this.strings).render(new y.MapFile(e),this.hostMode?o.LobbyType.MultiplayerHost:o.LobbyType.MultiplayerGuest,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(t)}catch(e){console.error("Failed to render map preview"),console.error(e),this.controller.setSidebarPreview()}}async loadAndCheckMap(t){if(this.mapList.getByName(t.mapName)){let e=await this.mapFileLoader.load(t.mapName);return T.MapDigest.compute(e)===t.mapDigest&&e.getSize()===t.mapSizeBytes?e:void 0}}initLobbyForm(){var[e]=this.jsxRenderer.render(n.jsx(c.HtmlView,{innerRef:e=>this.lobbyForm=e,component:i.LobbyForm,props:this.formModel}));this.controller.setMainComponent(e)}refreshSidebarButtons(){let e=this.strings,t=this.playerReadyStatus.get(this.wolCon.getCurrentUser());var i=this.playerHasMapStatus.get(this.wolCon.getCurrentUser())??b.WolHasMapStatus.NoMap,i=[this.hostMode?{label:e.get("GUI:StartGame"),tooltip:e.get("STT:HostButtonGo"),disabled:!1,onClick:()=>{var e;this.wolCon.isOpen()&&(void 0!==(e=[...this.playerHasMapStatus].find(([,e])=>e===b.WolHasMapStatus.NoMap)?.[0])?this.addSystemMessage(this.strings.get("GUI:HostNoMap",e,`"${this.gameOpts.mapTitle}"`)):this.gameOpts.humanPlayers.filter(e=>e.countryId!==g.OBS_COUNTRY_ID).length<2?this.addSystemMessage(this.strings.get("TXT_ONLY_ONE")):this.meetsMinimumTeams()?[...this.playerReadyStatus.values()].filter(e=>!1===e).length?(this.addSystemMessage(this.strings.get("GUI:HostGameStartHost")),this.wolCon.sendGameStartRequest()):this.wolCon.startGame(this.gameOpts.humanPlayers.map(e=>e.name)):this.addSystemMessage(this.strings.get("TXT_CANNOT_ALLY")))}}:{label:t?e.get("GUI:NotReady"):e.get("GUI:Accept"),tooltip:t?e.get("STT:NotReady"):e.get("STT:GuestButtonAccept"),disabled:i===b.WolHasMapStatus.NoMap,onClick:()=>{this.wolCon.isOpen()&&(this.playerReadyStatus.set(this.wolCon.getCurrentUser(),!t),this.wolCon.sendPlayerReady(!t))}},...this.hostMode?[{label:e.get("GUI:ChooseMap"),tooltip:e.get("STT:HostButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(w.ScreenType.MapSelection,{lobbyType:this.hostMode?o.LobbyType.MultiplayerHost:o.LobbyType.MultiplayerGuest,gameOpts:this.gameOpts,usedSlots:()=>1+d.findIndexReverse(this.slotsInfo,(e,t)=>e.type===S.SlotType.Ai||e.type===S.SlotType.Player&&this.observerSlotIndex!==t)-(0===this.observerSlotIndex?1:0)})}}]:[],{label:e.get("GUI:Back"),tooltip:this.hostMode?e.get("STT:HostButtonBack"):e.get("STT:GuestButtonBack"),isBottom:!0,onClick:()=>{this.hostMode&&this.wolCon.isOpen()&&this.gameChannelName&&this.wolCon.leaveChannel(this.gameChannelName),this.controller?.goToScreen(w.ScreenType.CustomGame,{})}}];this.controller.setSidebarButtons(i,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let e=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(A.isNotNullOrUndefined).filter(e=>e.countryId!==g.OBS_COUNTRY_ID),t=e[0].teamId;return t===g.NO_TEAM_ID||e.some(e=>e.teamId!==t)}refreshSidebarMpText(){this.controller.setSidebarMpText(this.gameOpts?this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+this.gameOpts.mapTitle:"")}async onLeave(){this.disposables.dispose(),this.mapLoadTask?.cancel(),this.mapLoadTask=void 0,this.ranksUpdateTask?.cancel(),this.ranksUpdateTask=void 0,this.pingsUpdateTask?.cancel(),this.pingsUpdateTask=void 0,this.currentMapFile=void 0,this.gameChannelName=void 0,this.hostPlayerName=void 0,this.hostRoomDesc="",this.gameOpts=void 0,this.preferredHostOpts=void 0,this.playerPings=this.slotsInfo=void 0,this.playerProfiles.clear(),this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.wolCon.onGameOpt.unsubscribe(this.handleGameOpt),this.wolCon.onGameStart.unsubscribe(this.handleGameStart),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelLeave),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoin),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},e("LobbyScreen",B)}}}),System.register("gui/screen/mainMenu/customGame/CustomGameScreen",["gui/screen/mainMenu/customGame/component/GameBrowser","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/Music","network/IrcConnection","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError","network/WLadderConnection","gui/screen/mainMenu/MainMenuRoute","network/chat/ChatMessage","gui/chat/ChatHistory"],function(e,t){"use strict";var i,r,h,s,a,u,d,g,n,o,l,c,p,m,f,y,T;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){h=e},function(e){s=e},function(e){a=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){T=class extends o.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c){super(),this.engineModHash=e,this.strings=t,this.wolCon=i,this.wolService=r,this.wladderService=s,this.jsxRenderer=a,this.sound=n,this.serverRegions=o,this.mapList=l,this.errorHandler=c,this.title=this.strings.get("GUI:CustomMatch"),this.musicType=g.MusicType.NormalShuffle,this.pings=new Map,this.playerProfiles=new Map,this.ignoreCmdReplies=!1,this.needsOperatorsRefresh=!1,this.operatorStatuses=new Map,this.disposables=new h.CompositeDisposable,this.onChannelJoinLeave=t=>{let e=t.channel,i=e.match(/#Lob \d+ (\d)/i);if(i&&([,r]=i.map(Number),e=this.strings.get("TXT_LOB_"+(r+1))),t.user.name===this.wolCon.getCurrentUser())this.addSystemMessage(this.strings.get("join"===t.type?"TXT_JOINED_S":"TXT_YOULEFT",e));else if(t.channel===this.channelName){if("join"===t.type){let e;this.wolV2Compat?(e=!1,this.operatorStatuses.has(t.user.name)?e=this.operatorStatuses.get(t.user.name):this.needsOperatorsRefresh=!0):e=t.user.operator,this.users.push({name:t.user.name,operator:e}),this.users.sort((e,t)=>Number(t.operator)-Number(e.operator))}else{var r=this.users.findIndex(e=>e.name===t.user.name);-1!==r&&(this.users.splice(r,1),this.pings.delete(t.user.name))}this.gameBrowser?.refresh()}},this.onChannelMessage=t=>{if(this.wolV2Compat){if(this.ignoreCmdReplies&&"/con"===t.text)return;if(this.ignoreCmdReplies&&t.to.type===f.ChatRecipientType.Page&&t.from===this.wolCon.getServerName()&&t.text.match(/^[^:]+:$|^\s*-\w+\s+-\w+\s+-----|^\s*wol|^\s*UNKNOW/))return void this.handleUserPingUpdate(t.text)}t.to.type!==f.ChatRecipientType.Page&&t.to.type!==f.ChatRecipientType.Whisper||this.sound.play(u.SoundKey.IncomingMessage,d.ChannelType.Ui);var e={...t,operator:this.users.find(e=>e.name===t.from)?.operator};this.messages.push(e),this.gameBrowser?.refresh(),t.to.type===f.ChatRecipientType.Whisper&&t.to.name!==this.wolCon.getServerName()&&t.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=t.from)},this.onWolClose=()=>{clearInterval(this.refreshTimeoutId)},this.onWolConLost=e=>{this.handleError(e,this.strings.get("TXT_YOURE_DISCON"))},this.wolV2Compat=this.wolService.getConfig().getWolV2Compat()}addSystemMessage(e){this.messages.push({text:e}),this.gameBrowser?.refresh()}handleUserPingUpdate(e){var t,i=e.match(/^\s+wol\s+\w+\s+"?([^\s"]+)"?\s+(\d+)/);i&&(t=i[1],i=Number(i[2]),this.pings.set(t,i),this.gameBrowser?.applyOptions(e=>e.pings=this.pings))}async refreshGames(){if(this.wolCon.isOpen()){if(this.channelName&&this.wolCon.isInChannel(this.channelName)&&this.wolCon.getCurrentUser()){this.wolV2Compat&&(this.ignoreCmdReplies=!0,this.wolCon.privmsg([this.channelName],"/con"));let t;try{var e=this.wolService.getConfig().getClientChannelType();t=await this.wolCon.listGames(e,e)}catch(e){if(e instanceof n.IrcConnection.SocketError)return;if(e instanceof n.IrcConnection.NoReplyError)return;throw e}t.sort((e,t)=>Number(e.passLocked)-Number(t.passLocked)),this.games=t;const i=this.selectedGame;i&&this.onGameSelectionChange(t.find(e=>e.name===i.name)),this.gameBrowser?.applyOptions(e=>e.games=t),this.refreshPlayerRanks(),this.refreshOperatorStatuses()}}else this.onWolClose()}refreshPlayerRanks(){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let e=this.ranksUpdateTask=new l.Task(async e=>{let t=[...new Set([...this.users.map(e=>e.name),...this.games.map(e=>e.hostName)])].filter(e=>!this.playerProfiles.has(e));if(t.length){for(;0<t.length;){var i,r=t.splice(0,p.WLadderConnection.MAX_LIST_SEARCH_COUNT),r=await this.wladderService.listSearch(r,e);if(e.isCancelled())return;for(i of r)this.playerProfiles.set(i.name,i)}this.gameBrowser?.refresh()}});e.start().catch(e=>{e instanceof c.OperationCanceledError||console.error(e)})}}refreshOperatorStatuses(){this.needsOperatorsRefresh&&(this.needsOperatorsRefresh=!1,this.operatorsUpdateTask?.cancel(),this.operatorsUpdateTask=new l.Task(async e=>{if(this.channelName&&this.wolCon.isInChannel(this.channelName)){var i=await this.wolCon.listUsers(this.channelName);if(!e.isCancelled()){for(let t of i){let e=this.users.find(e=>e.name===t.name);if(e){var r=e.operator!==t.operator;if(e.operator=t.operator,r)for(var s of this.messages)s.from===e.name&&(s.operator=t.operator)}this.operatorStatuses.set(t.name,t.operator)}this.gameBrowser?.refresh()}}}),this.operatorsUpdateTask.start().catch(e=>{e instanceof c.OperationCanceledError||console.error(e)}))}onGameSelectionChange(e){this.selectedGame=e,this.refreshSidebarButtons()}gameIsFull(e){return e.humanPlayers+e.aiPlayers===e.maxPlayers-(e.observable?1:0)}refreshSidebarButtons(){let e=this.selectedGame;var t=[{label:this.strings.get("GUI:CreateGame"),tooltip:this.strings.get("STT:LobbyButtonNew"),onClick:()=>this.createGame()},{label:this.strings.get("GUI:JoinGame"),tooltip:this.strings.get("STT:LobbyButtonJoin"),disabled:!e||this.gameIsFull(e),onClick:()=>this.joinGame(e)},{label:this.strings.get("GUI:Observe"),tooltip:this.strings.get("STT:LobbyButtonObserve"),disabled:!e||!e.observable||!!e.observers,onClick:()=>{this.observeGame(e)}},...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(r.ScreenType.Login,{clearCredentials:!0,afterLogin:e=>new m.MainMenuRoute(r.ScreenType.CustomGame,{messages:e})})}}]:[],{label:this.strings.get("GUI:Back"),tooltip:this.strings.get("STT:LobbyButtonBack"),isBottom:!0,onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(r.ScreenType.Home)}}];this.controller.setSidebarButtons(t)}initView(){var[e]=this.jsxRenderer.render(s.jsx(a.HtmlView,{innerRef:e=>this.gameBrowser=e,component:i.GameBrowser,props:{strings:this.strings,messages:this.messages,chatHistory:this.chatHistory,channels:[this.channelName],localUsername:this.wolCon.getCurrentUser(),users:this.users,games:this.games,pings:this.pings,playerProfiles:this.playerProfiles,mapList:this.mapList,onSendMessage:e=>{e.value.length?(this.wolV2Compat&&e.value.startsWith("/")&&(this.ignoreCmdReplies=!1),this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(e.value,e.recipient),e.recipient.type===f.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=e.recipient.name))):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onRefreshClick:()=>this.refreshGames(),onSelectGame:e=>this.onGameSelectionChange(e),onDoubleClickGame:e=>{this.gameIsFull(e)||this.joinGame(e)}}}));this.controller.setMainComponent(e),this.refreshSidebarButtons(),this.controller.showSidebarButtons()}async onEnter(e){this.messages=e?.messages??[],this.chatHistory=new y.ChatHistory,this.controller.toggleMainVideo(!1),this.wolCon.getCurrentUser()?await this.loadChannel():this.controller.goToScreen(r.ScreenType.Login,{afterLogin:e=>new m.MainMenuRoute(r.ScreenType.CustomGame,{messages:e})})}async loadChannel(){this.channelName=void 0,this.users=[],this.games=[],this.selectedGame=void 0,this.wolCon.onJoinChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost);try{let e=this.wolService.getConfig();var t=`#Lob ${e.getClientChannelType()} 0`;this.users=await this.wolCon.joinChannel(t,e.getGlobalChannelPass()),this.channelName=t,this.wolV2Compat&&(this.operatorStatuses.clear(),this.users.forEach(e=>this.operatorStatuses.set(e.name,e.operator))),this.pings.clear(),this.playerProfiles.clear(),this.initView(),this.gameBrowser?.applyOptions(e=>e.users=this.users),this.refreshGames(),this.refreshTimeoutId=setInterval(()=>this.refreshGames(),5e3)}catch(e){return void this.handleError(e,this.strings.get("WOL:MatchBadParameters"))}}async onLeave(){this.disposables.dispose(),this.refreshTimeoutId&&clearInterval(this.refreshTimeoutId),this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),this.operatorsUpdateTask&&(this.operatorsUpdateTask.cancel(),this.operatorsUpdateTask=void 0),this.wolCon.isOpen()&&this.channelName&&this.wolCon.leaveChannel(this.channelName),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),await this.controller.hideSidebarButtons(),this.channelName=void 0,this.gameBrowser=void 0,this.messages=[],this.users=[],this.pings.clear(),this.playerProfiles.clear(),this.operatorStatuses.clear(),this.needsOperatorsRefresh=!1,this.games=[],this.selectedGame=void 0}async createGame(){this.controller.goToScreen(r.ScreenType.Lobby,{create:!0})}async joinGame(e){this.joinRoom(e,!1)}observeGame(e){this.joinRoom(e,!0)}joinRoom(e,t){e.modHash===this.engineModHash?this.controller.goToScreen(r.ScreenType.Lobby,{game:e,observe:t}):void 0!==e.modHash&&this.addSystemMessage(this.strings.get("TXT_MISMATCH"))}handleError(e,t){this.errorHandler.handle(e,t,()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(r.ScreenType.Home)}),clearInterval(this.refreshTimeoutId)}},e("CustomGameScreen",T)}}}),System.register("gui/screen/mainMenu/ladder/component/Ladder",["react","classnames","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/Select","gui/component/Option"],function(e,t){"use strict";var p,m,f,y,T;t&&t.id;return{setters:[function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){e("Ladder",({players:e,highlightPlayer:t,hasPrevPage:i,hasNextPage:r,seasons:s,selectedSeason:a,disabled:n,strings:o,onFirstPageClick:l,onPrevPageClick:c,onNextPageClick:h,onPlayerSearch:u,onSeasonSelect:d})=>{if(!e)return p.createElement("div",{className:"ladder"},o.get("GUI:LoadingEx"));const g=p.useRef(null);return p.createElement("div",{className:"ladder"},p.createElement("table",null,p.createElement("thead",null,p.createElement("tr",null,p.createElement("th",{className:"player-rank"},"#"),p.createElement("th",{className:"player-rank-icon"},o.get("GUI:Rank")),p.createElement("th",{className:"player-name"},o.get("GUI:Name")),p.createElement("th",{className:"player-points"},o.get("GUI:Points")),p.createElement("th",{className:"player-wins"},o.get("GUI:NumberWins")),p.createElement("th",{className:"player-losses"},o.get("GUI:NumberLosses")))),p.createElement("tbody",null,e.map(e=>p.createElement("tr",{key:e.name,className:m.default({selected:t?.toLowerCase()===e.name.toLowerCase(),disabled:!(e.points||e.wins||e.losses||e.disconnects)})},p.createElement("td",{className:"player-rank"},e.rank),p.createElement("td",{className:"player-rank-icon"},p.createElement(f.RankIndicator,{playerProfile:e,strings:o})),p.createElement("td",{className:"player-name"},e.name),p.createElement("td",{className:"player-points"},e.points),p.createElement("td",{className:"player-wins"},e.wins),p.createElement("td",{className:"player-losses"},(e.losses??0)+(e.disconnects??0)))))),p.createElement("div",{className:"pagination"},s?.length&&p.createElement(y.Select,{disabled:n,initialValue:a??s[0].value,onSelect:d,className:"ladder-select"},s.map(e=>p.createElement(T.Option,{key:e.value,label:e.label,value:e.value}))),p.createElement("button",{className:"first-page",disabled:!i||n,onClick:l},"<<"),p.createElement("button",{className:"prev-page",disabled:!i||n,onClick:c},"<"),p.createElement("button",{className:"next-page",disabled:!r||n,onClick:h},">"),p.createElement("form",{className:"player-search",onSubmit:e=>{e.preventDefault(),g.current?.value&&(u(g.current.value),g.current.value="")}},p.createElement("input",{className:"player",type:"text",disabled:n,ref:g,placeholder:o.get("GUI:Player")}),p.createElement("button",{type:"submit",disabled:n},o.get("GUI:Search")))))})}}}),System.register("gui/screen/mainMenu/ladder/LadderScreen",["@puzzl/core/lib/async/cancellation","@puzzl/core/lib/async/Task","gui/jsx/HtmlView","gui/jsx/jsx","network/WLadderService","util/disposable/CompositeDisposable","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ladder/component/Ladder"],function(e,t){"use strict";var r,i,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class h extends l.MainMenuScreen{constructor(e,t,i,r){super(),this.wladderService=e,this.jsxRenderer=t,this.errorHandler=i,this.strings=r,this.title=this.strings.get("GUI:Ladder"),this.disposables=new o.CompositeDisposable}async onEnter(e){this.params=e,this.ladder=void 0,this.isBusy=!1,this.season=n.WLadderService.CURRENT_SEASON,this.highlightPlayer=e.highlightPlayer?.name,this.startIndex=this.computePageStartIndex(e.highlightPlayer),this.initSidebar(),this.initView();try{await this.fetchInitial(e.ladderType,this.season,this.startIndex)}catch(e){e instanceof r.OperationCanceledError||this.handleError(e,this.strings.get("TS:DownloadFailed"),{fatal:!0})}}computePageStartIndex(e){let t=1;return void 0!==e?.rank&&(t+=Math.floor((e.rank-1)/h.PLAYERS_PER_PAGE)*h.PLAYERS_PER_PAGE),t}initSidebar(){this.controller?.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}]),this.controller?.showSidebarButtons()}async fetchInitial(r,s,a){await this.runTaskAsync(async e=>{let t=await this.wladderService.getSeasons(r,e);var i=await this.wladderService.rungSearch(a,h.PLAYERS_PER_PAGE+1,e,r,s);e.isCancelled()||(this.updateView(i,a),1<t.length&&this.ladder?.applyOptions(e=>{e.seasons=t.map(e=>({value:e,label:e===n.WLadderService.CURRENT_SEASON?this.strings.get("GUI:LadderCurrent"):e===n.WLadderService.PREV_SEASON?this.strings.get("GUI:LadderPrev"):this.strings.get("GUI:LadderSeason",e)}))}))})}fetchLadder(i){this.runTaskAsync(async e=>{var t=await this.wladderService.rungSearch(i,h.PLAYERS_PER_PAGE+1,e,this.params.ladderType,this.season);e.isCancelled()||this.updateView(t,i)}).catch(e=>{e instanceof r.OperationCanceledError||this.handleError(e,this.strings.get("TS:DownloadFailed"))})}async runTaskAsync(e){this.asyncTask?.cancel();let t=this.asyncTask=new i.Task(e);try{this.isBusy=!0,this.ladder?.applyOptions(e=>e.disabled=!0),await t.start()}finally{this.isBusy=!1,this.ladder?.applyOptions(e=>e.disabled=!1)}return t}searchPlayer(i){this.runTaskAsync(async e=>{var[t]=await this.wladderService.listSearch([i],e,this.params.ladderType,this.season);t&&!e.isCancelled()&&(this.startIndex=this.computePageStartIndex(t),t=await this.wladderService.rungSearch(this.startIndex,h.PLAYERS_PER_PAGE+1,e,this.params.ladderType,this.season),e.isCancelled()||this.updateView(t,this.startIndex,i))}).catch(e=>{e instanceof r.OperationCanceledError||this.handleError(e,this.strings.get("TS:DownloadFailed"))})}initView(){var[e]=this.jsxRenderer.render(a.jsx(s.HtmlView,{component:c.Ladder,innerRef:e=>this.ladder=e,props:{players:void 0,highlightPlayer:this.params.highlightPlayer?.name,hasPrevPage:!1,hasNextPage:!1,seasons:void 0,selectedSeason:this.season,strings:this.strings,disabled:this.isBusy,onFirstPageClick:()=>{this.ladder&&this.fetchLadder(1)},onPrevPageClick:()=>{this.ladder&&this.fetchLadder(Math.max(1,this.startIndex-h.PLAYERS_PER_PAGE))},onNextPageClick:()=>{this.ladder&&this.fetchLadder(this.startIndex+h.PLAYERS_PER_PAGE)},onPlayerSearch:e=>{this.ladder&&this.searchPlayer(e)},onSeasonSelect:e=>{this.season=e,this.ladder&&(this.highlightPlayer?this.searchPlayer(this.highlightPlayer):this.fetchLadder(1))}}}));this.controller?.setMainComponent(e)}updateView(t,i,r){this.startIndex=i,this.highlightPlayer=r,this.ladder?.applyOptions(e=>{r&&(e.highlightPlayer=r),e.players=t.slice(0,h.PLAYERS_PER_PAGE),e.hasPrevPage=1<i,e.hasNextPage=t.length>h.PLAYERS_PER_PAGE})}handleError(e,t,{fatal:i}={}){this.errorHandler.handle(e,t,()=>{i&&this.controller?.popScreen()})}async onLeave(){this.disposables.dispose(),this.ladder=void 0,this.asyncTask&&(this.asyncTask.cancel(),this.asyncTask=void 0),await this.controller?.hideSidebarButtons()}},e("LadderScreen",h),h.PLAYERS_PER_PAGE=20}}}),System.register("gui/screen/mainMenu/login/ServerPingIndicator",["react","classnames","gui/component/Image"],function(t,e){"use strict";var r,s,a,i,n,o,l;e&&e.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){var e;(e=i=i||{})[e.Good=1]="Good",e[e.Average=2]="Average",e[e.Bad=3]="Bad",n=e=>e<=100?i.Good:e<=250?i.Average:i.Bad,o=(new Map).set(i.Bad,"pingr").set(i.Average,"pingy").set(i.Good,"pingg"),l=(new Map).set(i.Bad,"ping-bad").set(i.Average,"ping-avg").set(i.Good,"ping-good"),t("ServerPingIndicator",({ping:e,strings:t})=>{var i=n(e);return r.default.createElement("div",{className:"server-ping"},r.default.createElement("span",{className:s.default("ping-text",l.get(i))},t.get("TS:PingValue",e)),r.default.createElement(a.Image,{src:o.get(i)+".pcx"}))})}}}),System.register("gui/screen/mainMenu/login/ServerList",["gui/component/List","react","gui/screen/mainMenu/login/ServerPingIndicator"],function(e,t){"use strict";var o,l,c;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("ServerList",({regionId:r,regions:e,pings:s,strings:a,onChange:n})=>l.default.createElement(o.List,{className:"server-list"},e.map(e=>{var t=s.get(e);let i=!e.available||s.has(e)&&void 0===t;return l.default.createElement(o.ListItem,{key:e.id,selected:e.id===r&&!i,disabled:i,onClick:()=>!i&&n(e.id)},l.default.createElement("span",{className:"label"},e.label),l.default.createElement("span",{className:"ping"},i?l.default.createElement("span",{className:"offline-text"},a.get("TS:ServerOffline")):void 0!==t&&l.default.createElement(c.ServerPingIndicator,{ping:t,strings:a})))})))}}}),System.register("gui/screen/mainMenu/login/LoginBox",["react","gui/screen/mainMenu/login/ServerList","@puzzl/core/lib/async/Task","network/HttpRequest"],function(e,t){"use strict";var p,m,f,y,i;t&&t.id;return{setters:[function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){i=({regions:e,selectedRegion:t,selectedUser:i,pings:r,breakingNewsUrl:s,strings:a,onRegionChange:n,onRequestRegionRefresh:o,onSubmit:l},c)=>{let h=p.useRef(null),u=p.useRef(null),[d,g]=p.useState();p.useEffect(()=>{setTimeout(()=>h.current?.focus(),50)},[]),p.useEffect(()=>{if(s){let e=new f.Task(async e=>{let t=await(new y.HttpRequest).fetchHtml(s,e);t=t.trim(),t.length&&g(t)});return e.start().catch(e=>console.error(e)),()=>e.cancel()}},[s]);p.useImperativeHandle(c,()=>({getValues(){return{user:h.current.value,pass:u.current.value}}}));return p.default.createElement("div",{className:"login-wrapper"},p.default.createElement("div",{className:"title"},a.get("GUI:Login")),p.default.createElement("form",{onSubmit:e=>{e.preventDefault(),l()},className:"login-form login-box"},p.default.createElement("div",{className:"field"},p.default.createElement("label",null,a.get("TS:ServerLabel")),i&&t?p.default.createElement("input",{type:"text",value:t.label,readOnly:!0}):p.default.createElement(p.default.Fragment,null,p.default.createElement(m.ServerList,{regionId:t?.id,regions:e,pings:r,strings:a,onChange:e=>{n(e)}}),p.default.createElement("button",{type:"button",className:"icon-button refresh-button",onClick:o}))),p.default.createElement("div",{className:"field"},p.default.createElement("label",null,a.get("GUI:Nickname")),p.default.createElement("input",{name:"user",type:"text",maxLength:15,ref:h,value:i,readOnly:!!i})),p.default.createElement("div",{className:"field"},p.default.createElement("label",null,a.get("GUI:Password")),p.default.createElement("input",{name:"pass",type:"password",maxLength:8,ref:u})),p.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})),d&&p.default.createElement("fieldset",{className:"news"},p.default.createElement("legend",null,a.get("GUI:BreakingNews")),p.default.createElement("div",{dangerouslySetInnerHTML:{__html:d}})))},e("LoginBox",p.forwardRef(i))}}}),System.register("gui/screen/mainMenu/login/ServerPings",["network/WolConnection"],function(e,t){"use strict";var n,o;t&&t.id;return{setters:[function(e){n=e}],execute:function(){e("ServerPings",o=class o{constructor(e,t,i){this.regions=e,this.wolConfig=t,this.netLogger=i,this.pings=new Map}async update(s,a){await Promise.all(this.regions.getAll().filter(e=>e.available).map(async t=>{let i=n.WolConnection.factory(this.netLogger),e=setTimeout(()=>i.close(),o.CONNECT_TIMEOUT);a?.register(()=>{clearTimeout(e),i.close()});try{if(await i.connect(t.wolUrl,this.wolConfig.getWolV2Compat(),t.wolv2Ascii),a?.isCancelled())return}catch(e){return console.error(e),i.close(),a?.isCancelled()||this.pings.set(t,void 0),void s?.()}finally{clearTimeout(e)}let r;try{r=await i.ping(5)}catch(e){console.error(e)}finally{i.close()}a?.isCancelled()||(this.pings.set(t,r),s?.())}))}}),o.CONNECT_TIMEOUT=5e3}}}),System.register("network/gservCodes",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("RPL_CVERS_OK",10),e("RPL_CVERS_OUTDATED",11),e("RPL_CVERS_MISSING",12),e("RPL_LOGGED_IN",100),e("RPL_ALREADY_LOGGED_IN",101),e("RPL_NOT_LOGGED_IN",102),e("RPL_BAD_LOGIN",103),e("RPL_TOO_MANY_LOGIN_ATTEMPTS",104),e("RPL_INSTANCE_CREATED",200),e("RPL_INSTANCE_EXISTS",201),e("RPL_INSTANCE_TOO_MANY",202),e("RPL_NOT_ENOUGH_PARAMS",300),e("RPL_INVALID_PARAMS",301),e("RPL_RATE_LIMIT_EXCEEDED",302),e("RPL_INSTANCE_CONNECTED",400),e("RPL_INSTANCE_NONEXISTENT",401),e("RPL_INSTANCE_NOT_ALLOWED",402),e("RPL_INSTANCE_ALREADY_STARTED",403),e("RPL_NO_INSTANCE",404),e("RPL_INSTANCE_NOT_RUNNING",405),e("RPL_INSTANCE_VERS_MISMATCH",406),e("RPL_GAME_OPTS",500),e("RPL_LOAD_INFO",600),e("RPL_MAP_TOO_BIG",602),e("RPL_MAP_ALREADY_SENT",603),e("RPL_GAME_START",700),e("RPL_GAME_DESYNC",801),e("RPL_NET_RATE",802),e("RPL_TAUNT",803),e("RPL_PLAYER_DISCONNECT",804),e("RPL_BIN_PREFIX",2),e("RPL_BIN_GAME_ACTIONS",1),e("RPL_BIN_MAP_DATA",2),e("REQ_BIN_PREFIX",2),e("REQ_BIN_GAME_ACTIONS",1),e("REQ_BIN_GAME_STATE_HASH",2),e("REQ_BIN_PUT_MAP",3),e("REQ_BIN_GET_MAP",4)}}}),System.register("network/GservError",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;i=class extends Error{constructor(e,t){super(e),this.code=t}},t("GservError",i),(e=(e=i=i||{}).Code||(e.Code={}))[e.Unknown=0]="Unknown",e[e.OutdatedClient=1]="OutdatedClient",e[e.BadLogin=2]="BadLogin",e[e.TooManyLoginAttempts=3]="TooManyLoginAttempts",e[e.AlreadyLoggedIn=4]="AlreadyLoggedIn",e[e.InstanceNonExistent=5]="InstanceNonExistent",e[e.InstanceAlreadyExists=6]="InstanceAlreadyExists",e[e.InstanceNotAllowed=7]="InstanceNotAllowed",e[e.InstanceAlreadyStarted=8]="InstanceAlreadyStarted",e[e.InstanceVersMismatch=9]="InstanceVersMismatch",e[e.CreatedTooManyInstances=10]="CreatedTooManyInstances",t("GservError",i)}}}),System.register("network/GservConnection",["util/event","data/DataStream","network/IrcConnection","network/gservCodes","network/GservError","network/gservConfig","network/gameopt/Parser","network/gameopt/Serializer","network/Apgar","network/chat/ChatMessage"],function(e,t){"use strict";var i,r,s,l,c,a,n,o,h,u,d,g;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){l=e},function(e){c=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){h=e},function(e){u=e}],execute:function(){d=new Map([[l.RPL_BAD_LOGIN,c.GservError.Code.BadLogin],[l.RPL_TOO_MANY_LOGIN_ATTEMPTS,c.GservError.Code.TooManyLoginAttempts],[l.RPL_ALREADY_LOGGED_IN,c.GservError.Code.AlreadyLoggedIn],[l.RPL_INSTANCE_EXISTS,c.GservError.Code.InstanceAlreadyExists],[l.RPL_INSTANCE_TOO_MANY,c.GservError.Code.CreatedTooManyInstances],[l.RPL_INSTANCE_NONEXISTENT,c.GservError.Code.InstanceNonExistent],[l.RPL_INSTANCE_NOT_ALLOWED,c.GservError.Code.InstanceNotAllowed],[l.RPL_INSTANCE_ALREADY_STARTED,c.GservError.Code.InstanceAlreadyStarted],[l.RPL_INSTANCE_VERS_MISMATCH,c.GservError.Code.InstanceVersMismatch]]),e("GservConnection",g=class{constructor(e){this._onLoadInfo=new i.EventDispatcher,this._onGameStart=new i.EventDispatcher,this._onGameActions=new i.EventDispatcher,this._onGameDesync=new i.EventDispatcher,this._onRateChange=new i.EventDispatcher,this._onChatMessage=new i.EventDispatcher,this._onTaunt=new i.EventDispatcher,this._onPlayerDisconnect=new i.EventDispatcher,this.handleMessage=t=>{if("string"==typeof t){let e=t.split(" ");var i,r;"ping"===e[0]?this.isOpen()&&this.con.sendMessage("pong"+(e[1]?" "+e[1]:"")):"privmsg"===e[1].toLowerCase()?this.handlePrivMsg(t):e[1]===""+l.RPL_LOAD_INFO?this.handleLoadInfo(e[3]):e[1]===""+l.RPL_GAME_START?this.handleGameStart():e[1]===""+l.RPL_GAME_DESYNC?this._onGameDesync.dispatch(this):e[1]===""+l.RPL_NET_RATE?([i,r]=e[3].slice(1).split(","),this._onRateChange.dispatch(this,{rate:Number(i),turnNo:Number(r)})):e[1]===""+l.RPL_TAUNT?this._onTaunt.dispatch(this,{from:e[0].replace(/^:/,""),tauntNo:Number(e[3].replace(/^:/,""))}):e[1]===""+l.RPL_PLAYER_DISCONNECT&&this._onPlayerDisconnect.dispatch(this,e[3].replace(/^:/,""))}else t[0]===l.RPL_BIN_GAME_ACTIONS&&this.handlePlayerActions(t.slice(1))},this.con=e}get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onLoadInfo(){return this._onLoadInfo.asEvent()}get onGameStart(){return this._onGameStart.asEvent()}get onGameActions(){return this._onGameActions.asEvent()}get onGameDesync(){return this._onGameDesync.asEvent()}get onRateChange(){return this._onRateChange.asEvent()}get onChatMessage(){return this._onChatMessage.asEvent()}get onTaunt(){return this._onTaunt.asEvent()}get onPlayerDisconnect(){return this._onPlayerDisconnect.asEvent()}static factory(e){return new this(new s.IrcConnection({mode:"text",binaryRplPrefix:l.RPL_BIN_PREFIX,binaryReqPrefix:l.REQ_BIN_PREFIX},e))}getCurrentUser(){return this.currentUser}getServerName(){return this.serverName}async connect(e){return this.con.onMessage.subscribe(this.handleMessage),await this.con.connect(e)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close(),this.currentUser=void 0}isOpen(){return this.con.isOpen()}async cvers(e){let t=await this.con.sendCommand(`cvers ${e} `+a.API_VERSION,{replyCodes:[l.RPL_CVERS_OK,l.RPL_CVERS_OUTDATED]});if(t[0].code===l.RPL_CVERS_OUTDATED){var i=t[0].params?t[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new c.GservError("Cvers error: "+i,c.GservError.Code.OutdatedClient)}}async login(e,t){let i=await this.con.sendCommand(`user ${e} `+h.Apgar.encode(t),{replyCodes:[l.RPL_LOGGED_IN,l.RPL_BAD_LOGIN,l.RPL_TOO_MANY_LOGIN_ATTEMPTS,l.RPL_ALREADY_LOGGED_IN]});if(i[0].code!==l.RPL_LOGGED_IN){var r=d.get(i[0].code)??c.GservError.Code.Unknown,s=i[0].params?i[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new c.GservError("Login error: "+s,r)}this.currentUser=e,this.serverName=i[0].raw.match(/^:([^\s]+)/)?.[1]||""}async createGame(e,t,i,r,s){if(i.includes(" "))throw new Error("Game opts string cannot include spaces");let a=await this.con.sendCommand(`create ${e} ${t} ${i} ${r} `+s,{replyCodes:[l.RPL_INSTANCE_CREATED,l.RPL_INSTANCE_EXISTS,l.RPL_INSTANCE_TOO_MANY,l.RPL_INSTANCE_NOT_ALLOWED]});if(a[0].code!==l.RPL_INSTANCE_CREATED){var n=d.get(a[0].code)??c.GservError.Code.Unknown,o=a[0].params?a[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new c.GservError("Create error: "+o,n)}}async joinGame(e,t,i){let r=await this.con.sendCommand(`join ${e} ${t} `+i,{replyCodes:[l.RPL_INSTANCE_CONNECTED,l.RPL_INSTANCE_NONEXISTENT,l.RPL_INSTANCE_NOT_ALLOWED,l.RPL_INSTANCE_ALREADY_STARTED,l.RPL_INSTANCE_VERS_MISMATCH]});if(r[0].code!==l.RPL_INSTANCE_CONNECTED){var s=d.get(r[0].code)??c.GservError.Code.Unknown,a=r[0].params?r[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new c.GservError("Join error: "+a,s)}}async gameOpts(){let e=await this.con.sendCommand("gameopts",{replyCodes:[l.RPL_GAME_OPTS]});if(!e[0].params)throw new Error("Unexpected server reply for getopts command. Missing params.");return e[0].params.splice(1).join(" ").replace(/^:/,"")}sendLoadedPercent(e){this.con.sendMessage("loaded "+e)}requestLoadInfo(){this.con.sendMessage("loadinfo")}sendGameStateHash(e,t){let i=new r.DataStream(10);i.dynamicSize=!1,i.writeUint8(l.REQ_BIN_PREFIX),i.writeUint8(l.REQ_BIN_GAME_STATE_HASH),i.writeUint32(e),i.writeUint32(t),this.con.sendMessage(i.toUint8Array())}sendPlayerActive(e){this.con.sendMessage("active "+(e?1:0))}sendTaunt(e){this.con.sendMessage("taunt "+e)}async ping(e){return await this.con.ping(e)}sendPlayerActions(e,t){let i=new r.DataStream(6);i.writeUint8(l.REQ_BIN_PREFIX),i.writeUint8(l.REQ_BIN_GAME_ACTIONS),i.writeUint32(e),i.writeUint8Array(t),this.con.sendMessage(i.toUint8Array())}sendMap(e){let t=new r.DataStream(2);t.writeUint8(l.REQ_BIN_PREFIX),t.writeUint8(l.REQ_BIN_PUT_MAP),t.writeUint8Array((new o.Serializer).serializeMapData(e)),this.con.sendMessage(t.toUint8Array())}async getMap(){let e=new r.DataStream(2);e.dynamicSize=!1,e.writeUint8(l.REQ_BIN_PREFIX),e.writeUint8(l.REQ_BIN_GET_MAP);var t=await this.con.sendBinCommand(e.toUint8Array(),{replyCodes:[l.RPL_BIN_MAP_DATA],timeout:15});return(new n.Parser).parseMapData(t.data)}handleLoadInfo(e){this._onLoadInfo.dispatch(this,e.replace(/^:/,""))}handleGameStart(){this._onGameStart.dispatch(this,void 0)}handlePlayerActions(e){this._onGameActions.dispatch(this,e)}sayChannel(e){this.privmsg([a.RECIPIENT_ALL],e)}privmsg(e,t){if(!this.currentUser)throw new Error("Must login before sending messages");var i;t.length&&(i=e.join(","),this.con.sendMessage(`privmsg ${i} :`+t))}handlePrivMsg(e){var t=e.match(/^:([A-Za-z0-9-_]+) PRIVMSG ([A-Za-z0-9-_#']+) :(.*)/i);if(!t)throw new Error(`Unexpected PRIVMSG message format "${e}"`);var[,i,r,t]=t;let s;r===a.RECIPIENT_ALL?s={from:i,to:{type:u.ChatRecipientType.Channel,name:r},text:t}:r===this.currentUser&&(s={from:i,to:i===this.getServerName()?{type:u.ChatRecipientType.Page,name:r}:{type:u.ChatRecipientType.Channel,name:a.RECIPIENT_TEAM},text:t}),s&&this._onChatMessage.dispatch(this,s)}})}}}),System.register("game/action/NoAction",["game/action/Action","game/action/ActionType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.Action{constructor(){super(r.ActionType.NoAction)}process(){}},e("NoAction",s)}}}),System.register("network/gamestate/ActionSerializer",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ActionSerializer",i=class{getActionPayload(e){return{id:e.actionType,params:e.serialize()}}})}}}),System.register("game/GameTurnManager",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gamestate/ReplayRecorder",["game/action/ActionType","network/gamestate/replay/TurnActionsReplayEvent","network/gameopt/Parser","network/gameopt/Serializer","network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/TauntReplayEvent"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){e("ReplayRecorder",l=class{constructor(e,t,i,r){this.replay=e,this.playerId=t,this.humanPlayers=i,this.actionSerializer=r}recordActions(t,i){if(Array.isArray(i)){let e=new r.TurnActionsReplayEvent(new s.Parser,new a.Serializer,t);e.payload=[[this.playerId,i.map(e=>this.actionSerializer.getActionPayload(e))]],this.replay.writeEvent(e)}else if(this.hasActualActions(i)){let e=new r.TurnActionsReplayEvent(new s.Parser,new a.Serializer,t);e.payload=[...i].map(([e,t])=>[e,t]),this.replay.writeEvent(e)}}recordChatMessage(e,t,i){let r=new n.ChatMessageReplayEvent(e);r.payload={playerId:this.humanPlayers.findIndex(e=>e.name===t),message:i},this.replay.writeEvent(r)}recordTaunt(e,t,i){let r=new o.TauntReplayEvent(e);r.payload={playerId:this.humanPlayers.findIndex(e=>e.name===t),tauntNo:i},this.replay.writeEvent(r)}hasActualActions(e){return!![...e.values()].find(e=>e.find(e=>e.id!==i.ActionType.NoAction))}})}}}),System.register("network/gamestate/lockstepUtil",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){e("computeNetworkTurnMillis",(e,t)=>{return Math.max(1,Math.ceil(e/t))*t})}}}),System.register("network/gamestate/LockstepManager",["data/DataStream","game/action/NoAction","game/Game","util/event","network/gservConfig","game/GameSpeed","network/gamestate/lockstepUtil"],function(e,t){"use strict";var d,i,r,g,s,a,n,o;t&&t.id;return{setters:[function(e){d=e},function(e){i=e},function(e){r=e},function(e){g=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){e("LockstepManager",o=class o{constructor(e,t,i,r,s,a,n,o,l,c,h,u){this.game=e,this.gservCon=t,this.gameoptParser=i,this.gameoptSerializer=r,this.actionSerializer=s,this.actionFactory=a,this.inputActions=n,this.onDesync=o,this.actionLogger=l,this.debugLogger=c,this.replayRecorder=h,this.debugGameState=u,this.debugGameStateHistory=[],this.queuedRateChanges=[],this.errorState=!1,this.passiveMode=!1,this.receivedActions=new Map,this.receivedNetworkTurn=0,this.lagState=!1,this._onLagStateChange=new g.EventDispatcher,this._onActionsSent=new g.EventDispatcher,this._onActionsProcessed=new g.EventDispatcher,this._onActionsReceived=new g.EventDispatcher,this.receiveActions=e=>{let t=new d.DataStream(e);var i=t.readUint32(),r=this.gameoptParser.parseAllPlayerActions(t);this.receivedNetworkTurn=i,this.receivedActions.set(i,r),this._onActionsReceived.dispatch(void 0,i)},this.handleGameDesync=()=>{this.setErrorState(),this.onDesync()}}get onLagStateChange(){return this._onLagStateChange.asEvent()}get onActionsSent(){return this._onActionsSent.asEvent()}get onActionsProcessed(){return this._onActionsProcessed.asEvent()}get onActionsReceived(){return this._onActionsReceived.asEvent()}init(){this.gameTurnMillis=1e3/(this.game.desiredSpeed.value*a.GameSpeed.BASE_TICKS_PER_SECOND),this.currentNetworkTurn=0,this.currentSubTurn=0,this.gservCon.onGameActions.subscribe(this.receiveActions),this.gservCon.onGameDesync.subscribe(this.handleGameDesync),this.debug("Init: gameTurnMillis = "+this.gameTurnMillis)}canAdvanceNetworkTurn(){return this.currentNetworkTurn<2||this.receivedActions.has(this.currentNetworkTurn-2)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}setRate(e){if(this.debug(`Recv rate: ${e.rate} (turn ${e.turnNo})`),0===this.currentSubTurn&&0===this.currentNetworkTurn&&0===e.turnNo)this.updateRate(e.rate);else{if(e.turnNo<this.currentNetworkTurn-2)throw new Error("Rate change has turn number more than two turns in the past.");this.queuedRateChanges.push(e)}}updateRate(e){this.networkTurnMillis=n.computeNetworkTurnMillis(e,this.gameTurnMillis),this.hashCheckTurnInterval=Math.ceil(o.PREFERRED_HASH_CHECK_MILLIS/this.networkTurnMillis),console.log(`Rate set to ${e} (${this.networkTurnMillis}ms) @ `+this.currentNetworkTurn)}setPassiveMode(e){this.debug("Send passive: "+e),this.passiveMode=e,this.gservCon.sendPlayerActive(!e)}getTurnMillis(){return this.gameTurnMillis}doGameTurn(e){if(!this.errorState){if(!this.networkTurnMillis)throw new Error("Network turn rate should be set by now.");if(this.game.status!==r.GameStatus.Ended){if(0===this.currentSubTurn){var t=this.queuedRateChanges[0];if(t&&t.turnNo+2===this.currentNetworkTurn&&(this.debug(`Process rate ${t.rate} (turn ${t.turnNo})`),this.updateRate(t.rate),this.queuedRateChanges.shift()),!this.canAdvanceNetworkTurn())return this.handleCommsLag(!0,e),this.debug("Lag state: "+this.lagState),!1;this.debug("Advance turn"),this.commsLagStartTime&&0<e-this.commsLagStartTime&&console.log(`Waited ${Math.round(e-this.commsLagStartTime)}ms for other clients to catch up.`),this.handleCommsLag(!1,e),!this.passiveMode&&this.currentNetworkTurn>=this.receivedNetworkTurn&&this.sendActions(),2<=this.currentNetworkTurn&&(i=this.receivedActions.get(this.currentNetworkTurn-2),this.replayRecorder.recordActions(this.game.currentTick,i),this.processActions(i),this.receivedActions.delete(this.currentNetworkTurn-2),this._onActionsProcessed.dispatch(void 0,this.currentNetworkTurn-2)),this.game.update(),this.passiveMode||this.currentNetworkTurn%this.hashCheckTurnInterval!=0||this.gservCon.sendGameStateHash(this.currentNetworkTurn,this.game.getHash()),this.networkTurnMillis>this.gameTurnMillis?this.currentSubTurn++:this.currentNetworkTurn++}else this.debug("Update"),this.game.update(),this.currentSubTurn++,this.currentSubTurn>=this.networkTurnMillis/this.gameTurnMillis&&(this.currentSubTurn=0,this.currentNetworkTurn++);var i;this.debugGameState&&(i=this.networkTurnMillis/this.gameTurnMillis*this.hashCheckTurnInterval,this.debugGameStateHistory.length>i&&this.debugGameStateHistory.shift(),this.debugGameStateHistory.push(this.game.debugGetState()))}else this.game.update()}}handleCommsLag(e,t){e?(this.commsLagStartTime||(this.commsLagStartTime=t),t-this.commsLagStartTime>s.LAG_STATE_THRESH_MILLIS&&this.updateLagState(!0)):(this.commsLagStartTime=void 0,this.updateLagState(!1))}updateLagState(e){e!==this.lagState&&(this.lagState=e,this._onLagStateChange.dispatch(void 0,e))}sendActions(){let e=this.inputActions.dequeueAll();e.length||e.push(new i.NoAction);var t=this.gameoptSerializer.serializePlayerActions(e.map(e=>this.actionSerializer.getActionPayload(e)));this.debug("Send actions: "+t),this.gservCon.sendPlayerActions(this.currentNetworkTurn,t),this._onActionsSent.dispatch(void 0,this.currentNetworkTurn)}processActions(e){[...e].forEach(([r,e])=>e.forEach(e=>{let t=this.actionFactory.create(e.id);t.player=this.game.getPlayer(r),t.unserialize(e.params),t.process();var i=t.print();i&&this.actionLogger?.debug(`(${t.player.name})@${this.game.currentTick}: `+i)}))}debug(e){this.debugLogger?.(`${this.currentNetworkTurn}-${this.currentSubTurn}-${this.game.currentTick}: `+e)}dispose(){this.setErrorState(),this.gservCon.onGameActions.unsubscribe(this.receiveActions),this.gservCon.onGameDesync.unsubscribe(this.handleGameDesync)}}),o.PREFERRED_HASH_CHECK_MILLIS=1e3}}}),System.register("engine/GameAnimationLoop",["network/IrcConnection"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("GameAnimationLoop",i=class{constructor(e,t,i,r,s={}){this.localPlayer=e,this.renderer=t,this.sound=i,this.gameTurnMgr=r,this.options=s,this.isStarted=!1,this.rendererErrorState=!1,this.doBackgroundFrame=t=>{if(this.isStarted&&this.paused){let e=this.updateDeltaGameFrames(t);for(this.turnMgrIsWaiting&&(e=1);0<e;)this.turnMgrIsWaiting=!1===this.tickGame(t),e--}},this.doFrame=i=>{if(this.isStarted&&!this.paused){let t=this.updateDeltaGameFrames(i);(this.turnMgrIsWaiting||!this.options.skipFrames&&1<t)&&(t=1);let e=this.renderer.getStats();if(e&&e.begin(),this.options.skipBudgetMillis){let e=this.options.skipBudgetMillis;for(;0<t;){var r=performance.now();this.turnMgrIsWaiting=!1===this.tickGame(i),t--;r=performance.now()-r;if(e=Math.max(0,e-r),e<=0)break}}else for(;0<t;)this.turnMgrIsWaiting=!1===this.tickGame(i),t--;var s=this.gameTurnMgr.getTurnMillis(),s=Math.max(0,(i-(this.startTime+this.lastGameFrame*s))/s);this.updateRenderer(i,s),this.renderer.render(),e&&e.end(),this.rafId=requestAnimationFrame(this.doFrame)}},this.handleVisibilityChange=()=>{var e=document.hidden;if(this.paused!==e){if(this.localPlayer&&!this.localPlayer.isObserver&&this.paused&&this.doBackgroundFrame(performance.now()),(this.paused=e)||(this.startTime=void 0,this.lastGameFrame=0),this.localPlayer&&!this.localPlayer.isObserver)try{this.gameTurnMgr.setPassiveMode?.(this.paused)}catch(e){if(!(e instanceof a.IrcConnection.SocketError))throw e}this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval(()=>{var e=performance.now();this.doBackgroundFrame(e)},1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)),this.sound.audioSystem.setMuted(this.paused)}}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,this.startTime=void 0,this.lastGameFrame=0,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}updateDeltaGameFrames(e){var t=this.gameTurnMgr.getTurnMillis(),i=t!==this.lastGameTurnMillis;this.lastGameTurnMillis=t,i&&(this.lastGameFrame=0,this.startTime=e);let r=0;return this.startTime?(i=e-this.startTime,t=Math.round(i/t),r=t-this.lastGameFrame,this.lastGameFrame=t):this.startTime=e,r}tickGame(e){if(!this.options.onError)return this.gameTurnMgr.doGameTurn(e);try{return this.gameTurnMgr.doGameTurn(e)}catch(e){return this.gameTurnMgr.setErrorState(),void this.options.onError(e)}}updateRenderer(e,t){if(this.options.onError){if(!this.rendererErrorState)try{this.renderer.update(e,t)}catch(e){return this.gameTurnMgr.setErrorState(),this.rendererErrorState=!0,void this.options.onError(e)}}else this.renderer.update(e,t)}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}}),System.register("gui/screen/game/component/GameResultPopup",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer"],function(t,e){"use strict";var r,i,s,a,n,o;e&&e.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){a=e}],execute:function(){var e;(e=n=n||{})[e.SpVictory=0]="SpVictory",e[e.SpDefeat=1]="SpDefeat",e[e.MpVictory=2]="MpVictory",e[e.MpDefeat=3]="MpDefeat",t("GameResultType",n),o=class extends s.UiComponent{createUiObject({viewport:e}){let t=new i.UiObject(new THREE.Object3D,new a.HtmlContainer);return t.setPosition(e.x,e.y),t.getHtmlContainer().setSize(e.width,e.height),t}defineChildren(){let{viewport:i,type:e}=this.props;return r.jsx("sprite",{image:"grfxtxt.shp",palette:"grfxtxt.pal",ref:e=>{var t=e.getSize();e.setPosition((i.width-t.width)/2,(i.height-t.height)/2)},frame:e})}},t("GameResultPopup",o)}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenApi",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gamestate/SoloPlayTurnManager",["game/action/NoAction","game/Game","game/GameSpeed"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("SoloPlayTurnManager",a=class{constructor(e,t,i,r,s){this.game=e,this.currentPlayer=t,this.inputActions=i,this.actionLogger=r,this.replayRecorder=s,this.errorState=!1,this.gameSpeedChanged=!1,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value)}computeGameTurn(e){this.gameTurnMillis=1e3/(e*s.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(e){if(!this.errorState){if(this.game.status!==r.GameStatus.Ended){let e=this.inputActions.dequeueAll();e.length?this.replayRecorder.recordActions(this.game.currentTick,e):e.push(new i.NoAction),this.processActions(e)}this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1)}}processActions(e){e.forEach(e=>{e.player=this.currentPlayer,e.process();var t=e.print();t&&this.actionLogger?.debug(`(${e.player.name})@${this.game.currentTick}: `+t)})}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}}),System.register("engine/util/RaycastHelper",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RaycastHelper",i=class{constructor(e){this.scene=e}intersect(e,t,i=!1){let r=new THREE.Raycaster;var s=this.normalizePointer(e,this.scene.viewport);return r.setFromCamera(s,this.scene.camera),r.intersectObjects(t,i)}normalizePointer(e,t){return{x:(e.x-t.x)/t.width*2-1,y:2*-((e.y-t.y)/t.height)+1}}})}}}),System.register("engine/util/EntityIntersectHelper",["util/geometry"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("EntityIntersectHelper",i=class{constructor(e,t,i,r,s,a){this.map=e,this.renderableManager=t,this.mapTileIntersectHelper=i,this.raycastHelper=r,this.scene=s,this.worldViewportHelper=a}getEntitiesAtScreenBox(t){let e=this.renderableManager.getRenderableContainer();if(!e)return[];let i=this.collectIntersectTargets(e.get3DObject()),r=new Set;return i.forEach(e=>r.add(this.renderableManager.getRenderableById(this.findRenderableId(e)))),[...r].filter(e=>this.worldViewportHelper.intersectsScreenBox(e.gameObject.position.worldPosition,t))}getEntityAtScreenPoint(i){var r=this.scene.viewport;if(a.rectContainsPoint(r,i)){let e=this.renderableManager.getRenderableContainer();if(e){var s=this.collectIntersectTargets(e.get3DObject());let t=this.raycastHelper.intersect(i,s,!1);if(t.length){let e=t.map(e=>({renderable:this.renderableManager.getRenderableById(this.findRenderableId(e.object)),point:e.point}));r=e.find(e=>e.renderable.gameObject.isUnit());if(r)return r;s=e.find(e=>e.renderable.gameObject.isBuilding()&&e.renderable.getIntersectTarget?.());if(!s)return e[0];r=this.mapTileIntersectHelper.getTileAtScreenPoint(i);if(r){r=this.map.getObjectsOnTile(r).find(e=>{if(!e.isBuilding())return!1;let t=this.renderableManager.getRenderableByGameObject(e);return void 0!==t.getIntersectTarget?.()});if(r)return{renderable:this.renderableManager.getRenderableByGameObject(r),point:s.point}}}}}}collectIntersectTargets(t){let i=[];if(!t.visible)return i;if(void 0!==t.userData.id){let e=this.renderableManager.getRenderableById(t.userData.id);if(!e)throw new Error(`Entity not found (id = "${t.userData.id}")`);var r;e.gameObject.isDestroyed||e.gameObject.isCrashing||(r=e.getIntersectTarget?.(),Array.isArray(r)?i.push(...r):r&&i.push(r))}return t.children.forEach(e=>{e.visible&&i.push(...this.collectIntersectTargets(e))}),i}findRenderableId(e){let t;for(;t=e.userData.id,e=e.parent,void 0===t&&e.parent;);if(void 0===t)throw new Error("No attached renderable ID found for Object3D.");return t}})}}}),System.register("gui/screen/game/worldInteraction/UnitSelectionHandler",["util/geometry","util/math","util/event","util/array","game/gameobject/unit/HealthLevel"],function(t,e){"use strict";var a,i,n,l,s,o,r;e&&e.id;return{setters:[function(e){a=e},function(e){i=e},function(e){n=e},function(e){l=e},function(e){s=e}],execute:function(){var e;(e=o=o||{})[e.None=0]="None",e[e.OnScreen=1]="OnScreen",e[e.OnMap=2]="OnMap",e[e.Veteran=3]="Veteran",e[e.Health=4]="Health",t("QueryType",o),t("UnitSelectionHandler",r=class{constructor(e,t,i,r,s,a){this.worldScene=e,this.uiScene=t,this.player=i,this.unitSelection=r,this.entityIntersectHelper=s,this.veteranCap=a,this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1,this._onUserSelectionChange=new n.EventDispatcher,this._onUserSelectionUpdate=new n.EventDispatcher,this._onUserSelectionChange.subscribe(()=>{this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1}),this._onUserSelectionUpdate.subscribe(()=>{this.selectVeteranState=void 0,this.selectHealthState=void 0})}get onUserSelectionChange(){return this._onUserSelectionChange.asEvent()}get onUserSelectionUpdate(){return this._onUserSelectionUpdate.asEvent()}addToSelection(t){if(t.rules.selectable){let e=this.unitSelection.getSelectedUnits();e.length&&(t.owner===this.player&&!e.find(e=>e.owner!==t.owner)||this.unitSelection.deselectAll()),this.unitSelection.addToSelection(t)}}selectSingleUnit(e){var t,i,r;e.rules.selectable&&((t=this.unitSelection.getSelectedUnits()).length&&this.unitSelection.deselectAll(),this.unitSelection.addToSelection(e),r={selection:i=this.unitSelection.getSelectedUnits()},i.length===t.length&&i[0]===t[0]||this._onUserSelectionChange.dispatch(this,r),this._onUserSelectionUpdate.dispatch(this,r))}toggleSelection(e){var t;e.rules.selectable&&(this.unitSelection.isSelected(e)?this.unitSelection.removeFromSelection([e]):this.addToSelection(e),t={selection:this.unitSelection.getSelectedUnits()},this._onUserSelectionChange.dispatch(this,t),this._onUserSelectionUpdate.dispatch(this,t))}deselectAll(){var e={selection:[]};this.unitSelection.getSelectedUnits().length&&(this.unitSelection.deselectAll(),this._onUserSelectionChange.dispatch(this,e)),this._onUserSelectionUpdate.dispatch(this,e)}selectMultipleUnits(e,{queryType:t,veteranLevel:i,healthLevel:r},s=!0){var a=this.unitSelection.getSelectedUnits();s&&this.unitSelection.deselectAll(),e.forEach(e=>this.addToSelection(e));var n=this.unitSelection.getSelectedUnits(),o={selection:n,queryType:t,veteranLevel:i,healthLevel:r};l.equals(a,n)||this._onUserSelectionChange.dispatch(this,o),this._onUserSelectionUpdate.dispatch(this,o)}getSelectedUnits(){return this.unitSelection.getSelectedUnits()}startBoxSelect(e){this.boxSelectOrigin=e,this.selectBox=this.createSelectBox(new THREE.Box2),this.uiScene.get3DObject().add(this.selectBox)}updateBoxSelect(e){var t;this.boxSelectOrigin&&(e=this.clampPointerToWorldViewport(e),t=(new THREE.Box2).setFromPoints([new THREE.Vector2(this.boxSelectOrigin.x,this.boxSelectOrigin.y),new THREE.Vector2(e.x,e.y)]),this.selectBox.geometry.dispose(),this.selectBox.geometry=this.createBoxGeometry(t))}finishBoxSelect(e,t){if(!this.boxSelectOrigin)return!1;var i=this.boxSelectOrigin;if(this.boxSelectOrigin=void 0,this.disposeBoxSelect(),a.pointEquals(e,i))return!1;e=this.clampPointerToWorldViewport(e);i=(new THREE.Box2).setFromPoints([new THREE.Vector2(i.x,i.y),new THREE.Vector2(e.x,e.y)]);let r=this.entityIntersectHelper.getEntitiesAtScreenBox(i)?.map(e=>e.gameObject).filter(e=>e.isTechno()&&e.rules.selectable&&e.owner===this.player);if(!r.length)return!1;let s;return s=1===r.length?[r[0]]:r.filter(e=>!e.isBuilding()),!!s.length&&(this.selectMultipleUnits(s,{queryType:o.None},t),!0)}cancelBoxSelect(){this.boxSelectOrigin=void 0,this.disposeBoxSelect()}createGroup(e){var t=this.unitSelection.getSelectedUnits();1===t.length&&t[0].owner!==this.player||this.unitSelection.createGroup(e)}getGroupUnits(e){return this.unitSelection.getGroupUnits(e)}addGroupToSelection(e){var t=this.getSelectedUnits();this.unitSelection.addGroupToSelection(e);var i=this.getSelectedUnits(),r={selection:i};l.equals(i,t)||this._onUserSelectionChange.dispatch(this,r),this._onUserSelectionUpdate.dispatch(this,r)}selectGroup(e){var t=this.getSelectedUnits();this.unitSelection.selectGroup(e);var i=this.getSelectedUnits(),r={selection:i};l.equals(i,t)||this._onUserSelectionChange.dispatch(this,r),this._onUserSelectionUpdate.dispatch(this,r)}selectByType(){let i=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(i){let e=[];e=this.shouldSelectByTypeOnMap?i.getOwnedObjects():this.getOwnedObjectsOnScreen(i);let t=this.getSelectedUnits().reduce((e,t)=>e.add(t.name),new Set);var r=e.filter(e=>t.has(e.name)),s=this.shouldSelectByTypeOnMap?o.OnMap:o.OnScreen;r.length?this.selectMultipleUnits(r,{queryType:s},!1):t.size||this.selectMultipleUnits([],{queryType:s}),this.shouldSelectByTypeOnMap=!0}}selectCombatants(){let t=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(t){let e=[];e=this.shouldSelectCombatantsOnMap?t.getOwnedObjects():this.getOwnedObjectsOnScreen(t);var i,r=e.filter(e=>e.isUnit()&&e.rules.selectable&&e.rules.isSelectableCombatant&&e.attackTrait&&!e.rules.harvester);r.length?(i=this.shouldSelectCombatantsOnMap?o.OnMap:o.OnScreen,this.selectMultipleUnits(r,{queryType:i})):this.shouldSelectCombatantsOnMap?this.selectMultipleUnits([],{queryType:o.OnMap}):(this.shouldSelectCombatantsOnMap=!0,this.selectCombatants()),this.shouldSelectCombatantsOnMap=!0}}selectByVeterancy(){let i=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(i){let t;void 0===this.selectVeteranState?(t=this.veteranCap,this.vetNavSelectionSet=this.unitSelection.getSelectedUnits(),this.vetNavSelectionSet.length||(this.vetNavSelectionSet=this.getOwnedObjectsOnScreen(i).filter(e=>e.isUnit()))):(r=this.veteranCap+1,t=(this.selectVeteranState-1+r)%r);let e=this.vetNavSelectionSet.filter(e=>e.rules.selectable&&!e.isDestroyed&&!e.isCrashing&&!e.limboData&&e.owner===i);var r=e.filter(e=>e.veteranLevel===t);this.selectMultipleUnits(r,{queryType:o.Veteran,veteranLevel:e.length?t:void 0}),this.selectVeteranState=t}}selectByHealth(){let i=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(i){let t;var r=Object.keys(s.HealthLevel).filter(e=>!isNaN(Number(e))).length;void 0===this.selectHealthState?(t=r-1,this.healthNavSelectionSet=this.unitSelection.getSelectedUnits(),this.healthNavSelectionSet.length||(this.healthNavSelectionSet=this.getOwnedObjectsOnScreen(i).filter(e=>e.isUnit()))):t=(this.selectHealthState-1+r)%r;let e=this.healthNavSelectionSet.filter(e=>e.rules.selectable&&!e.isDestroyed&&!e.isCrashing&&!e.limboData&&e.owner===i);r=e.filter(e=>e.healthTrait.level===t);this.selectMultipleUnits(r,{queryType:o.Health,healthLevel:e.length?t:void 0}),this.selectHealthState=t}}getOwnedObjectsOnScreen(t){var e=this.worldScene.viewport,e=new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width-1,e.x+e.height-1));return this.entityIntersectHelper.getEntitiesAtScreenBox(e)?.map(e=>e.gameObject).filter(e=>e.isTechno()&&e.owner===t)}disposeBoxSelect(){this.selectBox&&(this.uiScene.get3DObject().remove(this.selectBox),this.selectBox.geometry.dispose(),this.selectBox.material.dispose(),this.selectBox=void 0)}clampPointerToWorldViewport(e){var t=this.worldScene.viewport;return{x:i.clamp(e.x,t.x,t.x+t.width-1),y:i.clamp(e.y,t.y,t.y+t.height-1)}}getHash(){return this.unitSelection.getHash()}dispose(){this.cancelBoxSelect(),this._onUserSelectionChange=new n.EventDispatcher,this._onUserSelectionUpdate=new n.EventDispatcher}createSelectBox(e){var t=new THREE.LineBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1}),i=this.createBoxGeometry(e);return new THREE.Line(i,t)}createBoxGeometry(e){var t={x:e.min.x,y:e.min.y},i={x:e.max.x,y:e.max.y},r={x:e.max.x,y:e.min.y},s={x:e.min.x,y:e.max.y};let a=new THREE.Geometry;return a.vertices.push(new THREE.Vector3(t.x,t.y,0),new THREE.Vector3(s.x,s.y,0),new THREE.Vector3(i.x,i.y,0),new THREE.Vector3(r.x,r.y,0),new THREE.Vector3(t.x,t.y,0)),a}})}}}),System.register("engine/sound/EvaSpecs",["game/SideType"],function(t,e){"use strict";var n,o,i;e&&e.id;return{setters:[function(e){n=e}],execute:function(){var e;(e=o=o||{})[e.Low=0]="Low",e[e.Normal=1]="Normal",e[e.Important=2]="Important",e[e.Critical=3]="Critical",t("EvaPriority",o),t("EvaSpecs",i=class{constructor(e){this.sideType=e,this.specs=new Map}readIni(t){let e=t.getSection("DialogList");if(!e)throw new Error("Missing eva.ini [DialogList] section");var i,r,s=new Set(e.entries.values()),a=this.sideType===n.SideType.GDI?"Allied":"Russian";for(i of s)if(i){let e=t.getSection(i);e?(r={text:e.getString("Text"),sound:e.getString(a),priority:e.getEnum("Priority",o,o.Normal,!0),queue:"queue"===e.getString("Type").trim().toLowerCase()},this.specs.set(i,r)):console.warn(`Missing eva section [${i}]`)}return this}getSpec(e){return this.specs.get(e)}})}}}),System.register("engine/sound/Eva",["engine/sound/ChannelType"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("Eva",i=class{constructor(e,t,i){this.evaSpecs=e,this.sound=t,this.renderer=i,this.evaWaitingList=[],this.lastEvaEventBySpec=new Map,this.handleFrame=t=>{var e,i;this.currentEvaPlaying?.isPlaying()?this.evaWaitingList=this.evaWaitingList.filter(e=>e.queue):(this.currentEvaPlaying=void 0,this.evaWaitingList.sort((e,t)=>t.priority-e.priority),this.evaWaitingList=this.evaWaitingList.filter(e=>5e3<=t-(this.lastEvaEventBySpec.get(e)||0)),this.evaWaitingList.length&&(e=this.evaWaitingList.shift(),(i=this.sound.getWavFile(e.sound))&&(this.currentEvaPlaying=this.sound.audioSystem.playWavFile(i,r.ChannelType.Voice),this.lastEvaEventBySpec.set(e,t),this.evaWaitingList.splice(1))))}}init(){this.renderer.onFrame.subscribe(this.handleFrame)}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.currentEvaPlaying?.stop()}play(e,t=!1){let i=this.evaSpecs.getSpec(e);i?(t&&(i={...i,queue:!0}),this.evaWaitingList.push(i)):console.warn(`No EVA with name ${e} was found. Skipping.`)}})}}}),System.register("game/event/InsufficientFundsEvent",["game/event/EventType"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("InsufficientFundsEvent",r=class{constructor(e){this.target=e,this.type=i.EventType.InsufficientFunds}})}}}),System.register("gui/screen/game/SoundHandler",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","util/disposable/CompositeDisposable","game/event/EventType","util/math","gui/screen/game/worldInteraction/UnitSelectionHandler","util/typeGuard","game/gameobject/Building","game/rules/TechnoRules","util/array","game/rules/general/RadarRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/Coords","game/event/AllianceChangeEvent","game/gameobject/unit/VeteranLevel","game/order/OrderFeedbackType","game/gameopts/constants","game/gameobject/common/DeathType","game/WeaponType","game/gameobject/unit/ZoneType","game/type/SuperWeaponType","game/gameobject/infantry/StanceType","game/type/PowerupType","game/gameobject/unit/HealthLevel","game/trait/StalemateDetectTrait"],function(e,t){"use strict";var a,N,L,l,D,F,o,c,_,U,i,H,r,s,G,V,W,n,z,K,q,$,h,Q,Z,u,Y,X,J,ee,te,ie,re,se,d;t&&t.id;return{setters:[function(e){a=e},function(e){N=e},function(e){L=e},function(e){l=e},function(e){D=e},function(e){F=e},function(e){o=e},function(e){c=e},function(e){_=e},function(e){U=e},function(e){i=e},function(e){H=e},function(e){r=e},function(e){s=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){n=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){h=e},function(e){Q=e},function(e){Z=e},function(e){u=e},function(e){Y=e}],execute:function(){X=(new Map).set(h.SuperWeaponType.MultiMissile,"EVA_NuclearSiloDetected").set(h.SuperWeaponType.IronCurtain,"EVA_IronCurtainDetected").set(h.SuperWeaponType.ChronoSphere,"EVA_ChronosphereDetected").set(h.SuperWeaponType.LightningStorm,"EVA_WeatherDeviceReady"),J=(new Map).set(h.SuperWeaponType.MultiMissile,"EVA_NuclearMissileReady").set(h.SuperWeaponType.IronCurtain,"EVA_IronCurtainReady").set(h.SuperWeaponType.ChronoSphere,"EVA_ChronosphereReady").set(h.SuperWeaponType.LightningStorm,"EVA_LightningStormReady").set(h.SuperWeaponType.ParaDrop,"EVA_ReinforcementsReady").set(h.SuperWeaponType.AmerParaDrop,"EVA_ReinforcementsReady"),ee=(new Map).set(h.SuperWeaponType.MultiMissile,"EVA_NuclearMissileLaunched").set(h.SuperWeaponType.IronCurtain,"EVA_IronCurtainActivated").set(h.SuperWeaponType.ChronoSphere,"EVA_ChronosphereActivated").set(h.SuperWeaponType.LightningStorm,"EVA_LightningStormCreated"),te=(new Map).set(h.SuperWeaponType.MultiMissile,N.SoundKey.DigSound),ie=(new Map).set(h.SuperWeaponType.LightningStorm,"TXT_LIGHTNING_STORM_APPROACHING"),re=new Map([[Z.PowerupType.Veteran,N.SoundKey.CratePromoteSound],[Z.PowerupType.Money,N.SoundKey.CrateMoneySound],[Z.PowerupType.Reveal,N.SoundKey.CrateRevealSound],[Z.PowerupType.Firepower,N.SoundKey.CrateFireSound],[Z.PowerupType.Armor,N.SoundKey.CrateArmourSound],[Z.PowerupType.Speed,N.SoundKey.CrateSpeedSound],[Z.PowerupType.Unit,N.SoundKey.CrateUnitSound]]),se=new Map([[Z.PowerupType.Armor,"EVA_UnitArmorUpgraded"],[Z.PowerupType.Firepower,"EVA_UnitFirePowerUpgraded"],[Z.PowerupType.Speed,"EVA_UnitSpeedUpgraded"]]),e("SoundHandler",d=class{constructor(e,t,i,r,s,a,n,o){this.game=e,this.worldSound=t,this.eva=i,this.sound=r,this.gameEvents=s,this.messageList=a,this.strings=n,this.player=o,this.lastAvailableObjectNames=[],this.lastQueueStatuses=new Map,this.triggerSoundHandles=new Map,this.disposables=new l.CompositeDisposable}init(){this.disposables.add(this.gameEvents.subscribe(e=>this.handleGameEvent(e)))}dispose(){this.disposables.dispose()}handleGameEvent(r){switch(r.type){case D.EventType.Cheer:this.sound.play(N.SoundKey.CheerSound,L.ChannelType.Effect);break;case D.EventType.UnitDeployUndeploy:var t="undeploy"===r.deployType,i=r.unit,t=t?i.rules.undeploySound:i.rules.deploySound;t&&this.worldSound.playEffect(t,i,i.owner);break;case D.EventType.ObjectTeleport:t=r;t.isChronoshift&&(t.target.rules.chronoInSound&&this.worldSound.playEffect(t.target.rules.chronoInSound,t.target,t.target.owner),t.target.rules.chronoOutSound&&(i=G.Coords.tile3dToWorld(t.prevTile.rx+.5,t.prevTile.ry+.5,t.prevTile.z),this.worldSound.playEffect(t.target.rules.chronoOutSound,i,t.target.owner)));break;case D.EventType.WeaponFire:var s=r.weapon,a=r.gameObject;if(s.type===q.WeaponType.DeathWeapon&&a.isCrashing)break;var n=s.rules.report;n.length&&(o=r.weapon.warhead.rules.electricAssault?.25:1,this.worldSound.playEffect(n[F.getRandomInt(0,n.length-1)],a.position.worldPosition,a.owner,o));break;case D.EventType.InflictDamage:{let e=r;s=e.target.healthTrait.health;if(s&&e.target.isTechno())if(e.target.isBuilding()){if(e.target.wallTrait)break;var n=e.damageHitPoints/e.target.healthTrait.maxHitPoints*100,a=this.game.rules.audioVisual,o=100*a.conditionRed,a=100*a.conditionYellow;(s<=a&&a<s+n||s<=o&&o<s+n)&&this.worldSound.playEffect(N.SoundKey.BuildingDamageSound,e.target,e.target.owner)}else{var l=e.target.rules.voiceFeedback;e.target.owner===this.player&&l&&.9<Math.random()&&this.worldSound.playEffect(l,e.target,e.target.owner)}}break;case D.EventType.RadarEvent:l=r;if(l.radarEventType===H.RadarEventType.BaseUnderAttack)l.target===this.player?(this.eva.play("EVA_OurBaseIsUnderAttack"),this.sound.play(N.SoundKey.BaseUnderAttackSound,L.ChannelType.Effect)):this.player&&this.game.alliances.areAllied(this.player,l.target)&&(this.eva.play("EVA_OurAllyIsUnderAttack"),this.sound.play(N.SoundKey.BaseUnderAttackSound,L.ChannelType.Effect));else if(l.radarEventType===H.RadarEventType.HarvesterUnderAttack)l.target===this.player&&this.eva.play("EVA_OreMinerUnderAttack");else if(l.radarEventType===H.RadarEventType.EnemyObjectSensed&&l.target===this.player){let e=this.game.map.getGroundObjectsOnTile(l.tile).find(e=>e.isBuilding()&&e.superWeaponTrait);e&&(void 0===(u=e.superWeaponTrait?.getSuperWeapon(e)?.rules.type)||(d=X.get(u))&&this.eva.play(d))}break;case D.EventType.SuperWeaponReady:var c=r.target;c.owner!==this.player||(h=void 0!==c.rules.type?J.get(c.rules.type):void 0)&&this.eva.play(h);break;case D.EventType.SuperWeaponActivate:var h,u=r.target,d=r.owner;r.noSfxWarning||((c=ee.get(u))&&this.eva.play(c,!0),(h=te.get(u))&&(c=r.atTile,this.worldSound.playEffect(h,G.Coords.tile3dToWorld(c.rx,c.ry,c.z),d)));u=ie.get(u);u&&this.messageList.addSystemMessage(this.strings.get(u),this.player??"grey");break;case D.EventType.LightningStormManifest:this.messageList.addSystemMessage(this.strings.get("TXT_LIGHTNING_STORM"),this.player??"grey");var g=r.target;this.worldSound.playEffect(N.SoundKey.StormSound,G.Coords.tile3dToWorld(g.rx,g.ry,g.z));break;case D.EventType.WarheadDetonate:r.isLightningStrike&&this.worldSound.playEffect(N.SoundKey.LightningSounds,r.position);break;case D.EventType.ObjectLiftOff:var p=r.gameObject,g=p.rules.auxSound1;g&&this.worldSound.playEffect(g,p,p.owner);break;case D.EventType.ObjectLand:var m=r.gameObject,p=m.rules.auxSound2;p&&this.worldSound.playEffect(p,m,m.owner);break;case D.EventType.ObjectCrashing:var f=r.gameObject,m=f.rules.crashingSound;m&&this.worldSound.playEffect(m,f.position.worldPosition,f.owner),f.owner!==this.player||(m=f.rules.voiceCrashing)&&this.worldSound.playEffect(m,f.position.worldPosition,f.owner);break;case D.EventType.ObjectDestroy:{let t=r.target,i=void 0;if(t.isUnit()&&!t.isInfantry()&&t.isCrashing?i=t.zone===$.ZoneType.Water?this.game.rules.audioVisual.impactWaterSound:t.rules.impactLandSound??this.game.rules.audioVisual.impactLandSound:t.deathType===K.DeathType.Temporal||t.deathType===K.DeathType.None?i=void 0:t.deathType===K.DeathType.Crush?i=t.rules.crushSound:t.isVehicle()&&t.zone===$.ZoneType.Water&&t.isSinker?i=N.SoundKey.SinkingSound:t.isTechno()?(i=t.rules.dieSound,!i&&t.isBuilding()&&(i=N.SoundKey.BuildingDieSound)):t.isProjectile()&&(t.fromWeapon.warhead.rules.ivanBomb?i=N.SoundKey.BombAttachSound:t.fromWeapon.warhead.rules.mindControl&&(i=N.SoundKey.YuriMindControlSound)),i){let e;t.isTechno()?e=t.owner:t.isProjectile()&&(e=t.fromPlayer),this.worldSound.playEffect(i,t.position.worldPosition,e)}t.isUnit()&&!t.rules.spawned&&t.owner===this.player&&this.eva.play("EVA_UnitLost")}break;case D.EventType.ObjectSpawn:{let e=r.gameObject;e.isTechno()&&e.rules.createSound&&this.worldSound.playEffect(e.rules.createSound,e,e.owner),e.isInfantry()&&e.stance===Q.StanceType.Paradrop&&this.worldSound.playEffect(N.SoundKey.ChuteSound,e,e.owner)}break;case D.EventType.ObjectUnspawn:{let e=r.gameObject;e.isBuilding()&&e.rules.spySat&&this.worldSound.playEffect(N.SoundKey.SpySatDeactivationSound,e,e.owner)}break;case D.EventType.ObjectMorph:let e=r.to;e.isBuilding()&&this.worldSound.playEffect(N.SoundKey.BuildingDrop,e,e.owner);break;case D.EventType.ShipSubmergeChange:this.worldSound.playEffect(N.SoundKey.CloakSound,r.target,r.target.owner);break;case D.EventType.BridgeRepair:r.source===this.player&&this.eva.play("EVA_BridgeRepaired");break;case D.EventType.BuildStatusChange:var y=r.target;r.status===_.BuildStatus.BuildDown&&(this.worldSound.playEffect(N.SoundKey.SellSound,y.position.worldPosition,y.owner),!y.poweredTrait||(f=y.rules.notWorkingSound)&&this.worldSound.playEffect(f,y,y.owner));break;case D.EventType.BuildingPlace:y=r.target;this.worldSound.playEffect(N.SoundKey.BuildingSlam,y,y.owner),y.rules.spySat&&this.worldSound.playEffect(N.SoundKey.SpySatActivationSound,y,y.owner);break;case D.EventType.BuildingFailedPlace:this.player===r.player&&this.eva.play("EVA_CannotDeployHere");break;case D.EventType.BuildingSell:var T=r.target;T.rules.wall&&this.worldSound.playEffect(N.SoundKey.SellSound,T.position.worldPosition,T.owner),this.player===T.owner&&this.eva.play("EVA_StructureSold");break;case D.EventType.BuildingRepairFull:var T=r.target,v=r.source;v===this.player&&this.worldSound.playEffect(N.SoundKey.BuildingRepairedSound,T,v);break;case D.EventType.BuildingCapture:var b=r.target;b.owner===this.player&&this.eva.play(b.rules.needsEngineer?"EVA_TechBuildingCaptured":"EVA_BuildingCaptured");break;case D.EventType.BuildingInfiltration:v=r.source,b=r.target;if(!this.player||this.player.isObserver||b.owner===this.player||v.owner===this.player){v=b.owner===this.player;b.rules.radar||v||this.eva.play("EVA_BuildingInfiltrated");let e;b.rules.radar&&(e=v?"EVA_RadarSabotaged":"EVA_BuildingInfRadarSabotaged"),0<b.rules.power&&(e=v?"EVA_PowerSabotaged":"EVA_EnemyBasePoweredDown"),b.rules.storage&&(e=v?"EVA_CashStolen":"EVA_BuildingInfCashStolen"),(this.game.rules.ai.buildTech.includes(b.name)||[U.FactoryType.InfantryType,U.FactoryType.UnitType].includes(b.factoryTrait?.type))&&(e=v?"EVA_TechnologyStolen":"EVA_NewTechnologyAcquired"),e&&this.eva.play(e)}break;case D.EventType.BuildingGarrison:var S=r.target;this.worldSound.playEffect(N.SoundKey.BuildingGarrisonedSound,S,S.owner),S.owner===this.player&&this.eva.play("EVA_StructureGarrisoned");break;case D.EventType.BuildingEvacuate:r.player===this.player&&this.eva.play("EVA_StructureAbandoned");break;case D.EventType.BuildingRepairStart:case D.EventType.UnitRepairStart:r.target.owner===this.player&&this.eva.play("EVA_Repairing");break;case D.EventType.UnitRepairFinish:S=r.target;S.owner===this.player&&(this.eva.play("EVA_UnitRepaired"),r.from.rules.hospital&&this.worldSound.playEffect(this.game.rules.crateRules.healCrateSound,S,S.owner));break;case D.EventType.PlayerDefeated:var w=r.target;w===this.player||w.resigned||(C=w.isAi?this.strings.get(z.aiUiNames.get(w.aiDifficulty)):w.name,this.eva.play("EVA_PlayerDefeated"),this.messageList.addSystemMessage(this.strings.get("TXT_PLAYER_DEFEATED",C),w));break;case D.EventType.PlayerResigned:this.eva.play("EVA_PlayerResigned");var C=r.target,w=C.isAi?this.strings.get(z.aiUiNames.get(C.aiDifficulty)):C.name;this.messageList.addSystemMessage(C.isObserver?this.strings.get("TXT_PLAYER_DEFEATED",w):this.strings.get("TXT_LEFT_GAME",w),C);break;case D.EventType.PlayerDropped:var E=r.target;this.messageList.addSystemMessage(this.strings.get("TXT_CONNECTION_LOST",E.name),"grey");break;case D.EventType.DeployNotAllowed:r.target.owner===this.player&&this.eva.play("EVA_CannotDeployHere");case D.EventType.PowerLow:r.target===this.player&&(this.eva.play("EVA_LowPower"),this.messageList.addSystemMessage(this.strings.get("TXT_LOW_POWER"),this.player));break;case D.EventType.RadarOnOff:r.target===this.player&&(x=r.radarEnabled,this.sound.play(x?N.SoundKey.RadarOn:N.SoundKey.RadarOff,L.ChannelType.Effect));break;case D.EventType.InsufficientFunds:r.target===this.player&&this.eva.play("EVA_InsufficientFunds");break;case D.EventType.RallyPointChange:r.target.owner===this.player&&this.eva.play("EVA_NewRallyPointEstablished");break;case D.EventType.PrimaryFactoryChange:r.target.owner===this.player&&this.eva.play("EVA_PrimaryBuildingSelected");break;case D.EventType.AllianceChange:{let e=r.alliance;var E=r.changeType,x=r.from;E===V.AllianceEventType.Formed?(!this.player||this.player.isObserver||e.players.has(this.player)||this.game.alliances.areAllied(this.player,e.players.first)&&this.game.alliances.areAllied(this.player,e.players.second)?this.eva.play("EVA_AllianceFormed"):this.eva.play("EVA_EnemyAllianceFormed"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",e.players.second.name,e.players.first.name),"white")):E===V.AllianceEventType.Requested?(this.player===e.players.first?this.eva.play("EVA_RequestingAlliance"):this.player===e.players.second&&this.eva.play("EVA_AllianceRequested"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",e.players.first.name,e.players.second.name),"lightgrey")):E===V.AllianceEventType.Broken&&(this.eva.play("EVA_AllianceBroken"),this.messageList.addSystemMessage(this.strings.get("TXT_AT_WAR",x.name,(x===e.players.first?e.players.second:e.players.first).name),"white"))}break;case D.EventType.UnitPromote:r.target.owner===this.player&&(this.sound.play(r.target.veteranLevel===W.VeteranLevel.Elite?N.SoundKey.UpgradeEliteSound:N.SoundKey.UpgradeVeteranSound,L.ChannelType.Effect),this.eva.play("EVA_UnitPromoted",!0));break;case D.EventType.EnterTransport:var O=r.target,A=O.rules.enterTransportSound;A&&this.worldSound.playEffect(A,O,O.owner);break;case D.EventType.LeaveTransport:A=r.target,O=A.rules.leaveTransportSound;O&&this.worldSound.playEffect(O,A,A.owner);break;case D.EventType.UnitRecycle:var M=r.target,R=M.rules.dieSound;R&&this.worldSound.playEffect(R,M.position.worldPosition,M.owner);break;case D.EventType.CratePickup:{R=r;let e=re.get(R.target.type);e||R.target.type!==Z.PowerupType.HealBase||(e=this.game.rules.crateRules.healCrateSound);var P=se.get(R.target.type);this.player&&!this.player.isObserver&&R.player!==this.player&&!this.game.alliances.areAllied(R.player,this.player)||(e&&(M=G.Coords.tile3dToWorld(R.tile.rx,R.tile.ry,R.tile.z),this.worldSound.playEffect(e,M,R.player)),P&&this.eva.play(P))}break;case D.EventType.StalemateDetect:var I=Math.floor(Y.StalemateDetectTrait.graceMinutes);this.messageList.addSystemMessage(this.strings.get("TS:StalemateWarning",I),"white",20),this.eva.play(1<I?`EVA_${I}MinutesRemaining`:"EVA_1MinuteRemaining");break;case D.EventType.TriggerSoundFx:var k=r,P=k.tile;if(P){I=this.worldSound.playEffect(k.soundId,G.Coords.tile3dToWorld(P.rx,P.ry,P.z));if(I){let e=this.triggerSoundHandles.get(P);e||(e=[],this.triggerSoundHandles.set(P,e)),e.push(I)}}else this.sound.play(k.soundId,L.ChannelType.Effect);break;case D.EventType.TriggerStopSoundFx:var B=r.tile,k=this.triggerSoundHandles.get(B);if(k){for(var j of k)j.isPlaying()&&j.stop();this.triggerSoundHandles.delete(B)}break;case D.EventType.TriggerEva:this.eva.play(r.soundId);break;case D.EventType.TriggerText:B=r.label;this.messageList.addSystemMessage(this.strings.get(B),this.player??"grey")}}handleOrderPushed(t,i,r){var s=Date.now();if(!this.lastFeedbackTime||250<=s-this.lastFeedbackTime){let e=void 0;if(i===a.OrderType.Stop)e=N.SoundKey.StopSound;else if(i===a.OrderType.Guard)e=N.SoundKey.GuardSound;else if(i===a.OrderType.Scatter)e=N.SoundKey.ScatterSound;else switch(r){case n.OrderFeedbackType.Attack:e=t.rules.voiceAttack;break;case n.OrderFeedbackType.Move:e=t.rules.voiceMove;break;case n.OrderFeedbackType.Capture:e=t.rules.voiceCapture||t.rules.voiceSpecialAttack;break;case n.OrderFeedbackType.SpecialAttack:e=t.rules.voiceSpecialAttack;break;case n.OrderFeedbackType.Enter:e=t.rules.voiceEnter??t.rules.voiceMove;break;case n.OrderFeedbackType.None:}e&&(this.sound.play(e,L.ChannelType.Effect),this.lastFeedbackTime=s)}}handleSelectionChangeEvent({selection:i,queryType:r,veteranLevel:s,healthLevel:a}){if(!i.length||i[0].owner===this.player){var n,e=Date.now(),t=!this.lastFeedbackTime||250<=e-this.lastFeedbackTime;if(t&&(this.lastFeedbackTime=e),r){if(t){let e=i.map(e=>e.rules.voiceSelect).filter(c.isNotNullOrUndefined),t=new Map;e.forEach(e=>t.set(e,(t.get(e)??0)+1)),t.forEach((t,i)=>{var r=this.sound.getSoundSpec(i);if(r){var s=Math.min(r.limit,t);for(let e=0;e<s;e++)this.sound.play(i,L.ChannelType.Effect)}})}if(i.length||[o.QueryType.Veteran,o.QueryType.Health].includes(r)){let t;switch(r){case o.QueryType.OnScreen:t=this.strings.get("Msg:SelAcrossScreen");break;case o.QueryType.OnMap:t=this.strings.get("Msg:SelAcrossMap");break;case o.QueryType.Veteran:case o.QueryType.Health:if(!i.length&&(r===o.QueryType.Veteran&&void 0===s||r===o.QueryType.Health&&void 0===a)){t=this.strings.get("Msg:NavEmpty");break}let e;if(r===o.QueryType.Veteran)switch(s){case W.VeteranLevel.Elite:e=this.strings.get("Msg:Elite");break;case W.VeteranLevel.Veteran:e=this.strings.get("Msg:Veteran");break;case W.VeteranLevel.None:e=this.strings.get("Msg:LittleExperience")}else if(r===o.QueryType.Health)switch(a){case u.HealthLevel.Green:e=this.strings.get("Msg:Healthy");break;case u.HealthLevel.Yellow:e=this.strings.get("Msg:HeavilyDamaged");break;case u.HealthLevel.Red:e=this.strings.get("Msg:Critical")}void 0!==e&&(e=e.toUpperCase(),t=i.length?(n=i.reduce((e,t)=>e+t.rules.cost,0),this.strings.get("Msg:UnitsWorth",i.length,e,n)):this.strings.get("Msg:NoUnitsSel",e))}t&&this.messageList.addUiFeedbackMessage(t)}else this.messageList.addUiFeedbackMessage(this.strings.get("Msg:NothingSelected"))}else!t||(t=i.find(e=>e.rules.voiceSelect)?.rules.voiceSelect)&&this.sound.play(t,L.ChannelType.Effect)}}handleAvailableObjectsUpdate(e){var t=e.map(e=>e.name);!i.equals(this.lastAvailableObjectNames,t)&&t.length>this.lastAvailableObjectNames.length&&(this.lastAvailableObjectNames=t,this.eva.play("EVA_NewConstructionOptions"))}handleProductionQueueUpdate(e){var t=this.lastQueueStatuses.get(e.type);if(void 0===t||e.status!==t)switch(this.lastQueueStatuses.set(e.type,e.status),e.status){case r.QueueStatus.Ready:e.getFirst().rules.type===s.ObjectType.Building?this.eva.play("EVA_ConstructionComplete"):this.eva.play("EVA_UnitReady");break;case r.QueueStatus.Active:e.getFirst().rules.type===s.ObjectType.Building?this.eva.play("EVA_Building"):t===r.QueueStatus.Idle&&this.eva.play("EVA_Training");break;case r.QueueStatus.OnHold:this.eva.play("EVA_OnHold")}}})}}}),System.register("gui/screen/game/worldInteraction/MapHoverHandler",["util/event","game/Coords"],function(e,t){"use strict";var a,n,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){e("MapHoverHandler",i=class{constructor(e,t,i,r,s){this.entityIntersectHelper=e,this.mapTileIntersectHelper=t,this.map=i,this.shroud=r,this.renderer=s,this._onHoverChange=new a.EventDispatcher,this.isActive=!1,this.needsUpdate=!1,this.onFrame=e=>{this.isActive&&(this.needsUpdate||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.needsUpdate=!1,this.lastUpdate=e,this.doUpdate())}}get onHoverChange(){return this._onHoverChange.asEvent()}getCurrentHover(){if(this.currentHoverTile)return this.currentHoverEntity?.gameObject.isDestroyed||this.currentHoverEntity?.gameObject.isCrashing?{entity:void 0,gameObject:void 0,tile:this.currentHoverTile}:{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}}update(e,t=!1){this.lastPointerPos=e,t?this.doUpdate():this.isActive||(this.isActive=!0,this.needsUpdate=!0,this.renderer.onFrame.subscribe(this.onFrame))}doUpdate(){let e=this.currentHoverEntity;var t=this.currentHoverTile,i=this.entityIntersectHelper.getEntityAtScreenPoint(this.lastPointerPos);if(i){this.currentHoverEntity=i.renderable;let e,t=i.renderable.gameObject;var r=t.getFoundation();t.isBuilding()&&(1<r.width||1<r.height)?e=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos):t.isTechno()&&!t.art.isVoxel?e=t.tile:(s=new THREE.Vector2(i.point.x,i.point.z).multiplyScalar(1/n.Coords.LEPTONS_PER_TILE).floor(),e=this.map.tiles.getByMapCoords(s.x,s.y),e||console.warn(`No tile exists at rx,ry="${JSON.stringify(s)}". Falling back to obj location.`)),e=e||t.tile;var s=this.map.tileOccupation.getBridgeOnTile(e);this.currentHoverEntity.gameObject.isOverlay()&&this.currentHoverEntity.gameObject.isBridge()&&!s&&(this.currentHoverEntity=void 0),this.currentHoverTile=e}else{this.currentHoverEntity=void 0;s=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos);this.currentHoverTile=s}this.shroud&&this.currentHoverTile&&this.shroud.isShrouded(this.currentHoverTile,this.currentHoverEntity?.gameObject.tileElevation)&&(this.currentHoverEntity=void 0),this.currentHoverEntity===e&&this.currentHoverTile===t||(e?.selectionModel?.setHover(!1),this.currentHoverEntity?.selectionModel?.setHover(!0),this.currentHoverTile&&this._onHoverChange.dispatch(this,{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}))}finish(){this.currentHoverEntity?.selectionModel?.setHover(!1),this.currentHoverEntity=void 0,this.currentHoverTile=void 0,this.isActive&&(this.renderer.onFrame.unsubscribe(this.onFrame),this.isActive=!1,this.needsUpdate=!1)}dispose(){this.finish()}})}}}),System.register("gui/screen/game/worldInteraction/DefaultActionHandler",["gui/PointerType","game/Coords","util/typeGuard","util/event","game/order/MoveOrder","game/order/orderPriorities","game/order/OrderFactory","game/order/AttackOrder","game/Target","game/order/AttackMoveOrder","game/order/OrderFeedbackType","game/order/GuardAreaOrder"],function(t,e){"use strict";var s,c,u,a,h,d,g,p,i,m,f,y,T,v,r;e&&e.id;return{setters:[function(e){s=e},function(e){c=e},function(e){u=e},function(e){a=e},function(e){h=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){i=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){var e;T=class{constructor(e,t,i,r=!1){this.game=e,this.unitSelectionHandler=t,this.currentPlayer=i,this.toggleSelect=r,this.force=!1,this.allowTypeSelect=!1,this.getPointerType=()=>s.PointerType.Select,this.isAllowed=()=>!0}setForce(e){return this.force=e,this}setTypeSelect(e){return this.allowTypeSelect=e,this}isValidTarget(e){if(!e?.isTechno())return!1;if(this.currentPlayer&&(e.isInfantry()||e.isVehicle())&&e.disguiseTrait?.hasTerrainDisguise()&&!this.game.alliances.haveSharedIntel(this.currentPlayer,e.owner))return!1;let t=this.unitSelectionHandler.getSelectedUnits();return!(!this.toggleSelect&&t.some(e=>e.isUnit())&&this.currentPlayer&&!this.currentPlayer.isObserver&&e.isTechno()&&!this.game.areFriendly(e,t[0])&&t[0].owner===this.currentPlayer)&&(e.rules.selectable&&(this.toggleSelect||this.force||this.allowTypeSelect&&1===t.length&&t[0]===e||!t.includes(e)))}execute(e){if(this.allowTypeSelect){var t=this.unitSelectionHandler.getSelectedUnits();if(1===t.length&&t[0]===e)return void this.unitSelectionHandler.selectByType()}this.toggleSelect?this.unitSelectionHandler.toggleSelection(e):this.unitSelectionHandler.selectSingleUnit(e)}},(e=v=v||{})[e.All=0]="All",e[e.SelectOnly=1]="SelectOnly",e[e.NoSelect=2]="NoSelect",t("ActionFilter",v),t("DefaultActionHandler",r=class{constructor(e,t,i,r){this.renderableManager=e,this.currentPlayer=t,this.audioVisualRules=i,this.tileOccupation=r,this._onOrder=new a.EventDispatcher}get onOrder(){return this._onOrder.asEvent()}static factory(e,t,i,r,s,a,n){let o=new this(e,r,n,s.tileOccupation);var l=new T(a,i,r);return o.selectAction=l,r&&!r.isObserver?(o.defaultActions=[...d.orderPriorities.map(e=>new g.OrderFactory(a,s).create(e,t)),l,new h.MoveOrder(a,s,t)],o.selectToggleAction=new T(a,i,r,!0),o.forceMoveAction=new h.MoveOrder(a,s,t,!0),o.forceAttackAction=new p.AttackOrder(a,{forceAttack:!0}),o.attackMoveAction=new m.AttackMoveOrder(a,s),o.guardAreaAction=new y.GuardAreaOrder(a,!0),o.specialActions=[o.selectToggleAction,o.forceMoveAction,o.forceAttackAction,o.attackMoveAction,o.guardAreaAction]):(o.defaultActions=[l],o.specialActions=[]),o}createOrderTarget(e){return new i.Target(e.gameObject,e.tile,this.tileOccupation)}getDefaultAction(e,t,i,r,s,a,n,o,l){var c=i.gameObject;let h=this.selectAction;if(h.setForce(a).setTypeSelect(!1),!e||e.owner!==this.currentPlayer||e.rules.spawned)return!l&&s!==v.NoSelect&&h.isValidTarget(c)?h:void 0;if(s!==v.NoSelect&&!l&&o?.shiftKey&&!o?.ctrlKey&&this.selectToggleAction?.isValidTarget(c))return this.selectToggleAction;if(s===v.SelectOnly)return!l&&h.setTypeSelect(n).isValidTarget(c)?h:void 0;var u,d=t.every(e=>e.warpedOutTrait.isActive());if(o?.ctrlKey&&!d)if(o.shiftKey){if(this.attackMoveAction?.set(e,r).isValid())return this.attackMoveAction}else if(o.altKey){if(this.guardAreaAction?.set(e,r).isValid())return this.guardAreaAction}else if(this.forceAttackAction?.set(e,r).isValid())return this.forceAttackAction;if(o?.altKey&&!d&&this.forceMoveAction?.set(e,r).isValid())return this.forceMoveAction;for(u of this.defaultActions.values())if(u instanceof T){if(s!==v.NoSelect&&!l&&u.setForce(a).setTypeSelect(!1).isValidTarget(c))return u}else if(!d&&(!l||u.minimapAllowed)&&!(u.singleSelectionRequired&&1<t.length)&&u.set(e,r).isValid())return u;return l&&!d&&this.forceMoveAction?.set(e,r).isValid()?this.forceMoveAction:void 0}updateMostSignificantAction(i,r,s,a,n,o,l,c){if(!i.length)return this.getDefaultAction(void 0,i,r,s,a,n,o,l,c);let e=i.map(e=>{var t=this.getDefaultAction(e,i,r,s,a,n,o,l,c);if(t)return{unit:e,action:t}}).filter(u.isNotNullOrUndefined),h=[...this.specialActions.values()];return e.length?e.reduce((e,t)=>!e||h.includes(t.action)||this.defaultActions.indexOf(t.action)<this.defaultActions.indexOf(e)||!(e instanceof T)&&e.sourceObject.rules.leadershipRating<t.unit.rules.leadershipRating&&this.defaultActions.indexOf(t.action)===this.defaultActions.indexOf(e)?t.action instanceof T?t.action:t.action.set(t.unit,s):e,void 0):void 0}getPointerType(e){if(this.mostSignificantAction instanceof T)return this.mostSignificantAction.getPointerType();if(!this.currentSelected||!this.mostSignificantAction)return e?s.PointerType.Mini:s.PointerType.Default;if(!this.mostSignificantAction.isAllowed()){var t,i=this.mostSignificantAction.sourceObject;for(t of this.currentSelected)if(this.mostSignificantAction.set(t,this.currentTarget),this.mostSignificantAction.isValid()&&this.mostSignificantAction.isAllowed())return this.mostSignificantAction.getPointerType(e,this.currentSelected);this.mostSignificantAction.set(i,this.currentTarget)}return this.mostSignificantAction.getPointerType(e,this.currentSelected)}update(e,t,i,r,s=!1){var a=this.currentTarget=this.createOrderTarget(e);this.currentSelected=t,this.mostSignificantAction=this.updateMostSignificantAction(t,e,a,v.All,i,!1,r,s)}execute(e,t,i,r,s,a,n=!1){let o=this.currentTarget=this.createOrderTarget(e);if(this.currentSelected=t,this.mostSignificantAction=this.updateMostSignificantAction(t,e,o,i,r,s,a,n),this.mostSignificantAction){var l=this.mostSignificantAction.isAllowed();return l&&(this.mostSignificantAction instanceof h.MoveOrder||this.mostSignificantAction instanceof m.AttackMoveOrder&&!o.obj?.isTechno()||this.mostSignificantAction instanceof y.GuardAreaOrder?this.renderableManager.createTransientAnim(this.audioVisualRules.moveFlash,e=>{e.setPosition(c.Coords.tile3dToWorld(o.tile.rx+.5,o.tile.ry+.5,o.tile.z+(o.getBridge()?.tileElevation??0)))}):this.mostSignificantAction instanceof T||t.includes(e.gameObject)||e.entity?.highlight?.()),this.mostSignificantAction instanceof T?this.mostSignificantAction.execute(e.gameObject):this._onOrder.dispatch(this,{orderType:this.mostSignificantAction.orderType,terminal:this.mostSignificantAction.terminal,feedbackType:l?this.mostSignificantAction.feedbackType:f.OrderFeedbackType.None,feedbackUnit:l?this.mostSignificantAction.sourceObject:void 0,target:o}),!0}return!1}})}}}),System.register("gui/screen/game/worldInteraction/CameraPanHandler",["util/geometry","gui/PointerType","util/math"],function(e,t){"use strict";var a,n,o,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){e("CameraPanHandler",i=class{constructor(e,t,i,r,s){this.cameraPan=e,this.pointer=t,this.panRate=i,this.freeCamera=r,this.worldScene=s,this.isPanning=!1,this.paused=!1,this.stickyMode=!1,this.onFrame=e=>{if(!this.paused)if(this.isPanning&&(!this.lastUpdate||e-this.lastUpdate>=1e3/60))if(this.lastUpdate=e,this.panVector.x||this.panVector.y){var i=this.stickyMode?this.initialPan:this.cameraPan.getPan(),r=this.cameraPan.getPanLimits();let e={x:o.clamp(i.x+this.panVector.x,r.x,r.x+r.width),y:o.clamp(i.y+this.panVector.y,r.y,r.y+r.height)};this.freeCamera.value&&(e={x:i.x+this.panVector.x,y:i.y+this.panVector.y});var s=!a.pointEquals(e,i),r=this.panVector.x&&e.x===i.x,i=this.panVector.y&&e.y===i.y;let t=0;if(r||i){let e=new THREE.Vector2(r?Math.sign(this.panVector.x):0,i?Math.sign(this.panVector.y):0);t=1+(THREE.Math.radToDeg(e.angle())+90)%360/45}this.pointer.setPointerType(n.PointerType.Pan,t),s&&this.cameraPan.setPan({x:e.x,y:e.y}),this.isPanning=s}else this.pointer.setPointerType(n.PointerType.Pan)}}start(e){this.startPos=e,this.isPanning=!1,this.panVector=new THREE.Vector2(0,0),this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame)}update(e,t){var i;t?(this.initialPan||(this.initialPan=this.cameraPan.getPan()),this.panVector.x=this.startPos.x-e.x,this.panVector.y=this.startPos.y-e.y):(i=this.panRate.value/5*50,this.panVector.x=Math.floor(i*o.clamp(e.x-this.startPos.x,-300,300)/300),this.panVector.y=Math.floor(i*o.clamp(e.y-this.startPos.y,-300,300)/300)),this.isPanning=!0,this.stickyMode=t}finish(){this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.pointer.setPointerType(n.PointerType.Default),this.initialPan=void 0}setPaused(e){this.paused=e}dispose(){this.finish()}})}}}),System.register("gui/screen/game/worldInteraction/InteractionMode",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/MapScrollHandler",["util/geometry","util/math","gui/PointerType"],function(e,t){"use strict";var o,l,c,i;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("MapScrollHandler",i=class{constructor(e,t,i,r,s){this.canvas=e,this.cameraPan=t,this.pointer=i,this.scrollRate=r,this.worldScene=s,this.isActive=!1,this.paused=!1,this.forceScrollCancelRequested=!1,this.onFrame=r=>{if(!this.paused)if(this.isActive&&(!this.lastUpdate||r-this.lastUpdate>=1e3/60)){this.lastUpdate=r;var s=this.cameraPan.getPan(),a=this.cameraPan.getPanLimits();let e,t=!1;(this.panDirection?.x||this.panDirection?.y)&&(n=this.scrollRate.value/5*20,e={x:l.clamp(s.x+this.panDirection.x*n,a.x,a.x+a.width),y:l.clamp(s.y+this.panDirection.y*n,a.y,a.y+a.height)},n=!o.pointEquals(e,s),this.pointer.setPointerType(n?c.PointerType.Scroll:c.PointerType.NoScroll,this.pointerFrameNo),n&&(t=!0));var n=this.forceScrollDirection;let i=!1;n&&(e={x:l.clamp(s.x+20*n.x,a.x,a.x+a.width),y:l.clamp(s.y+20*n.y,a.y,a.y+a.height)},o.pointEquals(e,s)||(i=!0)),this.isActive=t||i,e&&this.cameraPan.setPan({x:e.x,y:e.y}),this.isActive||this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.forceScrollCancelRequested&&(this.forceScrollCancelRequested=!1,this.forceScrollDirection=void 0)}}}isScrolling(){return!(!this.panDirection||!this.panDirection.x&&!this.panDirection.y)}requestForceScroll(e){this.forceScrollDirection=e,this.forceScrollCancelRequested=!1,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancelForceScroll(){this.forceScrollCancelRequested=!0}update(e){var t=this.canvas.height,i=this.canvas.width;let r=e.x<3?-1:e.x>i-1-3?1:0,s=e.y<3?-1:e.y>t-1-3?1:0;r?e.y<Math.min(300,t/3)?s=-1:e.y>Math.max(t-300,2*t/3)&&(s=1):s&&(e.x<Math.min(300,i/3)?r=-1:e.x>Math.max(i-300,2*i/3)&&(r=1)),this.panDirection=new THREE.Vector2(r,s),this.pointerFrameNo=(THREE.Math.radToDeg(this.panDirection.angle())+90)%360/45,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancel(){this.cancelForceScroll(),this.isActive&&(this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.isActive=!1)}setPaused(e){this.paused=e}dispose(){this.cancel()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommand",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.KeyDown=0]="KeyDown",e[e.KeyUp=1]="KeyUp",e[e.KeyDownUp=2]="KeyDownUp",t("TriggerMode",i)}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyboardHandler",["gui/screen/game/worldInteraction/keyboard/KeyCommandType","gui/screen/game/worldInteraction/keyboard/KeyCommand"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("KeyboardHandler",s=class s{constructor(e,t){this.keyBinds=e,this.devMode=t,this.commands=new Map,this.isPaused=!1}registerCommand(e,t){if(this.commands.has(e))throw new Error("Duplicate command "+e);this.commands.set(e,t)}unregisterCommand(e){this.commands.delete(e)}handleKeyDown(i){if("Backspace"===i.key&&(i.preventDefault(),i.stopPropagation()),!(i.repeat||["F5","F12"].includes(i.key)&&this.devMode)){let t=this.keyBinds.getCommandType(i);if(void 0===t&&(t=this.getNoModCmdType(i.keyCode)),void 0!==t){i.preventDefault(),i.stopPropagation();let e=this.commands.get(t);e&&!this.isPaused&&("function"==typeof e?e():e.triggerMode!==r.TriggerMode.KeyUp&&e.execute(!1))}}}handleKeyUp(e){if("Alt"===e.key)e.preventDefault(),e.stopPropagation();else if(!this.isPaused){let t=this.keyBinds.getCommandType(e);if(void 0===t&&(t=this.getNoModCmdType(e.keyCode)),void 0!==t){let e=this.commands.get(t);!e||"function"==typeof e||e.triggerMode!==r.TriggerMode.KeyUp&&e.triggerMode!==r.TriggerMode.KeyDownUp||e.execute(!0)}}}getNoModCmdType(e){var t=this.keyBinds.getCommandType({keyCode:e,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(t){var i=this.commands.get(t);if(i&&"function"!=typeof i&&s.anyModifierCommands.includes(t))return t}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}dispose(){this.commands.clear()}}),s.anyModifierCommands=[i.KeyCommandType.PlanningMode]}}}),System.register("engine/renderable/entity/TargetLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","game/gameobject/unit/ZoneType"],function(e,t){"use strict";var h,u,d,i;t&&t.id;return{setters:[function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("TargetLines",i=class{constructor(e,t,i,r,s){this.currentPlayer=e,this.unitSelection=t,this.camera=i,this.debugPaths=r,this.enabled=s,this.unitPaths=new Map,this.unitLines=new Map,this.lineHeadGeometry=new THREE.PlaneGeometry(3*h.Coords.ISO_WORLD_SCALE,3*h.Coords.ISO_WORLD_SCALE)}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="target_lines",this.obj.matrixAutoUpdate=!1,this.attackLineMaterial=new THREE.LineBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineMaterial=new THREE.LineBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}),this.attackLineHeadMaterial=new THREE.MeshBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineHeadMaterial=new THREE.MeshBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}))}get3DObject(){return this.obj}forceShow(){this.selectionHash=void 0}update(n){if(this.obj.visible=this.enabled.value,this.enabled.value){var e=this.unitSelection.getHash();if(void 0===this.selectionHash||this.selectionHash!==e)return this.selectionHash=e,this.hideAllLines(),this.unitPaths.clear(),this.disposeUnitLines(),void this.unitSelection.getSelectedUnits().forEach(e=>{!e.isUnit()||this.currentPlayer&&e.owner!==this.currentPlayer||(this.unitPaths.set(e,u.cloneConfig(e.unitOrderTrait.targetLinesConfig)),this.updateLines(e),e.zone!==d.ZoneType.Air&&!u.configHasTarget(e.unitOrderTrait.targetLinesConfig)||this.showLines(e,n))});{let t=!1;if(this.unitSelection.getSelectedUnits().forEach(e=>{if(e.isUnit()&&(!this.currentPlayer||e.owner===this.currentPlayer)){this.unitPaths.has(e)&&u.configsAreEqual(this.unitPaths.get(e),e.unitOrderTrait.targetLinesConfig)||e.unitOrderTrait.targetLinesConfig?.isRecalc||(this.unitPaths.set(e,u.cloneConfig(e.unitOrderTrait.targetLinesConfig)),t=!0,this.updateLines(e),u.configHasTarget(e.unitOrderTrait.targetLinesConfig)&&this.showLines(e,n));let i=this.unitLines.get(e),r=e.position.worldPosition;if(i){var s=!r.equals(i.srcLineHead.position),a=e.unitOrderTrait.targetLinesConfig?.target;let t=a?a.position.worldPosition:void 0;a=t&&!t.equals(i.destLineHead.position);if(s||a){let e=i.line.geometry;e.verticesNeedUpdate=!0,s&&(e.vertices[e.vertices.length-1].copy(r),i.srcLineHead.position.copy(r),i.srcLineHead.updateMatrix()),t&&a&&(e.vertices[0].copy(t),i.destLineHead.position.copy(t),i.destLineHead.updateMatrix())}}}}),t)return}void 0!==this.showStart&&1e3<=n-this.showStart&&this.hideAllLines()}}showLines(e,t){this.showStart=t,this.unitLines.get(e).root.visible=!0}hideAllLines(){this.showStart=void 0,this.unitLines.forEach(e=>e.root.visible=!1)}updateLines(e){let t=e.unitOrderTrait.targetLinesConfig;if(!t||!u.configHasTarget(t)){if(e.zone!==d.ZoneType.Air)return void(this.unitLines.has(e)&&(s=this.unitLines.get(e),this.obj?.remove(s.root),this.disposeLineObjects(s),this.unitLines.delete(e)));t={pathNodes:[{tile:e.tile,onBridge:void 0},{tile:e.tile,onBridge:void 0}]}}let i=new THREE.Geometry,r=t.pathNodes;r.length?(this.debugPaths.value||(r=[r[0],r[r.length-1]]),r.forEach(e=>{var t=h.Coords.tile3dToWorld(e.tile.rx+.5,e.tile.ry+.5,e.tile.z+(e.onBridge?.tileElevation??0));i.vertices.push(t)}),i.vertices[i.vertices.length-1].copy(e.position.worldPosition)):(a=t.target,i.vertices.push(a.position.worldPosition,e.position.worldPosition));var s=!!t.isAttack,a=s?this.attackLineMaterial:this.moveLineMaterial;let n=new THREE.Line(i,a);n.matrixAutoUpdate=!1;let o=this.createLineHead(s);o.position.copy(i.vertices[i.vertices.length-1]),o.matrixAutoUpdate=!1,o.updateMatrix();let l=this.createLineHead(s);l.position.copy(i.vertices[0]),l.matrixAutoUpdate=!1,l.updateMatrix(),n.renderOrder=o.renderOrder=l.renderOrder=1e6;let c=new THREE.Object3D;c.matrixAutoUpdate=!1,c.visible=!1,c.add(n),c.add(o),c.add(l),this.unitLines.has(e)&&(s=this.unitLines.get(e),this.obj?.remove(s.root),this.disposeLineObjects(s)),this.unitLines.set(e,{root:c,line:n,srcLineHead:o,destLineHead:l}),this.obj?.add(c)}createLineHead(e){let t=new THREE.Mesh(this.lineHeadGeometry,e?this.attackLineHeadMaterial:this.moveLineHeadMaterial);var i=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return t.setRotationFromQuaternion(i),t}disposeUnitLines(){[...this.unitLines.values()].forEach(e=>this.disposeLineObjects(e)),this.unitLines.clear()}disposeLineObjects(e){e.line.geometry.dispose()}dispose(){this.disposeUnitLines(),this.attackLineMaterial?.dispose(),this.attackLineHeadMaterial?.dispose(),this.moveLineMaterial?.dispose(),this.moveLineHeadMaterial?.dispose(),this.lineHeadGeometry.dispose()}})}}}),System.register("engine/util/MapPanningHelper",["engine/IsoCoords"],function(e,t){"use strict";var r,i;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("MapPanningHelper",i=class{constructor(e){this.map=e}computeCameraPanFromTile(e,t){var i=this.map.tiles.getByMapCoords(e,t)??this.map.tiles.getPlaceholderTile(e,t),i=r.IsoCoords.tile3dToScreen(e+.5,t+.5,i.z);return this.computeCameraPanFromScreen(i)}computeCameraPanFromWorld(e){var t=r.IsoCoords.vecWorldToScreen(e);return this.computeCameraPanFromScreen(t)}computeCameraPanFromScreen(e){var t=this.getScreenPanOrigin();return{x:Math.floor(e.x-t.x),y:Math.floor(e.y-t.y)}}getScreenPanOrigin(){return r.IsoCoords.worldToScreen(0,0)}computeCameraPanLimits(e,t){var i=this.getScreenPanOrigin();return{x:Math.ceil(t.x-i.x+e.width/2),y:Math.ceil(t.y-i.y+e.height/2-1),width:t.width-e.width-1,height:t.height-e.height-1}}})}}}),System.register("gui/screen/game/worldInteraction/MinimapHandler",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MinimapHandler",i=class{constructor(e,t,i,r,s){this.minimap=e,this.map=t,this.shroud=i,this.worldScene=r,this.mapPanningHelper=s}panToTile(e){this.worldScene.cameraPan.setPan(this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry))}getHover(e){return{entity:void 0,gameObject:this.shroud?.isShrouded(e)?void 0:this.map.getObjectsOnTile(e).sort((e,t)=>Number(e.isTechno())-Number(t.isTechno())).shift(),tile:e}}})}}}),System.register("gui/screen/game/worldInteraction/ArrowScrollHandler",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ArrowScrollHandler",i=class{constructor(e){this.mapScrollHandler=e,this.isPaused=!1,this.scrollDir=new THREE.Vector2,this.pressedKeys=new Set}handleKeyDown(e){!this.isPaused&&["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&(e.preventDefault(),e.stopPropagation(),e.repeat||(this.pressedKeys.add(e.key),this.updateScrollDir(),this.mapScrollHandler.requestForceScroll(this.scrollDir)))}handleKeyUp(e){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&(e.preventDefault(),e.stopPropagation(),this.pressedKeys.delete(e.key),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll())}cancel(){this.pressedKeys.clear(),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll()}updateScrollDir(){this.scrollDir.set(0,0);for(var e of this.pressedKeys)switch(e){case"ArrowUp":--this.scrollDir.y;break;case"ArrowDown":this.scrollDir.y+=1;break;case"ArrowLeft":--this.scrollDir.x;break;case"ArrowRight":this.scrollDir.x+=1;break;default:throw new Error("Should never reach this line")}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}})}}}),System.register("gui/screen/game/ChatTypingHandler",["network/chat/ChatMessage","network/gservConfig"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ChatTypingHandler",s=class{constructor(e,t,i,r){this.keyboardHandler=e,this.arrowScrollHandler=t,this.messageList=i,this.chatHistory=r,this.isTyping=!1}startTyping(){this.isTyping||(this.keyboardHandler.pause(),this.arrowScrollHandler.pause(),this.messageList.isComposing=!0,this.isTyping=!0)}endTyping(){this.isTyping&&(this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1,this.isTyping=!1)}handleKeyDown(e){this.isTyping||("Enter"===e.key?this.startTyping():"Backspace"===e.key&&(this.chatHistory.lastComposeTarget.value={type:i.ChatRecipientType.Channel,name:r.RECIPIENT_TEAM},this.startTyping()))}handleKeyUp(e){}dispose(){this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1}})}}}),System.register("gui/screen/game/worldInteraction/Tooltip",["gui/UiObject","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(e,t){"use strict";var i,n,c,r;t&&t.id;return{setters:[function(e){i=e},function(e){n=e},function(e){c=e}],execute:function(){r=class extends i.UiObject{constructor(e,t,i,r){super(new THREE.Object3D),this.text=e,this.color=t,this.pointer=i,this.viewport=r}create3DObject(){if(!this.mesh){let e=this.get3DObject();var i=this.texture=this.createTexture(this.text,this.color),r={width:i.image.width,height:i.image.height};let t=this.mesh=this.createMesh(i,r.width,r.height);r=this.computePosition(this.pointer,this.viewport,r);t.position.x=r.x,t.position.y=r.y,e.add(t),t.updateMatrix()}super.create3DObject()}createMesh(e,t,i){let r=n.SpriteUtils.createRectGeometry(t,i);n.SpriteUtils.addRectUvs(r,{x:0,y:0,width:t,height:i},{width:t,height:i}),r.translate(t/2,i/2,0);var s=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});let a=new THREE.Mesh(r,s);return a.matrixAutoUpdate=!1,a.frustumCulled=!1,a}createTexture(e,t){let i=document.createElement("canvas");i.width=i.height=0;let r=i.getContext("2d"),s=0;for(var a of e.split("\n")){a=c.CanvasUtils.drawText(r,a,0,s,{color:t,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,autoEnlargeCanvas:!0});s+=a.height}var n=i.width,o=i.height,o=r.getImageData(0,0,n,o);i.width+=1,i.height+=1,r.putImageData(o,1,1),r.globalCompositeOperation="destination-over",r.fillStyle="black",r.fillRect(0,0,i.width,i.height),r.globalCompositeOperation="source-over",r.strokeStyle=t,r.strokeRect(.5,.5,i.width-1,i.height-1);let l=new THREE.Texture(i);return l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,l.flipY=!1,l}computePosition(e,t,i){let r={...e.getPosition()};return r.x+20+i.width>t.x+t.width?r.x-=20+i.width:r.x+=20,r.y+20+i.height>t.x+t.height?r.y-=20+i.height:r.y+=20,r}destroy(){super.destroy(),this.texture?.dispose(),this.mesh&&(this.mesh.material.dispose(),this.mesh.geometry.dispose())}},e("Tooltip",r)}}}),System.register("gui/screen/game/worldInteraction/TooltipHandler",["util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/Tooltip"],function(e,t){"use strict";var n,o,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){o=e}],execute:function(){l=class{equals(e){return(this.entity??this.uiObject)===(e.entity??e.uiObject)}copy(e){this.entity=e.entity,this.uiObject=e.uiObject}},e("TooltipHandler",c=class c{constructor(e,t,i,r,s,a){this.mapHoverHandler=e,this.textColor=t,this.pointer=i,this.uiScene=r,this.renderer=s,this.strings=a,this.disposables=new n.CompositeDisposable,this.currentHover=new l,this.lastHover=new l,this.isTouch=!1,this.needsHoverTimeReset=!1,this.paused=!1,this.handleUiMouseMove=e=>{var t=e.intersection?.object;let i=t;for(;void 0===i?.userData.tooltip&&(i=i?.parent,i););this.currentHover.uiObject=i??t,this.hoverStartTime&&(this.needsHoverTimeReset=!0),this.isTouch=e.isTouch},this.handleMouseDown=()=>{this.paused=!0,this.reset()},this.handleMouseUp=e=>{this.paused=!1,this.isTouch=e.isTouch},this.handleMouseWheel=()=>{this.reset()},this.onFrame=e=>{var t;(!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastUpdate=e,t=this.mapHoverHandler.getCurrentHover()?.entity,this.currentHover.entity=t,this.paused||(this.currentHover.equals(this.lastHover)?(this.needsHoverTimeReset&&(this.needsHoverTimeReset=!1,this.hoverStartTime=e),t=this.currentHover.entity?800:400,this.hoverStartTime&&e-this.hoverStartTime>t&&(!(t=this.getTooltipText(this.currentHover))||this.tooltip||this.isTouch||(this.tooltip=new o.Tooltip(t,this.textColor,this.pointer,this.uiScene.viewport),this.tooltip.setZIndex(c.ZINDEX),this.uiScene.add(this.tooltip)))):(this.lastHover.copy(this.currentHover),this.hoverStartTime=void 0,this.destroyTooltip(),void 0!==this.getTooltipText(this.currentHover)&&(this.hoverStartTime=e))))}}init(){this.disposables.add(this.pointer.pointerEvents.addEventListener(this.uiScene.get3DObject(),"mousemove",this.handleUiMouseMove)),this.disposables.add(this.pointer.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointer.pointerEvents.addEventListener("canvas","wheel",this.handleMouseWheel),this.pointer.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp)),this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame))}reset(){this.destroyTooltip(),this.hoverStartTime&&(this.needsHoverTimeReset=!0)}getTooltipText(t){let i;if(t.entity){let e=t.entity.getUiName?.();void 0!==e&&""!==e&&(-1!==e.indexOf("{")?i=e.replace(/\{([^}]+)\}/g,(e,t)=>this.strings.get(t)):this.strings.has(e)&&(i=this.strings.get(e)))}else t.uiObject&&(i=t.uiObject.userData.tooltip);return i}destroyTooltip(){this.tooltip&&(this.uiScene.remove(this.tooltip),this.tooltip?.destroy(),this.tooltip=void 0)}dispose(){this.disposables.dispose(),this.destroyTooltip()}}),c.ZINDEX=100}}}),System.register("util/userAgent",[],function(e,t){"use strict";t&&t.id;function i(){return navigator.platform.includes("Mac")}return e("isIpad",function(){return/iPad/i.test(navigator.userAgent)||/MacIntel/i.test(navigator.platform)&&!!navigator.maxTouchPoints}),e("isMac",i),e("isMacFirefox",function(){return i()&&-1!==navigator.userAgent.toLowerCase().indexOf("firefox")}),{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/WorldInteraction",["util/geometry","gui/PointerType","gui/screen/game/worldInteraction/DefaultActionHandler","util/userAgent"],function(e,t){"use strict";var T,v,b,i,r;t&&t.id;return{setters:[function(e){T=e},function(e){v=e},function(e){b=e},function(e){i=e}],execute:function(){0,e("WorldInteraction",r=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y){this.worldScene=e,this.pointer=t,this.pointerEvents=i,this.cameraPanHandler=r,this.mapScrollHandler=s,this.mapHoverHandler=a,this.tooltipHandler=n,this.unitSelectionHandler=o,this.defaultActionHandler=l,this.keyboardHandler=c,this.arrowScrollHandler=h,this.minimapHandler=u,this.cameraZoom=d,this.document=g,this.renderer=p,this.targetLines=m,this.rightClickMove=f,this.rightClickScroll=y,this.initialized=!1,this.enabled=!0,this.clickOrigin={x:0,y:0},this.maybePan=!1,this.hasDragged=!1,this.isMinimapHover=!1,this.clearModeOnSelectionChange=!1,this.handleSelectionChange=()=>{this.clearModeOnSelectionChange&&this.setMode(void 0)},this.handleKeyDown=e=>{this.handleKeyModifierChange(e),this.keyboardHandler.handleKeyDown(e),this.arrowScrollHandler.handleKeyDown(e),this.chatTypingHandler?.handleKeyDown(e)},this.handleKeyUp=e=>{this.handleKeyModifierChange(e),this.keyboardHandler.handleKeyUp(e),this.arrowScrollHandler.handleKeyUp(e),this.chatTypingHandler?.handleKeyUp(e),this.tooltipHandler.reset()},this.handleKeyModifierChange=e=>{var t=this.lastKeyboardEvent;this.lastKeyboardEvent=e,this.currentMode||this.maybePan&&this.hasDragged||this.mapScrollHandler.isScrolling()||e.repeat||e.shiftKey===t?.shiftKey&&e.ctrlKey===t?.ctrlKey&&e.altKey===t?.altKey||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),e)},this.handleMapHoverChange=e=>{this.currentMode?.hover(e,this.isMinimapHover),this.isMinimapHover||this.currentMode||this.updateDefaultAction(e,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyboardEvent)},this.handleMouseMove=e=>{this.queuedMouseMoveEvent=e},this.handleFrame=e=>{this.lastFrameTime=e;let t=!1;var i=this.unitSelectionHandler.getHash();i===this.lastSelectionHash||this.currentMode||(this.lastSelectionHash=i,t=!0);i=this.queuedMouseMoveEvent;i&&(this.queuedMouseMoveEvent=void 0,this.processMouseMove(i));(!this.lastDefaultActionUpdate||e-this.lastDefaultActionUpdate>=1e3/15)&&(this.lastDefaultActionUpdate=e,this.currentMode||this.mapScrollHandler.isScrolling()||this.hasDragged&&this.maybePan||(t=!0)),t&&this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),this.lastKeyboardEvent)},this.handleMouseDown=e=>{T.rectContainsPoint(this.worldScene.viewport,e.pointer)&&void 0===this.mousePressed&&(this.hasFaultyCtrlLeftClick&&e.ctrlKey&&2===e.button&&(e.button=0),this.mapScrollHandler.cancel(),this.pointerEvents.intersectionsEnabled=!1,this.clickOrigin=e.pointer,this.mousePressed=e.button,this.lastMouseDownEvent=e,this.hasDragged=!1,(2===e.button&&this.isRightClickPanAllowed()||1===e.button)&&(this.maybePan=!0,this.cameraPanHandler.start(e.pointer)),2===e.button&&(this.isRightClickPanAllowed()||this.isRightClickMove()||this.unitSelectionHandler.deselectAll(),this.chatTypingHandler?.endTyping()))},this.handleMouseUp=i=>{if(this.hasFaultyCtrlLeftClick&&i.ctrlKey&&2===i.button&&(i.button=0),this.mousePressed===i.button){this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0;var r=this.maybePan;if(this.maybePan=!1,r&&this.cameraPanHandler.finish(),r&&this.hasDragged)return this.mapHoverHandler.update(i.pointer,!0),void this.currentMode?.hover(this.getCurrentHover(),this.isMinimapHover);if(this.currentMode)0===i.button?(this.mapHoverHandler.update(i.pointer,!0),!1!==this.currentMode.execute(this.getCurrentHover(),this.isMinimapHover)&&(this.currentMode=void 0)):2===i.button&&this.isClickRange(i.pointer)&&(this.currentMode.cancel?.(),this.currentMode=void 0,this.pointer.setPointerType(v.PointerType.Default));else{let t=!1;if(0===i.button&&this.hasDragged&&(t=this.unitSelectionHandler.finishBoxSelect(i.pointer,!i.shiftKey),t||this.mapHoverHandler.update(i.pointer,!0)),0===i.button||2===i.button){var s=this.isRightClickMove(),a=i.button===(s?2:0),n=this.isClickRange(i.pointer);let e=!1;var o=n&&i.isTouch&&500<=i.timeStamp-this.lastMouseDownEvent.timeStamp;i.isTouch&&this.mapHoverHandler.update(i.pointer,!0);var l,c=this.mapHoverHandler.getCurrentHover();if(n&&(l=this.lastDefaultModeClickDetails,r={mouseUpEvent:i,hoverObject:c?.gameObject,selectionHash:this.unitSelectionHandler.getHash(),time:Date.now()},l&&(e=r.mouseUpEvent.button===l.mouseUpEvent.button&&r.hoverObject===l.hoverObject&&r.selectionHash===l.selectionHash&&r.time-l.time<500),this.lastDefaultModeClickDetails=e?void 0:r),!a&&(!s||!i.shiftKey||i.ctrlKey)&&(!s||!e)){if(!n)return;this.unitSelectionHandler.deselectAll()}t||!s&&!a||this.handleDefaultClickAction(s,a,e,o,i,c),this.lastDefaultModeClickDetails&&(this.lastDefaultModeClickDetails.selectionHash=this.unitSelectionHandler.getHash())}}}},this.handleWheel=e=>{this.cameraZoom.applyStep(0<e.wheelDeltaY?-.1:.1)},this.handleMinimapClick=e=>{let t=!1;var i,r=this.minimapHandler.getHover(e);this.currentMode?!1!==this.currentMode.execute(r,!0)&&(this.currentMode=void 0,t=!0):(i=this.unitSelectionHandler.getSelectedUnits(),t=this.defaultActionHandler.execute(r,i,b.ActionFilter.All,!1,!1,this.lastKeyboardEvent,!0)),t||this.minimapHandler.panToTile(e)},this.handleMinimapRightClick=e=>{this.minimapHandler.panToTile(e)},this.handleMinimapMouseOver=()=>{this.isMinimapHover=!0},this.handleMinimapMouseMove=e=>{this.minimapHoverTile=e;var t=this.minimapHandler.getHover(e);this.currentMode?this.currentMode.hover(t,!0):this.updateDefaultAction(t,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyboardEvent)},this.handleMinimapMouseOut=()=>{this.pointer.setPointerType(v.PointerType.Default),this.isMinimapHover=!1,this.minimapHoverTile=void 0}}init(){this.initialized||(this.setupHandlers(),this.worldScene.add(this.targetLines),this.initialized=!0,this.hasFaultyCtrlLeftClick=i.isMacFirefox())}setupHandlers(){this.pointerEvents.addEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel),this.document.addEventListener("keydown",this.handleKeyDown),this.document.addEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.subscribe(this.handleMapHoverChange),this.renderer.onFrame.subscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.subscribe(this.handleSelectionChange),this.minimapHandler.minimap.onClick.subscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.subscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.subscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.subscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.subscribe(this.handleMinimapMouseOut),this.tooltipHandler.init()}teardownHandlers(){this.pointerEvents.removeEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.removeEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.removeEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel),this.document.removeEventListener("keydown",this.handleKeyDown),this.document.removeEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.unsubscribe(this.handleMapHoverChange),this.renderer.onFrame.unsubscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.unsubscribe(this.handleSelectionChange),this.unitSelectionHandler.cancelBoxSelect(),this.minimapHandler.minimap.onClick.unsubscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.unsubscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.unsubscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.unsubscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.unsubscribe(this.handleMinimapMouseOut),this.tooltipHandler.dispose(),this.mapScrollHandler.cancel(),this.arrowScrollHandler.cancel()}dispose(){this.initialized&&this.enabled&&(this.teardownHandlers(),this.pointer.setPointerType(v.PointerType.Default)),this.currentMode?.dispose(),this.mapScrollHandler.dispose(),this.cameraPanHandler.dispose(),this.mapHoverHandler.dispose(),this.unitSelectionHandler.dispose(),this.chatTypingHandler?.dispose(),this.keyboardHandler.dispose(),this.worldScene.remove(this.targetLines),this.targetLines.dispose(),this.tooltipHandler.dispose()}setEnabled(e){this.enabled!==e&&((this.enabled=e)?this.setupHandlers():(this.teardownHandlers(),this.cancelMouseUp(),this.cancelKeyUp(),this.pointer.setPointerType(v.PointerType.Default),this.chatTypingHandler?.endTyping()))}isEnabled(){return this.enabled}pausePanning(){this.cameraPanHandler.setPaused(!0),this.mapScrollHandler.setPaused(!0)}unpausePanning(){this.cameraPanHandler.setPaused(!1),this.mapScrollHandler.setPaused(!1)}setMode(e){var t;this.currentMode!==e&&(this.currentMode?.cancel?.(),this.pointer.setPointerType(v.PointerType.Default)),this.currentMode=e,this.clearModeOnSelectionChange=!1,e&&(this.unitSelectionHandler.deselectAll(),this.clearModeOnSelectionChange=!0,e.enter(),this.mapHoverHandler.update(this.pointer.getPosition(),!0),(t=this.getCurrentHover())&&e.hover(t,this.isMinimapHover))}getMode(){return this.currentMode}registerKeyCommand(e,t){return this.keyboardHandler.registerCommand(e,t),this}unregisterKeyCommand(e){return this.keyboardHandler.unregisterCommand(e),this}updateDefaultAction(e,t,i){var r=this.mapScrollHandler.isScrolling();e?(this.defaultActionHandler.update(e,t,this.isRightClickMove(),i,this.isMinimapHover),r||this.pointer.setPointerType(this.defaultActionHandler.getPointerType(this.isMinimapHover))):r||this.pointer.setPointerType(this.isMinimapHover?v.PointerType.Mini:v.PointerType.Default),this.lastDefaultActionUpdate=this.lastFrameTime}processMouseMove(e){var t=this.mapScrollHandler.isScrolling();void 0===this.mousePressed?e.isTouch||this.mapScrollHandler.update(e.pointer):this.hasDragged||this.isClickRange(e.pointer)||(this.hasDragged=!0,this.currentMode||0!==this.mousePressed||this.unitSelectionHandler.startBoxSelect(this.clickOrigin)),!this.currentMode||this.mapScrollHandler.isScrolling()||this.maybePan&&this.hasDragged||(!this.isMinimapHover&&t&&this.pointer.setPointerType(v.PointerType.Default),this.mapHoverHandler.update(e.pointer),this.currentMode.hover(this.getCurrentHover(),this.isMinimapHover)),void 0===this.mousePressed?this.mapScrollHandler.isScrolling()||(this.mapHoverHandler.update(e.pointer),this.currentMode||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),e)):(!this.hasDragged||(this.currentMode||this.isRightClickMove()&&2===this.mousePressed)&&!this.maybePan?this.mapHoverHandler.update(e.pointer):this.mapHoverHandler.finish(),this.hasDragged&&(this.maybePan?this.cameraPanHandler.update(e.pointer,e.isTouch):this.currentMode||this.isRightClickMove()&&2===this.mousePressed||(this.pointer.setPointerType(v.PointerType.Default),this.unitSelectionHandler.updateBoxSelect(e.pointer))))}handleDefaultClickAction(e,t,i,r,s,a){var n,o;a&&(n=this.unitSelectionHandler.getSelectedUnits(),o=e?t?b.ActionFilter.NoSelect:b.ActionFilter.SelectOnly:b.ActionFilter.All,this.defaultActionHandler.execute(a,n,o,e&&!t,i,r?{...s,ctrlKey:!0}:s))}cancelMouseUp(){void 0!==this.mousePressed&&(this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0,this.maybePan&&(this.maybePan=!1,this.cameraPanHandler.finish()),this.currentMode&&(this.currentMode.cancel?.(),this.currentMode=void 0),this.unitSelectionHandler.cancelBoxSelect())}cancelKeyUp(){var e;"keydown"===this.lastKeyboardEvent?.type&&(e=new KeyboardEvent("keyup",{key:this.lastKeyboardEvent.key,keyCode:this.lastKeyboardEvent.keyCode,ctrlKey:this.lastKeyboardEvent.ctrlKey,altKey:this.lastKeyboardEvent.altKey,shiftKey:this.lastKeyboardEvent.shiftKey,metaKey:this.lastKeyboardEvent.metaKey}),this.handleKeyUp(e))}isClickRange(e){return Math.abs(e.x-this.clickOrigin.x)<=10&&Math.abs(e.y-this.clickOrigin.y)<=10}isRightClickPanAllowed(){return this.rightClickScroll.value}isRightClickMove(){return this.rightClickMove.value}getCurrentHover(){return this.isMinimapHover?this.minimapHoverTile?this.minimapHandler.getHover(this.minimapHoverTile):void 0:this.mapHoverHandler.getCurrentHover()}})}}}),System.register("gui/screen/game/worldInteraction/WorldInteractionFactory",["engine/util/MapTileIntersectHelper","engine/util/EntityIntersectHelper","gui/screen/game/worldInteraction/UnitSelectionHandler","gui/screen/game/worldInteraction/DefaultActionHandler","gui/screen/game/worldInteraction/WorldInteraction","gui/screen/game/worldInteraction/CameraPanHandler","gui/screen/game/worldInteraction/MapScrollHandler","gui/screen/game/worldInteraction/MapHoverHandler","gui/screen/game/worldInteraction/keyboard/KeyboardHandler","engine/util/RaycastHelper","engine/util/WorldViewportHelper","engine/renderable/entity/TargetLines","gui/screen/game/worldInteraction/MinimapHandler","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/TooltipHandler","gui/screen/game/worldInteraction/ArrowScrollHandler"],function(e,t){"use strict";var h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,i;t&&t.id;return{setters:[function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e}],execute:function(){e("WorldInteractionFactory",i=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f){this.player=e,this.game=t,this.unitSelection=i,this.renderableManager=r,this.uiScene=s,this.worldScene=a,this.pointer=n,this.renderer=o,this.keyBinds=l,this.generalOptions=c,this.freeCamera=h,this.debugPaths=u,this.devMode=d,this.document=g,this.minimap=p,this.strings=m,this.tooltipTextColor=f}create(){var e=this.game.map,t=this.worldScene,i=this.pointer;let r=this.renderer;var s=new h.MapTileIntersectHelper(e,t),a=new v.RaycastHelper(t),n=new b.WorldViewportHelper(t),o=new u.EntityIntersectHelper(e,this.renderableManager,s,a,t,n),l=new d.UnitSelectionHandler(t,this.uiScene,this.player,this.unitSelection,o,this.game.rules.general.veteran.veteranCap),c=g.DefaultActionHandler.factory(this.renderableManager,this.unitSelection,l,this.player,e,this.game,this.game.rules.audioVisual),a=this.player?this.game.mapShroudTrait.getPlayerShroud(this.player):void 0,n=new T.KeyboardHandler(this.keyBinds,this.devMode),o=new y.MapHoverHandler(o,s,e,a,r),s=new f.MapScrollHandler(r.getCanvas(),t.cameraPan,i,this.generalOptions.scrollRate,t);return new p.WorldInteraction(t,i,i.pointerEvents,new m.CameraPanHandler(t.cameraPan,i,this.generalOptions.scrollRate,this.freeCamera,t),s,o,new E.TooltipHandler(o,this.tooltipTextColor,i,this.uiScene,this.renderer,this.strings),l,c,n,new x.ArrowScrollHandler(s),new w.MinimapHandler(this.minimap,e,a,t,new C.MapPanningHelper(e)),t.cameraZoom,this.document,r,new S.TargetLines(this.player,this.unitSelection,t.camera,this.debugPaths,this.generalOptions.targetLines),this.generalOptions.rightClickMove,this.generalOptions.rightClickScroll)}})}}}),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGridModel",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGrid",["game/Coords","game/theater/rampHeights","engine/gfx/OverlayUtils","util/geometry","engine/gfx/SpriteUtils","engine/IsoCoords"],function(e,t){"use strict";var u,d,a,n,s,g,p,i;t&&t.id;return{setters:[function(e){u=e},function(e){d=e},function(e){a=e},function(e){n=e},function(e){s=e},function(e){p=e}],execute:function(){g=THREE.Math.ceilPowerOfTwo,e("PlacementGrid",i=class{constructor(e,t,i){this.viewModel=e,this.camera=t,this.mapTiles=i,this.tileOverlays=new Map}get3DObject(){return this.target}create3DObject(){let e=new THREE.Object3D;e.name="placement_grid",this.target=e,this.createTileOverlays()}update(){if(this.refreshRangeCircle(),this.viewModel.visible||!this.tilesObject){let i=new THREE.Object3D;i.visible=!0;for(var r of this.viewModel.tiles){var s=this.mapTiles.getByMapCoords(r.rx,r.ry);if(!s)throw new Error(`Map tile not found for coords (${r.rx}, ${r.ry})`);let e=this.tileOverlays.get(s.rampType);if(!e)throw new Error("Missing overlay mesh for rampType "+s.rampType);let t=e.clone();t.material=t.material.clone();r=r.buildable?this.viewModel.showBusy?16776960:65280:16711680;t.material.color.set(r);s=this.getTilePosition(s);t.position.copy(s),i.add(t)}let e=this.get3DObject();e.remove(this.tilesObject),this.tilesObject=i,e.add(i)}else this.tilesObject.visible=!1}refreshRangeCircle(){if(this.viewModel.visible||!this.rangeObject){this.rangeObject&&(this.rangeObject.visible=!0);let e=this.get3DObject();var t=this.viewModel.rangeIndicator;if(t){if(this.lastRangeCircle&&t.radius===this.lastRangeCircle.radius||(s=a.OverlayUtils.createGroundCircle(t.radius*u.Coords.getWorldTileSize(),this.viewModel.rangeIndicatorColor),this.rangeObject&&e.remove(this.rangeObject),e.add(s),this.rangeObject=s),!this.lastRangeCircle||!n.pointEquals(t.center,this.lastRangeCircle.center)){var i=Math.floor(t.center.x),r=Math.floor(t.center.y),s=this.mapTiles.getByMapCoords(i,r);if(!s)throw new Error(`Map tile not found for coords (${i}, ${r})`);let e=this.getTilePosition(s);e.x+=t.center.x%1*u.Coords.getWorldTileSize(),e.z+=t.center.y%1*u.Coords.getWorldTileSize(),this.rangeObject.position.copy(e)}this.lastRangeCircle=t}else this.rangeObject&&(e.remove(this.rangeObject),this.rangeObject=void 0,this.lastRangeCircle=void 0)}else this.rangeObject.visible=!1}createTileOverlays(){for(let e=0;e<d.rampHeights.length;++e)this.tileOverlays.set(e,this.createTileOverlay(e))}createTileOverlay(e){var t=p.IsoCoords.getScreenTileSize();let i=s.SpriteUtils.createSpriteGeometry({texture:this.getTileOverlayTexture(),textureArea:{x:0,y:2*e*t.height,width:t.width,height:2*t.height},align:{x:0,y:-1},camera:this.camera,scale:u.Coords.ISO_WORLD_SCALE});i.applyMatrix((new THREE.Matrix4).makeTranslation(0,u.Coords.tileHeightToWorld(1),0));t=new THREE.MeshBasicMaterial({map:this.getTileOverlayTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0,depthTest:!1,depthWrite:!1});let r=new THREE.Mesh(i,t);return r.renderOrder=1e6,r.frustumCulled=!1,r}getTilePosition(e){return u.Coords.tile3dToWorld(e.rx,e.ry,e.z)}getTileOverlayTexture(){let s=this.textureCache;if(!s){var a=p.IsoCoords.getScreenTileSize();let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("Couldn't acquire canvas 2d context");e.width=g(a.width),e.height=g(2*a.height*d.rampHeights.length);let i=p.IsoCoords.tileToScreen(0,0);i.x+=-a.width/2;var n=u.Coords.ISO_TILE_SIZE/2;for(let r=0;r<d.rampHeights.length;++r){var o=d.rampHeights[r],l=[[0,1],[0,0],[1,0],[1,1]];t.beginPath();var c=p.IsoCoords.tileToScreen(l[0][0],l[0][1]);t.moveTo(-i.x+c.x,-i.y+c.y+(1-o[0])*n+2*r*a.height);for(let e=1;e<l.length;++e){var h=p.IsoCoords.tileToScreen(l[e][0],l[e][1]);t.lineTo(-i.x+h.x,-i.y+h.y+(1-o[e])*n+2*r*a.height)}t.closePath(),t.lineWidth=1,t.fillStyle="#"+16777215..toString(16),t.fill(),t.strokeStyle="#"+0..toString(16),t.stroke()}s=new THREE.Texture(e),s.needsUpdate=!0,this.textureCache=s}return s}dispose(){this.tileOverlays.forEach(e=>{e.material.dispose(),e.geometry.dispose()})}})}}}),System.register("gui/screen/game/worldInteraction/PlacementMode",["gui/screen/game/worldInteraction/placementMode/PlacementGrid","util/geometry","util/event","engine/type/ObjectType"],function(e,t){"use strict";var l,r,o,s,i;t&&t.id;return{setters:[function(e){l=e},function(e){r=e},function(e){o=e},function(e){s=e}],execute:function(){e("PlacementMode",i=class{constructor(e,t,i,r,s,a,n){this.game=e,this.player=t,this.constrWorker=i,this.renderer=r,this.eva=s,this.placementGrid=a,this.worldScene=n,this.defenseMode=!1,this.buildingRanges=new Map,this._onBuildingPlaceRequest=new o.EventDispatcher,this.onFrame=e=>{(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,this.currentBuilding&&this.updateGridModel(this.currentBuilding.name))}}get onBuildingPlaceRequest(){return this._onBuildingPlaceRequest}static factory(e,t,i,r,s){var a=e.getConstructionWorker(t),n={tiles:[],visible:!1,rangeIndicator:void 0,rangeIndicatorColor:void 0};let o=new this(e,t,a,i,s,new l.PlacementGrid(n,r.camera,e.map.tiles),r);return o.placementGridModel=n,o}init(){this.worldScene.add(this.placementGrid)}dispose(){this.worldScene.remove(this.placementGrid),this.placementGrid.dispose(),this.endConstrMode()}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}setBuilding(e){(this.currentBuilding=e).primary||e.hasRadialIndicator?(this.defenseMode=!0,this.prepareBuildingRanges(e)):this.defenseMode=!1}getBuilding(){return this.currentBuilding}hover(e,t){var i;t||(i=e?.tile)!==this.currentTile&&(this.currentTile=i)}updateGridModel(e){var t,i=this.currentTile;i?(t=this.constrWorker.getPlacementPreview(e,i),this.placementGridModel.tiles=t,this.placementGridModel.visible=!0,this.defenseMode?(this.showBuildingRangeOverlays(i,e),this.placementGridModel.rangeIndicator=this.getBuildingRangeCircle(i,e),this.placementGridModel.rangeIndicatorColor=this.player.color.asHex()):this.placementGridModel.rangeIndicator=void 0):this.placementGridModel.visible=!1}execute(e,t){if(!this.currentBuilding||t)return!1;var i=e?.tile;if(!i)return!1;if(this.player.production.isAvailableForProduction(this.currentBuilding)){if(!this.constrWorker.canPlaceAt(this.currentBuilding.name,i))return this.eva.play("EVA_CannotDeployHere"),!1;this._onBuildingPlaceRequest.dispatch(this,{rules:this.currentBuilding,tile:this.constrWorker.normalizePlacementTile(this.currentBuilding.name,i)}),this.endConstrMode()}else this.endConstrMode()}cancel(){this.endConstrMode()}endConstrMode(){this.defenseMode=!1,this.placementGridModel.visible=!1,this.hideBuildingRangeOverlays(),this.buildingRanges.clear(),this.currentBuilding=void 0,this.renderer.onFrame.unsubscribe(this.onFrame)}hideBuildingRangeOverlays(){this.buildingRanges.forEach((e,t)=>{t.showWeaponRange=!1})}showBuildingRangeOverlays(e,t){let i=this.getBuildingRangeCircle(e,t);this.buildingRanges.forEach((e,t)=>{t.showWeaponRange=r.circleIntersect(i,e)})}getBuildingRangeCircle(e,t){var i=this.game.art.getObject(t,s.ObjectType.Building).foundation;return{center:{x:e.rx+(i.width%2!=0?.5:0),y:e.ry+(i.height%2!=0?.5:0)},radius:this.currentRangeCircleRadius}}prepareBuildingRanges(t){let e=[...this.player.buildings].filter(e=>e.name===t.name);var i;t.psychicDetectionRadius?this.currentRangeCircleRadius=t.psychicDetectionRadius:t.gapGenerator?this.currentRangeCircleRadius=t.gapRadiusInCells:(i=t.primary)&&(this.currentRangeCircleRadius=this.game.rules.getWeapon(i).range),this.buildingRanges.clear(),e.forEach(e=>{var t=e.tile,i=this.game.art.getObject(e.name,s.ObjectType.Building).foundation,t={x:t.rx+i.width/2,y:t.ry+i.height/2},i=e.psychicDetectorTrait?.radiusTiles??e.gapGeneratorTrait?.radiusTiles??e.primaryWeapon?.range;i&&this.buildingRanges.set(e,{center:t,radius:i})})}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SelectGroupCmd",i=class{constructor(e,t,i,r,s){this.groupNum=e,this.unitSelectionHandler=t,this.targetLines=i,this.mapPanningHelper=r,this.cameraPan=s}execute(){this.unitSelectionHandler.selectGroup(this.groupNum),this.targetLines.forceShow();var e=performance.now();let t=!0;(!this.lastSelectTime||400<e-this.lastSelectTime)&&(t=!1,this.lastSelectTime=e),!t||(e=this.unitSelectionHandler.getSelectedUnits()).length&&(e=this.computePanTile(e),e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}computePanTile(e){return{rx:Math.floor(e.reduce((e,t)=>e+t.tile.rx,0)/e.length),ry:Math.floor(e.reduce((e,t)=>e+t.tile.ry,0)/e.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CenterGroupCmd",i=class{constructor(e,t,i,r){this.groupNum=e,this.unitSelectionHandler=t,this.mapPanningHelper=i,this.cameraPan=r}execute(){var e=this.unitSelectionHandler.getGroupUnits(this.groupNum);e.length&&(e=this.computePanTile(e),e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}computePanTile(e){return{rx:Math.floor(e.reduce((e,t)=>e+t.tile.rx,0)/e.length),ry:Math.floor(e.reduce((e,t)=>e+t.tile.ry,0)/e.length)}}})}}}),System.register("gui/screen/game/PlayerUi",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/game/gameMenu/ScreenType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.Home=0]="Home",e[e.Diplo=1]="Diplo",e[e.ConnectionInfo=2]="ConnectionInfo",e[e.QuitConfirm=3]="QuitConfirm",e[e.Options=4]="Options",e[e.OptionsSound=5]="OptionsSound",e[e.OptionsKeyboard=6]="OptionsKeyboard",t("ScreenType",i)}}}),System.register("gui/screen/game/gameMenu/ConInfoForm",["react","gui/component/CountryIcon","game/gameopts/constants","network/gamestate/PlayerConnectionStatus","network/gservConfig","gui/component/Chat"],function(e,t){"use strict";var c,h,u,d,g,p;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){e("ConInfoForm",({strings:e,conInfos:i,players:t,localPlayer:r,messages:s,chatHistory:a,onSendMessage:n})=>{let[o,l]=c.useState(()=>Math.floor((g.TURN_TIMEOUT_MILLIS-g.LAG_STATE_THRESH_MILLIS-g.CON_INFO_THRESH_MILLIS)/1e3));return c.useEffect(()=>{let e=setInterval(()=>l(Math.max(0,o-1)),1e3);return()=>clearInterval(e)},[o]),c.default.createElement("div",{className:"con-info-form"},c.default.createElement("div",{className:"con-info-form-content"},c.default.createElement("table",null,c.default.createElement("tbody",null,t.filter(e=>!e.isAi).map(t=>{var e=i?.find(e=>e.name===t.name);return c.default.createElement("tr",{key:t.name,style:{color:t.color.asHexString(),opacity:e&&e.status!==d.PlayerConnectionStatus.Connected?.5:1}},c.default.createElement("td",null,c.default.createElement(h.CountryIcon,{country:t.country?t.country.name:u.OBS_COUNTRY_NAME})),c.default.createElement("td",{className:"player-name"},t.name),c.default.createElement("td",{className:"player-ping"},c.default.createElement("meter",{value:e?.ping??1e3,max:1e3,low:150,high:500,optimum:0})))})))),c.default.createElement("div",{className:"con-info-form-footer"},c.default.createElement("div",{className:"time-allowed"},e.get("TXT_TIME_ALLOWED",o)),c.default.createElement("div",{className:"chat"},c.default.createElement(p.Chat,{strings:e,messages:s,channels:[g.RECIPIENT_ALL,g.RECIPIENT_TEAM],chatHistory:a,userColors:new Map(t.map(e=>[e.name,e.color.asHexString()])),localUsername:r.name,onSendMessage:n}))))})}}}),System.register("gui/screen/game/GameMenuScreen",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("GameMenuScreen",i=class{setController(e){this.controller=e}})}}}),System.register("network/gameopt/LoadInfoParser",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("LoadInfoParser",i=class{parse(e){let t=[];var i=e.split(",");for(let s=0;s<i.length/4;++s){var r={name:i[4*s],status:Number(i[4*s+1]),loadPercent:Number(i[4*s+2]),ping:Number(i[4*s+3])};t.push(r)}return t}})}}}),System.register("gui/screen/game/ChatNetHandler",["util/disposable/CompositeDisposable","network/chat/ChatMessage","network/gservConfig"],function(e,t){"use strict";var c,h,u,r,i;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){r=["/ignore","/squelch","/unignore","/unsquelch"],e("ChatNetHandler",i=class{constructor(e,t,i,r,s,a,n,o,l){this.gservCon=e,this.wolCon=t,this.messageList=i,this.chatHistory=r,this.chatMessageFormat=s,this.localPlayer=a,this.game=n,this.replayRecorder=o,this.mutedPlayers=l,this.disposables=new c.CompositeDisposable,this.handleMessage=i=>{if(i.from===this.localPlayer.name&&i.to.type===h.ChatRecipientType.Whisper)return this.messageList.addChatMessage(this.chatMessageFormat.formatPrefixPlain(i)+" "+i.text,"mediumpurple"),void this.chatHistory.addChatMessage(i);if(!i.text.startsWith("/")){var e=this.chatMessageFormat.formatPrefixPlain(i);let t;if(i.to.type!==h.ChatRecipientType.Page||i.from!==this.gservCon.getServerName()&&i.from!==this.wolCon.getServerName()){let e=this.game.getPlayerByName(i.from);if(this.mutedPlayers.has(e.name))return;t=i.to.type===h.ChatRecipientType.Whisper?"mediumpurple":e.color.asHexString()}else t="yellow";i.to.type===h.ChatRecipientType.Channel&&i.to.name===u.RECIPIENT_ALL&&this.replayRecorder.recordChatMessage(this.game.currentTick,i.from,i.text),this.messageList.addChatMessage(e+" "+i.text,t),this.chatHistory.addChatMessage(i),i.to.type===h.ChatRecipientType.Whisper&&i.to.name!==this.wolCon.getServerName()&&i.to.name!==this.gservCon.getServerName()&&(this.chatHistory.lastWhisperFrom.value=i.from)}}}init(){this.wolCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add(()=>this.wolCon.onChatMessage.unsubscribe(this.handleMessage)),this.gservCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add(()=>this.gservCon.onChatMessage.unsubscribe(this.handleMessage))}submitMessage(t,e){var i;this.gservCon.isOpen()?e.type===h.ChatRecipientType.Channel&&e.name===u.RECIPIENT_ALL?t.startsWith("/")?(i=this.wolCon.getCurrentChannels(),this.wolCon.isOpen()&&i.length&&r.some(e=>t.startsWith(e))&&this.wolCon.privmsg([i[0]],t)):this.gservCon.sayChannel(t):e.type===h.ChatRecipientType.Channel&&e.name===u.RECIPIENT_TEAM?(i=this.game.alliances.getAllies(this.localPlayer).filter(e=>!e.isAi).map(e=>e.name),this.gservCon.privmsg([...i,this.localPlayer.name],t)):e.type===h.ChatRecipientType.Whisper&&this.wolCon.isOpen()&&(this.wolCon.privmsg([e.name],t),this.chatHistory.lastWhisperTo.value=e.name):console.warn("Can't send chat message. Network connection is already closed.")}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/gameMenu/ConnectionInfoScreen",["gui/jsx/jsx","gui/screen/game/gameMenu/ScreenType","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/screen/game/gameMenu/ConInfoForm","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],function(e,t){"use strict";var r,s,a,i,n,o,l,c;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e},function(e){i=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends o.GameMenuScreen{constructor(e,t){super(),this.strings=e,this.jsxRenderer=t,this.messages=[],this.disposables=new i.CompositeDisposable,this.handleChatMessage=e=>{this.messages.push(e),this.form.refresh()},this.handleConInfoUpdate=t=>{this.form.applyOptions(e=>{e.conInfos=(new l.LoadInfoParser).parse(t)})}}onEnter(t){if(this.params=t,this.controller.toggleContentAreaVisibility(!0),this.initView(t),t.gservCon.isOpen()){t.gservCon.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add(()=>t.gservCon.onLoadInfo.unsubscribe(this.handleConInfoUpdate)),t.gservCon.requestLoadInfo();let e=setInterval(()=>{t.gservCon.isOpen()?t.gservCon.requestLoadInfo():this.disposables.dispose()},1e3);this.disposables.add(()=>clearInterval(e)),t.chatHistory.onNewMessage.subscribe(this.handleChatMessage),this.disposables.add(()=>{this.messages.length=0,t.chatHistory.onNewMessage.unsubscribe(this.handleChatMessage)})}this.messages.push({text:this.strings.get("GUI:ConnectingToPlayers")+"...\n"+this.strings.get("TXT_RECONNECT_HELP2")+" "+this.strings.get("TXT_RECONNECT_HELP2B")})}initView(t){let e=this.strings;var i=[{label:e.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(s.ScreenType.QuitConfirm,{onQuit:t.onQuit,onCancel:()=>{this.controller?.popScreen()}})}}];this.controller.setSidebarButtons(i),this.controller.showSidebarButtons();var[i]=this.jsxRenderer.render(r.jsx(a.HtmlView,{width:"100%",height:"100%",component:n.ConInfoForm,innerRef:e=>this.form=e,props:{players:t.players,localPlayer:t.localPlayer,strings:this.strings,messages:this.messages,chatHistory:t.chatHistory,onSendMessage:e=>{t.chatNetHandler.submitMessage(e.value,e.recipient)}}}));this.controller.setMainComponent(i),this.disposables.add(()=>this.form=void 0)}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},e("ConnectionInfoScreen",c)}}}),System.register("gui/screen/game/gameMenu/DiploForm",["react","game/Alliances","game/gameopts/constants","gui/component/CountryIcon","gui/component/Chat","network/gservConfig","gui/component/PingIndicator","network/gamestate/PlayerConnectionStatus"],function(e,t){"use strict";var b,S,w,C,E,x,O,A;t&&t.id;return{setters:[function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e}],execute:function(){e("DiploForm",({strings:i,playerInfos:e,localPlayer:r,taunts:t,singlePlayer:s,alliancesAllowed:a,gameModes:n,gameOpts:o,mapName:l,messages:c,chatHistory:h,conInfos:u,onToggleTaunts:d,onToggleAlliance:g,onToggleChat:p,onSendMessage:m,onCancelMessage:f})=>{var y,T=i.get(n.getById(o.gameMode).label),v=e=>e?i.get("TXT_ON"):i.get("TXT_OFF");return b.default.createElement("div",{className:"diplo-form"},b.default.createElement("div",{className:"players"},b.default.createElement("table",null,b.default.createElement("thead",null,b.default.createElement("tr",null,b.default.createElement("th",{className:"player-country"}),b.default.createElement("th",{className:"player-ping"}),b.default.createElement("th",{className:"player-name"},i.get("GUI:Player")),b.default.createElement("th",null,i.get("GUI:Allies")),!s&&b.default.createElement("th",null,i.get("GUI:Chat")),b.default.createElement("th",null,i.get("GUI:Kills")))),b.default.createElement("tbody",null,r&&b.default.createElement("tr",{style:{color:r.color.asHexString()}},b.default.createElement("td",{className:"player-country"},b.default.createElement(C.CountryIcon,{country:r.country?r.country.name:w.OBS_COUNTRY_NAME})),b.default.createElement("td",{className:"player-ping"},void 0!==(y=u?.find(e=>e.name===r.name)?.ping)&&b.default.createElement(O.PingIndicator,{ping:y,strings:i})),b.default.createElement("td",{className:"player-name"},r.name),b.default.createElement("td",null),!s&&b.default.createElement("td",null),b.default.createElement("td",null,!r.isObserver||r.defeated?r.getUnitsKilled():void 0)),e.map((t,e)=>b.default.createElement("tr",{key:e,style:{color:t.player.defeated?"grey":t.player.color.asHexString()}},b.default.createElement("td",{className:"player-country"},b.default.createElement(C.CountryIcon,{country:t.player.country?t.player.country.name:w.OBS_COUNTRY_NAME})),b.default.createElement("td",{className:"player-ping"},(()=>{var e=u?.find(e=>e.name===t.player.name),e=e?.status===A.PlayerConnectionStatus.Connected?e?.ping:void 0;return void 0!==e&&b.default.createElement(O.PingIndicator,{ping:e,strings:i})})()),b.default.createElement("td",{className:"player-name"},t.player.isAi?i.get(w.aiUiNames.get(t.player.aiDifficulty)):t.player.name),b.default.createElement("td",null,(!r?.isObserver||r.defeated)&&b.default.createElement("input",{type:"checkbox",name:"alliance",className:t.alliance?.status===S.AllianceStatus.Requested?t.alliance.players.first===r?"semi-checked-left":"semi-checked-right":void 0,disabled:!a||!t.allianceToggleable||!t.player.isCombatant(),checked:t.alliance?.status===S.AllianceStatus.Formed,onChange:()=>g(t.player,!(t.alliance?.status===S.AllianceStatus.Formed||t.alliance?.status===S.AllianceStatus.Requested&&t.alliance.players.first===r))})),!s&&b.default.createElement("td",null,b.default.createElement("input",{type:"checkbox",name:"mute",checked:!t.muted,onChange:e=>p(t.player,e.target.checked)})),b.default.createElement("td",null,!t.player.isObserver||t.player.defeated?t.player.getUnitsKilled():void 0)))))),b.default.createElement("div",{className:"diplo-form-footer"},b.default.createElement("div",{className:"game-settings"},b.default.createElement("div",null,i.get("TXT_MAP",l)),b.default.createElement("div",null,[i.get("GUI:GameType")+": "+T,i.get("GUI:ShortGame")+": "+v(o.shortGame),i.get("GUI:CratesAppear")+": "+v(o.cratesAppear),i.get("GUI:SuperWeaponsAllowed")+": "+v(o.superWeapons)].join(", "))),!s&&b.default.createElement("div",{"data-r-tooltip":i.get("STT:TauntsOn")},b.default.createElement("label",null,b.default.createElement("input",{type:"checkbox",name:"taunts",checked:!!t,disabled:void 0===t,onChange:e=>d(e.target.checked)})," ",b.default.createElement("span",null,i.get("GUI:TauntsOn")))),!s&&c&&h&&r&&b.default.createElement("div",{className:"chat"},b.default.createElement(E.Chat,{localUsername:r.name,messages:c,chatHistory:h,channels:[x.RECIPIENT_ALL,x.RECIPIENT_TEAM],strings:i,userColors:new Map([r,...e.map(e=>e.player)].map(e=>[e.name,e.color.asHexString()])),onSendMessage:m,onCancelMessage:f}))))})}}}),System.register("gui/screen/game/gameMenu/DiploScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/game/gameMenu/DiploForm","util/disposable/CompositeDisposable","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],function(e,t){"use strict";var a,n,o,l,i,c,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){i=e},function(e){c=e}],execute:function(){r=class extends i.GameMenuScreen{constructor(e,t,i,r,s,a){super(),this.strings=e,this.jsxRenderer=t,this.renderer=i,this.gameModes=r,this.taunts=s,this.mutedPlayers=a,this.disposables=new l.CompositeDisposable,this.onFrame=e=>{(!this.lastUpdate||500<e-this.lastUpdate)&&(this.lastUpdate=e,this.updateForm())},this.handleConInfoUpdate=t=>{this.form.applyOptions(e=>{e.conInfos=(new c.LoadInfoParser).parse(t)})},this.updateForm=()=>{this.form.applyOptions(e=>{this.params&&(e.playerInfos=this.buildPlayerInfos(this.params.game,this.params.localPlayer),e.taunts=this.taunts.value,e.messages=this.params.chatHistory?.getAll())})}}onEnter(e){this.controller.toggleContentAreaVisibility(!0),this.initView(e),this.params=e,this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame));const t=e.chatHistory;t&&(t.onNewMessage.subscribe(this.updateForm),this.disposables.add(()=>t.onNewMessage.unsubscribe(this.updateForm)));const i=e.gservCon;if(i?.isOpen()){i.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add(()=>i.onLoadInfo.unsubscribe(this.handleConInfoUpdate)),i.requestLoadInfo();let e=setInterval(()=>{i.isOpen()?i.requestLoadInfo():this.disposables.dispose()},1e4);this.disposables.add(()=>clearInterval(e))}}initView(t){let e=this.strings;var i=[{label:e.get("GUI:ResumeMission"),isBottom:!0,onClick:t.onCancel}];this.controller.setSidebarButtons(i),this.controller.showSidebarButtons();var{localPlayer:r,isSinglePlayer:s,game:i}=t,[i]=this.jsxRenderer.render(a.jsx(n.HtmlView,{width:"100%",height:"100%",component:o.DiploForm,innerRef:e=>this.form=e,props:{playerInfos:this.buildPlayerInfos(i,r),localPlayer:r,gameOpts:i.gameOpts,gameModes:this.gameModes,taunts:s?void 0:this.taunts.value,singlePlayer:s,alliancesAllowed:!s&&i.rules.mpDialogSettings.alliesAllowed&&i.rules.mpDialogSettings.allyChangeAllowed,mapName:i.gameOpts.mapTitle,messages:t.chatHistory?.getAll(),chatHistory:t.chatHistory,onToggleTaunts:e=>this.taunts.value=e,onToggleAlliance:t.onToggleAlliance,onToggleChat:(e,t)=>{t?this.mutedPlayers.delete(e.name):this.mutedPlayers.add(e.name)},onSendMessage:t.onSendMessage,onCancelMessage:e=>e&&t.onCancel(),strings:this.strings}}));this.controller.setMainComponent(i),this.disposables.add(()=>this.form=void 0)}buildPlayerInfos(e,i){let r=i?e.alliances.filterByPlayer(i):void 0;return e.getNonNeutralPlayers().filter(e=>e!==i).map(t=>({player:t,muted:this.mutedPlayers.has(t.name),allianceToggleable:!!i&&e.alliances.canRequestAlliance(t)&&e.alliances.canFormAlliance(i,t),alliance:r?.find(e=>e.players.first===t||e.players.second===t)}))}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}},e("DiploScreen",r)}}}),System.register("util/keyNames",[],function(e,t){"use strict";var i;t&&t.id;return e("getKeyName",function(e){var t=i.get(e);return void 0!==t?t:String.fromCharCode(e)}),{setters:[],execute:function(){i=new Map([[8,"Backspace"],[9,"Tab"],[12,"Clear"],[13,"Enter"],[19,"Pause/Break"],[20,"CapsLock"],[27,"Esc"],[32,"Space"],[33,"PageUp"],[34,"PageDown"],[35,"End"],[36,"Home"],[37,"ArrowLeft"],[38,"ArrowUp"],[39,"ArrowRight"],[40,"ArrowDown"],[44,"PrintScreen"],[45,"Insert"],[46,"Delete"],[91,"LeftWin/"],[92,"RightWin/"],...new Array(10).fill(0).map((e,t)=>[96+t,"Num"+t]),[106,"Num*"],[107,"Num+"],[109,"Num-"],[110,"NumDel"],[111,"Num/"],...new Array(32).fill(0).map((e,t)=>[111+t+1,"F"+(t+1)]),[144,"NumLock"],[145,"ScrollLock"],[186,";"],[187,"="],[188,","],[189,"-"],[190,"."],[191,"/"],[192,"`"],[219,"["],[220,"\\"],[221,"]"],[222,"'"]])}}}),System.register("gui/screen/options/component/getHumanReadableKey",["util/keyNames","util/userAgent"],function(e,t){"use strict";var r,s;t&&t.id;return{setters:[function(e){r=e},function(e){s=e}],execute:function(){e("getHumanReadableKey",e=>{var t=s.isMac()||s.isIpad();let i=[];return e.ctrlKey&&i.push("Ctrl"),e.altKey&&i.push(t?"":"Alt"),e.shiftKey&&i.push("Shift"),e.metaKey&&i.push(t?"":"Win"),void 0!==e.keyCode?(i.push(r.getKeyName(e.keyCode)),i.join("+")):i.join("+")+"+"})}}}),System.register("gui/screen/game/gameMenu/GameMenuHomeScreen",["gui/screen/game/gameMenu/ScreenType","gui/FullScreen","gui/screen/options/component/getHumanReadableKey","gui/screen/game/GameMenuScreen"],function(e,t){"use strict";var r,s,a,i,n;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){a=e},function(e){i=e}],execute:function(){n=class extends i.GameMenuScreen{constructor(e,t){super(),this.strings=e,this.fullScreen=t}onEnter(e){this.params=e,this.controller.toggleContentAreaVisibility(!0),this.initView(e)}initView(e){let t=this.strings;var i=[{label:t.get("GUI:Options"),onClick:()=>{this.controller?.pushScreen(r.ScreenType.Options)}},{label:t.get("GUI:Fullscreen",a.getHumanReadableKey(s.FullScreen.hotKey)),tooltip:t.get("STT:Fullscreen"),onClick:()=>this.fullScreen.toggle()},{label:t.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(r.ScreenType.QuitConfirm,this.params)}},{label:t.get("GUI:ResumeMission"),isBottom:!0,onClick:e.onCancel}];this.controller.setSidebarButtons(i),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1)}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},e("GameMenuHomeScreen",n)}}}),System.register("gui/screen/game/gameMenu/QuitConfirmScreen",["gui/screen/game/GameMenuScreen"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.GameMenuScreen{constructor(e){super(),this.strings=e}onEnter(e){this.initView(e)}initView(e){let t=this.strings;var i=[{label:t.get("GUI:Quit"),onClick:e.onQuit},...e.observeAllowed?[{label:t.get("GUI:Observe"),onClick:e.onObserve}]:[],{label:t.get("GUI:ResumeMission"),isBottom:!0,onClick:e.onCancel}];this.controller.setSidebarButtons(i),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons()}},e("QuitConfirmScreen",r)}}}),System.register("gui/screen/game/gameMenu/ScreenParamsMap",["gui/screen/game/gameMenu/ScreenType"],function(e,t){"use strict";t&&t.id;return{setters:[function(e){0}],execute:function(){}}}),System.register("gui/screen/game/gameMenu/GameMenuController",["gui/screen/Controller"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.Controller{constructor(e){super(),this.hud=e,this.contentAreaVisible=!1}async goToScreenBlocking(...e){var[t,i]=e;return super.goToScreenBlocking(t,i)}goToScreen(...e){var[t,i]=e;return super.goToScreen(t,i)}async pushScreen(...e){var[t,i]=e;this.setMainComponent(),await super.pushScreen(t,i)}async popScreen(e){this.setMainComponent(),await super.popScreen(e)}async close(){for(;this.screenStack.length;)await this.popScreen()}setHud(e){this.hud=e}setSidebarButtons(e){this.sidebarButtons=e}showSidebarButtons(){if(void 0===this.sidebarButtons)throw new Error("Sidebar buttons should be set first");this.hud.showSidebarMenu(this.sidebarButtons)}hideSidebarButtons(){this.sidebarButtons=void 0,this.hud.hideSidebarMenu()}setMainComponent(e){this.mainContentComponent=e,this.hud.setMenuContentComponent(this.mainContentComponent)}toggleContentAreaVisibility(e){this.contentAreaVisible=e,this.hud.toggleMenuContentVisibility(e)}rerenderCurrentScreen(){super.rerenderCurrentScreen(),this.sidebarButtons&&this.hud.showSidebarMenu(this.sidebarButtons),this.hud.setMenuContentComponent(this.mainContentComponent),this.hud.toggleMenuContentVisibility(this.contentAreaVisible)}destroy(){super.destroy(),this.setMainComponent(void 0)}},e("GameMenuController",r)}}}),System.register("gui/screen/game/GameMenu",["util/disposable/CompositeDisposable","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","util/event"],function(e,t){"use strict";var o,s,r,l,i;t&&t.id;return{setters:[function(e){o=e},function(e){s=e},function(e){r=e},function(e){l=e}],execute:function(){e("GameMenu",i=class{constructor(e,t,i,r,s,a,n=!1){this.subScreens=e,this.game=t,this.localPlayer=i,this.chatHistory=r,this.gservCon=s,this.isSinglePlayer=a,this.isTournament=n,this.disposables=new o.CompositeDisposable,this._onOpen=new l.EventDispatcher,this._onQuit=new l.EventDispatcher,this._onObserve=new l.EventDispatcher,this._onCancel=new l.EventDispatcher,this._onToggleAlliance=new l.EventDispatcher,this._onSendMessage=new l.EventDispatcher}get onOpen(){return this._onOpen.asEvent()}get onQuit(){return this._onQuit.asEvent()}get onObserve(){return this._onObserve.asEvent()}get onCancel(){return this._onCancel.asEvent()}get onToggleAlliance(){return this._onToggleAlliance.asEvent()}get onSendMessage(){return this._onSendMessage.asEvent()}init(e){let t=new s.GameMenuController(e);for(var[i,r]of this.subScreens)t.addScreen(i,r);this.controller=t,this.disposables.add(t,()=>this.controller=void 0),this.bindHudEvents(e)}handleHudChange(e){this.controller&&(this.controller.setHud(e),this.bindHudEvents(e),this.controller.rerenderCurrentScreen())}bindHudEvents(e){e.onOptButtonClick.subscribe(()=>this.open()),e.onDiploButtonClick.subscribe(()=>this.openDiplo())}open(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(r.ScreenType.Home,{observeAllowed:!(this.isTournament||this.isSinglePlayer||void 0===this.localPlayer||this.localPlayer.isObserver||this.localPlayer.defeated),onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)},onObserve:()=>{this.controller.close(),this._onObserve.dispatch(this)},onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openDiplo(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(r.ScreenType.Diplo,{game:this.game,localPlayer:this.localPlayer,isSinglePlayer:this.isSinglePlayer,chatHistory:this.chatHistory,gservCon:this.gservCon,onToggleAlliance:(e,t)=>{this._onToggleAlliance.dispatch(e,t)},onSendMessage:e=>this._onSendMessage.dispatch(this,e),onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openConnectionInfo(e,t,i){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(r.ScreenType.ConnectionInfo,{players:e,localPlayer:this.localPlayer,chatHistory:this.chatHistory,chatNetHandler:i,gservCon:t,onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)}})):console.warn("Menu not initialized")}close(){this.controller?this.controller.getCurrentScreen()&&(this.controller.close(),this._onCancel.dispatch(this)):console.warn("Menu not initialized")}getCurrentScreen(){return this.controller?.getCurrentScreen()}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/SellMode",["gui/PointerType","util/event","game/gameobject/Building"],function(e,t){"use strict";var a,n,i,r;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){i=e}],execute:function(){e("SellMode",r=class{constructor(e,t,i,r,s){this.game=e,this.player=t,this.sidebarModel=i,this.pointer=r,this.renderer=s,this._onExecute=new n.EventDispatcher,this.onFrame=e=>{var t,i;(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,i=!(!(t=this.currentTile)||!this.findRefundableBuilding(t)),this.pointer.setPointerType(t?i?a.PointerType.Sell:a.PointerType.NoSell:a.PointerType.Default))}}get onExecute(){return this._onExecute.asEvent()}static factory(e,t,i,r,s){return new this(e,t,i,r,s)}enter(){this.sidebarModel.sellMode=!0,this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(e,t){t||(this.currentTile=e?.tile)}findRefundableBuilding(e){return this.game.map.getObjectsOnTile(e).find(e=>e.isBuilding()&&e.owner===this.player&&!e.rules.unsellable&&e.buildStatus===i.BuildStatus.Ready&&!e.warpedOutTrait.isActive()&&0<this.game.sellTrait.computeRefundValue(e))}execute(e,t){if(t)return!1;var i=e?.tile;if(!i)return!1;i=this.findRefundableBuilding(i);return i&&this._onExecute.dispatch(this,i),!1}cancel(){this.end()}end(){this.sidebarModel.sellMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd",["game/event/EventType","game/type/SuperWeaponType"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("LastRadarEventCmd",s=class{constructor(e,t,i){this.player=e,this.mapPanningHelper=t,this.cameraPan=i,this.eventHistory=[],this.eventPointer=-1}execute(){var e,t;this.eventHistory.length&&(this.lastRun?(t=(e=Date.now())-this.lastRun,this.lastRun=e,400<t?this.eventPointer=this.eventHistory.length-1:(this.eventPointer--,this.eventPointer<0&&(this.eventPointer=this.eventHistory.length-1))):this.lastRun=Date.now(),(t=this.eventHistory[this.eventPointer])&&(t=this.mapPanningHelper.computeCameraPanFromTile(t.rx,t.ry),this.cameraPan.setPan(t)))}recordEvent(e){this.eventHistory.push(e),this.eventHistory=this.eventHistory.slice(-8),this.eventPointer=this.eventHistory.length-1}handleGameEvent(t){switch(t.type){case i.EventType.RadarEvent:t.target===this.player&&this.recordEvent(t.tile);break;case i.EventType.BridgeRepair:t.source===this.player&&this.recordEvent(t.tile);break;case i.EventType.ObjectDestroy:{let e=t.target;e.isUnit()&&e.owner===this.player&&this.recordEvent(e.tile),e.isProjectile()&&e.isNuke&&this.recordEvent(e.tile)}break;case i.EventType.FactoryProduceUnit:var e=t.target;e.owner===this.player&&this.recordEvent(e.tile);break;case i.EventType.SuperWeaponActivate:e=t;[r.SuperWeaponType.IronCurtain,r.SuperWeaponType.ChronoSphere].includes(e.target)&&this.recordEvent(e.atTile2??e.atTile);break;case i.EventType.LightningStormManifest:this.recordEvent(t.target)}}})}}}),System.register("gui/screen/game/worldInteraction/RepairMode",["gui/PointerType","util/event"],function(e,t){"use strict";var a,n,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e}],execute:function(){e("RepairMode",i=class{constructor(e,t,i,r,s){this.game=e,this.player=t,this.sidebarModel=i,this.pointer=r,this.renderer=s,this._onExecute=new n.EventDispatcher,this.onFrame=e=>{var t,i;(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,i=!(!(t=this.currentTile)||!this.findRepairableBuilding(t)),this.pointer.setPointerType(t?i?a.PointerType.SideRepair:a.PointerType.NoRepair:a.PointerType.Default))}}get onExecute(){return this._onExecute.asEvent()}static factory(e,t,i,r,s){return new this(e,t,i,r,s)}enter(){this.sidebarModel.repairMode=!0,this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(e,t){t||(this.currentTile=e?.tile)}findRepairableBuilding(e){return this.game.map.getObjectsOnTile(e).find(e=>e.isBuilding()&&e.owner===this.player&&e.healthTrait.health<100&&e.rules.repairable&&e.rules.clickRepairable)}execute(e,t){if(t)return!1;var i=e?.tile;if(!i)return!1;i=this.findRepairableBuilding(i);return i&&this._onExecute.dispatch(this,i),!1}cancel(){this.end()}end(){this.sidebarModel.repairMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("engine/renderable/entity/WaypointLine",["three.meshline","game/Coords"],function(e,t){"use strict";var i,s,r;t&&t.id;return{setters:[function(e){i=e},function(e){s=e}],execute:function(){e("WaypointLine",r=class{constructor(e,t){this.linePath=e,this.camera=t,this.lastColor=this.linePath.color,this.lastBgColor=this.linePath.bgColor,this.lineHeadMaterial=new THREE.PointsMaterial({size:6,sizeAttenuation:!1,color:e.color,depthTest:!1,depthWrite:!1,transparent:!0}),this.lineHeadBgMaterial=new THREE.PointsMaterial({size:8,sizeAttenuation:!1,color:e.bgColor,depthTest:!1,depthWrite:!1,transparent:!0})}get3DObject(){return this.wrapper}create3DObject(){if(!this.wrapper){this.wrapper=new THREE.Object3D,this.wrapper.name="waypoint_line";let e=this.meshLine=new i.MeshLine,t=this.linePath.vertices.filter(e=>e.enabled).map(e=>e.position);this.lastLineVertexCount=t.length,e.setGeometry(t.map(e=>[e.x,e.y,e.z]).flat()),this.fgLineMesh=new THREE.Mesh(e.geometry,this.createFgLineMaterial(new THREE.Color(this.linePath.color),this.computeLineLength(t))),this.fgLineMesh.renderOrder=1000002,this.wrapper.add(this.fgLineMesh),this.bgLineMesh=new THREE.Mesh(e.geometry,this.createBgLineMaterial(new THREE.Color(this.linePath.bgColor))),this.bgLineMesh.renderOrder=1000001,this.wrapper.add(this.bgLineMesh),this.lineHeadMeshes=this.createLineHeads(this.linePath.vertices.filter(e=>e.enabled&&e.lineHead).map(e=>e.position)),this.lineHeadMeshes.forEach(e=>this.wrapper.add(e))}}update(e){this.lastUpdateMillis||(this.lastUpdateMillis=e);let i=(e-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=e;var t=this.camera.top+"_"+this.camera.right;if(t!==this.cameraHash&&(this.cameraHash=t,[this.fgLineMesh,this.bgLineMesh].forEach(e=>{e.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))})),this.linePath.verticesNeedUpdate){this.linePath.verticesNeedUpdate=!1;let e=this.linePath.vertices.filter(e=>e.enabled).map(e=>e.position);this.lastLineVertexCount!==e.length&&(this.lastLineVertexCount=e.length,this.meshLine.attributes=void 0),this.meshLine.setGeometry(e.map(e=>[e.x,e.y,e.z]).flat());let i=this.computeLineLength(e);[this.fgLineMesh].forEach(e=>{let t=e.material;t.uniforms.dashArray.value=this.computeDashArray(i)}),this.updateLineHeads(this.linePath.vertices.filter(e=>e.enabled&&e.lineHead).map(e=>e.position))}this.linePath.color!==this.lastColor&&(this.lastColor=this.linePath.color,this.fgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.color),this.lineHeadMaterial.color.set(this.linePath.color)),this.linePath.bgColor!==this.lastBgColor&&(this.lastBgColor=this.linePath.bgColor,this.bgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.bgColor),this.lineHeadBgMaterial.color.set(this.linePath.bgColor)),[this.fgLineMesh].forEach(e=>{let t=e.material;t.uniforms.dashOffset.value-=t.uniforms.dashArray.value/50*i})}computeLineLength(e){let t=0;for(let i=1,r=e.length;i<r;i++)t+=e[i].distanceTo(e[i-1]);return t}createFgLineMaterial(e,t){return new i.MeshLineMaterial({color:e,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(t),depthTest:!1})}createBgLineMaterial(e){return new i.MeshLineMaterial({color:e,lineWidth:4,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,depthTest:!1})}computeDashArray(e){return Math.min(1,5/e)*s.Coords.ISO_WORLD_SCALE}computeResolution(e){var t=e.top,i=e.right/e.top,r=2*t/Math.cos(e.rotation.y);return new THREE.Vector2(r*i,r).multiplyScalar(t*Math.cos(this.camera.rotation.x)/s.Coords.ISO_WORLD_SCALE)}createLineHeads(e){let t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e.map(e=>[e.x,e.y,e.z]).flat()),3));let i=new THREE.Points(t,this.lineHeadMaterial);i.renderOrder=1000004;let r=new THREE.Points(t,this.lineHeadBgMaterial);return r.renderOrder=1000003,[i,r]}updateLineHeads(e){var r=e.map(e=>[e.x,e.y,e.z]).flat();let t=this.lineHeadMeshes[0].geometry,s=t.getAttribute("position");if(s.array.length!==r.length)t.addAttribute("position",new THREE.BufferAttribute(new Float32Array(r),3));else{let e=s.array;for(let t=0,i=e.length;t<i;t++)e[t]=r[t];s.needsUpdate=!0}}dispose(){[this.fgLineMesh,this.bgLineMesh].forEach(e=>{e&&(e.geometry.dispose(),e.material.dispose())}),this.lineHeadMeshes?.forEach(e=>e.geometry.dispose()),this.lineHeadMaterial.dispose(),this.lineHeadBgMaterial.dispose()}})}}}),System.register("engine/renderable/entity/WaypointLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","util/array","engine/renderable/entity/WaypointLine"],function(t,e){"use strict";var i,l,o,c,h,r;e&&e.id;return{setters:[function(e){i=e},function(e){l=e},function(e){o=e},function(e){c=e}],execute:function(){var e;(e=h=h||{})[e.Source=0]="Source",e[e.InitialTarget=1]="InitialTarget",e[e.Waypoint=2]="Waypoint",t("WaypointLines",r=class{constructor(e,t,i,r,s){this.unitSelection=e,this.currentPlayer=t,this.selectedPaths=i,this.paths=r,this.camera=s,this.lastPathWaypoints=new Map,this.sourceLinePaths=new Map,this.waypointLinePaths=new Map}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="waypoint_lines",this.obj.matrixAutoUpdate=!1)}get3DObject(){return this.obj}update(r){var e=this.unitSelection.getHash(),t=void 0===this.selectionHash||this.selectionHash!==e;t&&(this.selectionHash=e);let i=!this.lastPaths||!o.equals(this.lastPaths,this.paths);if(i)this.lastPaths=[...this.paths];else for(var s of this.paths){var a=this.lastPathWaypoints.get(s);if(!a||!o.equals(s.waypoints,a)){i=!0,this.lastPathWaypoints.set(s,[...s.waypoints]);break}}if(t||i){let e=[],t=this.unitSelection.getSelectedUnits();1===t.length&&t[0].owner!==this.currentPlayer&&(t=[]),e=this.paths.length?[...new Set([...this.paths.map(e=>[...e.units]).flat(),...t])]:t,e=e.filter(e=>e.isSpawned),[...this.sourceLinePaths.values(),...this.waypointLinePaths.values()].forEach(e=>{let t=e.lineObj;t&&(this.obj.remove(t.get3DObject()),t.dispose())}),this.sourceLinePaths.clear(),this.waypointLinePaths.clear();for(let i of e)if(i.isUnit()){let e=this.createSourceLinePath(i,this.paths.find(e=>e.units.has(i)));this.sourceLinePaths.set(i,e),e.lineObj=new c.WaypointLine(e,this.camera),e.lineObj.create3DObject(),this.obj.add(e.lineObj.get3DObject()),e.lineObj.update(r)}for(var n of this.paths){let e=this.createWaypointLinePath(n,this.selectedPaths.includes(n));this.waypointLinePaths.set(n,e),e.lineObj=new c.WaypointLine(e,this.camera),e.lineObj.create3DObject(),this.obj.add(e.lineObj.get3DObject()),e.lineObj.update(r)}}else this.sourceLinePaths.forEach((e,t)=>{this.updateSourceLinePath(e,t,this.paths.find(e=>e.units.has(t))),e.lineObj.update(r)}),this.waypointLinePaths.forEach(e=>{this.updateWaypointLinePath(e),e.lineObj.update(r)})}createSourceLinePath(t,e){var i=!!t.unitOrderTrait.targetLinesConfig&&l.configHasTarget(t.unitOrderTrait.targetLinesConfig);let r=t.unitOrderTrait.waypointPath?e?.waypoints.find(e=>e.original===(t.unitOrderTrait.currentWaypoint??t.unitOrderTrait.waypointPath.waypoints[0])):e?.waypoints.find(e=>e.draft),s={vertices:[],verticesNeedUpdate:!1,color:10867711,bgColor:this.unitSelection.isSelected(t)?16777215:0};var a={type:h.Source,enabled:i||!!r,lineHead:!0,obj:t,position:t.position.worldPosition.clone()},i={type:h.InitialTarget,enabled:i&&(!t.unitOrderTrait.waypointPath||!t.unitOrderTrait.currentWaypoint),lineHead:!0,obj:t,position:i?this.computeInitialTargetPosition(t.unitOrderTrait.targetLinesConfig).clone():new THREE.Vector3};return s.vertices.push(a,i),r&&(i={type:h.Waypoint,enabled:!0,lineHead:!1,waypoint:r,position:r.target.getWorldCoords().clone()},s.vertices.push(i)),s}updateSourceLinePath(i,r,e){var s,a=r.unitOrderTrait.waypointPath?e?.waypoints.find(e=>e.original===(r.unitOrderTrait.currentWaypoint??r.unitOrderTrait.waypointPath.waypoints[0])):e?.waypoints.find(e=>e.draft),n=!!a,o=!!r.unitOrderTrait.targetLinesConfig&&l.configHasTarget(r.unitOrderTrait.targetLinesConfig);for(s of i.vertices){let e,t;s.type===h.Source?(e=n||o,t=r.position.worldPosition):s.type===h.InitialTarget?(e=o&&(!r.unitOrderTrait.waypointPath||!r.unitOrderTrait.currentWaypoint),o&&(t=this.computeInitialTargetPosition(s.obj.unitOrderTrait.targetLinesConfig))):(e=n,a&&(s.waypoint=a),t=s.waypoint.target.getWorldCoords()),t&&!t.equals(s.position)&&(i.verticesNeedUpdate=!0,s.position.copy(t)),void 0!==e&&e!==s.enabled&&(i.verticesNeedUpdate=!0,s.enabled=e)}}createWaypointLinePath(e,t){return{vertices:e.waypoints.map(e=>({type:h.Waypoint,enabled:!0,lineHead:!0,waypoint:e,position:e.target.getWorldCoords().clone()})),verticesNeedUpdate:!1,color:10867711,bgColor:t?16777215:0}}updateWaypointLinePath(t){for(var i of t.vertices){let e=i.waypoint.target.getWorldCoords();e.equals(i.position)||(i.position.copy(e),t.verticesNeedUpdate=!0)}}computeInitialTargetPosition(e){if(e.pathNodes.length){var t=e.pathNodes[0];return i.Coords.tile3dToWorld(t.tile.rx+.5,t.tile.ry+.5,t.tile.z+(t.onBridge?.tileElevation??0))}if(e.target)return e.target.position.worldPosition;throw new Error("No target and no pathNodes found")}dispose(){this.sourceLinePaths.forEach(e=>e.lineObj?.dispose()),this.waypointLinePaths.forEach(e=>e.lineObj?.dispose())}})}}}),System.register("gui/screen/game/worldInteraction/PlanningMode",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","engine/type/ObjectType","util/typeGuard","engine/renderable/entity/WaypointLines","game/action/OrderUnitsAction"],function(e,t){"use strict";var n,o,l,i,r,s,c,a;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){c=e}],execute:function(){e("PlanningMode",a=class{constructor(e,t,i,r,s,a,n,o,l,c){this.player=e,this.messageList=t,this.sound=i,this.strings=r,this.worldScene=s,this.unitSelection=a,this.unitSelectionHandler=n,this.renderer=o,this.targetLines=l,this.maxWaypointPathLength=c,this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits=new Set,this.onFrame=e=>{(!this.lastUpdate||e-this.lastUpdate>1e3/15)&&(this.lastUpdate=e,this.updatePaths())}}isActive(){return this.active}enter(){var e;this.active||(this.active=!0,this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!1),this.renderer.onFrame.subscribe(this.onFrame),e=new Set([...this.player.getOwnedObjectsByType(i.ObjectType.Infantry),...this.player.getOwnedObjectsByType(i.ObjectType.Vehicle)].map(e=>e.unitOrderTrait.waypointPath).filter(r.isNotNullOrUndefined)),this.paths=[...e].map(e=>{let i={original:e,units:new Set(e.units),waypoints:[]};return e.waypoints.forEach(e=>{var t={orderType:e.orderType,target:e.target,next:void 0,draft:!1,terminal:e.terminal,original:e};i.waypoints.length&&(i.waypoints[i.waypoints.length-1].next=t),i.waypoints.push(t)}),i}),e=this.waypointLines=new s.WaypointLines(this.unitSelection,this.player,this.selectedPaths,this.paths,this.worldScene.camera),this.worldScene.add(e))}pushOrder(t,i,r){if(t!==n.OrderType.Deploy)if(1<this.selectedPaths.length)this.handleInvalidCommand(this.strings.get("MSG:PlanningModeHeteroSel"));else if(this.selectedUnits.size>c.ORDER_UNIT_LIMIT)this.handleInvalidCommand(this.strings.get("MSG:PlannerMaximum"));else{for(var s of this.selectedUnits){if(s.isBuilding())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoBuildings"));if(s.isAircraft())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoAircraft"))}let e=this.selectedPaths[0];var a;!e&&this.selectedUnits.size&&(e={original:void 0,units:new Set(this.selectedUnits),waypoints:[]},this.paths.push(e),this.selectedPaths.push(e)),e&&(e.waypoints.length!==this.maxWaypointPathLength?e.waypoints.find(e=>e.target.equals(i))?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeInvalidNodeX")):e.waypoints.length&&e.waypoints.slice(e.waypoints[0].draft?0:1).find(e=>e.terminal)?this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")):(a={orderType:t,target:i,terminal:r,next:void 0,draft:!0,original:void 0},e.waypoints.length&&(e.waypoints[e.waypoints.length-1].next=a),e.waypoints.push(a),r?(this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")),this.unitSelectionHandler.deselectAll()):this.sound.play(o.SoundKey.AddPlanningModeCommandSound,l.ChannelType.Ui)):this.handleInvalidCommand(this.strings.get("MSG:NodeMaximum")))}else this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy"))}exit(){let e=this.paths;this.active&&(this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!0),this.renderer.onFrame.unsubscribe(this.onFrame),this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits.clear(),this.waypointLines&&(this.worldScene.remove(this.waypointLines),this.waypointLines.dispose(),this.waypointLines=void 0));for(var t of e)t.waypoints=t.waypoints.filter(e=>e.draft);return e.filter(e=>e.waypoints.length)}updatePaths(){for(let t of this.paths){var e;t.original&&(t.original.units.length===t.units.size||t.waypoints.find(e=>e.draft)||(t.units=new Set(t.original.units)),0===t.original.units.length?t.waypoints=t.waypoints.filter(e=>e.draft):t.waypoints=t.waypoints.filter(e=>e.draft||t.original.waypoints.includes(e.original)),t.waypoints.length||(this.paths.splice(this.paths.indexOf(t),1),-1!==(e=this.selectedPaths.indexOf(t))&&this.selectedPaths.splice(e,1)))}}updateSelection(e){this.updatePaths();let t=[...e],i=new Set;for(var r of e)for(var s of this.paths)s.units.has(r)&&(i.add(s),t.push(...s.units));this.selectedPaths.length=0,this.selectedPaths.push(...i);var a=new Set(t);if((this.selectedUnits=a).size!==e.length)return[...this.selectedUnits]}handleInvalidCommand(e){this.sound.play(o.SoundKey.ScoldSound,l.ChannelType.Ui),this.messageList.addUiFeedbackMessage(e)}dispose(){this.exit()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd",["util/disposable/CompositeDisposable"],function(e,t){"use strict";var n,i;t&&t.id;return{setters:[function(e){n=e}],execute:function(){e("SelectNextUnitCmd",i=class{constructor(e,t,i,r,s){this.unitSelectionHandler=e,this.mapPanningHelper=t,this.cameraPan=i,this.player=r,this.world=s,this.reverse=!1,this.unitList=[],this.disposables=new n.CompositeDisposable;const a=e=>{e.isTechno()&&e.owner===r&&this.unitList.push(e)};this.world.onObjectSpawned.subscribe(a),this.disposables.add(()=>this.world.onObjectSpawned.unsubscribe(a))}getNextUnit(){return this.generator||(this.generator=this.generate()),this.generator.next().value}*generate(){for(;;){var t=this.unitList=this.player.getOwnedObjects().filter(e=>e.isUnit()).sort((e,t)=>e.tile.dx+1e3*e.tile.dy-(t.tile.dx+1e3*t.tile.dy)+.1*(t.position.subCell-e.position.subCell));if(t.length){let e=this.reverse?t.length:-1;for(;this.reverse?0<=--e:++e<t.length;){if(this.unitSelectionHandler.getHash()!==this.lastSelectionHash){this.lastSelectionHash=this.unitSelectionHandler.getHash();break}var i=t[e];i.owner===this.player&&i.isSpawned&&(yield i)}}else yield void 0}}setReverse(e){this.reverse=e}execute(){var e=this.getNextUnit();e&&(this.unitSelectionHandler.selectSingleUnit(e),this.lastSelectionHash=this.unitSelectionHandler.getHash(),e=e.tile,e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("SetCameraLocationCmd",i=class{constructor(e,t,i){this.cameraPan=e,this.cameraLocations=t,this.idx=i}execute(){this.cameraLocations.set(this.idx,this.cameraPan.getPan())}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("GoToCameraLocationCmd",i=class{constructor(e,t,i,r){this.cameraPan=e,this.cameraLocations=t,this.idx=i,this.defaultLocation=r}execute(){var e=this.cameraLocations.get(this.idx)||this.defaultLocation;e&&this.cameraPan.setPan(e)}})}}}),System.register("gui/screen/game/TauntPlayback",["engine/sound/ChannelType","util/string"],function(e,t){"use strict";var s,i,r,a;t&&t.id;return{setters:[function(e){s=e},function(e){i=e}],execute:function(){r=(new Map).set("Americans","am").set("French","fr").set("Germans","ge").set("British","br").set("Russians","ru").set("Confederation","cu").set("Africans","li").set("Arabs","ir").set("Alliance","ko"),e("TauntPlayback",a=class{constructor(e,t){this.audioSystem=e,this.taunts=t}async playTaunt(e,t){var i=this.getTauntFileName(e.country.name,t),r=await this.taunts.get(i);r?this.audioSystem.playWavFile(r,s.ChannelType.Voice):console.warn(`Taunt file "${i}" not found.`)}getTauntFileName(e,t){return`tau${r.get(e)}${i.pad(t,"00")}.wav`}})}}}),System.register("gui/screen/game/TauntHandler",["util/disposable/CompositeDisposable"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("TauntHandler",i=class{constructor(e,t,i,r,s,a,n){this.gservCon=e,this.localPlayer=t,this.game=i,this.replayRecorder=r,this.tauntsEnabled=s,this.tauntPlayback=a,this.mutedPlayers=n,this.lastTauntTimeByPlayer=new Map,this.disposables=new o.CompositeDisposable,this.handleMessage=e=>{var t;!this.tauntsEnabled.value||(t=this.game.getPlayerByName(e.from)).country&&(this.mutedPlayers.has(t.name)||this.checkAndUpdateLastTauntTime(t.name)&&(this.recordReplayEvent(t,e.tauntNo),this.tauntPlayback.playTaunt(t,e.tauntNo).catch(e=>console.error(e))))}}init(){this.gservCon.onTaunt.subscribe(this.handleMessage),this.disposables.add(()=>this.gservCon.onTaunt.unsubscribe(this.handleMessage))}sendTaunt(e){this.checkAndUpdateLastTauntTime(this.localPlayer.name)&&this.gservCon.isOpen()&&(this.gservCon.sendTaunt(e),this.recordReplayEvent(this.localPlayer,e),this.tauntPlayback.playTaunt(this.localPlayer,e).catch(e=>console.error(e)))}checkAndUpdateLastTauntTime(e){var t=Date.now(),i=this.lastTauntTimeByPlayer.get(e);return!(i&&t-i<=5e3)&&(this.lastTauntTimeByPlayer.set(e,t),!0)}recordReplayEvent(e,t){this.replayRecorder.recordTaunt(this.game.currentTick,e.name,t)}dispose(){this.disposables.dispose()}})}}}),System.register("engine/gfx/lighting/LightningStormFx",["engine/gfx/lighting/LightingFx"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=class extends i.LightingFx{constructor(e,t){super(),this.durationGameSeconds=e,this.ionLighting=t,this.cloudAnims=[]}waitForCloudAnim(e){this.cloudAnims.push(e)}update(e,t){let i=!1,r=!1;return e===this.startTime&&(this.mapLighting.copy(this.ionLighting),i=!0),(e-this.startTime)/1e3*t>this.durationGameSeconds&&!this.cloudAnims.some(e=>!e.isAnimFinished())&&(r=!0),{done:r,updated:i}}},e("LightningStormFx",r)}}}),System.register("engine/renderable/fx/handler/SuperWeaponFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","util/math","engine/gfx/lighting/LightningStormFx","game/GameSpeed","game/type/SuperWeaponType","game/Coords"],function(e,t){"use strict";var i,r,s,a,n,o,l,c;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){e("SuperWeaponFxHandler",c=class{constructor(e,t,i){this.game=e,this.renderableManager=t,this.lightingDirector=i,this.disposables=new r.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(i.EventType.LightningStormCloud,t=>{var e=this.game.rules.audioVisual.weatherConClouds,e=e[s.getRandomInt(0,e.length-1)],e=this.renderableManager.createTransientAnim(e,e=>{e.setPosition(t.position)});this.lightingFx?.waitForCloudAnim(e)}),this.game.events.subscribe(i.EventType.LightningStormManifest,()=>{var e=this.lightingFx=new a.LightningStormFx(this.game.rules.general.lightningStorm.duration/n.GameSpeed.BASE_TICKS_PER_SECOND,this.game.map.getIonLighting());this.lightingDirector.addEffect(e)}),this.game.events.subscribe(i.EventType.SuperWeaponActivate,r=>{var e=r.target;if(e===o.SuperWeaponType.IronCurtain)this.renderableManager.createTransientAnim(this.game.rules.audioVisual.ironCurtainInvokeAnim,e=>{var t=l.Coords.tile3dToWorld(r.atTile.rx+.5,r.atTile.ry+.5,r.atTile.z);e.setPosition(t)});else if(e===o.SuperWeaponType.ChronoSphere){this.disposeChronoSphereAnim();var s=this.game.map.tileOccupation.getBridgeOnTile(r.atTile)?.tileElevation??0;let t=l.Coords.tile3dToWorld(r.atTile.rx+.5,r.atTile.ry+.5,r.atTile.z+s);e=r.atTile2,s=this.game.map.tileOccupation.getBridgeOnTile(e)?.tileElevation??0;let i=l.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z+s);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlast,e=>{e.setPosition(t)}),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlastDest,e=>{e.setPosition(i)})}}))}createChronoSphereAnim(i){this.chronoSphereAnim=this.renderableManager.createAnim(this.game.rules.audioVisual.chronoPlacement,e=>{var t=this.game.map.tileOccupation.getBridgeOnTile(i)?.tileElevation??0,t=l.Coords.tile3dToWorld(i.rx+.5,i.ry+.5,i.z+t);e.setPosition(t)})}disposeChronoSphereAnim(){let e=this.chronoSphereAnim;e&&(this.renderableManager.getRenderableContainer()?.remove(e),e.dispose())}dispose(){this.lightingFx=void 0,this.disposeChronoSphereAnim(),this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/SpecialActionMode",["gui/PointerType","util/event","game/type/SuperWeaponType"],function(e,t){"use strict";var r,a,s,n,i;t&&t.id;return{setters:[function(e){r=e},function(e){a=e},function(e){s=e}],execute:function(){n=(new Map).set(s.SuperWeaponType.MultiMissile,r.PointerType.Nuke).set(s.SuperWeaponType.LightningStorm,r.PointerType.Storm).set(s.SuperWeaponType.IronCurtain,r.PointerType.Iron).set(s.SuperWeaponType.ChronoSphere,r.PointerType.Chrono).set(s.SuperWeaponType.ChronoWarp,r.PointerType.Chrono).set(s.SuperWeaponType.AmerParaDrop,r.PointerType.Para).set(s.SuperWeaponType.ParaDrop,r.PointerType.Para),e("SpecialActionMode",i=class{constructor(e,t,i,r,s){this.allSuperWeaponRules=e,this.superWeaponRules=t,this.superWeaponFxHandler=i,this.pointer=r,this.eva=s,this._onExecute=new a.EventDispatcher,this.isPostClick=!1,this.pointerSwType=this.superWeaponRules.type}get onExecute(){return this._onExecute.asEvent()}get superWeaponType(){return this.superWeaponRules.type}static factory(e,t,i,r,s){return new this(e,t,i,r,s)}enter(){this.eva.play("EVA_SelectTarget")}hover(e){var t=e?.tile,i=n.get(this.pointerSwType);this.pointer.setPointerType(t&&void 0!==i?i:r.PointerType.Default)}execute(e){var t=e?.tile;if(!t)return!1;if(this.superWeaponRules.type!==s.SuperWeaponType.ChronoSphere||this.isPostClick||this.superWeaponFxHandler.createChronoSphereAnim(t),this.superWeaponRules.preClick&&!this.isPostClick){this.isPostClick=!0,this.preTile=t;var i=[...this.allSuperWeaponRules.values()].find(e=>e.postClick&&e.preDependent===this.superWeaponRules.type)?.type;if(void 0===i)throw new Error('No super weapon section found with PostClick=yes and PreDependent="'+s.SuperWeaponType[this.superWeaponRules.type]);return this.pointerSwType=i,!1}this._onExecute.dispatch(this,this.isPostClick?{tile:this.preTile,tile2:t}:{tile:t,tile2:void 0})}cancel(){this.end()}end(){this.superWeaponRules.type===s.SuperWeaponType.ChronoSphere&&this.isPostClick&&this.superWeaponFxHandler.disposeChronoSphereAnim()}dispose(){this.end()}})}}}),System.register("game/action/PingLocationAction",["game/action/Action","data/DataStream","game/action/ActionType","game/event/PingLocationEvent","game/event/RadarEvent","game/rules/general/RadarRules"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends i.Action{constructor(e){super(s.ActionType.PingLocation),this.game=e}unserialize(e){let t=new r.DataStream(e);this.tile={x:t.readUint16(),y:t.readUint16()}}serialize(){let e=new r.DataStream(4);return e.writeUint16(this.tile.x),e.writeUint16(this.tile.y),e.toUint8Array()}print(){return`Ping location at tile (${this.tile.x}, ${this.tile.y})`}process(){var e=this.player,t=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(t){this.game.events.dispatch(new a.PingLocationEvent(t,e));for(var i of[e,...this.game.alliances.getAllies(e)])this.game.events.dispatch(new n.RadarEvent(i,o.RadarEventType.GenericNonCombat,t))}else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},e("PingLocationAction",l)}}}),System.register("engine/renderable/fx/handler/BeaconFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","engine/sound/SoundKey"],function(e,t){"use strict";var i,a,n,o,r;t&&t.id;return{setters:[function(e){i=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){0,e("BeaconFxHandler",r=class{constructor(e,t,i,r,s){this.game=e,this.localPlayer=t,this.renderableManager=i,this.renderer=r,this.worldSound=s,this.disposables=new a.CompositeDisposable,this.beacons=new Map,this.handlePingEvent=r=>{if((!this.localPlayer||this.localPlayer.isObserver||r.player===this.localPlayer||this.game.alliances.areAllied(r.player,this.localPlayer))&&this.canPingLocation(r.player,r.tile)){let e=this.beacons.get(r.player);e||(e=[],this.beacons.set(r.player,e));let t=e.find(e=>e.tile===r.tile);var s=r.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(r.tile):void 0;let i=n.Coords.tile3dToWorld(r.tile.rx+.5,r.tile.ry+.5,r.tile.z+(s?.tileElevation??0));this.worldSound.playEffect(o.SoundKey.PlaceBeaconSound,i,r.player),t?t.startTime=this.now:(s=this.renderableManager.createTransientAnim("PBEACON",e=>{e.setPosition(i),e.setRenderOrder(1e6),e.remapColor(r.player.color),e.create3DObject()}),e.push({tile:r.tile,anim:s,startTime:this.now}))}},this.handleFrame=e=>{this.now=e;for(var t of this.beacons.values())for(var i of t.slice())if(void 0===i.startTime)i.startTime=e;else if(e>i.startTime+7e3){i.anim.endAnimationLoop();i=t.indexOf(i);if(-1===i)throw new Error("Beacon not found in array");t.splice(i,1)}}}init(){this.disposables.add(this.game.events.subscribe(i.EventType.PingLocation,this.handlePingEvent)),this.renderer.onFrame.subscribe(this.handleFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.handleFrame))}canPingLocation(e,t){let i=this.beacons.get(e)??[];var r=i.reduce((e,t)=>Math.max(e,t.startTime??0),0);return(i.length<3||i.some(e=>e.tile===t))&&(!this.now||this.now-r>=1e3/3)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("CenterViewCmd",i=class{constructor(e,t,i){this.unitSelectionHandler=e,this.mapPanningHelper=t,this.cameraPan=i}execute(){var e=this.unitSelectionHandler.getSelectedUnits();e.length&&(e=this.computePanTile(e),e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}computePanTile(e){return{rx:Math.floor(e.reduce((e,t)=>e+t.tile.rx,0)/e.length),ry:Math.floor(e.reduce((e,t)=>e+t.tile.ry,0)/e.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd",["util/disposable/CompositeDisposable"],function(e,t){"use strict";var n,i;t&&t.id;return{setters:[function(e){n=e}],execute:function(){e("FollowUnitCmd",i=class{constructor(e,t,i,r,s,a){this.unitSelectionHandler=e,this.renderableManager=t,this.worldInteraction=i,this.mapPanningHelper=r,this.cameraPan=s,this.worldScene=a,this.disposables=new n.CompositeDisposable,this.handleUserSelectionChange=()=>{this.updateUnit(void 0)},this.handleFrame=()=>{let e=this.unitSelectionHandler.getSelectedUnits();this.unit&&!e.includes(this.unit)&&this.updateUnit(void 0),this.unit&&this.updatePan(this.unit)}}init(){this.unitSelectionHandler.onUserSelectionUpdate.subscribe(this.handleUserSelectionChange),this.disposables.add(()=>this.unitSelectionHandler.onUserSelectionUpdate.unsubscribe(this.handleUserSelectionChange)),this.worldScene.onBeforeCameraUpdate.subscribe(this.handleFrame),this.disposables.add(()=>this.worldScene.onBeforeCameraUpdate.unsubscribe(this.handleFrame))}execute(){let e=this.unitSelectionHandler.getSelectedUnits();this.unit&&!e.includes(this.unit)&&this.updateUnit(void 0),this.updateUnit(this.unit?void 0:e[0]),this.unit&&this.updatePan(this.unit)}updateUnit(e){(this.unit=e)?this.worldInteraction.pausePanning():this.worldInteraction.unpausePanning()}updatePan(e){let t=this.renderableManager.getRenderableByGameObject(e);var i;t&&(i=this.mapPanningHelper.computeCameraPanFromWorld(t.getPosition()),this.cameraPan.setPan(i))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/PendingPlacementHandler",["game/event/EventType","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/placementMode/PlacementGrid"],function(e,t){"use strict";var i,s,r,a;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){r=e}],execute:function(){e("PendingPlacementHandler",a=class{constructor(e,t,i,r){this.game=e,this.constructionWorker=t,this.renderer=i,this.worldScene=r,this.placements=[],this.gridModels=new Map,this.grids=new Map,this.disposables=new s.CompositeDisposable,this.onFrame=()=>{for(var t of this.placements){let e=this.gridModels.get(t);var i;e&&(i=t.rules.name,e.tiles=this.constructionWorker.getPlacementPreview(i,t.tile,{normalizedTile:!0}))}}}static factory(e,t,i,r){var s=e.getConstructionWorker(t);return new this(e,s,i,r)}pushPlacementInfo(e){this.placements.push(e),this.addGrid(e)}init(){this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame)),this.disposables.add(this.game.events.subscribe(i.EventType.BuildingPlace,e=>{this.removePendingPlacement(e.target.tile)}),this.game.events.subscribe(i.EventType.BuildingFailedPlace,e=>{this.removePendingPlacement(e.tile)}))}removePendingPlacement(t){var e=this.placements.findIndex(e=>e.tile===t),i=this.placements[e];-1!==e&&(this.placements.splice(e,1),this.removeGrid(i))}addGrid(e){var t={tiles:this.constructionWorker.getPlacementPreview(e.rules.name,e.tile,{normalizedTile:!0}),visible:!0,rangeIndicator:void 0,rangeIndicatorColor:void 0,showBusy:!0},i=new r.PlacementGrid(t,this.worldScene.camera,this.game.map.tiles);this.worldScene.add(i),this.gridModels.set(e,t),this.grids.set(e,i)}removeGrid(e){let t=this.grids.get(e);t&&(this.worldScene.remove(t),t.dispose(),this.gridModels.delete(e))}dispose(){for(var e of this.placements)this.removeGrid(e);this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/BeaconMode",["gui/PointerType","util/event"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("BeaconMode",s=class{constructor(e,t){this.pointer=e,this.renderer=t,this._onExecute=new r.EventDispatcher,this.onFrame=e=>{var t;(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,t=this.currentTile,this.pointer.setPointerType(t?i.PointerType.Beacon:i.PointerType.Default))}}get onExecute(){return this._onExecute.asEvent()}static factory(e,t){return new this(e,t)}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(e,t){t||(this.currentTile=e?.tile)}execute(e,t){if(t)return!1;var i=e?.tile;if(!i)return!1;this._onExecute.dispatch(this,i),this.end()}cancel(){this.end()}end(){this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/mainMenu/main/ReportBug",["react"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ReportBug",({strings:e,discordUrl:t})=>i.createElement("div",null,e.get("TS:ReportBugDesc"),i.createElement("br",null),i.createElement("br",null),i.createElement("a",{target:"_blank",href:t},t)))}}}),System.register("gui/screen/game/CombatantUi",["react","gui/screen/game/worldInteraction/PlacementMode","game/action/ActionType","util/disposable/CompositeDisposable","engine/sound/SoundKey","engine/sound/ChannelType","game/order/OrderType","game/action/OrderUnitsAction","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd","gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd","gui/screen/game/component/hud/viewmodel/SidebarModel","game/event/EventType","gui/screen/game/worldInteraction/SellMode","gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/UpdateQueueAction","gui/screen/game/worldInteraction/RepairMode","gui/screen/game/worldInteraction/keyboard/KeyCommand","gui/screen/game/worldInteraction/PlanningMode","game/order/OrderFeedbackType","game/rules/TechnoRules","gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","gui/screen/game/worldInteraction/SpecialActionMode","game/SuperWeapon","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/worldInteraction/PendingPlacementHandler","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/worldInteraction/BeaconMode","gui/screen/mainMenu/main/ReportBug"],function(e,t){"use strict";var l,c,g,E,p,m,f,h,y,T,v,b,S,r,u,w,C,x,d,O,A,M,R,P,I,k,B,i,j,N,L,D,F,_,U,s;t&&t.id;return{setters:[function(e){l=e},function(e){c=e},function(e){g=e},function(e){E=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){h=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){r=e},function(e){u=e},function(e){w=e},function(e){C=e},function(e){x=e},function(e){d=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){i=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e}],execute:function(){e("CombatantUi",s=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C){this.game=e,this.player=t,this.isSinglePlayer=i,this.actionQueue=r,this.actionFactory=s,this.sidebarModel=a,this.renderer=n,this.worldScene=o,this.soundHandler=l,this.messageList=c,this.sound=h,this.eva=u,this.worldInteractionFactory=d,this.gameMenu=g,this.pointer=p,this.runtimeVars=m,this.speedCheat=f,this.strings=y,this.tauntHandler=T,this.renderableManager=v,this.superWeaponFxHandler=b,this.beaconFxHandler=S,this.messageBoxApi=w,this.discordUrl=C,this.disposables=new E.CompositeDisposable}init(e){let r=this.game.getUnitSelection(),t=c.PlacementMode.factory(this.game,this.player,this.renderer,this.worldScene,this.eva);this.placementMode=t,this.disposables.add(t);let s=D.PendingPlacementHandler.factory(this.game,this.player,this.renderer,this.worldScene);s.init(),this.disposables.add(s),t.onBuildingPlaceRequest.subscribe(({rules:t,tile:i})=>{s.pushPlacementInfo({rules:t,tile:i}),this.pushAction(g.ActionType.PlaceBuilding,e=>{e.buildingRules=t,e.tile={x:i.rx,y:i.ry}})});let i=u.SellMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.sellMode=i,this.disposables.add(i),i.onExecute.subscribe(t=>{this.pushAction(g.ActionType.SellBuilding,e=>{e.buildingId=t.id})});let a=O.RepairMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.repairMode=a,this.disposables.add(a);let n=_.BeaconMode.factory(this.pointer,this.renderer);this.beaconMode=n,this.disposables.add(n),a.onExecute.subscribe(t=>{this.pushAction(g.ActionType.ToggleRepair,e=>{e.buildingId=t.id}),this.sound.play(p.SoundKey.GenericClick,m.ChannelType.Ui)}),n.onExecute.subscribe(e=>this.handleBeacon(e));let o=this.worldInteractionFactory.create();this.worldInteraction=o,o.init(),this.disposables.add(o);let l=new M.PlanningMode(this.player,this.messageList,this.sound,this.strings,this.worldScene,r,o.unitSelectionHandler,this.renderer,o.targetLines,this.game.rules.general.maxWaypointPathLength);this.planningMode=l,this.disposables.add(l),this.disposables.add(()=>this.specialMode?.dispose()),t.init(),this.initKeyboardCommands(o),this.initGameEventListeners(),this.initGameMenuListeners(),this.initHudEventListeners(e,i,a,n,o),this.lastSelectionHash=r.getHash(),o.unitSelectionHandler.onUserSelectionChange.subscribe(e=>{if(l.isActive()){var t=l.updateSelection(e.selection);if(t)for(var i of t)r.addToSelection(i)}this.lastSelectionHash=r.getHash(),this.pushAction(g.ActionType.SelectUnits,e=>{e.unitIds=r.getSelectedUnits().map(e=>e.id)})}),o.unitSelectionHandler.onUserSelectionUpdate.subscribe(e=>this.soundHandler.handleSelectionChangeEvent(e)),o.defaultActionHandler.onOrder.subscribe(({orderType:e,terminal:t,feedbackType:i,feedbackUnit:r,target:s})=>{l.isActive()?l.pushOrder(e,s,t):this.pushOrder(e,s,i,r)})}handleHudChange(e){this.worldInteraction&&this.initHudEventListeners(e,this.sellMode,this.repairMode,this.beaconMode,this.worldInteraction)}dispose(){this.disposables.dispose()}initGameEventListeners(){let e=e=>{e.isTechno()&&e.owner===this.player&&(e.isBuilding()||Number.isFinite(e.rules.buildLimit)||e.isVehicle()&&e.transportTrait||this.game.rules.general.padAircraft.includes(e.name))&&(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))},t=this.game.getWorld();this.sidebarModel.updateAvailableObjects(this.game.art),t.onObjectSpawned.subscribe(e),t.onObjectRemoved.subscribe(e),this.disposables.add(()=>t.onObjectSpawned.unsubscribe(e),()=>t.onObjectRemoved.unsubscribe(e)),this.disposables.add(this.game.events.subscribe(r.EventType.BuildingInfiltration,e=>{e.source.owner===this.player&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.disposables.add(this.game.events.subscribe(r.EventType.ObjectOwnerChange,e=>{!e.target.isBuilding()||e.prevOwner!==this.player&&e.target.owner!==this.player||(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))})),this.player.production.onQueueUpdate.subscribe(e=>{this.sidebarModel.updateFromQueue(e);var t=this.placementMode.getBuilding();t&&!this.player.production.getQueueForObject(t).find(t).length&&this.worldInteraction.setMode(void 0),this.soundHandler.handleProductionQueueUpdate(e)});let i=()=>{this.sidebarModel.updateSuperWeapons(),this.specialMode&&this.worldInteraction.getMode()===this.specialMode&&!this.player.superWeaponsTrait.getAll().find(e=>e.rules.type===this.specialMode.superWeaponType)&&(this.worldInteraction.setMode(void 0),this.specialMode.dispose(),this.specialMode=void 0)};this.renderer.onFrame.subscribe(i),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(i)),this.disposables.add(this.game.events.subscribe(e=>{e.type===r.EventType.PowerChange&&e.target===this.player&&(this.sidebarModel.powerGenerated=e.power,this.sidebarModel.powerDrained=e.drain)}))}initGameMenuListeners(){const e=(t,i)=>{this.pushAction(g.ActionType.ToggleAlliance,e=>{e.toPlayer=i,e.toggle=t})};this.gameMenu.onToggleAlliance.subscribe(e),this.disposables.add(()=>this.gameMenu.onToggleAlliance.unsubscribe(e))}initHudEventListeners(e,t,i,r,s){e.onSidebarSlotClick.subscribe(e=>this.handleSidebarSlotClick(e)),e.onSidebarTabClick.subscribe(()=>{this.sound.play(p.SoundKey.GUITabSound,m.ChannelType.Ui)}),e.onRepairButtonClick.subscribe(()=>{s.isEnabled()&&(this.sidebarModel.repairMode?s.setMode(void 0):s.setMode(i),this.sound.play(p.SoundKey.GenericClick,m.ChannelType.Ui))}),e.onSellButtonClick.subscribe(()=>{s.isEnabled()&&(this.sidebarModel.sellMode?s.setMode(void 0):s.setMode(t),this.sound.play(p.SoundKey.GenericClick,m.ChannelType.Ui))});let a=this.game.rules.audioVisual.creditTicks;e.onCreditsTick.subscribe(e=>{this.sound.play("up"===e?a[0]:a[1],m.ChannelType.CreditTicks)}),e.onMessagesTick.subscribe(()=>{this.sound.play(p.SoundKey.MessageCharTyped,m.ChannelType.Ui)}),e.onScrollButtonClick.subscribe(e=>{this.sound.play(e?p.SoundKey.GenericClick:p.SoundKey.ScoldSound,m.ChannelType.Ui)});let n=!1,o=s.unitSelectionHandler;e.onCommandBarButtonClick.subscribe(e=>{switch(e){case F.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(l.createElement(U.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"));break;case F.CommandBarButtonType.Beacon:s.getMode()!==r&&s.setMode(r);break;case F.CommandBarButtonType.Cheer:this.pushOrder(f.OrderType.Cheer,void 0);break;case F.CommandBarButtonType.Deploy:this.handleDeploy();break;case F.CommandBarButtonType.Guard:this.handleGuard();break;case F.CommandBarButtonType.PlanningMode:var t;this.planningMode.isActive()?(t=this.planningMode.exit(),this.sound.play(p.SoundKey.EndPlanningModeSound,m.ChannelType.Ui),this.queueOrders(t),n||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),n=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(s.unitSelectionHandler.getSelectedUnits()),this.sound.play(p.SoundKey.StartPlanningModeSound,m.ChannelType.Ui),n||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Button")));break;case F.CommandBarButtonType.Stop:this.handleStop();break;case F.CommandBarButtonType.Team01:this.handleCommandBarTeam(1,o);break;case F.CommandBarButtonType.Team02:this.handleCommandBarTeam(2,o);break;case F.CommandBarButtonType.Team03:this.handleCommandBarTeam(3,o);break;case F.CommandBarButtonType.TypeSelect:o.selectByType();break;default:console.warn("Unhandled command type "+e)}})}handleSidebarSlotClick(s){if(this.worldInteraction.isEnabled())if((s=s.isTouch&&0===s.button&&s.touchDuration&&300<s.touchDuration?{...s,shiftKey:!0,button:2}:s).target.type!==S.SidebarItemTargetType.Special){const o=s.target.rules;let i=this.player.production.getQueueForObject(o),e=i.find(o);var a=e.reduce((e,t)=>e+t.quantity,0);let r=!1;if(0===s.button)if(i.status===C.QueueStatus.Ready&&o.type===x.ObjectType.Building)e[0]===i.getFirst()?(this.placementMode.setBuilding(o),this.worldInteraction.setMode(this.placementMode)):this.eva.play("EVA_UnableToComply");else if(i.status===C.QueueStatus.OnHold&&e[0]===i.getFirst())this.pushAction(g.ActionType.UpdateQueue,e=>{e.queueType=i.type,e.updateType=d.UpdateType.Resume});else{var n=Math.min(i.maxSize-i.currentSize,i.maxItemQuantity-a);let t=Math.min(s.shiftKey?5:1,n);t<=0?o.type===x.ObjectType.Building?this.eva.play("EVA_UnableToComply"):(r=!0,this.sound.play(p.SoundKey.ScoldSound,m.ChannelType.Ui)):this.pushAction(g.ActionType.UpdateQueue,e=>{e.queueType=i.type,e.updateType=d.UpdateType.Add,e.item=o,e.quantity=t})}else{if(2!==s.button)return;if(i.status===C.QueueStatus.Active&&e[0]===i.getFirst())this.pushAction(g.ActionType.UpdateQueue,e=>{e.queueType=i.type,e.updateType=d.UpdateType.Pause});else if(e.length&&[C.QueueStatus.Ready,C.QueueStatus.OnHold,C.QueueStatus.Active].includes(i.status)){let t=Math.min(a,s.shiftKey?Number.POSITIVE_INFINITY:1);0<t&&(this.pushAction(g.ActionType.UpdateQueue,e=>{e.queueType=i.type,e.updateType=d.UpdateType.Cancel,e.item=o,e.quantity=t}),this.eva.play("EVA_Canceled"))}else r=!0}r||this.sound.play(p.SoundKey.GenericClick,m.ChannelType.Ui)}else if(0===s.button){if(this.sound.play(p.SoundKey.GenericClick,m.ChannelType.Ui),this.player.superWeaponsTrait?.getAll().find(e=>e.rules===s.target.rules)?.status!==j.SuperWeaponStatus.Ready)return;void 0!==s.target.rules.type&&this.activateSpecialMode(s.target.rules)}}pushOrder(t,i,e=R.OrderFeedbackType.None,r=void 0){let s=this.game.getUnitSelection();var a=s.getHash();let n=s.getSelectedUnits(),o=this.actionQueue.getLast();if(o&&o instanceof h.OrderUnitsAction&&o.orderType===t&&!o.queue&&a===this.lastSelectionHash){if(!o.target||!i||o.target.equals(i))return;this.actionQueue.dequeueLast()}a!==this.lastSelectionHash&&(this.lastSelectionHash=a,this.pushAction(g.ActionType.SelectUnits,e=>{e.unitIds=n.map(e=>e.id)})),this.pushAction(g.ActionType.OrderUnits,e=>{e.orderType=t,e.target=i}),this.soundHandler.handleOrderPushed(r||n[0],t,e)}queueOrders(e){if(e.length){for(let i of e){this.pushAction(g.ActionType.SelectUnits,e=>{e.unitIds=[...i.units].map(e=>e.id)});for(let t of i.waypoints)this.pushAction(g.ActionType.OrderUnits,e=>{e.orderType=t.orderType,e.target=t.target,e.queue=!0})}this.pushAction(g.ActionType.SelectUnits,e=>{e.unitIds=this.worldInteraction.unitSelectionHandler.getSelectedUnits().map(e=>e.id)})}}pushAction(e,t){var i=this.actionFactory.create(e);t?.(i),this.actionQueue.push(i)}activateSpecialMode(r){this.specialMode?.dispose();let e=this.specialMode=i.SpecialActionMode.factory(this.game.rules.superWeaponRules,r,this.superWeaponFxHandler,this.pointer,this.eva);e.onExecute.subscribe(({tile:t,tile2:i})=>{this.pushAction(g.ActionType.ActivateSuperWeapon,e=>{e.superWeaponType=r.type,e.tile={x:t.rx,y:t.ry},i&&(e.tile2={x:i.rx,y:i.ry})})}),this.worldInteraction.setMode(e)}initKeyboardCommands(r){let i=r.unitSelectionHandler;r.registerKeyCommand(y.KeyCommandType.Options,()=>this.gameMenu.open()).registerKeyCommand(y.KeyCommandType.Scoreboard,()=>this.gameMenu.openDiplo()).registerKeyCommand(y.KeyCommandType.DeployObject,()=>this.handleDeploy()).registerKeyCommand(y.KeyCommandType.StopObject,()=>this.handleStop()).registerKeyCommand(y.KeyCommandType.GuardObject,()=>this.handleGuard()).registerKeyCommand(y.KeyCommandType.AllToCheer,()=>this.pushOrder(f.OrderType.Cheer,void 0)).registerKeyCommand(y.KeyCommandType.TypeSelect,()=>i.selectByType()).registerKeyCommand(y.KeyCommandType.CombatantSelect,()=>i.selectCombatants()).registerKeyCommand(y.KeyCommandType.VeterancyNav,()=>i.selectByVeterancy()).registerKeyCommand(y.KeyCommandType.HealthNav,()=>i.selectByHealth()),[y.KeyCommandType.TeamCreate_1,y.KeyCommandType.TeamCreate_2,y.KeyCommandType.TeamCreate_3,y.KeyCommandType.TeamCreate_4,y.KeyCommandType.TeamCreate_5,y.KeyCommandType.TeamCreate_6,y.KeyCommandType.TeamCreate_7,y.KeyCommandType.TeamCreate_8,y.KeyCommandType.TeamCreate_9,y.KeyCommandType.TeamCreate_10].forEach((e,t)=>r.registerKeyCommand(e,()=>i.createGroup((t+1)%10))),[y.KeyCommandType.TeamAddSelect_1,y.KeyCommandType.TeamAddSelect_2,y.KeyCommandType.TeamAddSelect_3,y.KeyCommandType.TeamAddSelect_4,y.KeyCommandType.TeamAddSelect_5,y.KeyCommandType.TeamAddSelect_6,y.KeyCommandType.TeamAddSelect_7,y.KeyCommandType.TeamAddSelect_8,y.KeyCommandType.TeamAddSelect_9,y.KeyCommandType.TeamAddSelect_10].forEach((e,t)=>r.registerKeyCommand(e,()=>i.addGroupToSelection((t+1)%10)));let s=new T.MapPanningHelper(this.game.map);[y.KeyCommandType.TeamSelect_1,y.KeyCommandType.TeamSelect_2,y.KeyCommandType.TeamSelect_3,y.KeyCommandType.TeamSelect_4,y.KeyCommandType.TeamSelect_5,y.KeyCommandType.TeamSelect_6,y.KeyCommandType.TeamSelect_7,y.KeyCommandType.TeamSelect_8,y.KeyCommandType.TeamSelect_9,y.KeyCommandType.TeamSelect_10].forEach((e,t)=>r.registerKeyCommand(e,new v.SelectGroupCmd((t+1)%10,i,r.targetLines,s,this.worldScene.cameraPan))),[y.KeyCommandType.TeamCenter_1,y.KeyCommandType.TeamCenter_2,y.KeyCommandType.TeamCenter_3,y.KeyCommandType.TeamCenter_4,y.KeyCommandType.TeamCenter_5,y.KeyCommandType.TeamCenter_6,y.KeyCommandType.TeamCenter_7,y.KeyCommandType.TeamCenter_8,y.KeyCommandType.TeamCenter_9,y.KeyCommandType.TeamCenter_10].forEach((e,t)=>r.registerKeyCommand(e,new b.CenterGroupCmd((t+1)%10,i,s,this.worldScene.cameraPan))),new Map([[y.KeyCommandType.StructureTab,S.SidebarCategory.Structures],[y.KeyCommandType.DefenseTab,S.SidebarCategory.Armory],[y.KeyCommandType.InfantryTab,S.SidebarCategory.Infantry],[y.KeyCommandType.UnitTab,S.SidebarCategory.Vehicles]]).forEach((i,e)=>{r.registerKeyCommand(e,()=>{var e;this.sidebarModel.selectTab(i);for(e of this.player.production.getAllQueues().filter(e=>e.status===C.QueueStatus.Ready)){var t=this.sidebarModel.getTabForQueueType(e.type);if(i===t.id&&e.getFirst().rules.type===x.ObjectType.Building){this.placementMode.setBuilding(e.getFirst().rules),r.setMode(this.placementMode);break}}})}),r.registerKeyCommand(y.KeyCommandType.CenterBase,()=>{let e;var t=this.player.production.getPrimaryFactory(P.FactoryType.BuildingType);t?e=t.centerTile:(t=this.player.getOwnedObjectsByType(x.ObjectType.Vehicle).find(e=>this.game.rules.general.baseUnit.includes(e.name)))&&(e=t.tile),e&&this.worldScene.cameraPan.setPan(s.computeCameraPanFromTile(e.rx,e.ry))}),r.registerKeyCommand(y.KeyCommandType.ToggleSell,()=>{this.sidebarModel.sellMode?r.setMode(void 0):r.setMode(this.sellMode)}),r.registerKeyCommand(y.KeyCommandType.ToggleRepair,()=>{this.sidebarModel.repairMode?r.setMode(void 0):r.setMode(this.repairMode)});let t=new w.LastRadarEventCmd(this.player,s,this.worldScene.cameraPan);r.registerKeyCommand(y.KeyCommandType.CenterOnRadarEvent,t),this.disposables.add(this.game.events.subscribe(e=>t.handleGameEvent(e)));let e=()=>{this.runtimeVars.cheatsEnabled.value?r.registerKeyCommand(y.KeyCommandType.BuildCheat,()=>this.speedCheat.value=!this.speedCheat.value).registerKeyCommand(y.KeyCommandType.FreeMoney,()=>this.player.credits+=1e4).registerKeyCommand(y.KeyCommandType.ToggleShroud,()=>this.game.mapShroudTrait.revealMap(this.player,this.game)):(r.unregisterKeyCommand(y.KeyCommandType.BuildCheat).unregisterKeyCommand(y.KeyCommandType.FreeMoney).unregisterKeyCommand(y.KeyCommandType.ToggleShroud),this.speedCheat.value=!1)};e(),this.runtimeVars.cheatsEnabled.onChange.subscribe(e),this.disposables.add(()=>this.runtimeVars.cheatsEnabled.onChange.unsubscribe(e)),r.registerKeyCommand(y.KeyCommandType.ToggleFps,()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value),r.registerKeyCommand(y.KeyCommandType.ToggleAlliance,()=>{var e=this.game.rules.mpDialogSettings;if(e.alliesAllowed&&e.allyChangeAllowed){let t=i.getSelectedUnits()[0]?.owner;t&&t!==this.player&&this.game.alliances.canRequestAlliance(t)&&this.pushAction(g.ActionType.ToggleAlliance,e=>{e.toPlayer=t,e.toggle=!this.game.alliances.areAllied(this.player,t)})}});let a=!1;r.registerKeyCommand(y.KeyCommandType.PlanningMode,{triggerMode:A.TriggerMode.KeyDownUp,execute:e=>{var t;e?(t=this.planningMode.exit(),this.sound.play(p.SoundKey.EndPlanningModeSound,m.ChannelType.Ui),this.queueOrders(t),a||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),a=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(r.unitSelectionHandler.getSelectedUnits()),this.sound.play(p.SoundKey.StartPlanningModeSound,m.ChannelType.Ui),a||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Key")))}}),r.registerKeyCommand(y.KeyCommandType.ScatterObject,()=>{this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoScatter")):this.pushOrder(f.OrderType.Scatter,void 0)});let n=new I.SelectNextUnitCmd(i,s,this.worldScene.cameraPan,this.player,this.game.getWorld());r.registerKeyCommand(y.KeyCommandType.NextObject,()=>{n.setReverse(!1),n.execute()}),r.registerKeyCommand(y.KeyCommandType.PreviousObject,()=>{n.setReverse(!0),n.execute()}),this.disposables.add(n);var o=this.game.map.startingLocations[this.player.startLocation],o=this.game.map.tiles.getByMapCoords(o.x,o.y);let l=s.computeCameraPanFromTile(o.rx,o.ry),c=new Map;[y.KeyCommandType.SetView1,y.KeyCommandType.SetView2,y.KeyCommandType.SetView3,y.KeyCommandType.SetView4].forEach((e,t)=>{r.registerKeyCommand(e,new k.SetCameraLocationCmd(this.worldScene.cameraPan,c,t-1))}),[y.KeyCommandType.View1,y.KeyCommandType.View2,y.KeyCommandType.View3,y.KeyCommandType.View4].forEach((e,t)=>{r.registerKeyCommand(e,new B.GoToCameraLocationCmd(this.worldScene.cameraPan,c,t-1,l))}),[y.KeyCommandType.Taunt_1,y.KeyCommandType.Taunt_2,y.KeyCommandType.Taunt_3,y.KeyCommandType.Taunt_4,y.KeyCommandType.Taunt_5,y.KeyCommandType.Taunt_6,y.KeyCommandType.Taunt_7,y.KeyCommandType.Taunt_8].forEach((e,t)=>{r.registerKeyCommand(e,()=>this.tauntHandler?.sendTaunt(t+1))}),r.registerKeyCommand(y.KeyCommandType.PlaceBeacon,()=>{r.getMode()!==this.beaconMode&&r.setMode(this.beaconMode)});o=new N.CenterViewCmd(i,s,this.worldScene.cameraPan);r.registerKeyCommand(y.KeyCommandType.CenterView,o);let h=new L.FollowUnitCmd(i,this.renderableManager,r,s,this.worldScene.cameraPan,this.worldScene);h.init(),this.disposables.add(h),r.registerKeyCommand(y.KeyCommandType.Follow,h);let u=()=>this.sound.play(p.SoundKey.SystemError,m.ChannelType.Ui),d=[y.KeyCommandType.PageUser,y.KeyCommandType.ScreenCapture];d.forEach(e=>r.registerKeyCommand(e,u))}handleDeploy(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy")):this.pushOrder(f.OrderType.DeploySelected,void 0)}handleStop(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoStop")):this.pushOrder(f.OrderType.Stop,void 0)}handleGuard(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoGuardArea")):this.pushOrder(f.OrderType.Guard,void 0)}handleBeacon(t){this.isSinglePlayer||this.beaconFxHandler.canPingLocation(this.player,t)&&this.pushAction(g.ActionType.PingLocation,e=>{e.tile={x:t.rx,y:t.ry}})}handleCommandBarTeam(t,i){let r=i.getGroupUnits(t);if(r.length)if(i.getSelectedUnits().some(e=>r.includes(e))){let e=new b.CenterGroupCmd(t,i,new T.MapPanningHelper(this.game.map),this.worldScene.cameraPan);e.execute()}else i.selectGroup(t);else i.createGroup(t)}handleInvalidCommand(e){this.sound.play(p.SoundKey.ScoldSound,m.ChannelType.Ui),this.messageList.addUiFeedbackMessage(e)}})}}}),System.register("gui/screen/game/ObserverUi",["react","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/mainMenu/main/ReportBug"],function(e,t){"use strict";var i,u,l,c,h,d,g,p,m,f,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){u=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){r=e},function(e){s=e}],execute:function(){e("ObserverUi",a=class{constructor(e,t,i,r,s,a,n,o,l,c,h){this.game=e,this.worldInteractionFactory=t,this.cameraPan=i,this.renderableManager=r,this.worldScene=s,this.runtimeVars=a,this.gameMenu=n,this.sound=o,this.strings=l,this.messageBoxApi=c,this.discordUrl=h,this.disposables=new u.CompositeDisposable}init(e){let i=this.worldInteraction=this.worldInteractionFactory.create();i.init(),this.disposables.add(i),this.initHudEventListeners(e),i.registerKeyCommand(l.KeyCommandType.Options,()=>this.gameMenu.open()),i.registerKeyCommand(l.KeyCommandType.Scoreboard,()=>this.gameMenu.openDiplo()),i.registerKeyCommand(l.KeyCommandType.ToggleFps,()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value);let r=new Map;[l.KeyCommandType.SetView1,l.KeyCommandType.SetView2,l.KeyCommandType.SetView3,l.KeyCommandType.SetView4].forEach((e,t)=>{i.registerKeyCommand(e,new d.SetCameraLocationCmd(this.cameraPan,r,t-1))}),[l.KeyCommandType.View1,l.KeyCommandType.View2,l.KeyCommandType.View3,l.KeyCommandType.View4].forEach((e,t)=>{i.registerKeyCommand(e,new g.GoToCameraLocationCmd(this.cameraPan,r,t-1))});var t=new p.MapPanningHelper(this.game.map),s=new m.CenterViewCmd(i.unitSelectionHandler,t,this.cameraPan);i.registerKeyCommand(l.KeyCommandType.CenterView,s);let a=new f.FollowUnitCmd(i.unitSelectionHandler,this.renderableManager,i,t,this.cameraPan,this.worldScene);a.init(),this.disposables.add(a),i.registerKeyCommand(l.KeyCommandType.Follow,a);let n=()=>this.sound.play(c.SoundKey.SystemError,h.ChannelType.Ui),o=[l.KeyCommandType.PageUser,l.KeyCommandType.ScreenCapture];o.forEach(e=>i.registerKeyCommand(e,n))}handleHudChange(e){this.initHudEventListeners(e)}initHudEventListeners(e){e.onCommandBarButtonClick.subscribe(e=>{switch(e){case r.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(i.createElement(s.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"))}})}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/ChronoFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","game/gameobject/common/DeathType"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("ChronoFxHandler",n=class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new r.CompositeDisposable,this.handleObjectTeleport=r=>{if(r.isChronoshift){let i=r.target.position.getTileOffset().multiplyScalar(1/s.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,e=>{e.setPosition(s.Coords.tile3dToWorld(r.prevTile.rx+i.x,r.prevTile.ry+i.y,r.prevTile.z))}),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,e=>{var t=r.target.tile;e.setPosition(s.Coords.tile3dToWorld(t.rx+i.x,t.ry+i.y,t.z))})}},this.handleObjectDestroy=e=>{if(e.target.deathType===a.DeathType.Temporal){let t=e.target.isBuilding()?e.target.centerTile:e.target.tile,i=e.target.isBuilding()?new THREE.Vector2(.5,.5):e.target.position.getTileOffset().multiplyScalar(1/s.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpAway,e=>{e.setPosition(s.Coords.tile3dToWorld(t.rx+i.x,t.ry+i.y,t.z))})}}}init(){this.disposables.add(this.game.events.subscribe(i.EventType.ObjectTeleport,this.handleObjectTeleport),this.game.events.subscribe(i.EventType.ObjectDestroy,this.handleObjectDestroy))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/WarheadDetonateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","util/math"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("WarheadDetonateFxHandler",n=class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new r.CompositeDisposable,this.handleWarheadDetonation=r=>{var e=r.explodeAnim;e&&this.renderableManager.createTransientAnim(e,e=>{let t=r.position.clone();var i;r.target.rules.bullets&&(i=s.Coords.getWorldTileSize()/8,t=new THREE.Vector3(a.getRandomInt(-i,i),0,a.getRandomInt(-i,i)).add(t)),e.setPosition(t)}),r.isLightningStrike&&(e=(e=this.game.rules.audioVisual.weatherConBolts)[a.getRandomInt(0,e.length-1)],this.renderableManager.createTransientAnim(e,e=>{e.setPosition(r.position)}))}}init(){this.disposables.add(this.game.events.subscribe(i.EventType.WarheadDetonate,this.handleWarheadDetonation))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/CrateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("CrateFxHandler",a=class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new r.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(i.EventType.CratePickup,t=>{var e=t.target.animName;e&&this.renderableManager.createTransientAnim(e,e=>{e.setPosition(s.Coords.tile3dToWorld(t.tile.rx,t.tile.ry,t.tile.z+1)),e.setRenderOrder(1e6)})}))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/TriggerActionFxHandler",["util/disposable/CompositeDisposable","game/Coords","game/event/EventType"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("TriggerActionFxHandler",a=class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new i.CompositeDisposable,this.handleEvent=e=>{switch(e.type){case s.EventType.TriggerAnim:{let i=e;var t=i.name;this.renderableManager.createTransientAnim(t,e=>{var t=r.Coords.tile3dToWorld(i.tile.rx+.5,i.tile.ry+.5,i.tile.z);e.setPosition(t)});break}}}}init(){this.disposables.add(this.game.events.subscribe(this.handleEvent))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/WorldView",["util/disposable/CompositeDisposable","engine/renderable/WorldScene","engine/util/WorldViewportHelper","engine/util/MapTileIntersectHelper","engine/sound/WorldSound","engine/Engine","engine/util/MapPanningHelper","engine/IsoCoords","engine/ImageFinder","engine/renderable/entity/map/MapRenderable","engine/renderable/entity/RenderableFactory","engine/RenderableManager","engine/renderable/fx/handler/ChronoFxHandler","engine/Lighting","engine/gfx/lighting/LightingDirector","engine/renderable/fx/handler/WarheadDetonateFxHandler","engine/renderable/fx/handler/SuperWeaponFxHandler","engine/renderable/fx/handler/CrateFxHandler","engine/renderable/fx/handler/BeaconFxHandler","engine/renderable/builder/VxlBuilderFactory","engine/renderable/fx/handler/TriggerActionFxHandler"],function(e,t){"use strict";var h,o,v,b,S,w,l,c,C,E,x,O,A,M,R,P,I,k,B,j,N,i;t&&t.id;return{setters:[function(e){h=e},function(e){o=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){l=e},function(e){c=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e}],execute:function(){e("WorldView",i=class{constructor(e,t,i,r,s,a,n,o,l,c){this.hudGutterSize=e,this.game=t,this.sound=i,this.renderer=r,this.runtimeVars=s,this.minimap=a,this.strings=n,this.generalOptions=o,this.vxlGeometryPool=l,this.buildingImageDataCache=c,this.disposables=new h.CompositeDisposable}init(e,t,i){let r=this.game,s=r.map;var a=this.computeMapScreenBounds(s.mapBounds.getLocalSize()),n=this.computeWorldViewport(t,a);let o=this.initWorldView(e,n,r,s);this.worldScene=o;var l=new v.WorldViewportHelper(o),c=new b.MapTileIntersectHelper(s,o),a=r.getWorld(),n=e?this.game.mapShroudTrait.getPlayerShroud(e):void 0;let h=new S.WorldSound(this.sound,e,n,l,c,a,o,this.renderer);h.init(),this.disposables.add(h);let u=new M.Lighting(r.mapLightingTrait);this.disposables.add(u),o.applyLighting(u);let d=new R.LightingDirector(u,this.renderer,r.speed);d.init(),this.disposables.add(d);a=r.getUnitSelection();let{renderableManager:g,mapRenderable:p,superWeaponFxHandler:m,beaconFxHandler:f}=this.initRenderables(r,e,o,i,a,h,u,d),y=e=>{o.applyLighting(u),g.updateLighting(),p.updateLighting(e)};u.onChange.subscribe(y),this.disposables.add(()=>u.onChange.unsubscribe(y)),this.minimap.initWorld(o);let T=()=>{this.handleMapBoundsOrViewportChange(t),this.minimap.forceRerender()};return s.mapBounds.onLocalResize.subscribe(T),this.disposables.add(()=>s.mapBounds.onLocalResize.unsubscribe(T)),{worldScene:o,worldSound:h,renderableManager:g,superWeaponFxHandler:m,beaconFxHandler:f}}handleViewportChange(e){this.handleMapBoundsOrViewportChange(e)}handleMapBoundsOrViewportChange(e){var t;this.worldScene&&(t=this.computeMapScreenBounds(this.game.map.mapBounds.getLocalSize()),t=this.computeWorldViewport(e,t),this.worldScene.updateViewport(t),this.updatePanLimits(this.game.map,this.worldScene.cameraPan,t))}initWorldView(e,t,i,r){let s=o.WorldScene.factory(t,this.runtimeVars.freeCamera,this.generalOptions.graphics.shadows);this.disposables.add(s),this.updatePanLimits(r,s.cameraPan,t);var a=(!e||e.isObserver?i.getCombatants()[0]:e).startLocation,a=r.startingLocations[a];let n=new l.MapPanningHelper(r);s.cameraPan.setPan(n.computeCameraPanFromTile(a.x,a.y));a=r.mapBounds.getFullSize(),a=c.IsoCoords.screenTileToWorld(a.width/2,a.height/2);return s.setLightFocusPoint(a.x,a.y),s}initRenderables(e,t,i,r,s,a,n,o){var l=w.Engine.getImages(),c=w.Engine.getVoxels(),h=w.Engine.getVoxelAnims(),u=new C.ImageFinder(l,r),d=w.Engine.getPalettes(),g=t?e.mapShroudTrait.getPlayerShroud(t):void 0,l=new E.MapRenderable(e.map,g,e.mapRadiationTrait,n,r,e.rules,e.art,u,i.camera,this.runtimeVars.debugWireframes,e.speed,a,!0);i.add(l),this.disposables.add(l);g=this.renderer.supportsInstancing(),g=new x.RenderableFactory(t,s,e.alliances,e.rules,e.art,l,u,d,c,h,r,i.camera,n,o,this.runtimeVars.debugWireframes,this.runtimeVars.debugText,e.speed,a,this.strings,this.generalOptions.flyerHelper,this.generalOptions.hiddenObjects,new j.VxlBuilderFactory(this.vxlGeometryPool,g,i.camera),this.buildingImageDataCache,!0,g);let p=new O.RenderableManager(e.getWorld(),i,i.camera,g);p.init(),this.disposables.add(p);let m=new A.ChronoFxHandler(e,p);m.init(),this.disposables.add(m);let f=new P.WarheadDetonateFxHandler(e,p);f.init(),this.disposables.add(f);let y=new I.SuperWeaponFxHandler(e,p,o);y.init(),this.disposables.add(y);let T=new k.CrateFxHandler(e,p);T.init(),this.disposables.add(T);let v=new B.BeaconFxHandler(e,t,p,this.renderer,a);v.init(),this.disposables.add(v);let b=new N.TriggerActionFxHandler(e,p);return b.init(),this.disposables.add(b),{renderableManager:p,mapRenderable:l,superWeaponFxHandler:y,beaconFxHandler:v}}computeWorldViewport(e,t){return{x:e.x,y:e.y,width:Math.min(t.width,e.width-this.hudGutterSize.width),height:Math.min(t.height,e.height-this.hudGutterSize.height)}}updatePanLimits(e,t,i){let r=new l.MapPanningHelper(e);var s=this.computeMapScreenBounds(e.mapBounds.getLocalSize());t.setPanLimits(r.computeCameraPanLimits(i,s))}computeMapScreenBounds(e){var t=c.IsoCoords.screenTileToScreen(e.x,e.y),i=c.IsoCoords.screenTileToScreen(e.x+e.width,e.y+e.height-1);return{x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y}}dispose(){this.worldScene&&this.renderer.removeScene(this.worldScene),this.disposables.dispose()}})}}}),System.register("gui/screen/game/NetStats",["stats.js","util/disposable/CompositeDisposable","network/IrcConnection"],function(e,t){"use strict";var n,s,o,i;t&&t.id;return{setters:[function(e){n=e},function(e){s=e},function(e){o=e}],execute:function(){e("NetStats",i=class{constructor(e,t,i,r){this.lockstep=e,this.player=t,this.renderer=i,this.gservCon=r,this.disposables=new s.CompositeDisposable}init(){let e=this.renderer.getStats(),i=new n.default.Panel("ms RTT","#ff8","#221"),r=250,s,a=async()=>{if(s=void 0,!this.lockstep.getErrorState()&&this.gservCon.isOpen()){let t;try{t=await this.gservCon.ping(5)}catch(e){e instanceof o.IrcConnection.NoReplyError||console.error(e),t=5e3}s=setTimeout(a,1e3),requestAnimationFrame(()=>i.update(t,r))}};if(a(),this.disposables.add(()=>{s&&clearTimeout(s);let e=this.renderer.getStats();e&&e.dom.removeChild(i.dom)}),e.addPanel(i),!this.player.isObserver){let i=new n.default.Panel("ms LAT","#f8f","#212"),r=new Map;this.lockstep.onActionsSent.subscribe(e=>{r.set(e,performance.now())}),this.lockstep.onActionsReceived.subscribe(t=>{if(r.has(t)){let e=performance.now()-r.get(t);r.delete(t),requestAnimationFrame(()=>i.update(e,1e3))}}),e.addPanel(i),this.disposables.add(()=>{let e=this.renderer.getStats();e&&e.dom.removeChild(i.dom)})}}dispose(){this.disposables.dispose()}})}}}),System.register("game/player/PlayerFactory",["game/Player","game/Country","game/player/trait/PowerTrait","game/player/trait/RadarTrait","game/player/production/Production","game/SideType","game/player/trait/SuperWeaponsTrait","game/player/trait/SharedDetectDisguiseTrait"],function(e,t){"use strict";var o,s,l,c,h,a,u,d,i;t&&t.id;return{setters:[function(e){o=e},function(e){s=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){a=e},function(e){u=e},function(e){d=e}],execute:function(){e("PlayerFactory",i=class{constructor(e,t,i){this.rules=e,this.gameOpts=t,this.allAvailableObjects=i}createCombatant(e,t,i,r,s,a){let n=new o.Player(e,t,i,r);return n.isAi=s,n.aiDifficulty=a,n.powerTrait=new l.PowerTrait(n),n.traits.add(n.powerTrait),n.radarTrait=new c.RadarTrait,n.traits.add(n.radarTrait),n.superWeaponsTrait=new u.SuperWeaponsTrait,n.traits.add(n.superWeaponsTrait),n.production=h.Production.factory(n,this.rules,this.gameOpts,this.allAvailableObjects),n.sharedDetectDisguiseTrait=new d.SharedDetectDisguiseTrait,n}createObserver(e,t){let i=new o.Player(e,void 0,void 0,t.colors.get("LightGrey"));return i.radarTrait=new c.RadarTrait,i.traits.add(i.radarTrait),i.radarTrait.setDisabled(!1),i}createNeutral(e,t){var i=[...e.countryRules.values()].find(e=>e.side===a.SideType.Civilian);if(!i)throw new Error("Missing neutral country. No country found in rules with Civilian side");i=new s.Country(i);let r=new o.Player(t,i,void 0,e.colors.get("LightGrey"));return r.powerTrait=new l.PowerTrait(r),r.traits.add(r.powerTrait),r}})}}}),System.register("game/trait/PowerTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyHealthChange","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifyTick"],function(e,t){"use strict";var i,r,s,a,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){l=class{[i.NotifySpawn.onSpawn](e,t){e.isTechno()&&e.rules.power&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,"add",t)}[s.NotifyUnspawn.onUnspawn](e,t){e.isTechno()&&e.rules.power&&!e.warpedOutTrait.isActive()&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,"remove",t)}[r.NotifyHealthChange.onChange](e,t){e.isTechno()&&e.rules.power&&!e.warpedOutTrait.isActive()&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,"update",t)}[a.NotifyOwnerChange.onChange](e,t,i){e.rules.power&&!e.warpedOutTrait.isActive()&&(this.isCapturablePower(e,t)||t.powerTrait?.updateFrom(e,"remove",i),this.isCapturablePower(e,e.owner)||e.owner.powerTrait?.updateFrom(e,"add",i))}[n.NotifyWarpChange.onChange](e,t,i){e.rules.power&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,i?"remove":"add",t)}[o.NotifyTick.onTick](e){for(var t of e.getCombatants())t.powerTrait.updateBlackout(e)}isCapturablePower(e,t){return 0<e.rules.power&&t.isNeutral&&e.rules.needsEngineer}},e("PowerTrait",l)}}}),System.register("game/trait/ProductionTrait",["game/trait/interface/NotifyTick","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/player/production/ProductionQueue","game/event/InsufficientFundsEvent","game/rules/TechnoRules","game/trait/interface/NotifySpawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","util/math","game/GameSpeed","engine/type/ObjectType","game/math/GameMath"],function(e,t){"use strict";var i,r,s,h,u,a,n,o,l,d,c,g,p,m;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){h=e},function(e){u=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){d=e},function(e){c=e},function(e){g=e},function(e){p=e}],execute:function(){m=class{constructor(e,t){this.rules=e,this.speedCheat=t,this.availableObjectRules=new Set;var i=60*e.general.buildSpeed*c.GameSpeed.BASE_TICKS_PER_SECOND;this.baseBuildSpeed=1/(i/1e3),[...e.buildingRules.values(),...e.infantryRules.values(),...e.vehicleRules.values(),...e.aircraftRules.values()].forEach(e=>{e.owner.length&&this.availableObjectRules.add(e)})}[i.NotifyTick.onTick](e){for(var t of e.getCombatants())for(var i of t.production.getAllQueues())this.tickQueue(i,t,e)}[n.NotifySpawn.onSpawn](e,t){var i;e.isBuilding()&&e.owner.production?(i=e.rules.factory)&&(e.owner.production.getPrimaryFactory(i)||e.owner.production.setPrimaryFactory(e),e.owner.production.incrementFactoryCount(i),i===a.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(e.owner,t)):e.isAircraft()&&e.owner.production&&this.rules.general.padAircraft.includes(e.name)&&this.updateAircraftQueueMaxSize(e.owner,t)}[r.NotifyUnspawn.onUnspawn](e,t){var i;e.isBuilding()&&e.owner.production?(this.ensurePrerequisites(e.owner),(i=e.rules.factory)&&(e.owner.production.getPrimaryFactory(i)===e&&e.owner.production.crownPrimaryFactoryHeir(i),e.owner.production.decrementFactoryCount(i),i===a.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(e.owner,t))):e.isAircraft()&&e.owner.production&&this.rules.general.padAircraft.includes(e.name)&&this.updateAircraftQueueMaxSize(e.owner,t)}[s.NotifyOwnerChange.onChange](e,t,i){var r;e.isBuilding()?(this.ensurePrerequisites(t),(r=e.rules.factory)&&(t.production?.getPrimaryFactory(r)===e&&t.production.crownPrimaryFactoryHeir(r),e.owner.production&&!e.owner.production.getPrimaryFactory(r)&&e.owner.production.setPrimaryFactory(e),t.production?.decrementFactoryCount(r),e.owner.production?.incrementFactoryCount(r),r===a.FactoryType.AircraftType&&(this.updateAircraftQueueMaxSize(e.owner,i),this.updateAircraftQueueMaxSize(t,i)))):e.isAircraft()&&this.rules.general.padAircraft.includes(e.name)&&(this.updateAircraftQueueMaxSize(e.owner,i),this.updateAircraftQueueMaxSize(t,i))}[o.NotifyPower.onPowerLow](e){e.production&&(e.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(e.powerTrait.power,e.powerTrait.drain))}[o.NotifyPower.onPowerRestore](e){e.production&&(e.production.buildSpeedModifier=1)}[o.NotifyPower.onPowerChange](e){e.powerTrait?.level===l.PowerLevel.Low&&e.production&&(e.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(e.powerTrait.power,e.powerTrait.drain))}computeLowPowerBuildSpeedModifier(e,t){var i=1-Math.min(1,e/t),r=this.rules.general,i=.3*r.lowPowerPenaltyModifier*i/.15;return d.clamp(1-i,r.minLowPowerProductionSpeed,r.maxLowPowerProductionSpeed)}updateAircraftQueueMaxSize(i,r){i.production&&r.afterTick(()=>{var e=[...i.buildings].filter(e=>e.helipadTrait).reduce((e,t)=>e+t.dockTrait.numberOfDocks,0),t=i.getOwnedObjectsByType(g.ObjectType.Aircraft,!0).filter(e=>r.rules.general.padAircraft.includes(e.name)).length;i.production.getQueueForFactory(a.FactoryType.AircraftType).maxSize=Math.max(0,e-t)})}tickQueue(i,r,s){if(i.status===h.QueueStatus.Active){let e=!1,t=i.getFirst();var a,n=r.production.getFactoryTypeForQueueType(i.type),o=r.production.getFactoryCount(n),l=r.production.buildSpeedModifier,c=1/p.GameMath.pow(this.rules.general.multipleFactory,o-1),n=t.rules.wall?1/this.rules.general.wallBuildSpeedCoefficient:1,o=this.baseBuildSpeed*l*c*n,l=t.creditsEach,c=l&&!this.speedCheat.value?d.floorTo(l/o,54):54,c=Math.max(54,c),n=r.credits,o=t.creditsEach-t.creditsSpent,o=Math.min(r.credits,l/c+t.creditsSpentLeftover,o);0<o?(a=Math.floor(o),t.creditsSpentLeftover=o-a,a&&(t.creditsSpent+=a,t.progress=t.creditsSpent/t.creditsEach,r.credits-=a,e=!0)):t.creditsEach||(a=t.progress*c,t.progress=Math.min(1,(1+a)/c),e=!0),e&&1===t.progress&&(i.status=h.QueueStatus.Ready),0<n&&!r.credits&&s.events.dispatch(new u.InsufficientFundsEvent(r)),e&&i.notifyUpdated()}}ensurePrerequisites(e){if(e.production)for(var t of e.production.getAllQueues()){var i;for(i of t.getAll().map(e=>({rules:e.rules,quantity:e.quantity,creditsSpent:e.creditsSpent})))e.production.isAvailableForProduction(i.rules)||(t.pop(i.rules,i.quantity),e.credits+=i.creditsSpent)}}getAvailableObjects(){return[...this.availableObjectRules]}},e("ProductionTrait",m)}}}),System.register("game/action/factories/NoActionFactory",["game/action/NoAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("NoActionFactory",r=class{create(){return new i.NoAction}})}}}),System.register("game/action/factories/PlaceBuildingActionFactory",["game/action/PlaceBuildingAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PlaceBuildingActionFactory",r=class{constructor(e){this.game=e}create(){return new i.PlaceBuildingAction(this.game)}})}}}),System.register("game/action/factories/SellBuildingActionFactory",["game/action/SellBuildingAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SellBuildingActionFactory",r=class{constructor(e){this.game=e}create(){return new i.SellBuildingAction(this.game)}})}}}),System.register("game/action/factories/SelectUnitsActionFactory",["game/action/SelectUnitsAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("SelectUnitsActionFactory",r=class{constructor(e,t){this.game=e,this.orderActionContext=t}create(){return new i.SelectUnitsAction(this.game,this.orderActionContext)}})}}}),System.register("game/action/factories/OrderUnitsActionFactory",["game/action/OrderUnitsAction","game/order/OrderFactory"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("OrderUnitsActionFactory",s=class{constructor(e,t,i){this.game=e,this.map=t,this.orderActionContext=i}create(){return new i.OrderUnitsAction(this.game,this.map,this.orderActionContext,new r.OrderFactory(this.game,this.map))}})}}}),System.register("game/action/factories/UpdateQueueActionFactory",["game/action/UpdateQueueAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("UpdateQueueActionFactory",r=class{constructor(e){this.game=e}create(){return new i.UpdateQueueAction(this.game)}})}}}),System.register("game/action/DropPlayerAction",["game/action/Action","game/action/ActionType","game/event/PlayerDisconnectedEvent"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){a=class extends i.Action{constructor(e,t){super(r.ActionType.DropPlayer),this.game=e,this.localPlayerName=t}process(){if(this.localPlayerName!==this.player.name){let e=this.player;e.defeated||(this.game.removeAllPlayerAssets(e),e.dropped=!0,this.game.events.dispatch(new s.PlayerDroppedEvent(e)))}}},e("DropPlayerAction",a)}}}),System.register("game/action/factories/DropPlayerActionFactory",["game/action/DropPlayerAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("DropPlayerActionFactory",r=class{constructor(e,t){this.game=e,this.localPlayerName=t}create(){return new i.DropPlayerAction(this.game,this.localPlayerName)}})}}}),System.register("game/action/factories/ToggleRepairActionFactory",["game/action/ToggleRepairAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ToggleRepairActionFactory",r=class{constructor(e){this.game=e}create(){return new i.ToggleRepairAction(this.game)}})}}}),System.register("game/action/factories/ToggleAllianceFactory",["game/action/ToggleAllianceAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ToggleAllianceActionFactory",r=class{constructor(e){this.game=e}create(){return new i.ToggleAllianceAction(this.game)}})}}}),System.register("game/action/factories/ActivateSuperWeaponActionFactory",["game/action/ActivateSuperWeaponAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ActivateSuperWeaponActionFactory",r=class{constructor(e){this.game=e}create(){return new i.ActivateSuperWeaponAction(this.game)}})}}}),System.register("game/action/factories/PingLocationActionFactory",["game/action/PingLocationAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PingLocationActionFactory",r=class{constructor(e){this.game=e}create(){return new i.PingLocationAction(this.game)}})}}}),System.register("game/action/ObserveGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType","game/event/PlayerDefeatedEvent","game/event/RadarOnOffEvent"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends i.Action{constructor(e){super(s.ActionType.ObserveGame),this.game=e}process(){let e=this.player;var t;this.game.removeAllPlayerAssets(e),!e.isCombatant()||e.defeated||e.isObserver||(e.resigned=!0,e.defeated=!0,e.isObserver=!0,this.game.events.dispatch(new r.PlayerResignedEvent(e)),this.game.events.dispatch(new a.PlayerDefeatedEvent(e)),this.game.mapShroudTrait.getPlayerShroud(e)?.revealAll(),t=e.radarTrait.isDisabled(),e.radarTrait.setDisabled(!1),t&&this.game.events.dispatch(new n.RadarOnOffEvent(e,!0)))}},e("ObserveGameAction",o)}}}),System.register("game/action/factories/ObserveGameActionFactory",["game/action/ObserveGameAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ObserveGameActionFactory",r=class{constructor(e){this.game=e}create(){return new i.ObserveGameAction(this.game)}})}}}),System.register("game/action/factories/ResignGameActionFactory",["game/action/ResignGameAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("ResignGameActionFactory",r=class{constructor(e,t){this.game=e,this.localPlayerName=t}create(){return new i.ResignGameAction(this.game,this.localPlayerName)}})}}}),System.register("game/action/factories/DebugActionFactory",["game/action/DebugAction"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("DebugActionFactory",r=class{constructor(e){this.game=e}create(){return new i.DebugAction(this.game)}})}}}),System.register("game/action/ActionFactoryReg",["game/action/OrderActionContext","game/action/ActionType","game/action/factories/NoActionFactory","game/action/factories/PlaceBuildingActionFactory","game/action/factories/SellBuildingActionFactory","game/action/factories/SelectUnitsActionFactory","game/action/factories/OrderUnitsActionFactory","game/action/factories/UpdateQueueActionFactory","game/action/factories/DropPlayerActionFactory","game/action/factories/ToggleRepairActionFactory","game/action/factories/ToggleAllianceFactory","game/action/factories/ActivateSuperWeaponActionFactory","game/action/factories/PingLocationActionFactory","game/action/factories/ObserveGameActionFactory","game/action/factories/ResignGameActionFactory","game/action/factories/DebugActionFactory"],function(e,t){"use strict";var s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,i;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){e("ActionFactoryReg",i=class{register(e,t,i){var r=new s.OrderActionContext;e.registerFactory(a.ActionType.NoAction,new n.NoActionFactory),e.registerFactory(a.ActionType.PlaceBuilding,new o.PlaceBuildingActionFactory(t)),e.registerFactory(a.ActionType.SellBuilding,new l.SellBuildingActionFactory(t)),e.registerFactory(a.ActionType.ToggleRepair,new g.ToggleRepairActionFactory(t)),e.registerFactory(a.ActionType.SelectUnits,new c.SelectUnitsActionFactory(t,r)),e.registerFactory(a.ActionType.OrderUnits,new h.OrderUnitsActionFactory(t,t.map,r)),e.registerFactory(a.ActionType.UpdateQueue,new u.UpdateQueueActionFactory(t)),e.registerFactory(a.ActionType.ToggleAlliance,new p.ToggleAllianceActionFactory(t)),e.registerFactory(a.ActionType.ActivateSuperWeapon,new m.ActivateSuperWeaponActionFactory(t)),e.registerFactory(a.ActionType.PingLocation,new f.PingLocationActionFactory(t)),e.registerFactory(a.ActionType.DropPlayer,new d.DropPlayerActionFactory(t,i)),e.registerFactory(a.ActionType.ObserveGame,new y.ObserveGameActionFactory(t)),e.registerFactory(a.ActionType.ResignGame,new T.ResignGameActionFactory(t,i)),e.registerFactory(a.ActionType.DebugCommand,new v.DebugActionFactory(t))}})}}}),System.register("game/trait/SharedDetectDisguiseTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/math/Vector2","game/math/Box2"],function(e,t){"use strict";var i,r,s,a,c,n,o,l,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){c=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){h=class{constructor(){this.detectors=new Set}[r.NotifySpawn.onSpawn](e,t){this.isGlobalDetector(e)&&(this.detectors.add(e),this.updateAroundDetector(e,t)),this.isDisguisable(e)&&this.detect(e,t)}[a.NotifyUnspawn.onUnspawn](e,t){e.isTechno()&&(this.isGlobalDetector(e)&&(this.detectors.delete(e),this.updateAroundDetector(e,t)),this.isDisguisable(e)&&this.undetect(e,t))}[i.NotifyOwnerChange.onChange](e,t,i){this.isGlobalDetector(e)&&this.updateAroundDetector(e,i),this.isDisguisable(e)&&(this.undetect(e,i),this.detect(e,i))}[s.NotifyTileChange.onTileChange](e,t,i){this.isGlobalDetector(e)&&(this.updateAroundDetector(e,t,i),this.updateAroundDetector(e,t)),this.isDisguisable(e)&&(this.undetect(e,t),this.detect(e,t))}[n.NotifyPower.onPowerLow](t,e){var i=[...this.detectors].filter(e=>e.owner===t&&e.isBuilding()&&e.poweredTrait&&!e.poweredTrait.isPoweredOn());this.updateAroundDetectors(i,e)}[n.NotifyPower.onPowerRestore](t,e){var i=[...this.detectors].filter(e=>e.owner===t&&e.isBuilding()&&e.poweredTrait);this.updateAroundDetectors(i,e)}[n.NotifyPower.onPowerChange](e,t){}updateAroundDetectors(e,t){let i=new Set;for(var r of e)for(var s of this.findTechnosAroundDetector(r,t,r.tile))i.add(s);for(var a of i)this.isDisguisable(a)&&(this.undetect(a,t),this.detect(a,t))}updateAroundDetector(e,t,i=e.tile){var r;for(r of this.findTechnosAroundDetector(e,t,i))this.isDisguisable(r)&&(this.undetect(r,t),this.detect(r,t))}findTechnosAroundDetector(e,t,i){var r=e.getFoundation(),s=Math.max(r.width,r.height),r=e.rules.detectDisguiseRange+s,s=new o.Vector2(i.rx,i.ry).addScalar(-r),r=new o.Vector2(i.rx,i.ry).addScalar(r);return t.map.technosByTile.queryRange(new l.Box2(s,r))}detect(e,t){let i=new Set,r=new c.RangeHelper(t.map.tileOccupation);for(var s of this.detectors)if(!t.areFriendly(s,e)){var a=s.owner,n=s.rules.detectDisguiseRange;if(!i.has(a))if(!(s.isBuilding()&&s.poweredTrait&&!s.poweredTrait.isPoweredOn())&&r.tileDistance(e,s.tile)<=n)for(var o of[a,...t.alliances.getAllies(a)])i.add(o)}for(var l of i)l.sharedDetectDisguiseTrait?.add(e)}undetect(e,t){for(var i of t.getCombatants())i.sharedDetectDisguiseTrait?.delete(e)}isGlobalDetector(e){return!(!e.isTechno()||!e.rules.detectDisguiseRange)}isDisguisable(e){return!(!e.isInfantry()&&!e.isVehicle()||!e.disguiseTrait)}},e("SharedDetectDisguiseTrait",h)}}}),System.register("game/trait/SharedDetectCloakTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/trait/RadarTrait","game/rules/general/RadarRules","game/trait/interface/NotifyObjectTraitAdd","game/gameobject/trait/CloakableTrait","game/gameobject/trait/SensorsTrait","game/math/Vector2","game/math/Box2"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h,u,d,g,p,m,f;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class{constructor(){this.detectors=new Set}[r.NotifySpawn.onSpawn](e,t){this.isGlobalDetector(e)&&(this.detectors.add(e),this.updateAroundDetector(e,t)),this.isCloakable(e)&&this.detect(e,t)}[a.NotifyUnspawn.onUnspawn](e,t){e.isTechno()&&this.isGlobalDetector(e)&&this.detectors.delete(e)}[i.NotifyOwnerChange.onChange](e,t,i){this.isGlobalDetector(e)&&this.updateAroundDetector(e,i),this.isCloakable(e)&&this.detect(e,i)}[s.NotifyTileChange.onTileChange](e,t,i){this.isGlobalDetector(e)&&this.updateAroundDetector(e,t),this.isCloakable(e)&&this.detect(e,t)}[u.NotifyObjectTraitAdd.onAdd](e,t,i){e.isTechno()&&(t instanceof d.CloakableTrait?this.isCloakable(e)&&this.detect(e,i):t instanceof g.SensorsTrait&&this.isGlobalDetector(e)&&this.updateAroundDetector(e,i))}[o.NotifyPower.onPowerLow](e,t){}[o.NotifyPower.onPowerRestore](t,e){var i=[...this.detectors].filter(e=>e.owner===t&&e.isBuilding()&&e.poweredTrait);this.updateAroundDetectors(i,e)}[o.NotifyPower.onPowerChange](e,t){}[l.NotifyTick.onTick](e){for(var t of e.getCombatants()){var i;for(i of t.getOwnedObjects())i.cloakableTrait&&!i.cloakableTrait.isCloaked()&&this.detect(i,e)}}updateAroundDetectors(e,t){let i=new Set;for(var r of e)for(var s of this.findTechnosAroundDetector(r,t))i.add(s);for(var a of i)this.isCloakable(a)&&this.detect(a,t)}updateAroundDetector(e,t){var i;for(i of this.findTechnosAroundDetector(e,t))this.isCloakable(i)&&this.detect(i,t)}findTechnosAroundDetector(e,t){var i=e.getFoundation(),r=Math.max(i.width,i.height),i=e.rules.sensorsSight+r,r=new p.Vector2(e.tile.rx,e.tile.ry).addScalar(-i),i=new p.Vector2(e.tile.rx,e.tile.ry).addScalar(i);return t.map.technosByTile.queryRange(new m.Box2(r,i))}detect(e,t){let i=new n.RangeHelper(t.map.tileOccupation);for(var r of this.detectors)if(!t.areFriendly(r,e)){var s=r.rules.sensorsSight;if(!(r.isBuilding()&&r.poweredTrait&&!r.poweredTrait.isPoweredOn())&&i.tileDistance(e,r.tile)<=s){s=e.cloakableTrait?.isCloaked();if(e.cloakableTrait.uncloak(t),s)for(var a of[r.owner,...t.alliances.getAllies(r.owner)])t.traits.get(c.RadarTrait).addEventForPlayer(h.RadarEventType.GenericNonCombat,a,e.tile,t);break}}}isGlobalDetector(e){return!(!e.isTechno()||!e.sensorsTrait&&!e.rules.sensorArray||!e.rules.sensorsSight)}isCloakable(e){return e.isTechno()&&!!e.cloakableTrait}},e("SharedDetectCloakTrait",f)}}}),System.register("game/gameopts/GameOptRandomGen",["game/math/Vector2","game/Prng","game/rules/mpAllowedColors","util/typeGuard","game/gameopts/constants"],function(e,t){"use strict";var l,i,n,d,g,r;t&&t.id;return{setters:[function(e){l=e},function(e){i=e},function(e){n=e},function(e){d=e},function(e){g=e}],execute:function(){e("GameOptRandomGen",r=class{constructor(e){this.prng=e}static factory(e,t){return new this(new i.Prng(Number(e+""+t)))}generateColors(e){let t=[...e.humanPlayers,...e.aiPlayers].filter(d.isNotNullOrUndefined),i=t.map(e=>e.colorId).filter(e=>e!==g.RANDOM_COLOR_ID);var r=n.mpAllowedColors.length;let s=new Array(r).fill(0).map((e,t)=>t).filter(e=>!i.includes(e)),a=new Map;return t.forEach(e=>{if(e.countryId!==g.OBS_COUNTRY_ID&&e.colorId===g.RANDOM_COLOR_ID){if(s.length<1)throw new Error("Out of available colors to choose from");var t=this.prng.generateRandomInt(0,s.length-1);a.set(e,s[t]),s.splice(t,1)}}),a}generateCountries(e,t){let i=t.getMultiplayerCountries().length,r=[...e.humanPlayers,...e.aiPlayers].filter(d.isNotNullOrUndefined),s=new Map;return r.forEach(e=>{e.countryId===g.RANDOM_COUNTRY_ID&&s.set(e,this.prng.generateRandomInt(0,i-1))}),s}generateStartLocations(e,i){let t=[...e.humanPlayers,...e.aiPlayers].filter(d.isNotNullOrUndefined),r=t.filter(e=>e.startPos!==g.RANDOM_START_POS).map(e=>e.startPos),s=[...i.keys()].filter(e=>!r.includes(e)),a=[];for(;s.length;){var n=s.length?this.prng.generateRandomInt(0,s.length-1):0;a.push(...s.splice(n,1))}if(a.unshift(...r),3<=a.length)for(var o of[1,2])if(!(r.length-1>=o)){let e=a.map(e=>i[e]),t=this.findFarthestPointFrom(e.slice(0,o),e.slice(o));var l=e.findIndex(e=>e.x===t.x&&e.y===t.y);a.splice(o,0,...a.splice(l,1))}if(4<=a.length)if(r.length-1<3){let e=a.map(e=>i[e]),t=this.findFarthestPointFrom(e.slice(2,3),e.slice(3));var c=e.findIndex(e=>e.x===t.x&&e.y===t.y);a.splice(3,0,...a.splice(c,1))}a.splice(0,r.length);let h=new Map,u=-1;return t.forEach(e=>{if(e.countryId!==g.OBS_COUNTRY_ID&&e.startPos===g.RANDOM_START_POS){if(u>=a.length-1)throw new RangeError("Map has fewer starting locations than players");h.set(e,a[++u])}}),h}findFarthestPointFrom(e,t){let r=e.map(e=>new l.Vector2(e.x,e.y)),s,a=0;if(!t.length)throw new Error("Search array must have at least one element");for(var n of t){let i=new l.Vector2(n.x,n.y);var o=r.reduce((e,t)=>e+i.distanceTo(t),0);o>=a&&(s=n,a=o)}return s}})}}}),System.register("game/GameFactory",["game/rules/Rules","game/art/Art","game/Country","game/gameobject/ObjectFactory","game/World","game/GameMap","game/gameopts/GameOpts","game/gameopts/constants","util/typeGuard","game/Alliances","game/PlayerList","game/gameobject/selection/UnitSelection","util/BoxedVar","game/player/PlayerFactory","game/trait/PowerTrait","game/trait/SellTrait","game/trait/RadarTrait","game/trait/ProductionTrait","game/trait/MapShroudTrait","game/Game","game/trait/MapRadiationTrait","game/action/ActionFactory","game/action/ActionFactoryReg","game/trait/SuperWeaponsTrait","game/trait/SharedDetectDisguiseTrait","game/trait/SharedDetectCloakTrait","game/trait/CrateGeneratorTrait","game/trait/StalemateDetectTrait","game/gameopts/GameOptSanitizer","game/gameopts/GameOptRandomGen","game/trait/MapLightingTrait","game/Prng","game/ai/Ai","game/bot/BotFactory","game/BotManager"],function(e,t){"use strict";var H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee,te,ie,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,i;t&&t.id;return{setters:[function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e},function(e){ee=e},function(e){te=e},function(e){ie=e},function(e){re=e},function(e){se=e},function(e){ae=e},function(e){ne=e},function(e){oe=e},function(e){le=e},function(e){ce=e},function(e){he=e},function(e){ue=e},function(e){de=e},function(e){ge=e},function(e){pe=e},function(e){me=e},function(e){fe=e},function(e){ye=e},function(e){Te=e},function(e){ve=e},function(e){be=e},function(e){Se=e}],execute:function(){e("GameFactory",i=class{static create(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m){var f=i.clone().mergeWith(a).mergeWith(e);let y=new H.Rules(f,d);var T=new G.Art(y,r,e,d),v=new ve.Ai(s);y.applySpecialFlags(e.specialFlags),me.GameOptSanitizer.sanitize(l,y);let b=new H.Rules(i),S=b.getMultiplayerCountries(),w=[...b.getMultiplayerColors().values()],C=new Te.Prng(Number(n+""+o)),E=new K.GameMap(e,t,y,C.generateRandomInt.bind(C));var x=new z.World,O=c.getById(l.gameMode).type,A=new Y.PlayerList,M=new Z.Alliances(A),R=new X.UnitSelection,P=new J.BoxedVar(1),I=new W.ObjectFactory(E.tiles,E.tileOccupation,E.bridges,P),k=new le.ActionFactory,f=new be.BotFactory(u),f=Se.BotManager.factory(k,f,p,m);let B=new ne.Game(x,E,y,T,v,n,o,l,O,A,R,M,P,I,f);(new ce.ActionFactoryReg).register(k,B,void 0),B.traits.add(new te.PowerTrait),B.sellTrait=new ie.SellTrait(B,y.general),B.traits.add(B.sellTrait),B.traits.add(new re.RadarTrait);let j=new se.ProductionTrait(y,g);B.traits.add(j),B.mapShroudTrait=new ae.MapShroudTrait(E,M),B.traits.add(B.mapShroudTrait),B.mapRadiationTrait=new oe.MapRadiationTrait(E),B.traits.add(B.mapRadiationTrait),B.mapLightingTrait=new ye.MapLightingTrait(y.audioVisual,E.getLighting()),B.traits.add(B.mapLightingTrait),B.traits.add(new he.SuperWeaponsTrait),B.traits.add(new ue.SharedDetectDisguiseTrait),B.traits.add(new de.SharedDetectCloakTrait),B.crateGeneratorTrait=new ge.CrateGeneratorTrait(l.cratesAppear),B.traits.add(B.crateGeneratorTrait),h||(B.stalemateDetectTrait=new pe.StalemateDetectTrait,B.traits.add(B.stalemateDetectTrait));let N=new ee.PlayerFactory(y,l,j.getAvailableObjects()),L=fe.GameOptRandomGen.factory(n,o),D=L.generateColors(l),F=L.generateCountries(l,b),_=L.generateStartLocations(l,E.startingLocations),U=[...l.humanPlayers,...l.aiPlayers].filter(Q.isNotNullOrUndefined);return U.forEach(e=>{let t,i,r;if(q.isHumanPlayerInfo(e)?(t=e.name,i=!1):(t=B.getAiPlayerName(e),i=!0,r=e.difficulty),e.countryId!==$.OBS_COUNTRY_ID){var s=F.get(e)??e.countryId,a=D.get(e)??e.colorId,n=_.get(e)??e.startPos;if(s===$.RANDOM_COUNTRY_ID)throw new Error("Random country should have been resolved by now");if(a===$.RANDOM_COLOR_ID)throw new Error("Random color should have been resolved by now");if(n===$.RANDOM_START_POS)throw new Error("Random start location should have been resolved by now");s=S[s].name,s=V.Country.factory(s,y),a=w[a];B.addPlayer(N.createCombatant(t,s,n,a,i,r))}else B.addPlayer(N.createObserver(t,y))}),B.addPlayer(N.createNeutral(y,"@@NEUTRAL@@")),B}})}}}),System.register("worker/WorkerApi",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("gui/screen/game/GameLoader",["data/DataStream","@puzzl/core/lib/async/cancellation","engine/ResourceLoader","engine/resourceConfigs","engine/Engine","engine/TheaterType","util/time","game/SideType","game/Coords","engine/IsoCoords","engine/type/ObjectType","engine/ImageFinder","engine/renderable/builder/ShpBuilder","engine/renderable/entity/PipOverlay","engine/renderable/builder/CanvasSpriteBuilder","game/theater/TileSets","game/GameFactory","engine/renderable/fx/TrailerSmokeFx","engine/renderable/builder/ShpAggregator","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/building/BuildingAnimArtProps","util/math","data/MixFile","util/userAgent","game/gameopts/GameOptRandomGen","engine/renderable/DebugRenderable"],function(e,t){"use strict";var f,b,i,y,T,n,M,v,S,w,R,P,I,r,s,u,d,a,k,B,j,o,C,E,l,c,h;t&&t.id;return{setters:[function(e){f=e},function(e){b=e},function(e){i=e},function(e){y=e},function(e){T=e},function(e){n=e},function(e){M=e},function(e){v=e},function(e){S=e},function(e){w=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){r=e},function(e){s=e},function(e){u=e},function(e){d=e},function(e){a=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){o=e},function(e){C=e},function(e){E=e},function(e){l=e},function(e){c=e}],execute:function(){e("GameLoader",h=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g){this.workerHostApi=e,this.cdnResourceLoader=t,this.appResourceLoader=i,this.rules=r,this.gameModes=s,this.sound=a,this.iniLogger=n,this.actionLogger=o,this.speedCheat=l,this.gameResConfig=c,this.vxlGeometryPool=h,this.buildingImageDataCache=u,this.botsEnabled=d,this.debugBotIndex=g}async load(e,t,i,r,s,a,n,o){var l=this.resolveLoadingPlayerInfos(e,t,i);n.start(l,i.mapTitle,s);try{return this.workerHostApi.warmUpPool(),await this.doLoad(e,t,i,r,s,a,n,o)}finally{this.workerHostApi.dispose()}}resolveLoadingPlayerInfos(e,t,i){let r=l.GameOptRandomGen.factory(e,t),s=r.generateColors(i),a=r.generateCountries(i,this.rules);return i.humanPlayers.map(e=>({...e,colorId:s.get(e)??e.colorId,countryId:a.get(e)??e.countryId}))}async doLoad(e,t,i,r,s,a,n,o){if(!T.Engine.vfs)throw new Error("Virtual File System not initialized");this.clearStaticCaches(),this.buildingImageDataCache.clear();try{T.Engine.getActiveMod()||await this.loadFestiveAssets(o)}catch(e){if(e instanceof b.OperationCanceledError)throw e;console.error("Couldn't load festive assets",e)}await this.loadTheater(r.theaterType,o,e=>n.onLoadProgress(e/100*30)),await M.sleep(1);var l=a&&this.botsEnabled?await this.loadBotsLib():{};let{game:c,theater:h}=await this.createGame(e,t,i,r,a,l),u=v.SideType.GDI,d;s&&(d=c.getPlayerByName(s),d.isObserver||(u=d.country.side));let g=this.gameResConfig.isCdn()?await this.cdnResourceLoader.loadResources([y.ResourceType.Sounds,...u===v.SideType.GDI?[y.ResourceType.EvaAlly,y.ResourceType.UiAlly]:[y.ResourceType.EvaSov,y.ResourceType.UiSov],y.ResourceType.Cameo],o,e=>n.onLoadProgress(30+e/100*15)):void 0;g&&T.Engine.vfs.addArchive(new C.MixFile(new f.DataStream(g.pop(y.ResourceType.Cameo))),this.cdnResourceLoader.getResourceFileName(y.ResourceType.Cameo));var p,m=this.collectCameoFileNames(c);if(await this.loadHudSideImages(g,u),n.onLoadProgress(40),await M.sleep(1),g){for(p of[y.ResourceType.Sounds,u===v.SideType.GDI?y.ResourceType.EvaAlly:y.ResourceType.EvaSov])T.Engine.vfs.addArchive(new C.MixFile(new f.DataStream(g.pop(p))),this.cdnResourceLoader.getResourceFileName(p));await T.Engine.vfs.addBagFile("audio.bag")}n.onLoadProgress(45),await M.sleep(1);l=/iPhone|Android|CrOS|Windows Phone|webOS/i.test(navigator.userAgent)||E.isIpad();return l||(console.time("Load sounds"),await this.prepareSounds(o,e=>n.onLoadProgress(45+e/100*15)),console.timeEnd("Load sounds")),n.onLoadProgress(60),await M.sleep(1),l||(l=T.Engine.getImages(),l=new P.ImageFinder(l,h),console.time("Load textures"),await this.prepareTextures(c.rules,c.art,r,l,o,e=>n.onLoadProgress(60+e/100*10)),console.timeEnd("Load textures")),n.onLoadProgress(70),await M.sleep(1),console.time("Load voxels"),await this.prepareVxlGeometries(c.rules,c.art,c.map,T.Engine.getVoxels(),o,e=>n.onLoadProgress(70+e/100*20)),console.timeEnd("Load voxels"),await M.sleep(1),o?.throwIfCancelled(),w.IsoCoords.init({x:0,y:c.map.mapBounds.getFullSize().width*S.Coords.getWorldTileSize()/2}),c.init(d),o?.throwIfCancelled(),n.onLoadProgress(95),await M.sleep(1),{game:c,theater:h,hudSide:u,cameoFilenames:m}}collectCameoFileNames(e){let t=[],i=[...e.rules.buildingRules.values(),...e.rules.infantryRules.values(),...e.rules.vehicleRules.values(),...e.rules.aircraftRules.values()];for(var r of i.values())e.art.hasObject(r.name,r.type)&&(r=e.art.getObject(r.name,r.type),t.push(r.cameo+".shp"),t.push(r.altCameo+".shp"));for(var s of e.rules.superWeaponRules.values())s.sidebarImage.length&&t.push(s.sidebarImage+".shp");return t=t.filter(e=>T.Engine.getImages().has(e)),[...new Set(t)]}async prepareSounds(s,a){let e=new Set;for(var t of this.sound.soundSpecs.getAll())for(var i of t.sounds){const r=this.sound.getWavFile(i);r&&r.isRawImaAdpcm()&&e.add(r)}let n=0,o=e.size;if(o){let r=[...e].sort((e,t)=>e.getRawData().length-t.getRawData().length);var l=this.workerHostApi.concurrency;try{for(let e=0;e<l;e++)this.workerHostApi.queueTask(async t=>{for(;r.length&&!s?.isCancelled();){let e=r.pop();var i=e.getRawData(),i=await t.decodeWav(i);e.setData(i),n++;i=n/o*100;Math.floor(i)%10==0&&a(n/o*100)}}),await Promise.resolve();await this.workerHostApi.waitForTasks(),s?.throwIfCancelled()}catch(e){if(e instanceof b.OperationCanceledError)throw e;console.error(e)}}}async loadTheater(t,i,r){if(this.gameResConfig.isCdn()){var s=y.theaterSpecificResources.get(t);if(!s)throw new Error("Unhandled theater type "+n.TheaterType[t]);var a,s=[y.ResourceType.BuildGen,y.ResourceType.Anims,y.ResourceType.Vxl,...s];let e=await this.cdnResourceLoader.loadResources(s,i,e=>r(e/100*60));for(a of s)T.Engine.vfs.addArchive(new C.MixFile(new f.DataStream(e.pop(a))),this.cdnResourceLoader.getResourceFileName(a))}else r(100)}async createGame(e,t,i,r,s,a){var n=T.Engine.getIni(this.gameModes.getById(i.gameMode).rulesOverride),o=await T.Engine.loadTheater(r.theaterType),l=T.Engine.getActiveEngine(),c=T.Engine.getTheaterSettings(l,r.theaterType),l=T.Engine.getTheaterIni(l,r.theaterType);let h=new u.TileSets(l);return h.loadTileData(T.Engine.getTileData(),c.Extension),{game:d.GameFactory.create(r,h,T.Engine.getRules(),T.Engine.getArt(),T.Engine.getAi(),n,e,t,i,this.gameModes,s,a,this.iniLogger,this.speedCheat,this.debugBotIndex,this.actionLogger),theater:o}}async loadBotsLib(){let e;try{e=await SystemJS.import("@chronodivide/sp-bots")}catch(e){throw new i.DownloadError("Failed to download bot lib",{cause:e})}return e}async loadHudSideImages(e,t){if(!T.Engine.vfs)throw new Error("VFS is not initialized");if(T.Engine.vfs.removeArchive("sidec01.mix"),T.Engine.vfs.removeArchive("sidec02.mix"),T.Engine.vfs.removeArchive("sidec01cd.mix"),T.Engine.vfs.removeArchive("sidec02cd.mix"),T.Engine.unloadSideMixData(),e){var i=t===v.SideType.GDI?y.ResourceType.UiAlly:y.ResourceType.UiSov,r=this.cdnResourceLoader.getResourceFileName(i);if(!["sidec01.mix","sidec02.mix"].includes(r))throw new Error(`Side mix file name "${r}" mismatch`);T.Engine.vfs.addArchive(new C.MixFile(new f.DataStream(e.pop(i))),r)}else await T.Engine.vfs.addMixFile(t===v.SideType.GDI?"sidec01.mix":"sidec02.mix");await T.Engine.vfs.addMixFile(t===v.SideType.GDI?"sidec01cd.mix":"sidec02cd.mix")}async loadFestiveAssets(t){let e=new Date;var i=e.getMonth()+1,r=e.getDate();let s;if(10===i&&o.isBetween(r,24,31)||11===i&&o.isBetween(r,1,6)?s=y.ResourceType.HalloweenMix:12===i&&o.isBetween(r,16,31)&&(s=y.ResourceType.XmasMix),void 0!==s){i=this.appResourceLoader.getResourceFileName(s);if(!T.Engine.vfs.hasArchive(i)){let e=await this.appResourceLoader.loadResources([s],t);r=e.pop(s),r=new C.MixFile(new f.DataStream(r));T.Engine.vfs.addArchive(r,i)}}}async prepareTextures(e,i,t,r,s,a){let n=new B.BuildingShpHelper(r),o=new k.ShpAggregator,l=new Set,c=performance.now(),h=new Set;for(var u of t.structures)h.add(u.name);let d=[];for(var[g,p]of e.buildingRules)!h.has(g)&&-1===p.techLevel||d.push(g);let m=0;var f,y,T=d.length+e.animationNames.size;for(f of d){s?.throwIfCancelled();var v=performance.now();if(1e3<v-c&&(c=v,a(m/T*100),await M.sleep(0)),m++,!this.buildingImageDataCache.has(f)&&i.hasObject(f,R.ObjectType.Building)){v=i.getObject(f,R.ObjectType.Building);if(!v.demandLoad){let t=new j.BuildingAnimArtProps;t.read(v.art,i);for(var b of t.getAll().values())for(var S of b)l.add(S.name);try{var w=r.findByObjectArt(v),C=v.bibShape?r.find(v.bibShape,v.useTheaterExtension):void 0,E=n.collectAnimShpFiles(t,v);let e=n.getShpFrameInfos(v,w,C,E);var x=o.aggregate(e.values(),`agg_${f}.shp`);this.buildingImageDataCache.set(f,x),I.ShpBuilder.prepareTexture(x.file)}catch(e){if(e instanceof P.ImageFinder.MissingImageError)continue;throw e}}}}for(y of e.animationNames){s?.throwIfCancelled();var O=performance.now();if(1e3<O-c&&(c=O,a(m/T*100),await M.sleep(0)),m++,!l.has(y)&&i.hasObject(y,R.ObjectType.Animation)){O=i.getAnimation(y);try{var A=r.findByObjectArt(O);I.ShpBuilder.prepareTexture(A)}catch(e){if(e instanceof P.ImageFinder.MissingImageError)continue;throw e}}}}async prepareVxlGeometries(i,t,e,r,n,o){let s=new Set([...i.vehicleRules.values(),...i.aircraftRules.values(),...i.buildingRules.values()].filter(e=>(-1!==e.techLevel||e.spawned)&&t.hasObject(e.name,e.type)));for(var a of i.buildingRules.values()){if(a.freeUnit){let e;i.hasObject(a.freeUnit,R.ObjectType.Vehicle)&&(e=i.getObject(a.freeUnit,R.ObjectType.Vehicle)),e&&s.add(e)}a.undeploysInto&&s.add(i.getObject(a.undeploysInto,R.ObjectType.Vehicle))}for(var l of e.getInitialMapObjects().technos)(l.isVehicle()||l.isAircraft())&&i.hasObject(l.name,l.type)&&s.add(i.getObject(l.name,l.type));let c=new Map;for(var h of s){let e=t.getObject(h.name,h.type);if(e.isVoxel||h.type===R.ObjectType.Building&&h.turretAnimIsVoxel){var u,d=e.imageName.toLowerCase();let t=[];if(h.type!==R.ObjectType.Building){if(t.push(d+".vxl"),h.spawns&&h.noSpawnAlt&&t.push(d+"wo.vxl"),h.harvester&&h.unloadingClass&&t.push(i.getObject(h.unloadingClass,R.ObjectType.Vehicle).imageName.toLowerCase()+".vxl"),h.turret){for(let e=0;e<h.turretCount;++e)t.push(d+`tur${e||""}.vxl`);var g=d+"barl.vxl";r.has(g)&&t.push(g)}}else if(h.turretAnimIsVoxel){let e=h.turretAnim.toLowerCase()+".vxl";t.push(e);g=e.replace("tur","barl");r.has(g)&&t.push(g)}for(u of t){var p=r.get(u);p&&c.set(u,p)}}}let m=0,f=[];for(var[y,T]of c)n?.throwIfCancelled(),await this.vxlGeometryPool.loadFromStorage(T,y)?(m++,o(m/c.size*100)):f.push([y,T]);if(f.length){f.sort((e,t)=>t[1].voxelCount-e[1].voxelCount);var v=this.workerHostApi.concurrency;let s=this.vxlGeometryPool.getModelQuality(),a=[()=>this.vxlGeometryPool.clearOtherModStorage()];try{for(let e=0;e<v;e++)this.workerHostApi.queueTask(async r=>{for(;f.length&&!n?.isCancelled();){let[e,t]=f.pop(),i=await r.generateVxlGeometry(t,s);a.push(()=>this.vxlGeometryPool.persistToStorage(t,e,i)),m++,o(m/c.size*100)}});await this.workerHostApi.waitForTasks(),n?.throwIfCancelled()}catch(e){if(e instanceof b.OperationCanceledError)throw e;console.error(e),console.warn("Failed to pre-load VXL geometries. Skipping.")}await Promise.all(a.map(e=>e())).catch(e=>console.warn("Failed to persist VXL geometry cache",[e]))}}clearStaticCaches(){r.PipOverlay.clearCaches(),I.ShpBuilder.clearCaches(),c.DebugRenderable.clearCaches(),s.CanvasSpriteBuilder.clearCaches(),a.TrailerSmokeFx.clearTextureCache()}})}}}),System.register("gui/screen/game/HudFactory",["gui/screen/game/component/Hud","engine/Engine"],function(e,t){"use strict";var i,r,s;t&&t.id;return{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("HudFactory",s=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p){this.sideType=e,this.uiScene=t,this.sidebarModel=i,this.messageList=r,this.chatHistory=s,this.debugText=a,this.debugTextEnabled=n,this.localPlayer=o,this.players=l,this.stalemateDetectTrait=c,this.countdownTimer=h,this.cameoFilenames=u,this.jsxRenderer=d,this.strings=g,this.commandBarButtons=p}create(){return new i.Hud(this.sideType,this.uiScene.viewport,r.Engine.getImages(),r.Engine.getPalettes(),this.cameoFilenames,this.sidebarModel,this.messageList,this.chatHistory,this.debugText,this.debugTextEnabled,this.localPlayer,this.players,this.stalemateDetectTrait,this.countdownTimer,this.jsxRenderer,this.strings,this.commandBarButtons)}})}}}),System.register("gui/replay/ReplayExistsError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("ReplayExistsError",i)}}}),System.register("gui/ReplayManager",["network/gamestate/Replay","gui/replay/ReplayExistsError"],function(e,t){"use strict";var o,l,i;t&&t.id;return{setters:[function(e){o=e},function(e){l=e}],execute:function(){e("ReplayManager",i=class{constructor(e){this.storage=e}async loadList(e=!1){return await this.storage.getManifest(e)}async loadSerializedReplay(e){return await this.storage.getReplayData(e)}async loadReplay(e){let t=await this.loadSerializedReplay(e),i=new o.Replay;return i.unserialize("string"==typeof t?t:await t.text(),e),i}async saveReplay(e,t=!1){var i=e.name;if(!i)throw new Error("Replay is not initialized");var r=THREE.Math.generateUUID(),s=e.serialize();let a={id:r,name:i,keep:t,timestamp:e.timestamp},n=1;for(;await this.storage.hasReplayData(a);)1<n&&(a.name=a.name.replace(/ \(\d+\)$/,"")),a.name+=` (${++n})`;let o=await this.loadList(),l=o.filter(e=>!e.keep);if(50<l.length)for(var c of l.slice(50))await this.storage.deleteReplayData(c),o.splice(o.indexOf(c),1);return o.unshift(a),await this.storage.saveReplayData(a,s),await this.storage.saveManifest(o),r}async keepReplay(t,i){let r=await this.loadList();var s=r.find(e=>e.id===t);if(s){var a={...s,name:o.Replay.sanitizeFileName(i),keep:!0};if(await this.storage.hasReplayData(a))throw new l.ReplayExistsError(`A replay with name "${a.name}" already exists`);let e=await this.storage.getReplayData(s);var n="string"==typeof e?e:await e.text();await this.storage.deleteReplayData(s),await this.storage.saveReplayData(a,n),Object.assign(s,a),await this.storage.saveManifest(r)}}async deleteReplay(t){await this.storage.deleteReplayData(t);let e=await this.loadList();var i=e.findIndex(e=>e.id===t.id);-1!==i&&(e.splice(i,1),await this.storage.saveManifest(e))}async importReplay(s){return new Promise((r,e)=>{let t=new FileReader;t.onload=async t=>{try{var i=s.name.replace(o.Replay.extension,"");let e=new o.Replay;e.unserialize(t.target.result,{name:i,timestamp:s.lastModified}),await this.saveReplay(e,!0),r(e)}catch(t){e(t)}},t.onerror=()=>{e(t.error)},t.readAsText(s,"utf-8")})}})}}}),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonList",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],function(e,t){"use strict";var a,i;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("CommandBarButtonList",i=class{constructor(){this.buttons=[]}fromIni(e){var t,i=e.get("ButtonList")?.split(",")??[];let r=[],s=new Set(Object.keys(a.CommandBarButtonType).filter(e=>"string"==typeof e));for(t of i)"x"===t?r.push(a.CommandBarButtonType.Separator):s.has(t)?r.push(a.CommandBarButtonType[t]):console.warn(`Unknown command bar button type "${t}"`);return this.buttons=r,this}})}}}),System.register("gui/component/Toasts",["react"],function(e,t){"use strict";var r;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("Toasts",({messages:e,viewport:t,zIndex:i})=>{return r.default.createElement("div",{style:{position:"absolute",top:t.x,left:t.y,width:t.width,zIndex:i}},r.default.createElement("div",{className:"toasts"},e.map((e,t)=>r.default.createElement("div",{key:t,className:"toast"},e))))})}}}),System.register("gui/component/ToastApi",["gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Toasts"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("ToastApi",n=class{constructor(e,t,i){this.viewport=e,this.uiScene=t,this.jsxRenderer=i,this.messages=[],this.disposables=new s.CompositeDisposable,this.handleViewportChange=t=>{this.innerComponent&&this.innerComponent.applyOptions(e=>e.viewport=t)}}push(e){var t=Date.now();this.messages.push({text:e,timestamp:t}),this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.update()}update(){if(this.messages=this.messages.filter(e=>e.timestamp>Date.now()-5e3),this.messages=this.messages.slice(-5),this.messages.length){let t=this.messages.map(e=>e.text);if(this.uiToasts)this.innerComponent?.applyOptions(e=>e.messages=t);else{let[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{innerRef:e=>this.innerComponent=e,component:a.Toasts,props:{messages:t,viewport:this.viewport.value,zIndex:101}}));this.uiToasts=e,this.uiScene.add(e),this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(e,()=>this.uiScene.remove(e),()=>this.viewport.onChange.unsubscribe(this.handleViewportChange),()=>this.innerComponent=void 0,()=>this.uiToasts=void 0)}this.updateTimeoutId=setTimeout(()=>this.update(),5e3)}else this.destroy()}destroy(){this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.disposables.dispose()}})}}}),System.register("gui/screen/RootScreen",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RootScreen",i=class{constructor(){this.preventUnload=!1}setController(e){this.controller=e}})}}}),System.register("gui/screen/game/loadingScreen/LoadingScreen",["react","network/gamestate/PlayerConnectionStatus","gui/component/CountryIcon","game/gameopts/constants"],function(e,t){"use strict";var n,i,r,s,o,l,a;t&&t.id;return{setters:[function(e){n=e},function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){o=(new Map).set("Americans","Name:Para").set("French","Name:GTGCAN").set("Germans","Name:TNKD").set("British","Name:SNIPE").set("Russians","Name:TTNK").set("Confederation","Name:TERROR").set("Africans","Name:DTRUCK").set("Arabs","Name:DESO").set("Alliance","Name:BEAGLE"),l=(new Map).set("Americans","LoadBrief:USA").set("French","LoadBrief:French").set("Germans","LoadBrief:Germans").set("British","LoadBrief:British").set("Russians","LoadBrief:Russia").set("Confederation","LoadBrief:Cuba").set("Africans","LoadBrief:Lybia").set("Arabs","LoadBrief:Iraq").set("Alliance","LoadBrief:Korea"),a=class extends n.default.Component{render(){let e=this.props.playerInfos;var t=this.props.countryName,i=this.props.color,r=l.get(t),s=o.get(t);let a=this.props.strings;return n.default.createElement("div",{className:"loading-screen",style:this.getStyle(this.props.bgImageSrc)},s?n.default.createElement("div",{className:"special-unit-name"},a.get(s)):null,r?n.default.createElement("div",{className:"briefing-text",style:{color:i}},a.get(r)):null,n.default.createElement("div",{className:"loading-text",style:{color:i}},a.get("GUI:LoadingEx")),n.default.createElement("div",{className:"player-status-container"},e?e.map(e=>this.renderStatus(e)):null),n.default.createElement("div",{style:{color:i},className:"country-name"},this.props.strings.get(this.props.countryUiNames.get(t)||t)),n.default.createElement("div",{style:{color:i},className:"map-name"},this.props.mapName))}renderStatus(e){var t=e.status===i.PlayerConnectionStatus.Connected?1:.5;return n.default.createElement("div",{key:e.name,className:"player-status",style:{opacity:t,color:e.color}},n.default.createElement("progress",{value:""+e.loadPercent,max:100}),n.default.createElement(r.CountryIcon,{country:e.country?e.country.name:s.OBS_COUNTRY_NAME}),n.default.createElement("span",{className:"player-name"},e.name))}getStyle(e){var t=this.props.viewport;return{backgroundImage:e?`url(${e})`:void 0,backgroundSize:"cover",width:t.width+"px",height:t.height+"px",position:"absolute",left:t.x,top:t.y}}},e("LoadingScreen",a)}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenWrapper",["gui/jsx/jsx","gui/HtmlContainer","gui/jsx/UiComponent","gui/UiObject","gui/jsx/HtmlView","gui/screen/game/loadingScreen/LoadingScreen","game/gameopts/constants","game/SideType"],function(e,t){"use strict";var i,l,r,c,s,a,h,u,d,n;t&&t.id;return{setters:[function(e){i=e},function(e){l=e},function(e){r=e},function(e){c=e},function(e){s=e},function(e){a=e},function(e){h=e},function(e){u=e}],execute:function(){d=(new Map).set("Americans","ls800ustates.png").set("French","ls800france.png").set("Germans","ls800germany.png").set("British","ls800ukingdom.png").set("Russians","ls800russia.png").set("Confederation","ls800cuba.png").set("Africans","ls800libya.png").set("Arabs","ls800iraq.png").set("Alliance","ls800korea.png").set(h.OBS_COUNTRY_NAME,"ls800obs.png"),n=class extends r.UiComponent{createUiObject({playerName:t,gameResConfig:e}){var i,r=new c.UiObject(new THREE.Object3D,new l.HtmlContainer),s=t?this.props.playerInfos.find(e=>e.name===t):void 0,a=s?.country?s.country.name:h.OBS_COUNTRY_NAME;this.countryName=a;let n=s?.color??"#fff";s?.country&&(i=s.country.side===u.SideType.GDI?"AlliedLoad":"SovietLoad",n=this.props.rules.colors.get(i)?.asHexString()??"#fff"),this.color=n;let o=d.get(a);return o?e.isCdn()?this.bgHtmlImg=e.getCdnBaseUrl()+"ls/"+o:(this.bgSpriteImg=o?.replace("png","shp"),this.bgSpritePal=s?.country?"mpls.pal":"mplsobs.pal"):console.warn("Missing loading image for country "+a),r}defineChildren(){let e=this.props.rules.getMultiplayerCountries();var t=this.props.viewport;return i.jsx("fragment",null,this.props.gameResConfig.isCdn()?[]:i.jsx("sprite",{image:this.bgSpriteImg,palette:this.bgSpritePal,x:t.x,y:t.y,ref:e=>this.sprite=e}),i.jsx(s.HtmlView,{innerRef:e=>this.htmlEl=e,component:a.LoadingScreen,props:{viewport:this.props.viewport,countryUiNames:new Map([[h.OBS_COUNTRY_NAME,h.OBS_COUNTRY_UI_NAME]].concat(e.map(e=>[e.name,e.uiName]))),strings:this.props.strings,countryName:this.countryName,mapName:this.props.mapName,color:this.color,playerInfos:this.props.playerInfos,bgImageSrc:this.bgHtmlImg}}))}updateViewport(t){this.htmlEl?.applyOptions(e=>e.viewport=t),this.sprite?.setPosition(t.x,t.y)}applyOptions(e){this.htmlEl?.applyOptions(e)}},e("LoadingScreenWrapper",n)}}}),System.register("gui/screen/game/loadingScreen/MpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(e,t){"use strict";var i,s,o,r,a;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){o=e},function(e){r=e}],execute:function(){e("MpLoadingScreenApi",a=class{constructor(e,t,i,r,s,a,n){this.gservCon=e,this.loadInfoParser=t,this.rules=i,this.strings=r,this.uiScene=s,this.jsxRenderer=a,this.gameResConfig=n,this.lastLoadPercent=0,this.disposables=new o.CompositeDisposable,this.handleLoadInfoUpdate=e=>{let t=this.loadInfoParser.parse(e);this.loadingScreen?this.loadingScreen.applyOptions(e=>{e.playerInfos=this.createExtendedLoadingInfos(t)}):this.createLoadingScreen(t)}}async start(t,i,r){if(this.gservCon.isOpen()){this.players=t,this.localPlayerName=r,this.mapName=i,this.gservCon.onLoadInfo.subscribe(this.handleLoadInfoUpdate),this.disposables.add(()=>this.gservCon.onLoadInfo.unsubscribe(this.handleLoadInfoUpdate)),this.gservCon.requestLoadInfo();let e=setInterval(()=>{this.gservCon.isOpen()?this.gservCon.requestLoadInfo():this.disposables.dispose()},1e4);this.disposables.add(()=>clearInterval(e))}}onLoadProgress(e){(e=Math.floor(e))>this.lastLoadPercent&&(this.lastLoadPercent=e,this.gservCon.isOpen()&&this.gservCon.sendLoadedPercent(e))}createExtendedLoadingInfos(e){let i=[...this.rules.getMultiplayerColors().values()],r=this.rules.getMultiplayerCountries();return e.map(t=>{var e=this.players.find(e=>e.name===t.name);return{name:t.name,status:t.status,loadPercent:t.loadPercent,country:r[e.countryId],color:e.countryId===s.OBS_COUNTRY_ID?"#fff":i[e.colorId].asHexString()}})}createLoadingScreen(e){let[t]=this.jsxRenderer.render(i.jsx(r.LoadingScreenWrapper,{ref:e=>this.loadingScreen=e,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(e),gameResConfig:this.gameResConfig}));this.uiScene.add(t),this.disposables.add(t,()=>this.uiScene.remove(t),()=>this.loadingScreen=void 0)}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/ReplayLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(e,t){"use strict";var i,s,a,n,r,o;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){r=e}],execute:function(){e("ReplayLoadingScreenApi",o=class{constructor(e,t,i,r,s){this.rules=e,this.strings=t,this.uiScene=i,this.jsxRenderer=r,this.gameResConfig=s,this.lastLoadPercent=0,this.disposables=new a.CompositeDisposable,this.handleLoadInfoUpdate=t=>{var e;this.loadingScreen?(e=performance.now(),(!this.lastRenderTime||e-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=e,this.loadingScreen.applyOptions(e=>{e.playerInfos=this.createExtendedLoadingInfos(t)}))):this.createLoadingScreen(t)}}async start(e,t){this.players=e,this.mapName=t,this.handleLoadInfoUpdate(0)}onLoadProgress(e){(e=Math.floor(e))>this.lastLoadPercent&&(this.lastLoadPercent=e,this.handleLoadInfoUpdate(e))}createExtendedLoadingInfos(t){let i=[...this.rules.getMultiplayerColors().values()],r=this.rules.getMultiplayerCountries();return this.players.filter(e=>e.countryId!==s.OBS_COUNTRY_ID).map(e=>({name:e.name,status:n.PlayerConnectionStatus.Connected,loadPercent:t,country:r[e.countryId],color:i[e.colorId].asHexString()}))}createLoadingScreen(e){let[t]=this.jsxRenderer.render(i.jsx(r.LoadingScreenWrapper,{ref:e=>this.loadingScreen=e,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:void 0,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(e),gameResConfig:this.gameResConfig}));this.uiScene.add(t),this.disposables.add(t,()=>this.uiScene.remove(t),()=>this.loadingScreen=void 0)}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/SpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(e,t){"use strict";var i,s,a,n,r,o;t&&t.id;return{setters:[function(e){i=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){r=e}],execute:function(){e("SpLoadingScreenApi",o=class{constructor(e,t,i,r,s){this.rules=e,this.strings=t,this.uiScene=i,this.jsxRenderer=r,this.gameResConfig=s,this.lastLoadPercent=0,this.disposables=new a.CompositeDisposable,this.handleLoadInfoUpdate=t=>{var e;this.loadingScreen?(e=performance.now(),(!this.lastRenderTime||e-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=e,this.loadingScreen.applyOptions(e=>{e.playerInfos=this.createExtendedLoadingInfos(t)}))):this.createLoadingScreen()}}async start(e,t,i){this.players=e,this.localPlayerName=i,this.mapName=t,this.handleLoadInfoUpdate(0)}onLoadProgress(e){(e=Math.floor(e))>this.lastLoadPercent&&(this.lastLoadPercent=e,this.handleLoadInfoUpdate(e))}createExtendedLoadingInfos(e){let t=[...this.rules.getMultiplayerColors().values()];var i=this.rules.getMultiplayerCountries(),r=this.players.find(e=>e.name===this.localPlayerName);return[{name:this.localPlayerName,status:n.PlayerConnectionStatus.Connected,loadPercent:e,country:i[r.countryId],color:r.countryId===s.OBS_COUNTRY_ID?"#fff":t[r.colorId].asHexString()}]}createLoadingScreen(){let[e]=this.jsxRenderer.render(i.jsx(r.LoadingScreenWrapper,{ref:e=>this.loadingScreen=e,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(0),gameResConfig:this.gameResConfig}));this.uiScene.add(e),this.disposables.add(e,()=>this.uiScene.remove(e))}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenApiFactory",["network/gameopt/LoadInfoParser","gui/screen/game/loadingScreen/MpLoadingScreenApi","gui/screen/game/loadingScreen/ReplayLoadingScreenApi","gui/screen/game/loadingScreen/SpLoadingScreenApi"],function(t,e){"use strict";var l,c,h,u,d,i;e&&e.id;return{setters:[function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var e;(e=d=d||{})[e.SinglePlayer=0]="SinglePlayer",e[e.MultiPlayer=1]="MultiPlayer",e[e.Replay=2]="Replay",t("LoadingScreenType",d),t("LoadingScreenApiFactory",i=class{constructor(e,t,i,r,s,a){this.rules=e,this.strings=t,this.uiScene=i,this.jsxRenderer=r,this.gameResConfig=s,this.gservCon=a}create(e){var{rules:t,strings:i,uiScene:r,jsxRenderer:s,gameResConfig:a,gservCon:n}=this;switch(e){case d.SinglePlayer:return new u.SpLoadingScreenApi(t,i,r,s,a);case d.MultiPlayer:var o=new l.LoadInfoParser;return new c.MpLoadingScreenApi(n,o,t,i,r,s,a);case d.Replay:return new h.ReplayLoadingScreenApi(t,i,r,s,a);default:throw new Error(`Unsupported loading screen type "${e}"`)}}})}}}),System.register("engine/MapSupport",["game/rules/Rules","engine/Engine","game/theater/TileSets","engine/TheaterType"],function(e,t){"use strict";var a,n,o,l,i;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){e("MapSupport",i=class{static check(e,t){if(e.iniFormat<4)return t.get("TS:MapUnsupportedGame");if(!n.Engine.supportsTheater(e.theaterType))return t.get("TS:MapUnsupportedTheater",l.TheaterType[e.theaterType]);var i=n.Engine.getTheaterIni(n.Engine.getActiveEngine(),e.theaterType);let r=new o.TileSets(i);if(e.maxTileNum>r.readMaxTileNum())return t.get("TS:MapUnsupportedTileSet");let s=new a.Rules(n.Engine.getRules().clone().mergeWith(e));return s.hasOverlayId(e.maxOverlayId)?void 0:t.get("TS:MapUnsupportedOverlay",e.maxOverlayId)}})}}}),System.register("network/gameres/GameResClientInfo",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gameres/GameResGameInfo",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/gameres/GameResType",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){var e;(e=i=i||{})[e.ConnectionLost=2]="ConnectionLost",e[e.Playing=8]="Playing",e[e.Draw=64]="Draw",e[e.Win=256]="Win",e[e.Loss=512]="Loss",e[e.Resign=528]="Resign",e[e.Disconnect=768]="Disconnect",t("GameResType",i)}}}),System.register("network/gameres/GameResPlayerInfo",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("GameResPlayerInfo",i=class{})}}}),System.register("network/gameres/GameRes",["data/DataStream","engine/type/ObjectType","game/gameopts/constants","util/typeGuard","network/gameres/GameResType"],function(t,e){"use strict";var n,o,l,c,s,a,i;e&&e.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){s=e}],execute:function(){var e;(e=a=a||{})[e.Byte=1]="Byte",e[e.Boolean=2]="Boolean",e[e.Time=5]="Time",e[e.Int=6]="Int",e[e.String=7]="String",t("GameRes",i=class{fromGame(i,e,r){let t=i.gameOpts,s=i.gameOpts.humanPlayers.filter(e=>e.countryId!==l.OBS_COUNTRY_ID).map(e=>i.getPlayerByName(e.name));this.game={id:Number(String(i.id).slice(0,-3)),startTime:i.startTimestamp,duration:Math.floor(i.currentTime/1e3),speed:6-t.gameSpeed,players:s.length,mapName:t.mapName,mapDigest:t.mapDigest,unitCount:t.unitCount,cratesAppear:t.cratesAppear,credits:t.credits,tournament:e,shortGame:t.shortGame,superWeapons:t.superWeapons,aiPlayers:t.aiPlayers.filter(c.isNotNullOrUndefined).length,gameMode:t.gameMode,buildOffAlly:t.buildOffAlly,mcvRepacks:t.mcvRepacks},this.client={...r,senderId:s.findIndex(e=>e.name===r.accountName)};let a=this.computePlayerTeams(i,s);return this.players=s.map(t=>({buildingsBuilt:t.getUnitsBuilt(o.ObjectType.Building),buildingsCaptured:t.buildingsCaptured,buildingsKilled:t.getUnitsKilled(o.ObjectType.Building),buildingsLeft:t.buildings.size,color:2*[...i.rules.colors.values()].findIndex(e=>e.asHex()===t.color.asHex())+1,cratesFound:t.cratesPickedUp,endCredits:t.credits,infantryBuilt:t.getUnitsBuilt(o.ObjectType.Infantry),infantryKilled:t.getUnitsKilled(o.ObjectType.Infantry),infantryLeft:t.getOwnedObjectsByType(o.ObjectType.Infantry).length,lostConnection:t.name===r.accountName&&r.suddenDisconnect,name:t.name,planesBuilt:t.getUnitsBuilt(o.ObjectType.Aircraft),planesKilled:t.getUnitsKilled(o.ObjectType.Aircraft),planesLeft:t.getOwnedObjectsByType(o.ObjectType.Aircraft).length,unitsBuilt:t.getUnitsBuilt(o.ObjectType.Vehicle),unitsKilled:t.getUnitsKilled(o.ObjectType.Vehicle),unitsLeft:t.getOwnedObjectsByType(o.ObjectType.Vehicle).length,completionStatus:this.getCompletionStatus(t,i,this.client,s.length),country:t.country.id,side:t.country.side,team:a.get(t)})),this}computePlayerTeams(e,t){let i=new Map,r=0;for(var s of t)if(!i.has(s)){var a;i.set(s,r);for(a of e.alliances.getAllies(s))i.has(a)||i.set(a,r);r++}return i}getCompletionStatus(e,t,i,r){return i.finished?t.stalemateDetectTrait?.isStale()?s.GameResType.Draw:e.defeated?e.resigned?s.GameResType.Resign:e.dropped?s.GameResType.Disconnect:s.GameResType.Loss:s.GameResType.Win:i.outOfSync?s.GameResType.Disconnect:2<r?s.GameResType.Playing:i.accountName!==e.name?s.GameResType.Win:i.quit?s.GameResType.Resign:e.defeated?s.GameResType.Loss:s.GameResType.Disconnect}toFlat(){return{AFPS:[a.Int,this.client.avgFps],AIPL:[a.Int,this.game.aiPlayers],CRAT:[a.Boolean,this.game.cratesAppear],DURA:[a.Int,this.game.duration],FINI:[a.Boolean,this.client.finished],GSKU:[a.Int,this.client.gameSku],CRED:[a.Int,this.game.credits],IDNO:[a.Int,this.game.id],OOSY:[a.Boolean,this.client.outOfSync],PLRS:[a.Int,this.game.players],PNGR:[a.Int,this.client.pingsRecv],PNGS:[a.Int,this.client.pingsSent],SCEN:[a.String,this.game.mapName],SHRT:[a.Boolean,this.game.shortGame],SPID:[a.Int,this.client.senderId],SPED:[a.Int,this.game.speed],SUPR:[a.Boolean,this.game.superWeapons],TIME:[a.Time,this.game.startTime],TRNY:[a.Boolean,this.game.tournament],UNIT:[a.Int,this.game.unitCount],VERS:[a.String,this.client.clientVers],MODE:[a.Int,this.game.gameMode],BAMR:[a.Int,Number(this.game.mcvRepacks)+2*Number(this.game.buildOffAlly)],MAPC:[a.String,this.game.mapDigest],...this.players.map((e,t)=>({["BLB"+t]:[a.Time,e.buildingsBuilt],["BLC"+t]:[a.Int,e.buildingsCaptured],["BLK"+t]:[a.Time,e.buildingsKilled],["BLL"+t]:[a.Time,e.buildingsLeft],["COL"+t]:[a.Int,e.color],["CRA"+t]:[a.Int,e.cratesFound],["CRD"+t]:[a.Time,e.endCredits],["INB"+t]:[a.Time,e.infantryBuilt],["INK"+t]:[a.Time,e.infantryKilled],["INL"+t]:[a.Time,e.infantryLeft],["LCN"+t]:[a.Boolean,e.lostConnection],["NAM"+t]:[a.String,e.name],["PLB"+t]:[a.Time,e.planesBuilt],["PLK"+t]:[a.Time,e.planesKilled],["PLL"+t]:[a.Time,e.planesLeft],["UNB"+t]:[a.Time,e.unitsBuilt],["UNK"+t]:[a.Time,e.unitsKilled],["UNL"+t]:[a.Time,e.unitsLeft],["CMP"+t]:[a.Int,e.completionStatus],["CTY"+t]:[a.Int,e.country],["SID"+t]:[a.Int,e.side],["TID"+t]:[a.Int,e.team]})).reduce((e,t)=>e={...e,...t},{})}}toBinary(){var e,t=new n.DataStream,i=this.toFlat();for(e of Object.keys(i)){var[r,s]=i[e];this.writeType(r,e,s,t)}let a=new n.DataStream;return a.writeUint16(t.byteLength+4,n.DataStream.BIG_ENDIAN),a.writeUint16(0),a.writeUint8Array(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}writeType(e,t,i,r){if(4<t.length)throw new Error(`Field "${t}" must not exceed 4 characters`);switch(r.writeString(t,"ASCII",4),r.writeUint16(e,n.DataStream.BIG_ENDIAN),e){case a.Byte:return r.writeUint16(1,n.DataStream.BIG_ENDIAN),r.writeUint32(i,n.DataStream.BIG_ENDIAN);case a.Boolean:return r.writeUint16(1,n.DataStream.BIG_ENDIAN),r.writeUint8Array([i?1:0,0,0,0]);case a.Time:case a.Int:return r.writeUint16(4,n.DataStream.BIG_ENDIAN),r.writeUint32(i,n.DataStream.BIG_ENDIAN);case a.String:var s=i.length+1;return r.writeUint16(s,n.DataStream.BIG_ENDIAN),r.writeCString(i,4*Math.ceil(s/4));default:throw new Error(`Unhandled type "${e}"`)}}})}}}),System.register("network/WGameResConnection",["network/IrcConnection"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("WGameResConnection",r=class{constructor(e){this.con=e}get onError(){return this.con.onError}get onClose(){return this.con.onClose}static factory(e){return new this(new i.IrcConnection({mode:"binary"},e))}async connect(e){return await this.con.connect(e)}close(){this.con.close()}isOpen(){return this.con.isOpen()}sendGameResPacket(e){this.con.sendMessage(e)}})}}}),System.register("gui/screen/game/GameScreen",["data/DataStream","network/GservError","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","@puzzl/core/lib/async/sleep","game/Game","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","network/gamestate/LockstepManager","network/gamestate/ActionSerializer","game/action/ActionFactory","game/action/ActionQueue","tools/DevToolsApi","engine/GameAnimationLoop","gui/screen/game/component/GameResultPopup","gui/jsx/jsx","util/disposable/CompositeDisposable","network/gamestate/SoloPlayTurnManager","gui/screen/game/SoundHandler","LocalPrefs","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/CombatantUi","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/NetStats","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/Replay","network/gamestate/ReplayRecorder","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/ChatNetHandler","gui/screen/game/ChatTypingHandler","@puzzl/core/lib/async/Task","network/IrcConnection","@puzzl/core/lib/async/cancellation","network/gservConfig","engine/sound/Music","gui/screen/game/TauntHandler","gui/screen/game/TauntPlayback","game/action/ActionType","game/event/EventType","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/component/hud/commandBar/CommandBarButtonList","gui/screen/game/component/hud/commandBar/CommandBarButtonType","engine/ResourceLoader","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","util/userAgent","data/vfs/IOError","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/replay/ReplayStorageError","data/MapFile","data/vfs/VirtualFile","util/string","engine/MapDigest","engine/MapSupport","network/gameres/GameRes","game/gameopts/constants","gui/screen/mainMenu/MainMenuRoute","gui/screen/RootRoute","gui/chat/ChatHistory","gui/chat/ChatMessageFormat"],function(e,t){"use strict";var h,s,n,o,u,y,O,m,d,T,v,b,S,c,l,g,U,w,A,C,M,R,P,I,f,p,E,r,x,k,B,j,N,L,D,F,_,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee,te,a,i,ie,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve;t&&t.id;return{setters:[function(e){h=e},function(e){s=e},function(e){n=e},function(e){o=e},function(e){u=e},function(e){y=e},function(e){O=e},function(e){m=e},function(e){d=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){c=e},function(e){l=e},function(e){g=e},function(e){U=e},function(e){w=e},function(e){A=e},function(e){C=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){f=e},function(e){p=e},function(e){E=e},function(e){r=e},function(e){x=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e},function(e){ee=e},function(e){te=e},function(e){a=e},function(e){i=e},function(e){ie=e},function(e){re=e},function(e){se=e},function(e){ae=e},function(e){ne=e},function(e){oe=e},function(e){le=e},function(e){ce=e},function(e){he=e},function(e){ue=e},function(e){de=e},function(e){ge=e},function(e){pe=e},function(e){me=e},function(e){fe=e},function(e){ye=e},function(e){Te=e}],execute:function(){ve=class extends ae.RootScreen{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_){super(),this.workerHostApi=e,this.gservCon=t,this.wGameResCon=i,this.wolService=r,this.engineVersion=s,this.engineModHash=a,this.errorHandler=n,this.gameMenuSubScreens=o,this.loadingScreenApiFactory=l,this.gameOptsParser=c,this.gameOptsSerializer=h,this.config=u,this.strings=d,this.renderer=g,this.uiScene=p,this.runtimeVars=m,this.messageBoxApi=f,this.toastApi=y,this.uiAnimationLoop=T,this.viewport=v,this.jsxRenderer=b,this.pointer=S,this.sound=w,this.music=C,this.keyBinds=E,this.generalOptions=x,this.localPrefs=O,this.actionLogger=A,this.replayManager=M,this.fullScreen=R,this.mapFileLoader=P,this.mapDir=I,this.mapList=k,this.gameLoader=B,this.vxlGeometryPool=j,this.buildingImageDataCache=N,this.mutedPlayers=L,this.tauntsEnabled=D,this.speedCheat=F,this.sentry=_,this.preventUnload=!0,this.disposables=new U.CompositeDisposable,this.onGservClose=e=>{this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.handleError(e,this.strings.get("TXT_YOURE_DISCON")),this.game&&this.sendGameRes(this.game,{disconnect:!0,desync:!1,quit:!1,finished:!1})}}async onEnter(d){this.pointer.lock(),this.pointer.setVisible(!1),await this.music?.play($.MusicType.Loading);let e=new K.CancellationTokenSource;this.disposables.add(()=>e.cancel());let t=e.token,g;this.returnTo=d.returnTo,this.wgameresUrl=d.wgameresUrl,this.isTournament=d.tournament;var p=this.playerName=d.playerName,m=this.isSinglePlayer=d.create&&d.singlePlayer;if(m)g=d.gameOpts;else{var i=this.wolService.getCredentials();if(!i||i.user!==p)return this.localPrefs.removeItem(C.StorageKey.LastConnection),void this.controller?.goToScreen(n.ScreenType.MainMenuRoot,{route:new me.MainMenuRoute(o.ScreenType.Login,{forceUser:p,afterLogin:e=>new fe.RootRoute(n.ScreenType.Game,d)})});this.wolService.shouldKeepAliveInGame()?this.wolService.setAutoReconnect(!0):this.wolService.closeWolConnection(),this.gservCon.onClose.subscribe(this.onGservClose);try{g=await this.connectToServerInstance(d,i,t)}catch(e){return void this.handleGservConError(e)}this.localPrefs.setItem(C.StorageKey.LastConnection,JSON.stringify(d))}this.config.devMode?this.runtimeVars.cheatsEnabled.value=this.isSinglePlayer:this.isSinglePlayer||(this.runtimeVars.cheatsEnabled.value=!1);let r;try{var s=await this.transferAndLoadMapFile(d,g.mapName,g.mapDigest,t);g.mapOfficial||(this.debugMapFile=s,this.disposables.add(()=>this.debugMapFile=void 0)),r=new le.MapFile(s);var f=de.MapSupport.check(r,this.strings);if(f)throw new Error(f)}catch(e){return void this.handleMapLoadError(e,g.mapName)}f=this.loadingScreenApiFactory.create(m?ne.LoadingScreenType.SinglePlayer:ne.LoadingScreenType.MultiPlayer);if(this.loadingScreenApi=f,this.disposables.add(f,()=>this.loadingScreenApi=void 0),this.disposables.add(()=>this.gameLoader.clearStaticCaches()),!t.isCancelled()){let u;try{u=await this.gameLoader.load(d.gameId,d.timestamp,g,r,p,this.isSinglePlayer,f,t)}catch(e){return void this.handleGameLoadError(e,d,g)}if(!t.isCancelled()){let{game:i,theater:e,hudSide:t,cameoFilenames:r}=u;this.game=i,this.disposables.add(i,()=>this.game=void 0,()=>O.Engine.unloadTheater(e.type));let s=i.getPlayerByName(p),a;try{a=this.loadUi(i,e,s,t,r)}catch(e){f=e.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(i.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash"));return void this.handleGameError(e,f,i)}let n=new v.ActionFactory;(new D.ActionFactoryReg).register(n,i,p);let o=new b.ActionQueue,l=this.replay=new j.Replay;this.disposables.add(()=>this.replay=void 0),l.init(i.id,i.startTimestamp,g,this.engineVersion,this.engineModHash);let c=new N.ReplayRecorder(l,i.getPlayerNumber(s),i.gameOpts.humanPlayers,new T.ActionSerializer);if(this.isSinglePlayer)this.gameTurnMgr=new w.SoloPlayTurnManager(i,s,o,this.actionLogger,c);else{this.lagState=!1;let e=this.initLockstep(i,s,n,o,c);if(s.isObserver)try{e.setPassiveMode(!0)}catch(e){if(e instanceof z.IrcConnection.SocketError)return;throw e}this.gameTurnMgr=e}this.gameTurnMgr.init();let h=()=>{if(i.status!==y.GameStatus.Started)try{this.onGameStart(s,i,a,o,n,l,c)}catch(e){var t=e.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(i.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash"));this.handleGameError(e,t,i)}};if(m)h(),S.DevToolsApi.registerCommand("reset",async()=>{await this.onLeave(),await this.onEnter(d)}),S.DevToolsApi.registerVar("speed",i.desiredSpeed),this.disposables.add(()=>S.DevToolsApi.unregisterCommand("reset"),()=>S.DevToolsApi.unregisterVar("speed")),S.DevToolsApi.registerVar("cheats",this.runtimeVars.cheatsEnabled),this.disposables.add(()=>S.DevToolsApi.unregisterVar("cheats"));else if(this.gservCon.isOpen()){let e=e=>this.gameTurnMgr.setRate(e);this.gservCon.onRateChange.subscribe(e),this.disposables.add(()=>this.gservCon.onRateChange.unsubscribe(e)),this.gservCon.onGameStart.subscribe(h),this.disposables.add(()=>this.gservCon.onGameStart.unsubscribe(h)),this.gservCon.sendLoadedPercent(100)}}}}async connectToServerInstance(e,t,i){let r=!1,s=new W.Task(async e=>{await u.sleep(1e3),e.isCancelled()||(this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),r=!0)});s.start();try{var a,n,o;await this.gservCon.connect(e.gservUrl),await this.gservCon.cvers(this.engineVersion),await this.gservCon.login(t.user,t.pass),i.throwIfCancelled(),e.create?(a=this.gameOptsSerializer.serializeOptions(e.gameOpts),{gameId:n,timestamp:o}=e,await this.gservCon.createGame(n,o,a,this.engineVersion,this.engineModHash),console.log(`Created game instance with id ${e.gameId}.`),this.localPrefs.removeItem(C.StorageKey.LastConnection)):(await this.joinGame(e.gameId,5,i),console.log("Joined game instance with id "+e.gameId));var l=await this.gservCon.gameOpts();return this.gameOptsParser.parseOptions(l)}catch(e){throw this.gservCon.isOpen()||(r=!1),e}finally{s.cancel(),r&&this.messageBoxApi.destroy()}}async joinGame(e,i,r){if(i){let t;for(;i--;)try{return console.log(`Attempting to join game with id ${e}...`,i+" retries left"),r.throwIfCancelled(),void await this.gservCon.joinGame(e,this.engineVersion,this.engineModHash)}catch(e){if(!(e instanceof s.GservError&&e.code===s.GservError.Code.InstanceNonExistent))throw e;t=e,await u.sleep(3e3)}throw this.localPrefs.removeItem(C.StorageKey.LastConnection),t}await this.gservCon.joinGame(e,this.engineVersion,this.engineModHash)}async transferAndLoadMapFile(e,t,i,r){let s;if(e.create&&e.singlePlayer||!e.mapTransfer)s=await this.mapFileLoader.load(t,r);else{if(this.messageBoxApi.show(this.strings.get("GUI:MapTransfer")),e.create)s=await this.mapFileLoader.load(t,r),this.gservCon.sendMap(s.readAsString());else{var a=await this.gservCon.getMap();if(s=ce.VirtualFile.fromBytes(he.binaryStringToUint8Array(a),t),ue.MapDigest.compute(s)!==i)throw new Error("Transferred map is corrupt");if(this.mapDir&&!await this.mapDir.containsEntry(t))try{await this.mapDir.writeFile(s),this.mapList.addFromMapFile(s)}catch(e){console.error("Map couldn't be saved",[e])}}this.messageBoxApi.destroy()}return s}loadUi(e,t,i,r,s){var a=i.isObserver?new m.SidebarModel(e):new L.CombatantSidebarModel(i,e),n=new F.MessageList(e.rules.audioVisual.messageDuration,6,i),o=new ye.ChatHistory;let l=O.Engine.getUiIni(),c=new ee.CommandBarButtonList;i.isObserver||c.fromIni(l.getOrCreateSection(this.isSinglePlayer?"AdvancedCommandBar":"MultiplayerAdvancedCommandBar")),this.config.discordUrl&&c.buttons.push(te.CommandBarButtonType.BugReport),this.hudFactory=new x.HudFactory(r,this.uiScene,a,n,o,e.debugText,this.runtimeVars.debugText,i,e.getCombatants(),e.stalemateDetectTrait,e.countdownTimer,s,this.jsxRenderer,this.strings,c.buttons),this.disposables.add(()=>this.hudFactory=void 0);let h=this.hudFactory.create();this.hud=h;let u=this.minimap=new k.Minimap(e,i,h.getTextColor(),e.rules.general.radar);h.setMinimap(u),this.disposables.add(u,()=>this.minimap=void 0),u.setPointerEvents(this.pointer.pointerEvents);var d={width:h.sidebarWidth,height:h.actionBarHeight};let g=new f.WorldView(d,e,this.sound,this.renderer,this.runtimeVars,u,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),p=g.init(i,this.viewport.value,t);return this.worldView=g,this.disposables.add(g,()=>this.worldView=void 0),p.worldScene.create3DObject(),{worldViewInitResult:p,sidebarModel:a,messageList:n,chatHistory:o,minimap:u}}initLockstep(t,e,i,r,s){const a=this.config.debugGameState;let n,o=new h.DataStream;a&&(n=e=>{o.byteLength<10485760&&o.writeString(e+"\n")});let l=new d.LockstepManager(t,this.gservCon,this.gameOptsParser,this.gameOptsSerializer,new T.ActionSerializer,i,r,()=>{this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.handleGameError("desync_error",this.strings.get("TS:DesyncDetected"),t,a?async()=>{let i,r;try{let t=JSON.stringify(l.debugGameStateHistory,void 0,2);this.workerHostApi.queueTask(async e=>{i=await e.compressFile(t,"statedump.json")}),this.workerHostApi.queueTask(async e=>{r=await e.compressFile(new Uint8Array(o.buffer,0,o.byteLength),"lockstep.log")}),await this.workerHostApi.waitForTasks()}catch(e){console.error("Failed to export debug data",e)}finally{this.workerHostApi.dispose()}return{stateDump:i,debugLog:r}}:void 0)},this.actionLogger,n,s,a),c;return l.onLagStateChange.subscribe(e=>{this.lagState=e,c?.cancel(),c=void 0,e?(c=new W.Task(async e=>{await u.sleep(q.CON_INFO_THRESH_MILLIS,e),e.isCancelled()||this.menu?.openConnectionInfo(t.getCombatants(),this.gservCon,this.chatNetHandler)}),c.start().catch(e=>{if(!(e instanceof K.OperationCanceledError))throw e}),this.disposables.add(()=>c?.cancel())):this.menu?.getCurrentScreen()instanceof J.ConnectionInfoScreen&&this.menu.close()}),l}onViewportChange(){if(this.loadingScreenApi?.updateViewport(),this.hud){this.uiScene.remove(this.hud),this.hud.destroy();let e=this.hudFactory.create();this.hud=e,e.setMinimap(this.minimap),this.playerUi&&(this.uiScene.add(e),this.menu?.handleHudChange(e),this.worldView.handleViewportChange(this.viewport.value),this.playerUi.handleHudChange(e),this.chatTypingHandler&&this.initHudChatTypingEvents(this.chatTypingHandler,this.chatNetHandler,e))}}onGameStart(e,i,t,r,s,a,n){this.localPrefs.removeItem(C.StorageKey.LastConnection),this.loadingScreenApi?.dispose(),this.music?.play($.MusicType.Normal);var o=new E.EvaSpecs(e.country?.side??B.SideType.GDI).readIni(O.Engine.getIni("eva.ini"));let l=new p.Eva(o,this.sound,this.renderer);l.init(),this.disposables.add(l),this.initUi(e,i,n,r,s,this.hud,l,t),this.renderer.removeScene(this.uiScene),this.renderer.addScene(t.worldViewInitResult.worldScene),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),i.onEnd.subscribe(()=>this.onGameEnd(i,e,l,a)),i.start(),this.isSinglePlayer||this.initNetStats(e),this.gameAnimationLoop=new c.GameAnimationLoop(e,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!this.isSinglePlayer,onError:this.config.devMode?void 0:e=>{var t;e instanceof z.IrcConnection.SocketError||(t=e.message?.match(/memory|allocation/i)?this.strings.get("TS:GameCrashOom"):this.strings.get("TS:GameCrashed")+(i.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),this.handleGameError(e,t,i))}}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initNetStats(t){let i,e=e=>{i?.dispose(),e&&(i=new r.NetStats(this.gameTurnMgr,t,this.renderer,this.gservCon),i.init(),this.disposables.add(i))};e(this.runtimeVars.fps.value),this.runtimeVars.fps.onChange.subscribe(e),this.disposables.add(()=>{this.runtimeVars.fps.onChange.unsubscribe(e)})}initUi(i,r,s,e,t,a,n,o){let{worldViewInitResult:l,sidebarModel:c,messageList:h,chatHistory:u,minimap:d}=o;var{worldScene:g,worldSound:p,superWeaponFxHandler:m,beaconFxHandler:f,renderableManager:y}=l;let T=new A.SoundHandler(r,p,n,this.sound,r.events,h,this.strings,i);if(T.init(),this.disposables.add(T),h.onNewMessage.subscribe(e=>{e.animate&&this.sound.play(_.SoundKey.IncomingMessage,H.ChannelType.Ui)}),re.isIpad()){let e=e=>{c.topTextLeftAlign=e};this.fullScreen.onChange.subscribe(e),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(e))}this.uiScene.add(a);let v=this.menu=new I.GameMenu(this.gameMenuSubScreens,r,i,u,this.isSinglePlayer?void 0:this.gservCon,this.isSinglePlayer,this.isTournament);v.init(a),this.initGameMenuEvents(v,n,r,i,e,t),this.disposables.add(v,()=>this.menu=void 0);var b=r.getUnitSelection(),S=this.runtimeVars.freeCamera,w=this.runtimeVars.debugPaths,p=this.config.devMode,p=new M.WorldInteractionFactory(i,r,b,y,this.uiScene,g,this.pointer,this.renderer,this.keyBinds,this.generalOptions,S,w,p,document,d,this.strings,a.getTextColor());let C;this.isSinglePlayer||(E=new Z.TauntPlayback(this.sound.audioSystem,O.Engine.getTaunts()),C=new Q.TauntHandler(this.gservCon,i,r,s,this.tauntsEnabled,E,this.mutedPlayers),C.init(),this.disposables.add(C));var E=this.config.discordUrl;if(i.isObserver?this.playerUi=new P.ObserverUi(r,p,g.cameraPan,y,g,this.runtimeVars,v,this.sound,this.strings,this.messageBoxApi,E):this.playerUi=new R.CombatantUi(r,i,this.isSinglePlayer,e,t,c,this.renderer,g,T,h,this.sound,n,p,v,this.pointer,this.runtimeVars,this.speedCheat,this.strings,C,y,m,f,this.messageBoxApi,E),this.playerUi.init(a),this.disposables.add(this.playerUi,()=>this.playerUi=void 0),!this.isSinglePlayer){f=this.wolService.getConnection(),E=new Map(r.getNonNeutralPlayers().map(e=>[e.name,e.color.asHexString()])),E=new Te.ChatMessageFormat(this.strings,i.name,E);let t=new G.ChatNetHandler(this.gservCon,f,h,u,E,i,r,s,this.mutedPlayers);t.init(),this.disposables.add(t);let e=this.playerUi.worldInteraction;E=new V.ChatTypingHandler(e.keyboardHandler,e.arrowScrollHandler,h,u);e.chatTypingHandler=E,this.chatTypingHandler=E,this.chatNetHandler=t,this.disposables.add(()=>this.chatTypingHandler=this.chatNetHandler=void 0),this.initHudChatTypingEvents(E,t,a),v.onSendMessage.subscribe(e=>{e.value.length&&t.submitMessage(e.value,e.recipient)});const x=e=>{r.getPlayerByName(e).isObserver&&h.addSystemMessage(this.strings.get("TXT_LEFT_GAME",e),"grey")};this.gservCon.onPlayerDisconnect.subscribe(x),this.disposables.add(()=>this.gservCon.onPlayerDisconnect.unsubscribe(x))}}initHudChatTypingEvents(t,i,e){e.onMessageCancel.subscribe(()=>{t.endTyping()}),e.onMessageSubmit.subscribe(e=>{t.endTyping(),e.value.length&&i.submitMessage(e.value,e.recipient)})}initGameMenuEvents(e,t,i,r,s,a){e.onOpen.subscribe(()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1)}),e.onQuit.subscribe(async()=>{this.controller&&(r.isObserver||t.play("EVA_BattleControlTerminated"),this.pointer.lock(),this.pointer.setVisible(!1),this.playerUi.dispose(),r.isObserver||this.isSinglePlayer||this.lagState||(s.push(a.create(Y.ActionType.ResignGame)),await new Promise(e=>{this.gameTurnMgr.onActionsSent.subscribeOnce(()=>e())})),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.gameTurnMgr.dispose(),this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.isSinglePlayer||this.sendGameRes(i,{disconnect:!1,desync:!1,quit:!0,finished:!1}),r.isObserver||this.logGame(i,!1),await u.sleep(2e3),this.controller.goToScreen(n.ScreenType.MainMenuRoot,{route:this.returnTo}))}),e.onObserve.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0),s.push(a.create(Y.ActionType.ObserveGame)),this.disposables.add(i?.events.subscribe(X.EventType.PlayerResigned,e=>{e.target===r&&this.gameTurnMgr.setPassiveMode?.(!0)})),this.logGame(i,!1)}),e.onCancel.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0)})}async onGameEnd(e,t,i,r){var s=!t.defeated;let[a]=this.jsxRenderer.render(g.jsx(l.GameResultPopup,{type:s&&!t.isObserver?l.GameResultType.MpVictory:l.GameResultType.MpDefeat,viewport:this.viewport.value}));this.pointer.setVisible(!1),this.playerUi.dispose(),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.uiScene.add(a),t.isObserver||i.play(s?"EVA_YouAreVictorious":"EVA_YouHaveLost",!0),r.finish(e.currentTick),this.saveReplay(r),this.isSinglePlayer||this.sendGameRes(e,{disconnect:!1,desync:!1,quit:!1,finished:!e.alliances.getHostilePlayers().length}),t.isObserver||this.logGame(e,s),await u.sleep(5e3),this.uiScene.remove(a),a.destroy(),this.controller?.goToScreen(n.ScreenType.MainMenuRoot,{route:new me.MainMenuRoute(o.ScreenType.Score,{game:e,localPlayer:t,singlePlayer:this.isSinglePlayer,returnTo:this.returnTo??new me.MainMenuRoute(o.ScreenType.Home)})})}logGame(e,t){window.gtag?.("event","game_finish",{singlePlayer:Number(this.isSinglePlayer),numPlayers:e.gameOpts.humanPlayers.filter(e=>e.countryId!==pe.OBS_COUNTRY_ID).length+e.gameOpts.aiPlayers.filter(e=>!!e).length,won:Number(t),tournament:Number(this.isTournament),duration:e.currentTime})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose(),this.isSinglePlayer||(this.wolService.setAutoReconnect(!1),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close())}handleGservConError(t){if(!(t instanceof K.OperationCanceledError)){let e;if(t instanceof s.GservError&&t.code===s.GservError.Code.InstanceNonExistent)e=this.strings.get("WOL:InstanceNotFound");else if(t instanceof s.GservError&&t.code===s.GservError.Code.BadLogin)e=this.strings.get("TXT_BADPASS");else if(t instanceof s.GservError&&t.code===s.GservError.Code.AlreadyLoggedIn)e=this.strings.get("WOL:AlreadyLoggedIn");else if(t instanceof s.GservError&&t.code===s.GservError.Code.OutdatedClient)e=this.strings.get("TXT_YOURGAME_OUTDATED");else if(t instanceof s.GservError&&t.code===s.GservError.Code.TooManyLoginAttempts)e=this.strings.get("WOL:TooManyLoginAttempts");else if(t instanceof s.GservError&&t.code===s.GservError.Code.CreatedTooManyInstances)e=this.strings.get("WOL:CreatedTooManyInstances");else if(t instanceof s.GservError&&t.code===s.GservError.Code.InstanceNotAllowed)e=this.strings.get("WOL:InstanceNotAllowed");else if(t instanceof s.GservError&&t.code===s.GservError.Code.InstanceAlreadyStarted)e=this.strings.get("WOL:GameAlreadyStarted");else if(t instanceof s.GservError&&t.code===s.GservError.Code.InstanceVersMismatch)e=this.strings.get("TXT_MISMATCH");else{if(t instanceof z.IrcConnection.SocketError)return;t instanceof z.IrcConnection.ConnectError?e=this.strings.get("TS:ConnectFailed"):(e=this.strings.get("WOL:MatchBadParameters"),t instanceof s.GservError?this.sendDebugInfo(new Error("Gserv error "+t.code,{cause:t})):t instanceof z.IrcConnection.NoReplyError||this.sendDebugInfo(new Error(`Failed to connect to game instance (${t.message??t.name})`,{cause:t})))}this.handleError(t,e)}}handleMapLoadError(t,i){if(!(t instanceof K.OperationCanceledError||t instanceof z.IrcConnection.SocketError)){let e;e=t instanceof a.DownloadError?this.strings.get("TS:MapNotFound",i):("string"==typeof t?t:t.message)?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):t instanceof z.IrcConnection.NoReplyError?this.strings.get("WOL:MatchBadParameters"):this.strings.get("TXT_MAP_ERROR"),this.handleError(t,e)}}handleGameLoadError(i,r,s){if(!(i instanceof K.OperationCanceledError||i instanceof z.IrcConnection.SocketError)){let t;if(i instanceof a.DownloadError)t=this.strings.get("TS:AssetLoadError");else if(i instanceof se.IOError)t=this.strings.get("ts:storage_io_error");else{let e="string"==typeof i?i:i.message;if(e?.match(/memory|allocation/i))t=this.strings.get("TS:GameInitOom");else{t=this.strings.get("TS:GameInitError"),s.mapOfficial||(t+="\n\n"+this.strings.get("TS:CustomMapCrash"));let e=new j.Replay;e.init(r.gameId,r.timestamp,s,this.engineVersion,this.engineModHash),e.debugInfo=i instanceof Error?i.stack:i,e.finish(0),this.sendDebugInfo(new Error(`Game init failed (${"string"==typeof i?i:i.message??i.name})`,{cause:i}),{gameId:r.gameId,replay:e,map:this.debugMapFile,official:s.mapOfficial})}}this.handleError(i,t)}}handleGameError(e,t,i,r){const s=this.replay;s&&(s.name+=" (crashdump)",s.debugInfo=e instanceof Error?e.stack:e,"desync_error"===e&&(s.debugInfo+="\nConstants: "+[Math.E,Math.LN10,Math.LN2,Math.LOG10E,Math.LOG2E,Math.PI,Math.SQRT1_2,Math.SQRT2].join(",")),s.finish(i.currentTick),this.saveReplay(s)),this.handleError(e,t),this.sendDebugInfo(e,{gameId:i.id,replay:s,map:this.debugMapFile,official:i.gameOpts.mapOfficial},r),"desync_error"===e&&this.sendGameRes(i,{disconnect:!1,desync:!0,quit:!1,finished:!1})}sendDebugInfo(t,{gameId:i,replay:r,map:s,official:a}={},n){this.sentry&&!t.message?.match(/out of memory|buffer allocation/i)&&(async()=>{let e=n?await n():void 0;this.sentry.captureException(t,t=>{if(i&&t.setTag("gameId",i),t.setTag("nick",this.playerName),t.setTag("tournament",this.isTournament),e?.stateDump&&t.addAttachment({filename:"statedump.7z",data:e.stateDump}),e?.debugLog&&t.addAttachment({filename:"lockstep_log.7z",data:e.debugLog}),r)try{t.addAttachment({filename:r.name+j.Replay.extension,data:r.serialize()})}catch(e){t.setExtra("replayError",e)}return s&&(t.addAttachment({filename:s.filename,data:s.getBytes()}),t.setTag("mapName",s.filename)),void 0!==a&&t.setTag("officialMap",a),t})})().catch(e=>console.error("Failed sending error to sentry",e))}handleError(e,t){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock(),this.errorHandler.handle(e,t,()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(n.ScreenType.MainMenuRoot)})}saveReplay(t){(async()=>{try{await this.replayManager.saveReplay(t)}catch(e){e instanceof i.StorageQuotaError||e instanceof se.IOError||e instanceof ie.FileNotFoundError||e instanceof oe.ReplayStorageError||this.sendDebugInfo(e,{replay:t,gameId:this.game?.id}),console.error(e),this.toastApi.push(this.strings.get("GUI:SaveReplayError"))}})()}sendGameRes(i,r){(async()=>{if(this.wgameresUrl&&i.gameOpts.humanPlayers.find(e=>e.name===this.playerName)?.countryId!==pe.OBS_COUNTRY_ID)try{let e=(new ge.GameRes).fromGame(i,this.isTournament,this.getGameResClientInfo(r));var t=e.toBinary();this.wGameResCon.isOpen()||await this.wGameResCon.connect(this.wgameresUrl),this.wGameResCon.sendGameResPacket(t)}catch(e){console.error(e)}finally{this.wGameResCon.isOpen()&&this.wGameResCon.close()}})()}getGameResClientInfo(e){return{clientVers:this.engineVersion,avgFps:0,outOfSync:e.desync,gameSku:this.wolService.getConfig().getClientSku(),accountName:this.playerName,suddenDisconnect:e.disconnect,quit:e.quit,finished:e.finished,pingsRecv:0,pingsSent:0}}},e("GameScreen",ve)}}}),System.register("gui/screen/mainMenu/component/PrefetchProgress",["react"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("PrefetchProgress",({progress:e,statusText:t})=>i.default.createElement("div",{className:"prefetch-progress"},i.default.createElement("div",null,i.default.createElement("label",null,t),i.default.createElement("progress",{value:e,max:100}))))}}}),System.register("gui/screen/mainMenu/MainMenuRootScreen",["gui/jsx/jsx","gui/screen/mainMenu/component/MainMenu","gui/screen/mainMenu/MainMenuController","gui/screen/mainMenu/ScreenType","engine/resourceConfigs","util/disposable/CompositeDisposable","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/jsx/HtmlView","gui/screen/mainMenu/component/PrefetchProgress","@puzzl/core/lib/async/sleep","gui/screen/RootScreen"],function(e,t){"use strict";var i,r,s,a,n,u,o,l,c,h,d,g,p;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){u=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){d=e},function(e){g=e}],execute:function(){p=class extends g.RootScreen{constructor(e,t,i,r,s,a,n,o,l,c,h){super(),this.subScreens=e,this.uiScene=t,this.gameResConfig=i,this.strings=r,this.images=s,this.jsxRenderer=a,this.videoSrc=n,this.cdnResourceLoader=o,this.sound=l,this.music=c,this.sentry=h,this.prefetched=!1,this.disposables=new u.CompositeDisposable}createView(){var e;this.mainMenu=new r.MainMenu(this.uiScene.menuViewport,this.images,this.jsxRenderer,this.videoSrc),!this.prefetched&&this.gameResConfig.isCdn()&&([e]=this.jsxRenderer.render(i.jsx(c.HtmlView,{component:h.PrefetchProgress,ref:e=>this.prefetchProgressView=e,props:{progress:0,statusText:this.strings.get("TS:Preloading")}})),this.prefetchProgressEl=e,this.prefetched=!0,this.updatePrefetchProgressViewport())}createViewAndController(){return this.createView(),this.mainMenuCtrl=new s.MainMenuController(this.mainMenu,this.sound,this.music),this.mainMenuCtrl.onScreenChange.subscribe(e=>this.sentry?.addBreadcrumb({category:"ui",message:void 0!==e?"Navigated to screen "+a.ScreenType[e]:"Navigated to previous screen",level:"info"})),this.mainMenuCtrl}onViewportChange(){this.mainMenu.setViewport(this.uiScene.menuViewport),this.mainMenuCtrl?.rerenderCurrentScreen(),this.updatePrefetchProgressViewport()}onEnter(e){let t=this.createViewAndController();for(var[i,r]of this.subScreens)t.addScreen(i,r);if(this.uiScene.add(this.mainMenu),setTimeout(()=>{e?.route?t.goToScreen(e.route.screenType,e.route.params):t.goToScreen(a.ScreenType.Home)}),this.prefetchProgressEl){let t=!1,e=new o.Task(async e=>{await d.sleep(5e3,e),d.sleep(15e3,e).then(()=>{t||this.uiScene.add(this.prefetchProgressEl)}).catch(e=>{if(!(e instanceof l.OperationCanceledError))throw e}),await this.cdnResourceLoader.loadResources(n.resourcesForPrefetch,e,t=>{this.prefetchProgressView.getElement().applyOptions(e=>e.progress=t)}),t=!0,this.uiScene.remove(this.prefetchProgressEl)});e.start().catch(e=>{this.prefetchProgressEl&&this.uiScene.remove(this.prefetchProgressEl),t=!0,e instanceof l.OperationCanceledError||console.error(e)}).then(()=>e=void 0),this.disposables.add(()=>{e?.cancel(),this.prefetchProgressEl.destroy(),this.prefetchProgressEl=void 0,this.prefetchProgressView=void 0})}}updatePrefetchProgressViewport(){this.prefetchProgressEl?.getHtmlContainer()?.setSize(this.uiScene.viewport.width,0)}async onLeave(){this.mainMenuCtrl&&(this.mainMenuCtrl.toggleMainVideo(!1),await this.mainMenuCtrl.leaveCurrentScreen(),this.mainMenuCtrl.destroy(),this.mainMenuCtrl=void 0),this.uiScene.remove(this.mainMenu),this.mainMenu.destroy(),this.mainMenu=void 0,this.disposables.dispose()}},e("MainMenuRootScreen",p)}}}),System.register("network/gamestate/ReplayTurnManager",["game/Game","game/GameSpeed","network/gamestate/replay/TurnActionsReplayEvent","util/event"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("ReplayTurnManager",n=class{constructor(e,t,i,r){this.game=e,this.replay=t,this.actionFactory=i,this.actionLogger=r,this.errorState=!1,this.gameSpeedChanged=!1,this._onReplayEvent=new a.EventDispatcher,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}get onReplayEvent(){return this._onReplayEvent.asEvent()}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value),this.replayIterator=this.replay.getEvents().values(),this.nextReplayEvent=this.replayIterator.next().value}computeGameTurn(e){this.gameTurnMillis=1e3/(e*r.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(e){if(!this.errorState)if(this.game.status!==i.GameStatus.Ended){for(;this.nextReplayEvent&&this.nextReplayEvent.tickNo===this.game.currentTick;)this.nextReplayEvent instanceof s.TurnActionsReplayEvent&&this.processActions(this.nextReplayEvent.payload),this._onReplayEvent.dispatch(this,this.nextReplayEvent),this.nextReplayEvent=this.replayIterator.next().value;if(this.nextReplayEvent&&this.nextReplayEvent.tickNo<this.game.currentTick)throw new Error("Replay event desync");this.replay.endTick+1<=this.game.currentTick?this.game.status=i.GameStatus.Ended:(this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1))}else this.game.speed.value=0}processActions(e){e.forEach(([r,e])=>e.forEach(e=>{let t=this.actionFactory.create(e.id);t.player=this.game.getPlayer(r),t.unserialize(e.params),t.process();var i=t.print();i&&this.actionLogger?.debug(`(${t.player.name})@${this.game.currentTick}: `+i)}))}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}}),System.register("gui/screen/replay/ReplayScreen",["engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","tools/DevToolsApi","engine/GameAnimationLoop","util/disposable/CompositeDisposable","gui/screen/game/SoundHandler","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/ReplayTurnManager","game/action/ActionFactory","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/Music","network/gamestate/replay/ChatMessageReplayEvent","engine/sound/SoundKey","engine/sound/ChannelType","network/gamestate/replay/TauntReplayEvent","gui/screen/game/TauntPlayback","gui/screen/game/component/hud/commandBar/CommandBarButtonType","util/userAgent","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","data/MapFile","engine/ResourceLoader","engine/MapDigest","gui/chat/ChatHistory"],function(e,t){"use strict";var C,E,x,h,O,m,f,y,T,A,u,d,M,R,g,P,I,k,B,j,N,v,b,L,D,F,S,i,_,U,H,G,V,r;t&&t.id;return{setters:[function(e){C=e},function(e){E=e},function(e){x=e},function(e){h=e},function(e){O=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){A=e},function(e){u=e},function(e){d=e},function(e){M=e},function(e){R=e},function(e){g=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){v=e},function(e){b=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){S=e},function(e){i=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e}],execute:function(){r=class extends i.RootScreen{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x){super(),this.engineVersion=e,this.engineModHash=t,this.errorHandler=i,this.gameMenuSubScreens=r,this.loadingScreenApiFactory=s,this.config=a,this.strings=n,this.renderer=o,this.uiScene=l,this.runtimeVars=c,this.messageBoxApi=h,this.uiAnimationLoop=u,this.viewport=d,this.jsxRenderer=g,this.pointer=p,this.sound=m,this.music=f,this.keyBinds=y,this.generalOptions=T,this.actionLogger=v,this.fullScreen=b,this.mapFileLoader=S,this.gameLoader=w,this.vxlGeometryPool=C,this.buildingImageDataCache=E,this.leaveAction=x,this.preventUnload=!0,this.disposables=new O.CompositeDisposable}async onEnter(p){this.params=p,this.disposables.add(()=>this.params=void 0),this.pointer.lock(),this.pointer.setVisible(!1),await this.music?.play(j.MusicType.Loading);var{gameId:m,gameTimestamp:f,gameOpts:y,engineVersion:T,modHash:v}=p.replay;let e;if(T!==this.engineVersion?e=this.strings.get("GUI:ReplayVersionMismatch",T):v!==this.engineModHash&&(e=this.strings.get("GUI:ReplayModMismatch")),e)this.messageBoxApi.show(e,this.strings.get("GUI:Ok"),()=>{this.leaveAction()});else{T=this.loadingScreenApiFactory.create(_.LoadingScreenType.Replay);this.loadingScreenApi=T,this.disposables.add(T,()=>this.loadingScreenApi=void 0);let e;v=y.mapName;try{var b=await this.mapFileLoader.load(v);if(G.MapDigest.compute(b)!==y.mapDigest)return void this.handleError("Map digest mismatch",this.strings.get("TS:MapMismatch",v));var S=new U.MapFile(b);e=await this.gameLoader.load(m,f,y,S,void 0,1===y.humanPlayers.length,T)}catch(e){let t;return e.message?.match(/memory|allocation/i)?t=this.strings.get("TS:GameInitOom"):e instanceof H.DownloadError?t=this.strings.get("TS:MapNotFound",v):(t=this.strings.get("TS:GameInitError"),y.mapOfficial||(t+="\n\n"+this.strings.get("TS:CustomMapCrash"))),void this.handleError(e,t)}let{game:s,theater:t,hudSide:i,cameoFilenames:r}=e;this.game=s,this.baseSpeed=this.game.speed.value,this.disposables.add(()=>this.game=void 0),this.disposables.add(()=>{C.Engine.unloadTheater(t.type),this.gameLoader.clearStaticCaches()}),this.disposables.add(s);T=new E.SidebarModel(s,p.replay);let a=new B.MessageList(s.rules.audioVisual.messageDuration,6,void 0);v=new V.ChatHistory;this.messageList=a,this.disposables.add(()=>this.messageList=void 0);y=[F.CommandBarButtonType.ReplayRewind,F.CommandBarButtonType.ReplayPlay,F.CommandBarButtonType.ReplayPause,F.CommandBarButtonType.ReplaySpeed];this.hudFactory=new M.HudFactory(i,this.uiScene,T,a,v,s.debugText,this.runtimeVars.debugText,void 0,s.getCombatants(),s.stalemateDetectTrait,s.countdownTimer,r,this.jsxRenderer,this.strings,y),this.disposables.add(()=>this.hudFactory=void 0);let n=this.hudFactory.create();this.hud=n;let o=this.minimap=new R.Minimap(s,void 0,n.getTextColor(),s.rules.general.radar);n.setMinimap(o),this.disposables.add(o,()=>this.minimap=void 0),o.setPointerEvents(this.pointer.pointerEvents);y={width:n.sidebarWidth,height:n.actionBarHeight};let l=new A.WorldView(y,s,this.sound,this.renderer,this.runtimeVars,o,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),{worldScene:c,worldSound:h,renderableManager:u}=l.init(void 0,this.viewport.value,t);this.worldView=l,this.disposables.add(l,()=>this.worldView=void 0),c.create3DObject();y=new I.ActionFactory;(new k.ActionFactoryReg).register(y,s,void 0);let d=this.gameTurnMgr=new P.ReplayTurnManager(s,p.replay,y,this.actionLogger);this.gameTurnMgr.init();let g=new D.TauntPlayback(this.sound.audioSystem,C.Engine.getTaunts());const w=t=>{if(t instanceof N.ChatMessageReplayEvent){var i=t.payload;let e=s.getPlayer(i.playerId);var r=this.strings.get("TS:ReplayChatFrom",e.name)+" "+i.message,i=e.color.asHexString();a.addChatMessage(r,i)}else t instanceof L.TauntReplayEvent&&(r=t.payload,i=s.getPlayer(r.playerId),r=r.tauntNo,g.playTaunt(i,r).catch(e=>console.error(e)))};d.onReplayEvent.subscribe(w),this.disposables.add(()=>d.onReplayEvent.unsubscribe(w)),this.onGameStart(s,n,T,o,a,c,h,u),x.DevToolsApi.registerCommand("reset",async()=>{await this.onLeave(),await this.onEnter(p)}),x.DevToolsApi.registerVar("speed",s.desiredSpeed),this.disposables.add(()=>x.DevToolsApi.unregisterCommand("reset"),()=>x.DevToolsApi.unregisterVar("speed"))}}onViewportChange(){if(this.loadingScreenApi?.updateViewport(),this.hud){this.uiScene.remove(this.hud),this.hud.destroy();let e=this.hudFactory.create();this.hud=e,e.setMinimap(this.minimap),this.worldView&&(this.uiScene.add(e),this.menu?.handleHudChange(e),this.worldView.handleViewportChange(this.viewport.value),this.playerUi?.handleHudChange(e),this.initHudEvents(e,this.messageList))}}onGameStart(t,e,i,r,s,a,n,o){this.loadingScreenApi?.dispose(),this.music?.play(j.MusicType.Normal);var l=new d.EvaSpecs(g.SideType.GDI).readIni(C.Engine.getIni("eva.ini"));let c=new u.Eva(l,this.sound,this.renderer);c.init(),this.disposables.add(c);try{this.initUi(t,e,i,a,n,c,o,r,s)}catch(e){l=e.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError");return void this.handleError(e,l)}this.renderer.removeScene(this.uiScene),this.renderer.addScene(a),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),t.start(),this.gameAnimationLoop=new h.GameAnimationLoop(void 0,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!0,skipBudgetMillis:8,onError:this.config.devMode?void 0:e=>this.handleError(e,this.strings.get("TS:GameCrashed")+(t.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")))}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initUi(e,t,i,r,s,a,n,o,l){let c=new m.SoundHandler(e,s,a,this.sound,e.events,l,this.strings,void 0);if(c.init(),this.disposables.add(c),l.onNewMessage.subscribe(e=>{e.animate&&this.sound.play(v.SoundKey.IncomingMessage,b.ChannelType.Ui)}),S.isIpad()){let e=e=>{i.topTextLeftAlign=e};this.fullScreen.onChange.subscribe(e),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(e))}this.uiScene.add(t),this.initHudEvents(t,l);let h=this.menu=new T.GameMenu(this.gameMenuSubScreens,e,void 0,void 0,void 0,!0);h.init(t),this.initGameMenuEvents(h),this.disposables.add(h,()=>this.menu=void 0);var u=e.getUnitSelection(),d=this.runtimeVars.freeCamera,g=this.runtimeVars.debugPaths,p=this.config.devMode,g=new f.WorldInteractionFactory(void 0,e,u,n,this.uiScene,r,this.pointer,this.renderer,this.keyBinds,this.generalOptions,d,g,p,document,o,this.strings,t.getTextColor()),p=this.config.discordUrl;this.playerUi=new y.ObserverUi(e,g,r.cameraPan,n,r,this.runtimeVars,h,this.sound,this.strings,this.messageBoxApi,p),this.playerUi.init(t),this.disposables.add(this.playerUi,()=>this.playerUi=void 0)}initGameMenuEvents(e){e.onOpen.subscribe(()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1)}),e.onQuit.subscribe(async()=>{this.playerUi.dispose(),this.gameTurnMgr.dispose(),this.leaveAction()}),e.onCancel.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0)})}initHudEvents(e,i){e.onCommandBarButtonClick.subscribe(t=>{switch(this.sound.play(v.SoundKey.GenericClick,b.ChannelType.Ui),t){case F.CommandBarButtonType.ReplayRewind:(async()=>{var e=this.params;await this.onLeave(),await this.onEnter(e)})().catch(e=>console.error(e));break;case F.CommandBarButtonType.ReplayPlay:this.game.desiredSpeed.value=this.baseSpeed,this.game.speed.value===Number.EPSILON?this.gameTurnMgr.doGameTurn(performance.now()):this.game.speed.value!==this.baseSpeed&&i.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm","1x"),"grey");break;case F.CommandBarButtonType.ReplayPause:this.game.desiredSpeed.value=Number.EPSILON;break;case F.CommandBarButtonType.ReplaySpeed:this.game.speed.value===Number.EPSILON&&(this.game.desiredSpeed.value=this.baseSpeed,this.gameTurnMgr.doGameTurn(performance.now()));let e=Math.floor(this.game.desiredSpeed.value/this.baseSpeed);e=16===e?1:2*e,this.game.desiredSpeed.value=e*this.baseSpeed,i.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm",e+"x"),"grey");break;default:console.warn("Unhandled command type "+t)}})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose()}handleError(e,t){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock(),this.errorHandler.handle(e,t,()=>{this.leaveAction()})}},e("ReplayScreen",r)}}}),System.register("gui/screen/ScreenParamsMap",["gui/screen/ScreenType"],function(e,t){"use strict";t&&t.id;return{setters:[function(e){0}],execute:function(){}}}),System.register("gui/screen/RootRoute",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("RootRoute",i=class{constructor(...e){var[t,i]=e;this.screenType=t,this.params=i}})}}}),System.register("gui/screen/mainMenu/login/LoginScreen",["gui/jsx/jsx","network/WolError","gui/screen/mainMenu/login/LoginBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/sleep","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/login/ServerPings","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuRoute"],function(e,t){"use strict";var i,o,r,s,a,l,c,h,n,u,d,g,p,m;t&&t.id;return{setters:[function(e){i=e},function(e){o=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){n=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=void 0,m=class extends n.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h,u){super(),this.wolService=e,this.wladderService=t,this.strings=i,this.jsxRenderer=r,this.messageBoxApi=s,this.serverRegions=a,this.serversUrl=n,this.breakingNewsUrl=o,this.netLogger=l,this.errorHandler=c,this.localPrefs=h,this.rootController=u,this.title=this.strings.get("GUI:Login"),this.needsServerListRefresh=!1,this.handleLoginSubmit=async()=>{var e,t,i;!this.isBusy&&this.loginBoxApi&&this.controller&&(this.isBusy=!0,(e=this.selectedRegion)&&({user:t,pass:i}=this.loginBoxApi.getValues(),await this.controller.hideSidebarButtons(),await this.login(t,i,e.id)))}}async onEnter(e){this.params=e,this.formRendered=!1,this.controller.toggleMainVideo(!1),e.clearCredentials&&(p=void 0);try{await this.loadServerList()}catch(e){return void this.handleWolError(e,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0})}this.needsServerListRefresh=!1,this.serverPings=new u.ServerPings(this.serverRegions,this.wolService.getConfig(),this.netLogger),p&&this.serverRegions.isAvailable(p.regionId)?(this.isBusy=!0,this.login(p.user,p.pass,p.regionId)):(this.isBusy=!1,this.initView(!0))}async loadServerList(e){let t=!1;var i=setTimeout(async()=>{this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),t=!0},1e3);try{var r=await this.wolService.loadServerList(this.serversUrl,e);if(e?.isCancelled())return;this.serverRegions.load(r),this.selectedRegion&&(this.selectedRegion=this.serverRegions.getAll().find(e=>e.id===this.selectedRegion.id))}finally{clearTimeout(i),t&&this.messageBoxApi.destroy()}}initView(e=!1){if(this.controller){if(this.updateSidebarButtons(),this.isBusy||this.controller.showSidebarButtons(),!this.selectedRegion){var t=this.localPrefs.getItem(h.StorageKey.PreferredServerRegion),t=t&&this.serverRegions.isAvailable(t)?this.serverRegions.get(t):this.serverRegions.getFirstAvailable();let e=this.serverPings.pings;!t||e.has(t)&&void 0===e.get(t)?this.selectedRegion=void 0:this.selectedRegion=t}e&&!this.params.forceUser&&this.selectedRegion&&this.updateServers();var[t]=this.jsxRenderer.render(i.jsx(a.HtmlView,{width:"100%",height:"100%",component:r.LoginBox,props:{ref:e=>this.loginBoxApi=e,regions:this.serverRegions.getAll(),selectedRegion:this.selectedRegion,selectedUser:this.params.forceUser,pings:this.serverPings.pings,breakingNewsUrl:this.breakingNewsUrl,strings:this.strings,onRegionChange:e=>{this.selectedRegion=this.serverRegions.get(e),this.loginBox?.applyOptions(e=>e.selectedRegion=this.selectedRegion),this.updateSidebarButtons()},onRequestRegionRefresh:()=>{this.needsServerListRefresh=!0,this.updateServers()},onSubmit:this.handleLoginSubmit},innerRef:e=>this.loginBox=e}));this.controller.setMainComponent(t),this.updateSidebarButtons(),this.formRendered=!0}}updateSidebarButtons(){this.controller&&this.controller.setSidebarButtons([{label:this.strings.get("GUI:Login"),disabled:!this.selectedRegion,onClick:this.handleLoginSubmit},{label:this.strings.get("GUI:NewAccount"),disabled:!!this.params.forceUser,onClick:()=>{this.controller?.goToScreen(s.ScreenType.NewAccount,{afterLogin:this.params.afterLogin})}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(s.ScreenType.Home)}}])}updateServers(){this.isBusy||this.serversUpdateTask||(this.serverPings.pings.clear(),this.handleServerPingsUpdate(),this.serversUpdateTask=new l.Task(async e=>{if(this.formRendered||await c.sleep(500,e),this.needsServerListRefresh){this.needsServerListRefresh=!1;try{await this.loadServerList(e)}catch(e){return this.handleWolError(e,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0}),void(this.serversUpdateTask=void 0)}}this.loginBox?.applyOptions(e=>{e.selectedRegion=this.selectedRegion,e.regions=this.serverRegions.getAll()}),this.updateSidebarButtons();try{await this.serverPings.update(()=>this.handleServerPingsUpdate(),e)}finally{this.serversUpdateTask=void 0}this.handleServerPingsUpdate()}),this.serversUpdateTask.start().catch(e=>{e instanceof d.OperationCanceledError||console.error(e)}))}handleServerPingsUpdate(){if(this.loginBoxApi){var t=this.selectedRegion;let e=this.serverPings.pings;t&&e.has(t)&&void 0===e.get(t)&&(this.selectedRegion=void 0,this.loginBox?.applyOptions(e=>e.selectedRegion=void 0),this.updateSidebarButtons()),this.loginBox?.refresh()}}async login(t,r,s){if(t.match(/^[A-Za-z0-9-_]+$/)){this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0;let i=new l.Task(async e=>{await c.sleep(1e3,e),e.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))});i.start().catch(e=>{e instanceof d.OperationCanceledError||console.error(e)});var a=this.serverRegions.get(s);this.serverRegions.setSelectedRegion(s);try{await this.wolService.validateGameVersion(a)}catch(e){i.cancel(),this.messageBoxApi.destroy();let t;return t=e instanceof o.WolError&&e.code===o.WolError.Code.OutdatedClient?this.strings.get("TS:OutdatedClient"):this.strings.get("TXT_NO_SERV_LIST"),void this.handleWolError(e,t,{fatal:!1})}try{let e=[];this.wolService.isConnected()&&this.wolService.getConnection().getCurrentUser()||(e=await this.wolService.connectAndLogin({url:a.wolUrl,wolv2Ascii:a.wolv2Ascii,keepAliveInGame:a.wolKeepAliveInGame,user:t,pass:r}),this.wladderService.setUrl(a.wladderUrl),p={user:t,pass:r,regionId:s}),i.cancel(),this.messageBoxApi.destroy(),this.localPrefs.setItem(h.StorageKey.PreferredServerRegion,s);var n=this.params.afterLogin(e);n instanceof g.MainMenuRoute?this.controller?.goToScreen(n.screenType,n.params):this.rootController.goToScreen(n.screenType,n.params)}catch(e){i.cancel(),this.messageBoxApi.destroy(),e instanceof o.WolError&&e.code===o.WolError.Code.BadLogin?(this.wolService.closeWolConnection(),this.handleBadPass()):this.handleWolError(e,this.strings.get("TS:ConnectFailed"),{fatal:!1,netError:!0})}}else this.handleBadPass()}handleBadPass(){this.messageBoxApi.show(this.strings.get("TXT_BADPASS"),this.strings.get("GUI:Ok"),()=>{this.isBusy=!1,this.formRendered?(this.updateSidebarButtons(),this.controller.showSidebarButtons()):this.initView()})}handleWolError(e,t,{fatal:i,netError:r}){this.errorHandler.handle(e,t,()=>{this.isBusy=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.wolService.closeWolConnection(),i?this.controller?.goToScreen(s.ScreenType.Home):this.formRendered?(this.updateSidebarButtons(),this.controller?.showSidebarButtons()):(r&&(this.needsServerListRefresh=!0),this.initView(r))})}async onLeave(){this.loginBoxApi=null,this.loginBox=void 0,this.formRendered=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.isBusy||await this.controller.hideSidebarButtons(),this.isBusy=!1}},e("LoginScreen",m)}}}),System.register("gui/screen/mainMenu/mapSel/component/MapSel",["react","gui/component/List","gui/component/Select","gui/component/Option"],function(t,e){"use strict";var y,T,v,b,S,w;e&&e.id;return{setters:[function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e}],execute:function(){var e;(e=S=S||{}).None="",e.NameAsc="nameAsc",e.NameDesc="nameDesc",e.MaxSlotsAsc="maxSlotsAsc",e.MaxSlotsDesc="maxSlotsDesc",t("SortType",S),w=(e,t)=>{switch(t){case S.None:return e;case S.NameAsc:return e.sort((e,t)=>e.mapTitle.localeCompare(t.mapTitle));case S.NameDesc:return e.sort((e,t)=>t.mapTitle.localeCompare(e.mapTitle));case S.MaxSlotsAsc:return e.sort((e,t)=>e.maxSlots-t.maxSlots);case S.MaxSlotsDesc:return e.sort((e,t)=>t.maxSlots-e.maxSlots);default:throw new Error(`Unsupported sort type "${t}"`)}},t("MapSel",({strings:t,gameModes:e,maps:i,selectedGameMode:r,selectedMapName:s,initialSortType:a,onSelectGameMode:n,onSelectMap:o,onSelectSort:l})=>{const c=y.useRef(null),[h,u]=y.useState(i),[d,g]=y.useState(""),[p,m]=y.useState(a);y.useEffect(()=>{f()},[i,d,p]),y.useEffect(()=>{let e=setTimeout(()=>c.current?.scrollIntoView(),50);return()=>clearTimeout(e)},[i]);const f=()=>{u(w(i.filter(e=>e.mapTitle.toLowerCase().includes(d.toLowerCase())),p))};return y.default.createElement("div",{className:"map-sel-form"},y.default.createElement("div",{className:"map-sel-title"},t.get("GUI:SelectEngagement")),y.default.createElement("div",{className:"map-sel-body"},y.default.createElement("div",{className:"map-sel-game-mode"},y.default.createElement(T.List,{title:t.get("GUI:GameType"),className:"game-mode-list",tooltip:t.get("STT:ScenarioListGameType")},e.map(e=>y.default.createElement(T.ListItem,{key:e.id,selected:r===e,onClick:()=>n(e),"data-r-tooltip":t.get(e.description)},t.get(e.label))))),y.default.createElement("div",{className:"map-sel-map"},y.default.createElement(T.List,{title:y.default.createElement("div",{className:"map-list-title"},y.default.createElement("div",null,t.get("GUI:GameMap")),y.default.createElement("div",{className:"map-list-sort","data-r-tooltip":t.get("STT:SortBy")},y.default.createElement("label",null,""),y.default.createElement(v.Select,{initialValue:p,onSelect:e=>(e=>{m(e),l(e)})(e),className:"map-list-sort-select"},y.default.createElement(b.Option,{value:S.None,label:t.get("TS:SortNone")}),y.default.createElement(b.Option,{value:S.NameAsc,label:t.get("TS:SortName")+" "}),y.default.createElement(b.Option,{value:S.NameDesc,label:t.get("TS:SortName")+" "}),y.default.createElement(b.Option,{value:S.MaxSlotsAsc,label:t.get("TS:SortMaxSlots")+" "}),y.default.createElement(b.Option,{value:S.MaxSlotsDesc,label:t.get("TS:SortMaxSlots")+" "})))),className:"map-list",tooltip:t.get("STT:ScenarioListMaps")},h.map(e=>{var t=e.mapName===s;return y.default.createElement(T.ListItem,{key:e.mapName,selected:t,innerRef:t?c:null,onClick:()=>o(e.mapName,!1),onDoubleClick:()=>o(e.mapName,!0)},e.mapTitle)})),y.default.createElement("div",{className:"map-sel-search"},y.default.createElement("label",null,y.default.createElement("span",null,t.get("GUI:Search")),y.default.createElement("input",{type:"text",className:"new-message",value:d,onChange:e=>{var t=e.target.value;g(t)}}))))))})}}}),System.register("gui/screen/mainMenu/mapSel/MapSelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/mapSel/component/MapSel","gui/screen/mainMenu/lobby/MapPreviewRenderer","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuScreen","game/ini/GameModeType","LocalPrefs","data/MapFile","data/vfs/VirtualFile","engine/MapSupport","data/vfs/IOError","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","engine/Engine","util/disposable/CompositeDisposable","engine/ResourceLoader","engine/MapManifest","data/vfs/NameNotAllowedError"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,u,h,d,g,p,m,f,y,T,v,b,S,w;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){u=e},function(e){h=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e}],execute:function(){w=class extends l.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h){super(),this.strings=e,this.jsxRenderer=t,this.mapFileLoader=i,this.errorHandler=r,this.messageBoxApi=s,this.localPrefs=a,this.mapList=n,this.gameModes=o,this.mapDir=l,this.fsAccessLib=c,this.sentry=h,this.title=this.strings.get("GUI:ChooseMap"),this.disposables=new T.CompositeDisposable,this.handleSelectMap=(t,e)=>{var i=this.selectedMapName!==t;this.selectedMapName=t,this.refreshMapInfo(),i&&(this.updateMapDeferred({updatePreview:!e}),this.initSidebar()),this.form.applyOptions(e=>e.selectedMapName=t),e&&this.handleSubmit()},this.handleSelectGameMode=t=>{this.selectedGameMode=t;let i=this.computeAvailableMaps();i.find(e=>e.mapName===this.selectedMapName)||this.handleSelectMap(i[0].mapName,!1),this.refreshMapInfo(),this.form.applyOptions(e=>{e.selectedGameMode=t,e.maps=i})},this.handleSelectSort=e=>{this.localPrefs.setItem(u.StorageKey.LastSortMap,e)}}onEnter({gameOpts:t,usedSlots:e,lobbyType:i}){this.updateMapsAndModes(),this.selectedGameMode=this.availableGameModes.find(e=>e.id===t.gameMode),this.selectedMapName=t.mapName,this.lobbyType=i,this.computeUsedSlots=e,this.initSidebar(),this.initForm()}updateMapsAndModes(){let e=this.gameModes.getAll().filter(t=>this.mapList.getAll().find(e=>e.gameModes.some(e=>e.id===t.id)));var t=this.mapList.getAll().map(e=>({mapName:e.fileName,mapTitle:e.getFullMapTitle(this.strings),maxSlots:e.maxSlots,gameModes:e.gameModes}));this.availableGameModes=e.filter(e=>e.type!==c.GameModeType.Cooperative).sort((e,t)=>e.id-t.id),this.allMaps=t}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(i.jsx(r.HtmlView,{innerRef:e=>this.form=e,component:s.MapSel,props:{strings:this.strings,maps:this.computeAvailableMaps(),gameModes:this.availableGameModes,selectedMapName:this.selectedMapName,selectedGameMode:this.selectedGameMode,initialSortType:this.readInitialSort(),onSelectMap:this.handleSelectMap,onSelectGameMode:this.handleSelectGameMode,onSelectSort:this.handleSelectSort}}))[0])}readInitialSort(){let e=this.localPrefs.getItem(u.StorageKey.LastSortMap);return e&&Object.values(s.SortType).includes(e)||(e=s.SortType.None),e}initSidebar(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:UseMap"),tooltip:this.strings.get("STT:ScenarioButtonUseMap"),onClick:()=>{this.handleSubmit()}},...this.mapDir?[{label:this.strings.get("TS:ImportMap"),tooltip:this.strings.get("STT:ImportMap"),onClick:async()=>{let e=new o.CancellationTokenSource;var t=()=>e.cancel();this.disposables.add(t);try{await this.importMap(e.token)}catch(e){return void(e instanceof o.OperationCanceledError||this.handleMapImportError(e))}finally{this.disposables.remove(t)}}}]:[],{label:this.strings.get("GUI:Cancel"),tooltip:this.strings.get("STT:ScenarioButtonCancel"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}],!0),this.refreshMapInfo(),this.controller.showSidebarButtons()}async importMap(r){let s;try{var a=await this.fsAccessLib.showOpenFilePicker({types:[{description:"RA2 Map",accept:{"text/plain":y.Engine.supportedMapTypes.map(e=>"."+e)}}],excludeAcceptAllOption:!0});let e=Array.isArray(a)?a[0]:a;s=await e.getFile()}catch(e){if("AbortError"===e.name)return;if(e instanceof DOMException)throw new p.IOError(`File could not be read (${e.name})`,{cause:e});throw e}if(y.Engine.supportedMapTypes.some(e=>s.name.toLowerCase().endsWith("."+e)))if(this.mapList.getByName(s.name))await this.messageBoxApi.alert(this.strings.get("TS:ImportMapDuplicateError",s.name),this.strings.get("GUI:Ok"));else{a=await d.VirtualFile.fromRealFile(s);let e,t;try{e=new h.MapFile(a);var n=g.MapSupport.check(e,this.strings);if(n)return void await this.messageBoxApi.alert(n,this.strings.get("GUI:Ok"));t=(new b.MapManifest).fromMapFile(a,this.gameModes.getAll())}catch(e){return console.error(e),void await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok"))}if(e.unknownActionTypes.size||e.unknownEventTypes.size)if(!await this.messageBoxApi.confirm(this.strings.get("TS:MapUnsupportedTriggers"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;let i=t.gameModes;i.length?(await this.mapDir.writeFile(a),this.mapList.add(t),r.throwIfCancelled(),this.updateMapsAndModes(),this.form.applyOptions(e=>{e.gameModes=this.availableGameModes,e.maps=this.computeAvailableMaps()}),i.some(e=>this.selectedGameMode.id===e.id)||this.handleSelectGameMode(i[0]),this.handleSelectMap(a.filename,!1)):await this.messageBoxApi.alert(this.strings.get("TS:MapUnsupportedGameMode"),this.strings.get("GUI:Ok"))}else await this.messageBoxApi.alert(this.strings.get("TS:ImportMapUnsupportedType",y.Engine.supportedMapTypes.map(e=>"*."+e).join(", ")),this.strings.get("GUI:Ok"))}handleMapImportError(e){let t=this.strings,i=t.get("TS:ImportMapError");"QuotaExceededError"===e.name||e instanceof m.StorageQuotaError?i+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof S.NameNotAllowedError?i+="\n\n"+t.get("TS:FileNameError"):e instanceof p.IOError||e instanceof f.FileNotFoundError||this.sentry?.captureException(new Error("Map import failed "+(e.message??e.name),{cause:e})),this.errorHandler.handle(e,i,()=>{})}async handleSubmit(){let e=new o.CancellationTokenSource;var t=()=>e.cancel();this.disposables.add(t);try{await this.submitMap(e.token)}catch(e){if(!(e instanceof o.OperationCanceledError))throw e}finally{this.disposables.remove(t)}}async submitMap(e){let t=!1;if(this.mapFileUpdateTask){this.form.hide(),this.controller?.hideSidebarButtons(),t=!0;try{await this.mapFileUpdateTask.wait()}catch(e){return}}if(e.throwIfCancelled(),this.changedMapFile)try{var i=new h.MapFile(this.changedMapFile),r=g.MapSupport.check(i,this.strings);if(r)return void await this.messageBoxApi.alert(r,this.strings.get("GUI:Ok"))}catch(e){return console.error(e),void await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok"))}let s;s=!(this.computeUsedSlots()>this.allMaps.find(e=>e.mapName===this.selectedMapName).maxSlots)||await this.messageBoxApi.confirm(this.strings.get("GUI:EjectPlayers"),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel")),e.throwIfCancelled(),s?await this.controller?.popScreen({gameMode:this.selectedGameMode,mapName:this.selectedMapName,changedMapFile:this.changedMapFile}):t&&(this.form.show(),this.controller?.showSidebarButtons())}computeAvailableMaps(){return this.allMaps.filter(e=>e.gameModes.some(e=>e.id===this.selectedGameMode.id))}refreshMapInfo(){this.controller?.setSidebarMpText(this.strings.get(this.selectedGameMode.label)+"\n\n"+this.allMaps.find(e=>e.mapName===this.selectedMapName)?.mapTitle)}async onLeave(){this.computeUsedSlots=void 0,this.availableGameModes=void 0,this.allMaps=void 0,this.messageBoxApi.destroy(),this.form=void 0,this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=void 0,this.controller.setMainComponent(),this.disposables.dispose(),await this.controller.hideSidebarButtons()}updateMapDeferred({updatePreview:r}){this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=new n.Task(async t=>{if(this.controller){r&&this.controller.setSidebarPreview(),this.changedMapFile=void 0;let e;try{e=this.changedMapFile=await this.mapFileLoader.load(this.selectedMapName,t)}catch(e){if(e instanceof v.DownloadError)return void this.errorHandler.handle(e,this.strings.get("TXT_DOWNLOAD_FAILED"),()=>{this.controller?.popScreen()});throw e}var i;r&&!t.isCancelled()&&(i=new a.MapPreviewRenderer(this.strings).render(new h.MapFile(e),this.lobbyType,this.controller.getSidebarPreviewSize()),this.controller.setSidebarPreview(i)),this.mapFileUpdateTask=void 0}}),this.mapFileUpdateTask.start().catch(e=>{e instanceof o.OperationCanceledError||(console.error("Failed to render map preview"),console.error(e))})}},e("MapSelScreen",w)}}}),System.register("gui/screen/mainMenu/newAccount/NewAccountBox",["react"],function(e,t){"use strict";var u,i;t&&t.id;return{setters:[function(e){u=e}],execute:function(){i=({regions:e,initialRegion:t,strings:i,onRegionChange:r,onSubmit:s},a)=>{let[n,o]=u.useState(t.id),l=u.useRef(null),c=u.useRef(null),h=u.useRef(null);u.useEffect(()=>{setTimeout(()=>l.current?.focus(),50)},[]);u.useImperativeHandle(a,()=>({getValues(){return{user:l.current.value,pass:c.current.value,passMatch:c.current.value===h.current.value,regionId:n}}}));return u.default.createElement("div",{className:"login-wrapper new-account-box"},u.default.createElement("div",{className:"title"},i.get("GUI:NewAccount")),u.default.createElement("form",{onSubmit:e=>{e.preventDefault(),s()},className:"login-form login-box"},1<e.length?u.default.createElement("div",{className:"field"},u.default.createElement("label",null,i.get("TS:ServerLabel")),u.default.createElement("select",{name:"server",value:n,onChange:e=>{var t=e.target.value;o(t),r(t)}},e.map(e=>u.default.createElement("option",{value:e.id,key:e.id,disabled:!e.available},e.label)))):u.default.createElement("input",{type:"hidden",name:"server",value:n}),u.default.createElement("div",{className:"field"},u.default.createElement("label",null,i.get("GUI:Nickname")),u.default.createElement("input",{name:"user",type:"text",maxLength:15,ref:l,autoComplete:"off"})),u.default.createElement("div",{className:"field"},u.default.createElement("label",null,i.get("GUI:MinPasswordLen"))),u.default.createElement("div",{className:"field"},u.default.createElement("label",null,i.get("GUI:Password")),u.default.createElement("input",{name:"pass",type:"password",maxLength:8,ref:c,autoComplete:"off"})),u.default.createElement("div",{className:"field"},u.default.createElement("label",null,i.get("GUI:Re-enterPassword")),u.default.createElement("input",{name:"confirmPass",type:"password",maxLength:8,ref:h,autoComplete:"off"})),u.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))},e("NewAccountBox",u.forwardRef(i))}}}),System.register("gui/screen/mainMenu/newAccount/NewAccountScreen",["gui/jsx/jsx","network/WolError","gui/screen/mainMenu/newAccount/NewAccountBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","util/time","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/MainMenuRoute"],function(e,t){"use strict";var i,l,r,s,a,c,h,n,o,u,d;t&&t.id;return{setters:[function(e){i=e},function(e){l=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){c=e},function(e){h=e},function(e){n=e},function(e){o=e},function(e){u=e}],execute:function(){d=class extends o.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l){super(),this.wolService=e,this.wladderService=t,this.strings=i,this.jsxRenderer=r,this.messageBoxApi=s,this.serverRegions=a,this.errorHandler=n,this.localPrefs=o,this.rootController=l,this.title=this.strings.get("GUI:NewAccount"),this.handleSubmit=async s=>{if(!this.isBusy&&this.controller){this.isBusy=!0,await this.controller.hideSidebarButtons();let{user:e,pass:t,passMatch:i,regionId:r}=this.newAccountBox.getValues();i?8===t.length?e.match(/^[A-Za-z0-9-_]+$/)?await this.createAccount(e,t,r,s):this.handleValidationError(this.strings.get("TS:BadNickname")):this.handleValidationError(this.strings.get("TXT_PASSWORD_TOO_SHORT")):this.handleValidationError(this.strings.get("TXT_PASSWORD_VERIFY"))}}}async onEnter(e){this.controller.toggleMainVideo(!1),this.isBusy=!1;var t=this.localPrefs.getItem(n.StorageKey.PreferredServerRegion),t=t&&this.serverRegions.isAvailable(t)?this.serverRegions.get(t):this.serverRegions.getFirstAvailable();t?(this.controller.setSidebarButtons([{label:this.strings.get("GUI:Ok"),onClick:()=>this.handleSubmit(e.afterLogin)},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(s.ScreenType.Login,{afterLogin:e.afterLogin})}}]),this.controller.showSidebarButtons(),[t]=this.jsxRenderer.render(i.jsx(a.HtmlView,{width:"100%",height:"100%",component:r.NewAccountBox,props:{ref:e=>this.newAccountBox=e,strings:this.strings,regions:this.serverRegions.getAll(),initialRegion:t,onRegionChange:e=>{this.localPrefs.setItem(n.StorageKey.PreferredServerRegion,e)},onSubmit:()=>this.handleSubmit(e.afterLogin)}})),this.controller.setMainComponent(t)):this.handleWolError("No servers available",this.strings.get("gui:noserversavailable"),{fatal:!0})}async createAccount(e,t,i,r){var s=this.serverRegions.get(i);this.serverRegions.setSelectedRegion(i);let a=new c.Task(async e=>{await h.sleep(1e3),e.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))});a.start();try{await this.wolService.validateGameVersion(s)}catch(e){a.cancel(),this.messageBoxApi.destroy();let t;return t=e instanceof l.WolError&&e.code===l.WolError.Code.OutdatedClient?this.strings.get("TS:OutdatedClient"):this.strings.get("TXT_NO_SERV_LIST"),void this.handleWolError(e,t,{fatal:!1})}try{var n=await this.wolService.connectAndLogin({url:s.wolUrl,wolv2Ascii:s.wolv2Ascii,keepAliveInGame:s.wolKeepAliveInGame,user:e,pass:t});this.wladderService.setUrl(s.wladderUrl),a.cancel(),this.messageBoxApi.destroy();var o=r(n);o instanceof u.MainMenuRoute?this.controller?.goToScreen(o.screenType,o.params):this.rootController.goToScreen(o.screenType,o.params)}catch(e){a.cancel(),this.messageBoxApi.destroy(),e instanceof l.WolError&&e.code===l.WolError.Code.BadLogin?(this.wolService.closeWolConnection(),this.handleValidationError(this.strings.get("TXT_LOGIN_USED"))):this.handleWolError(e,this.strings.get("TS:ConnectFailed"),{fatal:!1})}}handleValidationError(e){this.messageBoxApi.show(e,this.strings.get("GUI:Ok"),()=>{this.isBusy=!1,this.controller?.showSidebarButtons()})}handleWolError(e,t,{fatal:i}){this.errorHandler.handle(e,t,()=>{this.isBusy=!1,this.controller&&(this.wolService.closeWolConnection(),i?this.controller.goToScreen(s.ScreenType.Home):this.controller.showSidebarButtons())})}async onLeave(){this.newAccountBox=void 0,!this.isBusy&&this.controller&&await this.controller.hideSidebarButtons(),this.isBusy=!1}},e("NewAccountScreen",d)}}}),System.register("gui/component/ButtonSelect",["react","classnames"],function(e,t){"use strict";var d,g;t&&t.id;return{setters:[function(e){d=e},function(e){g=e}],execute:function(){e("ButtonSelect",({initialValue:e,disabled:t,tooltip:i,className:r,onSelect:s,labelStyle:a,children:n})=>{let[o,l]=d.useState(()=>e),[c,h]=d.useState(()=>e);var u=d.useRef(null);d.useEffect(()=>{o!==e&&(l(e),h(o))},[e]);return d.useEffect(()=>{h(o)},[]),d.default.createElement("div",{className:g.default("button-select",{disabled:t},r),"data-r-tooltip":i,ref:u},d.default.Children.map(n,e=>{if(!e)return null;const t=e.props.value,i=e.props.value;return d.default.createElement("div",{onMouseEnter:()=>!i&&h(t),onMouseLeave:()=>c===t&&h(void 0)},d.default.cloneElement(e,{selected:t===o||t===c,labelStyle:a?.(t),onClick:()=>{var e;e=t,l(e),h(e),s(e)}}))}))})}}}),System.register("gui/screen/mainMenu/quickGame/component/QuickGameForm",["gui/component/ButtonSelect","gui/component/ColorSelect","gui/component/CountrySelect","gui/component/Option","react","gui/screen/mainMenu/lobby/component/RankIndicator"],function(e,t){"use strict";var n,o,l,c,h,u;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("QuickGameForm",t=>{let{strings:e,playerProfile:i,unrankedEnabled:r,ranked:s,onRankedChange:a}=t;return h.createElement("div",{className:"qm-form opts"},h.createElement("div",{className:"item"},h.createElement("label",null,h.createElement("span",{className:"label"},e.get("GUI:QuickMatchGameMode")),h.createElement("div",{className:"qm-game-type"},h.createElement(n.ButtonSelect,{initialValue:String(Number(s)),onSelect:e=>{a(Boolean(Number(e)))}},h.createElement(c.Option,{value:"1",label:e.get("GUI:Ranked")}),h.createElement(c.Option,{value:"0",disabled:!r,label:e.get("GUI:Unranked")})),h.createElement(n.ButtonSelect,{initialValue:"0",onSelect:()=>{}},h.createElement(c.Option,{value:"0",label:"1v1"}),h.createElement(c.Option,{value:"1",disabled:!0,label:"2v2"}),h.createElement(c.Option,{value:"2",disabled:!0,label:"3v3"}),h.createElement(c.Option,{value:"3",disabled:!0,label:"4v4"}),h.createElement(c.Option,{value:"4",disabled:!0,label:"FFA"}))))),h.createElement("div",{className:"item"},h.createElement("label",null,h.createElement("span",{className:"label"},e.get("GUI:PreferredCountry")),h.createElement(l.CountrySelect,{countryUiNames:t.countryUiNames,countryUiTooltips:t.countryUiTooltips,country:t.country,availableCountries:t.availableCountries,disabled:!1,strings:t.strings,onSelect:e=>t.onCountrySelect(e)}))),h.createElement("div",{className:"item"},h.createElement("label",null,h.createElement("span",{className:"label"},e.get("GUI:PreferredColor")),h.createElement(o.ColorSelect,{color:t.color,availableColors:t.availableColors,disabled:!1,strings:t.strings,onSelect:e=>t.onColorSelect(e)}))),h.createElement("fieldset",{className:"qm-profile"},h.createElement("legend",null,e.get("GUI:UserProfileLabel",i.name)),h.createElement("div",{className:"item"},h.createElement("span",{className:"label"},e.get("GUI:LadderWins")),h.createElement("span",{className:"value"},i.wins??e.get("GUI:UnknownStats"))),h.createElement("div",{className:"item"},h.createElement("span",{className:"label"},e.get("GUI:LadderLosses")),h.createElement("span",{className:"value"},i.losses??e.get("GUI:UnknownStats"))),h.createElement("div",{className:"item"},h.createElement("span",{className:"label"},e.get("GUI:Disconnects")),h.createElement("span",{className:"value"},i.disconnects??e.get("GUI:UnknownStats"))),h.createElement("div",{className:"item"},h.createElement("span",{className:"label"},e.get("GUI:LadderRank")),h.createElement("span",{className:"value"},i.rank??e.get("GUI:UnknownStats"),i?h.createElement(u.RankIndicator,{playerProfile:i,strings:e}):void 0)),h.createElement("div",{className:"item"},h.createElement("span",{className:"label"},e.get("GUI:LadderPoints")),h.createElement("span",{className:"value"},i.points??e.get("GUI:UnknownStats")))))})}}}),System.register("gui/screen/mainMenu/quickGame/QuickGameScreen",["@puzzl/core/lib/async/Task","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","engine/MapDigest","util/time","network/gameopt/Parser","game/gameopts/constants","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/mainMenu/MainMenuRoute","util/math","network/gameopt/Serializer","gui/screen/mainMenu/quickGame/component/QuickGameForm","LocalPrefs"],function(t,e){"use strict";var r,i,s,f,a,y,T,h,v,b,n,u,d,S,w,o,l,c,C,g;e&&e.id;return{setters:[function(e){r=e},function(e){i=e},function(e){s=e},function(e){f=e},function(e){a=e},function(e){y=e},function(e){T=e},function(e){h=e},function(e){v=e},function(e){b=e},function(e){n=e},function(e){u=e},function(e){d=e},function(e){S=e},function(e){w=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){var e;(e=C=C||{})[e.None=0]="None",e[e.Initializing=1]="Initializing",e[e.WaitingForMatch=2]="WaitingForMatch",e[e.MatchFound=3]="MatchFound",e[e.WaitingForPlayers=4]="WaitingForPlayers",e[e.WaitingForAllReady=5]="WaitingForAllReady",e[e.WaitingForStartTimer=6]="WaitingForStartTimer",e[e.WaitingForGameStart=7]="WaitingForGameStart",g=class extends a.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m){super(),this.unrankedEnabled=e,this.engineModHash=t,this.rules=i,this.wolService=r,this.wolCon=s,this.wladderService=a,this.serverRegions=n,this.mapFileLoader=o,this.mapList=l,this.rootController=c,this.messageBoxApi=h,this.jsxRenderer=u,this.strings=d,this.localPrefs=g,this.sound=p,this.errorHandler=m,this.title=this.strings.get("GUI:WolMatch"),this.musicType=f.MusicType.NormalShuffle,this.disposables=new T.CompositeDisposable,this.handleChatMessage=t=>{if(this.queueState!==C.None&&t.from===this.wolConfig.getQuickMatchBotName())if("Working"===t.text)this.queueState===C.Initializing?this.updateQueueState(C.WaitingForMatch):console.warn(`Unexpected reply "${t.text}" from match bot (qs: ${C[this.queueState]})`);else if(t.text.startsWith("Start"))this.queueState===C.WaitingForMatch?(this.updateQueueState(C.MatchFound),r=t.text.replace(/^Start /,""),this.handleBotStartMsg(r).catch(e=>this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!0}))):console.warn(`Unexpected reply "${t.text}" from match bot (qs: ${C[this.queueState]})`);else if(t.text.startsWith("Stats")&&this.queueState===C.WaitingForMatch){let e=t.text.replace(/^Stats /,"");var[i,r]=e.split(","),i=Number(i),r="-1"!==r?Number(r):void 0;this.messageBoxApi.updateText(this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type)+"\n\n\n"+this.strings.get("WOL:MatchPlayersInQueue",i)+"\n"+this.strings.get("WOL:MatchAvgWaitTime")+(void 0!==r&&r<3600?this.strings.get("WOL:MatchAvgWaitTimeMinutes",r<60?"<1":"~"+Math.ceil(r/60)):this.strings.get("WOL:MatchAvgWaitTimeUnavail")))}},this.handleJoinChannel=t=>{if(this.isHost&&t.user.name!==this.wolCon.getCurrentUser()){if([C.WaitingForPlayers,C.WaitingForAllReady,C.WaitingForStartTimer,C.WaitingForGameStart].includes(this.queueState)){if(t.channel!==this.gameChannelName)return;if(!this.gameOpts)throw new Error("Game opts should be set by now");if(!this.gameOpts.humanPlayers.find(e=>e.name===t.user.name))return void this.wolCon.kick([t.user.name],this.gameChannelName,"User does not belong to this game")}this.queueState===C.WaitingForPlayers&&(this.sendGameOpts(),this.updateQueueState(C.WaitingForAllReady))}},this.handleLeaveChannel=async t=>{if(t.user.name===this.wolCon.getCurrentUser())return t.channel!==this.gameChannelName&&t.channel!==this.quickMatchChannelName?void 0:void(this.queueState!==C.MatchFound&&(this.updateQueueState(C.None),[C.Initializing,C.WaitingForMatch].includes(this.queueState)&&this.wolCon.close()));switch(this.queueState){case C.Initializing:case C.WaitingForMatch:break;case C.WaitingForAllReady:case C.WaitingForStartTimer:case C.WaitingForGameStart:if(t.channel!==this.gameChannelName)return;if(!this.gameOpts)throw new Error("Game opts should be set by now");if(!this.gameOpts.humanPlayers.find(e=>e.name===t.user.name))return;console.log("A player left. Requeuing..."),await this.leaveQueue(),this.wolCon.isOpen()&&await this.joinQueue()}},this.handleGameOpt=async e=>{let t=e.opt[0];if(this.isHost)"A"===t&&"1"===e.opt[1]&&this.queueState===C.WaitingForAllReady&&this.updateQueueState(C.WaitingForStartTimer);else if(this.queueState===C.MatchFound){for(;!this.wolCon.isInChannel(this.gameChannelName);)if(await v.sleep(100),this.queueState!==C.MatchFound||!this.wolCon.isOpen())return;if(t.match(/^-|\d+/)){var i=e.opt,i=(new b.Parser).parseOptions(i);if(!this.gameOpts)throw new Error("Game opts should be set by now");if(i.mapDigest!==this.gameOpts.mapDigest)return this.wolService.closeWolConnection(),this.updateQueueState(C.None),void this.messageBoxApi.show(this.strings.get("GUI:JoinerNoMap",i.mapName),[{label:this.strings.get("GUI:OK"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(y.ScreenType.Home)}}]);this.wolCon.sendPlayerReady(!0),this.updateQueueState(C.WaitingForStartTimer)}}},this.handleGameStart=async r=>{if(this.queueState===C.WaitingForGameStart||this.queueState===C.WaitingForStartTimer)try{var s=this.wolCon.getCurrentUser();if(void 0===s)throw new Error("User should be logged in");var a=this.isTournament;if(void 0===a)throw new Error("Tournament flag should be set by now");var e=this.isHost;if(void 0===e)throw new Error("Host flag should be set by now");this.updateQueueState(C.None),this.wolCon.isOpen()&&this.gameChannelName&&this.wolCon.leaveChannel(this.gameChannelName);var n=new S.MainMenuRoute(y.ScreenType.Login,{afterLogin:e=>new S.MainMenuRoute(y.ScreenType.QuickGame,{forceWolReconnect:!0})});if(e){let e=this.gameOpts;if(!e)throw new Error("Game opts should be set by now");let t=this.rules.getMultiplayerCountries(),i=t.reduce((e,t)=>Math.max(t.id,e),0);e.humanPlayers=e.humanPlayers.map(e=>({...e,countryId:e.countryId>i?w.getRandomInt(0,i-1):e.countryId})),this.rootController.createGame(r.gameId,r.timestamp,s,e,!1,a,!1,n)}else this.rootController.joinGame(r.gameId,r.timestamp,s,a,!1,n)}catch(e){if(await this.leaveQueue(),!this.wolCon.isOpen())return;this.handleError(e,this.strings.get("WOL:MatchTimeout"),{fatal:!1})}},this.onWolClose=()=>{this.updateQueueState(C.None)},this.onWolConLost=e=>{this.handleError(e,this.strings.get("TXT_YOURE_DISCON"),{fatal:!0})}}async onEnter(e){this.updateQueueState(C.None);var t=this.localPrefs.getItem(c.StorageKey.LastPlayerCountry),i=this.localPrefs.getItem(c.StorageKey.LastPlayerColor),t=void 0!==t&&Number(t)<this.getAvailablePlayerCountries().length?Number(t):n.RANDOM_COUNTRY_ID,i=void 0!==i&&Number(i)<this.getAvailablePlayerColors().length?Number(i):n.RANDOM_COLOR_ID;if(this.queueOpts={type:"1v1",ranked:!0,countryId:t,colorId:i},this.playerProfile={name:this.wolCon.getCurrentUser()??""},this.prevWolV2Ascii=this.wolCon.getWolV2Ascii(),this.wolCon.setWolV2Ascii(!0),this.controller.toggleMainVideo(!1),this.wolService.isConnected()&&this.wolCon.getCurrentUser()){if(!e?.forceWolReconnect||(await this.tryWolReconnect(),this.wolCon.isOpen())){this.wolConfig=this.wolService.getConfig(),this.wolCon.onClose.subscribe(this.onWolClose),this.disposables.add(()=>this.wolCon.onClose.unsubscribe(this.onWolClose)),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.disposables.add(()=>this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost)),this.wolCon.onChatMessage.subscribe(this.handleChatMessage),this.disposables.add(()=>this.wolCon.onChatMessage.unsubscribe(this.handleChatMessage)),this.wolCon.onLeaveChannel.subscribe(this.handleLeaveChannel),this.disposables.add(()=>this.wolCon.onLeaveChannel.unsubscribe(this.handleLeaveChannel)),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.disposables.add(()=>this.wolCon.onGameStart.unsubscribe(this.handleGameStart)),this.wolCon.onJoinChannel.subscribe(this.handleJoinChannel),this.disposables.add(()=>this.wolCon.onJoinChannel.unsubscribe(this.handleJoinChannel)),this.wolCon.onGameOpt.subscribe(this.handleGameOpt),this.disposables.add(()=>this.wolCon.onGameOpt.unsubscribe(this.handleGameOpt)),this.showDefaultSidebarButtons(),this.initView();let e=new r.Task(e=>this.refreshPlayerProfile(e));e.start(),this.disposables.add(()=>e.cancel())}}else this.controller.goToScreen(y.ScreenType.Login,{afterLogin:e=>new S.MainMenuRoute(y.ScreenType.QuickGame,{})})}showDefaultSidebarButtons(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:QuickMatchPlay"),tooltip:this.strings.get("GUI:FindAGame"),onClick:()=>{this.joinQueue()}},...this.wladderService.getUrl()?[{label:this.strings.get("GUI:ViewLadder"),tooltip:this.strings.get("GUI:ViewTourLadder"),onClick:()=>{this.controller?.pushScreen(y.ScreenType.Ladder,{ladderType:this.queueOpts.type,highlightPlayer:this.playerProfile})}}]:[],...this.controller?.hasScreen(y.ScreenType.LadderRules)?[{label:this.strings.get("GUI:ViewRules"),onClick:()=>{this.controller?.pushScreen(y.ScreenType.LadderRules)}}]:[],...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(y.ScreenType.Login,{clearCredentials:!0,afterLogin:e=>new S.MainMenuRoute(y.ScreenType.QuickGame,{})})}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(y.ScreenType.Home)}}]),this.controller.showSidebarButtons()}initView(){var[e]=this.jsxRenderer.render(i.jsx(s.HtmlView,{component:l.QuickGameForm,innerRef:e=>this.form=e,props:{strings:this.strings,countryUiNames:new Map([[n.RANDOM_COUNTRY_NAME,n.RANDOM_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(e=>[e.name,e.uiName]))),countryUiTooltips:new Map([[n.RANDOM_COUNTRY_NAME,n.RANDOM_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(e=>e.uiTooltip).map(e=>[e.name,e.uiTooltip]))),availableColors:[n.RANDOM_COLOR_NAME].concat(this.getAvailablePlayerColors()),availableCountries:[n.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),color:this.getColorNameById(this.queueOpts.colorId),country:this.getCountryNameById(this.queueOpts.countryId),ranked:this.queueOpts.ranked,unrankedEnabled:this.unrankedEnabled&&this.wolConfig.hasUnrankedQuickMatch(),playerProfile:this.playerProfile,onCountrySelect:t=>{var e=this.getCountryIdByName(t);this.queueOpts.countryId=e,this.form?.applyOptions(e=>{e.country=t}),e!==n.RANDOM_COUNTRY_ID?this.localPrefs.setItem(c.StorageKey.LastPlayerCountry,String(e)):this.localPrefs.removeItem(c.StorageKey.LastPlayerCountry)},onColorSelect:t=>{var e=this.getColorIdByName(t);this.queueOpts.colorId=e,this.form?.applyOptions(e=>{e.color=t}),e!==n.RANDOM_COLOR_ID?this.localPrefs.setItem(c.StorageKey.LastPlayerColor,String(e)):this.localPrefs.removeItem(c.StorageKey.LastPlayerColor)},onRankedChange:t=>{this.queueOpts.ranked=t,this.form?.applyOptions(e=>e.ranked=t)}}}));this.controller.setMainComponent(e)}async refreshPlayerProfile(e){if(this.wladderService.getUrl()){var t=this.wolCon.getCurrentUser();if(t)try{var[i]=await this.wladderService.listSearch([t],e);if(e.isCancelled())return;this.playerProfile=i,this.form?.applyOptions(e=>e.playerProfile=this.playerProfile)}catch(e){console.error(e)}}}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(e=>e.name)}getCountryNameById(e){let t;return t=e===n.RANDOM_COUNTRY_ID?n.RANDOM_COUNTRY_NAME:this.getAvailablePlayerCountries()[e],t}getCountryIdByName(t){let i;if(t===n.RANDOM_COUNTRY_NAME)i=n.RANDOM_COUNTRY_ID;else{let e=this.getAvailablePlayerCountries();i=e.indexOf(t)}return i}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(e=>e.asHexString())}getColorNameById(e){let t;return t=e===n.RANDOM_COLOR_ID?n.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[e],t}getColorIdByName(t){let i;if(t===n.RANDOM_COLOR_NAME)i=n.RANDOM_COLOR_ID;else{let e=this.getAvailablePlayerColors();if(i=e.indexOf(t),-1===i)throw new Error(`Color ${t} not found in available player colors`)}return i}async joinQueue(){this.isHost=void 0,this.isTournament=void 0,this.gameOpts=void 0,this.quickMatchChannelName=void 0,this.gameChannelName=void 0,this.messageBoxApi.show(this.strings.get("WOL:RequestingMatch")+"...",[{label:this.strings.get("GUI:Cancel"),onClick:()=>{this.leaveQueue()}}]),this.updateQueueState(C.Initializing);try{var e=`#Lob ${this.wolConfig.getQuickMatchChannelId(this.queueOpts.ranked)} 0`;if(await this.wolCon.joinChannel(e,this.wolConfig.getGlobalChannelPass()),this.queueState!==C.Initializing)return;this.quickMatchChannelName=e;var{countryId:t,colorId:i}=this.queueOpts,r=`Match COU=${t}, COL=`+i;this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],r)}catch(e){return void this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!0})}}async leaveQueue(){this.queueState!==C.None&&(this.updateQueueState(C.None),this.messageBoxApi.destroy(),this.wolCon.isOpen()&&await this.tryWolReconnect())}async tryWolReconnect(){try{await this.wolService.forceReconnect(),this.wolCon.setWolV2Ascii(!0)}catch(e){this.wolService.closeWolConnection(),this.handleError(e,this.strings.get("TXT_YOURE_DISCON"),{fatal:!0})}}updateQueueState(t){if(this.queueState=t,this.gameStartTimeoutId&&(clearTimeout(this.gameStartTimeoutId),this.gameStartTimeoutId=void 0),this.countdownIntervalId&&(clearInterval(this.countdownIntervalId),this.countdownIntervalId=void 0),this.updateStatsIntervalId&&(clearInterval(this.updateStatsIntervalId),this.updateStatsIntervalId=void 0),t!==C.None){[C.WaitingForAllReady,C.WaitingForGameStart,C.WaitingForPlayers].includes(t)&&(this.gameStartTimeoutId=setTimeout(async()=>{console.log("Timed out. Rejoining queue..."),await this.leaveQueue(),this.wolCon.isOpen()&&this.joinQueue()},1e4)),t===C.WaitingForStartTimer&&(this.countdownSeconds=10,this.countdownIntervalId=setInterval(()=>this.tickStartTimer(),1e3)),t!==C.WaitingForMatch||this.wolConfig.getWolV2Compat()||(this.updateStatsIntervalId=setInterval(()=>this.requestStats(),5e3));let e;switch(t){case C.WaitingForMatch:e=this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type);break;case C.MatchFound:e=this.strings.get("GUI:MatchFound");break;case C.WaitingForPlayers:e=this.strings.get("WOL:MatchWaitingForPlayers")+"...";break;case C.WaitingForStartTimer:e=this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds);break;case C.WaitingForGameStart:e=this.strings.get("WOL:MatchGameStarting");break;case C.WaitingForAllReady:}void 0!==e&&(this.messageBoxApi.updateText(e),console.log(e))}}async tickStartTimer(){if(void 0===this.countdownSeconds)throw new Error("Game start countdown should be set by now");if(0<this.countdownSeconds)this.countdownSeconds--,this.messageBoxApi.updateText(this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds)),this.sound.play(u.SoundKey.QuickMatchTimer,d.ChannelType.Ui);else{if(this.updateQueueState(C.WaitingForGameStart),void 0===this.isHost)throw new Error("Host should be set by now");if(this.isHost)try{let e=this.gameOpts;if(!e)throw new Error("Game opts should be set by now");this.wolCon.startGame(e.humanPlayers.map(e=>e.name))}catch(e){return(await this.leaveQueue(),this.wolCon.isOpen())?void this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!1}):void 0}}}requestStats(){this.queueState===C.WaitingForMatch&&this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],"Stats")}async handleBotStartMsg(r){if(this.queueState===C.MatchFound){if(!this.quickMatchChannelName)throw new Error("Quick match channel name should be set by now");this.wolCon.leaveChannel(this.quickMatchChannelName);let t=(new b.Parser).parseOptions(r);var s=t.mapName;let i=t.humanPlayers[0].name;t.aiPlayers.length||(t.aiPlayers=new Array(7).fill(void 0));var a=this.wolCon.getCurrentUser()===i,n=this.queueOpts.ranked;const c=this.mapList.getByName(s);let e;try{if(!c)throw new Error(`Map "${s}" not found`);e=await this.mapFileLoader.load(c.fileName)}catch(e){return void this.handleError(e,this.strings.get("TS:MapNotFound",s),{fatal:!0})}if(this.queueState===C.MatchFound){this.isTournament=n,this.isHost=a,this.gameOpts={...t,gameMode:c.gameModes.some(e=>e.id===t.gameMode)?t.gameMode:c.gameModes[0].id,mapName:c.fileName,mapDigest:h.MapDigest.compute(e),mapSizeBytes:e.getSize(),mapTitle:c.getFullMapTitle(this.strings),maxSlots:c.maxSlots,mapOfficial:c.official},this.sound.play(u.SoundKey.PlayerJoined,d.ChannelType.Ui);var o=this.wolConfig.getQuickMatchChannelId(n);if(console.log("Matched with: "+(a?t.humanPlayers.slice(1).map(e=>e.name).join(", "):i)),a){console.log("Creating WOL game..."),this.messageBoxApi.updateText(this.strings.get("WOL:MatchCreatingGame"));try{this.gameChannelName=await this.wolCon.createGame(1,2,o,n)}catch(e){return(await this.leaveQueue(),this.wolCon.isOpen())?void this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!1}):void 0}this.queueState===C.MatchFound&&(this.wolCon.sendGameTopic(1,2,0,0,!1,s,this.engineModHash,""),this.updateQueueState(C.WaitingForPlayers))}else{console.log(`Looking for game hosted by "${i}"...`),this.messageBoxApi.updateText(this.strings.get("WOL:MatchJoiningGame"));try{let t=3;for(;0<t--;){let e=await this.wolCon.listGames(this.wolConfig.getClientChannelType(),o);if(this.queueState!==C.MatchFound)return;var l=e.find(e=>e.hostName===i);if(l){if(this.engineModHash!==l.modHash)return this.leaveQueue(),void this.messageBoxApi.show(this.strings.get("TXT_MISMATCH"),[{label:this.strings.get("GUI:OK"),onClick:()=>{this.wolCon.isOpen()&&this.joinQueue()}}]);if(console.log(`Joining game channel "${l.name}"...`),await this.wolCon.joinGame(l.name),this.gameChannelName=l.name,this.queueState!==C.MatchFound)return;break}if(console.log("Game not found. Retries left = "+t),await v.sleep(3e3),this.queueState!==C.MatchFound)return}if(-1===t)return await this.leaveQueue(),this.wolCon.isOpen()?void await this.joinQueue():void 0}catch(e){return(await this.leaveQueue(),this.wolCon.isOpen())?void this.handleError(e,this.strings.get("WOL:MatchErrorJoiningGame"),{fatal:!1}):void 0}}}}}sendGameOpts(){if(!this.isHost)throw new Error("Only host can send game opts");if(!this.gameOpts)throw new Error("Game opts should be set by now");var e=(new o.Serializer).serializeOptions(this.gameOpts);this.wolCon.sendGameOpts(e)}async onUnstack(){this.showDefaultSidebarButtons(),this.initView()}async onStack(){await this.unrender()}async onLeave(){this.updateQueueState(C.None),this.messageBoxApi.destroy(),this.gameOpts=void 0,this.wolCon.setWolV2Ascii(this.prevWolV2Ascii),this.disposables.dispose(),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.form=void 0}handleError(e,t,{fatal:i}){this.updateQueueState(C.None),this.errorHandler.handle(e,t,()=>{i&&(this.wolService.closeWolConnection(),this.controller?.goToScreen(y.ScreenType.Home))})}},t("QuickGameScreen",g)}}}),System.register("gui/screen/mainMenu/score/ScoreTable",["game/gameopts/constants","gui/component/CountryIcon","react","util/format","gui/screen/mainMenu/lobby/component/RankIndicator"],function(e,t){"use strict";var s,a,n,o,l;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){e("ScoreTable",({game:e,playerProfiles:i,strings:r})=>{const t=e.getNonNeutralPlayers().filter(e=>!e.isObserver||e.defeated).sort((e,t)=>t.score-e.score);return n.default.createElement("div",{className:"score-wrapper"},n.default.createElement("div",{className:"score-header"},n.default.createElement("div",{"data-r-tooltip":r.get("STT:MPScoreLabelGame")},r.get("TXT_GAME",e.id)),n.default.createElement("div",{"data-r-tooltip":r.get("STT:MPScoreLabelMapName")},r.get("TXT_MAP",e.gameOpts.mapTitle)),n.default.createElement("div",{"data-r-tooltip":r.get("STT:MPScoreLabelTime")},r.get("GUI:Time"),": ",o.formatTimeDuration(Math.floor(e.currentTime/1e3)))),n.default.createElement("table",null,n.default.createElement("thead",null,n.default.createElement("tr",null,n.default.createElement("th",null),n.default.createElement("th",{className:"player-rank"}),n.default.createElement("th",{className:"player-name","data-r-tooltip":r.get("STT:MPScoreLabelPlayer")},r.get("GUI:Player")),n.default.createElement("th",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelKills")},r.get("GUI:Kills")),n.default.createElement("th",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelLosses")},r.get("GUI:Losses")),n.default.createElement("th",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelBuilt")},r.get("GUI:Built")),n.default.createElement("th",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelScore")},r.get("GUI:Score")))),n.default.createElement("tbody",null,t.map((t,e)=>n.default.createElement("tr",{key:e,style:{color:t.color.asHexString()}},n.default.createElement("td",null,n.default.createElement(a.CountryIcon,{country:t.country.name})),n.default.createElement("td",{className:"player-rank"},(()=>{var e=i?.find(e=>e.name===t.name);return e&&n.default.createElement(l.RankIndicator,{playerProfile:e,strings:r})})()),n.default.createElement("td",{className:"player-name","data-r-tooltip":r.get("STT:MPScoreLabelPlayer")},t.isAi?r.get(s.aiUiNames.get(t.aiDifficulty)):t.name),n.default.createElement("td",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelKills")},t.getUnitsKilled()),n.default.createElement("td",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelLosses")},t.getUnitsLost()),n.default.createElement("td",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelBuilt")},t.getUnitsBuilt()),n.default.createElement("td",{className:"number","data-r-tooltip":r.get("STT:MPScoreLabelScore")},t.score))))))})}}}),System.register("gui/screen/mainMenu/score/ScoreScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/score/ScoreTable","game/SideType","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","LocalPrefs","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError"],function(e,t){"use strict";var a,n,o,l,c,i,r,s,h,u,d;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){i=e},function(e){r=e},function(e){s=e},function(e){h=e}],execute:function(){u=new Map([[l.SideType.GDI,{img:"mpascrnl.shp",pal:"mpascrn.pal"}],[l.SideType.Nod,{img:"mpsscrnl.shp",pal:"mpsscrn.pal"}]]),d=class extends i.MainMenuScreen{constructor(e,t,i,r,s,a){super(),this.strings=e,this.jsxRenderer=t,this.messageBoxApi=i,this.localPrefs=r,this.config=s,this.wladderService=a,this.musicType=c.MusicType.Score}async onEnter(e){this.title=e.singlePlayer?this.strings.get("GUI:SkirmishScore"):this.strings.get("GUI:MultiplayerScore"),this.controller.toggleMainVideo(!1),this.initView(e.game,e.localPlayer,e.returnTo),e.singlePlayer||this.refreshPlayerRanks(e.game)}initView(e,t,i){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Continue"),tooltip:this.strings.get("STT:MPScoreButtonContinue"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(i.screenType,i.params)}}]),this.controller.showSidebarButtons();var r=t.country?.side??l.SideType.GDI,s=u.get(r);if(!s)throw new Error("Unsupported sideType "+r);var[s]=this.jsxRenderer.render(a.jsx("container",{width:"100%",height:"100%"},a.jsx("sprite",{image:s.img,palette:s.pal}),a.jsx(n.HtmlView,{width:"100%",height:"100%",component:o.ScoreTable,innerRef:e=>this.scoreTable=e,props:{game:e,strings:this.strings}})));this.controller.setMainComponent(s)}refreshPlayerRanks(t){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let e=this.ranksUpdateTask=new s.Task(async e=>{var i=t.getNonNeutralPlayers().filter(e=>(!e.isObserver||e.defeated)&&!e.isAi).map(e=>e.name);if(i.length){let t=await this.wladderService.listSearch(i,e);e.isCancelled()||this.scoreTable.applyOptions(e=>e.playerProfiles=t)}});e.start().catch(e=>{e instanceof h.OperationCanceledError||console.error(e)})}}async onLeave(){this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),await this.controller.hideSidebarButtons();var e,t,i=this.config.donateUrl;i&&(2<=(t=Number(this.localPrefs.getItem(r.StorageKey.DonateBoxState)??"0"))?((e=await this.messageBoxApi.confirm(this.strings.get("TS:DonatePrompt"),this.strings.get("TS:DonateNow"),this.strings.get("TS:DonateLater")))&&window.open(i,"_blank"),this.localPrefs.setItem(r.StorageKey.DonateBoxState,"-"+Date.now()),window.gtag?.("event","donate_dismiss",{donate:e})):0<=t?this.localPrefs.setItem(r.StorageKey.DonateBoxState,String(t+1)):(t=-t,2592e6<Date.now()-t&&this.localPrefs.setItem(r.StorageKey.DonateBoxState,"0")))}},e("ScoreScreen",d)}}}),System.register("gui/screen/mainMenu/ScreenParamsMap",["gui/screen/mainMenu/ScreenType"],function(e,t){"use strict";t&&t.id;return{setters:[function(e){0}],execute:function(){}}}),System.register("gui/screen/mainMenu/MainMenuRoute",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("MainMenuRoute",i=class{constructor(...e){var[t,i]=e;this.screenType=t,this.params=i}})}}}),System.register("gui/screen/RootController",["gui/screen/Controller","gui/screen/ScreenType"],function(e,t){"use strict";var i,l,r;t&&t.id;return{setters:[function(e){i=e},function(e){l=e}],execute:function(){r=class extends i.Controller{constructor(e){super(),this.serverRegions=e}async goToScreenBlocking(...e){var[t,i]=e;return super.goToScreenBlocking(t,i)}goToScreen(...e){var[t,i]=e;return super.goToScreen(t,i)}async pushScreen(...e){var[t,i]=e;return super.pushScreen(t,i)}createGame(e,t,i,r,s,a,n=!1,o){if(!this.serverRegions)throw new Error("Server regions must be loaded first");this.goToScreen(l.ScreenType.Game,{create:!0,gameId:Number(e+""+String(t).substr(-3)),timestamp:t,playerName:i,gameOpts:r,singlePlayer:s,tournament:a,mapTransfer:n,gservUrl:s?"":this.serverRegions.getSelectedRegion().gservUrl,wgameresUrl:s?"":this.serverRegions.getSelectedRegion().wgameresUrl,returnTo:o})}joinGame(e,t,i,r,s=!1,a){if(!this.serverRegions)throw new Error("Server regions must be loaded first");this.goToScreen(l.ScreenType.Game,{create:!1,gameId:Number(e+""+String(t).substr(-3)),timestamp:t,playerName:i,tournament:r,mapTransfer:s,gservUrl:this.serverRegions.getSelectedRegion().gservUrl,wgameresUrl:this.serverRegions.getSelectedRegion().wgameresUrl,returnTo:a})}},e("RootController",r)}}}),System.register("gui/replay/ReplayStorageMemStorage",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){e("ReplayStorageMemStorage",i=class{constructor(){this.replays=new Map}async getManifest(){return this.manifest?JSON.parse(this.manifest):[]}async saveManifest(e){this.manifest=JSON.stringify(e)}async getReplayData(e){var t=this.replays.get(e.id);if(!t)throw new Error(`Replay "${e.id}" not found in memory`);return t}async hasReplayData(e){return this.replays.has(e.id)}async saveReplayData(e,t){this.replays.set(e.id,t)}async deleteReplayData(e){this.replays.delete(e.id)}})}}}),System.register("gui/screen/mainMenu/main/HomeScreen",["gui/screen/mainMenu/ScreenType","gui/FullScreen","engine/sound/Music","gui/screen/options/component/getHumanReadableKey","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/MainMenuRoute"],function(e,t){"use strict";var i,r,a,s,n,o,l;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){a=e},function(e){s=e},function(e){n=e},function(e){o=e}],execute:function(){l=class extends n.MainMenuScreen{constructor(e,t,i,r,s){super(),this.strings=e,this.fullScreen=t,this.appVersion=i,this.storageEnabled=r,this.quickMatchEnabled=s,this.title=this.strings.get("GUI:MainMenu"),this.musicType=a.MusicType.Intro}onEnter(){let e=this.strings;this.controller.setSidebarButtons([{label:e.get("GUI:QuickMatch"),tooltip:e.get("STT:WOLWelcomeQuickMatch"),disabled:!this.quickMatchEnabled,onClick:()=>{this.controller?.goToScreen(i.ScreenType.Login,{afterLogin:e=>new o.MainMenuRoute(i.ScreenType.QuickGame,{})})}},{label:e.get("GUI:CustomMatch"),tooltip:e.get("STT:WOLWelcomeCustomMatch"),onClick:()=>{this.controller?.goToScreen(i.ScreenType.Login,{afterLogin:e=>new o.MainMenuRoute(i.ScreenType.CustomGame,{messages:e})})}},{label:e.get("GUI:Demo"),tooltip:e.get("STT:Demo"),onClick:()=>{this.controller?.goToScreen(i.ScreenType.Skirmish)}},{label:e.get("GUI:Replays"),tooltip:e.get("STT:Replays"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.ReplaySelection)}},...this.storageEnabled?[{label:e.get("GUI:Mods"),tooltip:e.get("STT:Mods"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.ModSelection)}}]:[],{label:e.get("TS:InfoAndCredits"),tooltip:e.get("STT:InfoAndCredits"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.InfoAndCredits)}},{label:e.get("GUI:Options"),tooltip:e.get("STT:MainButtonOptions"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.Options)}},{label:e.get("GUI:Fullscreen",s.getHumanReadableKey(r.FullScreen.hotKey)),tooltip:e.get("STT:Fullscreen"),isBottom:!0,onClick:()=>this.fullScreen.toggle()}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.showVersion(this.appVersion)}async onLeave(){this.controller.hideVersion(),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("HomeScreen",l)}}}),System.register("gui/screen/mainMenu/lobby/SkirmishScreen",["@puzzl/core/lib/async/Task","network/gameopt/SlotInfo","game/gameopts/GameOpts","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","LocalPrefs","util/typeGuard","gui/screen/mainMenu/lobby/PreferredHostOpts","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","gui/screen/mainMenu/MainMenuRoute","engine/sound/Music"],function(e,t){"use strict";var i,d,g,p,r,n,s,u,a,o,l,c,h,m,f,y,T,v,b,S,w,C,E;t&&t.id;return{setters:[function(e){i=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){r=e},function(e){n=e},function(e){s=e},function(e){u=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){E=class extends v.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h){super(),this.botsEnabled=e,this.rootController=t,this.errorHandler=i,this.messageBoxApi=r,this.strings=s,this.rules=a,this.jsxRenderer=n,this.mapFileLoader=o,this.mapList=l,this.gameModes=c,this.localPrefs=h,this.title=this.strings.get("GUI:SkirmishGame"),this.musicType=C.MusicType.Intro,this.playerName="Player 1",this.disposables=new u.CompositeDisposable}onEnter(){this.controller.toggleMainVideo(!1),this.lobbyForm=void 0,this.initFormModel(),this.createGame()}async createGame(){try{await this.initOptions()}catch(e){return void this.handleError(e,e instanceof l.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchErrorCreatingGame"))}this.updateMapPreview(),this.updateFormModel(),this.controller.toggleSidebarPreview(!0),this.initView()}onViewportChange(){}onUnstack(a){if(a){let t=a.gameMode.id!==this.gameOpts.gameMode;this.gameOpts.gameMode=a.gameMode.id;let i=this.mapList.getByName(a.mapName),r=a.changedMapFile??this.currentMapFile;this.currentMapFile=r;var n=m.findIndexReverse(this.slotsInfo,e=>e.type===d.SlotType.Ai||e.type===d.SlotType.Player||e.type===d.SlotType.Open),o=Math.max(0,n+1-i.maxSlots);for(let e=0;e<o;e++)this.slotsInfo[n-e].type=d.SlotType.Closed,this.gameOpts.aiPlayers[n-e]=void 0;let s=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach(e=>{e&&(e.startPos>i.maxSlots-1&&(e.startPos=p.RANDOM_START_POS),t&&(e.teamId=s.alliesAllowed&&s.mustAlly?0:p.NO_TEAM_ID))}),this.applyGameOption(e=>{e.mapName=i.fileName,e.mapDigest=S.MapDigest.compute(r),e.mapSizeBytes=r.getSize(),e.mapTitle=i.getFullMapTitle(this.strings),e.maxSlots=i.maxSlots,e.mapOfficial=i.official}),this.localPrefs.setItem(f.StorageKey.LastMap,i.fileName),this.localPrefs.setItem(f.StorageKey.LastMode,String(a.gameMode.id))}this.updateMapPreview(),this.initView()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons()}async initOptions(){var e=this.localPrefs.getItem(f.StorageKey.PreferredGameOpts),t=this.localPrefs.getItem(f.StorageKey.LastPlayerCountry),i=this.localPrefs.getItem(f.StorageKey.LastPlayerColor),r=this.localPrefs.getItem(f.StorageKey.LastMap),s=this.localPrefs.getItem(f.StorageKey.LastMode);let a=r?this.mapList.getByName(r):void 0,n=a&&s&&this.gameModes.hasId(Number(s))?Number(s):1,o=this.gameModes.getById(n),l;l=a?.gameModes.find(e=>e.mapFilter===o.mapFilter)?a:(n=1,o=this.gameModes.getById(n),this.mapList.getAll().find(e=>e.gameModes.find(e=>o.mapFilter===e.mapFilter)));let c=this.currentMapFile=await this.mapFileLoader.load(l.fileName),h=new T.PreferredHostOpts;e?h.unserialize(e):h.applyMpDialogSettings(this.rules.mpDialogSettings);s=o.mpDialogSettings,e=this.botsEnabled?g.AiDifficulty.Medium:g.AiDifficulty.Easy;this.gameOpts={gameMode:n,shortGame:h.shortGame,mcvRepacks:h.mcvRepacks,cratesAppear:h.cratesAppear,superWeapons:h.superWeapons,gameSpeed:h.gameSpeed,credits:h.credits,unitCount:h.unitCount,buildOffAlly:h.buildOffAlly,humanPlayers:[{name:this.playerName,countryId:void 0!==t&&Number(t)<this.getAvailablePlayerCountries().length?Number(t):p.RANDOM_COUNTRY_ID,colorId:void 0!==i&&Number(i)<this.getAvailablePlayerColors().length?Number(i):p.RANDOM_COLOR_ID,startPos:p.RANDOM_START_POS,teamId:s.mustAlly?0:p.NO_TEAM_ID}],aiPlayers:[void 0,{countryId:p.RANDOM_COUNTRY_ID,colorId:p.RANDOM_COLOR_ID,startPos:p.RANDOM_START_POS,teamId:s.mustAlly?3:p.NO_TEAM_ID,difficulty:e},...new Array(7).fill(void 0)],mapName:l.fileName,mapDigest:S.MapDigest.compute(c),mapSizeBytes:c.getSize(),mapTitle:l.getFullMapTitle(this.strings),maxSlots:l.maxSlots,mapOfficial:l.official},this.slotsInfo=[{type:d.SlotType.Player,name:this.playerName},{type:d.SlotType.Ai,difficulty:e}];for(let u=1;u<7;++u)this.slotsInfo.push({type:d.SlotType.Closed})}handleError(e,t){this.errorHandler.handle(e,t,()=>{this.controller?.goToScreen(s.ScreenType.Home)})}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(e=>e.name)}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(e=>e.asHexString())}getAvailableStartPositions(){return new Array(this.gameOpts?.maxSlots??8).fill(0).map((e,t)=>t)}getSelectablePlayerColors(){let t=[];this.formModel&&this.formModel.playerSlots.forEach(e=>{e&&t.push(e.color)});let e=this.getAvailablePlayerColors();return[p.RANDOM_COLOR_NAME].concat(e.filter(e=>e&&-1===t.indexOf(e)))}getSelectableStartPositions(){let t=[];this.formModel&&this.formModel.playerSlots.forEach(e=>{e&&t.push(e.startPos)});let e=this.getAvailableStartPositions();return[p.RANDOM_START_POS].concat(e.filter(e=>!t.includes(e)))}initFormModel(){var e=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[p.RANDOM_COUNTRY_NAME,p.RANDOM_COUNTRY_UI_NAME],[p.OBS_COUNTRY_NAME,p.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(e=>[e.name,e.uiName]))),countryUiTooltips:new Map([[p.RANDOM_COUNTRY_NAME,p.RANDOM_COUNTRY_UI_TOOLTIP],[p.OBS_COUNTRY_NAME,p.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(e=>e.uiTooltip).map(e=>[e.name,e.uiTooltip]))),availablePlayerCountries:[p.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:this.getSelectablePlayerColors(),availableStartPositions:this.getSelectableStartPositions(),availableAiNames:this.botsEnabled?p.aiUiNames:new Map([...p.aiUiNames.entries()].filter(([e])=>e!==g.AiDifficulty.Medium)),lobbyType:n.LobbyType.Singleplayer,mpDialogSettings:e,onCountrySelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(e),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel()},onColorSelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(e),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel()},onStartPosSelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),e,this.formModel.playerSlots[t].team,t)},onTeamSelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,e,t)},onSlotChange:(e,t,i)=>{this.changeSlotType(e,t,i)},onToggleShortGame:t=>this.applyGameOption(e=>e.shortGame=t),onToggleMcvRepacks:t=>this.applyGameOption(e=>e.mcvRepacks=t),onToggleCratesAppear:t=>this.applyGameOption(e=>e.cratesAppear=t),onToggleSuperWeapons:t=>this.applyGameOption(e=>e.superWeapons=t),onToggleBuildOffAlly:t=>this.applyGameOption(e=>e.buildOffAlly=t),onChangeGameSpeed:t=>this.applyGameOption(e=>e.gameSpeed=t),onChangeCredits:t=>this.applyGameOption(e=>e.credits=t),onChangeUnitCount:t=>this.applyGameOption(e=>e.unitCount=t),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,gameSpeed:6,credits:e.money,unitCount:e.unitCount}}applyGameOption(e){e(this.gameOpts),this.updateFormModel(),this.localPrefs.setItem(f.StorageKey.PreferredGameOpts,(new T.PreferredHostOpts).applyGameOpts(this.gameOpts).serialize())}changeSlotType(e,t,i){if(0===t)throw new Error("Change slot type of host");if(e===n.SlotOccupation.Occupied&&void 0!==i){var r=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;let e=this.slotsInfo[t];e.type=d.SlotType.Ai,e.difficulty=i,this.gameOpts.aiPlayers[t]={difficulty:i,countryId:p.RANDOM_COUNTRY_ID,colorId:p.RANDOM_COLOR_ID,startPos:p.RANDOM_START_POS,teamId:r.mustAlly?3:p.NO_TEAM_ID}}e===n.SlotOccupation.Closed&&(this.slotsInfo[t].type=d.SlotType.Closed,this.gameOpts.aiPlayers[t]=void 0),this.updateFormModel()}getCountryNameById(e){let t;return t=e===p.RANDOM_COUNTRY_ID?p.RANDOM_COUNTRY_NAME:e===p.OBS_COUNTRY_ID?p.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[e],t}getCountryIdByName(t){let i;if(t===p.RANDOM_COUNTRY_NAME)i=p.RANDOM_COUNTRY_ID;else if(t===p.OBS_COUNTRY_NAME)i=p.OBS_COUNTRY_ID;else{let e=this.getAvailablePlayerCountries();i=e.indexOf(t)}return i}getColorNameById(e){let t;return t=e===p.RANDOM_COLOR_ID?p.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[e],t}getColorIdByName(t){let i;if(t===p.RANDOM_COLOR_NAME)i=p.RANDOM_COLOR_ID;else{let e=this.getAvailablePlayerColors();if(i=e.indexOf(t),-1===i)throw new Error(`Color ${t} not found in available player colors`)}return i}updatePlayerInfo(t,i,r,s,a){const n=this.slotsInfo[a];if(n.type===d.SlotType.Ai){let e=this.gameOpts.aiPlayers[a];if(!e)throw new Error("No AI found on slot "+a);e.countryId=t,e.colorId=i,e.startPos=r,e.teamId=s}else{if(n.type!==d.SlotType.Player)throw new Error("Unexpected slot type "+n.type);{let e=this.gameOpts.humanPlayers.find(e=>e.name===n.name);if(!e)throw new Error("No player found on slot "+a);e.countryId=t,e.colorId=i,e.startPos=r,e.teamId=s,t!==p.RANDOM_COUNTRY_ID?this.localPrefs.setItem(f.StorageKey.LastPlayerCountry,String(t)):this.localPrefs.removeItem(f.StorageKey.LastPlayerCountry),i!==p.RANDOM_COLOR_ID?this.localPrefs.setItem(f.StorageKey.LastPlayerColor,String(i)):this.localPrefs.removeItem(f.StorageKey.LastPlayerColor)}}this.updateFormModel()}updateFormModel(){var e=this.gameOpts;if(e&&(this.formModel.gameSpeed=e.gameSpeed,this.formModel.credits=e.credits,this.formModel.unitCount=e.unitCount,this.formModel.shortGame=e.shortGame,this.formModel.superWeapons=e.superWeapons,this.formModel.buildOffAlly=e.buildOffAlly,this.formModel.mcvRepacks=e.mcvRepacks,this.formModel.cratesAppear=e.cratesAppear),this.gameOpts&&this.slotsInfo){let i=e.maxSlots;this.slotsInfo.forEach((e,t)=>{i?(i--,this.formModel.playerSlots[t]={country:p.RANDOM_COUNTRY_NAME,color:p.RANDOM_COLOR_NAME,startPos:p.RANDOM_START_POS,team:p.NO_TEAM_ID}):this.formModel.playerSlots[t]=void 0}),this.slotsInfo.forEach((t,i)=>{if(this.formModel.playerSlots[i]){let e=this.formModel.playerSlots[i];t.type===d.SlotType.Closed?e.occupation=n.SlotOccupation.Closed:t.type===d.SlotType.Open||t.type===d.SlotType.OpenObserver?e.occupation=n.SlotOccupation.Open:e.occupation=n.SlotOccupation.Occupied,t.type===d.SlotType.Ai?(e.aiDifficulty=t.difficulty,e.type=n.SlotType.Ai):t.type===d.SlotType.Player&&(e.name=t.name,e.type=n.SlotType.Player),e.status=n.PlayerStatus.NotReady}})}let r=this.gameOpts?this.gameOpts.humanPlayers:[],s=this.gameOpts?this.gameOpts.aiPlayers:[],a=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;this.formModel.playerSlots.forEach((t,e)=>{var i;t&&r.length&&(t.occupation===n.SlotOccupation.Occupied?(i=r.find(e=>e.name===t.name))?(t.country=this.getCountryNameById(i.countryId),t.color=this.getColorNameById(i.colorId),t.startPos=i.startPos,t.team=i.teamId):(i=s[e])&&(t.country=this.getCountryNameById(i.countryId),t.color=this.getColorNameById(i.colorId),t.startPos=i.startPos,t.team=i.teamId):(t.country=p.RANDOM_COUNTRY_NAME,t.team=a.mustAlly?3:p.NO_TEAM_ID))}),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(),this.formModel.availableStartPositions=this.getSelectableStartPositions(),this.gameOpts&&(this.formModel.teamsAllowed=this.gameModes.getById(e.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(e.gameMode).mpDialogSettings.mustAlly),this.lobbyForm&&r.length&&this.lobbyForm.refresh()}updateMapPreview(){this.mapTask?.cancel(),this.mapTask=new i.Task(async t=>{if(this.controller){this.controller.setSidebarPreview();let e;try{e=new b.MapFile(await this.mapFileLoader.load(this.gameOpts.mapName,t))}catch(e){if(e instanceof l.DownloadError)return void this.handleError(e,this.strings.get("TXT_DOWNLOAD_FAILED"));throw e}var i=new h.MapPreviewRenderer(this.strings).render(e,n.LobbyType.Singleplayer,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(i)}}),this.mapTask.start().catch(e=>{e instanceof c.OperationCanceledError||(console.error("Failed to render map preview"),console.error(e))}),this.disposables.add(()=>this.mapTask?.cancel(),()=>this.mapTask=void 0)}initLobbyForm(){var[e]=this.jsxRenderer.render(a.jsx(o.HtmlView,{innerRef:e=>this.lobbyForm=e,component:r.LobbyForm,props:this.formModel}));this.controller.setMainComponent(e)}refreshSidebarButtons(){let e=this.strings;var t=[{label:e.get("GUI:StartGame"),tooltip:e.get("STT:SkirmishButtonStartGame"),disabled:!1,onClick:()=>{this.gameOpts.aiPlayers.filter(y.isNotNullOrUndefined).length<1?this.messageBoxApi.show(this.strings.get("TXT_NEED_AT_LEAST_TWO_PLAYERS"),this.strings.get("GUI:Ok")):this.meetsMinimumTeams()?this.rootController.createGame(0,Date.now(),this.playerName,this.gameOpts,!0,!1,!1,new w.MainMenuRoute(s.ScreenType.Skirmish)):this.messageBoxApi.show(this.strings.get("TXT_CANNOT_ALLY"),this.strings.get("GUI:Ok"))}},{label:e.get("GUI:ChooseMap"),tooltip:e.get("STT:SkirmishButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(s.ScreenType.MapSelection,{lobbyType:n.LobbyType.Singleplayer,gameOpts:this.gameOpts,usedSlots:()=>1+m.findIndexReverse(this.slotsInfo,e=>e.type===d.SlotType.Ai||e.type===d.SlotType.Player)})}},{label:e.get("GUI:Back"),tooltip:e.get("STT:SkirmishButtonBack"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(s.ScreenType.Home)}}];this.controller.setSidebarButtons(t,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let e=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(y.isNotNullOrUndefined).filter(e=>e.countryId!==p.OBS_COUNTRY_ID),t=e[0].teamId;return t===p.NO_TEAM_ID||e.some(e=>e.teamId!==t)}refreshSidebarMpText(){this.controller?.setSidebarMpText(this.gameOpts?this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+this.gameOpts.mapTitle:"")}async onLeave(){this.disposables.dispose(),this.gameOpts=void 0,this.slotsInfo=void 0,this.currentMapFile=void 0,this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},e("SkirmishScreen",E)}}}),System.register("gui/screen/replay/StorageWarning",["react"],function(e,t){"use strict";var r;t&&t.id;function s(e){return Math.ceil(e/1024/1024)}return{setters:[function(e){r=e}],execute:function(){e("StorageWarning",({strings:e})=>{const[t,i]=r.useState();return r.useEffect(()=>{navigator.storage?.estimate&&navigator.storage.estimate().then(e=>i(e)).catch(e=>console.warn("Couldn't get storage estimate",[e]))},[]),t?.quota&&t.usage&&t.quota-t.usage<1048576?r.default.createElement("div",{className:"storage-warning"},e.get("ts:storage_quota_warning",s(t.usage),s(t.quota))):null})}}}),System.register("gui/screen/replay/ReplayDetailsPane",["react","util/format"],function(e,t){"use strict";var n,o;t&&t.id;return{setters:[function(e){n=e},function(e){o=e}],execute:function(){e("ReplayDetailsPane",({replayDetails:{engineVersion:e,durationSeconds:t,gameTimestamp:i,mapName:r,players:s},strings:a})=>n.createElement("div",{className:"replay-details"},n.createElement("table",null,n.createElement("tbody",null,i?n.createElement("tr",null,n.createElement("td",null,a.get("GUI:ReplayTime"),":"),n.createElement("td",{dir:"auto"},new Date(i*(String(i).length<13?1e3:1)).toLocaleString())):null,n.createElement("tr",null,n.createElement("td",null,a.get("GUI:GameVersion"),":"),n.createElement("td",null,e)),void 0!==r&&n.createElement("tr",null,n.createElement("td",null,a.get("GUI:Map"),":"),n.createElement("td",null,r)),s&&n.createElement("tr",null,n.createElement("td",null,a.get("GUI:Players"),":"),n.createElement("td",null,s.map((e,t)=>n.createElement(n.Fragment,{key:e.name},t?", ":"",n.createElement("span",{style:{color:e.color}},e.name))))),void 0!==t&&n.createElement("tr",null,n.createElement("td",null,a.get("GUI:Duration"),":"),n.createElement("td",null,o.formatTimeDuration(t)))))))}}}),System.register("gui/screen/replay/ReplaySel",["react","gui/component/List","gui/screen/replay/StorageWarning","gui/screen/replay/ReplayDetailsPane"],function(e,t){"use strict";var n,o,l,c;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("ReplaySel",({strings:e,replays:t,selectedReplay:i,selectedReplayDetails:r,onSelectReplay:s})=>{const a=n.useRef(null);return n.useEffect(()=>{a.current?.scrollIntoView()},[]),n.default.createElement("div",{className:"replay-sel-form"},n.default.createElement(o.List,{title:e.get("GUI:SelectReplay"),className:"replay-list"},t?t.map(e=>{var t=e.id===i?.id;return n.default.createElement(o.ListItem,{key:e.id,selected:t,innerRef:t?a:null,onClick:()=>s(e),onDoubleClick:()=>s(e,!0),style:{display:"flex"}},n.default.createElement("div",{className:"replay-name"},e.keep?"":"* ",e.name),n.default.createElement("div",{className:"replay-time",dir:"auto"},new Date(e.timestamp).toLocaleString()))}):n.default.createElement(o.ListItem,{style:{textAlign:"center"}},e.get("GUI:LoadingEx"))),r&&n.default.createElement(c.ReplayDetailsPane,{replayDetails:r,strings:e}),n.default.createElement(l.StorageWarning,{strings:e}))})}}}),System.register("gui/screen/replay/KeepReplayBox",["react","gui/component/Dialog","network/gamestate/Replay"],function(e,t){"use strict";var c,h,u;t&&t.id;return{setters:[function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("KeepReplayBox",({defaultName:e,strings:t,viewport:i,onSubmit:r,onDismiss:s})=>{let a=c.useRef(null),[n,o]=c.useState(!1);c.useEffect(()=>{setTimeout(()=>{a.current?.focus(),a.current?.setSelectionRange(0,a.current.value.length)},50)},[]);var l=e=>{e&&e.preventDefault();var t=a.current.value;t&&(o(!0),r(t))};return c.default.createElement(h.Dialog,{className:"keep-replay-box",hidden:n,viewport:i,zIndex:100,buttons:[{label:t.get("GUI:Ok"),onClick:l},{label:t.get("GUI:Cancel"),onClick:()=>{o(!0),s?.()}}]},c.default.createElement("form",{onSubmit:l},c.default.createElement("div",{className:"field"},c.default.createElement("label",null,t.get("GUI:ReplayNamePrompt")),c.default.createElement("input",{type:"text",name:"replayname",autoComplete:"off",ref:a,defaultValue:e,maxLength:u.Replay.maxNameLength})),c.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/replay/ReplaySelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/replay/ReplaySel","network/gamestate/Replay","gui/screen/ScreenType","gui/screen/replay/KeepReplayBox","util/disposable/CompositeDisposable","gui/replay/ReplayStorageError","engine/ResourceLoader","data/vfs/StorageQuotaError","@puzzl/core/lib/async/Task","network/gameopt/Parser","game/GameSpeed","gui/replay/ReplayExistsError","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/cancellation","data/vfs/IOError","data/vfs/FileNotFoundError","RouteHelper","game/gameopts/GameOptRandomGen","game/gameopts/constants"],function(e,t){"use strict";var r,s,i,c,a,n,g,o,l,h,u,d,p,m,f,y,T,v,b,S,w,C;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e},function(e){c=e},function(e){a=e},function(e){n=e},function(e){g=e},function(e){o=e},function(e){l=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){C=class extends f.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d){super(),this.engineVersion=e,this.engineModHash=t,this.activeMod=i,this.oldClientsBaseUrl=r,this.rootController=s,this.strings=a,this.jsxRenderer=n,this.errorHandler=o,this.messageBoxApi=l,this.replayManager=c,this.uiScene=h,this.rules=u,this.sentry=d,this.title=this.strings.get("GUI:Replays"),this.disposables=new g.CompositeDisposable,this.handleSelectReplay=(t,e)=>{var i=this.selectedReplay?.id!==t.id;this.selectedReplay=t,i&&this.updateSidebarButtons(),this.form.applyOptions(e=>{e.selectedReplay=t,e.selectedReplayDetails=void 0}),e?this.loadSelectedReplay():this.loadReplayDetails(t)}}async onEnter(){this.availableReplays=[],this.controller.toggleMainVideo(!1),this.initForm();try{this.availableReplays=await this.replayManager.loadList(!0)}catch(e){return e instanceof T.IOError||e instanceof v.FileNotFoundError||e instanceof h.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load replay list (${e.name??e.message})`,{cause:e})),void this.handleError(e,this.strings.get("GUI:ReplayListError"))}this.selectedReplay=this.availableReplays[0],this.form.applyOptions(e=>{e.replays=this.availableReplays,e.selectedReplay=this.selectedReplay}),void 0!==this.selectedReplay&&this.loadReplayDetails(this.selectedReplay),this.initSidebar(),this.initFileInput()}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(r.jsx(s.HtmlView,{innerRef:e=>this.form=e,component:i.ReplaySel,props:{strings:this.strings,replays:void 0,selectedReplay:void 0,selectedReplayDetails:void 0,onSelectReplay:this.handleSelectReplay}}))[0])}initFileInput(){let e=this.fileInput=document.createElement("input");e.setAttribute("type","file"),e.setAttribute("accept",c.Replay.extension),e.setAttribute("style","display: none"),document.body.appendChild(e);const t=async()=>{var e=this.fileInput.files?.[0];if(e)try{await this.replayManager.importReplay(e),this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions(e=>e.replays=this.availableReplays)}catch(e){let t;t=e instanceof h.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):e instanceof o.ReplayStorageError?this.strings.get("GUI:SaveReplayError"):this.strings.get("GUI:ImportReplayError"),this.errorHandler.handle(e,t,()=>{})}};e.addEventListener("change",t),this.disposables.add(()=>{document.body.removeChild(this.fileInput),this.fileInput.removeEventListener("change",t),this.fileInput=void 0})}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){let t=this.getSelectedReplayMeta();this.controller?.setSidebarButtons([{label:this.strings.get("GUI:LoadReplay"),disabled:!this.selectedReplay,onClick:()=>{this.loadSelectedReplay()}},{label:this.strings.get(t?.keep?"GUI:RenameReplay":"GUI:KeepReplay"),tooltip:t?.keep?void 0:this.strings.get("STT:KeepReplay"),disabled:!this.selectedReplay,onClick:()=>{this.showKeepReplayBox(t.name,e=>{this.replayManager.keepReplay(t.id,e).then(async()=>{this.availableReplays=await this.replayManager.loadList(),this.selectedReplay=this.getSelectedReplayMeta(),this.form.applyOptions(e=>e.replays=this.availableReplays),this.updateSidebarButtons()}).catch(e=>{let t;t=e instanceof m.ReplayExistsError?this.strings.get("GUI:ReplayExistsError"):this.strings.get("GUI:SaveReplayError"),this.errorHandler.handle(e,t,()=>{})})})}},{label:this.strings.get("GUI:ImportReplay"),tooltip:this.strings.get("STT:ImportReplay"),onClick:()=>{if(void 0!==this.fileInput.click)this.fileInput.click();else{let e=document.createEvent("Event");e.initEvent("click",!0,!0),this.fileInput.dispatchEvent(e)}}},{label:this.strings.get("GUI:ExportReplay"),tooltip:this.strings.get("STT:ExportReplay"),disabled:!this.selectedReplay,onClick:()=>{this.exportCurrentReplay().catch(e=>this.errorHandler.handle(e,this.strings.get("GUI:ReplayError"),()=>{}))}},{label:this.strings.get("GUI:DeleteReplay"),disabled:!this.selectedReplay,onClick:async()=>{var t=this.getSelectedReplayMeta();if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmDeleteReplay",t.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){try{await this.replayManager.deleteReplay(t)}catch(e){t=e instanceof h.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:DeleteReplayError");return void this.errorHandler.handle(e,t,()=>{})}this.selectedReplay=void 0,this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions(e=>{e.replays=this.availableReplays,e.selectedReplay=void 0,e.selectedReplayDetails=void 0}),this.updateSidebarButtons()}}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadSelectedReplay(){var t=this.selectedReplay;let i;try{var r=await this.replayManager.loadSerializedReplay(t);i=await(new c.Replay).parseHeader(r)}catch(e){return void this.errorHandler.handle(e,this.strings.get("GUI:ReplayError"),()=>{})}if(i.engineVersion!==this.engineVersion){if(!this.clientVersions&&this.oldClientsBaseUrl){this.messageBoxApi.show(this.strings.get("GUI:LoadingEx"));try{let e=new l.ResourceLoader(this.oldClientsBaseUrl);this.clientVersions=await e.loadJson("versions.json")}catch(e){console.warn("Couldn't download client version list",e)}finally{this.messageBoxApi.destroy()}}let e;return this.clientVersions&&(e=this.clientVersions[i.engineVersion]),void(e?await this.messageBoxApi.confirm(this.strings.get("GUI:ReplayOpenOldClient",i.engineVersion),this.strings.get("TXT_CONTINUE"),this.strings.get("GUI:Close"))&&(r=this.activeMod?`?${b.RouteHelper.modQueryStringName}=`+this.activeMod:"",window.open(`${this.oldClientsBaseUrl}v${e}/${r}#/replay/`+t.id,"_blank")):this.messageBoxApi.show(this.strings.get("GUI:ReplayVersionMismatch",i.engineVersion),this.strings.get("GUI:Ok")))}if(i.modHash===this.engineModHash){let e;try{e=await this.replayManager.loadReplay(t)}catch(e){return void this.errorHandler.handle(e,this.strings.get("GUI:ReplayError"),()=>{})}this.rootController.goToScreen(a.ScreenType.Replay,{replay:e})}else this.messageBoxApi.show(this.strings.get("GUI:ReplayModMismatch"),this.strings.get("GUI:Ok"))}showKeepReplayBox(e,t){let[i]=this.jsxRenderer.render(r.jsx(s.HtmlView,{component:n.KeepReplayBox,props:{defaultName:e,strings:this.strings,onSubmit:e=>{t(e),i.destroy()},onDismiss:()=>{i.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(i),this.disposables.add(i,()=>this.uiScene.remove(i))}async exportCurrentReplay(){var e=this.getSelectedReplayMeta();if(!e)throw new Error("No replay selected");var t=await this.replayManager.loadSerializedReplay(e);this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl);t=URL.createObjectURL(new Blob([t],{type:"application/octet-stream"}));this.currentReplayUrl=t;let i=document.createElement("a");i.setAttribute("href",t),i.setAttribute("download",e.name+c.Replay.extension),document.body.appendChild(i),i.click(),document.body.removeChild(i)}getSelectedReplayMeta(){if(this.selectedReplay)return this.availableReplays.find(e=>e.id===this.selectedReplay.id)}async onLeave(){this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),this.clientVersions=void 0,this.availableReplays.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.replayDetailsTask?.cancel(),this.replayDetailsTask=void 0,this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}loadReplayDetails(l){this.replayDetailsTask?.cancel(),this.replayDetailsTask=new u.Task(async t=>{let i=await this.replayManager.loadSerializedReplay(l);var r=await(new c.Replay).parseHeader(i);t.throwIfCancelled();let s,a;if(r.engineVersion===this.engineVersion){let e=new c.Replay;e.unserialize("string"==typeof i?i:await i.text(),l),t.throwIfCancelled(),s=e.gameOpts,a=Math.floor(e.endTick/p.GameSpeed.BASE_TICKS_PER_SECOND)}else try{s=(new d.Parser).parseOptions(r.gameOptsSerialized)}catch(e){console.warn("Replay couldn't be parsed",e)}let n;if(s){let e=S.GameOptRandomGen.factory(r.gameId,r.gameTimestamp),t=e.generateColors(s),i=this.getAvailablePlayerColors();n=s.humanPlayers.filter(e=>e.countryId!==w.OBS_COUNTRY_ID).map(e=>({name:e.name,color:i[t.get(e)??e.colorId]}))}let o={gameTimestamp:r.gameTimestamp||void 0,engineVersion:r.engineVersion,durationSeconds:a,mapName:s?.mapTitle,players:n};this.form.applyOptions(e=>{e.selectedReplayDetails=o})}),this.replayDetailsTask.start().catch(e=>{e instanceof y.OperationCanceledError||console.error(e)})}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(e=>e.asHexString())}handleError(e,t){this.errorHandler.handle(e,t,()=>{this.rootController.goToScreen(a.ScreenType.MainMenuRoot)})}},e("ReplaySelScreen",C)}}}),System.register("gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen",["react","gui/screen/mainMenu/main/ReportBug","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType"],function(e,t){"use strict";var r,s,i,a,n;t&&t.id;return{setters:[function(e){r=e},function(e){s=e},function(e){i=e},function(e){a=e}],execute:function(){n=class extends i.MainMenuScreen{constructor(e,t,i){super(),this.strings=e,this.config=t,this.messageBoxApi=i,this.title=this.strings.get("TS:InfoAndCredits")}onEnter(){let e=this.strings;const t=this.config.discordUrl,i=this.config.donateUrl;this.controller.setSidebarButtons([...this.controller.hasScreen(a.ScreenType.PatchNotes)?[{label:e.get("TS:PatchNotes"),tooltip:e.get("STT:PatchNotes"),onClick:()=>{this.controller?.pushScreen(a.ScreenType.PatchNotes)}}]:[],...t?[{label:e.get("TS:ReportBug"),tooltip:e.get("TS:ReportBugTT"),onClick:()=>{this.messageBoxApi.show(r.createElement(s.ReportBug,{discordUrl:t,strings:this.strings}),this.strings.get("GUI:OK"))}}]:[],...i?[{label:e.get("TS:Donate"),onClick:()=>{window.open(i,"_blank"),window.gtag?.("event","donate_click")}}]:[],{label:e.get("GUI:ViewCredits"),onClick:()=>{this.controller?.pushScreen(a.ScreenType.Credits)}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.setMainComponent()}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("InfoAndCreditsScreen",n)}}}),System.register("gui/screen/mainMenu/credits/Credits",["react"],function(e,t){"use strict";var r;t&&t.id;return{setters:[function(e){r=e}],execute:function(){e("Credits",({contentTpl:e,strings:i})=>{var t=e.replace(/\{([^}]+)\}/g,(e,t)=>i.get(t)).replace(/<([^>]+)>/g,(e,t)=>t.match(/^(https?|mailto):(\/\/)?/)?`<a href='${encodeURI(t)}' target='_blank' rel='noopener'>${encodeURI(t)}</a>`:"").replace(/\t*\r?\n/g,"<br />").replace(/([^>]+)\t+([^<]+)<br \/>/g,`<div class='def'>
                <span class='title'>$1</span>
                <span class='filler'></span>
                <span class='name'>$2</span>
            </div>`);return r.createElement("div",{className:"credits-container"},r.createElement("div",{className:"credits",dangerouslySetInnerHTML:{__html:t}}))})}}}),System.register("gui/screen/mainMenu/credits/CreditsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/credits/Credits","engine/Engine","gui/screen/mainMenu/MainMenuScreen"],function(e,t){"use strict";var i,r,s,a,n,o;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e}],execute:function(){o=class extends n.MainMenuScreen{constructor(e,t){super(),this.strings=e,this.jsxRenderer=t,this.title=this.strings.get("GUI:Credits")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var e=a.Engine.vfs?.openFile("creditscd.txt").readAsString("utf-8");let t=a.Engine.vfs?.openFile("credits.txt").readAsString();var e=t.replace(/\s+\{CRD:CREDITS\}\s+/,e),[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.Credits,props:{contentTpl:e,strings:this.strings}}));this.controller.setMainComponent(e)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("CreditsScreen",o)}}}),System.register("gui/screen/options/component/Resolution",["gui/component/Select","gui/component/Option","react"],function(e,t){"use strict";var p,m,f,y;t&&t.id;return{setters:[function(e){p=e},function(e){m=e},function(e){f=e}],execute:function(){y=[{width:1920,height:1080},{width:1600,height:900},{width:1280,height:1024},{width:1366,height:768},{width:1024,height:768},{width:800,height:600}],e("ResolutionSelect",({resolution:i,fullScreen:e,strings:t})=>{const r=e=>e.width+" x "+e.height,s=()=>({width:Math.max(y[y.length-1].width,window.innerWidth),height:Math.max(y[y.length-1].height,window.innerHeight)}),a=i=>y.filter((e,t)=>e.height<=i.height&&e.width<=i.width||t===y.length-1),[n,o]=f.useState(()=>s()),[l,c]=f.useState(i.value),[h,u]=f.useState(()=>a(n));var d=e.isFullScreen(),g=l&&!h.find(e=>e.height===l.height&&e.width===l.width);return f.useEffect(()=>{const e=()=>{var e=s();o(e),u(a(e))};return window.addEventListener("resize",e),i.onChange.subscribe(c),()=>{window.removeEventListener("resize",e),i.onChange.unsubscribe(c)}},[]),d?f.createElement(p.Select,{className:"resolution-select",initialValue:"",disabled:!0,onSelect:()=>{}},f.createElement(m.Option,{value:"",label:t.get("TS:ResolutionFullScreen",r(n))})):f.createElement(p.Select,{className:"resolution-select",initialValue:l?r(l):"",onSelect:e=>{var t=""!==e?e.split(" x ").map(e=>Number(e)):void 0,t=t?{width:t[0],height:t[1]}:void 0;i.value=t}},g&&f.createElement(m.Option,{value:r(l),label:`${r(l)} (${r({width:Math.min(l.width,n.width),height:Math.min(l.height,n.height)})})`}),f.createElement(m.Option,{value:"",label:t.get("TS:ResolutionFit",r(n))}),h.map(e=>{var t=r(e);return f.createElement(m.Option,{key:t,value:t,label:t})}))})}}}),System.register("gui/screen/options/component/GeneralOpts",["react","gui/component/Slider","gui/screen/options/GeneralOptions","gui/component/Select","gui/component/Option","engine/renderable/entity/unit/FlyerHelperMode","engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","gui/component/Image","gui/screen/options/component/Resolution"],function(e,t){"use strict";var s,a,n,o,l,c,h,u,d,g,p;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=new Map([[1,"TXT_SLOWEST"],[2,"TXT_SLOWER"],[3,"TXT_SLOW"],[4,"TXT_MEDIUM"],[5,"TXT_FAST"],[6,"TXT_FASTER"],[7,"TXT_FASTEST"]]),e("GeneralOpts",({strings:t,options:i,fullScreen:e,inGame:r})=>s.createElement("div",{className:"opts general-opts"},s.createElement("fieldset",null,s.createElement("legend",null,t.get("TS:GameplayOpts")),s.createElement("div",{className:"slider-item"},s.createElement("span",{className:"label"},t.get("GUI:ScrollRate")),s.createElement(a.Slider,{min:1,max:7,value:""+Math.floor(i.scrollRate.value/n.SCROLL_BASE_FACTOR),getLabel:e=>t.get(p.get(Number(e))),onChange:e=>i.scrollRate.value=Number(e.target.value)*n.SCROLL_BASE_FACTOR})),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:MouseAccel")},s.createElement("label",null,s.createElement("span",{className:"label"},t.get("TS:MouseAccel")),s.createElement(o.Select,{initialValue:""+Number(i.mouseAcceleration.value),onSelect:e=>i.mouseAcceleration.value=Boolean(Number(e))},s.createElement(l.Option,{value:"1",label:t.get("TXT_ON")}),s.createElement(l.Option,{value:"0",label:t.get("TXT_OFF")})),s.createElement("span",{className:"info",title:t.get("TS:MouseAccelHint")},s.createElement(d.Image,{src:"info.png"})))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:AttackMoveButton")},s.createElement("label",null,s.createElement("span",{className:"label"},t.get("TS:AttackMoveButton")),s.createElement(o.Select,{initialValue:""+Number(i.rightClickMove.value),onSelect:e=>i.rightClickMove.value=Boolean(Number(e))},s.createElement(l.Option,{value:"0",label:t.get("TS:AttackMoveButtonLeft")}),s.createElement(l.Option,{value:"1",label:t.get("TS:AttackMoveButtonRight")})))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:RightClickScroll")},s.createElement("label",null,s.createElement("span",{className:"label"},t.get("TS:RightClickScroll")),s.createElement(o.Select,{initialValue:""+Number(i.rightClickScroll.value),onSelect:e=>i.rightClickScroll.value=Boolean(Number(e))},s.createElement(l.Option,{value:"1",label:t.get("TXT_ON")}),s.createElement(l.Option,{value:"0",label:t.get("TXT_OFF")})))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:FlyerLabel")},s.createElement("span",{className:"label"},t.get("TS:FlyerLabel")),s.createElement(o.Select,{initialValue:""+i.flyerHelper.value,onSelect:e=>i.flyerHelper.value=Number(e)},s.createElement(l.Option,{value:""+c.FlyerHelperMode.Always,label:t.get("TS:FlyerAlways")}),s.createElement(l.Option,{value:""+c.FlyerHelperMode.Selected,label:t.get("TS:FlyerSelected")}),s.createElement(l.Option,{value:""+c.FlyerHelperMode.Never,label:t.get("TS:FlyerNever")}))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:IGGameOptCBoxHidden")},s.createElement("label",null,s.createElement("span",{className:"label"},t.get("GUI:ShowHidden")),s.createElement("input",{type:"checkbox",defaultChecked:i.hiddenObjects.value,onChange:e=>i.hiddenObjects.value=e.target.checked}))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:IGGameOptCBoxTargetLines")},s.createElement("label",null,s.createElement("span",{className:"label"},t.get("GUI:TargetLines")),s.createElement("input",{type:"checkbox",defaultChecked:i.targetLines.value,onChange:e=>i.targetLines.value=e.target.checked})))),s.createElement("fieldset",null,s.createElement("legend",null,t.get("TS:GfxOpts")),s.createElement("div",{className:"item"},s.createElement("span",{className:"label"},t.get("TS:Resolution")),s.createElement(g.ResolutionSelect,{resolution:i.graphics.resolution,fullScreen:e,strings:t}),s.createElement("span",{className:"info",title:t.get("TS:ResolutionHint")},s.createElement(d.Image,{src:"info.png"}))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:GfxModels")},s.createElement("span",{className:"label"},t.get("TS:GfxModels")),s.createElement(o.Select,{disabled:r,initialValue:""+i.graphics.models.value,onSelect:e=>i.graphics.models.value=Number(e)},s.createElement(l.Option,{value:""+h.ModelQuality.High,label:t.get("TS:GfxQualityHigh")}),s.createElement(l.Option,{value:""+h.ModelQuality.Low,label:t.get("TS:GfxQualityLow")}))),s.createElement("div",{className:"item","data-r-tooltip":t.get("STT:GfxShadows")},s.createElement("span",{className:"label"},t.get("TS:GfxShadows")),s.createElement(o.Select,{initialValue:""+i.graphics.shadows.value,onSelect:e=>i.graphics.shadows.value=Number(e)},s.createElement(l.Option,{value:""+u.ShadowQuality.High,label:t.get("TS:GfxQualityHigh")}),s.createElement(l.Option,{value:""+u.ShadowQuality.Medium,label:t.get("TS:GfxQualityMed")}),s.createElement(l.Option,{value:""+u.ShadowQuality.Low,label:t.get("TS:GfxQualityLow")}),s.createElement(l.Option,{value:""+u.ShadowQuality.Off,label:t.get("TS:GfxQualityOff")}))))))}}}),System.register("gui/screen/options/OptionsScreen",["gui/jsx/jsx","gui/screen/mainMenu/MainMenuController","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","LocalPrefs","gui/jsx/HtmlView","gui/screen/options/component/GeneralOpts"],function(e,t){"use strict";var i,r,s,a,n,o,l,c,h;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("OptionsScreen",h=class{constructor(e,t,i,r,s,a,n){this.strings=e,this.jsxRenderer=t,this.options=i,this.localPrefs=r,this.fullScreen=s,this.inGame=a,this.storageOptsEnabled=n,this.title=this.strings.get("GUI:Options")}setController(e){this.controller=e}onEnter(){this.initialOptionsStr=this.options.serialize(),this.controller instanceof r.MainMenuController&&this.controller.toggleMainVideo(!1),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Sound"),onClick:()=>{this.controller instanceof s.GameMenuController?this.controller.pushScreen(a.ScreenType.OptionsSound):this.controller?.pushScreen(n.ScreenType.OptionsSound)}},{label:this.strings.get("GUI:Keyboard"),onClick:()=>{this.controller instanceof s.GameMenuController?this.controller.pushScreen(a.ScreenType.OptionsKeyboard):this.controller?.pushScreen(n.ScreenType.OptionsKeyboard)}},...this.controller instanceof r.MainMenuController&&this.storageOptsEnabled?[{label:this.strings.get("GUI:Storage"),onClick:()=>{this.controller.pushScreen(n.ScreenType.OptionsStorage,{})}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[e]=this.jsxRenderer.render(i.jsx(l.HtmlView,{width:"100%",height:"100%",component:c.GeneralOpts,props:{options:this.options,fullScreen:this.fullScreen,strings:this.strings,inGame:this.inGame}}));this.controller.setMainComponent(e)}async onLeave(){var e=this.options.serialize();e!==this.initialOptionsStr&&this.localPrefs.setItem(o.StorageKey.Options,e),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}})}}}),System.register("gui/screen/options/component/MusicJukebox",["gui/component/List","react","util/string"],function(e,t){"use strict";var a,n,o;t&&t.id;return{setters:[function(e){a=e},function(e){n=e},function(e){o=e}],execute:function(){e("MusicJukebox",({music:t,strings:i})=>{const[r,s]=n.useState(()=>t.getCurrentPlaylistItem());return n.default.createElement("div",{className:"music-jukebox"},n.default.createElement("div",{className:"jukebox-content"},n.default.createElement("div",{className:"controls"},n.default.createElement("div",null,n.default.createElement("label",null,n.default.createElement("input",{type:"checkbox",defaultChecked:t.getShuffleMode(),onChange:e=>t.setShuffleMode(e.target.checked)}),i.get("GUI:Shuffle"))),n.default.createElement("div",null,n.default.createElement("label",null,n.default.createElement("input",{type:"checkbox",defaultChecked:t.getRepeatMode(),onChange:e=>t.setRepeatMode(e.target.checked)}),i.get("GUI:Repeat")))),n.default.createElement(a.List,{className:"playlist"},t.getPlaylist().map((e,t)=>n.default.createElement(a.ListItem,{key:e.name,selected:e===r,onClick:()=>s(e)},o.pad(t+1,"00")," - ",i.get(e.name))))),n.default.createElement("div",{className:"jukebox-footer"},n.default.createElement("button",{className:"dialog-button",onClick:()=>r&&t.selectPlaylistItem(r)},i.get("GUI:Play")),n.default.createElement("button",{className:"dialog-button",onClick:()=>t.stopPlaying()},i.get("GUI:Stop"))))})}}}),System.register("gui/screen/options/component/SoundOpts",["react","gui/component/Slider","engine/sound/ChannelType","gui/screen/options/component/MusicJukebox"],function(e,t){"use strict";var s,a,i,n,o;t&&t.id;return{setters:[function(e){s=e},function(e){a=e},function(e){i=e},function(e){n=e}],execute:function(){o=new Map([[i.ChannelType.Master,"GUI:MasterVolume"],[i.ChannelType.Music,"GUI:MusicVolume"],[i.ChannelType.Effect,"GUI:SFXVolume"],[i.ChannelType.Voice,"GUI:VoiceVolume"],[i.ChannelType.Ambient,"GUI:AmbientVolume"],[i.ChannelType.Ui,"GUI:UIVolume"],[i.ChannelType.CreditTicks,"GUI:CreditsVolume"]]),e("SoundOpts",({strings:i,music:e,mixer:r})=>s.createElement("div",{className:"opts sound-opts"},s.createElement("div",{className:"sound-sliders"},[...o].map(([t,e])=>s.createElement("div",{className:"slider-item",key:t},s.createElement("span",{className:"label"},i.get(e)),s.createElement(a.Slider,{min:0,max:10,value:""+10*r.getVolume(t),onChange:e=>r.setVolume(t,Number(e.target.value)/10)})))),e&&s.createElement(n.MusicJukebox,{music:e,strings:i})))}}}),System.register("gui/screen/options/SoundOptsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/SoundOpts","LocalPrefs"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){e("SoundOptsScreen",n=class{constructor(e,t,i,r,s){this.strings=e,this.jsxRenderer=t,this.mixer=i,this.music=r,this.localPrefs=s,this.title=this.strings.get("GUI:Sound")}setController(e){this.controller=e}onEnter(){this.initialSettings=this.mixer.serialize(),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.SoundOpts,props:{mixer:this.mixer,music:this.music,strings:this.strings}}));this.controller.setMainComponent(e)}async onLeave(){var e=this.mixer.serialize();e!==this.initialSettings&&this.localPrefs.setItem(a.StorageKey.Mixer,e),this.music&&(e=this.music.serializeOptions(),this.localPrefs.setItem(a.StorageKey.MusicOpts,e)),await this.controller.hideSidebarButtons()}})}}}),System.register("gui/screen/options/component/configurableCmds",["gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("configurableCmds",new Map([[i.KeyCommandType.Options,{label:"txt_options",desc:"txt_options_desc"}],[i.KeyCommandType.ToggleAlliance,{label:"txt_alliance",desc:"txt_alliance_desc"}],[i.KeyCommandType.PlaceBeacon,{label:"txt_place_beacon",desc:"txt_place_beacon_desc"}],[i.KeyCommandType.AllToCheer,{label:"cmnd:allcheer",desc:"cmnd:allcheerdesc"}],[i.KeyCommandType.DeployObject,{label:"txt_deploy_object",desc:"txt_deploy_object_desc"}],[i.KeyCommandType.Follow,{label:"txt_follow",desc:"txt_follow_desc"}],[i.KeyCommandType.GuardObject,{label:"txt_guard",desc:"txt_guard_desc"}],[i.KeyCommandType.StopObject,{label:"txt_stop_object",desc:"txt_stop_object_desc"}],[i.KeyCommandType.ScatterObject,{label:"txt_scatter",desc:"txt_scatter_desc"}],[i.KeyCommandType.CenterBase,{label:"txt_center_base",desc:"txt_center_base_desc"}],[i.KeyCommandType.ToggleRepair,{label:"txt_repair_mode",desc:"txt_repair_mode_desc"}],[i.KeyCommandType.ToggleSell,{label:"txt_sell_mode",desc:"txt_sell_mode_desc"}],[i.KeyCommandType.PreviousObject,{label:"txt_prev_object",desc:"txt_prev_object_desc"}],[i.KeyCommandType.NextObject,{label:"txt_next_object",desc:"txt_next_object_desc"}],[i.KeyCommandType.TypeSelect,{label:"cmnd:typeselect",desc:"cmnd:typeselectdesc"}],[i.KeyCommandType.CombatantSelect,{label:"cmnd:combatantselect",desc:"cmnd:combatantselectdesc"}],[i.KeyCommandType.StructureTab,{label:"txt_structure_tab",desc:"txt_structure_tab_desc"}],[i.KeyCommandType.DefenseTab,{label:"txt_defense_tab",desc:"txt_defense_tab_desc"}],[i.KeyCommandType.InfantryTab,{label:"txt_infantry_tab",desc:"txt_infantry_tab_desc"}],[i.KeyCommandType.UnitTab,{label:"txt_unit_tab",desc:"txt_unit_tab_desc"}],[i.KeyCommandType.PlanningMode,{label:"cmnd:planningmode",desc:"cmnd:planningmodedesc"}],[i.KeyCommandType.CenterOnRadarEvent,{label:"txt_radar_event",desc:"txt_radar_event_desc"}],[i.KeyCommandType.HealthNav,{label:"cmnd:healthnavigation",desc:"cmnd:healthnavigationdesc"}],[i.KeyCommandType.VeterancyNav,{label:"cmnd:vetnavigation",desc:"cmnd:vetnavigationdesc"}],[i.KeyCommandType.TeamSelect_1,{label:e=>e.get("txt_select_team",1),desc:e=>e.get("txt_select_team_desc",1)}],[i.KeyCommandType.TeamSelect_2,{label:e=>e.get("txt_select_team",2),desc:e=>e.get("txt_select_team_desc",2)}],[i.KeyCommandType.TeamSelect_3,{label:e=>e.get("txt_select_team",3),desc:e=>e.get("txt_select_team_desc",3)}],[i.KeyCommandType.TeamSelect_4,{label:e=>e.get("txt_select_team",4),desc:e=>e.get("txt_select_team_desc",4)}],[i.KeyCommandType.TeamSelect_5,{label:e=>e.get("txt_select_team",5),desc:e=>e.get("txt_select_team_desc",5)}],[i.KeyCommandType.TeamSelect_6,{label:e=>e.get("txt_select_team",6),desc:e=>e.get("txt_select_team_desc",6)}],[i.KeyCommandType.TeamSelect_7,{label:e=>e.get("txt_select_team",7),desc:e=>e.get("txt_select_team_desc",7)}],[i.KeyCommandType.TeamSelect_8,{label:e=>e.get("txt_select_team",8),desc:e=>e.get("txt_select_team_desc",8)}],[i.KeyCommandType.TeamSelect_9,{label:e=>e.get("txt_select_team",9),desc:e=>e.get("txt_select_team_desc",9)}],[i.KeyCommandType.TeamSelect_10,{label:e=>e.get("txt_select_team",10),desc:e=>e.get("txt_select_team_desc",10)}],[i.KeyCommandType.TeamCreate_1,{label:e=>e.get("txt_create_team",1),desc:e=>e.get("txt_create_team_desc",1)}],[i.KeyCommandType.TeamCreate_2,{label:e=>e.get("txt_create_team",2),desc:e=>e.get("txt_create_team_desc",2)}],[i.KeyCommandType.TeamCreate_3,{label:e=>e.get("txt_create_team",3),desc:e=>e.get("txt_create_team_desc",3)}],[i.KeyCommandType.TeamCreate_4,{label:e=>e.get("txt_create_team",4),desc:e=>e.get("txt_create_team_desc",4)}],[i.KeyCommandType.TeamCreate_5,{label:e=>e.get("txt_create_team",5),desc:e=>e.get("txt_create_team_desc",5)}],[i.KeyCommandType.TeamCreate_6,{label:e=>e.get("txt_create_team",6),desc:e=>e.get("txt_create_team_desc",6)}],[i.KeyCommandType.TeamCreate_7,{label:e=>e.get("txt_create_team",7),desc:e=>e.get("txt_create_team_desc",7)}],[i.KeyCommandType.TeamCreate_8,{label:e=>e.get("txt_create_team",8),desc:e=>e.get("txt_create_team_desc",8)}],[i.KeyCommandType.TeamCreate_9,{label:e=>e.get("txt_create_team",9),desc:e=>e.get("txt_create_team_desc",9)}],[i.KeyCommandType.TeamCreate_10,{label:e=>e.get("txt_create_team",10),desc:e=>e.get("txt_create_team_desc",10)}],[i.KeyCommandType.TeamAddSelect_1,{label:e=>e.get("txt_add_select_team",1),desc:e=>e.get("txt_add_select_team_desc",1)}],[i.KeyCommandType.TeamAddSelect_2,{label:e=>e.get("txt_add_select_team",2),desc:e=>e.get("txt_add_select_team_desc",2)}],[i.KeyCommandType.TeamAddSelect_3,{label:e=>e.get("txt_add_select_team",3),desc:e=>e.get("txt_add_select_team_desc",3)}],[i.KeyCommandType.TeamAddSelect_4,{label:e=>e.get("txt_add_select_team",4),desc:e=>e.get("txt_add_select_team_desc",4)}],[i.KeyCommandType.TeamAddSelect_5,{label:e=>e.get("txt_add_select_team",5),desc:e=>e.get("txt_add_select_team_desc",5)}],[i.KeyCommandType.TeamAddSelect_6,{label:e=>e.get("txt_add_select_team",6),desc:e=>e.get("txt_add_select_team_desc",6)}],[i.KeyCommandType.TeamAddSelect_7,{label:e=>e.get("txt_add_select_team",7),desc:e=>e.get("txt_add_select_team_desc",7)}],[i.KeyCommandType.TeamAddSelect_8,{label:e=>e.get("txt_add_select_team",8),desc:e=>e.get("txt_add_select_team_desc",8)}],[i.KeyCommandType.TeamAddSelect_9,{label:e=>e.get("txt_add_select_team",9),desc:e=>e.get("txt_add_select_team_desc",9)}],[i.KeyCommandType.TeamAddSelect_10,{label:e=>e.get("txt_add_select_team",10),desc:e=>e.get("txt_add_select_team_desc",10)}],[i.KeyCommandType.TeamCenter_1,{label:e=>e.get("txt_center_team",1),desc:e=>e.get("txt_center_team_desc",1)}],[i.KeyCommandType.TeamCenter_2,{label:e=>e.get("txt_center_team",2),desc:e=>e.get("txt_center_team_desc",2)}],[i.KeyCommandType.TeamCenter_3,{label:e=>e.get("txt_center_team",3),desc:e=>e.get("txt_center_team_desc",3)}],[i.KeyCommandType.TeamCenter_4,{label:e=>e.get("txt_center_team",4),desc:e=>e.get("txt_center_team_desc",4)}],[i.KeyCommandType.TeamCenter_5,{label:e=>e.get("txt_center_team",5),desc:e=>e.get("txt_center_team_desc",5)}],[i.KeyCommandType.TeamCenter_6,{label:e=>e.get("txt_center_team",6),desc:e=>e.get("txt_center_team_desc",6)}],[i.KeyCommandType.TeamCenter_7,{label:e=>e.get("txt_center_team",7),desc:e=>e.get("txt_center_team_desc",7)}],[i.KeyCommandType.TeamCenter_8,{label:e=>e.get("txt_center_team",8),desc:e=>e.get("txt_center_team_desc",8)}],[i.KeyCommandType.TeamCenter_9,{label:e=>e.get("txt_center_team",9),desc:e=>e.get("txt_center_team_desc",9)}],[i.KeyCommandType.TeamCenter_10,{label:e=>e.get("txt_center_team",10),desc:e=>e.get("txt_center_team_desc",10)}],[i.KeyCommandType.CenterView,{label:"txt_center_view",desc:"txt_center_view_desc"}],[i.KeyCommandType.View1,{label:"txt_view_bookmark1",desc:"txt_view_bookmark1_desc"}],[i.KeyCommandType.View2,{label:"txt_view_bookmark2",desc:"txt_view_bookmark2_desc"}],[i.KeyCommandType.View3,{label:"txt_view_bookmark3",desc:"txt_view_bookmark3_desc"}],[i.KeyCommandType.View4,{label:"txt_view_bookmark4",desc:"txt_view_bookmark4_desc"}],[i.KeyCommandType.SetView1,{label:"txt_set_bookmark1",desc:"txt_set_bookmark1_desc"}],[i.KeyCommandType.SetView2,{label:"txt_set_bookmark2",desc:"txt_set_bookmark2_desc"}],[i.KeyCommandType.SetView3,{label:"txt_set_bookmark3",desc:"txt_set_bookmark3_desc"}],[i.KeyCommandType.SetView4,{label:"txt_set_bookmark4",desc:"txt_set_bookmark4_desc"}],[i.KeyCommandType.Taunt_1,{label:e=>e.get("txt_taunt_number",1),desc:e=>e.get("txt_taunt_desc",1)}],[i.KeyCommandType.Taunt_2,{label:e=>e.get("txt_taunt_number",2),desc:e=>e.get("txt_taunt_desc",2)}],[i.KeyCommandType.Taunt_3,{label:e=>e.get("txt_taunt_number",3),desc:e=>e.get("txt_taunt_desc",3)}],[i.KeyCommandType.Taunt_4,{label:e=>e.get("txt_taunt_number",4),desc:e=>e.get("txt_taunt_desc",4)}],[i.KeyCommandType.Taunt_5,{label:e=>e.get("txt_taunt_number",5),desc:e=>e.get("txt_taunt_desc",5)}],[i.KeyCommandType.Taunt_6,{label:e=>e.get("txt_taunt_number",6),desc:e=>e.get("txt_taunt_desc",6)}],[i.KeyCommandType.Taunt_7,{label:e=>e.get("txt_taunt_number",7),desc:e=>e.get("txt_taunt_desc",7)}],[i.KeyCommandType.Taunt_8,{label:e=>e.get("txt_taunt_number",8),desc:e=>e.get("txt_taunt_desc",8)}],[i.KeyCommandType.Delete,{label:"cmnd:delete",desc:"cmnd:deletedesc"}],[i.KeyCommandType.PageUser,{label:"txt_pageuser",desc:"txt_pageuser_desc"}],[i.KeyCommandType.SidebarPageUp,{label:"txt_sidebar_pgup",desc:"txt_sidebar_pgup_desc"}],[i.KeyCommandType.SidebarUp,{label:"txt_sidebar_up",desc:"txt_sidebar_up_desc"}],[i.KeyCommandType.SidebarPageDown,{label:"txt_sidebar_pgdn",desc:"txt_sidebar_pgdn_desc"}],[i.KeyCommandType.SidebarDown,{label:"txt_sidebar_down",desc:"txt_sidebar_down_desc"}],[i.KeyCommandType.ToggleFps,{label:"cmnd:togglefps",desc:"cmnd:togglefpsdesc"}]]))}}}),System.register("gui/screen/options/component/PressKeyInput",["gui/FullScreen","react","gui/screen/options/component/getHumanReadableKey"],function(e,t){"use strict";var n,o,l,c,h,u;t&&t.id;return{setters:[function(e){n=e},function(e){o=e},function(e){l=e}],execute:function(){c=e=>e.shiftKey||e.ctrlKey||e.altKey||e.metaKey,h=e=>["Alt","Control","Shift","Meta"].includes(e.key),u=["Escape","Backspace","Enter","Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "],e("PressKeyInput",({tooltip:e,onChange:t})=>{const[i,r]=o.useState(),s=e=>{r(e),e&&void 0===e.keyCode||t(e)};var a=i?l.getHumanReadableKey(i):"";return o.default.createElement("input",{type:"text",value:a,"data-r-tooltip":e,onChange:()=>{},onKeyDown:e=>{e.preventDefault(),e.stopPropagation(),e.repeat||255<e.keyCode||(u.includes(e.key)||n.FullScreen.isFullScreenHotKey(e)?s(void 0):s({shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,keyCode:h(e)?void 0:e.keyCode}))},onKeyUp:e=>{e.preventDefault(),e.stopPropagation(),e.repeat||255<e.keyCode||void 0===i?.keyCode&&h(e)&&s(c(e)?{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,keyCode:void 0}:void 0)},onBlur:()=>{i&&void 0===i?.keyCode&&s(void 0)}})})}}}),System.register("gui/screen/options/component/KeyOpts",["react","gui/screen/options/component/configurableCmds","gui/component/List","gui/screen/options/component/PressKeyInput","gui/screen/options/component/getHumanReadableKey","gui/screen/game/worldInteraction/keyboard/KeyboardHandler"],function(e,t){"use strict";var T,v,b,S,w,C;t&&t.id;return{setters:[function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){e("KeyOpts",({strings:t,keyBinds:i,onResetAll:e,onHotKeyChange:r})=>{let[s,a]=T.useState(),[n,o]=T.useState(),[l,c]=T.useState(),[h,u]=T.useState(0),[d,g]=T.useState();const p=e=>"function"==typeof e?e(t):t.get(e);let m=s&&v.configurableCmds.has(s)?v.configurableCmds.get(s).desc:void 0;var f=m?"function"==typeof m?m(t):t.get(m):void 0,y=s?i.getHotKey(s):void 0;return T.default.createElement("div",{className:"opts key-opts"},T.default.createElement("div",{className:"key-opts-list"},T.default.createElement("div",{className:"key-opts-left"},T.default.createElement(b.List,{title:t.get("GUI:Commands"),className:"key-list"},[...v.configurableCmds].map(([e,{label:t}])=>T.default.createElement(b.ListItem,{key:e,selected:s===e,onClick:()=>(e=>{a(e),o(void 0),u(h+1),g(void 0)})(e)},p(t))))),T.default.createElement("div",{className:"key-opts-right"},T.default.createElement("fieldset",{className:"key-opts-desc-container"},T.default.createElement("legend",null,t.get("GUI:Description")),T.default.createElement("div",{className:"key-opts-desc"},f)))),T.default.createElement("div",{className:"key-opts-assigns"},T.default.createElement("div",{className:"key-opts-cur-assign"},T.default.createElement("div",{className:"key-opts-left","data-r-tooltip":t.get("STT:KeyboardLabelAssigned")},T.default.createElement("div",{className:"key-opts-cur-assign-label"},t.get("GUI:CurrentShortcut")),T.default.createElement("div",{className:"key-opts-cur-assign-value"},y&&w.getHumanReadableKey(y))),T.default.createElement("div",{className:"key-opts-right"},d)),T.default.createElement("div",{className:"key-opts-ch-assign"},T.default.createElement("div",{className:"key-opts-left"},T.default.createElement("div",{className:"key-opts-ch-assign-label"},t.get("GUI:PressShortcut")),T.default.createElement(S.PressKeyInput,{key:h,onChange:e=>{o(e?i.getCommandType(e):void 0),c(e),g(void 0)},tooltip:t.get("STT:KeyboardEditEntry")}),T.default.createElement("div",{className:"key-opts-ch-assign-current"},T.default.createElement("div",null,t.get("GUI:CurAssignedTo")),T.default.createElement("div",null,n&&v.configurableCmds.has(n)?p(v.configurableCmds.get(n).label):""))),T.default.createElement("div",{className:"key-opts-right"},T.default.createElement("button",{className:"dialog-button",disabled:!s,onClick:()=>{if(s){if(l&&(l.shiftKey||l.ctrlKey||l.altKey||l.metaKey)){if(C.KeyboardHandler.anyModifierCommands.includes(s))return void g(t.get("Error:CannotMap"));var e=i.getCommandType({keyCode:l.keyCode,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(void 0!==e&&C.KeyboardHandler.anyModifierCommands.includes(e))return void g(t.get("Error:CannotRemap"))}r?.(s,l),o(void 0),c(void 0),u(h+1),g(void 0)}},"data-r-tooltip":t.get("STT:KeyboardButtonAssign")},t.get("GUI:Assign")),T.default.createElement("button",{className:"dialog-button",onClick:async()=>{a(void 0),o(void 0),c(void 0),g(void 0),await e?.(),u(h+1)},"data-r-tooltip":t.get("STT:KeyboardButtonResetAll")},t.get("GUI:ResetAll")))),T.default.createElement("fieldset",{className:"key-opts-ch-assign-warn"},T.default.createElement("legend",null,t.get("TS:Warning").toLocaleUpperCase()),t.get("TS:HotKeyFSWarning"))))})}}}),System.register("gui/screen/options/KeyboardScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/KeyOpts"],function(e,t){"use strict";var i,r,s,a;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("KeyboardScreen",a=class{constructor(e,t,i){this.strings=e,this.jsxRenderer=t,this.keyBinds=i,this.title=this.strings.get("GUI:KeyboardOptions")}setController(e){this.controller=e}onEnter(){this.isDirty=!1,this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.KeyOpts,props:{keyBinds:this.keyBinds,strings:this.strings,onHotKeyChange:(e,t)=>{this.keyBinds.changeHotKey(e,t),this.isDirty=!0},onResetAll:async()=>{try{await this.keyBinds.resetAndReload()}catch(e){console.error(e)}}}}));this.controller.setMainComponent(e)}async onLeave(){if(await this.controller.hideSidebarButtons(),this.isDirty){this.isDirty=!1;try{await this.keyBinds.save()}catch(e){console.error(e)}}}})}}}),System.register("gui/screen/mainMenu/component/Iframe",["react"],function(e,t){"use strict";var i;t&&t.id;return{setters:[function(e){i=e}],execute:function(){e("Iframe",({src:e,className:t})=>i.createElement("iframe",{src:e,className:t}))}}}),System.register("gui/screen/mainMenu/patchNotes/PatchNotesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/component/Iframe","gui/screen/mainMenu/MainMenuScreen"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends a.MainMenuScreen{constructor(e,t,i){super(),this.strings=e,this.jsxRenderer=t,this.patchNotesUrl=i,this.title=this.strings.get("TS:PatchNotes")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.Iframe,props:{src:this.patchNotesUrl,className:"patch-notes"}}));this.controller.setMainComponent(e)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("PatchNotesScreen",n)}}}),System.register("gui/screen/mainMenu/modSel/ModDetailsPane",["react","gui/screen/mainMenu/modSel/ModStatus"],function(e,t){"use strict";var c,i,h;t&&t.id;return{setters:[function(e){c=e},function(e){i=e}],execute:function(){h=new Map([[i.ModStatus.Installed,"GUI:ModStatusInstalled"],[i.ModStatus.UpdateAvailable,"GUI:ModStatusUpdateAvail"],[i.ModStatus.NotInstalled,"GUI:ModStatusNotInstalled"]]),e("ModDetailsPane",({modDetails:{supported:e,name:t,description:i,authors:r,version:s,website:a},modLoaded:n,modStatus:o,strings:l})=>c.createElement("div",{className:"mod-details"},c.createElement("table",null,c.createElement("tbody",null,c.createElement("tr",null,c.createElement("td",null,l.get("GUI:ModName"),":"),c.createElement("td",null,t)),c.createElement("tr",null,c.createElement("td",null,l.get("GUI:ModStatus"),":"),c.createElement("td",null,l.get(h.get(o)??"GUI:Unknown"),n?", "+l.get("GUI:ModLoaded"):"",e?"":", "+l.get("GUI:ModUnsupported"))),s&&c.createElement("tr",null,c.createElement("td",null,l.get("GUI:ModVersion"),":"),c.createElement("td",null,s)),i&&c.createElement("tr",null,c.createElement("td",null,l.get("GUI:ModDescription"),":"),c.createElement("td",{className:"mod-desc"},i)),r&&c.createElement("tr",null,c.createElement("td",null,l.get("GUI:ModAuthor"),":"),c.createElement("td",null,r.join(", "))),a&&c.createElement("tr",null,c.createElement("td",null,l.get("GUI:ModWebsite"),":"),c.createElement("td",null,c.createElement("a",{href:a,rel:"nofollow noopener",target:"_blank"},a)))))))}}}),System.register("gui/screen/mainMenu/modSel/ModSel",["react","gui/component/List","gui/screen/mainMenu/modSel/ModDetailsPane"],function(e,t){"use strict";var o,l,c;t&&t.id;return{setters:[function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("ModSel",({strings:i,mods:e,activeMod:r,selectedMod:s,onSelectMod:a})=>{const n=o.useRef(null);return o.useEffect(()=>{n.current?.scrollIntoView()},[]),o.default.createElement("div",{className:"mod-sel-form"},o.default.createElement(l.List,{title:i.get("GUI:SelectMod"),className:"mod-list"},e?e.map(e=>{var t=e.id===s?.id;return o.default.createElement(l.ListItem,{key:e.id,selected:t,innerRef:t?n:null,onClick:()=>a(e),onDoubleClick:()=>a(e,!0),style:{display:"flex"}},o.default.createElement("div",{className:"mod-name"},(e===r?" ":"")+e.name+(e.supported?"":` (${i.get("GUI:ModUnsupported").toUpperCase()})`)))}):o.default.createElement(l.ListItem,{style:{textAlign:"center"}},i.get("GUI:LoadingEx"))),s&&o.default.createElement(c.ModDetailsPane,{modLoaded:r===s,modStatus:s.status,modDetails:s.meta,strings:i}))})}}}),System.register("gui/screen/mainMenu/modSel/BadModArchiveError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("BadModArchiveError",i)}}}),System.register("gui/screen/mainMenu/modSel/DuplicateModError",[],function(e,t){"use strict";var i;t&&t.id;return{setters:[],execute:function(){i=class extends Error{},e("DuplicateModError",i)}}}),System.register("gui/screen/mainMenu/modSel/ModImporter",["util/time","data/vfs/IOError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/InvalidArchiveError","gui/screen/mainMenu/modSel/ModManager","gui/screen/mainMenu/modSel/ModMeta","gui/screen/mainMenu/modSel/BadModArchiveError","data/IniFile","gui/screen/mainMenu/modSel/DuplicateModError"],function(e,t){"use strict";var b,S,w,C,E,x,O,A,M,R;t&&t.id;return{setters:[function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e}],execute:function(){e("ModImporter",R=class R{constructor(e,t,i){this.strings=e,this.messageBoxApi=t,this.storage=i}async import(e,s,a,n){let o=this.strings,t=await SystemJS.import("7z-wasm"),i,r,l=await t({quit:(e,t)=>{i=e,r=t}});n(o.get("ts:import_loading_archive")),l.FS.chdir("/tmp");var c=e.name;try{var h=await e.arrayBuffer(),u=l.FS.open(c,"w+");l.FS.write(u,new Uint8Array(h),0,h.byteLength,0,!0),l.FS.close(u)}catch(e){if(e instanceof DOMException)throw new S.IOError(`File "${c}" could not be read (${e.name})`,{cause:e});throw e}if(n(o.get("ts:import_extracting_archive")),await b.sleep(100),l.callMain(["x","-ssc-","-x!*/",c,"*.*"]),i)throw 1===i?new w.ArchiveExtractionError("Archive extraction failed with code "+i,{cause:r}):new C.InvalidArchiveError("7-Zip exited with code "+i,{cause:r});l.FS.unlink(c);let d=l.FS.lookupPath(l.FS.cwd())["node"],g=Object.keys(d.contents),p=new x.ModMeta;var m,u=()=>{({node:d}=l.FS.lookupPath(l.FS.cwd())),g=Object.keys(d.contents);for(var e of g)l.FS.unlink(e)};let f=0;for(m of g)f+=l.FS.stat(m).size;if(this.storage?.estimate){c=await this.storage.estimate().catch(e=>{console.warn("Couldn't get storage estimate",[e])});if(c?.quota&&c.usage){c=c.quota-c.usage;if(c<f+1048576)return await this.messageBoxApi.alert(o.get("GUI:InstallModStorageFull",c/1024/1024,f/1024/1024),o.get("GUI:OK")),void u()}}try{let t=await s.listEntries(),i;if(g.includes(E.ModManager.modMetaFileName)){let e=this.readFileFromEmFs(l.FS,E.ModManager.modMetaFileName);try{p.fromIniFile(new A.IniFile(await e.text()))}catch(e){throw new O.BadModArchiveError("Mod meta file is invalid")}if(i=p.id,!a&&t.find(e=>e.toLowerCase()===i))throw new M.DuplicateModError(`A mod with the id "${p.id}" already exists`)}else{if(!g.some(e=>R.modFileExtensions.includes(d.contents[e].name.toLowerCase().split(".").pop())))throw new O.BadModArchiveError("Archive doesn't contain a valid mod");if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ImportModUnsupportedWarn"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return void u();if(i=await this.promptFolderName(t),!i)return void u();p.id=i,p.name=i}let r=await s.getOrCreateDirectory(i);for await(var y of r.getFileHandles())await r.deleteFile(y.name);for(var T of g){n(o.get("ts:import_importing",T));try{var v=this.readFileFromEmFs(l.FS,T);await r.writeFile(v)}catch(e){throw await s.deleteDirectory(r.name,!0),e}finally{l.FS.unlink(T)}}}finally{u()}return p}async promptFolderName(e){let t=this.strings,i;for(;;){if(i=await this.messageBoxApi.prompt(t.get("GUI:ImportModFolderPrompt"),t.get("GUI:Ok"),t.get("GUI:Cancel")),!i)return;if(i.match(E.ModManager.modIdRegex)){if(!e.some(e=>e.toLowerCase()===i))break;await this.messageBoxApi.alert(t.get("GUI:ImportModFolderExists"),t.get("GUI:Ok"))}else await this.messageBoxApi.alert(t.get("GUI:ImportModFolderBadName"),t.get("GUI:Ok"))}return i}readFileFromEmFs(e,t){try{e.chmod(t,448)}catch(e){if(44!==e.errno)throw e}var i=e.readFile(t);let r=e.stat(t);i=new Blob([i],{type:"application/octet-stream"});return new File([i],t.slice(t.lastIndexOf("/")+1),{lastModified:r.mtime.getTime()})}}),R.modFileExtensions=["ini","mix"]}}}),System.register("gui/screen/mainMenu/modSel/ModDownloadPrompt",["react"],function(e,t){"use strict";var a;t&&t.id;return{setters:[function(e){a=e}],execute:function(){e("ModDownloadPrompt",({url:e,sizeMb:t,isUpdate:i,strings:r,onClick:s})=>a.createElement("div",null,i&&a.createElement("p",{style:{marginTop:0}},r.get("GUI:ModUpdateAvail")),a.createElement("p",null,r.get("GUI:ManualDownloadModPrompt")),a.createElement("a",{href:e,rel:"nofollow noopener",target:"_blank",onClick:s},e),a.createElement("br",null),a.createElement("br",null),a.createElement("em",null,r.get("ts:gameres_download_size",t))))}}}),System.register("gui/screen/mainMenu/modSel/ModSelScreen",["react","gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","data/vfs/StorageQuotaError","gui/screen/mainMenu/MainMenuScreen","data/vfs/IOError","data/vfs/FileNotFoundError","gui/screen/mainMenu/modSel/ModSel","engine/Engine","engine/gameRes/FileSystemUtil","gui/screen/mainMenu/modSel/ModImporter","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","gui/screen/mainMenu/modSel/BadModArchiveError","gui/screen/mainMenu/modSel/DuplicateModError","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModStatus","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/modSel/ModDownloadPrompt"],function(e,t){"use strict";var s,i,r,a,n,u,o,l,c,h,d,g,p,m,f,y,T,v,b,S,w,C,E;t&&t.id;return{setters:[function(e){s=e},function(e){i=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){u=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){E=class extends l.MainMenuScreen{constructor(e,t,i,r,s,a,n,o,l,c,h){super(),this.rootController=e,this.strings=t,this.jsxRenderer=i,this.errorHandler=r,this.messageBoxApi=s,this.modManager=a,this.activeModId=n,this.modSdkUrl=o,this.modResourceLoader=l,this.fsAccessLib=c,this.sentry=h,this.title=this.strings.get("GUI:Mods"),this.disposables=new u.CompositeDisposable,this.handleSelectMod=async(t,e)=>{var i=this.selectedMod?.id!==t.id;this.selectedMod=t,i&&this.updateSidebarButtons(),this.form?.applyOptions(e=>{e.selectedMod=t}),e&&t!==this.activeMod&&t.status===S.ModStatus.Installed&&await this.loadOrUnloadMod(t)}}async onEnter(){this.availableMods=[],this.controller.toggleMainVideo(!1),this.initForm();var e=await this.loadAvailableMods();e&&(this.availableMods=e,this.activeMod=this.availableMods.find(e=>e.id===this.activeModId),this.selectedMod=this.activeMod,this.form.applyOptions(e=>{e.mods=this.availableMods,e.activeMod=this.activeMod,e.selectedMod=this.selectedMod}),this.initSidebar())}async loadAvailableMods(){try{var[e,t]=await Promise.all([this.modManager.listLocal(),this.modManager.listRemote().catch(e=>{console.warn("Failed to fetch remote mods",[e])})]);return await this.modManager.buildModList(e,t)}catch(e){return e instanceof c.IOError||e instanceof h.FileNotFoundError||e instanceof o.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load mod list (${e.name??e.message})`,{cause:e})),void this.handleError(e,this.strings.get("GUI:ModListError"))}}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(i.jsx(r.HtmlView,{innerRef:e=>this.form=e,component:d.ModSel,props:{strings:this.strings,mods:void 0,activeMod:void 0,selectedMod:void 0,onSelectMod:this.handleSelectMod}}))[0])}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){this.controller?.setSidebarButtons([{label:this.selectedMod&&this.selectedMod===this.activeMod?this.strings.get("GUI:UnloadMod"):this.selectedMod?.isInstalled()?this.strings.get("GUI:LoadMod"):this.strings.get("GUI:ModActionInstall"),disabled:!this.selectedMod,onClick:async()=>{var i=this.selectedMod;if(i.status===S.ModStatus.Installed||i===this.activeMod)await this.loadOrUnloadMod(i);else{var r=(i.meta.downloadSize||0)/1024/1024;if(i.meta.manualDownload){var e=i.status===S.ModStatus.UpdateAvailable,t=s.createElement(C.ModDownloadPrompt,{url:i.meta.download,sizeMb:r,isUpdate:e,strings:this.strings,onClick:()=>this.messageBoxApi.destroy()});e?await this.messageBoxApi.confirm(t,this.strings.get("GUI:Close"),this.strings.get("GUI:ModActionLoadAnyway"))||await this.loadOrUnloadMod(i):this.messageBoxApi.show(t,this.strings.get("GUI:Close"),()=>{})}else{let e=!1;if(i.status===S.ModStatus.UpdateAvailable){if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ModUpdateAvail")+"\n\n"+this.strings.get("GUI:UpdateModPrompt",i.latestVersion,r),this.strings.get("GUI:ModActionUpdate"),this.strings.get("GUI:ModActionLoadAnyway")))return void await this.loadOrUnloadMod(i);e=!0}else if(10<r&&!await this.messageBoxApi.confirm(this.strings.get("GUI:InstallModDownloadPrompt",r),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;let t;try{t=await this.downloadMod(i)}catch(e){return e instanceof w.OperationCanceledError?void 0:void this.errorHandler.handle(e,this.strings.get("GUI:DownloadFailed"),()=>{})}this.messageBoxApi.destroy();try{await this.importModFromFile(t,i.status===S.ModStatus.UpdateAvailable)}catch(e){return void this.handleModImportError(e)}e&&await this.loadOrUnloadMod(i)}}}},{label:this.strings.get("GUI:ImportMod"),tooltip:this.strings.get("STT:ImportMod"),onClick:async()=>{try{let t;try{let e=await p.FileSystemUtil.showArchivePicker(this.fsAccessLib);t=await e.getFile()}catch(e){if("AbortError"===e.name)return;if(e instanceof DOMException)throw new c.IOError(`File could not be read (${e.name})`,{cause:e});throw e}await this.importModFromFile(t,!1)}catch(e){return void this.handleModImportError(e)}}},{label:this.strings.get("GUI:UninstallMod"),tooltip:this.strings.get("STT:UninstallMod"),disabled:!(this.selectedMod?.isInstalled()&&this.activeMod!==this.selectedMod),onClick:async()=>{var e=this.selectedMod;if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmUninstallMod",e.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){this.messageBoxApi.show(this.strings.get("GUI:WorkingPleaseWait"));try{await this.modManager.deleteModFiles(e.id)}catch(e){var t=e instanceof o.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:UninstallModError");return void this.errorHandler.handle(e,t,()=>{})}finally{this.messageBoxApi.destroy()}t=await this.loadAvailableMods();t&&(this.availableMods=t,this.selectedMod=void 0,this.form?.applyOptions(e=>{e.mods=this.availableMods,e.selectedMod=void 0}),this.updateSidebarButtons())}}},{label:this.strings.get("GUI:BrowseMod"),tooltip:this.strings.get("STT:BrowseMod"),onClick:()=>{this.controller?.pushScreen(n.ScreenType.OptionsStorage,{startIn:g.Engine.rfsSettings.modDir+(this.selectedMod?.isInstalled()?"/"+this.selectedMod.id:"")})}},...this.modSdkUrl?[{label:this.strings.get("GUI:ModSDK"),tooltip:this.strings.get("STT:ModSDK"),onClick:()=>{window.open(this.modSdkUrl,"_blank")}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadOrUnloadMod(e){await this.controller?.hideSidebarButtons(),this.modManager.loadMod(e!==this.activeMod?e.id:void 0)}async downloadMod(e){var t=e.meta.download;if(!t)throw new Error("Mod meta is missing download");let i=new w.CancellationTokenSource;this.messageBoxApi.show(this.strings.get("TS:Downloading"),this.strings.get("GUI:Cancel"),()=>i.cancel());var r={id:"archive",src:t,type:"binary",sizeHint:e.meta.downloadSize};let s=await this.modResourceLoader.loadResources([r],i.token,e=>{this.messageBoxApi.updateText(this.strings.get("TS:DownloadingPg",e))});t=s.pop("archive");return new File([t],this.modResourceLoader.getResourceFileName(r))}async importModFromFile(e,t){this.messageBoxApi.show(this.strings.get("ts:import_preparing_for_import"));var i=e=>{this.messageBoxApi.updateText(e)};let r;try{r=await new m.ModImporter(this.strings,this.messageBoxApi,navigator.storage).import(e,this.modManager.getModDir(),t,i)}finally{this.messageBoxApi.destroy()}if(r){let t=new b.Mod(r,void 0);t&&(-1!==(i=this.availableMods.findIndex(e=>e.id===t.id))?this.availableMods.splice(i,1,t):this.availableMods.unshift(t),this.selectedMod=t,this.form?.applyOptions(e=>{e.mods=this.availableMods,e.selectedMod=t}),this.updateSidebarButtons())}}handleModImportError(e){let t=this.strings,i=t.get("GUI:ImportModError");e instanceof T.BadModArchiveError?i+="\n\n"+t.get("GUI:ImportModBadArchive"):e instanceof v.DuplicateModError?i+="\n\n"+t.get("GUI:ImportDuplicateModError"):e instanceof f.InvalidArchiveError?i+="\n\n"+t.get("ts:import_invalid_archive"):e instanceof y.ArchiveExtractionError?e.cause?.message?.match(/out of memory|allocation/i)?i+="\n\n"+t.get("ts:import_out_of_memory"):i+="\n\n"+t.get("ts:import_archive_extract_failed"):e.message?.match(/out of memory|allocation/i)?i+="\n\n"+t.get("ts:import_out_of_memory"):"QuotaExceededError"===e.name||e instanceof o.StorageQuotaError?i+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof c.IOError||e instanceof h.FileNotFoundError||this.sentry?.captureException(new Error("Mod import failed "+(e.message??e.name),{cause:e})),this.errorHandler.handle(e,i,()=>{})}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}async onLeave(){this.availableMods.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}handleError(e,t){this.errorHandler.handle(e,t,()=>{this.rootController.goToScreen(a.ScreenType.MainMenuRoot)})}},e("ModSelScreen",E)}}}),System.register("gui/screen/mainMenu/ladderRules/LadderRulesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/component/Iframe"],function(e,t){"use strict";var i,r,s,a,n;t&&t.id;return{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){a=e}],execute:function(){n=class extends s.MainMenuScreen{constructor(e,t,i){super(),this.strings=e,this.jsxRenderer=t,this.rulesUrl=i,this.title=this.strings.get("GUI:Rules")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:a.Iframe,props:{src:this.rulesUrl,className:"ladder-rules"}}));this.controller.setMainComponent(e)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("LadderRulesScreen",n)}}}),System.register("Gui",["react","engine/Engine","gui/UiScene","engine/gfx/Renderer","game/rules/Rules","gui/screen/RootController","gui/screen/mainMenu/MainMenuRootScreen","gui/screen/game/GameScreen","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","gui/screen/ScreenType","gui/component/MessageBoxApi","network/WolConnection","network/GservConnection","network/gameopt/Parser","network/gameopt/Serializer","engine/ResourceLoader","ErrorHandler","engine/UiAnimationLoop","util/Logger","tools/DevToolsApi","gui/jsx/JsxRenderer","gui/Pointer","engine/sound/Sound","engine/sound/AudioSystem","engine/sound/Mixer","engine/sound/SoundSpecs","engine/sound/ChannelType","LocalPrefs","gui/screen/game/worldInteraction/keyboard/KeyBinds","gui/ReplayManager","gui/screen/replay/ReplayScreen","data/vfs/FileNotFoundError","engine/sound/Music","engine/sound/MusicSpecs","gui/screen/game/GameLoader","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/gfx/RendererError","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMemStorage","data/vfs/StorageQuotaError","gui/CanvasMetrics","data/vfs/IOError","util/disposable/CompositeDisposable","gui/component/ToastApi","network/WolService","gui/screen/mainMenu/main/HomeScreen","gui/screen/mainMenu/lobby/SkirmishScreen","gui/screen/mainMenu/login/LoginScreen","gui/screen/mainMenu/newAccount/NewAccountScreen","gui/screen/mainMenu/customGame/CustomGameScreen","gui/screen/mainMenu/lobby/LobbyScreen","gui/screen/mainMenu/mapSel/MapSelScreen","gui/screen/replay/ReplaySelScreen","gui/screen/mainMenu/score/ScoreScreen","gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen","gui/screen/mainMenu/credits/CreditsScreen","gui/screen/options/OptionsScreen","gui/screen/options/SoundOptsScreen","gui/screen/options/KeyboardScreen","gui/screen/options/StorageScreen","gui/screen/mainMenu/patchNotes/PatchNotesScreen","gui/screen/game/gameMenu/GameMenuHomeScreen","gui/screen/game/gameMenu/DiploScreen","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/gameMenu/QuitConfirmScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/screen/game/MapFileLoader","gui/screen/mainMenu/modSel/ModSelScreen","gui/screen/mainMenu/modSel/ModManager","network/WGameResConnection","gui/screen/mainMenu/quickGame/QuickGameScreen","network/WLadderService","gui/screen/mainMenu/ladder/LadderScreen","network/WolConfig","gui/screen/mainMenu/ladderRules/LadderRulesScreen"],function(e,t){"use strict";var i,_,U,o,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee,l,te,c,ie,re,h,u,d,g,p,se,ae,ne,oe,le,m,f,ce,he,ue,de,ge,pe,me,fe,ye,Te,T,ve,be,Se,we,Ce,Ee,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,je,Ne,Le,De,Fe,_e,Ue,He,Ge,Ve,We,ze,Ke,qe,$e,Qe,Ze,r;t&&t.id;return{setters:[function(e){i=e},function(e){_=e},function(e){U=e},function(e){o=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e},function(e){ee=e},function(e){l=e},function(e){te=e},function(e){c=e},function(e){ie=e},function(e){re=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){se=e},function(e){ae=e},function(e){ne=e},function(e){oe=e},function(e){le=e},function(e){m=e},function(e){f=e},function(e){ce=e},function(e){he=e},function(e){ue=e},function(e){de=e},function(e){ge=e},function(e){pe=e},function(e){me=e},function(e){fe=e},function(e){ye=e},function(e){Te=e},function(e){T=e},function(e){ve=e},function(e){be=e},function(e){Se=e},function(e){we=e},function(e){Ce=e},function(e){Ee=e},function(e){xe=e},function(e){Oe=e},function(e){Ae=e},function(e){Me=e},function(e){Re=e},function(e){Pe=e},function(e){Ie=e},function(e){ke=e},function(e){Be=e},function(e){je=e},function(e){Ne=e},function(e){Le=e},function(e){De=e},function(e){Fe=e},function(e){_e=e},function(e){Ue=e},function(e){He=e},function(e){Ge=e},function(e){Ve=e},function(e){We=e},function(e){ze=e},function(e){Ke=e},function(e){qe=e},function(e){$e=e},function(e){Qe=e},function(e){Ze=e}],execute:function(){e("Gui",r=class{constructor(e,t,i,r,s,a,n,o,l,c,h,u,d,g,p,m,f,y){this.appVersion=e,this.engineVersion=t,this.engineModHash=i,this.gpuTier=r,this.config=s,this.gameResConfig=a,this.appResPath=n,this.localPrefs=o,this.generalOptions=l,this.rootEl=c,this.viewport=h,this.fullScreen=u,this.strings=d,this.cdnResourceLoader=g,this.fsAccessLib=p,this.serverRegions=m,this.runtimeVars=f,this.sentry=y,this.disposables=new T.CompositeDisposable,this.handleFullScreenChange=e=>{e&&this.pointer?.getUserLockMode()&&this.pointer.lock()},this.handleViewportChange=e=>{var t;this.renderer?.setViewportSize(e.width,e.height),this.uiScene&&(t=U.UiScene.createCamera(this.viewport.value),this.uiScene.setCamera(t),this.uiScene.setViewport(this.viewport.value),this.jsxRenderer?.setCamera(t),this.messageBoxApi?.updateViewport(this.viewport.value),this.rootController?.rerenderCurrentScreen(),this.canvasMetrics?.notifyViewportChange())}}getRootController(){if(!this.rootController)throw new Error("Root controller is not initialized");return this.rootController}async init(e){let t=this.strings,i,r;try{({renderer:i,uiAnimationLoop:r}=this.initRenderer(this.rootEl,this.viewport.value,this.config.devMode))}catch(e){if(e instanceof ge.RendererError)return console.error(e.cause),void alert(t.get("TS:RendererInitError"));throw e}this.renderer=i,this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(()=>this.viewport.onChange.unsubscribe(this.handleViewportChange)),this.fullScreen.onChange.subscribe(this.handleFullScreenChange),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(this.handleFullScreenChange));var s=this.gameResConfig;let a=U.UiScene.factory(this.viewport.value),n=this.canvasMetrics=new ye.CanvasMetrics(i.getCanvas(),window);n.init(),this.disposables.add(n);let o=this.pointer=re.Pointer.factory(_.Engine.getImages().get("mouse.shp"),_.Engine.getPalettes().get("mousepal.pal"),i,document,n,this.generalOptions.mouseAcceleration);o.init(),this.disposables.add(o),a.add(o.getSprite());var l=this.jsxRenderer=new ie.JsxRenderer(_.Engine.getImages(),_.Engine.getPalettes(),a.camera,o.pointerEvents);this.toastApi=new ve.ToastApi(this.viewport,a,l),this.disposables.add(this.toastApi),this.messageBoxApi=new $.MessageBoxApi(this.viewport.value,a,l);var c=new ee.ErrorHandler(this.messageBoxApi,t),h=new Y.Parser,u=new X.Serializer;let d=this.rootController=new G.RootController(this.serverRegions);var g=_.Engine.getMpModes(),p=_.Engine.getFileNameVariant("keyboard.ini");let m=new ae.KeyBinds(_.Engine.rfs?.getRootDirectory(),p,_.Engine.getIni(p));await m.load();var f=await _.Engine.getReplayDir().catch(e=>{console.error("Couldn't get replay directory",[e]),e instanceof fe.StorageQuotaError||e instanceof Te.IOError||e instanceof le.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get replay directory (${e.name})`,{cause:e}))}),y=f?new pe.ReplayStorageFileSystem(f,this.sentry):new me.ReplayStorageMemStorage,T=new ne.ReplayManager(y);let v=this.generalOptions;var b=new J.ResourceLoader(this.config.mapsBaseUrl),S=new J.ResourceLoader(this.appResPath),w=new J.ResourceLoader(this.config.modsBaseUrl),C=new Ge.MapFileLoader(b,_.Engine.vfs),E=te.AppLogger.get("net"),x=Qe.WolConfig.factory(this.config.wolv2Compat?Qe.ClientType.Yuri:Qe.ClientType.Cdral2),O=Q.WolConnection.factory(E);let A=new be.WolService(x,O,this.appVersion);A.init(),this.disposables.add(A);var M=new qe.WLadderService(x,E),R=_.Engine.getMapList(),P=await _.Engine.getModDir().catch(e=>{console.error("Couldn't get mods directory",[e]),e instanceof fe.StorageQuotaError||e instanceof Te.IOError||e instanceof le.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get mods directory (${e.name})`,{cause:e}))});let I=P?new We.ModManager(window.location,P,S):void 0;var k=_.Engine.getActiveMod(),B=k?await I?.loadModMeta(k):void 0,p=await _.Engine.getMapDir().catch(e=>{console.error("Couldn't get map dir",[e])}),f=te.AppLogger.get("ini");let j;try{j=new H.Rules(_.Engine.getRules(),f)}catch(e){if(k&&I)return console.error(e),i.addScene(a),this.uiScene=a,this.rootEl.appendChild(a.getHtmlContainer().getElement()),await this.messageBoxApi.alert(t.get("TS:ModLoadError"),t.get("GUI:Ok")),void I.loadMod(void 0);throw e}var{mixer:y,sound:b,music:x}=await this.initSound(j,s);let N=(new Map).set(K.ScreenType.Home,new Se.HomeScreen(t,this.fullScreen,this.appVersion,!(!_.Engine.rfs||!P),!_.Engine.getActiveMod()&&this.config.quickMatchEnabled)).set(K.ScreenType.Skirmish,new we.SkirmishScreen(this.config.botsEnabled,d,c,this.messageBoxApi,t,j,l,C,R,g,this.localPrefs)).set(K.ScreenType.Login,new Ce.LoginScreen(A,M,t,l,this.messageBoxApi,this.serverRegions,this.config.serversUrl,this.config.breakingNewsUrl,E,c,this.localPrefs,d)).set(K.ScreenType.NewAccount,new Ee.NewAccountScreen(A,M,t,l,this.messageBoxApi,this.serverRegions,c,this.localPrefs,d)).set(K.ScreenType.QuickGame,new Ke.QuickGameScreen(this.config.unrankedQueueEnabled,this.engineModHash,j,A,O,M,this.serverRegions,C,R,d,this.messageBoxApi,l,t,this.localPrefs,b,c)).set(K.ScreenType.Ladder,new $e.LadderScreen(M,l,c,t)).set(K.ScreenType.CustomGame,new xe.CustomGameScreen(this.engineModHash,t,O,A,M,l,b,this.serverRegions,R,c)).set(K.ScreenType.Lobby,new Oe.LobbyScreen(this.engineModHash,B,d,c,this.messageBoxApi,t,a,O,A,M,j,h,u,l,C,R,g,b,this.localPrefs)).set(K.ScreenType.MapSelection,new Ae.MapSelScreen(t,l,C,c,this.messageBoxApi,this.localPrefs,R,g,p,this.fsAccessLib,this.sentry)).set(K.ScreenType.ReplaySelection,new Me.ReplaySelScreen(this.engineVersion,this.engineModHash,k,this.config.oldClientsBaseUrl,d,t,l,c,this.messageBoxApi,T,a,j,this.sentry)).set(K.ScreenType.Score,new Re.ScoreScreen(t,l,this.messageBoxApi,this.localPrefs,this.config,M)).set(K.ScreenType.InfoAndCredits,new Pe.InfoAndCreditsScreen(t,this.config,this.messageBoxApi)).set(K.ScreenType.Credits,new Ie.CreditsScreen(t,l)).set(K.ScreenType.Options,new ke.OptionsScreen(t,l,v,this.localPrefs,this.fullScreen,!1,!!_.Engine.rfs)).set(K.ScreenType.OptionsSound,new Be.SoundOptsScreen(t,l,y,void 0,this.localPrefs)).set(K.ScreenType.OptionsKeyboard,new je.KeyboardScreen(t,l,m)).set(K.ScreenType.OptionsStorage,new Ne.StorageScreen(t,l,this.messageBoxApi,_.Engine.rfs));I&&N.set(K.ScreenType.ModSelection,new Ve.ModSelScreen(d,t,l,c,this.messageBoxApi,I,_.Engine.getActiveMod(),this.config.modSdkUrl,w,this.fsAccessLib,this.sentry)),this.config.patchNotesUrl&&N.set(K.ScreenType.PatchNotes,new Le.PatchNotesScreen(t,l,this.config.patchNotesUrl)),this.config.ladderRulesUrl&&N.set(K.ScreenType.LadderRules,new Ze.LadderRulesScreen(t,l,this.config.ladderRulesUrl));O=await this.getMainMenuVideoUrl(s,P),k=new V.MainMenuRootScreen(N,a,s,t,_.Engine.getImages(),l,O,this.cdnResourceLoader,b,x,this.sentry),M=new de.VxlGeometryCache(await _.Engine.getCacheDir(),_.Engine.getActiveMod());let L=new ue.VxlGeometryPool(M,v.graphics.models.value);v.graphics.models.onChange.subscribe(e=>{L.setModelQuality(e),L.clear(),L.clearStorage().catch(e=>console.warn("Couldn't clear VXL geocache",[e]))});w=window.CDWorkerHostLib,P=new he.BoxedVar(!1),O=new Map,M=te.AppLogger.get("action"),S=new ce.GameLoader(w,this.cdnResourceLoader,S,j,g,b,f,M,P,s,L,O,this.config.botsEnabled,this.runtimeVars.debugBotIndex),f=new Set;let D=new he.BoxedVar(Boolean(Number(this.localPrefs.getItem(se.StorageKey.TauntsEnabled)??"1")));const F=e=>{this.localPrefs.setItem(se.StorageKey.TauntsEnabled,String(Number(e)))};D.onChange.subscribe(F),this.disposables.add(()=>D.onChange.unsubscribe(F));g=(new Map).set(z.ScreenType.Home,new De.GameMenuHomeScreen(t,this.fullScreen)).set(z.ScreenType.Diplo,new Fe.DiploScreen(t,l,i,g,D,f)).set(z.ScreenType.ConnectionInfo,new _e.ConnectionInfoScreen(t,l)).set(z.ScreenType.QuitConfirm,new Ue.QuitConfirmScreen(t)).set(z.ScreenType.Options,new ke.OptionsScreen(t,l,v,this.localPrefs,this.fullScreen,!0,!1)).set(z.ScreenType.OptionsSound,new Be.SoundOptsScreen(t,l,y,x,this.localPrefs)).set(z.ScreenType.OptionsKeyboard,new je.KeyboardScreen(t,l,m)),y=Z.GservConnection.factory(E),E=ze.WGameResConnection.factory(E),s=new He.LoadingScreenApiFactory(j,t,a,l,s,y),P=new W.GameScreen(w,y,E,A,this.engineVersion,this.engineModHash,c,g,s,h,u,this.config,t,i,a,this.runtimeVars,this.messageBoxApi,this.toastApi,r,this.viewport,l,o,b,x,m,v,this.localPrefs,M,T,this.fullScreen,C,p,R,S,L,O,f,D,P,this.sentry),O=new oe.ReplayScreen(this.engineVersion,this.engineModHash,c,g,s,this.config,t,i,a,this.runtimeVars,this.messageBoxApi,r,this.viewport,l,o,b,x,m,v,M,this.fullScreen,C,S,L,O,()=>{void 0!==e?(window.close(),(async()=>{await this.destroy(),document.body.appendChild(document.createTextNode(t.get("GUI:ReplayWindowClose")))})()):d.goToScreen(q.ScreenType.MainMenuRoot)});d.addScreen(q.ScreenType.MainMenuRoot,k),d.addScreen(q.ScreenType.Game,P),d.addScreen(q.ScreenType.Replay,O),i.addScene(a),this.uiScene=a,this.rootEl.appendChild(a.getHtmlContainer().getElement()),await this.routeToInitialScreen(d,v,x,b,e,T)}async getMainMenuVideoUrl(e,t){let i,r=_.Engine.rfsSettings.menuVideoFileName;if(e.isCdn())i=e.getCdnBaseUrl()+r.replace(".webm",".mp4");else try{let e;t&&await t.containsEntry(r)&&(e=await t.getRawFile(r)),!e&&await _.Engine.rfs?.containsEntry(r)&&(e=await _.Engine.rfs.getRawFile(r)),!e&&_.Engine.vfs?.fileExists(r)&&(e=_.Engine.vfs.openFile(r).asFile()),i=e?new File([e],e.name,{type:"video/webm"}):(console.warn("Main menu video file not found in browser FS"),"")}catch(e){console.error("Failed to read video file from browser FS"),i=""}return i}async routeToInitialScreen(e,t,i,r,s,a){let n=!1;var o=this.localPrefs.getItem(se.StorageKey.LastConnection);let l;if(o)try{l=JSON.parse(o)}catch(e){console.error(`Unable to decode game params string "${o}"`)}if(l){var c=await this.messageBoxApi.confirm(this.strings.get("TS:ReconnectPrompt"),this.strings.get("TS:Reconnect"),this.strings.get("GUI:Quit"));if(n=!0,c)return l.create=!1,void e.goToScreen(q.ScreenType.Game,l);this.localPrefs.removeItem(se.StorageKey.LastConnection)}o=this.gpuTier;void 0!==o&&(c=this.localPrefs.getItem(se.StorageKey.LastGpuTier),2<=o?void 0!==c&&Number(c)!==o&&(await this.confirmHighGfxSettings()&&(t.graphics.applyHighPreset(),this.localPrefs.setItem(se.StorageKey.Options,t.serialize())),n=!0):(void 0===c||2<=Number(c))&&(await this.confirmLowGfxSettings()&&(t.graphics.applyLowPreset(),this.localPrefs.setItem(se.StorageKey.Options,t.serialize())),n=!0),this.localPrefs.setItem(se.StorageKey.LastGpuTier,""+o)),i&&!n&&(!r.audioSystem.isSuspended()&&await r.audioSystem.canAutoPlay()||await this.messageBoxApi.alert(this.strings.get("GUI:RequestAudioPermission"),this.strings.get("GUI:OK")));let h;if(void 0!==s)try{let e=await a.loadList();var u=e.find(e=>e.id===s);if(!u)throw new Error(`Replay ID "${s}" not found`);h=await a.loadReplay(u)}catch(e){await this.messageBoxApi.alert(this.strings.get("GUI:ReplayError"),this.strings.get("GUI:Ok"))}h?e.goToScreen(q.ScreenType.Replay,{replay:h}):e.goToScreen(q.ScreenType.MainMenuRoot)}async confirmLowGfxSettings(){return await this.messageBoxApi.confirm(i.default.createElement("div",{dangerouslySetInnerHTML:{__html:this.strings.get("TS:RendererWarning").replace(/\n/g,"<br />").replace("{link}",'<a href="https://www.windowsdigitals.com/force-chrome-firefox-game-to-use-nvidia-gpu-integrated-graphics/" target="_blank" rel="noreferrer noopener">').replace("{/link}","</a>")}}),this.strings.get("TS:RendererUseLow"),this.strings.get("TS:RendererIgnore"))}async confirmHighGfxSettings(){return await this.messageBoxApi.confirm(this.strings.get("TS:RendererChangeDesc"),this.strings.get("GUI:Yes"),this.strings.get("GUI:No"))}initRenderer(t,e,i){var{width:r,height:s}=e;let a=new o.Renderer(r,s);a.init(t),this.disposables.add(a),c.DevToolsApi.registerVar("fps",this.runtimeVars.fps),this.disposables.add(()=>c.DevToolsApi.unregisterVar("fps")),this.runtimeVars.fps.onChange.subscribe(e=>{e?a.initStats(t):a.destroyStats()}),i&&(this.runtimeVars.fps.value=!0),this.runtimeVars.fps.value&&a.initStats(t);let n=new l.UiAnimationLoop(a);return n.start(),this.disposables.add(n),t.addEventListener("contextmenu",e=>{"A"===e.target.nodeName&&e.target.href.length||e.preventDefault()}),i||window.addEventListener("beforeunload",e=>{this.rootController?.getCurrentScreen()?.preventUnload&&(e.preventDefault(),e.returnValue="")}),a.getCanvas().addEventListener("mousedown",e=>{e.preventDefault()}),{renderer:a,uiAnimationLoop:n}}async initSound(e,t){let i;var r=this.localPrefs.getItem(se.StorageKey.Mixer);if(r)try{i=(new d.Mixer).unserialize(r)}catch(e){console.warn("Failed to read mixer values from local storage",[e])}i||(i=new d.Mixer,i.setVolume(p.ChannelType.Master,.4),i.setVolume(p.ChannelType.CreditTicks,.2),i.setVolume(p.ChannelType.Music,.3),i.setVolume(p.ChannelType.Ambient,.3));let s=new h.Sound(new u.AudioSystem(i),_.Engine.getSounds(),new g.SoundSpecs(_.Engine.getIni("sound.ini")),e.audioVisual,document);s.initialize(),this.disposables.add(s);let a;try{a=!!await _.Engine.rfs?.containsEntry(_.Engine.rfsSettings.musicDir)}catch(e){console.error("Couldn't get music directory",[e]),e instanceof fe.StorageQuotaError||e instanceof Te.IOError||e instanceof le.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get music directory (${e.name})`,{cause:e})),a=!1}let n;if(a){n=new m.Music(s.audioSystem,_.Engine.getThemes(),new f.MusicSpecs(_.Engine.getIni(_.Engine.getFileNameVariant("theme.ini")))),this.disposables.add(n);r=this.localPrefs.getItem(se.StorageKey.MusicOpts);if(r)try{n.unserializeOptions(r)}catch(e){console.warn("Failed to read music options from local storage",[e])}}return{mixer:i,sound:s,music:n}}async destroy(){this.messageBoxApi&&(this.messageBoxApi.destroy(),this.messageBoxApi=void 0),this.rootController&&(await this.rootController.leaveCurrentScreen(),this.rootController.destroy()),this.uiScene&&(this.rootEl.removeChild(this.uiScene.getHtmlContainer().getElement()),this.uiScene.destroy()),this.disposables.dispose()}})}}}),System.register("Application",["fontfaceobserver","detect-gpu","@puzzl/core/lib/async/cancellation","engine/Engine","gui/component/SplashScreen","network/WolConnection","network/gameopt/Parser","Config","util/Routing","tools/LobbyFormTester","tools/VxlTester","tools/ShpTester","tools/BuildingTester","data/IniFile","util/time","engine/ResourceLoader","ConsoleVars","util/Logger","tools/DevToolsApi","tools/VehicleTester","tools/InfantryTester","tools/AircraftTester","tools/SoundTester","LocalPrefs","gui/FullScreen","version","data/Strings","network/ServerRegions","gui/screen/options/GeneralOptions","engine/gameRes/GameResConfig","gui/component/BasicErrorBoxApi","engine/gameRes/GameRes","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/NoStorageError","data/MapFile","gui/component/ImageContext","util/BoxedVar","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMigration","data/vfs/StorageQuotaError","Gui","data/vfs/IOError","network/WolService","data/vfs/FileNotFoundError","RouteHelper","data/CsfFile","util/Sentry","engine/gameRes/importError/NoWebAssemblyError","network/WolConfig"],function(e,t){"use strict";var h,i,s,u,d,c,g,r,a,n,o,p,m,l,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee;t&&t.id;return{setters:[function(e){h=e},function(e){i=e},function(e){s=e},function(e){u=e},function(e){d=e},function(e){c=e},function(e){g=e},function(e){r=e},function(e){a=e},function(e){n=e},function(e){o=e},function(e){p=e},function(e){m=e},function(e){l=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e}],execute:function(){e("Application",ee=class ee{constructor(){this.viewport=new H.BoxedVar({x:0,y:0,width:0,height:0})}getVersion(){return A.version}getEngineVersion(){return u.Engine.getVersion()}getEngineModHash(){return u.Engine.getModHash()}async main(){try{await this.loadConfig()}catch(e){return void console.error("Missing config.ini. Please see README.md")}var t=this.config.defaultLanguage;let i;try{i=await this.loadTranslations(t)}catch(e){return void console.error(`Missing translation ${t}.`,e)}let r=new M.Strings(i);try{this.checkGlobalLibs()}catch(e){return console.error(e),void alert(r.get("TS:DownloadFailed"))}this.localPrefs=new x.LocalPrefs(localStorage);var s=document.getElementById("ra2web-root");if(!s)throw new Error("Missing root element");this.rootEl=s,this.runtimeVars=new T.ConsoleVars,b.DevToolsApi.registerCommand("help",()=>{console.info("Available commands: "),[...b.DevToolsApi.listCommands()].forEach(e=>console.info("> "+e)),console.info("Available variables: "),[...b.DevToolsApi.listVars()].forEach(e=>console.info("> "+e))}),b.DevToolsApi.registerVar("freecamera",this.runtimeVars.freeCamera),this.runtimeVars.forceResolution.onChange.subscribe(e=>{var t,i;e?.match(/^\d+x\d+$/)&&([t,i]=e?.split("x").map(Number),this.setPreferredViewportSize({width:t,height:i}))}),b.DevToolsApi.registerVar("forcesize",this.runtimeVars.forceResolution),b.DevToolsApi.registerVar("debug_wireframes",this.runtimeVars.debugWireframes),b.DevToolsApi.registerVar("debug_paths",this.runtimeVars.debugPaths),b.DevToolsApi.registerVar("debug_text",this.runtimeVars.debugText),b.DevToolsApi.registerVar("debug_bot",this.runtimeVars.debugBotIndex),await this.initLogging(),this.fullScreen=new O.FullScreen(document),this.fullScreen.init(),this.fullScreen.onChange.subscribe(e=>{this.onFullScreenChange(e),this.updateViewportSize(e)}),window.addEventListener("resize",()=>this.updateViewportSize(this.fullScreen.isFullScreen())),this.updateViewportSize(this.fullScreen.isFullScreen());let a=new d.SplashScreen(this.viewport.value.width,this.viewport.value.height);this.splashScreen=a,a.render(this.rootEl),a.setLoadingText(r.get("GUI:LoadingEx")),a.setCopyrightText(r.get("TXT_COPYRIGHT")+"\n"+r.get("GUI:WWBrand")),a.setDisclaimerText(r.get("TS:Disclaimer"));var e=f.sleep(this.config.devMode?0:5e3);this.loadGpuBenchmarkData().then(e=>this.gpuTier=e).catch(e=>this.sentry?.captureException(e));let n;try{n=this.fsAccessLib=await SystemJS.import("file-system-access")}catch(e){return console.error(e),a.setLoadingText(""),a.setBackgroundImage(""),void this.handleGameResLoadError(new y.DownloadError("Failed to download fsa lib",{cause:e}),r,!0)}var o=new URLSearchParams(location.search).get(Q.RouteHelper.modQueryStringName)||void 0;let l=this.loadGameResConfig(this.localPrefs);try{let{configToPersist:e,cdnResLoader:t}=await new B.GameRes(this.getVersion(),o,n,this.localPrefs,r,s,a,this.viewport,this.config,ee.resPath,this.sentry).init(l,(e,t)=>this.handleGameResLoadError(e,t),(e,t)=>this.handleGameResImportError(e,t));e&&(e.isCdn()?this.localPrefs.removeItem(x.StorageKey.GameRes):this.localPrefs.setItem(x.StorageKey.GameRes,e.serialize()),l=e),this.cdnResourceLoader=t}catch(e){return console.error(e),a.setLoadingText(""),a.setBackgroundImage(""),void this.handleGameResLoadError(e,r,!0)}this.gameResConfig=l,window.gtag?.("event","app_init",{res:this.gameResConfig.source,modName:u.Engine.getActiveMod()||"<none>"}),U.ImageContext.cdnBaseUrl=this.gameResConfig.isCdn()?this.gameResConfig.getCdnBaseUrl():void 0,U.ImageContext.vfs=u.Engine.vfs;try{let e=new Z.CsfFile(u.Engine.vfs.openFile(u.Engine.getFileNameVariant("ra2.csf")));var c=e.getIsoLangCode();if(void 0!==c&&c!==t)try{i=await this.loadTranslations(c)}catch(e){console.warn(`Failed to load translation ${c}. Falling back to ${t}.`,e)}r=this.strings=new M.Strings(e),r.fromJson(i),u.Engine.loadRules(),this.sentry?.configureScope(e=>{e.setTag("mod",u.Engine.getActiveMod()),e.setExtra("mod",u.Engine.getActiveMod()||"<none>"),e.setExtra("modHash",u.Engine.getModHash())}),window.AudioContext||(window.AudioContext=(await SystemJS.import("web-audio-polyfill.js")).AudioContext)}catch(e){return console.error(e),a.setLoadingText(""),a.setBackgroundImage(""),void this.handleGameResLoadError(e,r,!0)}try{await new h.default("Fira Sans Condensed").load(),await new h.default("Fira Sans Condensed",{weight:"bold"}).load()}catch(e){console.error("Failed to load font",e)}try{await this.migrateReplayStorage(this.localPrefs,a,r)}catch(e){a.setLoadingText(""),e instanceof W.StorageQuotaError||e instanceof K.IOError||e instanceof $.FileNotFoundError||this.sentry?.captureException(new Error("Failed to migrate replays to new storage",{cause:e})),console.error("Failed to migrate replays to new storage",e)}await e,a.destroy(),this.splashScreen=void 0,this.initRouting()}async loadTranslations(e){return await new y.ResourceLoader(ee.resPath).loadJson(`locale/${e}.json?v=`+this.getVersion())}checkGlobalLibs(){var t,i;for([t,i]of new Map([["CDWorkerHostLib",()=>window.CDWorkerHostLib],["THREE",()=>window.THREE],["Octree",()=>window.Octree],["SimplexNoise",()=>window.SimplexNoise],["LightningStrike",()=>window.THREE.LightningStrike],["TrailRenderer",()=>window.THREE.TrailRenderer],["SPE",()=>window.SPE],["GrowingPacker",()=>window.GrowingPacker],["lzo1x",()=>window.lzo1x]])){let e=!1;try{void 0!==i()&&(e=!0)}catch(e){}if(!e)throw new Error(`Library "${t}" was not found on window scope`)}}async loadConfig(){let e=await new y.ResourceLoader("").loadText("config.ini");if(e.startsWith("<"))throw new Error("Config download failed. Response looks like an HTML document.");var t=(new l.IniFile).fromString(e);this.config=new r.Config,this.config.load(t)}async initLogging(){v.AppLogger.useDefaults(),b.DevToolsApi.registerVar("debug_logging",this.runtimeVars.debugLogging);var e=e=>{var t;if("string"!=typeof e)v.AppLogger.setLevel(Boolean(e)?v.AppLogger.DEBUG:v.AppLogger.INFO);else for(t of e.split(","))v.AppLogger.get(t).setLevel(v.AppLogger.DEBUG)};e(this.runtimeVars.debugLogging.value),this.runtimeVars.debugLogging.onChange.subscribe(e);e=this.config.sentry;if(e)try{this.sentry=new Y.Sentry,await this.sentry.init(e,this.getVersion())}catch(e){console.error(e)}}loadGameResConfig(e){var t=e.getItem(x.StorageKey.GameRes);if(t){let e=new I.GameResConfig(this.config.gameresBaseUrl??"");return e.unserialize(t),e.isCdn()&&!e.getCdnBaseUrl()?void 0:e}}async handleGameResLoadError(e,t,i=!1){let r=new k.BasicErrorBoxApi(this.viewport,t,this.rootEl),s=t.get("ts:import_load_files_failed");e instanceof D.ChecksumError?s+="\n\n"+t.get("ts:import_checksum_mismatch",e.file):e instanceof j.FileNotFoundError?s+="\n\n"+t.get("ts:import_file_not_found",e.file):e instanceof y.DownloadError||e.message?.match(/XHR error|Failed to fetch/i)?s+="\n\n"+t.get("ts:downloadfailed"):e instanceof F.NoStorageError?s+="\n\n"+t.get("ts:import_no_storage"):e.message?.match(/out of memory|allocation/i)?s+="\n\n"+t.get("ts:gameinitoom"):"QuotaExceededError"===e.name||e instanceof W.StorageQuotaError?s+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof K.IOError?(s+="\n\n"+t.get("ts:storage_io_error"),i=!0):e instanceof $.FileNotFoundError||this.sentry?.captureException(new Error(`Game res load failed (${e.message??e.name})`,{cause:e})),await r.show(s,i)}async handleGameResImportError(e,t){let i=new k.BasicErrorBoxApi(this.viewport,t,this.rootEl),r=t.get("ts:import_failed");e instanceof j.FileNotFoundError?r+="\n\n"+t.get("ts:import_file_not_found",e.file):e instanceof N.InvalidArchiveError?r+="\n\n"+t.get("ts:import_invalid_archive"):e instanceof L.ArchiveExtractionError?e.cause?.message?.match(/out of memory|allocation/i)?r+="\n\n"+t.get("ts:import_out_of_memory"):(r+="\n\n"+t.get("ts:import_archive_extract_failed"),this.sentry?.captureException(new Error(`Game res import failed (${e.message??e.name})`,{cause:e}))):e instanceof X.NoWebAssemblyError?r+="\n\n"+t.get("ts:import_no_web_assembly"):e instanceof D.ChecksumError?r+="\n\n"+t.get("ts:import_checksum_mismatch",e.file):e instanceof y.DownloadError||e.message?.match(/XHR error|Failed to fetch|CompileError: WebAssembly|SystemJS/i)?r+="\n\n"+t.get("ts:downloadfailed"):e instanceof F.NoStorageError?r+="\n\n"+t.get("ts:import_no_storage"):e.message?.match(/out of memory|allocation/i)?r+="\n\n"+t.get("ts:import_out_of_memory"):"QuotaExceededError"===e.name||e instanceof W.StorageQuotaError?r+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof K.IOError||e instanceof $.FileNotFoundError||this.sentry?.captureException(new Error("Game res import failed "+(e.message??e.name),{cause:e})),await i.show(r)}async loadGpuBenchmarkData(){let r=!1;var e=await i.getGPUTier({override:{loadBenchmarks:async t=>{let i=new s.CancellationTokenSource;var e=setTimeout(()=>i.cancel(),5e3);try{let e=await new y.ResourceLoader("").loadJson("https://unpkg.com/detect-gpu@3.0.0/dist/benchmarks/"+t,i.token);return e.shift(),e}catch(e){throw r=!0,e}finally{clearTimeout(e)}}}});return r?void 0:e.tier}async migrateReplayStorage(e,t,i){var r,s=await u.Engine.getReplayDir();s&&(r=new G.ReplayStorageFileSystem(s,this.sentry),await new V.ReplayStorageMigration(t,i,s,e,r).migrate())}initRouting(){let e=new a.Routing,l;e.addRoute("*",async()=>{l&&await l.destroy()}),e.addRoute("/",async()=>{var e=new R.ServerRegions;this.gui=await this.initGui(e,this.strings),l=this}),e.addRoute("/game",async i=>{let r=new R.ServerRegions;if(this.gui=await this.initGui(r,this.strings),this.gui){let t=this.gui.getRootController();if(l=this,await f.sleep(1e3),i.length<2){var[s]=i;if(s){var a=decodeURIComponent(`0,0,0,10000,10,1,0,0,0,0,1,0,0,8,0,374465,${s},DFr2T1EU7PlayAbdzMaSX/f4j+E=:Player1,-2,-2,-2,-2,0,0,0,Player2,-2,-2,-2,-2,0,0,0:@:0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,`);let e=(new g.Parser).parseOptions(decodeURIComponent(a));e.gameSpeed=5,e.mcvRepacks=!0,e.gameMode=4,t.createGame(0,Date.now(),"Player1",e,!0,!1)}}else{var n=c.WolConnection.factory(v.AppLogger.get("net")),o=J.WolConfig.factory(this.config.wolv2Compat?J.ClientType.Yuri:J.ClientType.Cdral2);let e=new q.WolService(o,n,this.getVersion());r.load(await e.loadServerList(this.config.serversUrl));s=this.localPrefs.getItem(x.StorageKey.PreferredServerRegion),a=s&&r.isAvailable(s)?r.get(s):r.getFirstAvailable();r.setSelectedRegion(a.id);var[o,n,s,a]=i,o=Number(o),a=Boolean(Number(a||0));s?(s=(new g.Parser).parseOptions(decodeURIComponent(s)),t.createGame(o,0,n,s,!1,a)):t.joinGame(o,0,n,a)}}}),e.addRoute("/replay",async e=>{l=this;var[t]=e,i=new R.ServerRegions;this.gui=await this.initGui(i,this.strings,void 0!==t?t:void 0)}),e.addRoute("/lobbytest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");n.LobbyFormTester.main(this.rootEl,this.strings),l=n.LobbyFormTester}),e.addRoute("/vxltest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");o.VxlTester.main(u.Engine.vfs,this.runtimeVars),l=o.VxlTester}),e.addRoute("/shptest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");var e=new _.MapFile(u.Engine.vfs.openFile("mp03t4.map"));p.ShpTester.main(u.Engine.vfs,e,this.rootEl,this.strings),l=p.ShpTester}),e.addRoute("/buildtest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");m.BuildingTester.main(this.runtimeVars),l=m.BuildingTester}),e.addRoute("/vehicletest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");S.VehicleTester.main(this.runtimeVars),l=S.VehicleTester}),e.addRoute("/airtest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");C.AircraftTester.main(this.runtimeVars),l=C.AircraftTester}),e.addRoute("/inftest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");w.InfantryTester.main(this.runtimeVars),l=w.InfantryTester}),e.addRoute("/soundtest",async()=>{if(!u.Engine.vfs)throw new Error("Original game files must be provided.");E.SoundTester.main(u.Engine.vfs,this.runtimeVars),l=E.SoundTester}),e.init()}async initGui(e,i,t){var r=this.localPrefs.getItem(x.StorageKey.Options);let s;if(r)try{s=(new P.GeneralOptions).unserialize(r)}catch(e){console.warn("Couldn't read options from local storage",[e])}s||(s=new P.GeneralOptions,s.graphics.resolution.value={width:this.config.viewport.width,height:this.config.viewport.height}),this.setPreferredViewportSize(s.graphics.resolution.value),s.graphics.resolution.onChange.subscribe(e=>{this.setPreferredViewportSize(e)});let a=new z.Gui(this.getVersion(),this.getEngineVersion(),this.getEngineModHash(),this.gpuTier,this.config,this.gameResConfig,ee.resPath,this.localPrefs,s,this.rootEl,this.viewport,this.fullScreen,i,this.cdnResourceLoader,this.fsAccessLib,e,this.runtimeVars,this.sentry);try{await a.init(t)}catch(e){console.error("Failed to initialize GUI",[e]);let t;return e instanceof W.StorageQuotaError||e instanceof K.IOError||e instanceof $.FileNotFoundError?t=i.get("TS:GUIInitFSError"):(t=i.get("TS:GUIInitUnknownError"),this.sentry?.captureException(new Error(`Failed to initialize GUI (${e.name})`,{cause:e}))),void alert(t)}return a}setPreferredViewportSize(e){this.config.viewport.width=e?.width??Number.POSITIVE_INFINITY,this.config.viewport.height=e?.height??Number.POSITIVE_INFINITY,this.updateViewportSize(this.fullScreen.isFullScreen())}onFullScreenChange(e){navigator.keyboard&&(e?navigator.keyboard.lock(["Escape",...this.config.devMode?[]:["F5","F12"],"F11"])?.catch?.(e=>console.warn("Keyboard lock failed",e)):navigator.keyboard.unlock())}updateViewportSize(e){let t,i;i=e?(t=window.innerWidth,window.innerHeight):(t=Math.min(window.innerWidth,this.config.viewport.width),Math.min(window.innerHeight,this.config.viewport.height)),t=Math.max(800,t-t%2),i=Math.max(600,i-i%2),this.setViewportSize(t,i),this.splashScreen?.setSize(t,i)}setViewportSize(e,t){this.viewport.value={x:this.viewport.value.x,y:this.viewport.value.y,width:e,height:t}}async destroy(){await this.gui?.destroy(),this.gui=void 0,this.splashScreen&&(this.splashScreen.destroy(),this.splashScreen=void 0)}}),ee.resPath="res/"}}}),System.register("main",["Application"],function(e,t){"use strict";var i,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){r=new i.Application,document.body?r.main():document.addEventListener("DOMContentLoaded",()=>{r.main()})}}}),System.register("engine/gfx/material/PaletteLambertMaterial",["engine/gfx/material/paletteShaderLib"],function(e,t){"use strict";var i,a,r;t&&t.id;return{setters:[function(e){i=e}],execute:function(){a={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,i.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshlambert_vert.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+i.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshlambert_frag.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+i.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+i.paletteShaderLib.paletteFullLightFragment)},r=class extends THREE.MeshLambertMaterial{constructor({palette:e,paletteCount:t,paletteOffset:i,extraLight:r,...s}={}){super(s),this.uniforms=THREE.UniformsUtils.clone(a.uniforms),e&&(this.palette=e),t&&(this.paletteCount=t),i&&(this.paletteOffset=i),r&&this.extraLight.copy(r),this.vertexShader=a.vertexShader,this.fragmentShader=a.fragmentShader,this.type="PaletteLambertMaterial"}get palette(){return this.uniforms.palette.value}set palette(e){this.uniforms.palette.value=e}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(e){this.uniforms.paletteOffsetCount.value[0]=e}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(e){this.uniforms.paletteOffsetCount.value[1]=e}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(e){this.uniforms.extraLight.value=e}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.palette=e.palette,this}},e("PaletteLambertMaterial",r)}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryCulledBuilder",["engine/gfx/BufferGeometryUtils"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("VxlGeometryCulledBuilder",i=class{build(e){let{voxels:a,voxelField:n}=e.getAllVoxels(),t=new THREE.BoxBufferGeometry(1,1,1);var o=t.getAttribute("position").array,l=o.length/3,c=t.getAttribute("normal").array,h=t.getIndex().array;let u=[],d=[],g=[],p=[];var m=e.minBounds,f=e.scale,y=e.getNormals();let T=0;for(let E=0,r=a.length;E<r;E++){var v=a[E],b=y[Math.min(a[E].normalIndex,y.length-1)];let e=new Array(l);for(let t=0,i=3*l;t<i;t+=3)n.get(v.x+c[t],v.y+c[t+1],v.z+c[t+2])||(e[t/3]=T,u.push(m.x+v.x*f.x+o[t],m.y+v.y*f.y+o[t+1],m.z+v.z*f.z+o[t+2]),d.push(b.x,b.y,b.z),g.push(v.colorIndex/255,0,0),T++);for(let r=0,s=h.length;r<s;r+=3){var S=e[h[r]],w=e[h[r+1]],C=e[h[r+2]];void 0!==S&&void 0!==w&&void 0!==C&&p.push(S,w,C)}}let i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(new Uint32Array(p),1)),i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(u),3)),i.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(g),3)),i=s.BufferGeometryUtils.mergeVertices(i),i.computeBoundingBox(),i}})}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryNaiveBuilder",["engine/gfx/BufferGeometryUtils"],function(e,t){"use strict";var o,i;t&&t.id;return{setters:[function(e){o=e}],execute:function(){e("VxlGeometryNaiveBuilder",i=class{build(e){var{voxels:t,voxelField:i}=e.getAllVoxels();let r=new THREE.BoxBufferGeometry(1,1,1);var s=r.getAttribute("position").array.length/3,a=r.getAttribute("normal").array;let n=new THREE.BufferGeometry;return n.setIndex(this.createIndexAttr(t,r,s)),n.addAttribute("position",this.createPositionAttr(e,t,r)),n.addAttribute("normal",this.createNormalAttr(e,t,s)),n.addAttribute("color",this.createColorAttr(t,s,a,i)),n=o.BufferGeometryUtils.mergeVertices(n),n.computeBoundingBox(),n}createPositionAttr(e,i,t){var r=t.getAttribute("position").array,s=r.length;let a=new Float32Array(r.length*i.length);var n=e.minBounds,o=e.scale;for(let h=0,u=i.length;h<u;h++){var l=h*s,c=i[h];for(let e=0,t=r.length;e<t;e+=3)a[l+e]=n.x+c.x*o.x+r[e],a[l+e+1]=n.y+c.y*o.y+r[e+1],a[l+e+2]=n.z+c.z*o.z+r[e+2]}return new THREE.BufferAttribute(a,3)}createNormalAttr(e,i,r){let s=new Float32Array(r*i.length*3);var a=e.getNormals();for(let l=0,t=i.length;l<t;l++){var n=l*r*3,o=a[Math.min(i[l].normalIndex,a.length-1)];for(let e=0,t=3*r;e<t;e+=3)s[n+e]=o.x,s[n+e+1]=o.y,s[n+e+2]=o.z}return new THREE.BufferAttribute(s,3)}createColorAttr(i,r,s,a){let n=new Float32Array(r*i.length*3);for(let h=0,e=i.length;h<e;h++){var o=h*r*3,l=i[h];for(let e=0,t=3*r;e<t;e+=3){var c=a.get(l.x+s[e],l.y+s[e+1],l.z+s[e+2]);n[o+e]=c?0:l.colorIndex/255,n[o+e+1]=0,n[o+e+2]=0}}return new THREE.BufferAttribute(n,3)}createIndexAttr(i,e,r){var s=e.getIndex().array;let a=new Uint32Array(i.length*s.length);for(let n=0,o=i.length;n<o;n++)for(let e=0,t=s.length;e<t;e++)a[n*t+e]=n*r+s[e];return new THREE.BufferAttribute(a,1)}})}}}),System.register("network/Logger",[],function(e,t){"use strict";t&&t.id;return{setters:[],execute:function(){}}}),System.register("network/WLadderTransportTcpSocket",["net"],function(e,t){"use strict";var s,i;t&&t.id;return{setters:[function(e){s=e}],execute:function(){e("WLadderTransportTcpSocket",i=class{constructor(e,t,i){this.host=e,this.port=t,this.logger=i}async sendCommand(r){return new Promise((i,t)=>{this.logger.debug("Connecting to WLadder server...");let e=s.connect({host:this.host,port:this.port,timeout:5e3},()=>{e.write(r+"\r\n"),this.logger.debug("Sent request: "+r)});e.on("data",e=>{this.logger.debug("Got response: "+e.toString());var t=e.toString().split(/\r?\n/g).map(e=>e.trim()).filter(e=>0<e.length);i(t)}),e.on("error",e=>t(e)),e.on("timeout",()=>{e.destroy(),t(new Error("Request timed out"))})})}})}}});